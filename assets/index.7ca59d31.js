import{aG as S,aQ as H,aO as M,aF as C,aX as W,a_ as w,c_ as D,aY as E,aZ as O}from"./three@0.169.11.js";const f={node:"node",material:"material",camera:"camera",light:"light"},R="KHR_animation_pointer",U={CUBICSPLINE:void 0,LINEAR:H,STEP:W};class j{constructor(a){this.name=R,this.parser=a,this.animationPointerResolver=null}setAnimationPointerResolver(a){return this.animationPointerResolver=a,this}loadAnimationTargetFromChannel(a){const t=a.target,r=t.node!==void 0?t.node:t.id;return this.parser.getDependency("node",r)}loadAnimationTargetFromChannelWithAnimationPointer(a){var c;B();const t=a.target,r=t.extensions&&t.extensions[R]&&t.path&&t.path==="pointer";if(!r)return null;let e,s=f.node,n;if(r){const m=t.extensions[R];let o=m.pointer;if(!o){console.warn("Invalid path",m,t);return}if(o.startsWith("/materials/")?s=f.material:o.startsWith("/extensions/KHR_lights_punctual/lights/")?s=f.light:o.startsWith("/cameras/")&&(s=f.camera),n=this._tryResolveTargetId(o,s),n===null||isNaN(n)){console.warn("Failed resolving animation node id: "+n,o);return}switch(s){case f.material:const x=("/materials/"+n.toString()+"/").length,h=o.substring(0,x);switch(e=o.substring(x),e){case"pbrMetallicRoughness/baseColorFactor":e="color";break;case"pbrMetallicRoughness/roughnessFactor":e="roughness";break;case"pbrMetallicRoughness/metallicFactor":e="metalness";break;case"emissiveFactor":e="emissive";break;case"alphaCutoff":e="alphaTest";break;case"occlusionTexture/strength":e="aoMapIntensity";break;case"normalTexture/scale":e="normalScale";break;case"pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale":e="map/repeat";break;case"pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset":e="map/offset";break;case"emissiveTexture/extensions/KHR_texture_transform/scale":e="emissiveMap/repeat";break;case"emissiveTexture/extensions/KHR_texture_transform/offset":e="emissiveMap/offset";break;case"extensions/KHR_materials_emissive_strength/emissiveStrength":e="emissiveIntensity";break;case"extensions/KHR_materials_transmission/transmissionFactor":e="transmission";break;case"extensions/KHR_materials_ior/ior":e="ior";break;case"extensions/KHR_materials_volume/thicknessFactor":e="thickness";break;case"extensions/KHR_materials_volume/attenuationColor":e="attenuationColor";break;case"extensions/KHR_materials_volume/attenuationDistance":e="attenuationDistance";break;case"extensions/KHR_materials_iridescence/iridescenceFactor":e="iridescence";break;case"extensions/KHR_materials_iridescence/iridescenceIor":e="iridescenceIOR";break;case"extensions/KHR_materials_iridescence/iridescenceThicknessMinimum":e="iridescenceThicknessRange[0]";break;case"extensions/KHR_materials_iridescence/iridescenceThicknessMaximum":e="iridescenceThicknessRange[1]";break;case"extensions/KHR_materials_clearcoat/clearcoatFactor":e="clearcoat";break;case"extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor":e="clearcoatRoughness";break;case"extensions/KHR_materials_sheen/sheenColorFactor":e="sheenColor";break;case"extensions/KHR_materials_sheen/sheenRoughnessFactor":e="sheenRoughness";break;case"extensions/KHR_materials_specular/specularFactor":e="specularIntensity";break;case"extensions/KHR_materials_specular/specularColorFactor":e="specularColor";break}o=h+e;break;case f.node:const u=("/nodes/"+n.toString()+"/").length,l=o.substring(0,u);switch(e=o.substring(u),e){case"translation":e="position";break;case"rotation":e="quaternion";break;case"scale":e="scale";break;case"weights":e="morphTargetInfluences";break}o=l+e;break;case f.light:const p=("/extensions/KHR_lights_punctual/lights/"+n.toString()+"/").length;switch(e=o.substring(p),e){case"color":break;case"intensity":break;case"spot/innerConeAngle":e="penumbra";break;case"spot/outerConeAngle":e="angle";break;case"range":e="distance";break}o="/lights/"+n.toString()+"/"+e;break;case f.camera:const g=("/cameras/"+n.toString()+"/").length,b=o.substring(0,g);switch(e=o.substring(g),e){case"perspective/yfov":e="fov";break;case"perspective/znear":case"orthographic/znear":e="near";break;case"perspective/zfar":case"orthographic/zfar":e="far";break;case"perspective/aspect":e="aspect";break;case"orthographic/xmag":e="zoom";break;case"orthographic/ymag":e="zoom";break}o=b+e;break}(c=this.animationPointerResolver)!=null&&c.resolvePath&&(o=this.animationPointerResolver.resolvePath(o)),t.extensions[R].pointer=o}if(n==null||isNaN(n)){console.warn("Failed resolving animation node id: "+n,t);return}let i;return s===f.node?i=this.parser.getDependency("node",n):s===f.material?i=this.parser.getDependency("material",n):s===f.light?i=this.parser.getDependency("light",n):s===f.camera?i=this.parser.getDependency("camera",n):console.error("Unhandled type",s),i}createAnimationTracksWithAnimationPointer(a,t,r,e,s){if(!(s.extensions&&s.extensions[R]&&s.path&&s.path==="pointer"))return null;let i=s.extensions[R].pointer;if(!i)return null;const c=[];i=i.replaceAll("/",".");const m=i.split(".");var x=a.name!==void 0&&a.name!==null?a.name:a.uuid;if(m[2]=x,m[3]==="morphTargetInfluences"&&a.type==="Group"){for(const u of a.children)u instanceof S&&u.morphTargetInfluences&&(m[3]=u.name,m[4]="morphTargetInfluences",h(this.parser));return c}h(this.parser);function h(u){i=m.join(".");let l;switch(r.itemSize){case 1:l=O;break;case 2:case 3:l=E;break;case 4:i.endsWith(".quaternion")?l=w:l=D;break}if(!l){console.warn("Unsupported output accessor format",r);return}const p=e.interpolation!==void 0?U[e.interpolation]:H;let g=u._getArrayFromAccessor(r);i.endsWith(".fov")&&(g=g.map(k=>k/Math.PI*180));const b=new l(i,t.array,g,p);if(p==="CUBICSPLINE"&&u._createCubicSplineTrackInterpolant(b),c.push(b),i&&r.itemSize===4&&i.startsWith(".materials.")&&i.endsWith(".color")){const k=new Float32Array(g.length/4);for(let T=0,_=g.length/4;T<_;T+=1)k[T]=g[T*4+3];const d=new l(i.replace(".color",".opacity"),t.array,k,p);p==="CUBICSPLINE"&&u._createCubicSplineTrackInterpolant(b),c.push(d)}}return c}_tryResolveTargetId(a,t){let r="";return t==="node"?r=a.substring(7):t==="material"?r=a.substring(11):t==="light"?r=a.substring(39):t==="camera"&&(r=a.substring(9)),r=r.substring(0,r.indexOf("/")),Number.parseInt(r)}loadAnimation(a){const t=this,r=this.parser.json,e=this.parser,s=r.animations[a],n=s.name?s.name:"animation_"+a,i=[],c=[],m=[],o=[],x=[];for(let h=0,u=s.channels.length;h<u;h++){const l=s.channels[h],p=s.samplers[l.sampler],g=l.target,b=s.parameters!==void 0?s.parameters[p.input]:p.input,k=s.parameters!==void 0?s.parameters[p.output]:p.output;let d=t.loadAnimationTargetFromChannelWithAnimationPointer(l);d||(d=t.loadAnimationTargetFromChannel(l)),i.push(d),c.push(e.getDependency("accessor",b)),m.push(e.getDependency("accessor",k)),o.push(p),x.push(g)}return Promise.all([Promise.all(i),Promise.all(c),Promise.all(m),Promise.all(o),Promise.all(x)]).then(function(h){const u=h[0],l=h[1],p=h[2],g=h[3],b=h[4],k=[];for(let d=0,T=u.length;d<T;d++){const _=u[d],v=l[d],A=p[d],N=g[d],K=b[d];if(_===void 0)continue;_.updateMatrix&&(_.updateMatrix(),_.matrixAutoUpdate=!0);let y=t.createAnimationTracksWithAnimationPointer(_,v,A,N,K);if(y||(y=e._createAnimationTracks(_,v,A,N,K)),y)for(let P=0;P<y.length;P++)k.push(y[P])}return new M(n,void 0,k)})}}let F=!1,z=null;function B(){if(F)return;F=!0;const I=z||(z=C.findNode);C.findNode=function(a,t){if(!t)return I(a,t);if(t.startsWith(".materials.")){const r=t.substring(11).substring(t.indexOf(".")),e=r.indexOf("."),s=e<0?r:r.substring(0,e);let n=null;return a.traverse(i=>{n!==null||i.type!=="Mesh"&&i.type!=="SkinnedMesh"||i.material&&(i.material.uuid===s||i.material.name===s)&&(n=i.material,n!==null&&(r.endsWith(".map")?n=n.map:r.endsWith(".emissiveMap")&&(n=n.emissiveMap)))}),n}else if(t.startsWith(".nodes.")||t.startsWith(".lights.")||t.startsWith(".cameras.")){const r=t.split(".");let e;for(let s=1;s<r.length;s++){const n=r[s];if(n.length==36)e=a.getObjectByProperty("uuid",n);else if(e&&e[n]){const c=Number.parseInt(n);let m=n;c>=0&&(m=c),e=e[m]}else{const c=a.getObjectByName(n);c&&(e=c)}}if(!e){const s=I(a,r[2]);return s||console.warn(R+": Property binding not found",t,a,a.name,r),s}return e}return I(a,t)}}export{j as GLTFAnimationPointerExtension,j as default};
