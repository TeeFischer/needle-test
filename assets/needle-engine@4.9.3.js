var jP=Object.defineProperty;var BP=(s,t,e)=>t in s?jP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var a=(s,t,e)=>(BP(s,typeof t!="symbol"?t+"":t,e),e),hg=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var be=(s,t,e)=>(hg(s,t,"read from private field"),e?e.call(s):t.get(s)),On=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},qn=(s,t,e,i)=>(hg(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e);var gh=(s,t,e)=>(hg(s,t,"access private method"),e);import{o as le,V as x,x as Ce,aS as H,bs as ro,bI as ol,P as Se,ae as $p,i as bn,M as X,T as Ke,U as Un,y as de,a as Nn,h as It,bl as Ct,l as to,bS as Dw,bT as FP,bU as q_,a6 as Ie,b as Lw,f as ce,bO as Vr,aB as D,bD as Hr,aM as Fo,bV as yn,ag as Be,u as vn,B as os,aL as Ar,bn as jw,af as Wp,bo as bc,bW as zP,bX as UP,bY as NP,bi as $P,bZ as Bw,ax as Ty,aw as X_,aI as vc,d as Hi,b_ as WP,aH as Fw,aE as Q_,bk as Vp,S as Hp,b$ as VP,bE as Za,aG as Ir,c as zw,aN as HP,aP as GP,c0 as qP,c1 as XP,aO as Dr,a4 as Y_,e as Bd,aF as xc,s as Xo,aq as Ai,an as QP,A as K_,H as Gp,by as zo,n as Qo,g as YP,c2 as wc,c3 as qp,c4 as Xp,c5 as Ff,c6 as KP,c7 as JP,W as io,D as Uw,J as zf,c8 as ZP,c9 as Oy,ca as J_,C as eR,F as Gr,j as tR,cb as D0,cc as iR,cd as nR,ce as ky,E as Z_,t as Qp,_ as sR,cf as oR,cg as rR,bz as aR,ch as lR,ci as cR,cj as hR,ck as dR,cl as uR,cm as fR,cn as pR,co as mR,cp as gR,cq as yR,cr as _R,cs as bR,ct as vR,cu as xR,cv as wR,cw as SR,cx as L0,cy as Nw,cz as CR,aa as PR,a8 as RR,a7 as TR,a9 as OR,K as kR,a0 as ER,$ as MR,cA as j0,ay as Ey,cB as $w,m as AR,L as Uf,cC as IR,bN as DR,bP as Ww,cD as LR,av as jR,cE as BR,cF as FR,cG as zR,bQ as UR,cH as NR,cI as eb,cJ as tb,Q as dg,cK as $R,cL as Vw,cM as WR,b0 as VR,cN as HR,cO as GR,aY as qR,a_ as XR,cP as QR,aW as B0,am as Hw,aj as Nf,a5 as YR,cQ as KR,cR as JR,cS as ZR}from"./three@0.169.11.js";import{_ as ze,a as Gw,b as qw,c as eT,S as tT,d as ug,e as F0,T as z0}from"./three-mesh-ui.8845d782.js";import{a as Sc,F as iT,T as nT,b as sT,G as Yo,c as Xw,E as ib,R as Qw,S as oT,n as rT,O as Yw,d as aT,H as lT,V as cT,e as Kw,s as Jw,z as hT,X as dT,f as uT,L as fT,g as pT,h as mT,i as gT,I as yT,j as _T,k as bT,l as nb,m as Zw,o as vT}from"./three-examples.d0f093e2.js";import{_ as rs,c as sb,g as eS,L as ma,N as pt,s as xT,a as wT,b as ST,d as CT}from"./gltf-progressive.b1e08517.js";import{M as fg,B as PT,P as RT,R as So,T as U0,C as TT,V as OT,a as kT}from"./three-quarks.e0069b48.js";import{EffectAttribute as ET}from"./postprocessing.1c56ce23.js";const pg=new Map;function fs(s=(t=>(t=globalThis.location)==null?void 0:t.hostname)()){if(pg.has(s))return pg.get(s);const e=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|localhost/.test(s);return pg.set(s,e),e===!0}function MT(){return window.location.hostname.includes("glitch.me")}const AT='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 160 187.74"><defs><linearGradient id="a" x1="89.64" y1="184.81" x2="90.48" y2="21.85" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#62d399"/><stop offset=".51" stop-color="#acd842"/><stop offset=".9" stop-color="#d7db0a"/></linearGradient><linearGradient id="b" x1="69.68" y1="178.9" x2="68.08" y2="16.77" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0ba398"/><stop offset=".5" stop-color="#4ca352"/><stop offset="1" stop-color="#76a30a"/></linearGradient><linearGradient id="c" x1="36.6" y1="152.17" x2="34.7" y2="84.19" gradientUnits="userSpaceOnUse"><stop offset=".19" stop-color="#36a382"/><stop offset=".54" stop-color="#49a459"/><stop offset="1" stop-color="#76a30b"/></linearGradient><linearGradient id="d" x1="15.82" y1="153.24" x2="18" y2="90.86" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#267880"/><stop offset=".51" stop-color="#457a5c"/><stop offset="1" stop-color="#717516"/></linearGradient><linearGradient id="e" x1="135.08" y1="135.43" x2="148.93" y2="63.47" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#b0d939"/><stop offset="1" stop-color="#eadb04"/></linearGradient><linearGradient id="f" x1="-4163.25" y1="2285.12" x2="-4160.81" y2="2215.34" gradientTransform="rotate(20 4088.49 13316.712)" gradientUnits="userSpaceOnUse"><stop offset=".17" stop-color="#74af52"/><stop offset=".48" stop-color="#99be32"/><stop offset="1" stop-color="#c0c40a"/></linearGradient><symbol id="g" viewBox="0 0 160 187.74"><path style="fill:url(#a)" d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75z"/><path style="fill:url(#b)" d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98z"/><path style="fill:url(#c)" d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z"/><path style="fill:url(#d)" d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04z"/><path style="fill:#9c3" d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5z"/><path style="fill:url(#e)" d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59z"/><path style="fill:url(#f)" d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z"/><path style="fill:#ffe113" d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1z"/><path style="fill:#f3e600" d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75z"/></symbol></defs><use width="160" height="187.74" xlink:href="#g"/></svg>',IT=btoa(AT),DT="data:image/svg+xml;base64,"+IT,tS=DT,LT=`<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'> <svg clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" version="1.1" viewBox="0 0 1014 282" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m665.95 132.73v44.88l-10.56-8.4c-0.8-0.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18 0.4-6.06 1.2s-3.54 1.8-4.98 3-2.56 2.5-3.36 3.9-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c0.32 0.24 0.56 0.44 0.72 0.6s0.36 0.32 0.6 0.48c0.96-1.2 2.14-2.28 3.54-3.24s2.92-1.76 4.56-2.4 3.34-1.14 5.1-1.5 3.44-0.54 5.04-0.54c1.44 0 2.92 0.04 4.44 0.12s2.84 0.28 3.96 0.6c4.56 1.12 7.8 3.12 9.72 6s2.88 6.56 2.88 11.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m732.38 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m795.93 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m858.57 97.21c0.64 0.48 0.96 1.16 0.96 2.04v74.88c-0.08 1.04-0.12 2.12-0.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18s-2.06-1.66-2.46-1.98c-1.76 2.48-4.26 4.44-7.5 5.88s-7.02 2.16-11.34 2.16c-3.84 0-7.4-0.7-10.68-2.1s-6.14-3.44-8.58-6.12-4.34-5.94-5.7-9.78-2.04-8.16-2.04-12.96c0-4.32 0.78-8.34 2.34-12.06s3.6-6.92 6.12-9.6 5.38-4.78 8.58-6.3 6.48-2.28 9.84-2.28c2.56 0 4.82 0.22 6.78 0.66s3.68 1.06 5.16 1.86 2.78 1.74 3.9 2.82 2.16 2.22 3.12 3.42v-35.04l10.68 8.64zm-27.96 67.92c3.6 0 6.52-0.68 8.76-2.04s3.98-3.06 5.22-5.1 2.1-4.22 2.58-6.54 0.72-4.44 0.72-6.36v-1.2c0-1.12-0.22-2.7-0.66-4.74s-1.28-4.06-2.52-6.06-3-3.7-5.28-5.1-5.22-2.02-8.82-1.86c-3.44 0-6.26 0.74-8.46 2.22s-3.96 3.26-5.28 5.34-2.24 4.2-2.76 6.36-0.78 3.92-0.78 5.28c0 1.84 0.24 3.92 0.72 6.24s1.36 4.48 2.64 6.48 3.04 3.68 5.28 5.04 5.12 2.04 8.64 2.04z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m882.81 97.09c0.64 0.48 0.96 1.12 0.96 1.92l-0.12 41.04v37.08l-10.56-8.4c-0.72-0.64-1.08-1.44-1.08-2.4v-77.88l10.8 8.64z" fill-rule="nonzero"/> </g> <g transform="matrix(1.008 0 0 1.008 -2.239 .61874)"> <path d="m950.36 146.05c0 0.88 0.02 1.5 0.06 1.86s-0.02 0.98-0.18 1.86h-7.08c-2.08 0-4.44-0.02-7.08-0.06s-5.36-0.06-8.16-0.06h-22.08c0 2.88 0.56 5.36 1.68 7.44s2.6 3.8 4.44 5.16 3.94 2.36 6.3 3 4.74 0.96 7.14 0.96c3.04 0 5.9-0.76 8.58-2.28s4.94-3.52 6.78-6c0.64 0.56 1.54 1.48 2.7 2.76s2.94 3.2 5.34 5.76c-2.8 3.36-6.22 6.02-10.26 7.98s-8.42 2.94-13.14 2.94-8.92-0.64-12.84-1.92-7.32-3.24-10.2-5.88-5.12-5.98-6.72-10.02-2.4-8.82-2.4-14.34c0-4.96 0.66-9.42 1.98-13.38s3.22-7.32 5.7-10.08 5.44-4.9 8.88-6.42 7.32-2.28 11.64-2.28c5.76 0 10.52 0.88 14.28 2.64s6.72 4.16 8.88 7.2 3.66 6.54 4.5 10.5 1.26 8.18 1.26 12.66zm-29.4-22.8c-2.16 0.16-4.16 0.72-6 1.68s-3.42 2.2-4.74 3.72-2.36 3.28-3.12 5.28-1.14 4.12-1.14 6.36h33.12c0-2-0.22-4.06-0.66-6.18s-1.3-4.02-2.58-5.7-3.1-3.02-5.46-4.02-5.5-1.38-9.42-1.14z" fill-rule="nonzero"/> </g> <g transform="matrix(1.8559 0 0 .7642 45.348 36.475)"> <g transform="translate(2.7114)"> <path d="m3.935 173.02c-0.331 0-0.497-0.402-0.497-1.207v-51.002c0-0.738 0.138-1.107 0.414-1.107h1.781c0.277 0 0.415 0.335 0.415 1.006v5.935c0 0.336 0.027 0.553 0.083 0.654 0.055 0.101 0.151-0.017 0.289-0.352 0.912-1.744 1.754-3.236 2.527-4.477 0.773-1.24 1.554-2.179 2.341-2.816s1.65-0.956 2.588-0.956c1.685 0 3.011 0.922 3.977 2.766 0.967 1.845 1.602 3.84 1.905 5.986 0.056 0.268 0.139 0.369 0.249 0.302s0.221-0.235 0.331-0.503c0.939-1.811 1.802-3.353 2.589-4.628 0.787-1.274 1.581-2.246 2.382-2.917s1.671-1.006 2.61-1.006c2.016 0 3.569 1.392 4.66 4.175 1.09 2.783 1.636 6.421 1.636 10.915v37.925c0 0.871-0.18 1.307-0.539 1.307h-1.739c-0.138 0-0.249-0.1-0.332-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.338-6.321-1.015-8.3-0.676-1.978-1.76-2.967-3.251-2.967-0.884 0-1.726 0.386-2.527 1.157s-1.519 1.727-2.154 2.867-1.201 2.213-1.699 3.219c-0.248 0.469-0.421 0.905-0.517 1.308-0.097 0.402-0.145 0.972-0.145 1.71v37.221c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.166 0-0.29-0.1-0.373-0.301-0.083-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.332-6.321-0.994-8.3-0.663-1.978-1.754-2.967-3.273-2.967-1.242 0-2.375 0.704-3.396 2.112-1.022 1.409-2.223 3.555-3.604 6.439v39.031c0 0.805-0.18 1.207-0.539 1.207h-1.698z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m53.642 166.28c-1.077 2.549-2.237 4.477-3.479 5.785-1.243 1.307-2.61 1.961-4.101 1.961-2.154 0-3.853-1.324-5.095-3.973-1.243-2.649-1.864-6.187-1.864-10.613 0-3.488 0.4-6.489 1.201-9.004s1.988-4.51 3.562-5.985c1.574-1.476 3.521-2.414 5.841-2.817l3.686-0.704c0.221-0.067 0.394-0.218 0.518-0.453 0.124-0.234 0.187-0.587 0.187-1.056v-2.917c0-3.89-0.504-6.975-1.512-9.255s-2.354-3.42-4.039-3.42c-1.298 0-2.472 0.72-3.521 2.162s-2.002 3.572-2.858 6.388c-0.083 0.268-0.159 0.453-0.228 0.554-0.069 0.1-0.172 0.083-0.311-0.051l-1.698-1.71c-0.083-0.134-0.138-0.285-0.166-0.453-0.027-0.167 0.014-0.452 0.125-0.855 0.856-3.353 2.009-6.052 3.459-8.098 1.449-2.045 3.224-3.068 5.322-3.068 1.74 0 3.211 0.687 4.412 2.062s2.112 3.37 2.734 5.986c0.621 2.615 0.932 5.7 0.932 9.255v35.712c0 0.536-0.035 0.888-0.104 1.056s-0.2 0.251-0.393 0.251h-1.533c-0.166 0-0.29-0.117-0.373-0.352-0.083-0.234-0.124-0.553-0.124-0.955l-0.083-5.231c-0.055-0.939-0.221-1.006-0.497-0.202zm0.456-19.314c0-1.14-0.194-1.643-0.58-1.509l-3.107 0.603c-1.436 0.202-2.686 0.638-3.749 1.308-1.063 0.671-1.953 1.543-2.671 2.616s-1.257 2.33-1.616 3.772-0.538 3.102-0.538 4.98c0 3.152 0.455 5.616 1.367 7.393 0.911 1.778 2.14 2.666 3.686 2.666 0.939 0 1.85-0.419 2.734-1.257s1.671-1.895 2.361-3.169c0.663-1.408 1.181-2.85 1.553-4.326 0.373-1.475 0.56-2.883 0.56-4.225v-8.852z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m79.034 173.02c-0.166 0-0.297-0.117-0.394-0.352-0.096-0.234-0.145-0.553-0.145-0.955v-4.628c0-0.536-0.041-0.838-0.124-0.905s-0.207 0.1-0.373 0.503c-0.276 0.67-0.69 1.593-1.242 2.766-0.553 1.174-1.271 2.23-2.154 3.169-0.884 0.939-1.961 1.408-3.231 1.408-1.74 0-3.314-0.989-4.722-2.967-1.409-1.979-2.534-4.963-3.376-8.953-0.843-3.991-1.264-8.937-1.264-14.838 0-5.701 0.415-10.68 1.243-14.939s1.988-7.595 3.479-10.009c1.492-2.415 3.204-3.622 5.137-3.622 1.436 0 2.616 0.57 3.541 1.71 0.926 1.14 1.719 2.381 2.382 3.722 0.249 0.47 0.414 0.637 0.497 0.503s0.125-0.536 0.125-1.207v-23.841c0-0.805 0.151-1.208 0.455-1.208h1.864c0.276 0 0.414 0.369 0.414 1.107v72.128c0 0.537-0.041 0.905-0.124 1.107-0.083 0.201-0.235 0.301-0.455 0.301h-1.533zm-0.621-42.049c-0.939-2.213-1.885-3.94-2.838-5.181s-2.009-1.861-3.169-1.861c-1.463 0-2.768 0.889-3.914 2.666s-2.044 4.376-2.693 7.796-0.973 7.578-0.973 12.474c0 5.097 0.338 9.272 1.015 12.524 0.676 3.253 1.567 5.651 2.672 7.193 1.104 1.543 2.305 2.314 3.603 2.314 1.188 0 2.258-0.704 3.211-2.113 0.952-1.408 1.705-3.118 2.257-5.13s0.829-3.957 0.829-5.835v-24.847z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m89.514 149.38c0 3.42 0.345 6.606 1.035 9.557 0.691 2.951 1.609 5.315 2.755 7.092s2.437 2.666 3.873 2.666c1.519 0 2.837-0.738 3.956-2.213 1.118-1.476 2.064-3.655 2.837-6.539 0.083-0.336 0.166-0.52 0.249-0.554 0.083-0.033 0.179 0.017 0.29 0.151l1.408 1.912c0.221 0.268 0.235 0.67 0.041 1.207-0.69 2.548-1.47 4.661-2.34 6.337-0.87 1.677-1.857 2.935-2.962 3.773-1.104 0.838-2.319 1.257-3.645 1.257-2.043 0-3.838-1.14-5.385-3.42-1.546-2.28-2.761-5.482-3.645-9.607-0.884-4.124-1.325-8.836-1.325-14.134 0-5.901 0.455-10.931 1.367-15.089 0.911-4.158 2.14-7.377 3.686-9.658 1.547-2.28 3.3-3.42 5.261-3.42 1.988 0 3.714 1.073 5.178 3.219 1.463 2.146 2.595 5.231 3.396 9.255s1.201 8.886 1.201 14.587c0 0.469-0.02 0.939-0.062 1.408-0.041 0.469-0.214 0.704-0.517 0.704h-16.362c-0.083 0-0.152 0.151-0.207 0.453-0.056 0.302-0.083 0.654-0.083 1.056zm13.752-6.237c0.304 0 0.497-0.1 0.58-0.302 0.083-0.201 0.124-0.57 0.124-1.106 0-3.219-0.283-6.187-0.849-8.903s-1.367-4.896-2.402-6.539c-1.036-1.643-2.272-2.464-3.708-2.464-1.629 0-2.996 0.955-4.101 2.867-1.104 1.911-1.94 4.342-2.506 7.293s-0.849 6.002-0.849 9.154h13.711z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m148.54 119.7c0.165 0 0.283 0.117 0.352 0.352s0.076 0.52 0.02 0.855l-6.254 50.902c-0.028 0.47-0.104 0.788-0.228 0.956s-0.297 0.251-0.518 0.251h-1.615c-0.442 0-0.718-0.402-0.829-1.207l-5.26-40.138c-0.111-0.604-0.201-0.905-0.27-0.905s-0.131 0.301-0.186 0.905l-5.012 40.138c-0.028 0.47-0.097 0.788-0.207 0.956-0.111 0.168-0.277 0.251-0.497 0.251h-1.74c-0.442 0-0.718-0.402-0.829-1.207l-6.503-50.801c-0.055-0.403-0.048-0.721 0.021-0.956s0.2-0.352 0.393-0.352h1.823c0.166 0 0.297 0.067 0.393 0.201 0.097 0.134 0.159 0.403 0.187 0.805l5.302 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.219-41.949c0.055-0.268 0.124-0.47 0.207-0.604s0.193-0.201 0.331-0.201h1.533c0.138 0 0.262 0.067 0.373 0.201 0.11 0.134 0.179 0.403 0.207 0.805l5.468 41.848c0.083 0.671 0.179 0.989 0.29 0.956 0.11-0.034 0.207-0.386 0.29-1.056l5.053-41.849c0.055-0.335 0.138-0.57 0.249-0.704 0.11-0.134 0.234-0.201 0.373-0.201h1.284z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m156.49 171.51c0 0.604-0.042 1.006-0.125 1.208-0.082 0.201-0.262 0.301-0.538 0.301h-1.533c-0.221 0-0.366-0.083-0.435-0.251s-0.103-0.486-0.103-0.956v-50.902c0-0.805 0.152-1.207 0.456-1.207h1.822c0.304 0 0.456 0.402 0.456 1.207v50.6zm0.165-63.979c0 1.207-0.207 1.811-0.621 1.811h-1.905c-0.221 0-0.366-0.135-0.435-0.403s-0.104-0.67-0.104-1.207v-7.847c0-1.006 0.18-1.509 0.539-1.509h1.988c0.359 0 0.538 0.47 0.538 1.409v7.746z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m168.3 124.83c-0.221 0-0.331 0.269-0.331 0.805v33.801c0 3.42 0.221 5.667 0.663 6.74 0.441 1.073 1.09 1.609 1.946 1.609h3.024c0.138 0 0.242 0.084 0.311 0.252 0.069 0.167 0.103 0.419 0.103 0.754v2.716c0 0.537-0.138 0.906-0.414 1.107-0.248 0.067-0.614 0.134-1.098 0.201-0.483 0.067-0.959 0.118-1.429 0.151-0.469 0.034-0.828 0.05-1.077 0.05-1.712 0-2.934-0.955-3.665-2.867-0.732-1.911-1.098-5.013-1.098-9.305v-35.108c0-0.604-0.124-0.906-0.373-0.906h-3.521c-0.248 0-0.373-0.268-0.373-0.804v-3.521c0-0.537 0.111-0.805 0.332-0.805h3.686c0.166 0 0.263-0.268 0.29-0.805l0.415-16.095c0-0.805 0.124-1.207 0.372-1.207h1.492c0.303 0 0.455 0.436 0.455 1.307v15.995c0 0.537 0.097 0.805 0.29 0.805h5.468c0.221 0 0.331 0.268 0.331 0.805v3.521c0 0.536-0.124 0.804-0.373 0.804h-5.426z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> <g transform="translate(2.7114)"> <path d="m179.4 173.02c-0.331 0-0.497-0.402-0.497-1.207v-72.329c0-0.738 0.138-1.107 0.414-1.107h1.782c0.276 0 0.414 0.336 0.414 1.006v27.162c0 0.335 0.034 0.536 0.103 0.603s0.159-0.033 0.27-0.302c0.994-1.81 1.898-3.319 2.713-4.526 0.814-1.208 1.629-2.113 2.444-2.717 0.814-0.603 1.691-0.905 2.63-0.905 2.182 0 3.839 1.375 4.971 4.125 1.132 2.749 1.698 6.404 1.698 10.965v37.925c0 0.871-0.166 1.307-0.497 1.307h-1.74c-0.165 0-0.29-0.1-0.373-0.301-0.082-0.202-0.124-0.503-0.124-0.906v-36.315c0-3.555-0.366-6.321-1.097-8.3-0.732-1.978-1.899-2.967-3.501-2.967-0.883 0-1.705 0.318-2.464 0.956-0.76 0.637-1.526 1.576-2.299 2.816-0.773 1.241-1.643 2.834-2.61 4.779v39.031c0 0.805-0.179 1.207-0.538 1.207h-1.699z" fill-rule="nonzero" stroke="#000" stroke-width=".7px"/> </g> </g> <g transform="matrix(.80638 0 0 .80638 452.53 65.421)" fill-rule="nonzero"> <path d="m79.32 36.98v150.76l15.68-13.2 6.59-156.31-22.27 18.75z" fill="url(#f)"/> <path d="m79.32 36.98-22.27-18.75 6.59 156.31 15.68 13.2v-150.76z" fill="url(#e)"/> <path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33z" fill="url(#d)"/> <path d="m25.19 104.83-25.19-14.59 16.97 53.86 16.85 9.77-8.63-49.04z" fill="url(#c)"/> <path d="M43.86,82.5L18.69,67.98L0,90.24L25.18,104.83L43.86,82.5Z" fill="#9c3"/> <path d="m134.82 78.69-9.97 56.5 15.58-9.04 19.57-62.05-25.18 14.59z" fill="url(#b)"/> <path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5z" fill="url(#a)"/> <path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33 25.19-14.59z" fill="#ffe113"/> <path d="M101.59,18.23L79.32,0L57.05,18.23L79.32,36.98L101.59,18.23Z" fill="#f3e600"/> </g> <defs> <linearGradient id="f" x2="1" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)" gradientUnits="userSpaceOnUse"><stop stop-color="#62d399" offset="0"/><stop stop-color="#acd842" offset=".51"/><stop stop-color="#d7db0a" offset=".9"/><stop stop-color="#d7db0a" offset="1"/></linearGradient> <linearGradient id="e" x2="1" gradientTransform="matrix(-1.6,-162.13,162.13,-1.6,69.68,178.9)" gradientUnits="userSpaceOnUse"><stop stop-color="#0ba398" offset="0"/><stop stop-color="#4ca352" offset=".5"/><stop stop-color="#76a30a" offset="1"/></linearGradient> <linearGradient id="d" x2="1" gradientTransform="matrix(-1.9,-67.98,67.98,-1.9,36.6,152.17)" gradientUnits="userSpaceOnUse"><stop stop-color="#36a382" offset="0"/><stop stop-color="#36a382" offset=".19"/><stop stop-color="#49a459" offset=".54"/><stop stop-color="#76a30b" offset="1"/></linearGradient> <linearGradient id="c" x2="1" gradientTransform="matrix(2.18,-62.38,62.38,2.18,15.82,153.24)" gradientUnits="userSpaceOnUse"><stop stop-color="#267880" offset="0"/><stop stop-color="#457a5c" offset=".51"/><stop stop-color="#717516" offset="1"/></linearGradient> <linearGradient id="b" x2="1" gradientTransform="matrix(13.85,-71.96,71.96,13.85,135.08,135.43)" gradientUnits="userSpaceOnUse"><stop stop-color="#b0d939" offset="0"/><stop stop-color="#eadb04" offset="1"/></linearGradient> <linearGradient id="a" x2="1" gradientTransform="matrix(26.159 -64.737 64.737 26.159 107.42 128.14)" gradientUnits="userSpaceOnUse"><stop stop-color="#74af52" offset="0"/><stop stop-color="#74af52" offset=".17"/><stop stop-color="#99be32" offset=".48"/><stop stop-color="#c0c40a" offset="1"/></linearGradient> </defs> </svg>`;btoa(LT);const jT='<svg viewBox="0 0 509 154" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><path d="M665.95 132.73v44.88l-10.56-8.4c-.8-.64-1.2-1.44-1.2-2.4v-32.4c0-6.48-4.12-9.72-12.36-9.72-2.16 0-4.18.4-6.06 1.2-1.88.8-3.54 1.8-4.98 3-1.44 1.2-2.56 2.5-3.36 3.9-.8 1.4-1.2 2.7-1.2 3.9v40.92l-10.68-8.4c-.72-.64-1.08-1.44-1.08-2.4v-53.76l10.92 8.52c.32.24.56.44.72.6.16.16.36.32.6.48.96-1.2 2.14-2.28 3.54-3.24 1.4-.96 2.92-1.76 4.56-2.4 1.64-.64 3.34-1.14 5.1-1.5 1.76-.36 3.44-.54 5.04-.54 1.44 0 2.92.04 4.44.12 1.52.08 2.84.28 3.96.6 4.56 1.12 7.8 3.12 9.72 6 1.92 2.88 2.88 6.56 2.88 11.04ZM732.38 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM795.93 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14ZM858.57 97.21c.64.48.96 1.16.96 2.04v74.88c-.08 1.04-.12 2.12-.12 3.24-1.84-1.52-3.56-2.92-5.16-4.2-1.36-1.12-2.66-2.18-3.9-3.18-1.24-1-2.06-1.66-2.46-1.98-1.76 2.48-4.26 4.44-7.5 5.88-3.24 1.44-7.02 2.16-11.34 2.16-3.84 0-7.4-.7-10.68-2.1-3.28-1.4-6.14-3.44-8.58-6.12-2.44-2.68-4.34-5.94-5.7-9.78-1.36-3.84-2.04-8.16-2.04-12.96 0-4.32.78-8.34 2.34-12.06 1.56-3.72 3.6-6.92 6.12-9.6 2.52-2.68 5.38-4.78 8.58-6.3 3.2-1.52 6.48-2.28 9.84-2.28 2.56 0 4.82.22 6.78.66 1.96.44 3.68 1.06 5.16 1.86s2.78 1.74 3.9 2.82a35.92 35.92 0 0 1 3.12 3.42V88.57l10.68 8.64Zm-27.96 67.92c3.6 0 6.52-.68 8.76-2.04 2.24-1.36 3.98-3.06 5.22-5.1a20.5 20.5 0 0 0 2.58-6.54c.48-2.32.72-4.44.72-6.36v-1.2c0-1.12-.22-2.7-.66-4.74-.44-2.04-1.28-4.06-2.52-6.06s-3-3.7-5.28-5.1c-2.28-1.4-5.22-2.02-8.82-1.86-3.44 0-6.26.74-8.46 2.22-2.2 1.48-3.96 3.26-5.28 5.34-1.32 2.08-2.24 4.2-2.76 6.36-.52 2.16-.78 3.92-.78 5.28 0 1.84.24 3.92.72 6.24.48 2.32 1.36 4.48 2.64 6.48s3.04 3.68 5.28 5.04c2.24 1.36 5.12 2.04 8.64 2.04ZM882.81 97.09c.64.48.96 1.12.96 1.92l-.12 41.04v37.08l-10.56-8.4c-.72-.64-1.08-1.44-1.08-2.4V88.45l10.8 8.64ZM950.36 146.05c0 .88.02 1.5.06 1.86.04.36-.02.98-.18 1.86h-7.08c-2.08 0-4.44-.02-7.08-.06-2.64-.04-5.36-.06-8.16-.06h-22.08c0 2.88.56 5.36 1.68 7.44 1.12 2.08 2.6 3.8 4.44 5.16 1.84 1.36 3.94 2.36 6.3 3 2.36.64 4.74.96 7.14.96 3.04 0 5.9-.76 8.58-2.28 2.68-1.52 4.94-3.52 6.78-6 .64.56 1.54 1.48 2.7 2.76 1.16 1.28 2.94 3.2 5.34 5.76-2.8 3.36-6.22 6.02-10.26 7.98-4.04 1.96-8.42 2.94-13.14 2.94-4.72 0-8.92-.64-12.84-1.92-3.92-1.28-7.32-3.24-10.2-5.88-2.88-2.64-5.12-5.98-6.72-10.02-1.6-4.04-2.4-8.82-2.4-14.34 0-4.96.66-9.42 1.98-13.38 1.32-3.96 3.22-7.32 5.7-10.08s5.44-4.9 8.88-6.42c3.44-1.52 7.32-2.28 11.64-2.28 5.76 0 10.52.88 14.28 2.64 3.76 1.76 6.72 4.16 8.88 7.2 2.16 3.04 3.66 6.54 4.5 10.5.84 3.96 1.26 8.18 1.26 12.66Zm-29.4-22.8c-2.16.16-4.16.72-6 1.68-1.84.96-3.42 2.2-4.74 3.72-1.32 1.52-2.36 3.28-3.12 5.28-.76 2-1.14 4.12-1.14 6.36h33.12c0-2-.22-4.06-.66-6.18-.44-2.12-1.3-4.02-2.58-5.7-1.28-1.68-3.1-3.02-5.46-4.02-2.36-1-5.5-1.38-9.42-1.14Z" style="fill-rule:nonzero" transform="translate(-452.406 -63.709) scale(1.00797)"/><path d="M79.32 36.98v150.76L95 174.54l6.59-156.31-22.27 18.75Z" style="fill:url(#a);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M79.32 36.98 57.05 18.23l6.59 156.31 15.68 13.2V36.98Z" style="fill:url(#b);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m25.19 104.83 8.63 49.04 12.5-14.95-2.46-56.42-18.67 22.33Z" style="fill:url(#c);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M25.19 104.83 0 90.24l16.97 53.86 16.85 9.77-8.63-49.04Z" style="fill:url(#d);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M43.86 82.5 18.69 67.98 0 90.24l25.18 14.59L43.86 82.5Z" style="fill:#9c3;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-9.97 56.5 15.58-9.04L160 64.1l-25.18 14.59Z" style="fill:url(#e);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m134.82 78.69-18.68-22.33-2.86 65 11.57 13.83 9.97-56.5Z" style="fill:url(#f);fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="m160 64.1-18.69-22.26-25.17 14.52 18.67 22.33L160 64.1Z" style="fill:#ffe113;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><path d="M101.59 18.23 79.32 0 57.05 18.23l22.27 18.75 22.27-18.75Z" style="fill:#f3e600;fill-rule:nonzero" transform="matrix(.80638 0 0 .80638 2.361 1.094)"/><defs><linearGradient id="a" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(.84 -162.96 162.96 .84 89.64 184.81)"><stop offset="0" style="stop-color:#62d399;stop-opacity:1"/><stop offset=".51" style="stop-color:#acd842;stop-opacity:1"/><stop offset=".9" style="stop-color:#d7db0a;stop-opacity:1"/><stop offset="1" style="stop-color:#d7db0a;stop-opacity:1"/></linearGradient><linearGradient id="b" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-90.565 123.412 54.953) scale(162.14)"><stop offset="0" style="stop-color:#0ba398;stop-opacity:1"/><stop offset=".5" style="stop-color:#4ca352;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30a;stop-opacity:1"/></linearGradient><linearGradient id="c" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="scale(-68) rotate(88.4 .881 -1.396)"><stop offset="0" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".19" style="stop-color:#36a382;stop-opacity:1"/><stop offset=".54" style="stop-color:#49a459;stop-opacity:1"/><stop offset="1" style="stop-color:#76a30b;stop-opacity:1"/></linearGradient><linearGradient id="d" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-88 87.255 68.431) scale(62.42)"><stop offset="0" style="stop-color:#267880;stop-opacity:1"/><stop offset=".51" style="stop-color:#457a5c;stop-opacity:1"/><stop offset="1" style="stop-color:#717516;stop-opacity:1"/></linearGradient><linearGradient id="e" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-79.1 149.53 -14.065) scale(73.28)"><stop offset="0" style="stop-color:#b0d939;stop-opacity:1"/><stop offset="1" style="stop-color:#eadb04;stop-opacity:1"/></linearGradient><linearGradient id="f" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="rotate(-67.997 148.705 -15.558) scale(69.8226)"><stop offset="0" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".17" style="stop-color:#74af52;stop-opacity:1"/><stop offset=".48" style="stop-color:#99be32;stop-opacity:1"/><stop offset="1" style="stop-color:#c0c40a;stop-opacity:1"/></linearGradient></defs></svg>',BT=btoa(jT),FT="data:image/svg+xml;charset=utf-8;base64,"+BT,zT=FT,N0=typeof window!==void 0?window.location.search.includes("debugcontext"):!1;var ge;(function(s){s.ContextRegistered="ContextRegistered",s.ContextCreationStart="ContextCreationStart",s.ContextCreated="ContextCreated",s.ContextFirstFrameRendered="ContextFirstFrameRendered",s.ContextDestroying="ContextDestroying",s.ContextDestroyed="ContextDestroyed",s.MissingCamera="MissingCamera",s.ContextClearing="ContextClearing",s.ContextCleared="ContextCleared"})(ge||(ge={}));class ve{static get Current(){return globalThis["NeedleEngine.Context.Current"]}static set Current(t){globalThis["NeedleEngine.Context.Current"]=t}static get All(){return this.Registered}static register(t){this.Registered.indexOf(t)===-1&&(N0&&console.warn("Registering context"),this.Registered.push(t),this.dispatchCallback(ge.ContextRegistered,t))}static unregister(t){const e=this.Registered.indexOf(t);e!==-1&&(N0&&console.warn("Unregistering context"),this.Registered.splice(e,1))}static registerCallback(t,e){this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(e)}static unregisterCallback(t,e){if(!this._callbacks[t])return;const i=this._callbacks[t].indexOf(e);i!==-1&&this._callbacks[t].splice(i,1)}static dispatchCallback(t,e,i){if(!this._callbacks[t])return!0;const n={event:t,context:e};if(i)for(const r in i)n[r]=i[r];const o=new Array;return this._callbacks[t].forEach(r=>{const l=r(n);l instanceof Promise&&o.push(l)}),Promise.all(o)}static addContextCreatedCallback(t){this.registerCallback(ge.ContextCreated,t)}static addContextDestroyedCallback(t){this.registerCallback(ge.ContextDestroyed,t)}}a(ve,"Registered",[]),a(ve,"_callbacks",{});const UT=()=>s=>s;function BL(s){return UT()(s)}function FL(){return!!S("debug")}class $n{constructor(t,e){a(this,"_factory");a(this,"_cache",[]);a(this,"_maxSize");a(this,"_index",0);this._factory=t,this._maxSize=e}get(){const t=this._index%this._maxSize;return this._index++,this._cache.length<=t&&(this._cache[t]=this._factory()),this._cache[t]}}let Pa=!1;const My=new Array;typeof window<"u"&&setTimeout(()=>{if(Pa){const s={},t=new URL(window.location.href),e=new URL(t);e.searchParams.append("console","");const i=e.toString().replace(/=$|=(?=&)/g,"");for(const o of My){const r=new URL(t);r.searchParams.append(o,""),s[o]=r.toString().replace(/=$|=(?=&)/g,"")}console.log(`ðŸŒµ ?help: Debug Options for Needle Engine.
Append any of these parameters to the URL to enable specific debug options.
Example: ${i} will show an onscreen console window.`);const n=Pa===!0?"":` (containing "${Pa}")`;console.group("Available URL parameters:"+n);for(const o of Object.keys(s).sort())typeof Pa=="string"&&!o.toLowerCase().includes(Pa.toLowerCase())||(console.groupCollapsed(o),console.log("Reload with this flag enabled:"),console.log(s[o]),console.groupEnd());console.groupEnd()}},100);function Yp(){var s;return new URLSearchParams((s=globalThis.location)==null?void 0:s.search)}function S(s){Pa&&!My.includes(s)&&My.push(s);const t=Yp();if(t.has(s)){const e=t.get(s);if(e){const i=Number(e);return isNaN(i)?e:i}else return!0}return!1}Pa=S("help");function zL(s,t){const e=Yp();e.has(s)?e.set(s,t):e.append(s,t),document.location.search=e.toString()}function $f(s,t,e=!0){const i=Yp();i.has(s)?t===null?i.delete(s):i.set(s,t):t!==null&&i.append(s,t),e?NT(s,i):iS(s,i)}function $0(s,t,e){s.has(t)?s.set(t,e.toString()):s.append(t,e.toString())}function NT(s,t,e){window.history.pushState(e,s,"?"+t.toString())}function iS(s,t,e){window.history.replaceState(e,s,"?"+t.toString())}function UL(s){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=e.length,n=0;n<s;n++)t+=e.charAt(Math.floor(Math.random()*i));return t}function NL(s,t){return Math.floor(Math.random()*(t-s+1))+s}const W0=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],V0=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function $T(){const s=W0[Math.floor(Math.random()*W0.length)],t=V0[Math.floor(Math.random()*V0.length)];return s+"_"+t}function WT(s){return s=s.replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±Ã¼ \.,_-]/gim,""),s.trim()}function Fd(s,t,e=!0,i=!1){var n;if(t==null)return null;if(t.userData&&t.userData.guid===s)return t;if(t.guid==s)return t;if(i&&(n=t.userData)!=null&&n.components){for(const o of t.userData.components)if(o.guid===s)return o}if(e){if(t.scenes)for(const o in t.scenes){const r=t.scenes[o],l=Fd(s,r,e,i);if(l)return l}if(t.children)for(const o in t.children){const r=t.children[o],l=Fd(s,r,e,i);if(l)return l}}}function Kp(s,t){if(s!=null&&typeof s=="object"){let e;Array.isArray(s)?e=[]:(e=Object.create(s),Object.assign(e,s));for(const i of Object.keys(s)){const n=s[i];t&&!t(s,i,n)?e[i]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?e[i]=n.clone():e[i]=Kp(n,t)}return e}return s}function Ko(s){return new Promise((t,e)=>{setTimeout(t,s)})}function Jp(s,t){if(s<=0)return Promise.resolve();if(t||(t=ve.Current),!t)return Promise.reject("No context");const e=t.time.frameCount+s;return new Promise((i,n)=>{if(!t)return n("No context");const o=()=>{t.time.frameCount>=e&&(t.pre_update_callbacks.splice(t.pre_update_callbacks.indexOf(o),1),i())};t.pre_update_callbacks.push(o)})}const Tu=S("debugresolveurl"),VT="rel:";function $L(s,t){return rl(s,t)}function rl(s,t){if(t===void 0)return Tu&&console.warn("getPath: uri is undefined, returning uri",t),t;if(t.startsWith("./"))return t;if(t.startsWith("http"))return Tu&&console.warn("getPath: uri is absolute, returning uri",t),t;if(s===void 0)return Tu&&console.warn("getPath: source is undefined, returning uri",t),t;t.startsWith(VT)&&(t=t.substring(4));const e=s.lastIndexOf("/");if(e>=0){const i=s.substring(0,e+1);for(;i.endsWith("/")&&t.startsWith("/");)t=t.substring(1);const n=i+t;return Tu&&console.log("source:",s,`changed uri 
from`,t,`
to `,n,`
basePath: `+i),n}return t}class HT{constructor(t,e){a(this,"writeCallbacks",[]);a(this,"_applied",!1);a(this,"_object");a(this,"_prop");a(this,"_wrapperProp");this._object=t,this._prop=e,this._wrapperProp=Symbol("$"+e),this.apply()}subscribeWrite(t){this.writeCallbacks.push(t)}unsubscribeWrite(t){const e=this.writeCallbacks.indexOf(t);e!==-1&&this.writeCallbacks.splice(e,1)}apply(){if(this._applied||!this._object)return;const t=this._object,e=this._prop;if(t[e]===void 0)return;this._applied=!0,t[this._wrapperProp]!==void 0&&console.warn("Watcher is being applied to an object that already has a wrapper property. This is not (yet) supported");const i=t[e];t[this._wrapperProp]=i,Object.defineProperty(t,e,{get:()=>t[this._wrapperProp],set:r=>{t[this._wrapperProp]=r;for(const l of this.writeCallbacks)l(r,this._prop)}})}revoke(){if(!this._applied||!this._object)return;this._applied=!1;const t=this._object,e=this._prop;Reflect.deleteProperty(t,e);const i=t[this._wrapperProp];t[e]=i,Reflect.deleteProperty(t,this._wrapperProp)}dispose(){this.revoke(),this.writeCallbacks.length=0,this._object=null}}class Lr{constructor(t,e){a(this,"_watches",[]);if(Array.isArray(e))for(const i of e)this._watches.push(new Lr(t,i));else this._watches.push(new HT(t,e))}subscribeWrite(t){for(const e of this._watches)e.subscribeWrite(t)}unsubscribeWrite(t){for(const e of this._watches)e.unsubscribeWrite(t)}apply(){for(const t of this._watches)t.apply()}revoke(){for(const t of this._watches)t.revoke()}dispose(){for(const t of this._watches)t.dispose();this._watches.length=0}}const Al=Symbol("needle:watches");function ob(s,t){if(!s[Al])if(s instanceof le)s[Al]=new Lr(s,["x","y"]);else if(s instanceof x)s[Al]=new Lr(s,["x","y","z"]);else if(s instanceof Ce||s instanceof H)s[Al]=new Lr(s,["x","y","z","w"]);else return!1;return s[Al].subscribeWrite(t),!0}function nS(s,t){if(!s)return;const e=s[Al];e&&e.unsubscribeWrite(t)}var K;(function(s){let t;function e(){if(t!==void 0)return t;const I=window.navigator.userAgent,V=/Windows|MacOS|Mac OS/.test(I),ie=/Windows NT/.test(I)&&/Edg/.test(I)&&!/Win64/.test(I);return t=V&&!ie&&!v()}s.isDesktop=e;let i;function n(){return i!==void 0?i:typeof window.orientation<"u"||navigator.userAgent.indexOf("IEMobile")!==-1?i=!0:i=/iPhone|iPad|iPod|Android|IEMobile/i.test(navigator.userAgent)}s.isMobileDevice=n;function o(){return l()}s.isIPad=o;let r;function l(){return r!==void 0?r:r=/iPad/.test(navigator.userAgent)}s.isiPad=l;let c;function h(){return c!==void 0?c:c=/Android/.test(navigator.userAgent)}s.isAndroidDevice=h;let d;function u(){return d!==void 0?d:d=/WebXRViewer\//i.test(navigator.userAgent)}s.isMozillaXR=u;let f;function p(){if(f!==void 0)return f;if(navigator.userAgentData)return f=navigator.userAgentData.platform==="macOS";{const I=navigator.userAgent.toLowerCase();return f=I.includes("mac os x")||I.includes("macintosh")}}s.isMacOS=p;let g;function _(){return g!==void 0?g:g=p()&&"xr"in navigator}s.isVisionOS=_;let y;const b=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];function v(){return y!==void 0?y:y=b.includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}s.isiOS=v;let w;function P(){return w!==void 0||(w=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),w}s.isSafari=P;let E;function T(){return E!==void 0?E:E=navigator.userAgent.includes("OculusBrowser")}s.isQuest=T;let k;function z(){return k!==void 0||(k=document.createElement("a").relList.supports("ar")),k}s.supportsQuickLookAR=z;async function L(){try{return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}catch(I){return console.error("Error querying `microphone` permissions.",I),!1}}s.microphonePermissionsGranted=L;let O;function A(){if(O!==void 0)return O;const I=navigator.userAgent.match(/iPhone OS (\d+_\d+)/);if(I&&(O=I[1].replace("_",".")),!O){const V=navigator.userAgent.match(/(?:\(Macintosh;|iPhone;|iPad;).*Version\/(\d+\.\d+)/);V&&(O=V[1])}return O||(O=null),O}s.getiOSVersion=A;let $;function B(){if($!==void 0)return $;const I=navigator.userAgent.match(/(?:CriOS|Chrome)\/(\d+\.\d+\.\d+\.\d+)/);return I?$=I[1].replace("_","."):$=null,$}s.getChromeVersion=B})(K||(K={}));function WL(){return K.isDesktop()}function VL(){return K.isMobileDevice()}function HL(){return K.isiPad()}function GL(){return K.isiPad()}function qL(){return K.isAndroidDevice()}function XL(){return K.isMozillaXR()}function QL(){return K.isMacOS()}function YL(){return K.isiOS()}function KL(){return K.isSafari()}function JL(){return K.isQuest()}async function ZL(){return K.microphonePermissionsGranted()}const Or=new WeakMap;function GT(s,t,e){if(!Or.get(s)){const n=new MutationObserver(o=>{XT(s,o)});Or.set(s,{observer:n,attributeChangedListeners:new Map}),n.observe(s,{attributes:!0})}const i=Or.get(s).attributeChangedListeners;i.has(t)||i.set(t,[]),i.get(t).push(e)}function qT(s,t,e){if(!Or.get(s))return;const i=Or.get(s).attributeChangedListeners;if(!i.has(t))return;const n=i.get(t),o=n.indexOf(e);if(o!==-1&&(n.splice(o,1),n.length<=0)){i.delete(t);const r=Or.get(s);r==null||r.observer.disconnect(),Or.delete(s)}}function XT(s,t){const e=Or.get(s).attributeChangedListeners;for(const i of t)if(i.type==="attributes"){const n=i.attributeName,o=s.getAttribute(n);if(e.has(n))for(const r of e.get(n))r(o)}}class H0{constructor(t){a(this,"reason");this.reason=t}}async function sS(s){const t=await Promise.allSettled(s).catch(n=>[new H0(n.message)]);let e=!1;const i=t.map(n=>"value"in n?n.value:(e=!0,new H0(n.reason)));return{anyFailed:e,results:i}}async function QT(s){var c;if(!globalThis.QRCode){const h="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js";let d=document.head.querySelector(`script[src="${h}"]`);d||(d=document.createElement("script"),d.src=h,document.head.appendChild(d)),await new Promise((u,f)=>{d.addEventListener("load",()=>{u(!0)})})}const t=globalThis.QRCode,e=s.domElement??document.createElement("div"),i=new t(e,{width:s.width??256,height:s.height??256,colorDark:"#000000",colorLight:"#ffffff",correctLevel:s.showLogo?t.CorrectionLevel.H:t.CorrectLevel.M,...s}),n=(i==null?void 0:i._oQRCode.moduleCount)||0,o=(c=i==null?void 0:i._oDrawing)==null?void 0:c._elCanvas;let r=.25;n<40?r=Math.floor(n/4)/n:r=Math.floor(n/6)/n;const l=Math.floor(n/20)/n;try{const h=await YT(o,{showLogo:s.showLogo,logoSize:r,logoPadding:l}).catch(d=>{});h&&(e.innerHTML="",e.append(h))}catch{}if(s.showUrl!==!1&&s.text){const h=e.querySelector(".qr-code-link-label");let d=s.text.replace(/^(https?:\/\/)?(www\.)?/,"").replace(/\/+$/,"").replace(/\?+$/,"");if(d="Scan to visit "+d,h)h.textContent=d;else{const u=document.createElement("div");u.classList.add("qr-code-link-label"),s.text=d,u.textContent=s.text,u.addEventListener("click",f=>{f.stopImmediatePropagation()}),u.style.textAlign="center",u.style.fontSize="0.8em",u.style.marginTop="0.1em",u.style.color="#000000",u.style.fontFamily="'Roboto Flex', sans-serif",u.style.opacity="0.5",u.style.wordBreak="break-all",u.style.wordWrap="break-word",u.style.marginBottom="0.3em",e.style.width="calc(210px + 20px)",e.appendChild(u)}}return e}async function YT(s,t){if(!s)return;const e=8,i=20,n=t.logoPadding||1/32,o="transparent",r=0,l=new Image,c=document.querySelector("needle-engine"),h=(c==null?void 0:c.getAttribute("loading-logo-src"))||tS;if(!h)return;let d=!1;t.showLogo!==!1&&(l.src=h,d=await new Promise((v,w)=>{l.onload=()=>v(!0),l.onerror=P=>{console.error("Error loading favicon image for QR code",P),v(!1)}}));const u=document.createElement("canvas");u.width=s.width+e,u.height=s.height+e;const f=u.getContext("2d");if(!f)return;f.fillStyle="#ffffff",f.fillRect(0,0,u.width,u.height),f.drawImage(s,e/2,e/2),f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",f.mozImageSmoothingEnabled=!0,f.webkitImageSmoothingEnabled=!0,f.globalCompositeOperation="lighten";const p=f.createLinearGradient(0,0,0,u.height);p.addColorStop(0,"rgb(45, 45, 45)"),p.addColorStop(1,"rgb(45, 45, 45)"),f.fillStyle=p,f.fillRect(0,0,u.width,u.height),f.globalCompositeOperation="source-over";let g=Math.min(s.width,s.height)*(t.logoSize||.25),_=g;if(d){const v=l.width/l.height;v>1?_=g/v:g=_*v;const w=n*s.width,P=Math.max(g,_),E=Math.round(P+w),T=Math.round(P+w),k=(u.width-P)/2,z=(u.height-P)/2;f.shadowColor=o,f.shadowBlur=i;const L=r,O=Math.round(k-w/2),A=Math.round(z-w/2);f.beginPath(),f.moveTo(O+L,A),f.lineTo(O+E-L,A),f.quadraticCurveTo(O+E,A,O+E,A+L),f.lineTo(O+E,A+T-L),f.quadraticCurveTo(O+E,A+T,O+E-L,A+T),f.lineTo(O+L,A+T),f.quadraticCurveTo(O,A+T,O,A+T-L),f.lineTo(O,A+L),f.quadraticCurveTo(O,A,O+L,A),f.fillStyle="#ffffff",f.closePath(),f.fill(),f.clip(),f.shadowColor="transparent";const $=(u.width-g)/2,B=(u.height-_)/2;f.drawImage(l,$,B,g,_)}const y=u.toDataURL("image/png"),b=document.createElement("img");return b.src=y,b.style.width="100%",b.style.height="auto",b}const KT=S("debugdebug");let rb=!1;(S("noerrors")||S("nooverlaymessages"))&&(rb=!0);const mg="needle_engine_global_error_container";var Jt;(function(s){s[s.Log=0]="Log",s[s.Warn=1]="Warn",s[s.Error=2]="Error"})(Jt||(Jt={}));function oS(){return aS}const Ay=new Array;function JT(s){Ay.push(s)}let gg=!1;function ZT(...s){if(!gg){gg=!0;try{for(let t=0;t<Ay.length;t++)Ay[t](...s)}catch(t){console.error(t)}gg=!1}}const rS=console.error,eO=function(...s){rS.apply(console,s),nO(s),La(Jt.Error,s),iO(...s)};function tO(s){rb=!s,s?console.error=eO:console.error=rS}function e3(s){return tO(s)}let aS=0;function iO(...s){aS+=1,ZT(...s)}function nO(s){if(Array.isArray(s))for(let t=0;t<s.length;t++){const e=s[t];typeof e=="string"&&e.startsWith("THREE.PropertyBinding: Trying to update node for track:")&&(s[t]="Some animated objects couldn't be found: see console for details")}}function La(s,t,e,i){if(rb)return;const n=ve.Current,o=(n==null?void 0:n.domElement)??document.querySelector("needle-engine");if(o){if(Array.isArray(t)){let r="";for(let l=0;l<t.length;l++){let c=t[l];c instanceof Error&&(c=c.message),typeof c!="object"&&(l>0&&(r+=" "),r+=c)}t=r}!t||t.length<=0||sO(s,o,t)}}const Xh=new Map;function sO(s,t,e){if(e==null)return;const i=rO(t);if(i.childElementCount>=20){const l=i.lastElementChild;G0(l)}e.length>400&&(e=e.substring(0,400)+"...");const n=e;if(Xh.has(n))return;const o=aO(s,e);i.prepend(o);const r=()=>{Xh.delete(n),G0(o)};Xh.set(n,r),setTimeout(r,1e4)}function t3(){KT&&console.log("Clearing messages");for(const s of Xh.values())s==null||s.call(s);Xh.clear()}const oO=`

@import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

div[data-needle_engine_debug_overlay] {
    font-family: 'Roboto Flex', sans-serif;
    font-weight: 400;
    font-size: 16px;
}

div[data-needle_engine_debug_overlay] strong {
    font-weight: 700;
}

div[data-needle_engine_debug_overlay] a {
    color: white;
    text-decoration: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

div[data-needle_engine_debug_overlay] a:hover {
    text-decoration: none;
    border: none;
}

div[data-needle_engine_debug_overlay] .log strong {
    color: rgba(200,200,200,.9);
}

div[data-needle_engine_debug_overlay] .warn strong {
    color: rgba(255,255,230, 1);
}

div[data-needle_engine_debug_overlay] .error strong {
    color: rgba(255,100,120, 1);
}
`;function rO(s){globalThis[mg]||(globalThis[mg]=new Map);const t=globalThis[mg];if(t.has(s))return t.get(s);{const e=document.createElement("div");t.set(s,e),e.setAttribute("data-needle_engine_debug_overlay",""),e.classList.add("debug-container"),e.style.cssText=`
            position: absolute;
            top: 0;
            right: 5px;
            padding-top: 0px;
            max-width: 70%;
            max-height: calc(100% - 5px);
            z-index: 9999999999;
            pointer-events: scroll;
            display: flex;
            align-items: end;
            flex-direction: column;
            color: white;
            overflow: auto;
            word-break: break-word;
        `,s.shadowRoot?s.shadowRoot.appendChild(e):s.appendChild(e);const i=document.createElement("style");return i.innerHTML=oO,e.appendChild(i),e}}const lS=Symbol("logtype"),Wf=new Map;function G0(s){s.remove();const t=s[lS],e=Wf.get(t)??[];e.push(s),Wf.set(t,e)}function aO(s,t){if(Wf.has(s)){const i=Wf.get(s);if(i.length>0){const n=i.pop();return n.innerHTML=t,n}}const e=document.createElement("div");switch(e.setAttribute("data-id","__needle_engine_debug_overlay"),e.style.marginRight="5px",e.style.padding=".5em",e.style.backgroundColor="rgba(0,0,0,.9)",e.style.marginTop="5px",e.style.marginBottom="3px",e.style.borderRadius="8px",e.style.pointerEvents="all",e.style.userSelect="text",e.style.maxWidth="250px",e.style.whiteSpace="pre-wrap",e.style["backdrop-filter"]="blur(10px)",e.style["-webkit-backdrop-filter"]="blur(10px)",e.style.backgroundColor="rgba(20,20,20,.8)",e.style.boxShadow="inset 0 0 80px rgba(0,0,0,.2), 0 0 5px rgba(0,0,0,.2)",e.style.border="1px solid rgba(160,160,160,.2)",e[lS]=s,s){case Jt.Log:e.classList.add("log"),e.style.color="rgba(200,200,200,.7)",e.style.backgroundColor="rgba(40,40,40,.7)";break;case Jt.Warn:e.classList.add("warn"),e.style.color="rgb(255, 255, 150)",e.style.backgroundColor="rgba(50,50,20,.8)";break;case Jt.Error:e.classList.add("error"),e.style.color="rgb(255, 50, 50",e.style.backgroundColor="rgba(50,20,20,.8)";break}return e.title="Open the browser console (F12) for more information",e.innerHTML=t,e}class lO{constructor(){a(this,"Rad2Deg",180/Math.PI);a(this,"Deg2Rad",Math.PI/180);a(this,"Epsilon",1e-5)}random(t,e){return Array.isArray(t)?t.length<=0?null:t[Math.floor(Math.random()*t.length)]:t!==void 0&&e!==void 0?Math.random()*(e-t)+t:Math.random()}randomVector3(t,e=0,i=1){t.x=this.random(e,i),t.y=this.random(e,i),t.z=this.random(e,i)}clamp(t,e,i){return t<e?e:t>i?i:t}clamp01(t){return this.clamp(t,0,1)}lerp(t,e,i){return i=i<0?0:i,i=i>1?1:i,t+(e-t)*i}inverseLerp(t,e,i){return(i-t)/(e-t)}remap(t,e,i,n,o){return n+(o-n)*(t-e)/(i-e)}moveTowards(t,e,i){return t+=i,(i<0&&t<e||i>0&&t>e)&&(t=e),t}toDegrees(t){return t*180/Math.PI}toRadians(t){return t*Math.PI/180}tan(t){return Math.tan(t)}gammaToLinear(t){return Math.pow(t,2.2)}linearToGamma(t){return Math.pow(t,1/2.2)}approximately(t,e,i=Number.EPSILON){for(const n of cO){const o=t[n],r=e[n];if(o===void 0||r===void 0)break;if(Math.abs(o-r)>i)return!1}return!0}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}}const cO=["x","y","z","w"],N=new lO;class q0{constructor(t){a(this,"y");a(this,"s");a(this,"alpha",0);this.setAlpha(t),this.y=null,this.s=null}setAlpha(t){if(t<=0||t>1)throw new Error;this.alpha=t}filter(t,e){e&&this.setAlpha(e);let i;return this.y?i=this.alpha*t+(1-this.alpha)*this.s:i=t,this.y=t,this.s=i,i}lastValue(){return this.y}reset(t){this.y=t,this.s=t}}class yg{constructor(t,e=1,i=0,n=1){a(this,"freq");a(this,"minCutOff");a(this,"beta");a(this,"dCutOff");a(this,"x");a(this,"dx");a(this,"lasttime");if(t<=0||e<=0||n<=0)throw new Error;this.freq=t,this.minCutOff=e,this.beta=i,this.dCutOff=n,this.x=new q0(this.alpha(this.minCutOff)),this.dx=new q0(this.alpha(this.dCutOff)),this.lasttime=null}alpha(t){const e=1/this.freq;return 1/(1+1/(2*Math.PI*t)/e)}filter(t,e=null){this.lasttime&&e&&(this.freq=1/(e-this.lasttime)),this.lasttime=e;const i=this.x.lastValue(),n=i?(t-i)*this.freq:0,o=this.dx.filter(n,this.alpha(this.dCutOff)),r=this.minCutOff+this.beta*Math.abs(o);return this.x.filter(t,this.alpha(r))}reset(t){t!=null&&this.x.reset(t),this.x.alpha=this.alpha(this.minCutOff),this.dx.alpha=this.alpha(this.dCutOff),this.lasttime=null}}class cS{constructor(t,e=1,i=0,n=1){a(this,"x");a(this,"y");a(this,"z");this.x=new yg(t,e,i,n),this.y=new yg(t,e,i,n),this.z=new yg(t,e,i,n)}filter(t,e,i=null){e.x=this.x.filter(t.x,i),e.y=this.y.filter(t.y,i),e.z=this.z.filter(t.z,i)}reset(t){this.x.reset(t==null?void 0:t.x),this.y.reset(t==null?void 0:t.y),this.z.reset(t==null?void 0:t.z)}}const yf="needle:cameraController";function hO(s){return s[yf]}function X0(s,t,e){e?s[yf]=t:s[yf]===t&&(s[yf]=null)}const Iy="needle:autofit";function dO(s){return s[Iy]===void 0?!0:s[Iy]!==!1}function Dy(s,t){s[Iy]=t}let yo;const uO={x:0,y:0,width:0,height:0};function fO(s,t,e,i){s instanceof Element&&(s=s.getBoundingClientRect()),yo=i.domElement.getBoundingClientRect();const n=uO;n.x=s.x,n.y=s.y,n.width=s.width,n.height=s.height,n.x-=yo.x,n.y-=yo.y;const o=n.width/-2-(n.x-yo.width/2),r=n.height/-2-(n.y-yo.height/2),l=e.view;let c=(l==null?void 0:l.offsetX)||0,h=(l==null?void 0:l.offsetY)||0;c=N.lerp(c,o,t),h=N.lerp(h,r,t),e.setViewOffset(yo.width,yo.height,c,h,yo.width,yo.height),e.updateProjectionMatrix()}function i3(s,t,e){const i=s.length(),n=t.length(),o=N.lerp(i,n,e);return s.lerp(t,e).normalize().multiplyScalar(o)}const _g=new H,hS=new H().setFromAxisAngle(new x(0,1,0),Math.PI);function n3(s,t){s.lookAt(t),s.quaternion.multiply(hS)}function Zp(s,t,e=!0,i=!1){if(s===t)return;_g.copy(s.quaternion);const n=ae(t),o=ae(s);if(i){if(no(s,Le(t)),e){const r=o.y,l=o.sub(wO(s));l.y=r,s.lookAt(l),s.quaternion.multiply(hS)}Number.isNaN(s.quaternion.x)&&s.quaternion.copy(_g);return}e&&(n.y=o.y),s.lookAt(n),Number.isNaN(s.quaternion.x)&&s.quaternion.copy(_g)}function s3(s,t,e,i=1){if(e){const n=q(0,0,0),o=t.x/window.innerWidth*2-1,r=-(t.y/window.innerHeight)*2+1;n.set(o,r,0),n.unproject(e);const l=e.worldPosition,c=s.worldPosition.distanceTo(l),h=n.sub(l);h.multiplyScalar(i*3.6*c);const d=e.worldPosition.add(h);return s.lookAt(d),d}return null}const pO=new $n(()=>new x,100);function q(s,t,e){const i=pO.get();return i.set(0,0,0),s instanceof x?i.copy(s):Array.isArray(s)?i.set(s[0],s[1],s[2]):s instanceof DOMPointReadOnly?i.set(s.x,s.y,s.z):typeof s=="number"?(i.x=s,i.y=t!==void 0?t:i.x,i.z=e!==void 0?e:i.x):typeof s=="object"&&(i.x=s.x,i.y=s.y,i.z=s.z),i}const mO=new $n(()=>new de,30);function gO(s){const t=mO.get();return s?t.copy(s):t.set(0,0,0),t}const yO=new $n(()=>new H,100);function dn(s){const t=yO.get();return t.identity(),s instanceof H?t.copy(s):s instanceof DOMPointReadOnly&&t.set(s.x,s.y,s.z,s.w),t}const ab=new $n(()=>new x,100),Q0=Symbol("lastMatrixWorldUpdateKey");function ae(s,t=null,e=!0){const i=t??ab.get();return s?s.parent?(e&&s.updateWorldMatrix(!0,!1),s.matrixWorldNeedsUpdate&&s[Q0]!==Date.now()&&(s[Q0]=Date.now(),s.updateMatrixWorld()),i.setFromMatrixPosition(s.matrixWorld),i):i.copy(s.position):i.set(0,0,0)}function ei(s,t){if(!s)return s;const e=ab.get();return t!==e&&e.copy(t),((s==null?void 0:s.parent)??s).worldToLocal(e),s.position.set(e.x,e.y,e.z),s}function Cc(s,t,e,i){const n=ab.get();return n.set(t,e,i),ei(s,n),s}const Vf=new $n(()=>new H,100),Wa=new H,bg=new H;function Le(s,t=null){if(!s)return Vf.get().identity();const e=t??Vf.get();return s.parent?(s.getWorldQuaternion(e),e):e.copy(s.quaternion)}function no(s,t){if(!s)return;t!==Wa&&Wa.copy(t);const e=Wa,i=s==null?void 0:s.parent;i==null||i.getWorldQuaternion(bg),bg.invert();const n=bg.multiply(e);s.quaternion.set(n.x,n.y,n.z,n.w)}function dS(s,t,e,i,n){Wa.set(t,e,i,n),no(s,Wa)}const _O=new $n(()=>new x,100),bO=new x;function _t(s,t=null){return t||(t=_O.get()),s?s.parent?(s.getWorldScale(t),t):t.copy(s.scale):t.set(0,0,0)}function zd(s,t){if(!s)return;if(!s.parent){s.scale.copy(t);return}const e=bO;s.parent.getWorldScale(e),s.scale.copy(t),s.scale.divide(e)}const vO=new x,Y0=new H;function o3(s){return Le(s,Y0),vO.set(0,0,1).applyQuaternion(Y0)}const xO=new $n(()=>new x,100),K0=new H;function wO(s,t){return t||(t=xO.get().set(0,0,1)),Le(s,K0),t.applyQuaternion(K0)}const J0=new Ct,Z0=new Ct,SO=new x;function uS(s){const t=Vf.get();return s.getWorldQuaternion(t),Z0.setFromQuaternion(t),Z0}function fS(s,t){const e=Vf.get();no(s,e.setFromEuler(t))}function lb(s){const t=uS(s),e=SO;return e.set(t.x,t.y,t.z),e.x=N.toDegrees(e.x),e.y=N.toDegrees(e.y),e.z=N.toDegrees(e.z),e}function CO(s,t){em(s,t.x,t.y,t.z,!0)}function em(s,t,e,i,n=!0){n&&(t=N.toRadians(t),e=N.toRadians(e),i=N.toRadians(i)),J0.set(t,e,i),Wa.setFromEuler(J0),no(s,Wa)}function Ly(s,t=!0){s&&(t?function e(i){console.groupCollapsed((i.name?i.name:"(no name : "+i.type+")")+" %o",i),i.children.forEach(e),console.groupEnd()}(s):s.traverse(function(e){for(var i="|___",n=e;n.parent!==null;)i="	"+i,n=n.parent;console.log(i+e.name+" <"+e.type+">")}))}function r3(s){let t=(s==null?void 0:s.name)||"";if(!s)return t;let e=s.parent;for(;e;)t=e.name+"/"+t,e=e.parent;return t}function PO(s){if(s){const t=s;return t.blendMode!==void 0&&t.clampWhenFinished!==void 0&&t.enabled!==void 0&&t.fadeIn!==void 0&&t.getClip!==void 0}return!1}const v0=class extends to{constructor(){super({vertexShader:v0.vertex,uniforms:{map:new Un(null),flipY:new Un(!0),writeDepth:new Un(!1),depthTexture:new Un(null)},fragmentShader:`
uniform sampler2D map;
uniform bool flipY;
uniform bool writeDepth;
uniform sampler2D depthTexture;

varying vec2 vUv;

void main(){ 
    vec2 uv = vUv;
    if (flipY) uv.y = 1.0 - uv.y;
    gl_FragColor = texture2D(map, uv);

    if (writeDepth) {
        float depth = texture2D(depthTexture, uv).r;
        gl_FragDepth = depth;

        // float linearDepth = (depth - 0.99) * 100.0; // Enhance near 1.0 values
        // gl_FragColor = vec4(linearDepth, linearDepth, linearDepth, 1.0);
    }
}`})}reset(){this.uniforms.map.value=null,this.uniforms.flipY.value=!0,this.uniforms.writeDepth.value=!1,this.uniforms.depthTexture.value=null,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}};let Qh=v0;a(Qh,"vertex",`
varying vec2 vUv;
void main(){
    vUv = uv;
    gl_Position = vec4(position.xy, 0., 1.0);
}`);const kp=class{static copyTexture(t,e){e||(e=this.blitMaterial),this.blitMaterial.reset();const i=e||this.blitMaterial;i.uniforms.map.value=t,i.needsUpdate=!0,i.uniformsNeedUpdate=!0;const n=i.vertexShader;i.vertexShader=Qh.vertex;const o=this.mesh;o.material=i,o.frustumCulled=!1,this.scene.children.length=0,this.scene.add(o),this.renderer.setSize(t.image.width,t.image.height),this.renderer.clear(),this.renderer.render(this.scene,this.perspectiveCam);const r=new Ke(this.renderer.domElement);return r.name="Copy",r.needsUpdate=!0,i.vertexShader=n,r}static blit(t,e,i){const{renderer:n=this.renderer,blitMaterial:o=this.blitMaterial,flipY:r=!1,depthTexture:l=null,depthTest:c=!0,depthWrite:h=!0}=i||{};this.blitMaterial.reset(),o.uniforms.map&&(o.uniforms.map.value=t),o.uniforms.flipY&&(o.uniforms.flipY.value=r),l?(o.uniforms.writeDepth=new Un(!0),o.uniforms.depthTexture.value=l):(o.uniforms.writeDepth=new Un(!1),o.uniforms.depthTexture.value=null),o.needsUpdate=!0,o.uniformsNeedUpdate=!0;const d=this.mesh;d.material=o,d.frustumCulled=!1,this.scene.children.length=0,this.scene.add(d);const u=n.getRenderTarget(),f=n.getContext(),p=f.getParameter(f.DEPTH_TEST),g=f.getParameter(f.DEPTH_WRITEMASK),_=f.getParameter(f.DEPTH_FUNC);c?n.getContext().enable(n.getContext().DEPTH_TEST):n.getContext().disable(n.getContext().DEPTH_TEST),n.state.buffers.depth.setMask(h),n.setClearColor(new de(0,0,0),0),n.pixelRatio!==window.devicePixelRatio&&n.xr.isPresenting===!1&&n.setPixelRatio(window.devicePixelRatio),n.setRenderTarget(e),n.clear(),n.render(this.scene,this.perspectiveCam),n.setRenderTarget(u);const y=n.state.buffers.depth;y.setTest(p),y.setMask(g),y.setFunc(_)}static textureToCanvas(t,e=!1){if(!t)return null;(e===!0||t.isCompressedTexture===!0)&&(t=RO(t));const i=t.image;if(TO(i)){const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const o=n.getContext("2d");return o?(o.drawImage(i,0,0,i.width,i.height,0,0,n.width,n.height),n):(console.error("Failed getting canvas 2d context"),null)}return null}};let cn=kp;a(cn,"planeGeometry",new ro(2,2,1,1)),a(cn,"renderer",new ol({antialias:!1,alpha:!0})),a(cn,"perspectiveCam",new Se),a(cn,"orthographicCam",new $p),a(cn,"scene",new bn),a(cn,"blitMaterial",new Qh),a(cn,"mesh",new X(kp.planeGeometry,kp.blitMaterial));function RO(s){return cn.copyTexture(s)}function a3(s,t=!1){return cn.textureToCanvas(s,t)}function TO(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}function OO(s){const t=s.type;return t==="Mesh"||t==="SkinnedMesh"}function pS(s,t){t?s["needle:rendercustomshadow"]=!0:s["needle:rendercustomshadow"]=!1}function kO(s){if(s){if(s["needle:rendercustomshadow"]===!0)return!0;if(s["needle:rendercustomshadow"]==null)return!0}return!1}function Qi(s,t=void 0,e=void 0,i=void 0){const n=i||new Nn;n.makeEmpty();const o=[];function r(c){let h=!0;if(c.visible&&dO(c)!==!1&&!(c.type==="TransformControlsGizmo"||c.type==="TransformControlsPlane")){if(c instanceof FP&&(h=!1),c instanceof q_&&(h=!1),c instanceof Sc&&(h=!1),c.isGizmo===!0&&(h=!1),c.material instanceof Dw&&(h=!1),OO(c)||(h=!1),e&&c.layers.test(e)===!1&&(h=!1),h){if(t&&Array.isArray(t)&&(t!=null&&t.includes(c)))return;if(typeof t=="function"&&t(c)===!0)return}if(c.isUI!==!0){if(h){const d=c.children;c.children=o;const u=c.position,f=c.scale;if(Number.isNaN(u.x)||Number.isNaN(u.y)||Number.isNaN(u.z)){console.warn(`Object "${c.name}" has NaN values in position or scale.... will ignore it`,u,f);return}c.geometry===null&&(c.geometry=void 0),n.expandByObject(c,!0),c.children=d}for(const d of c.children)r(d)}}}let l=!1;Array.isArray(s)||(s=[s]);for(const c of s)c&&(l=!0,c.updateMatrixWorld(),r(c));return l||console.warn("No objects to fit camera to..."),n}function EO(s,t,e){const i=Qi([s],e==null?void 0:e.ignore),n=new x;i.getSize(n);const o=new x;i.getCenter(o);const r=new x;t.getSize(r);const l=new x;t.getCenter(l);const c=new x;c.set(r.x/n.x,r.y/n.y,r.z/n.z);const h=Math.min(c.x,c.y,c.z),d=(e==null?void 0:e.scale)!==!1;if(d&&zd(s,_t(s).multiplyScalar(h)),(e==null?void 0:e.position)!==!1){const u=new x;i.getCenter(u),u.y=i.min.y;const f=new x;t.getCenter(f),f.y=t.min.y;const p=f.clone().sub(u);d&&p.multiplyScalar(h),ei(s,ae(s).add(p))}return{boundsBefore:i,scale:c}}function MO(s,t){const e=Qi([s]),i=new x;e.getCenter(i),i.y=e.min.y;const n=t.clone().sub(i),o=ae(s);return ei(s,o.add(n)),{offset:n,bounds:e}}function mS(s,t,e,i){if(Array.isArray(t)){let r=!0;for(let l=0;l<t.length;l++)mS(s,t[l],l,t)||(r=!1);return r}if(t.type==="MeshStandardMaterial"||t.type==="MeshBasicMaterial")return!1;if(t["material:fbx"]!=null)return!0;const n=new It;n["material:fbx"]=t;const o=t;return o&&(o.map?n.color.set(1,1,1):n.color.copyLinearToSRGB(o.color),n.emissive.copyLinearToSRGB(o.emissive),n.emissiveIntensity=o.emissiveIntensity,n.opacity=o.opacity,n.displacementScale=o.displacementScale,n.transparent=o.transparent,n.bumpMap=o.bumpMap,n.aoMap=o.aoMap,n.map=o.map,n.displacementMap=o.displacementMap,n.emissiveMap=o.emissiveMap,n.normalMap=o.normalMap,n.envMap=o.envMap,n.alphaMap=o.alphaMap,n.metalness=o.reflectivity,n.vertexColors=o.vertexColors,o.shininess&&(n.roughness=1-Math.sqrt(o.shininess)/10),n.needsUpdate=!0),e===void 0?s.material=n:i[e]=n,!0}let Ou=!1;JT((...s)=>{var t;U()&&((t=ve.Current)!=null&&t.isInXR)&&(lc(!0),gS("error",...s))});function lc(s){if(s){if(Ou)return;Ou=!0,IO()}else{if(!Ou)return;Ou=!1,DO()}}const Yh={log:void 0,warn:void 0,error:void 0};class AO{constructor(){a(this,"familyName","needle-xr");a(this,"root",null);a(this,"context",null);a(this,"defaultFontSize",.06);a(this,"targetObject",new D);a(this,"userForwardViewPoint",new x);a(this,"oneEuroFilter",new cS(90,.8));a(this,"_lastElementRemoveTime",0);a(this,"onBeforeRender",()=>{var e,i;const t=(e=this.context)==null?void 0:e.mainCamera;if(this.context&&t instanceof Se){const n=this.getRoot();Number.isNaN(n.position.x)&&n.position.set(0,0,0),Number.isNaN(n.quaternion.x)&&n.quaternion.set(0,0,0,1),this.context.scene.add(this.targetObject);const o=((i=this.context.xr)==null?void 0:i.rigScale)??1,r=3.5*o,l=t.worldForward;l.y=0,l.normalize().multiplyScalar(r),this.userForwardViewPoint.copy(t.worldPosition).sub(l),this.targetObject.position.distanceTo(this.userForwardViewPoint)>2*o&&(this.targetObject.position.copy(this.userForwardViewPoint),Zp(this.targetObject,t,!0,!0),this.targetObject.rotateY(Math.PI)),this.oneEuroFilter.filter(this.targetObject.position,n.position,this.context.time.time);const h=this.context.time.deltaTime;if(n.quaternion.slerp(this.targetObject.quaternion,h*5),n.scale.setScalar(o),this.targetObject.removeFromParent(),this.context.scene.add(n),this.context.time.time-this._lastElementRemoveTime>.1){this._lastElementRemoveTime=this.context.time.time;const d=Date.now();for(let u=0;u<this._activeTexts.length;u++){const f=this._activeTexts[u];if(f instanceof ze.Text&&d-f._activatedTime>2e4){f.removeFromParent(),this._textBuffer.push(f),this._activeTexts.splice(u,1);break}}}}});a(this,"textOptions",{fontSize:this.defaultFontSize,fontFamily:this.familyName,padding:.03,margin:.005,color:0,backgroundColor:16777215,backgroundOpacity:.4,borderRadius:.03,offset:.025});a(this,"_textBuffer",[]);a(this,"_activeTexts",[]);this.ensureFont()}onEnable(){this.context=ve.Current||ve.All[0],this.context.pre_render_callbacks.push(this.onBeforeRender)}onDisable(){var t,e,i;(e=this.context)==null||e.pre_render_callbacks.splice((t=this.context)==null?void 0:t.pre_render_callbacks.indexOf(this.onBeforeRender),1),(i=this.root)==null||i.removeFromParent()}addLog(t,e){const i=this.getRoot(),n=this.getText();let o=16777215,r=0;switch(t){case"log":o=16777215,r=0;break;case"warn":o=16772761,r=4465152;break;case"error":o=16755370,r=7798784;break}e.length>1e3&&(e=e.substring(0,1e3)+"...");const l=new Date().toISOString().split("T")[1].split(".")[0];n.textContent="["+l+"] "+e,n.visible=!0,n._activatedTime=Date.now(),i.add(n),this._activeTexts.push(n),this.context&&this.context.scene.add(i),n.set({backgroundColor:o,color:r}),ze.update()}ensureFont(){let t=ze.FontLibrary.getFontFamily(this.familyName);if(!t){t=ze.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{ze.update()})}}getText(){const t=this.getRoot();if(this._textBuffer.length>0){const i=this._textBuffer.pop();return i.visible=!0,setTimeout(()=>this.disableDepthTestRecursive(i),100),i}if(t.children.length>20&&this._activeTexts.length>0)return this._activeTexts.shift();const e=new ze.Text(this.textOptions);return setTimeout(()=>this.disableDepthTestRecursive(e),500),setTimeout(()=>this.disableDepthTestRecursive(e),1500),e}disableDepthTestRecursive(t,e=0){for(let n=0;n<t.children.length;n++){const o=t.children[n];o instanceof D&&this.disableDepthTestRecursive(o,e+1)}t.renderOrder=10*e,t.layers.set(2);const i=t.material;i&&(i.depthWrite=!1,i.depthTest=!1,i.transparent=!0),e===0&&ze.update()}getRoot(){if(this.root)return this.root;const t=this.defaultFontSize,e={boxSizing:"border-box",fontFamily:this.familyName,width:"2.6",fontSize:t,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:0,whiteSpace:"pre-wrap",flexDirection:"column-reverse"};return this.root=new ze.Block(e),this.root}}let Mi=null;function IO(){Mi||(Mi=new AO),Mi.onEnable();for(const s in Yh){Yh[s]=console[s];let t=!1;console[s]=function(){var e;if((e=Yh[s])==null||e.apply(console,arguments),!t)try{t=!0,gS(s,...arguments)}finally{t=!1}}}}function DO(){Mi==null||Mi.onDisable();for(const s in Yh)console[s]=Yh[s]}const yh=new Map;function gS(s,...t){try{switch(yh.clear(),s){case"log":Mi==null||Mi.addLog("log",e());break;case"warn":Mi==null||Mi.addLog("warn",e());break;case"error":Mi==null||Mi.addLog("error",e());break}}catch(o){console.error("Error in spatial console",o)}finally{yh.clear()}function e(){let o="";for(let r=0;r<t.length;r++){const l=t[r];o+=i(l),r<t.length-1&&(o+=", ")}return o}function i(o,r=0){if(typeof o=="string")return'"'+o+'"';if(typeof o=="number"){if(o%1!==0){const c=o.toFixed(5),h=c.indexOf(".");let d=c.length-1;for(;d>h&&c[d]==="0";)d--;return c.substring(0,d+1)}return o.toString()}else if(Array.isArray(o)){let l="[";for(let c=0;c<o.length;c++){const h=o[c];l+=i(h,r+1),c<o.length-1&&(l+=", ")}return l+="]",l}else{if(o===null)return"null";if(o===void 0)return"undefined";if(typeof o=="function")return o.name+"()"}if(o instanceof le)return`(${i(o.x)}, ${i(o.y)})`;if(o instanceof x)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)})`;if(o instanceof Ce)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof H)return`(${i(o.x)}, ${i(o.y)}, ${i(o.z)}, ${i(o.w)})`;if(o instanceof Ie||o instanceof Ke)return o.name;if(o instanceof Lw)return`[${o.elements.join(", ")}]`;if(o instanceof ce)return`[${o.elements.join(", ")}]`;if(o instanceof Vr)return o.mask.toString();if(typeof o=="object"){if(yh.has(o))return"*";let l=`{
`;l+=n(r);const c=Object.keys(o);let h="";for(let d=0;d<c.length;d++){const u=c[d],f=o[u];if(yh.has(f)){h+="";continue}yh.set(f,!0),h+=u+":"+i(f,r+1),d<c.length-1&&(h+=", "),h.length>=60&&(h+=`
`,h+=n(r),l+=h,h="")}return l+=h,l+=`
}`,l}return o}function n(o){let r="";for(let l=0;l<o;l++)r+=" ";return r}}const LO=S("nodevlogs");function nt(s,t=Jt.Log){La(t,s)}function ke(s){nt(s,Jt.Warn)}function tm(s){nt(s,Jt.Error)}let jy,vg;function U(){if(LO)return!1;if(jy!==void 0)return jy;if(vg!==void 0)return vg;let s=fs();return s||(s=window.location.hostname.endsWith(".local-credentialless.webcontainer.io")),vg=s,s}function l3(s){jy=s}let Gi,_o=null,Vs=null,_h=!1,ev=null;const yS="terminal",jO=S("console");jO&&_S();const BO=Symbol("consoleParent");function _S(){if(Gi){Gi.showSwitch();return}WO()}function FO(){Gi&&(Gi.hide(),Gi.hideSwitch())}function zO(){ev||(ev=setInterval(UO,500))}let tv=0;function UO(){const s=oS(),t=s!==tv;tv=s,t&&NO()}function NO(){_S(),Vs&&(Vs.setAttribute("error","true"),Vs.innerText="ðŸ¤¬")}function $O(){Vs&&(Vs.removeAttribute("error"),Vs.innerText=yS)}function WO(s=!1){if(Gi!==void 0||_h)return;_h=!0;const t=document.createElement("script");t.onload=()=>{if(!globalThis.VConsole){console.warn("ðŸŒµ Debug console failed to load."),_h=!1,Gi=null;return}_h=!1,zO(),Gi=new VConsole({pluginOrder:["default","needle-console"]});const e=globalThis["needle:codegen_files"];if(e&&e.length>0&&Gi.addPlugin(VO()),_o=GO(),_o&&(_o[BO]=_o.parentElement,_o.style.position="absolute",_o.style.zIndex=Number.MAX_SAFE_INTEGER.toString()),Gi.setSwitchPosition(20,30),Vs=HO(),Vs){Vs.innerText=yS,Vs.addEventListener("click",$O);const i=document.createElement("style"),n=40;i.innerHTML=`
                #__vconsole .vc-switch {
                    border: 1px solid rgba(255, 255, 255, .1);
                    border-radius: 50%;
                    width: ${n}px;
                    height: ${n}px;
                    padding: 0;
                    line-height: ${n}px;
                    font-size: ${n*.4}px;
                    text-align: center;
                    background: #ffffff5c;
                    backdrop-filter: blur(16px);
                    -webkit-backdrop-filter: blur(16px);
                    user-select: none;
                    pointer-events: auto;
                    transition: transform .2s ease-in-out;
                    box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);

                    font-family: 'Material Symbols Outlined';
                    color: black;
                    font-size: 2.3em;
                    font-weight: 100;
                }
                #__vconsole .vc-switch:hover {
                    cursor: pointer;
                    transform: scale(1.1);
                    transition: transform .1s ease-in-out, background .1s linear;
                    background: rgba(245, 245, 245, .8);
                    outline: rgba(0, 0, 0, .05) 1px solid;
                }
                #__vconsole .vc-switch[error] {
                    background: rgba(255,0,0,.2);
                    animation: vconsole-notify 1s ease-in-out;
                    line-height: 35px;
                }
                @keyframes vconsole-notify {
                    from {
                        transform: scale(1, 1);
                    }
                    10% {
                        transform: scale(1.3, 1.3);
                    }
                    70% {
                        transform: scale(1.4, 1.4);
                    }
                    to {
                        transform: scale(1, 1);
                    }
                }
                #__vconsole .vc-panel {
                    font-family: monospace;
                    font-size: 11px;
                }
                #__vconsole .vc-plugin-box.vc-actived {
                    height: 100%;
                }
                #__vconsole .vc-mask {
                    overflow: hidden;
                }
            `,_o==null||_o.prepend(i),s===!0&&oS()<=0&&FO(),console.log("ðŸŒµ Debug console has loaded")}},t.onerror=()=>{console.warn("ðŸŒµ Debug console failed to load."+(window.crossOriginIsolated?"This page is using cross-origin isolation, so external scripts can't be loaded.":"")),_h=!1,Gi=null},t.src="https://cdn.jsdelivr.net/npm/vconsole@3.15.1/dist/vconsole.min.js",document.body.appendChild(t)}function VO(){if(!globalThis.VConsole)return;const s=new VConsole.VConsolePlugin("needle-console","ðŸŒµ Inspect glTF"),t=()=>document.querySelector("#__vc_plug_"+s._id+" iframe");return s.on("renderTab",function(e){const i=globalThis["needle:codegen_files"];if(!i||i.length===0)return;let n=globalThis["needle:codegen_files"][0];const o=n.indexOf("?");o>-1&&(n=n.substring(0,o));const l=location.protocol+"//"+location.host+location.pathname+"/"+n,c=encodeURIComponent(l);s.fullUrl="https://viewer.needle.tools?inspect&file="+c;var h='<iframe src="" style="width: 100%; height: 99%; border: none;"></iframe>';e(h)}),s.on("show",function(){const e=t();e&&e.src!==s.fullUrl&&(e.src=s.fullUrl)}),s.on("hide",function(){const e=t();e&&(e.src="")}),s.on("addTopBar",function(e){var i=new Array;i.push({name:"Open in new window â†—",onClick:function(n){window.open(s.fullUrl,"_blank"),Gi==null||Gi.hide()}}),i.push({name:"Reload",onClick:function(n){const o=t();o&&(o.src=s.fullUrl)}}),i.push({name:"Fullscreen",onClick:function(n){const o=t();o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen instanceof Function&&o.webkitRequestFullscreen()}}),e(i)}),s}function HO(){const s=document.querySelector("#__vconsole .vc-switch");return s||null}function GO(){const s=document.querySelector("#__vconsole");return s||null}const bS=S("debugdefines");Qr('if(!globalThis[""4.9.3""]) globalThis[""4.9.3""] = "0.0.0";');Qr('if(!globalThis[""Unity 2021.3.45f1, Needle Engine Integration @4.9.3""]) globalThis[""Unity 2021.3.45f1, Needle Engine Integration @4.9.3""] = "unknown";');Qr('if(!globalThis[""Fri Sep 19 2025 14:46:20 GMT+0200 (MitteleuropÃ¤ische Sommerzeit)""]) globalThis[""Fri Sep 19 2025 14:46:20 GMT+0200 (MitteleuropÃ¤ische Sommerzeit)""] = "unknown";');Qr('if(!globalThis[""npk_a693985ecf8c6d819a54aded2a2bd0e11ff7d3efa928c3a0ec39fea9d91bbd9b""]) globalThis[""npk_a693985ecf8c6d819a54aded2a2bd0e11ff7d3efa928c3a0ec39fea9d91bbd9b""] = "unknown";');Qr('globalThis["__NEEDLE_ENGINE_VERSION__"] = "4.9.3";');Qr('globalThis["__NEEDLE_ENGINE_GENERATOR__"] = "Unity 2021.3.45f1, Needle Engine Integration @4.9.3";');Qr('globalThis["__NEEDLE_PROJECT_BUILD_TIME__"] = "Fri Sep 19 2025 14:46:20 GMT+0200 (MitteleuropÃ¤ische Sommerzeit)";');Qr('globalThis["__NEEDLE_PUBLIC_KEY__"] = "npk_a693985ecf8c6d819a54aded2a2bd0e11ff7d3efa928c3a0ec39fea9d91bbd9b";');const as="4.9.3",cb="Unity 2021.3.45f1, Needle Engine Integration @4.9.3",vS="Fri Sep 19 2025 14:46:20 GMT+0200 (MitteleuropÃ¤ische Sommerzeit)";bS&&console.log(`Engine version: ${as} (generator: ${cb})
Project built at ${vS}`);const _f="npk_a693985ecf8c6d819a54aded2a2bd0e11ff7d3efa928c3a0ec39fea9d91bbd9b",jr="needle_isActiveInHierarchy",Il="builtin_components",bf="needle_editor_guid";function Qr(s){try{(0,eval)(s)}catch(t){bS&&console.error(t)}}let xS,iv=null;function so(){return xS}function wS(s){if(s==null){console.warn("Oh no: someone tried registering a non-existend gltf-loader. When you see this log it might mean that needle-engine is being imported multiple times. Please check your project setup.");return}iv!==s&&(iv=s,xS=new s)}const fn=Symbol("shadowDomOwner"),qO=S("debugpatch");function hb(s,t,e,i){const n=qO===t;if(!e&&!i)return;const o=t+"___needle";XO(s,t,e,i);const r=Object.getOwnPropertyDescriptor(s,t),l=s[t];n&&console.log("Patch",s.constructor.name,t,r,l),r?(n&&console.log("Apply patch with existing descriptor",s.constructor.name,t,r),typeof r.value=="function"&&(s[t]=sv(r.value,s,t))):(n&&console.log("Create patch with new property",s.constructor.name,t,r),Object.defineProperty(s,t,{set:function(c){if(typeof c=="function")this[o]=sv(c,s,t);else{const h=this[o];SS(s,t,this,h,c),this[o]=c,CS(s,t,this,h,c)}},get:function(){const c=this[o];return typeof c=="function"&&c[o]?c[o]:c}}))}function c3(s,t,e){const i=db(s,t);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];o.prefix===e&&(o.prefix=null),o.postfix===e&&(o.postfix=null),!o.prefix&&!o.postfix&&i.splice(n,1)}}const nv=Symbol("Needle:Patches:WrappedFunction");function sv(s,t,e){if(s[nv])return s;const i=function(...n){SS(t,e,this,...n);const o=s.apply(this,n);return CS(t,e,this,o,...n),o};return i[nv]=!0,i}const xg="Needle:Patches";function By(){return globalThis[xg]||(globalThis[xg]=new WeakMap),globalThis[xg]}function db(s,t){const e=By().get(s);return e?e.get(t):null}function XO(s,t,e,i){let n=By().get(s);n||(n=new Map,By().set(s,n));let o=n.get(t);o||(o=[],n.set(t,o)),o.push({prefix:e,postfix:i})}function SS(s,t,e,...i){var o;if(!e)return;const n=db(s,t);if(n)for(const r of n)(o=r.prefix)==null||o.call(e,...i)}function CS(s,t,e,i,...n){var r;if(!e)return;const o=db(s,t);if(o)for(const l of o)(r=l.postfix)==null||r.call(e,i,...n)}const Pc=[];function ub(s){Pc.indexOf(s)===-1&&Pc.push(s)}function h3(s){const t=Pc.indexOf(s);t!==-1&&Pc.splice(t,1)}const Rc=[];function PS(s){Rc.indexOf(s)===-1&&Rc.push(s)}function d3(s){const t=Rc.indexOf(s);t!==-1&&Rc.splice(t,1)}function QO(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-start",{detail:s}));for(let t=0;t<Pc.length;t++)Pc[t](s)}function YO(s){globalThis.dispatchEvent(new CustomEvent("needle-xrsession-end",{detail:s}));for(let t=0;t<Rc.length;t++)Rc[t](s)}const At={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function RS(s){const t=await fetch(s);if(t.ok)return t.json();throw new Error(t.statusText)}async function KO(s){if(!s)throw new Error("No basePath supplied");return await RS(`${s}/profilesList.json`)}async function JO(s,t,e=null,i=!0){if(!s)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const n=await KO(t);let o;if(s.profiles.some(c=>{const h=n[c];return h&&(o={profileId:c,profilePath:`${t}/${h.path}`,deprecated:!!h.deprecated}),!!o}),!o){if(!e)throw new Error("No matching profile name found");const c=n[e];if(!c)throw new Error(`No matching profile name found and default profile "${e}" missing.`);o={profileId:e,profilePath:`${t}/${c.path}`,deprecated:!!c.deprecated}}const r=await RS(o.profilePath);let l;if(i){let c;if(s.handedness==="any"?c=r.layouts[Object.keys(r.layouts)[0]]:c=r.layouts[s.handedness],!c)throw new Error(`No matching handedness, ${s.handedness}, in profile ${o.profileId}`);c.assetPath&&(l=o.profilePath.replace("profile.json",c.assetPath))}return{profile:r,assetPath:l}}const ZO={xAxis:0,yAxis:0,button:0,state:At.ComponentState.DEFAULT};function ek(s=0,t=0){let e=s,i=t;if(Math.sqrt(s*s+t*t)>1){const r=Math.atan2(t,s);e=Math.cos(r),i=Math.sin(r)}return{normalizedXAxis:e*.5+.5,normalizedYAxis:i*.5+.5}}class tk{constructor(t){this.componentProperty=t.componentProperty,this.states=t.states,this.valueNodeName=t.valueNodeName,this.valueNodeProperty=t.valueNodeProperty,this.valueNodeProperty===At.VisualResponseProperty.TRANSFORM&&(this.minNodeName=t.minNodeName,this.maxNodeName=t.maxNodeName),this.value=0,this.updateFromComponent(ZO)}updateFromComponent({xAxis:t,yAxis:e,button:i,state:n}){const{normalizedXAxis:o,normalizedYAxis:r}=ek(t,e);switch(this.componentProperty){case At.ComponentProperty.X_AXIS:this.value=this.states.includes(n)?o:.5;break;case At.ComponentProperty.Y_AXIS:this.value=this.states.includes(n)?r:.5;break;case At.ComponentProperty.BUTTON:this.value=this.states.includes(n)?i:0;break;case At.ComponentProperty.STATE:this.valueNodeProperty===At.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(n):this.value=this.states.includes(n)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}let ik=class{constructor(t,e){if(!t||!e||!e.visualResponses||!e.gamepadIndices||Object.keys(e.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=t,this.type=e.type,this.rootNodeName=e.rootNodeName,this.touchPointNodeName=e.touchPointNodeName,this.visualResponses={},Object.keys(e.visualResponses).forEach(i=>{const n=new tk(e.visualResponses[i]);this.visualResponses[i]=n}),this.gamepadIndices=Object.assign({},e.gamepadIndices),this.values={state:At.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(t){if(this.values.state=At.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&t.buttons.length>this.gamepadIndices.button){const e=t.buttons[this.gamepadIndices.button];this.values.button=e.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,e.pressed||this.values.button===1?this.values.state=At.ComponentState.PRESSED:(e.touched||this.values.button>At.ButtonTouchThreshold)&&(this.values.state=At.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&t.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=t.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===At.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>At.AxisTouchThreshold&&(this.values.state=At.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&t.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=t.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===At.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>At.AxisTouchThreshold&&(this.values.state=At.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(e=>{e.updateFromComponent(this.values)})}};class nk{constructor(t,e,i){if(!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No profile supplied");this.xrInputSource=t,this.assetUrl=i,this.id=e.profileId,this.layoutDescription=e.layouts[t.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(n=>{const o=this.layoutDescription.components[n];this.components[n]=new ik(n,o)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const t=[];return Object.values(this.components).forEach(e=>{t.push(e.data)}),t}updateFromGamepad(){Object.values(this.components).forEach(t=>{t.updateFromGamepad(this.xrInputSource.gamepad)})}}const wt=S("debuginput");var kr;(function(s){s.Mouse="mouse",s.Touch="touch",s.Controller="controller",s.Hand="hand"})(kr||(kr={}));var ov;(function(s){s.PointerDown="pointerdown",s.PointerUp="pointerup",s.PointerMove="pointermove"})(ov||(ov={}));var rv;(function(s){s.KeyDown="keydown",s.KeyUp="keyup",s.KeyPressed="keypress"})(rv||(rv={}));var _e;(function(s){s.PointerDown="pointerdown",s.PointerUp="pointerup",s.PointerMove="pointermove",s.KeyDown="keydown",s.KeyUp="keyup",s.KeyPressed="keypress"})(_e||(_e={}));class gr extends PointerEvent{constructor(e,i,n){super(e,n);a(this,"clientZ");a(this,"deviceIndex");a(this,"origin");a(this,"source");a(this,"mode");a(this,"_ray");a(this,"space");a(this,"isClick",!1);a(this,"isDoubleClick",!1);a(this,"_used",!1);a(this,"_pointerid");a(this,"_pointerType");a(this,"_type");a(this,"metadata",{});a(this,"intersections",new Array);a(this,"_immediatePropagationStopped",!1);a(this,"_propagationStopped",!1);this.clientZ=n.clientZ,this._pointerid=n.pointerId,this._pointerType=n.pointerType,this._type=e,this.deviceIndex=n.deviceIndex,this.origin=n.origin,this.source=i,this.mode=n.mode,this._ray=n.ray,this.space=n.device}get isSpatial(){return this.mode!="screen"}get ray(){return this._ray||(this._ray=new Hr(this.space.worldPosition.clone(),this.space.worldForward.clone())),this._ray}set ray(e){this._ray=e}get hasRay(){return this._ray!==void 0}get used(){return this._used}use(){this._used=!0}get pointerId(){return this._pointerid}get pointerType(){return this._pointerType}get type(){return this._type}get immediatePropagationStopped(){return this._immediatePropagationStopped}get propagationStopped(){return this._immediatePropagationStopped||this._propagationStopped}stopImmediatePropagation(){var e;this._immediatePropagationStopped=!0,super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}stopPropagation(){var e;this._propagationStopped=!0,super.stopPropagation(),(e=this.source)==null||e.stopPropagation(),wt&&console.warn("Stop propagation...",this.pointerId,this.pointerType)}}class ku extends KeyboardEvent{constructor(e,i,n){super(e,n);a(this,"source");this.source=i}stopImmediatePropagation(){var e;super.stopImmediatePropagation(),(e=this.source)==null||e.stopImmediatePropagation()}}class f3{constructor(t){a(this,"key");a(this,"keyType");a(this,"source");this.key=t.key,this.keyType=t.type,this.source=t}}var qi;(function(s){s[s.Early=-100]="Early",s[s.Default=0]="Default",s[s.Late=100]="Late"})(qi||(qi={}));class sk{constructor(t){a(this,"_eventListeners",{});a(this,"_doubleClickTimeThreshold",.2);a(this,"_longPressTimeThreshold",1);a(this,"_setCursorTypes",[]);a(this,"context");a(this,"_pointerDown",[!1]);a(this,"_pointerUp",[!1]);a(this,"_pointerClick",[!1]);a(this,"_pointerDoubleClick",[!1]);a(this,"_pointerPressed",[!1]);a(this,"_pointerPositions",[new le]);a(this,"_pointerPositionsLastFrame",[new le]);a(this,"_pointerPositionsDelta",[new le]);a(this,"_pointerPositionsRC",[new le]);a(this,"_pointerPositionDown",[new x]);a(this,"_pointerDownTime",[]);a(this,"_pointerUpTime",[]);a(this,"_pointerUpTimestamp",[]);a(this,"_pointerIds",[]);a(this,"_pointerTypes",[""]);a(this,"_mouseWheelChanged",[!1]);a(this,"_mouseWheelDeltaY",[0]);a(this,"_pointerEvent",[]);a(this,"_pointerEventsPressed",[]);a(this,"_pointerSpace",[]);a(this,"_pressedStack",new Map);a(this,"_htmlEventSource");a(this,"onLostFocus",()=>{for(const t in this.keysPressed)this.keysPressed[t].pressed=!1});a(this,"_receivedPointerMoveEventsThisFrame",new Array);a(this,"onEndOfFrame",()=>{this._receivedPointerMoveEventsThisFrame.length=0;for(let t=0;t<this._pointerUp.length;t++)this._pointerUp[t]=!1;for(let t=0;t<this._pointerDown.length;t++)this._pointerDown[t]=!1;for(let t=0;t<this._pointerClick.length;t++)this._pointerClick[t]=!1;for(let t=0;t<this._pointerDoubleClick.length;t++)this._pointerDoubleClick[t]=!1;for(const t of this._pointerPositionsDelta)t.set(0,0);for(let t=0;t<this._mouseWheelChanged.length;t++)this._mouseWheelChanged[t]=!1;for(let t=0;t<this._mouseWheelDeltaY.length;t++)this._mouseWheelDeltaY[t]=0});a(this,"onContextMenu",t=>{this.canReceiveInput(t)!==!1&&t instanceof PointerEvent&&t.pointerType});a(this,"keysPressed",{});a(this,"onKeyDown",t=>{if(wt&&console.log(`key down ${t.code}, ${this.context.application.hasFocus}`,t),!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(e&&e.pressed)return;this.keysPressed[t.code]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:t.key,code:t.code};const i=new ku(_e.KeyDown,t,t);this.onDispatchEvent(i)});a(this,"onKeyPressed",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!0,e.frame=this.context.time.frameCount+1;const i=new ku(_e.KeyPressed,t,t);this.onDispatchEvent(i)});a(this,"onKeyUp",t=>{if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.code];if(!e)return;e.pressed=!1,e.frame=this.context.time.frameCount+1;const i=new ku(_e.KeyUp,t,t);this.onDispatchEvent(i)});a(this,"onWheelWindow",t=>{document.pointerLockElement&&this.onMouseWheel(t)});a(this,"onMouseWheel",t=>{if(this.canReceiveInput(t)===!1)return;this._mouseWheelDeltaY.length<=0&&this._mouseWheelDeltaY.push(0),this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0;const e=this._mouseWheelDeltaY[0];this._mouseWheelDeltaY[0]=e+t.deltaY});a(this,"onPointerDown",t=>{if(this.context.isInAR||this.canReceiveInput(t)===!1)return;t.target instanceof HTMLElement&&t.target.setPointerCapture(t.pointerId);const e=this.getPointerId(t);wt&&nt(`pointer down #${e}, identifier:${t.pointerId}`);const i=this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),n=new gr(_e.PointerDown,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:i,pressure:t.pressure});this.onDown(n)});a(this,"onPointerMove",t=>{if(this.context.isInAR||this._receivedPointerMoveEventsThisFrame.includes(t.pointerId))return;this._receivedPointerMoveEventsThisFrame.push(t.pointerId);let e=t.button;t.pointerType==="mouse"&&(e=this.getFirstPressedButtonForPointer(0)??0);const i=this.getPointerId(t,e);e===-1&&(e=i);const n=this.getAndUpdateSpatialObjectForScreenPosition(i,t.clientX,t.clientY),o=new gr(_e.PointerMove,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:i,button:e,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:n,pressure:t.pressure});this.onMove(o)});a(this,"onPointerCancel",t=>{this.context.isInAR||(wt&&console.log("Pointer cancel",t),this.onPointerUp(t))});a(this,"onPointerUp",t=>{if(this.context.isInAR)return;t.target instanceof HTMLElement&&t.target.releasePointerCapture(t.pointerId);const e=this.getPointerId(t),i=new gr(_e.PointerUp,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:e,button:t.button,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,buttonName:this.getButtonName(t),device:this.getAndUpdateSpatialObjectForScreenPosition(e,t.clientX,t.clientY),pressure:t.pressure});this.onUp(i),this._pointerIds[e]=-1,wt&&console.log("ID="+e,"PointerId="+t.pointerId,"ALL:",[...this._pointerIds])});a(this,"onTouchStart",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),r=new gr(_e.PointerDown,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onDown(r)}});a(this,"onTouchMove",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),r=new gr(_e.PointerMove,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:o,pressure:i.force});this.onMove(r)}});a(this,"onTouchEnd",t=>{if(this.context.isInAR)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=this.getPointerIndex(i.identifier),o=new gr(_e.PointerUp,t,{origin:this,mode:"screen",deviceIndex:0,pointerId:n,button:0,clientX:i.clientX,clientY:i.clientY,pointerType:"touch",buttonName:"unknown",device:this.getAndUpdateSpatialObjectForScreenPosition(n,i.clientX,i.clientY),pressure:i.force});this.onUp(o),this._pointerIds[n]=-1}});a(this,"tempNearPlaneVector",new x);a(this,"tempFarPlaneVector",new x);a(this,"tempLookMatrix",new ce);this.context=t,this.context.post_render_callbacks.push(this.onEndOfFrame)}addEventListener(t,e,i){if(this._eventListeners[t]||(this._eventListeners[t]=[]),!e||typeof e!="function"){console.error("Invalid call to addEventListener: callback is required and must be a function!");return}i?i={...i}:i={};let n=0;(i==null?void 0:i.queue)!=null&&(n=i.queue);const o=this._eventListeners[t],r=o.find(l=>l.priority===n);r?r.listeners.push({callback:e,options:i}):(o.push({priority:n,listeners:[{callback:e,options:i}]}),o.sort((l,c)=>l.priority-c.priority))}removeEventListener(t,e,i){if(!this._eventListeners[t]||!e)return;const n=this._eventListeners[t];if((i==null?void 0:i.queue)!=null){const o=n.find(l=>l.priority===i.queue);if(!o)return;const r=o.listeners.findIndex(l=>l.callback===e);r>=0&&o.listeners.splice(r,1)}else for(const o of n){const r=o.listeners.findIndex(l=>l.callback===e);r>=0&&o.listeners.splice(r,1)}}dispatchEvent(t){var i,n,o,r;let e=!1;if(t instanceof ku){const l=this._eventListeners[t.type];if(l)for(const c of l)for(let h=0;h<c.listeners.length;h++){const d=c.listeners[h];if((n=(i=d.options)==null?void 0:i.signal)!=null&&n.aborted){c.listeners.splice(h,1),h--;continue}d.options.once&&(c.listeners.splice(h,1),h--),d.callback(t)}}if(t instanceof gr){const l=this._eventListeners[t.type];if(l)for(const c of l){if(e)break;for(let h=0;h<c.listeners.length;h++){const d=c.listeners[h];if((r=(o=d.options)==null?void 0:o.signal)!=null&&r.aborted){c.listeners.splice(h,1),h--;continue}if(t.immediatePropagationStopped){e=!0,wt&&console.log("immediatePropagationStopped",t.type);break}else t.propagationStopped&&(e=!0,wt&&console.log("propagationStopped",t.type));d.options.once&&(c.listeners.splice(h,1),h--),d.callback(t)}}}}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}get click(){return this._pointerClick[0]}get doubleClick(){return this._pointerDoubleClick[0]}getGamepad(t=0){return typeof navigator<"u"&&"getGamepads"in navigator&&navigator.getGamepads()[t]||null}setCursorPointer(){this.setCursor("pointer")}setCursorNormal(){this.unsetCursor("pointer")}setCursor(t){this._setCursorTypes.push(t),this._setCursorTypes.length>10&&this._setCursorTypes.shift(),this.updateCursor()}unsetCursor(t){for(let e=this._setCursorTypes.length-1;e>=0;e--)if(this._setCursorTypes[e]===t){this._setCursorTypes.splice(e,1),this.updateCursor();break}}updateCursor(){var t;((t=this._setCursorTypes)==null?void 0:t.length)==0?this.context.domElement.style.cursor="default":this.context.domElement.style.cursor=this._setCursorTypes[this._setCursorTypes.length-1]}getIsPointerIdInUse(t){for(const e of this._pointerEventsPressed)if(e.pointerId===t&&e.used)return!0;return!1}getPointerPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&t++;return t}getPointerPosition(t){return t>=this._pointerPositions.length?null:this._pointerPositions[t]}getPointerPositionLastFrame(t){return t>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[t]}getPointerPositionDelta(t){return t>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[t]}getPointerPositionRC(t){return t>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[t]}getPointerDown(t){return t>=this._pointerDown.length?!1:this._pointerDown[t]}getPointerUp(t){return t>=this._pointerUp.length?!1:this._pointerUp[t]}getPointerPressed(t){return t>=this._pointerPressed.length?!1:this._pointerPressed[t]}getPointerClicked(t){return t>=this._pointerClick.length?!1:this._pointerClick[t]}getPointerDoubleClicked(t){return t>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[t]}getPointerDownTime(t){return t>=this._pointerDownTime.length?-1:this._pointerDownTime[t]}getPointerUpTime(t){return t>=this._pointerUpTime.length?-1:this._pointerUpTime[t]}getPointerLongPress(t){return t>=this._pointerDownTime.length?!1:this.getPointerPressed(t)&&this.context.time.time-this._pointerDownTime[t]>this._longPressTimeThreshold}getIsMouse(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]===kr.Mouse}getIsTouch(t){return t<0||t>=this._pointerTypes.length?!1:this._pointerTypes[t]===kr.Touch}getTouchesPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&this.getIsTouch(e)&&t++;return t}getMouseWheelChanged(t=0){return t>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[t]}getMouseWheelDeltaY(t=0){return t>=this._mouseWheelDeltaY.length?0:this._mouseWheelDeltaY[t]}getPointerEvent(t){if(!(t>=this._pointerEvent.length))return this._pointerEvent[t]??void 0}*foreachPointerId(t){for(let e=0;e<this._pointerTypes.length;e++)if(this._pointerIsActive(e)){if(t!==void 0){const i=this._pointerTypes[e];if(Array.isArray(t)){let n=!1;for(const o of t)if(i===o){n=!0;break}if(!n)continue}else if(t!==i)continue}yield e}}*foreachTouchId(){for(let t=0;t<this._pointerTypes.length;t++)this._pointerTypes[t]===kr.Touch&&this._pointerIsActive[t]&&(yield t)}_pointerIsActive(t){return t<0?!1:this._pointerPressed[t]||this._pointerDown[t]||this._pointerUp[t]}onDownButton(t,e){let i=this._pressedStack.get(t);i||(i=[],this._pressedStack.set(t,i)),i.push(e)}onReleaseButton(t,e){const i=this._pressedStack.get(t);if(!i)return;const n=i.indexOf(e);n>=0&&i.splice(n,1)}getFirstPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[0]}getLatestPressedButtonForPointer(t){const e=this._pressedStack.get(t);if(e)return e[e.length-1]}getKeyDown(t){if(t!==void 0)return this.isKeyDown(t);for(const e in this.keysPressed){const i=this.keysPressed[e];if(i.startFrame===this.context.time.frameCount)return i.key}return null}getKeyPressed(t){if(t!==void 0)return this.isKeyPressed(t);for(const e in this.keysPressed){const i=this.keysPressed[e];if(i.pressed)return i.key}return null}getKeyUp(t){if(t!==void 0)return this.isKeyUp(t);for(const e in this.keysPressed){const i=this.keysPressed[e];return i.pressed===!1&&i.frame===this.context.time.frameCount}return null}isKeyDown(t){if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyDown(n))return!0;return!1}const i=this.keysPressed[t];return i?i.startFrame===this.context.time.frameCount&&i.pressed:!1}isKeyUp(t){if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyUp(n))return!0;return!1}const i=this.keysPressed[t];return i?i.frame===this.context.time.frameCount&&i.pressed===!1:!1}isKeyPressed(t){if(!this.context.application.isVisible||!this.context.application.hasFocus)return!1;const e=this.getCodeForCommonKeyName(t);if(e!==null){for(const n of e)if(this.isKeyPressed(n))return!0;return!1}const i=this.keysPressed[t];return i&&i.pressed||!1}getCodeForCommonKeyName(t){if(t.length===1){if(t>="0"&&t<="9")return["Digit"+t];if(t>="a"&&t<="z")return["Key"+t.toUpperCase()];if(t==" ")return["Space"]}switch(t){case"shift":case"Shift":return["ShiftLeft","ShiftRight"];case"control":case"Control":return["ControlLeft","ControlRight"];case"alt":case"Alt":return["AltLeft","AltRight"]}return null}createInputEvent(t){switch(t.type){case _e.PointerDown:wt&&nt("Create Pointer down"),this.onDownButton(t.deviceIndex,t.button),this.onDown(t);break;case _e.PointerMove:wt&&nt("Create Pointer move"),this.onMove(t);break;case _e.PointerUp:wt&&nt("Create Pointer up"),this.onUp(t),this.onReleaseButton(t.deviceIndex,t.button);break}}convertScreenspaceToRaycastSpace(t){return t.x=(t.x-this.context.domX)/this.context.domWidth*2-1,t.y=-((t.y-this.context.domY)/this.context.domHeight)*2+1,t}bindEvents(){this.unbindEvents(),this._htmlEventSource=this.context.renderer.domElement,window.addEventListener("contextmenu",this.onContextMenu),this._htmlEventSource.addEventListener("pointerdown",this.onPointerDown,{passive:!0}),window.addEventListener("pointermove",this.onPointerMove,{passive:!0,capture:!0}),window.addEventListener("pointerup",this.onPointerUp,{passive:!0}),window.addEventListener("pointercancel",this.onPointerCancel,{passive:!0}),window.addEventListener("touchstart",this.onTouchStart,{passive:!0}),window.addEventListener("touchmove",this.onTouchMove,{passive:!0}),window.addEventListener("touchend",this.onTouchEnd,{passive:!0}),this._htmlEventSource.addEventListener("wheel",this.onMouseWheel,{passive:!0}),window.addEventListener("wheel",this.onWheelWindow,{passive:!0}),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keypress",this.onKeyPressed,!1),window.addEventListener("keyup",this.onKeyUp,!1),window.addEventListener("blur",this.onLostFocus)}unbindEvents(){var t,e;for(const i in this._eventListeners)this._eventListeners[i].length=0;window.removeEventListener("contextmenu",this.onContextMenu),(t=this._htmlEventSource)==null||t.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("pointercancel",this.onPointerCancel),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("touchend",this.onTouchEnd),(e=this._htmlEventSource)==null||e.removeEventListener("wheel",this.onMouseWheel,!1),window.removeEventListener("wheel",this.onWheelWindow,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keypress",this.onKeyPressed,!1),window.removeEventListener("keyup",this.onKeyUp,!1),window.removeEventListener("blur",this.onLostFocus)}dispose(){const t=this.context.post_render_callbacks.indexOf(this.onEndOfFrame);t>=0&&this.context.post_render_callbacks.splice(t,1),this.unbindEvents()}canReceiveInput(t){var e;return t.target===((e=this.context.renderer)==null?void 0:e.domElement)||t.target===this.context.domElement||this.context.isInAR||this.context.isInAR&&t.target===document.body&&K.isMozillaXR()?!0:(wt&&console.warn("CanReceiveInput:False for",t.target),!1)}getPointerId(t,e){return t.pointerType==="mouse"?0+(e??t.button):this.getPointerIndex(t.pointerId)}getButtonName(t){const e=t.button;if(t.pointerType==="mouse")switch(e){case 0:return"left";case 1:return"middle";case 2:return"right"}return"unknown"}getAndUpdateSpatialObjectForScreenPosition(t,e,i){let n=this._pointerSpace[t];n||(n=new D,this._pointerSpace[t]=n),this._pointerSpace[t]=n;const o=this.context.mainCamera;if(o){const r=this.tempNearPlaneVector.set(e,i,-1);this.convertScreenspaceToRaycastSpace(r);const l=this.tempFarPlaneVector.set(r.x,r.y,1);r.unproject(o),l.unproject(o);const c=o.worldUp||q(0,1,0).applyQuaternion(Le(o));this.tempLookMatrix.lookAt(l,r,c),n.position.set(r.x,r.y,r.z),n.quaternion.setFromRotationMatrix(this.tempLookMatrix)}return n}isInRect(t){if(this.context.isInXR)return!0;const e=this.context.domElement.getBoundingClientRect(),i=t.clientX,n=t.clientY,o=i>=e.x&&i<=e.right&&n>=e.y&&n<=e.bottom;return wt&&!o&&console.log("Not in rect",e,i,n),o}onDown(t){const e=t.pointerId;if(this.getPointerPressed(e)&&console.warn(`Received pointerDown for pointerId that is already pressed: ${e}`,wt?t:""),wt&&console.log(t.pointerType,"DOWN",e),!!this.isInRect(t)){for(this.setPointerState(e,this._pointerPressed,!0),this.setPointerState(e,this._pointerDown,!0),this.setPointerStateT(e,this._pointerEvent,t.source);e>=this._pointerTypes.length;)this._pointerTypes.push(t.pointerType);for(this._pointerTypes[e]=t.pointerType;e>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new x);for(this._pointerPositionDown[e].set(t.clientX,t.clientY,t.clientZ??0);e>=this._pointerPositions.length;)this._pointerPositions.push(new le);this._pointerPositions[e].set(t.clientX,t.clientY),e>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[e]=this.context.time.realtimeSinceStartup,this.updatePointerPosition(t),this._pointerEventsPressed.push(t),this.onDispatchEvent(t)}}onMove(t){const e=t.pointerId,i=this.getPointerPressed(e);i===!1&&!this.isInRect(t)||t.pointerType===kr.Touch&&!i||(this.updatePointerPosition(t),this.setPointerStateT(e,this._pointerEvent,t.source),this.onDispatchEvent(t))}onUp(t){const e=t.pointerId;if(!this.getPointerPressed(e)){wt&&console.log(t.pointerType,"UP",e,"was not down");return}wt&&console.log(t.pointerType,"UP",e),this.setPointerState(e,this._pointerPressed,!1),this.setPointerStateT(e,this._pointerEvent,t.source),this.setPointerState(e,this._pointerUp,!0),this.updatePointerPosition(t);for(let c=this._pointerEventsPressed.length-1;c>=0;c--)if(this._pointerEventsPressed[c].pointerId===e){this._pointerEventsPressed.splice(c,1);break}if(!this._pointerPositionDown[e]){wt&&ke("Received pointer up event without matching down event for button: "+e),console.warn("Received pointer up event without matching down event for button: "+e);return}const n=this._pointerUpTime[e],o=this._pointerDownTime[e],r=this.context.time.realtimeSinceStartup,l=r-o;if(e>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),this._pointerUpTime[e]=r,l<1){let c=t.clientX-this._pointerPositionDown[e].x,h=t.clientY-this._pointerPositionDown[e].y,d=0;if(t.isSpatial&&t.clientZ!=null&&(d=t.clientZ-this._pointerPositionDown[e].z,c*=200,h*=200,d*=200),Math.abs(c)<5&&Math.abs(h)<5&&Math.abs(d)<5){this.setPointerState(e,this._pointerClick,!0),t.isClick=!0;const u=r-n;wt&&console.log("CLICK",e,c,h,d,u),u<this._doubleClickTimeThreshold&&u>0&&(this.setPointerState(e,this._pointerDoubleClick,!0),t.isDoubleClick=!0)}}this.onDispatchEvent(t)}updatePointerPosition(t){const e=t.pointerId;for(;e>=this._pointerPositions.length;)this._pointerPositions.push(new le);for(;e>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new le);for(;e>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new le);const i=this._pointerPositionsLastFrame[e];i.copy(this._pointerPositions[e]);const n=this._pointerPositionsDelta[e];let o=t.clientX-i.x,r=t.clientY-i.y;if(t.source instanceof MouseEvent||t.source instanceof TouchEvent){const d=t.source;o===0&&d.movementX!==0&&(o=d.movementX||0),r===0&&d.movementY!==0&&(r=d.movementY||0)}n.x+=o,n.y+=r,this._pointerPositions[e].x=t.clientX,this._pointerPositions[e].y=t.clientY;const l=t.clientX,c=t.clientY;for(;e>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new le);const h=this._pointerPositionsRC[e];h.set(l,c),this.convertScreenspaceToRaycastSpace(h)}getPointerIndex(t){let e=-1;for(let i=0;i<this._pointerIds.length;i++){if(this._pointerIds[i]===t)return i;e===-1&&this._pointerIds[i]===-1&&(e=i)}return e!==-1?(this._pointerIds[e]=t,e):(wt&&console.log("PUSH pointerId:",t),this._pointerIds.push(t),this._pointerIds.length-1)}setPointerState(t,e,i){e[t]=i}setPointerStateT(t,e,i){return e[t]=i,i}onDispatchEvent(t){const e=ne.Current;try{ne.Current=this.context,this.dispatchEvent(t)}finally{ne.Current=e}}}const cc=new ce().makeRotationY(Math.PI),Dn=new H().setFromAxisAngle(new x(0,1,0),Math.PI),ok=S("debugwebxr");class rk{constructor(){a(this,"priority",-1e5);a(this,"gameObject");if(this.gameObject=new D,this.gameObject.name="Implicit XR Rig",ok){const t=vb(16733661);t.position.y+=.5,this.gameObject.add(t)}}isXRRig(){return!0}get isActive(){return this.gameObject.visible}}const bo=S("debugwebxr"),Eu=S("debugcustomgesture"),ak="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",lk="generic-trigger",ck=new H().setFromEuler(new Ct(Fo.degToRad(0),Fo.degToRad(-90),Fo.degToRad(-90))),hk=new x(.04,-.04,0);class TS{constructor(t,e,i){a(this,"xr");a(this,"inputSource");a(this,"index",0);a(this,"emitEvents",!0);a(this,"_connected",!0);a(this,"_isTracking",!1);a(this,"__gamepad");a(this,"__hand");a(this,"__side");a(this,"_hitTestSource");a(this,"_hasSelectEvent",!1);a(this,"_isMxInk",!1);a(this,"_isMetaQuestTouchController",!1);a(this,"_handJointPoses",new Map);a(this,"_gripMatrix",new ce);a(this,"_gripPosition",new x);a(this,"_gripQuaternion",new H);a(this,"_linearVelocity",new x);a(this,"_rayPositionRaw",new x);a(this,"_rayRotationRaw",new H);a(this,"_rayMatrix",new ce);a(this,"_rayPosition",new x);a(this,"_rayQuaternion",new H);a(this,"_gripWorldPosition",new x);a(this,"_gripWorldQuaternion",new H);a(this,"_rayWorldPosition",new x);a(this,"_rayWorldQuaternion",new H);a(this,"_pinchPosition",new x);a(this,"_ray");a(this,"_hand_wristDotUp");a(this,"_object");a(this,"_gripSpaceObject");a(this,"_raySpaceObject");a(this,"model",null);a(this,"_debugAxesHelper",new yn(.15));a(this,"_debugGripAxesHelper",new yn(.07));a(this,"_debugRayAxesHelper",new yn(.07));a(this,"_hitTestSourcePromise",null);a(this,"onPointerHits",t=>{});a(this,"_needleGamepadButtons",{});a(this,"_buttonMap",new Map);a(this,"_motioncontroller");a(this,"_layout");a(this,"getMotionController");a(this,"emitPointerDownEvent",!0);a(this,"emitPointerUpEvent",!0);a(this,"emitPointerMoveEvent",!0);a(this,"pointerMoveDistanceThreshold",.03);a(this,"pointerMoveAngleThreshold",.05);a(this,"_selectButtonIndex");a(this,"_squeezeButtonIndex");a(this,"onSelectStart",t=>{var n,o,r,l;if(!this.emitPointerDownEvent||this.inputSource!==t.inputSource)return;this.onUpdateFrame(t.frame),this._hasSelectEvent=!0;const e=(n=this._layout)==null?void 0:n.selectComponentId,i=(l=(r=(o=this._layout)==null?void 0:o.components[e])==null?void 0:r.gamepadIndices)==null?void 0:l.button;i!==void 0&&(this._selectButtonIndex=i),!Eu&&(bo&&G.DrawDirection(this.rayWorldPosition,q(0,.01,1).applyQuaternion(this.rayWorldQuaternion),16711680,10),this.emitPointerEvent(_e.PointerDown,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});a(this,"onSelectEnd",t=>{this.emitPointerUpEvent&&(Eu||this.inputSource===t.inputSource&&this.emitPointerEvent(_e.PointerUp,this._selectButtonIndex||0,"xr-standard-trigger",!0,t))});a(this,"onSequeezeStart",t=>{var e,i,n;this.emitPointerDownEvent&&this.inputSource===t.inputSource&&(this._squeezeButtonIndex=(n=(i=(e=this._layout)==null?void 0:e.components["xr-standard-squeeze"])==null?void 0:i.gamepadIndices)==null?void 0:n.button,this._squeezeButtonIndex!==void 0&&(bo&&G.DrawDirection(this.rayWorldPosition,q(0,.01,1).applyQuaternion(this.rayWorldQuaternion),255,10),this.emitPointerEvent(_e.PointerDown,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)))});a(this,"onSequeezeEnd",t=>{this.emitPointerUpEvent&&this.inputSource===t.inputSource&&this._squeezeButtonIndex!==void 0&&this.emitPointerEvent(_e.PointerUp,this._squeezeButtonIndex||0,"xr-standard-squeeze",!0,t)});a(this,"states",{});a(this,"_didMoveLastFrame",!1);a(this,"_lastPointerMovePosition",new x);a(this,"_lastPointerMoveQuaternion",new H);a(this,"pointerInit");this.xr=t,this.inputSource=e,this.index=i,this._object=new D,this._object.name=`NeedleXRController_${i}`,bo&&(this._object.add(this._debugAxesHelper),this._gripSpaceObject=new D,this._raySpaceObject=new D,this._gripSpaceObject.name=`NeedleXRController_${i}_gripSpace`,this._raySpaceObject.name=`NeedleXRController_${i}_raySpace`,this._gripSpaceObject.add(this._debugGripAxesHelper),this._raySpaceObject.add(this._debugRayAxesHelper),this.xr.context.scene.add(this._gripSpaceObject),this.xr.context.scene.add(this._raySpaceObject)),this.xr.context.scene.add(this._object),this._ray=new Hr,this.pointerInit={origin:this,pointerType:this.hand?"hand":"controller",deviceIndex:this.index,pointerId:-1,mode:this.inputSource.targetRayMode,ray:this._ray,device:this._object,buttonName:"none"},this.initialize(),this.subscribeEvents()}get context(){return this.xr.context}get connected(){return this._connected}get isTracking(){return this._isTracking}get gamepad(){return this.__gamepad??(this.__gamepad=this.inputSource.gamepad)}get isHand(){return this.hand!=null}get hand(){return this.__hand??(this.__hand=this.inputSource.hand)}get handObject(){return this.context.renderer.xr.getHand(this.index)}get profiles(){return this.inputSource.profiles}get layout(){return this._layout}get targetRayMode(){return this.inputSource.targetRayMode}get targetRaySpace(){return this.inputSource.targetRaySpace}get gripSpace(){return this.inputSource.gripSpace}get side(){return this.__side??(this.__side=this.inputSource.handedness)}get isRight(){return this.side==="right"}get isLeft(){return this.side==="left"}get isStylus(){return this._isMxInk}getHitTestSource(){return this._hitTestSource||this._requestHitTestSource(),this._hitTestSource}get hasHitTestSource(){return this._hitTestSource}cancelHitTestSource(){this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}get hasSelectEvent(){return this._hasSelectEvent}getHitTest(){return this.xr.getHitTest(this)}getHandJointPose(t,e){var n;if(e=e||this.xr.frame,!this.hand||!(e!=null&&e.getJointPose)||!this.xr.referenceSpace)return null;let i=(n=this._handJointPoses)==null?void 0:n.get(t);return i||(i=e.getJointPose(t,this.xr.referenceSpace),i&&this._handJointPoses.set(t,i),i)}get gripPosition(){return q(this._gripPosition)}get gripQuaternion(){return dn(this._gripQuaternion)}get gripMatrix(){return this._gripMatrix}get gripLinearVelocity(){return q(this._linearVelocity).applyQuaternion(Dn)}get rayPosition(){return q(this._rayPosition)}get rayQuaternion(){return dn(this._rayQuaternion)}get gripWorldPosition(){return q(this._gripWorldPosition)}get gripWorldQuaternion(){return dn(this._gripWorldQuaternion)}get rayWorldPosition(){return q(this._rayWorldPosition)}updateRayWorldPosition(){var e;const t=(e=this.xr.context.mainCamera)==null?void 0:e.parent;this._rayWorldPosition.copy(this._rayPositionRaw),t&&this._rayWorldPosition.applyMatrix4(t.matrixWorld)}get rayWorldQuaternion(){return dn(this._rayWorldQuaternion)}get pinchPosition(){return q(this._pinchPosition)}updateRayWorldQuaternion(){var i;const t=(i=this.xr.context.mainCamera)==null?void 0:i.parent,e=t?Le(t):void 0;this._rayWorldQuaternion.copy(this._rayRotationRaw).multiply(Dn),e&&this._rayWorldQuaternion.premultiply(e)}get ray(){return this._ray.origin.copy(this.rayWorldPosition),this._ray.direction.copy(q(0,0,1).applyQuaternion(this.rayWorldQuaternion)),this._ray}get handWristDotUp(){var e;if(this._hand_wristDotUp!==void 0)return this._hand_wristDotUp;const t=(e=this.handObject)==null?void 0:e.joints.wrist;if(t){const i=q(0,1,0).applyQuaternion(t.quaternion),n=q(0,1,0).dot(i);return this._hand_wristDotUp=n}}get isHandUpsideDown(){return this.handWristDotUp!==void 0?this.handWristDotUp<-.7:!1}get isTeleportGesture(){var t;return this.isHandUpsideDown&&((t=this.getGesture("pinch"))==null?void 0:t.isDown)}get object(){return this._object}async getModelUrl(){var t;return(t=this.getMotionController)==null?void 0:t.then(e=>(e==null?void 0:e.assetUrl)||null)}_requestHitTestSource(){var t;return this._hitTestSourcePromise?this._hitTestSourcePromise:this.xr.mode==="immersive-ar"&&this.inputSource.targetRayMode==="tracked-pointer"&&this.xr.session.requestHitTestSourceForTransientInput?this._hitTestSourcePromise=((t=this.xr.session.requestHitTestSourceForTransientInput({profile:this.inputSource.profiles[0],offsetRay:new XRRay}))==null?void 0:t.then(e=>(this._hitTestSourcePromise=null,this.connected?this._hitTestSource=e:(e.cancel(),null))))??null:null}onUpdate(t){this.onUpdateFrame(t),this.updateInputEvents(),this.onUpdateMove()}onRenderDebug(){var o;G.DrawSphere(this.rayWorldPosition,.003),G.DrawDirection(this.rayWorldPosition,q(0,0,10).applyQuaternion(this.rayWorldQuaternion));const e=(this.inputSource.gripSpace?this.gripWorldPosition:this.object.worldPosition).sub(this.object.worldForward.multiplyScalar(.1)),i=this.inputSource.profiles.join(`
`);let n=`Controller[${this.index}] (${this.inputSource.targetRayMode}, ${this.side})
C:${this.connected?"x":"-"} T:${this.isTracking?"x":"-"} Hand:${this.inputSource.hand?"x":"-"} Pen: ${this._isMxInk?"x":"-"}`;if(this.inputSource.hand&&(n+=`
Pinch: ${(o=this.getGesture("pinch"))==null?void 0:o.value.toFixed(3)}`),n+=`
`+i,n+=`
`+(this.inputSource.targetRaySpace?"Ray: x":"Ray: -")+(this.inputSource.gripSpace?" Grip: x":" Grip: -")+(this.inputSource.gamepad?` Gamepad: ${this.inputSource.gamepad.mapping}`:" Gamepad: -"),this.inputSource.gamepad){const r=this.inputSource.gamepad;let l="[btns "+r.buttons.length+"]: "+r.buttons.map(c=>c.value.toPrecision(1)).join(",");l+=`
[axes `+r.axes.length+"]: "+r.axes.map(c=>c.toPrecision(1)).join(","),n+=`
`+l}G.DrawLabel(e,n,.006)}onUpdateFrame(t){var d,u,f,p,g,_,y,b,v,w,P,E;if(this._handJointPoses.clear(),this._hand_wristDotUp=void 0,!this.xr.referenceSpace||!((d=this.inputSource.gamepad)!=null&&d.connected)){this._isTracking=!1;return}const e=t.getPose(this.inputSource.targetRaySpace,this.xr.referenceSpace);this._isTracking=e!=null;let i=null,n=null,o=null,r=null;if(e){const T=e.transform;this._rayMatrix.fromArray(T.matrix).premultiply(cc),this._rayMatrix.decompose(this._rayPosition,this._rayQuaternion,q(1,1,1)),o=q(T.position),r=dn(T.orientation),this._rayPositionRaw.copy(o),this._rayRotationRaw.copy(r)}if(this.inputSource.gripSpace){const T=t.getPose(this.inputSource.gripSpace,this.xr.referenceSpace);if(T){const k=T.transform;if(i=q(k.position),n=dn(k.orientation),this._gripMatrix.fromArray(k.matrix).premultiply(cc),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,q(1,1,1)),"linearVelocity"in T&&T.linearVelocity){const z=T.linearVelocity;this._linearVelocity.set(z.x,z.y,z.z)}}}(u=this.xr.context.mainCamera)!=null&&u.parent&&(this._object.parent!==((f=this.xr.context.mainCamera)==null?void 0:f.parent)&&this.xr.context.mainCamera.parent.add(this._object),this._gripSpaceObject!==void 0&&((p=this._gripSpaceObject)==null?void 0:p.parent)!==((g=this.xr.context.mainCamera)==null?void 0:g.parent)&&this.xr.context.mainCamera.parent.add(this._gripSpaceObject),this._raySpaceObject!==void 0&&((_=this._raySpaceObject)==null?void 0:_.parent)!==((y=this.xr.context.mainCamera)==null?void 0:y.parent)&&this.xr.context.mainCamera.parent.add(this._raySpaceObject));const l=this.hand;if(l){let T=!1;const k=l.get("wrist"),z=k&&this.getHandJointPose(k,t);if(z){T=!0;const A=z.transform.position,$=z.transform.orientation;this._object.position.set(A.x,A.y,A.z),this._object.quaternion.set($.x,$.y,$.z,$.w).multiply(Dn)}T||(this._object.position.copy(this._rayPosition),this._object.quaternion.copy(this._rayQuaternion).multiply(Dn));const L=l.get("middle-finger-metacarpal"),O=L&&this.getHandJointPose(L,t);O&&(this._gripMatrix.fromArray(O.transform.matrix).premultiply(cc),this._gripMatrix.decompose(this._gripPosition,this._gripQuaternion,q(1,1,1)),i=q().copy(O.transform.position),n=dn().copy(O.transform.orientation),n.multiply(ck),i.add(q(hk).applyQuaternion(n)))}else this.inputSource.gripSpace&&this.targetRayMode==="transient-pointer"&&i&&n?(this._object.position.copy(i),this._object.quaternion.copy(n).multiply(Dn)):o&&r&&(this._object.position.copy(o),this._object.quaternion.copy(r).multiply(Dn));bo&&(o&&r&&((b=this._raySpaceObject)==null||b.position.copy(o),(v=this._raySpaceObject)==null||v.quaternion.copy(r).multiply(Dn)),i&&n&&((w=this._gripSpaceObject)==null||w.position.copy(i),(P=this._gripSpaceObject)==null||P.quaternion.copy(n).multiply(Dn)));const c=(E=this.xr.context.mainCamera)==null?void 0:E.parent,h=c?Le(c):void 0;i&&n&&(this._gripWorldPosition.copy(i),c&&this._gripWorldPosition.applyMatrix4(c.matrixWorld),this._gripWorldQuaternion.copy(n),this._gripWorldQuaternion.multiply(Dn),h&&this._gripWorldQuaternion.premultiply(h)),this.updateRayWorldPosition(),this.updateRayWorldQuaternion()}onDisconnected(){var t,e,i,n,o,r;this._connected=!1,bo&&console.warn("Controller disconnected",this.index);for(const l of this._object.children)this.xr.context.scene.attach(l);(t=this._object)==null||t.removeFromParent(),(e=this._debugAxesHelper)==null||e.removeFromParent(),(i=this._debugGripAxesHelper)==null||i.removeFromParent(),(n=this._debugRayAxesHelper)==null||n.removeFromParent(),(o=this._gripSpaceObject)==null||o.removeFromParent(),(r=this._raySpaceObject)==null||r.removeFromParent(),this.unsubscribeEvents(),this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0)}getButton(t){var i;if(!this._layout)return;switch(t){case"primary-button":if(this.isLeft)t="x-button";else if(this.isRight)t="a-button";else return;break;case"primary":return this.hand?this.getGesture("pinch"):this.toNeedleGamepadButton(0,t);case"xr-standard-trigger":if(this.inputSource.gamepad)return this.toNeedleGamepadButton(0,t);break;case"xr-standard-squeeze":if(this.inputSource.gamepad)return this.toNeedleGamepadButton(1,t);break;case"xr-standard-thumbstick":if(this.inputSource.gamepad)return this.toNeedleGamepadButton(3,t);break}if(this._buttonMap.has(t))return this.toNeedleGamepadButton(this._buttonMap.get(t),t);const e=(i=this._layout)==null?void 0:i.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"button":case"squeeze":if(this.inputSource.gamepad){const n=e.gamepadIndices.button;return this._buttonMap.set(t,n),this.toNeedleGamepadButton(n,t)}break;default:console.warn("Unsupported component type",e.type);break}this._buttonMap.set(t,void 0)}getGesture(t){const e=this.states[t];if(!e)return null;this.states[t]=e;const i=this._needleGamepadButtons[t]||new lv(void 0,t);return i.pressed=e.pressed,i.value=e.value,i.isDown=e.isDown,i.isUp=e.isUp,this._needleGamepadButtons[t]=i,i}getPointerId(t){if((t==="primary"||t==="pinch")&&(t=0),typeof t!="number"){const e=this._buttonMap.get(t);if(e===void 0)return;t=e}return this.index*10+t}toNeedleGamepadButton(t,e){var r,l;if(!((r=this.inputSource.gamepad)!=null&&r.buttons))return;const i=(l=this.inputSource.gamepad)==null?void 0:l.buttons[t],n=this.states[t],o=this._needleGamepadButtons[t]||new lv(t,e);return i&&(o.pressed=i.pressed,o.value=i.value,o.touched=i.touched),n&&(o.isDown=n.isDown,o.isUp=n.isUp),this._needleGamepadButtons[t]=o,o}getStick(t){var i,n,o;if(!this._layout)return{x:0,y:0,z:0};if(this.isHand)return{x:0,y:0,z:0};t==="primary"&&this._layout.components["xr-standard-thumbstick"]&&(t="xr-standard-thumbstick");const e=(i=this._layout)==null?void 0:i.components[t];if(e!=null&&e.gamepadIndices)switch(e.type){case"thumbstick":if(this.inputSource.gamepad){const r=e.gamepadIndices.xAxis,l=e.gamepadIndices.yAxis;let c=this.inputSource.gamepad.axes[r]||0,h=this.inputSource.gamepad.axes[l]||0;c*=-1,h*=-1;const d=e.gamepadIndices.button,u=((o=(n=this.inputSource.gamepad)==null?void 0:n.buttons[d])==null?void 0:o.value)||0;return{x:c,y:h,z:u}}}return{x:0,y:0,z:0}}initialize(){if(this._hasSelectEvent=this.profiles.includes("generic-hand-select")||this.profiles.some(t=>t.startsWith("generic-trigger")),this._isMetaQuestTouchController=this.profiles.includes("meta-quest-touch-plus")||this.profiles.includes("oculus-touch-v3"),this._isMxInk=this.profiles.includes("logitech-mx-ink"),!this._layout){if(this.inputSource.targetRayMode==="transient-pointer")return;const t=JO(this.inputSource,ak,lk);this.getMotionController=t.then(e=>{var o;if(!this.connected)return null;this._motioncontroller=new nk(this.inputSource,e.profile,e.assetPath||"");const n=e.profile.layouts[this.inputSource.handedness];if(this._layout=n,this._layout&&!((o=this._layout.gamepad)!=null&&o.length)){this._layout.gamepad=[];for(const r in this._layout.components){const l=this._layout.components[r];this._layout.gamepad[l.gamepadIndices.button]=r}}return this._motioncontroller}).catch(e=>(this.inputSource&&console.warn("Couldn't initialize motion controller profile for ",this.inputSource,e),null))}}subscribeEvents(){this.xr.session.addEventListener("selectstart",this.onSelectStart),this.xr.session.addEventListener("selectend",this.onSelectEnd),this.xr.session.addEventListener("squeezestart",this.onSequeezeStart),this.xr.session.addEventListener("squeezeend",this.onSequeezeEnd)}unsubscribeEvents(){this.xr.session.removeEventListener("selectstart",this.onSelectStart),this.xr.session.removeEventListener("selectend",this.onSelectEnd),this.xr.session.removeEventListener("squeezestart",this.onSequeezeStart),this.xr.session.removeEventListener("squeezeend",this.onSequeezeEnd)}updateInputEvents(){var t,e,i;if((t=this.gamepad)!=null&&t.buttons){for(let n=0;n<this.gamepad.buttons.length;n++){const o=this.gamepad.buttons[n],r=this.states[n]||new av;let l=null;this._isMxInk&&(n===4||n===5)?(o.value>0&&!r.pressed?(l="pointerdown",r.isDown=!0,r.isUp=!1):o.value===0&&r.pressed?(l="pointerup",r.isDown=!1,r.isUp=!0):r.pressed&&(l="pointermove",r.isDown=!1,r.isUp=!1),r.pressed=o.value>0,r.value=o.value):(o.pressed&&!r.pressed?(l="pointerdown",r.isDown=!0,r.isUp=!1):!o.pressed&&r.pressed?(l="pointerup",r.isDown=!1,r.isUp=!0):(r.isDown=!1,r.isUp=!1),r.pressed=o.pressed,r.value=o.value),this.states[n]=r;const c=n!==this._selectButtonIndex&&n!==this._squeezeButtonIndex;if(l!=null&&c){let h=(e=this._layout)==null?void 0:e.gamepad[n];this._isMxInk&&n===4&&(h="stylus-touch"),this._isMxInk&&n===5&&(h="stylus-tip"),(bo||Eu)&&console.log("Emitting pointer event",l,n,h,o.value,this.gamepad,this._layout),this.emitPointerEvent(l,n,h??"none",!1,null,o.value)}}if(this._isMetaQuestTouchController){const n=this.gamepad.buttons.length-1,o=this.states[n];if(o&&o.isDown){const r=this.context.menu;r.spatialMenuIsVisible?r.setSpatialMenuVisible(!1):this.context.menu.setSpatialMenuVisible(!0)}}}if(this.hand){const n=this.handObject;if(n){const o=n.joints["index-finger-tip"],r=n.joints["thumb-tip"];if(o&&r){const l=o.position.distanceTo(r.position);this._pinchPosition.lerpVectors(o.position,r.position,.5);const c=(i=this.xr.context.mainCamera)==null?void 0:i.parent;if(c&&this._pinchPosition.applyMatrix4(c.matrixWorld),l!==0){const u=this.states.pinch||new av,f=(.02+.01)*1.5;u.value=1-(l-.02)/f;const p=l<.02-.01,g=l>.02+.01;p&&!u.pressed?(Eu&&console.log("pinch start",l),u.isDown=!0,u.isUp=!1,u.pressed=!0):g&&u.pressed?(u.isDown=!1,u.isUp=!0,u.pressed=!1):(u.isDown=!1,u.isUp=!1),this.states.pinch=u}}}}}onUpdateMove(){var i,n;if(!this.emitPointerMoveEvent)return;let t=!1;if(this._lastPointerMovePosition.distanceTo(this.gripWorldPosition)>this.pointerMoveDistanceThreshold*this.xr.rigScale&&(t=!0),t||this._lastPointerMoveQuaternion.angleTo(this.gripWorldQuaternion)>this.pointerMoveAngleThreshold&&(t=!0),t){this._didMoveLastFrame=!0,this._lastPointerMovePosition.copy(this.gripWorldPosition),this._lastPointerMoveQuaternion.copy(this.gripWorldQuaternion),bo&&G.DrawLabel(this.rayWorldPosition.add(this.object.worldForward.multiplyScalar(.1)),"move",.01);let o=this.xr.context.input.getFirstPressedButtonForPointer(this.index);o===void 0&&(o=0);const r=(n=(i=this.gamepad)==null?void 0:i.buttons[o])==null?void 0:n.value;this.emitPointerEvent("pointermove",o,"none",!1,null,r)}else this._didMoveLastFrame=!1}emitPointerEvent(t,e,i,n,o=null,r){if(!this.emitEvents){bo&&t!==_e.PointerMove&&console.warn("Pointer events are disabled for this controller",this.index,t,e);return}if(this.xr.mode==="immersive-vr"||this.xr.isPassThrough){this.pointerInit.origin=this,this.pointerInit.pointerId=this.getPointerId(e),this.pointerInit.pointerType=this.hand?"hand":"controller",this.pointerInit.button=e,this.pointerInit.buttonName=i,this.pointerInit.isPrimary=n,this.pointerInit.mode=this.inputSource.targetRayMode,this.pointerInit.ray=this.ray,this.pointerInit.device=this.object,this.pointerInit.pressure=r,this.pointerInit.clientX=this._rayPosition.x/this.xr.rigScale,this.pointerInit.clientY=this._rayPosition.y/this.xr.rigScale,this.pointerInit.clientZ=this._rayPosition.z/this.xr.rigScale;const l=ne.Current;ne.Current=this.xr.context,bo&&t!=="pointermove"&&console.warn("Pointer event",t,e,i,{...this.pointerInit}),this.xr.context.input.createInputEvent(new gr(t,o,this.pointerInit)),ne.Current=l}}}class av{constructor(){a(this,"isDown",!1);a(this,"isUp",!1);a(this,"pressed",!1);a(this,"value",0)}}class lv{constructor(t,e){a(this,"index");a(this,"name");a(this,"touched",!1);a(this,"pressed",!1);a(this,"value",0);a(this,"isDown",!1);a(this,"isUp",!1);this.index=t,this.name=e}}var Va;(function(s){s.Visible="application-visible",s.Hidden="application-hidden",s.MuteChanged="application-mutechanged"})(Va||(Va={}));let Hf=!1;const Ul=[];function al(){if(Hf)return;U()&&console.debug("User interaction registered: audio can now be played"),Hf=!0;const s=[...Ul];Ul.length=0,s.forEach(t=>t())}document.addEventListener("mousedown",al);document.addEventListener("pointerup",al);document.addEventListener("click",al);document.addEventListener("dragstart",al);document.addEventListener("touchend",al);document.addEventListener("keydown",al);const x0=class extends EventTarget{constructor(e){super();a(this,"_mute",!1);a(this,"context");a(this,"_isVisible",!0);this.context=e,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}static get userInteractionRegistered(){return Hf}static registerWaitForInteraction(e){if(e!==null){if(Hf){e();return}Ul.indexOf(e)===-1&&Ul.push(e)}}static unregisterWaitForInteraction(e){const i=Ul.indexOf(e);i!==-1&&Ul.splice(i,1)}get muted(){return this._mute}set muted(e){e!==this._mute&&(this._mute=e,this.dispatchEvent(new Event(Va.MuteChanged)))}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(e){switch(e.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event(Va.Hidden));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event(Va.Visible));break}}};let ls=x0;a(ls,"registerWaitForAllowAudio",x0.registerWaitForInteraction);const hc=new Map,Nl=new Map;let cv=0;function tr(s,t,e){if(hc.has(t)||hc.set(t,new Array),hc.get(t).push({method:s,options:{once:!1,...e}}),cv<30){const i=Nl.get(t);i&&(i==null?void 0:i.length)>100&&(cv+=1,console.warn(`You have ${i.length} methods registered for Event ${t}.

This might be a performance issue!
Consider unregistering the methods when they are not needed anymore!

To unregister you can call the function returned by your event hook (e.g.const unregister = onStart(...)) 

or by using the once option like onStart(()=>{}, { once:true }).

See https://engine.needle.tools/docs/scripting.html#special-lifecycle-hooks for more information.`))}}function Yr(s,t){const e=Nl.get(t);if(e){for(let n=0;n<e.length;n++)if(e[n].method===s){e.splice(n,1);return}}const i=hc.get(t);if(i){for(let n=0;n<i.length;n++)if(i[n].method===s){i.splice(n,1);return}}}function ws(s,t){t===ge.ContextCreated&&Fy.delete(s),OS(s,t)}function OS(s,t){t===oe.Start&&hc.get(ge.ContextCreated)&&OS(s,ge.ContextCreated);const e=t===oe.Start||t===ge.ContextCreated,i=Nl.get(t);i&&i.length>0&&dv(s,i,e);const n=hc.get(t);if(n&&n.length>0){const o=[...n];n.length=0,dv(s,o,e),o.length>0&&(Nl.has(t)||Nl.set(t,new Array),Nl.get(t).push(...o))}}const Mu=new Array,hv={context:null};function dv(s,t,e){var n,o;Mu.length=0;for(let r=0;r<t.length;r++)Mu.push(t[r]);let i=Fy.get(s);for(let r=0;r<Mu.length;r++){const l=Mu[r];let c=!0;if(i&&i.has(l)&&(c=!1),c)try{hv.context=s,(n=l.method)==null||n.call(hv,s)}catch(h){console.error("Error in lifecycle method",h)}if((o=l.options)!=null&&o.once){for(let h=0;h<t.length;h++)if(t[h]===l){t.splice(h,1);break}}else e&&(i||(i=new Set,Fy.set(s,i)),i.add(l))}}const Fy=new WeakMap,wg=2,Ns=4,Mo=4,fb=4,vr=new Int32Array(2),uv=new Float32Array(vr.buffer),fv=new Float64Array(vr.buffer),Au=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;class Uo{constructor(t,e){this.low=t|0,this.high=e|0}static create(t,e){return t==0&&e==0?Uo.ZERO:new Uo(t,e)}toFloat64(){return(this.low>>>0)+this.high*4294967296}equals(t){return this.low==t.low&&this.high==t.high}}Uo.ZERO=new Uo(0,0);var zy;(function(s){s[s.UTF8_BYTES=1]="UTF8_BYTES",s[s.UTF16_STRING=2]="UTF16_STRING"})(zy||(zy={}));class Ud{constructor(t){this.bytes_=t,this.position_=0}static allocate(t){return new Ud(new Uint8Array(t))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(t){this.position_=t}capacity(){return this.bytes_.length}readInt8(t){return this.readUint8(t)<<24>>24}readUint8(t){return this.bytes_[t]}readInt16(t){return this.readUint16(t)<<16>>16}readUint16(t){return this.bytes_[t]|this.bytes_[t+1]<<8}readInt32(t){return this.bytes_[t]|this.bytes_[t+1]<<8|this.bytes_[t+2]<<16|this.bytes_[t+3]<<24}readUint32(t){return this.readInt32(t)>>>0}readInt64(t){return new Uo(this.readInt32(t),this.readInt32(t+4))}readUint64(t){return new Uo(this.readUint32(t),this.readUint32(t+4))}readFloat32(t){return vr[0]=this.readInt32(t),uv[0]}readFloat64(t){return vr[Au?0:1]=this.readInt32(t),vr[Au?1:0]=this.readInt32(t+4),fv[0]}writeInt8(t,e){this.bytes_[t]=e}writeUint8(t,e){this.bytes_[t]=e}writeInt16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeUint16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeInt32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeUint32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeInt64(t,e){this.writeInt32(t,e.low),this.writeInt32(t+4,e.high)}writeUint64(t,e){this.writeUint32(t,e.low),this.writeUint32(t+4,e.high)}writeFloat32(t,e){uv[0]=e,this.writeInt32(t,vr[0])}writeFloat64(t,e){fv[0]=e,this.writeInt32(t,vr[Au?0:1]),this.writeInt32(t+4,vr[Au?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+Ns+Mo)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let t="";for(let e=0;e<Mo;e++)t+=String.fromCharCode(this.readInt8(this.position_+Ns+e));return t}__offset(t,e){const i=t-this.readInt32(t);return e<this.readInt16(i)?this.readInt16(i+e):0}__union(t,e){return t.bb_pos=e+this.readInt32(e),t.bb=this,t}__string(t,e){t+=this.readInt32(t);const i=this.readInt32(t);let n="",o=0;if(t+=Ns,e===zy.UTF8_BYTES)return this.bytes_.subarray(t,t+i);for(;o<i;){let r;const l=this.readUint8(t+o++);if(l<192)r=l;else{const c=this.readUint8(t+o++);if(l<224)r=(l&31)<<6|c&63;else{const h=this.readUint8(t+o++);if(l<240)r=(l&15)<<12|(c&63)<<6|h&63;else{const d=this.readUint8(t+o++);r=(l&7)<<18|(c&63)<<12|(h&63)<<6|d&63}}}r<65536?n+=String.fromCharCode(r):(r-=65536,n+=String.fromCharCode((r>>10)+55296,(r&1024-1)+56320))}return n}__union_with_string(t,e){return typeof t=="string"?this.__string(e):this.__union(t,e)}__indirect(t){return t+this.readInt32(t)}__vector(t){return t+this.readInt32(t)+Ns}__vector_len(t){return this.readInt32(t+this.readInt32(t))}__has_identifier(t){if(t.length!=Mo)throw new Error("FlatBuffers: file identifier must be length "+Mo);for(let e=0;e<Mo;e++)if(t.charCodeAt(e)!=this.readInt8(this.position()+Ns+e))return!1;return!0}createLong(t,e){return Uo.create(t,e)}createScalarList(t,e){const i=[];for(let n=0;n<e;++n)t(n)!==null&&i.push(t(n));return i}createObjList(t,e){const i=[];for(let n=0;n<e;++n){const o=t(n);o!==null&&i.push(o.unpack())}return i}}class eu{constructor(t){this.minalign=1,this.vtable=null,this.vtable_in_use=0,this.isNested=!1,this.object_start=0,this.vtables=[],this.vector_num_elems=0,this.force_defaults=!1,this.string_maps=null;let e;t?e=t:e=1024,this.bb=Ud.allocate(e),this.space=e}clear(){this.bb.clear(),this.space=this.bb.capacity(),this.minalign=1,this.vtable=null,this.vtable_in_use=0,this.isNested=!1,this.object_start=0,this.vtables=[],this.vector_num_elems=0,this.force_defaults=!1,this.string_maps=null}forceDefaults(t){this.force_defaults=t}dataBuffer(){return this.bb}asUint8Array(){return this.bb.bytes().subarray(this.bb.position(),this.bb.position()+this.offset())}prep(t,e){t>this.minalign&&(this.minalign=t);const i=~(this.bb.capacity()-this.space+e)+1&t-1;for(;this.space<i+t+e;){const n=this.bb.capacity();this.bb=eu.growByteBuffer(this.bb),this.space+=this.bb.capacity()-n}this.pad(i)}pad(t){for(let e=0;e<t;e++)this.bb.writeInt8(--this.space,0)}writeInt8(t){this.bb.writeInt8(this.space-=1,t)}writeInt16(t){this.bb.writeInt16(this.space-=2,t)}writeInt32(t){this.bb.writeInt32(this.space-=4,t)}writeInt64(t){this.bb.writeInt64(this.space-=8,t)}writeFloat32(t){this.bb.writeFloat32(this.space-=4,t)}writeFloat64(t){this.bb.writeFloat64(this.space-=8,t)}addInt8(t){this.prep(1,0),this.writeInt8(t)}addInt16(t){this.prep(2,0),this.writeInt16(t)}addInt32(t){this.prep(4,0),this.writeInt32(t)}addInt64(t){this.prep(8,0),this.writeInt64(t)}addFloat32(t){this.prep(4,0),this.writeFloat32(t)}addFloat64(t){this.prep(8,0),this.writeFloat64(t)}addFieldInt8(t,e,i){(this.force_defaults||e!=i)&&(this.addInt8(e),this.slot(t))}addFieldInt16(t,e,i){(this.force_defaults||e!=i)&&(this.addInt16(e),this.slot(t))}addFieldInt32(t,e,i){(this.force_defaults||e!=i)&&(this.addInt32(e),this.slot(t))}addFieldInt64(t,e,i){(this.force_defaults||!e.equals(i))&&(this.addInt64(e),this.slot(t))}addFieldFloat32(t,e,i){(this.force_defaults||e!=i)&&(this.addFloat32(e),this.slot(t))}addFieldFloat64(t,e,i){(this.force_defaults||e!=i)&&(this.addFloat64(e),this.slot(t))}addFieldOffset(t,e,i){(this.force_defaults||e!=i)&&(this.addOffset(e),this.slot(t))}addFieldStruct(t,e,i){e!=i&&(this.nested(e),this.slot(t))}nested(t){if(t!=this.offset())throw new Error("FlatBuffers: struct must be serialized inline.")}notNested(){if(this.isNested)throw new Error("FlatBuffers: object serialization must not be nested.")}slot(t){this.vtable!==null&&(this.vtable[t]=this.offset())}offset(){return this.bb.capacity()-this.space}static growByteBuffer(t){const e=t.capacity();if(e&3221225472)throw new Error("FlatBuffers: cannot grow buffer beyond 2 gigabytes.");const i=e<<1,n=Ud.allocate(i);return n.setPosition(i-e),n.bytes().set(t.bytes(),i-e),n}addOffset(t){this.prep(Ns,0),this.writeInt32(this.offset()-t+Ns)}startObject(t){this.notNested(),this.vtable==null&&(this.vtable=[]),this.vtable_in_use=t;for(let e=0;e<t;e++)this.vtable[e]=0;this.isNested=!0,this.object_start=this.offset()}endObject(){if(this.vtable==null||!this.isNested)throw new Error("FlatBuffers: endObject called without startObject");this.addInt32(0);const t=this.offset();let e=this.vtable_in_use-1;for(;e>=0&&this.vtable[e]==0;e--);const i=e+1;for(;e>=0;e--)this.addInt16(this.vtable[e]!=0?t-this.vtable[e]:0);const n=2;this.addInt16(t-this.object_start);const o=(i+n)*wg;this.addInt16(o);let r=0;const l=this.space;e:for(e=0;e<this.vtables.length;e++){const c=this.bb.capacity()-this.vtables[e];if(o==this.bb.readInt16(c)){for(let h=wg;h<o;h+=wg)if(this.bb.readInt16(l+h)!=this.bb.readInt16(c+h))continue e;r=this.vtables[e];break}}return r?(this.space=this.bb.capacity()-t,this.bb.writeInt32(this.space,r-t)):(this.vtables.push(this.offset()),this.bb.writeInt32(this.bb.capacity()-t,this.offset()-t)),this.isNested=!1,t}finish(t,e,i){const n=i?fb:0;if(e){const o=e;if(this.prep(this.minalign,Ns+Mo+n),o.length!=Mo)throw new Error("FlatBuffers: file identifier must be length "+Mo);for(let r=Mo-1;r>=0;r--)this.writeInt8(o.charCodeAt(r))}this.prep(this.minalign,Ns+n),this.addOffset(t),n&&this.addInt32(this.bb.capacity()-this.space),this.bb.setPosition(this.space)}finishSizePrefixed(t,e){this.finish(t,e,!0)}requiredField(t,e){const i=this.bb.capacity()-t,n=i-this.bb.readInt32(i);if(!(this.bb.readInt16(n+e)!=0))throw new Error("FlatBuffers: field "+e+" must be set")}startVector(t,e,i){this.notNested(),this.vector_num_elems=e,this.prep(Ns,t*e),this.prep(i,t*e)}endVector(){return this.writeInt32(this.vector_num_elems),this.offset()}createSharedString(t){if(!t)return 0;if(this.string_maps||(this.string_maps=new Map),this.string_maps.has(t))return this.string_maps.get(t);const e=this.createString(t);return this.string_maps.set(t,e),e}createString(t){if(!t)return 0;let e;if(t instanceof Uint8Array)e=t;else{e=[];let i=0;for(;i<t.length;){let n;const o=t.charCodeAt(i++);if(o<55296||o>=56320)n=o;else{const r=t.charCodeAt(i++);n=(o<<10)+r+(65536-56623104-56320)}n<128?e.push(n):(n<2048?e.push(n>>6&31|192):(n<65536?e.push(n>>12&15|224):e.push(n>>18&7|240,n>>12&63|128),e.push(n>>6&63|128)),e.push(n&63|128))}}this.addInt8(0),this.startVector(1,e.length,1),this.bb.setPosition(this.space-=e.length);for(let i=0,n=this.space,o=this.bb.bytes();i<e.length;i++)o[n++]=e[i];return this.endVector()}createLong(t,e){return Uo.create(t,e)}createObjectOffset(t){return t===null?0:typeof t=="string"?this.createString(t):t.pack(this)}createObjectOffsetList(t){const e=[];for(let i=0;i<t.length;++i){const n=t[i];if(n!==null)e.push(this.createObjectOffset(n));else throw new Error("FlatBuffers: Argument for createObjectOffsetList cannot contain null.")}return e}createStructOffsetList(t,e){return e(this,t.length),this.createObjectOffsetList(t),this.endVector()}}const kS={};function ES(s,t){kS[s]=t}function dk(s){const t=s.getBufferIdentifier(),e=kS[t];return e(s)}function uk(s){return typeof s.guid=="function"?s.guid():null}function im(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var MS={exports:{}};(function(s){var t={};t.useBlobBuilder=function(){try{return new Blob([]),!1}catch{return!0}}(),t.useArrayBufferView=!t.useBlobBuilder&&function(){try{return new Blob([new Uint8Array([])]).size===0}catch{return!0}}(),s.exports.binaryFeatures=t;var e=s.exports.BlobBuilder;typeof window<"u"&&(e=s.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder);function i(){this._pieces=[],this._parts=[]}i.prototype.append=function(n){typeof n=="number"?this._pieces.push(n):(this.flush(),this._parts.push(n))},i.prototype.flush=function(){if(this._pieces.length>0){var n=new Uint8Array(this._pieces);t.useArrayBufferView||(n=n.buffer),this._parts.push(n),this._pieces=[]}},i.prototype.getBuffer=function(){if(this.flush(),t.useBlobBuilder){for(var n=new e,o=0,r=this._parts.length;o<r;o++)n.append(this._parts[o]);return n.getBlob()}else return new Blob(this._parts)},s.exports.BufferBuilder=i})(MS);var AS=MS.exports,fk=AS.BufferBuilder,pv=AS.binaryFeatures,pk={unpack:function(s){var t=new si(s);return t.unpack()},pack:function(s){var t=new oi;t.pack(s);var e=t.getBuffer();return e}},mk=pk;function si(s){this.index=0,this.dataBuffer=s,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}si.prototype.unpack=function(){var s=this.unpack_uint8();if(s<128)return s;if((s^224)<32)return(s^224)-32;var t;if((t=s^160)<=15)return this.unpack_raw(t);if((t=s^176)<=15)return this.unpack_string(t);if((t=s^144)<=15)return this.unpack_array(t);if((t=s^128)<=15)return this.unpack_map(t);switch(s){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return t=this.unpack_uint16(),this.unpack_string(t);case 217:return t=this.unpack_uint32(),this.unpack_string(t);case 218:return t=this.unpack_uint16(),this.unpack_raw(t);case 219:return t=this.unpack_uint32(),this.unpack_raw(t);case 220:return t=this.unpack_uint16(),this.unpack_array(t);case 221:return t=this.unpack_uint32(),this.unpack_array(t);case 222:return t=this.unpack_uint16(),this.unpack_map(t);case 223:return t=this.unpack_uint32(),this.unpack_map(t)}};si.prototype.unpack_uint8=function(){var s=this.dataView[this.index]&255;return this.index++,s};si.prototype.unpack_uint16=function(){var s=this.read(2),t=(s[0]&255)*256+(s[1]&255);return this.index+=2,t};si.prototype.unpack_uint32=function(){var s=this.read(4),t=((s[0]*256+s[1])*256+s[2])*256+s[3];return this.index+=4,t};si.prototype.unpack_uint64=function(){var s=this.read(8),t=((((((s[0]*256+s[1])*256+s[2])*256+s[3])*256+s[4])*256+s[5])*256+s[6])*256+s[7];return this.index+=8,t};si.prototype.unpack_int8=function(){var s=this.unpack_uint8();return s<128?s:s-256};si.prototype.unpack_int16=function(){var s=this.unpack_uint16();return s<32768?s:s-65536};si.prototype.unpack_int32=function(){var s=this.unpack_uint32();return s<Math.pow(2,31)?s:s-Math.pow(2,32)};si.prototype.unpack_int64=function(){var s=this.unpack_uint64();return s<Math.pow(2,63)?s:s-Math.pow(2,64)};si.prototype.unpack_raw=function(s){if(this.length<this.index+s)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+s+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+s);return this.index+=s,t};si.prototype.unpack_string=function(s){for(var t=this.read(s),e=0,i="",n,o;e<s;)n=t[e],n<128?(i+=String.fromCharCode(n),e++):(n^192)<32?(o=(n^192)<<6|t[e+1]&63,i+=String.fromCharCode(o),e+=2):(o=(n&15)<<12|(t[e+1]&63)<<6|t[e+2]&63,i+=String.fromCharCode(o),e+=3);return this.index+=s,i};si.prototype.unpack_array=function(s){for(var t=new Array(s),e=0;e<s;e++)t[e]=this.unpack();return t};si.prototype.unpack_map=function(s){for(var t={},e=0;e<s;e++){var i=this.unpack(),n=this.unpack();t[i]=n}return t};si.prototype.unpack_float=function(){var s=this.unpack_uint32(),t=s>>31,e=(s>>23&255)-127,i=s&8388607|8388608;return(t===0?1:-1)*i*Math.pow(2,e-23)};si.prototype.unpack_double=function(){var s=this.unpack_uint32(),t=this.unpack_uint32(),e=s>>31,i=(s>>20&2047)-1023,n=s&1048575|1048576,o=n*Math.pow(2,i-20)+t*Math.pow(2,i-52);return(e===0?1:-1)*o};si.prototype.read=function(s){var t=this.index;if(t+s<=this.length)return this.dataView.subarray(t,t+s);throw new Error("BinaryPackFailure: read index out of range")};function oi(){this.bufferBuilder=new fk}oi.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};oi.prototype.pack=function(s){var t=typeof s;if(t==="string")this.pack_string(s);else if(t==="number")Math.floor(s)===s?this.pack_integer(s):this.pack_double(s);else if(t==="boolean")s===!0?this.bufferBuilder.append(195):s===!1&&this.bufferBuilder.append(194);else if(t==="undefined")this.bufferBuilder.append(192);else if(t==="object")if(s===null)this.bufferBuilder.append(192);else{var e=s.constructor;if(e==Array)this.pack_array(s);else if(e==Blob||e==File||s instanceof Blob||s instanceof File)this.pack_bin(s);else if(e==ArrayBuffer)pv.useArrayBufferView?this.pack_bin(new Uint8Array(s)):this.pack_bin(s);else if("BYTES_PER_ELEMENT"in s)pv.useArrayBufferView?this.pack_bin(new Uint8Array(s.buffer)):this.pack_bin(s.buffer);else if(e==Object||e.toString().startsWith("class"))this.pack_object(s);else if(e==Date)this.pack_string(s.toString());else if(typeof s.toBinaryPack=="function")this.bufferBuilder.append(s.toBinaryPack());else throw new Error('Type "'+e.toString()+'" not yet supported')}else throw new Error('Type "'+t+'" not yet supported');this.bufferBuilder.flush()};oi.prototype.pack_bin=function(s){var t=s.length||s.byteLength||s.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(219),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(s)};oi.prototype.pack_string=function(s){var t=yk(s);if(t<=15)this.pack_uint8(176+t);else if(t<=65535)this.bufferBuilder.append(216),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(217),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(s)};oi.prototype.pack_array=function(s){var t=s.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(221),this.pack_uint32(t);else throw new Error("Invalid length");for(var e=0;e<t;e++)this.pack(s[e])};oi.prototype.pack_integer=function(s){if(s>=-32&&s<=127)this.bufferBuilder.append(s&255);else if(s>=0&&s<=255)this.bufferBuilder.append(204),this.pack_uint8(s);else if(s>=-128&&s<=127)this.bufferBuilder.append(208),this.pack_int8(s);else if(s>=0&&s<=65535)this.bufferBuilder.append(205),this.pack_uint16(s);else if(s>=-32768&&s<=32767)this.bufferBuilder.append(209),this.pack_int16(s);else if(s>=0&&s<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(s);else if(s>=-2147483648&&s<=2147483647)this.bufferBuilder.append(210),this.pack_int32(s);else if(s>=-9223372036854776e3&&s<=9223372036854776e3)this.bufferBuilder.append(211),this.pack_int64(s);else if(s>=0&&s<=18446744073709552e3)this.bufferBuilder.append(207),this.pack_uint64(s);else throw new Error("Invalid integer")};oi.prototype.pack_double=function(s){var t=0;s<0&&(t=1,s=-s);var e=Math.floor(Math.log(s)/Math.LN2),i=s/Math.pow(2,e)-1,n=Math.floor(i*Math.pow(2,52)),o=Math.pow(2,32),r=t<<31|e+1023<<20|n/o&1048575,l=n%o;this.bufferBuilder.append(203),this.pack_int32(r),this.pack_int32(l)};oi.prototype.pack_object=function(s){var t=Object.keys(s),e=t.length;if(e<=15)this.pack_uint8(128+e);else if(e<=65535)this.bufferBuilder.append(222),this.pack_uint16(e);else if(e<=4294967295)this.bufferBuilder.append(223),this.pack_uint32(e);else throw new Error("Invalid length");for(var i in s)s.hasOwnProperty(i)&&(this.pack(i),this.pack(s[i]))};oi.prototype.pack_uint8=function(s){this.bufferBuilder.append(s)};oi.prototype.pack_uint16=function(s){this.bufferBuilder.append(s>>8),this.bufferBuilder.append(s&255)};oi.prototype.pack_uint32=function(s){var t=s&4294967295;this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255)};oi.prototype.pack_uint64=function(s){var t=s/Math.pow(2,32),e=s%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};oi.prototype.pack_int8=function(s){this.bufferBuilder.append(s&255)};oi.prototype.pack_int16=function(s){this.bufferBuilder.append((s&65280)>>8),this.bufferBuilder.append(s&255)};oi.prototype.pack_int32=function(s){this.bufferBuilder.append(s>>>24&255),this.bufferBuilder.append((s&16711680)>>>16),this.bufferBuilder.append((s&65280)>>>8),this.bufferBuilder.append(s&255)};oi.prototype.pack_int64=function(s){var t=Math.floor(s/Math.pow(2,32)),e=s%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};function gk(s){var t=s.charCodeAt(0);return t<=2047?"00":t<=65535?"000":t<=2097151?"0000":t<=67108863?"00000":"000000"}function yk(s){return s.length>600?new Blob([s]).size:s.replace(/[^\u0000-\u007F]/g,gk).length}const mv=im(mk);let IS=!0,DS=!0;function zh(s,t,e){const i=s.match(t);return i&&i.length>=e&&parseInt(i[e],10)}function jc(s,t,e){if(!s.RTCPeerConnection)return;const i=s.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(r,l){if(r!==t)return n.apply(this,arguments);const c=h=>{const d=e(h);d&&(l.handleEvent?l.handleEvent(d):l(d))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(l,c),n.apply(this,[r,c])};const o=i.removeEventListener;i.removeEventListener=function(r,l){if(r!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(l))return o.apply(this,arguments);const c=this._eventMap[t].get(l);return this._eventMap[t].delete(l),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[r,c])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(r){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),r&&this.addEventListener(t,this["_on"+t]=r)},enumerable:!0,configurable:!0})}function _k(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(IS=s,s?"adapter.js logging disabled":"adapter.js logging enabled")}function bk(s){return typeof s!="boolean"?new Error("Argument type: "+typeof s+". Please use a boolean."):(DS=!s,"adapter.js deprecation warnings "+(s?"disabled":"enabled"))}function pb(){if(typeof window=="object"){if(IS)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function nm(s,t){DS&&console.warn(s+" is deprecated, please use "+t+" instead.")}function vk(s){const t={browser:null,version:null};if(typeof s>"u"||!s.navigator)return t.browser="Not a browser.",t;const{navigator:e}=s;if(e.mozGetUserMedia)t.browser="firefox",t.version=zh(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection&&!s.RTCIceGatherer)t.browser="chrome",t.version=zh(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=zh(e.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(s.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=zh(e.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function gv(s){return Object.prototype.toString.call(s)==="[object Object]"}function LS(s){return gv(s)?Object.keys(s).reduce(function(t,e){const i=gv(s[e]),n=i?LS(s[e]):s[e],o=i&&!Object.keys(n).length;return n===void 0||o?t:Object.assign(t,{[e]:n})},{}):s}function Uy(s,t,e){!t||e.has(t.id)||(e.set(t.id,t),Object.keys(t).forEach(i=>{i.endsWith("Id")?Uy(s,s.get(t[i]),e):i.endsWith("Ids")&&t[i].forEach(n=>{Uy(s,s.get(n),e)})}))}function yv(s,t,e){const i=e?"outbound-rtp":"inbound-rtp",n=new Map;if(t===null)return n;const o=[];return s.forEach(r=>{r.type==="track"&&r.trackIdentifier===t.id&&o.push(r)}),o.forEach(r=>{s.forEach(l=>{l.type===i&&l.trackId===r.id&&Uy(s,l,n)})}),n}const _v=pb;function jS(s,t){var l;const e=s&&s.navigator;if(!e.mediaDevices)return;const i=function(c){if(typeof c!="object"||c.mandatory||c.optional)return c;const h={};return Object.keys(c).forEach(d=>{if(d==="require"||d==="advanced"||d==="mediaSource")return;const u=typeof c[d]=="object"?c[d]:{ideal:c[d]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const f=function(p,g){return p?p+g.charAt(0).toUpperCase()+g.slice(1):g==="deviceId"?"sourceId":g};if(u.ideal!==void 0){h.optional=h.optional||[];let p={};typeof u.ideal=="number"?(p[f("min",d)]=u.ideal,h.optional.push(p),p={},p[f("max",d)]=u.ideal,h.optional.push(p)):(p[f("",d)]=u.ideal,h.optional.push(p))}u.exact!==void 0&&typeof u.exact!="number"?(h.mandatory=h.mandatory||{},h.mandatory[f("",d)]=u.exact):["min","max"].forEach(p=>{u[p]!==void 0&&(h.mandatory=h.mandatory||{},h.mandatory[f(p,d)]=u[p])})}),c.advanced&&(h.optional=(h.optional||[]).concat(c.advanced)),h},n=function(c,h){if(t.version>=61)return h(c);if(c=JSON.parse(JSON.stringify(c)),c&&typeof c.audio=="object"){const d=function(u,f,p){f in u&&!(p in u)&&(u[p]=u[f],delete u[f])};c=JSON.parse(JSON.stringify(c)),d(c.audio,"autoGainControl","googAutoGainControl"),d(c.audio,"noiseSuppression","googNoiseSuppression"),c.audio=i(c.audio)}if(c&&typeof c.video=="object"){let d=c.video.facingMode;d=d&&(typeof d=="object"?d:{ideal:d});const u=t.version<66;if(d&&(d.exact==="user"||d.exact==="environment"||d.ideal==="user"||d.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete c.video.facingMode;let f;if(d.exact==="environment"||d.ideal==="environment"?f=["back","rear"]:(d.exact==="user"||d.ideal==="user")&&(f=["front"]),f)return e.mediaDevices.enumerateDevices().then(p=>{p=p.filter(_=>_.kind==="videoinput");let g=p.find(_=>f.some(y=>_.label.toLowerCase().includes(y)));return!g&&p.length&&f.includes("back")&&(g=p[p.length-1]),g&&(c.video.deviceId=d.exact?{exact:g.deviceId}:{ideal:g.deviceId}),c.video=i(c.video),_v("chrome: "+JSON.stringify(c)),h(c)})}c.video=i(c.video)}return _v("chrome: "+JSON.stringify(c)),h(c)},o=function(c){return t.version>=64?c:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[c.name]||c.name,message:c.message,constraint:c.constraint||c.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},r=function(c,h,d){n(c,u=>{e.webkitGetUserMedia(u,h,f=>{d&&d(o(f))})})};if(e.getUserMedia=r.bind(e),e.mediaDevices.getUserMedia){const c=e.mediaDevices.getUserMedia.bind(e.mediaDevices);(l=Object.getOwnPropertyDescriptor(e.mediaDevices,"getUserMedia"))!=null&&l.writable&&(e.mediaDevices.getUserMedia=function(h){return n(h,d=>c(d).then(u=>{if(d.audio&&!u.getAudioTracks().length||d.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(f=>{f.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(o(u))))})}}function xk(s,t){if(!(s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices)&&s.navigator.mediaDevices){if(typeof t!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}s.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(n=>{const o=i.video&&i.video.width,r=i.video&&i.video.height,l=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:l||3}},o&&(i.video.mandatory.maxWidth=o),r&&(i.video.mandatory.maxHeight=r),s.navigator.mediaDevices.getUserMedia(i)})}}}function BS(s){s.MediaStream=s.MediaStream||s.webkitMediaStream}function FS(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("ontrack"in s.RTCPeerConnection.prototype)){Object.defineProperty(s.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",n=>{let o;s.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(l=>l.track&&l.track.id===n.track.id):o={track:n.track};const r=new Event("track");r.track=n.track,r.receiver=o,r.transceiver={receiver:o},r.streams=[i.stream],this.dispatchEvent(r)}),i.stream.getTracks().forEach(n=>{let o;s.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(l=>l.track&&l.track.id===n.id):o={track:n};const r=new Event("track");r.track=n,r.receiver=o,r.transceiver={receiver:o},r.streams=[i.stream],this.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else jc(s,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function zS(s){if(typeof s=="object"&&s.RTCPeerConnection&&!("getSenders"in s.RTCPeerConnection.prototype)&&"createDTMFSender"in s.RTCPeerConnection.prototype){const t=function(n,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=n.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:n}};if(!s.RTCPeerConnection.prototype.getSenders){s.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(l,c){let h=n.apply(this,arguments);return h||(h=t(this,l),this._senders.push(h)),h};const o=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(l){o.apply(this,arguments);const c=this._senders.indexOf(l);c!==-1&&this._senders.splice(c,1)}}const e=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(o){this._senders=this._senders||[],e.apply(this,[o]),o.getTracks().forEach(r=>{this._senders.push(t(this,r))})};const i=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(o){this._senders=this._senders||[],i.apply(this,[o]),o.getTracks().forEach(r=>{const l=this._senders.find(c=>c.track===r);l&&this._senders.splice(this._senders.indexOf(l),1)})}}else if(typeof s=="object"&&s.RTCPeerConnection&&"getSenders"in s.RTCPeerConnection.prototype&&"createDTMFSender"in s.RTCPeerConnection.prototype&&s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)){const t=s.RTCPeerConnection.prototype.getSenders;s.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach(n=>n._pc=this),i},Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function US(s){if(!s.RTCPeerConnection)return;const t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[i,n,o]=arguments;if(arguments.length>0&&typeof i=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof i!="function"))return t.apply(this,[]);const r=function(c){const h={};return c.result().forEach(u=>{const f={id:u.id,timestamp:u.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[u.type]||u.type};u.names().forEach(p=>{f[p]=u.stat(p)}),h[f.id]=f}),h},l=function(c){return new Map(Object.keys(c).map(h=>[h,c[h]]))};if(arguments.length>=2){const c=function(h){n(l(r(h)))};return t.apply(this,[c,i])}return new Promise((c,h)=>{t.apply(this,[function(d){c(l(r(d)))},h])}).then(n,o)}}function NS(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender&&s.RTCRtpReceiver))return;if(!("getStats"in s.RTCRtpSender.prototype)){const e=s.RTCPeerConnection.prototype.getSenders;e&&(s.RTCPeerConnection.prototype.getSenders=function(){const o=e.apply(this,[]);return o.forEach(r=>r._pc=this),o});const i=s.RTCPeerConnection.prototype.addTrack;i&&(s.RTCPeerConnection.prototype.addTrack=function(){const o=i.apply(this,arguments);return o._pc=this,o}),s.RTCRtpSender.prototype.getStats=function(){const o=this;return this._pc.getStats().then(r=>yv(r,o.track,!0))}}if(!("getStats"in s.RTCRtpReceiver.prototype)){const e=s.RTCPeerConnection.prototype.getReceivers;e&&(s.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(o=>o._pc=this),n}),jc(s,"track",i=>(i.receiver._pc=i.srcElement,i)),s.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(o=>yv(o,n.track,!1))}}if(!("getStats"in s.RTCRtpSender.prototype&&"getStats"in s.RTCRtpReceiver.prototype))return;const t=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof s.MediaStreamTrack){const i=arguments[0];let n,o,r;return this.getSenders().forEach(l=>{l.track===i&&(n?r=!0:n=l)}),this.getReceivers().forEach(l=>(l.track===i&&(o?r=!0:o=l),l.track===i)),r||n&&o?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():o?o.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function $S(s){s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(r=>this._shimmedLocalStreams[r][0])};const t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addTrack=function(r,l){if(!l)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=t.apply(this,arguments);return this._shimmedLocalStreams[l.id]?this._shimmedLocalStreams[l.id].indexOf(c)===-1&&this._shimmedLocalStreams[l.id].push(c):this._shimmedLocalStreams[l.id]=[l,c],c};const e=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(r){this._shimmedLocalStreams=this._shimmedLocalStreams||{},r.getTracks().forEach(h=>{if(this.getSenders().find(u=>u.track===h))throw new DOMException("Track already exists.","InvalidAccessError")});const l=this.getSenders();e.apply(this,arguments);const c=this.getSenders().filter(h=>l.indexOf(h)===-1);this._shimmedLocalStreams[r.id]=[r].concat(c)};const i=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[r.id],i.apply(this,arguments)};const n=s.RTCPeerConnection.prototype.removeTrack;s.RTCPeerConnection.prototype.removeTrack=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},r&&Object.keys(this._shimmedLocalStreams).forEach(l=>{const c=this._shimmedLocalStreams[l].indexOf(r);c!==-1&&this._shimmedLocalStreams[l].splice(c,1),this._shimmedLocalStreams[l].length===1&&delete this._shimmedLocalStreams[l]}),n.apply(this,arguments)}}function WS(s,t){if(!s.RTCPeerConnection)return;if(s.RTCPeerConnection.prototype.addTrack&&t.version>=65)return $S(s);const e=s.RTCPeerConnection.prototype.getLocalStreams;s.RTCPeerConnection.prototype.getLocalStreams=function(){const d=e.apply(this);return this._reverseStreams=this._reverseStreams||{},d.map(u=>this._reverseStreams[u.id])};const i=s.RTCPeerConnection.prototype.addStream;s.RTCPeerConnection.prototype.addStream=function(d){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.getTracks().forEach(u=>{if(this.getSenders().find(p=>p.track===u))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[d.id]){const u=new s.MediaStream(d.getTracks());this._streams[d.id]=u,this._reverseStreams[u.id]=d,d=u}i.apply(this,[d])};const n=s.RTCPeerConnection.prototype.removeStream;s.RTCPeerConnection.prototype.removeStream=function(d){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[d.id]||d]),delete this._reverseStreams[this._streams[d.id]?this._streams[d.id].id:d.id],delete this._streams[d.id]},s.RTCPeerConnection.prototype.addTrack=function(d,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const f=[].slice.call(arguments,1);if(f.length!==1||!f[0].getTracks().find(_=>_===d))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(_=>_.track===d))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const g=this._streams[u.id];if(g)g.addTrack(d),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const _=new s.MediaStream([d]);this._streams[u.id]=_,this._reverseStreams[_.id]=u,this.addStream(_)}return this.getSenders().find(_=>_.track===d)};function o(h,d){let u=d.sdp;return Object.keys(h._reverseStreams||[]).forEach(f=>{const p=h._reverseStreams[f],g=h._streams[p.id];u=u.replace(new RegExp(g.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:u})}function r(h,d){let u=d.sdp;return Object.keys(h._reverseStreams||[]).forEach(f=>{const p=h._reverseStreams[f],g=h._streams[p.id];u=u.replace(new RegExp(p.id,"g"),g.id)}),new RTCSessionDescription({type:d.type,sdp:u})}["createOffer","createAnswer"].forEach(function(h){const d=s.RTCPeerConnection.prototype[h],u={[h](){const f=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[g=>{const _=o(this,g);f[0].apply(null,[_])},g=>{f[1]&&f[1].apply(null,g)},arguments[2]]):d.apply(this,arguments).then(g=>o(this,g))}};s.RTCPeerConnection.prototype[h]=u[h]});const l=s.RTCPeerConnection.prototype.setLocalDescription;s.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?l.apply(this,arguments):(arguments[0]=r(this,arguments[0]),l.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(s.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(s.RTCPeerConnection.prototype,"localDescription",{get(){const h=c.get.apply(this);return h.type===""?h:o(this,h)}}),s.RTCPeerConnection.prototype.removeTrack=function(d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!d._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(d._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let f;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(_=>d.track===_)&&(f=this._streams[p])}),f&&(f.getTracks().length===1?this.removeStream(this._reverseStreams[f.id]):f.removeTrack(d.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Ny(s,t){!s.RTCPeerConnection&&s.webkitRTCPeerConnection&&(s.RTCPeerConnection=s.webkitRTCPeerConnection),s.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){const i=s.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new(e==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};s.RTCPeerConnection.prototype[e]=n[e]})}function VS(s,t){jc(s,"negotiationneeded",e=>{const i=e.target;if(!((t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return e})}const bv=Object.freeze(Object.defineProperty({__proto__:null,fixNegotiationNeeded:VS,shimAddTrackRemoveTrack:WS,shimAddTrackRemoveTrackWithNative:$S,shimGetDisplayMedia:xk,shimGetSendersWithDtmf:zS,shimGetStats:US,shimGetUserMedia:jS,shimMediaStream:BS,shimOnTrack:FS,shimPeerConnection:Ny,shimSenderReceiverGetStats:NS},Symbol.toStringTag,{value:"Module"}));function wk(s,t){let e=!1;return s=JSON.parse(JSON.stringify(s)),s.filter(i=>{if(i&&(i.urls||i.url)){let n=i.urls||i.url;i.url&&!i.urls&&nm("RTCIceServer.url","RTCIceServer.urls");const o=typeof n=="string";return o&&(n=[n]),n=n.filter(r=>{if(r.indexOf("stun:")===0)return!1;const l=r.startsWith("turn")&&!r.startsWith("turn:[")&&r.includes("transport=udp");return l&&!e?(e=!0,!0):l&&!e}),delete i.url,i.urls=o?n[0]:n,!!n.length}})}var HS={exports:{}};(function(s){var t={};t.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split(`
`).map(function(i){return i.trim()})},t.splitSections=function(e){var i=e.split(`
m=`);return i.map(function(n,o){return(o>0?"m="+n:n).trim()+`\r
`})},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter(function(n){return n.indexOf(i)===0})},t.parseCandidate=function(e){var i;e.indexOf("a=candidate:")===0?i=e.substring(12).split(" "):i=e.substring(10).split(" ");for(var n={foundation:i[0],component:parseInt(i[1],10),protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]},o=8;o<i.length;o+=2)switch(i[o]){case"raddr":n.relatedAddress=i[o+1];break;case"rport":n.relatedPort=parseInt(i[o+1],10);break;case"tcptype":n.tcpType=i[o+1];break;case"ufrag":n.ufrag=i[o+1],n.usernameFragment=i[o+1];break;default:n[i[o]]=i[o+1];break}return n},t.writeCandidate=function(e){var i=[];i.push(e.foundation),i.push(e.component),i.push(e.protocol.toUpperCase()),i.push(e.priority),i.push(e.address||e.ip),i.push(e.port);var n=e.type;return i.push("typ"),i.push(n),n!=="host"&&e.relatedAddress&&e.relatedPort&&(i.push("raddr"),i.push(e.relatedAddress),i.push("rport"),i.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(i.push("ufrag"),i.push(e.usernameFragment||e.ufrag)),"candidate:"+i.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var i=e.substr(9).split(" "),n={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),n.name=i[0],n.clockRate=parseInt(i[1],10),n.channels=i.length===3?parseInt(i[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){var i=e.payloadType;e.preferredPayloadType!==void 0&&(i=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+i+" "+e.name+"/"+e.clockRate+(n!==1?"/"+n:"")+`\r
`},t.parseExtmap=function(e){var i=e.substr(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+`\r
`},t.parseFmtp=function(e){for(var i={},n,o=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<o.length;r++)n=o[r].trim().split("="),i[n[0].trim()]=n[1];return i},t.writeFmtp=function(e){var i="",n=e.payloadType;if(e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var o=[];Object.keys(e.parameters).forEach(function(r){e.parameters[r]?o.push(r+"="+e.parameters[r]):o.push(r)}),i+="a=fmtp:"+n+" "+o.join(";")+`\r
`}return i},t.parseRtcpFb=function(e){var i=e.substr(e.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},t.writeRtcpFb=function(e){var i="",n=e.payloadType;return e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(o){i+="a=rtcp-fb:"+n+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),i},t.parseSsrcMedia=function(e){var i=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,i-7),10)},o=e.indexOf(":",i);return o>-1?(n.attribute=e.substr(i+1,o-i-1),n.value=e.substr(o+1)):n.attribute=e.substr(i+1),n},t.parseSsrcGroup=function(e){var i=e.substr(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(function(n){return parseInt(n,10)})}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var i=e.substr(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1]}},t.getDtlsParameters=function(e,i){var n=t.matchPrefix(e+i,"a=fingerprint:");return{role:"auto",fingerprints:n.map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,i){var n="a=setup:"+i+`\r
`;return e.fingerprints.forEach(function(o){n+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),n},t.parseCryptoLine=function(e){var i=e.substr(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;var i=e.substr(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){var n=t.matchPrefix(e+i,"a=crypto:");return n.map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],o=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&o?{usernameFragment:n.substr(12),password:o.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e),o=n[0].split(" "),r=3;r<o.length;r++){var l=o[r],c=t.matchPrefix(e,"a=rtpmap:"+l+" ")[0];if(c){var h=t.parseRtpMap(c),d=t.matchPrefix(e,"a=fmtp:"+l+" ");switch(h.parameters=d.length?t.parseFmtp(d[0]):{},h.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+l+" ").map(t.parseRtcpFb),i.codecs.push(h),h.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(h.name.toUpperCase());break}}}return t.matchPrefix(e,"a=extmap:").forEach(function(u){i.headerExtensions.push(t.parseExtmap(u))}),i},t.writeRtpDescription=function(e,i){var n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=i.codecs.map(function(r){return r.preferredPayloadType!==void 0?r.preferredPayloadType:r.payloadType}).join(" ")+`\r
`,n+=`c=IN IP4 0.0.0.0\r
`,n+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(function(r){n+=t.writeRtpMap(r),n+=t.writeFmtp(r),n+=t.writeRtcpFb(r)});var o=0;return i.codecs.forEach(function(r){r.maxptime>o&&(o=r.maxptime)}),o>0&&(n+="a=maxptime:"+o+`\r
`),n+=`a=rtcp-mux\r
`,i.headerExtensions&&i.headerExtensions.forEach(function(r){n+=t.writeExtmap(r)}),n},t.parseRtpEncodingParameters=function(e){var i=[],n=t.parseRtpParameters(e),o=n.fecMechanisms.indexOf("RED")!==-1,r=n.fecMechanisms.indexOf("ULPFEC")!==-1,l=t.matchPrefix(e,"a=ssrc:").map(function(f){return t.parseSsrcMedia(f)}).filter(function(f){return f.attribute==="cname"}),c=l.length>0&&l[0].ssrc,h,d=t.matchPrefix(e,"a=ssrc-group:FID").map(function(f){var p=f.substr(17).split(" ");return p.map(function(g){return parseInt(g,10)})});d.length>0&&d[0].length>1&&d[0][0]===c&&(h=d[0][1]),n.codecs.forEach(function(f){if(f.name.toUpperCase()==="RTX"&&f.parameters.apt){var p={ssrc:c,codecPayloadType:parseInt(f.parameters.apt,10)};c&&h&&(p.rtx={ssrc:h}),i.push(p),o&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:r?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});var u=t.matchPrefix(e,"b=");return u.length&&(u[0].indexOf("b=TIAS:")===0?u=parseInt(u[0].substr(7),10):u[0].indexOf("b=AS:")===0?u=parseInt(u[0].substr(5),10)*1e3*.95-50*40*8:u=void 0,i.forEach(function(f){f.maxBitrate=u})),i},t.parseRtcpParameters=function(e){var i={},n=t.matchPrefix(e,"a=ssrc:").map(function(l){return t.parseSsrcMedia(l)}).filter(function(l){return l.attribute==="cname"})[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);var o=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;var r=t.matchPrefix(e,"a=rtcp-mux");return i.mux=r.length>0,i},t.parseMsid=function(e){var i,n=t.matchPrefix(e,"a=msid:");if(n.length===1)return i=n[0].substr(7).split(" "),{stream:i[0],track:i[1]};var o=t.matchPrefix(e,"a=ssrc:").map(function(r){return t.parseSsrcMedia(r)}).filter(function(r){return r.attribute==="msid"});if(o.length>0)return i=o[0].value.split(" "),{stream:i[0],track:i[1]}},t.parseSctpDescription=function(e){var i=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:"),o;n.length>0&&(o=parseInt(n[0].substr(19),10)),isNaN(o)&&(o=65536);var r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substr(12),10),protocol:i.fmt,maxMessageSize:o};var l=t.matchPrefix(e,"a=sctpmap:");if(l.length>0){var c=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},t.writeSctpDescription=function(e,i){var n=[];return e.protocol!=="DTLS/SCTP"?n=["m="+e.kind+" 9 "+e.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:n=["m="+e.kind+" 9 "+e.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&n.push("a=max-message-size:"+i.maxMessageSize+`\r
`),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,n){var o,r=i!==void 0?i:2;e?o=e:o=t.generateSessionId();var l=n||"thisisadapterortc";return`v=0\r
o=`+l+" "+o+" "+r+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.writeMediaSection=function(e,i,n,o){var r=t.writeRtpDescription(e.kind,i);if(r+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),n==="offer"?"actpass":"active"),r+="a=mid:"+e.mid+`\r
`,e.direction?r+="a="+e.direction+`\r
`:e.rtpSender&&e.rtpReceiver?r+=`a=sendrecv\r
`:e.rtpSender?r+=`a=sendonly\r
`:e.rtpReceiver?r+=`a=recvonly\r
`:r+=`a=inactive\r
`,e.rtpSender){var l="msid:"+o.id+" "+e.rtpSender.track.id+`\r
`;r+="a="+l,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+l,e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+l,r+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+`\r
`,e.rtpSender&&e.sendEncodingParameters[0].rtx&&(r+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+`\r
`),r},t.getDirection=function(e,i){for(var n=t.splitLines(e),o=0;o<n.length;o++)switch(n[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[o].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){var i=t.splitLines(e),n=i[0].split(" ");return n[0].substr(2)},t.isRejected=function(e){return e.split(" ",2)[1]==="0"},t.parseMLine=function(e){var i=t.splitLines(e),n=i[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0],n=i.substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;for(var i=t.splitLines(e),n=0;n<i.length;n++)if(i[n].length<2||i[n].charAt(1)!=="=")return!1;return!0},s.exports=t})(HS);var GS=HS.exports;const vf=im(GS);var re=GS;function Sk(s){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[s.type]||s.type}function vv(s,t,e,i,n){var o=re.writeRtpDescription(s.kind,t);if(o+=re.writeIceParameters(s.iceGatherer.getLocalParameters()),o+=re.writeDtlsParameters(s.dtlsTransport.getLocalParameters(),e==="offer"?"actpass":n||"active"),o+="a=mid:"+s.mid+`\r
`,s.rtpSender&&s.rtpReceiver?o+=`a=sendrecv\r
`:s.rtpSender?o+=`a=sendonly\r
`:s.rtpReceiver?o+=`a=recvonly\r
`:o+=`a=inactive\r
`,s.rtpSender){var r=s.rtpSender._initialTrackId||s.rtpSender.track.id;s.rtpSender._initialTrackId=r;var l="msid:"+(i?i.id:"-")+" "+r+`\r
`;o+="a="+l,o+="a=ssrc:"+s.sendEncodingParameters[0].ssrc+" "+l,s.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+s.sendEncodingParameters[0].rtx.ssrc+" "+l,o+="a=ssrc-group:FID "+s.sendEncodingParameters[0].ssrc+" "+s.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return o+="a=ssrc:"+s.sendEncodingParameters[0].ssrc+" cname:"+re.localCName+`\r
`,s.rtpSender&&s.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+s.sendEncodingParameters[0].rtx.ssrc+" cname:"+re.localCName+`\r
`),o}function Ck(s,t){var e=!1;return s=JSON.parse(JSON.stringify(s)),s.filter(function(i){if(i&&(i.urls||i.url)){var n=i.urls||i.url;i.url&&!i.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var o=typeof n=="string";return o&&(n=[n]),n=n.filter(function(r){var l=r.indexOf("turn:")===0&&r.indexOf("transport=udp")!==-1&&r.indexOf("turn:[")===-1&&!e;return l?(e=!0,!0):r.indexOf("stun:")===0&&t>=14393&&r.indexOf("?transport=udp")===-1}),delete i.url,i.urls=o?n[0]:n,!!n.length}})}function Iu(s,t){var e={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(o,r){o=parseInt(o,10);for(var l=0;l<r.length;l++)if(r[l].payloadType===o||r[l].preferredPayloadType===o)return r[l]},n=function(o,r,l,c){var h=i(o.parameters.apt,l),d=i(r.parameters.apt,c);return h&&d&&h.name.toLowerCase()===d.name.toLowerCase()};return s.codecs.forEach(function(o){for(var r=0;r<t.codecs.length;r++){var l=t.codecs[r];if(o.name.toLowerCase()===l.name.toLowerCase()&&o.clockRate===l.clockRate){if(o.name.toLowerCase()==="rtx"&&o.parameters&&l.parameters.apt&&!n(o,l,s.codecs,t.codecs))continue;l=JSON.parse(JSON.stringify(l)),l.numChannels=Math.min(o.numChannels,l.numChannels),e.codecs.push(l),l.rtcpFeedback=l.rtcpFeedback.filter(function(c){for(var h=0;h<o.rtcpFeedback.length;h++)if(o.rtcpFeedback[h].type===c.type&&o.rtcpFeedback[h].parameter===c.parameter)return!0;return!1});break}}}),s.headerExtensions.forEach(function(o){for(var r=0;r<t.headerExtensions.length;r++){var l=t.headerExtensions[r];if(o.uri===l.uri){e.headerExtensions.push(l);break}}}),e}function xv(s,t,e){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][s].indexOf(e)!==-1}function Sg(s,t){var e=s.getRemoteCandidates().find(function(i){return t.foundation===i.foundation&&t.ip===i.ip&&t.port===i.port&&t.priority===i.priority&&t.protocol===i.protocol&&t.type===i.type});return e||s.addRemoteCandidate(t),!e}function li(s,t){var e=new Error(t);return e.name=s,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[s],e}var Pk=function(s,t){function e(c,h){h.addTrack(c),h.dispatchEvent(new s.MediaStreamTrackEvent("addtrack",{track:c}))}function i(c,h){h.removeTrack(c),h.dispatchEvent(new s.MediaStreamTrackEvent("removetrack",{track:c}))}function n(c,h,d,u){var f=new Event("track");f.track=h,f.receiver=d,f.transceiver={receiver:d},f.streams=u,s.setTimeout(function(){c._dispatchEvent("track",f)})}var o=function(c){var h=this,d=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(f){h[f]=d[f].bind(d)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",c=JSON.parse(JSON.stringify(c||{})),this.usingBundle=c.bundlePolicy==="max-bundle",c.rtcpMuxPolicy==="negotiate")throw li("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(c.rtcpMuxPolicy||(c.rtcpMuxPolicy="require"),c.iceTransportPolicy){case"all":case"relay":break;default:c.iceTransportPolicy="all";break}switch(c.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:c.bundlePolicy="balanced";break}if(c.iceServers=Ck(c.iceServers||[],t),this._iceGatherers=[],c.iceCandidatePoolSize)for(var u=c.iceCandidatePoolSize;u>0;u--)this._iceGatherers.push(new s.RTCIceGatherer({iceServers:c.iceServers,gatherPolicy:c.iceTransportPolicy}));else c.iceCandidatePoolSize=0;this._config=c,this.transceivers=[],this._sdpSessionId=re.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(o.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(o.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),o.prototype.onicecandidate=null,o.prototype.onaddstream=null,o.prototype.ontrack=null,o.prototype.onremovestream=null,o.prototype.onsignalingstatechange=null,o.prototype.oniceconnectionstatechange=null,o.prototype.onconnectionstatechange=null,o.prototype.onicegatheringstatechange=null,o.prototype.onnegotiationneeded=null,o.prototype.ondatachannel=null,o.prototype._dispatchEvent=function(c,h){this._isClosed||(this.dispatchEvent(h),typeof this["on"+c]=="function"&&this["on"+c](h))},o.prototype._emitGatheringStateChange=function(){var c=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",c)},o.prototype.getConfiguration=function(){return this._config},o.prototype.getLocalStreams=function(){return this.localStreams},o.prototype.getRemoteStreams=function(){return this.remoteStreams},o.prototype._createTransceiver=function(c,h){var d=this.transceivers.length>0,u={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:c,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&d)u.iceTransport=this.transceivers[0].iceTransport,u.dtlsTransport=this.transceivers[0].dtlsTransport;else{var f=this._createIceAndDtlsTransports();u.iceTransport=f.iceTransport,u.dtlsTransport=f.dtlsTransport}return h||this.transceivers.push(u),u},o.prototype.addTrack=function(c,h){if(this._isClosed)throw li("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var d=this.transceivers.find(function(p){return p.track===c});if(d)throw li("InvalidAccessError","Track already exists.");for(var u,f=0;f<this.transceivers.length;f++)!this.transceivers[f].track&&this.transceivers[f].kind===c.kind&&(u=this.transceivers[f]);return u||(u=this._createTransceiver(c.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(h)===-1&&this.localStreams.push(h),u.track=c,u.stream=h,u.rtpSender=new s.RTCRtpSender(c,u.dtlsTransport),u.rtpSender},o.prototype.addStream=function(c){var h=this;if(t>=15025)c.getTracks().forEach(function(u){h.addTrack(u,c)});else{var d=c.clone();c.getTracks().forEach(function(u,f){var p=d.getTracks()[f];u.addEventListener("enabled",function(g){p.enabled=g.enabled})}),d.getTracks().forEach(function(u){h.addTrack(u,d)})}},o.prototype.removeTrack=function(c){if(this._isClosed)throw li("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(c instanceof s.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var h=this.transceivers.find(function(f){return f.rtpSender===c});if(!h)throw li("InvalidAccessError","Sender was not created by this connection.");var d=h.stream;h.rtpSender.stop(),h.rtpSender=null,h.track=null,h.stream=null;var u=this.transceivers.map(function(f){return f.stream});u.indexOf(d)===-1&&this.localStreams.indexOf(d)>-1&&this.localStreams.splice(this.localStreams.indexOf(d),1),this._maybeFireNegotiationNeeded()},o.prototype.removeStream=function(c){var h=this;c.getTracks().forEach(function(d){var u=h.getSenders().find(function(f){return f.track===d});u&&h.removeTrack(u)})},o.prototype.getSenders=function(){return this.transceivers.filter(function(c){return!!c.rtpSender}).map(function(c){return c.rtpSender})},o.prototype.getReceivers=function(){return this.transceivers.filter(function(c){return!!c.rtpReceiver}).map(function(c){return c.rtpReceiver})},o.prototype._createIceGatherer=function(c,h){var d=this;if(h&&c>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var u=new s.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(u,"state",{value:"new",writable:!0}),this.transceivers[c].bufferedCandidateEvents=[],this.transceivers[c].bufferCandidates=function(f){var p=!f.candidate||Object.keys(f.candidate).length===0;u.state=p?"completed":"gathering",d.transceivers[c].bufferedCandidateEvents!==null&&d.transceivers[c].bufferedCandidateEvents.push(f)},u.addEventListener("localcandidate",this.transceivers[c].bufferCandidates),u},o.prototype._gather=function(c,h){var d=this,u=this.transceivers[h].iceGatherer;if(!u.onlocalcandidate){var f=this.transceivers[h].bufferedCandidateEvents;this.transceivers[h].bufferedCandidateEvents=null,u.removeEventListener("localcandidate",this.transceivers[h].bufferCandidates),u.onlocalcandidate=function(p){if(!(d.usingBundle&&h>0)){var g=new Event("icecandidate");g.candidate={sdpMid:c,sdpMLineIndex:h};var _=p.candidate,y=!_||Object.keys(_).length===0;if(y)(u.state==="new"||u.state==="gathering")&&(u.state="completed");else{u.state==="new"&&(u.state="gathering"),_.component=1,_.ufrag=u.getLocalParameters().usernameFragment;var b=re.writeCandidate(_);g.candidate=Object.assign(g.candidate,re.parseCandidate(b)),g.candidate.candidate=b,g.candidate.toJSON=function(){return{candidate:g.candidate.candidate,sdpMid:g.candidate.sdpMid,sdpMLineIndex:g.candidate.sdpMLineIndex,usernameFragment:g.candidate.usernameFragment}}}var v=re.getMediaSections(d._localDescription.sdp);y?v[g.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:v[g.candidate.sdpMLineIndex]+="a="+g.candidate.candidate+`\r
`,d._localDescription.sdp=re.getDescription(d._localDescription.sdp)+v.join("");var w=d.transceivers.every(function(P){return P.iceGatherer&&P.iceGatherer.state==="completed"});d.iceGatheringState!=="gathering"&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),y||d._dispatchEvent("icecandidate",g),w&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},s.setTimeout(function(){f.forEach(function(p){u.onlocalcandidate(p)})},0)}},o.prototype._createIceAndDtlsTransports=function(){var c=this,h=new s.RTCIceTransport(null);h.onicestatechange=function(){c._updateIceConnectionState(),c._updateConnectionState()};var d=new s.RTCDtlsTransport(h);return d.ondtlsstatechange=function(){c._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),c._updateConnectionState()},{iceTransport:h,dtlsTransport:d}},o.prototype._disposeIceAndDtlsTransports=function(c){var h=this.transceivers[c].iceGatherer;h&&(delete h.onlocalcandidate,delete this.transceivers[c].iceGatherer);var d=this.transceivers[c].iceTransport;d&&(delete d.onicestatechange,delete this.transceivers[c].iceTransport);var u=this.transceivers[c].dtlsTransport;u&&(delete u.ondtlsstatechange,delete u.onerror,delete this.transceivers[c].dtlsTransport)},o.prototype._transceive=function(c,h,d){var u=Iu(c.localCapabilities,c.remoteCapabilities);h&&c.rtpSender&&(u.encodings=c.sendEncodingParameters,u.rtcp={cname:re.localCName,compound:c.rtcpParameters.compound},c.recvEncodingParameters.length&&(u.rtcp.ssrc=c.recvEncodingParameters[0].ssrc),c.rtpSender.send(u)),d&&c.rtpReceiver&&u.codecs.length>0&&(c.kind==="video"&&c.recvEncodingParameters&&t<15019&&c.recvEncodingParameters.forEach(function(f){delete f.rtx}),c.recvEncodingParameters.length?u.encodings=c.recvEncodingParameters:u.encodings=[{}],u.rtcp={compound:c.rtcpParameters.compound},c.rtcpParameters.cname&&(u.rtcp.cname=c.rtcpParameters.cname),c.sendEncodingParameters.length&&(u.rtcp.ssrc=c.sendEncodingParameters[0].ssrc),c.rtpReceiver.receive(u))},o.prototype.setLocalDescription=function(c){var h=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(li("TypeError",'Unsupported type "'+c.type+'"'));if(!xv("setLocalDescription",c.type,h.signalingState)||h._isClosed)return Promise.reject(li("InvalidStateError","Can not set local "+c.type+" in state "+h.signalingState));var d,u;if(c.type==="offer")d=re.splitSections(c.sdp),u=d.shift(),d.forEach(function(p,g){var _=re.parseRtpParameters(p);h.transceivers[g].localCapabilities=_}),h.transceivers.forEach(function(p,g){h._gather(p.mid,g)});else if(c.type==="answer"){d=re.splitSections(h._remoteDescription.sdp),u=d.shift();var f=re.matchPrefix(u,"a=ice-lite").length>0;d.forEach(function(p,g){var _=h.transceivers[g],y=_.iceGatherer,b=_.iceTransport,v=_.dtlsTransport,w=_.localCapabilities,P=_.remoteCapabilities,E=re.isRejected(p)&&re.matchPrefix(p,"a=bundle-only").length===0;if(!E&&!_.rejected){var T=re.getIceParameters(p,u),k=re.getDtlsParameters(p,u);f&&(k.role="server"),(!h.usingBundle||g===0)&&(h._gather(_.mid,g),b.state==="new"&&b.start(y,T,f?"controlling":"controlled"),v.state==="new"&&v.start(k));var z=Iu(w,P);h._transceive(_,z.codecs.length>0,!1)}})}return h._localDescription={type:c.type,sdp:c.sdp},c.type==="offer"?h._updateSignalingState("have-local-offer"):h._updateSignalingState("stable"),Promise.resolve()},o.prototype.setRemoteDescription=function(c){var h=this;if(["offer","answer"].indexOf(c.type)===-1)return Promise.reject(li("TypeError",'Unsupported type "'+c.type+'"'));if(!xv("setRemoteDescription",c.type,h.signalingState)||h._isClosed)return Promise.reject(li("InvalidStateError","Can not set remote "+c.type+" in state "+h.signalingState));var d={};h.remoteStreams.forEach(function(b){d[b.id]=b});var u=[],f=re.splitSections(c.sdp),p=f.shift(),g=re.matchPrefix(p,"a=ice-lite").length>0,_=re.matchPrefix(p,"a=group:BUNDLE ").length>0;h.usingBundle=_;var y=re.matchPrefix(p,"a=ice-options:")[0];return y?h.canTrickleIceCandidates=y.substr(14).split(" ").indexOf("trickle")>=0:h.canTrickleIceCandidates=!1,f.forEach(function(b,v){var w=re.splitLines(b),P=re.getKind(b),E=re.isRejected(b)&&re.matchPrefix(b,"a=bundle-only").length===0,T=w[0].substr(2).split(" ")[2],k=re.getDirection(b,p),z=re.parseMsid(b),L=re.getMid(b)||re.generateIdentifier();if(E||P==="application"&&(T==="DTLS/SCTP"||T==="UDP/DTLS/SCTP")){h.transceivers[v]={mid:L,kind:P,protocol:T,rejected:!0};return}!E&&h.transceivers[v]&&h.transceivers[v].rejected&&(h.transceivers[v]=h._createTransceiver(P,!0));var O,A,$,B,I,V,ie,Z,J,ue=re.parseRtpParameters(b),Ae,He;E||(Ae=re.getIceParameters(b,p),He=re.getDtlsParameters(b,p),He.role="client"),ie=re.parseRtpEncodingParameters(b);var ai=re.parseRtcpParameters(b),Wt=re.matchPrefix(b,"a=end-of-candidates",p).length>0,Zi=re.matchPrefix(b,"a=candidate:").map(function(Me){return re.parseCandidate(Me)}).filter(function(Me){return Me.component===1});if((c.type==="offer"||c.type==="answer")&&!E&&_&&v>0&&h.transceivers[v]&&(h._disposeIceAndDtlsTransports(v),h.transceivers[v].iceGatherer=h.transceivers[0].iceGatherer,h.transceivers[v].iceTransport=h.transceivers[0].iceTransport,h.transceivers[v].dtlsTransport=h.transceivers[0].dtlsTransport,h.transceivers[v].rtpSender&&h.transceivers[v].rtpSender.setTransport(h.transceivers[0].dtlsTransport),h.transceivers[v].rtpReceiver&&h.transceivers[v].rtpReceiver.setTransport(h.transceivers[0].dtlsTransport)),c.type==="offer"&&!E){O=h.transceivers[v]||h._createTransceiver(P),O.mid=L,O.iceGatherer||(O.iceGatherer=h._createIceGatherer(v,_)),Zi.length&&O.iceTransport.state==="new"&&(Wt&&(!_||v===0)?O.iceTransport.setRemoteCandidates(Zi):Zi.forEach(function(Me){Sg(O.iceTransport,Me)})),Z=s.RTCRtpReceiver.getCapabilities(P),t<15019&&(Z.codecs=Z.codecs.filter(function(Me){return Me.name!=="rtx"})),V=O.sendEncodingParameters||[{ssrc:(2*v+2)*1001}];var en=!1;if(k==="sendrecv"||k==="sendonly"){if(en=!O.rtpReceiver,I=O.rtpReceiver||new s.RTCRtpReceiver(O.dtlsTransport,P),en){var xi;J=I.track,z&&z.stream==="-"||(z?(d[z.stream]||(d[z.stream]=new s.MediaStream,Object.defineProperty(d[z.stream],"id",{get:function(){return z.stream}})),Object.defineProperty(J,"id",{get:function(){return z.track}}),xi=d[z.stream]):(d.default||(d.default=new s.MediaStream),xi=d.default)),xi&&(e(J,xi),O.associatedRemoteMediaStreams.push(xi)),u.push([J,I,xi])}}else O.rtpReceiver&&O.rtpReceiver.track&&(O.associatedRemoteMediaStreams.forEach(function(Me){var Sl=Me.getTracks().find(function(rh){return rh.id===O.rtpReceiver.track.id});Sl&&i(Sl,Me)}),O.associatedRemoteMediaStreams=[]);O.localCapabilities=Z,O.remoteCapabilities=ue,O.rtpReceiver=I,O.rtcpParameters=ai,O.sendEncodingParameters=V,O.recvEncodingParameters=ie,h._transceive(h.transceivers[v],!1,en)}else if(c.type==="answer"&&!E){O=h.transceivers[v],A=O.iceGatherer,$=O.iceTransport,B=O.dtlsTransport,I=O.rtpReceiver,V=O.sendEncodingParameters,Z=O.localCapabilities,h.transceivers[v].recvEncodingParameters=ie,h.transceivers[v].remoteCapabilities=ue,h.transceivers[v].rtcpParameters=ai,Zi.length&&$.state==="new"&&((g||Wt)&&(!_||v===0)?$.setRemoteCandidates(Zi):Zi.forEach(function(Me){Sg(O.iceTransport,Me)})),(!_||v===0)&&($.state==="new"&&$.start(A,Ae,"controlling"),B.state==="new"&&B.start(He));var xs=Iu(O.localCapabilities,O.remoteCapabilities),pa=xs.codecs.filter(function(Me){return Me.name.toLowerCase()==="rtx"}).length;!pa&&O.sendEncodingParameters[0].rtx&&delete O.sendEncodingParameters[0].rtx,h._transceive(O,k==="sendrecv"||k==="recvonly",k==="sendrecv"||k==="sendonly"),I&&(k==="sendrecv"||k==="sendonly")?(J=I.track,z?(d[z.stream]||(d[z.stream]=new s.MediaStream),e(J,d[z.stream]),u.push([J,I,d[z.stream]])):(d.default||(d.default=new s.MediaStream),e(J,d.default),u.push([J,I,d.default]))):delete O.rtpReceiver}}),h._dtlsRole===void 0&&(h._dtlsRole=c.type==="offer"?"active":"passive"),h._remoteDescription={type:c.type,sdp:c.sdp},c.type==="offer"?h._updateSignalingState("have-remote-offer"):h._updateSignalingState("stable"),Object.keys(d).forEach(function(b){var v=d[b];if(v.getTracks().length){if(h.remoteStreams.indexOf(v)===-1){h.remoteStreams.push(v);var w=new Event("addstream");w.stream=v,s.setTimeout(function(){h._dispatchEvent("addstream",w)})}u.forEach(function(P){var E=P[0],T=P[1];v.id===P[2].id&&n(h,E,T,[v])})}}),u.forEach(function(b){b[2]||n(h,b[0],b[1],[])}),s.setTimeout(function(){h&&h.transceivers&&h.transceivers.forEach(function(b){b.iceTransport&&b.iceTransport.state==="new"&&b.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),b.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},o.prototype.close=function(){this.transceivers.forEach(function(c){c.iceTransport&&c.iceTransport.stop(),c.dtlsTransport&&c.dtlsTransport.stop(),c.rtpSender&&c.rtpSender.stop(),c.rtpReceiver&&c.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},o.prototype._updateSignalingState=function(c){this.signalingState=c;var h=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",h)},o.prototype._maybeFireNegotiationNeeded=function(){var c=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,s.setTimeout(function(){if(c.needNegotiation){c.needNegotiation=!1;var h=new Event("negotiationneeded");c._dispatchEvent("negotiationneeded",h)}},0))},o.prototype._updateIceConnectionState=function(){var c,h={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&!u.rejected&&h[u.iceTransport.state]++}),c="new",h.failed>0?c="failed":h.checking>0?c="checking":h.disconnected>0?c="disconnected":h.new>0?c="new":h.connected>0?c="connected":h.completed>0&&(c="completed"),c!==this.iceConnectionState){this.iceConnectionState=c;var d=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",d)}},o.prototype._updateConnectionState=function(){var c,h={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&u.dtlsTransport&&!u.rejected&&(h[u.iceTransport.state]++,h[u.dtlsTransport.state]++)}),h.connected+=h.completed,c="new",h.failed>0?c="failed":h.connecting>0?c="connecting":h.disconnected>0?c="disconnected":h.new>0?c="new":h.connected>0&&(c="connected"),c!==this.connectionState){this.connectionState=c;var d=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",d)}},o.prototype.createOffer=function(){var c=this;if(c._isClosed)return Promise.reject(li("InvalidStateError","Can not call createOffer after close"));var h=c.transceivers.filter(function(g){return g.kind==="audio"}).length,d=c.transceivers.filter(function(g){return g.kind==="video"}).length,u=arguments[0];if(u){if(u.mandatory||u.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");u.offerToReceiveAudio!==void 0&&(u.offerToReceiveAudio===!0?h=1:u.offerToReceiveAudio===!1?h=0:h=u.offerToReceiveAudio),u.offerToReceiveVideo!==void 0&&(u.offerToReceiveVideo===!0?d=1:u.offerToReceiveVideo===!1?d=0:d=u.offerToReceiveVideo)}for(c.transceivers.forEach(function(g){g.kind==="audio"?(h--,h<0&&(g.wantReceive=!1)):g.kind==="video"&&(d--,d<0&&(g.wantReceive=!1))});h>0||d>0;)h>0&&(c._createTransceiver("audio"),h--),d>0&&(c._createTransceiver("video"),d--);var f=re.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.transceivers.forEach(function(g,_){var y=g.track,b=g.kind,v=g.mid||re.generateIdentifier();g.mid=v,g.iceGatherer||(g.iceGatherer=c._createIceGatherer(_,c.usingBundle));var w=s.RTCRtpSender.getCapabilities(b);t<15019&&(w.codecs=w.codecs.filter(function(E){return E.name!=="rtx"})),w.codecs.forEach(function(E){E.name==="H264"&&E.parameters["level-asymmetry-allowed"]===void 0&&(E.parameters["level-asymmetry-allowed"]="1"),g.remoteCapabilities&&g.remoteCapabilities.codecs&&g.remoteCapabilities.codecs.forEach(function(T){E.name.toLowerCase()===T.name.toLowerCase()&&E.clockRate===T.clockRate&&(E.preferredPayloadType=T.payloadType)})}),w.headerExtensions.forEach(function(E){var T=g.remoteCapabilities&&g.remoteCapabilities.headerExtensions||[];T.forEach(function(k){E.uri===k.uri&&(E.id=k.id)})});var P=g.sendEncodingParameters||[{ssrc:(2*_+1)*1001}];y&&t>=15019&&b==="video"&&!P[0].rtx&&(P[0].rtx={ssrc:P[0].ssrc+1}),g.wantReceive&&(g.rtpReceiver=new s.RTCRtpReceiver(g.dtlsTransport,b)),g.localCapabilities=w,g.sendEncodingParameters=P}),c._config.bundlePolicy!=="max-compat"&&(f+="a=group:BUNDLE "+c.transceivers.map(function(g){return g.mid}).join(" ")+`\r
`),f+=`a=ice-options:trickle\r
`,c.transceivers.forEach(function(g,_){f+=vv(g,g.localCapabilities,"offer",g.stream,c._dtlsRole),f+=`a=rtcp-rsize\r
`,g.iceGatherer&&c.iceGatheringState!=="new"&&(_===0||!c.usingBundle)&&(g.iceGatherer.getLocalCandidates().forEach(function(y){y.component=1,f+="a="+re.writeCandidate(y)+`\r
`}),g.iceGatherer.state==="completed"&&(f+=`a=end-of-candidates\r
`))});var p=new s.RTCSessionDescription({type:"offer",sdp:f});return Promise.resolve(p)},o.prototype.createAnswer=function(){var c=this;if(c._isClosed)return Promise.reject(li("InvalidStateError","Can not call createAnswer after close"));if(!(c.signalingState==="have-remote-offer"||c.signalingState==="have-local-pranswer"))return Promise.reject(li("InvalidStateError","Can not call createAnswer in signalingState "+c.signalingState));var h=re.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.usingBundle&&(h+="a=group:BUNDLE "+c.transceivers.map(function(f){return f.mid}).join(" ")+`\r
`),h+=`a=ice-options:trickle\r
`;var d=re.getMediaSections(c._remoteDescription.sdp).length;c.transceivers.forEach(function(f,p){if(!(p+1>d)){if(f.rejected){f.kind==="application"?f.protocol==="DTLS/SCTP"?h+=`m=application 0 DTLS/SCTP 5000\r
`:h+="m=application 0 "+f.protocol+` webrtc-datachannel\r
`:f.kind==="audio"?h+=`m=audio 0 UDP/TLS/RTP/SAVPF 0\r
a=rtpmap:0 PCMU/8000\r
`:f.kind==="video"&&(h+=`m=video 0 UDP/TLS/RTP/SAVPF 120\r
a=rtpmap:120 VP8/90000\r
`),h+=`c=IN IP4 0.0.0.0\r
a=inactive\r
a=mid:`+f.mid+`\r
`;return}if(f.stream){var g;f.kind==="audio"?g=f.stream.getAudioTracks()[0]:f.kind==="video"&&(g=f.stream.getVideoTracks()[0]),g&&t>=15019&&f.kind==="video"&&!f.sendEncodingParameters[0].rtx&&(f.sendEncodingParameters[0].rtx={ssrc:f.sendEncodingParameters[0].ssrc+1})}var _=Iu(f.localCapabilities,f.remoteCapabilities),y=_.codecs.filter(function(b){return b.name.toLowerCase()==="rtx"}).length;!y&&f.sendEncodingParameters[0].rtx&&delete f.sendEncodingParameters[0].rtx,h+=vv(f,_,"answer",f.stream,c._dtlsRole),f.rtcpParameters&&f.rtcpParameters.reducedSize&&(h+=`a=rtcp-rsize\r
`)}});var u=new s.RTCSessionDescription({type:"answer",sdp:h});return Promise.resolve(u)},o.prototype.addIceCandidate=function(c){var h=this,d;return c&&!(c.sdpMLineIndex!==void 0||c.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(u,f){if(h._remoteDescription)if(!c||c.candidate==="")for(var p=0;p<h.transceivers.length&&!(!h.transceivers[p].rejected&&(h.transceivers[p].iceTransport.addRemoteCandidate({}),d=re.getMediaSections(h._remoteDescription.sdp),d[p]+=`a=end-of-candidates\r
`,h._remoteDescription.sdp=re.getDescription(h._remoteDescription.sdp)+d.join(""),h.usingBundle));p++);else{var g=c.sdpMLineIndex;if(c.sdpMid){for(var _=0;_<h.transceivers.length;_++)if(h.transceivers[_].mid===c.sdpMid){g=_;break}}var y=h.transceivers[g];if(y){if(y.rejected)return u();var b=Object.keys(c.candidate).length>0?re.parseCandidate(c.candidate):{};if(b.protocol==="tcp"&&(b.port===0||b.port===9)||b.component&&b.component!==1)return u();if((g===0||g>0&&y.iceTransport!==h.transceivers[0].iceTransport)&&!Sg(y.iceTransport,b))return f(li("OperationError","Can not add ICE candidate"));var v=c.candidate.trim();v.indexOf("a=")===0&&(v=v.substr(2)),d=re.getMediaSections(h._remoteDescription.sdp),d[g]+="a="+(b.type?v:"end-of-candidates")+`\r
`,h._remoteDescription.sdp=re.getDescription(h._remoteDescription.sdp)+d.join("")}else return f(li("OperationError","Can not add ICE candidate"))}else return f(li("InvalidStateError","Can not add ICE candidate without a remote description"));u()})},o.prototype.getStats=function(c){if(c&&c instanceof s.MediaStreamTrack){var h=null;if(this.transceivers.forEach(function(u){u.rtpSender&&u.rtpSender.track===c?h=u.rtpSender:u.rtpReceiver&&u.rtpReceiver.track===c&&(h=u.rtpReceiver)}),!h)throw li("InvalidAccessError","Invalid selector.");return h.getStats()}var d=[];return this.transceivers.forEach(function(u){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(f){u[f]&&d.push(u[f].getStats())})}),Promise.all(d).then(function(u){var f=new Map;return u.forEach(function(p){p.forEach(function(g){f.set(g.id,g)})}),f})};var r=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];r.forEach(function(c){var h=s[c];if(h&&h.prototype&&h.prototype.getStats){var d=h.prototype.getStats;h.prototype.getStats=function(){return d.apply(this).then(function(u){var f=new Map;return Object.keys(u).forEach(function(p){u[p].type=Sk(u[p]),f.set(p,u[p])}),f})}}});var l=["createOffer","createAnswer"];return l.forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[0]=="function"||typeof d[1]=="function"?h.apply(this,[arguments[2]]).then(function(u){typeof d[0]=="function"&&d[0].apply(null,[u])},function(u){typeof d[1]=="function"&&d[1].apply(null,[u])}):h.apply(this,arguments)}}),l=["setLocalDescription","setRemoteDescription","addIceCandidate"],l.forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[1]=="function"||typeof d[2]=="function"?h.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)},function(u){typeof d[2]=="function"&&d[2].apply(null,[u])}):h.apply(this,arguments)}}),["getStats"].forEach(function(c){var h=o.prototype[c];o.prototype[c]=function(){var d=arguments;return typeof d[1]=="function"?h.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)}):h.apply(this,arguments)}}),o};const Rk=im(Pk);function qS(s){var n;const t=s&&s.navigator,e=function(o){return{name:{PermissionDeniedError:"NotAllowedError"}[o.name]||o.name,message:o.message,constraint:o.constraint,toString(){return this.name}}},i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);(n=Object.getOwnPropertyDescriptor(t.mediaDevices,"getUserMedia"))!=null&&n.writable&&(t.mediaDevices.getUserMedia=function(o){return i(o).catch(r=>Promise.reject(e(r)))})}function XS(s){"getDisplayMedia"in s.navigator&&s.navigator.mediaDevices&&(s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||(s.navigator.mediaDevices.getDisplayMedia=s.navigator.getDisplayMedia.bind(s.navigator)))}function $y(s,t){if(s.RTCIceGatherer&&(s.RTCIceCandidate||(s.RTCIceCandidate=function(n){return n}),s.RTCSessionDescription||(s.RTCSessionDescription=function(n){return n}),t.version<15025)){const i=Object.getOwnPropertyDescriptor(s.MediaStreamTrack.prototype,"enabled");Object.defineProperty(s.MediaStreamTrack.prototype,"enabled",{set(n){i.set.call(this,n);const o=new Event("enabled");o.enabled=n,this.dispatchEvent(o)}})}s.RTCRtpSender&&!("dtmf"in s.RTCRtpSender.prototype)&&Object.defineProperty(s.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=new s.RTCDtmfSender(this):this.track.kind==="video"&&(this._dtmf=null)),this._dtmf}}),s.RTCDtmfSender&&!s.RTCDTMFSender&&(s.RTCDTMFSender=s.RTCDtmfSender);const e=Rk(s,t.version);s.RTCPeerConnection=function(n){return n&&n.iceServers&&(n.iceServers=wk(n.iceServers,t.version),pb("ICE servers after filtering:",n.iceServers)),new e(n)},s.RTCPeerConnection.prototype=e.prototype}function QS(s){s.RTCRtpSender&&!("replaceTrack"in s.RTCRtpSender.prototype)&&(s.RTCRtpSender.prototype.replaceTrack=s.RTCRtpSender.prototype.setTrack)}const wv=Object.freeze(Object.defineProperty({__proto__:null,shimGetDisplayMedia:XS,shimGetUserMedia:qS,shimPeerConnection:$y,shimReplaceTrack:QS},Symbol.toStringTag,{value:"Module"}));function YS(s,t){var n;const e=s&&s.navigator,i=s&&s.MediaStreamTrack;if(e.getUserMedia=function(o,r,l){nm("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(o).then(r,l)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){const o=function(l,c,h){c in l&&!(h in l)&&(l[h]=l[c],delete l[c])},r=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if((n=Object.getOwnPropertyDescriptor(e.mediaDevices,"getUserMedia"))!=null&&n.writable&&(e.mediaDevices.getUserMedia=function(l){return typeof l=="object"&&typeof l.audio=="object"&&(l=JSON.parse(JSON.stringify(l)),o(l.audio,"autoGainControl","mozAutoGainControl"),o(l.audio,"noiseSuppression","mozNoiseSuppression")),r(l)}),i&&i.prototype.getSettings){const l=i.prototype.getSettings;i.prototype.getSettings=function(){const c=l.apply(this,arguments);return o(c,"mozAutoGainControl","autoGainControl"),o(c,"mozNoiseSuppression","noiseSuppression"),c}}if(i&&i.prototype.applyConstraints){const l=i.prototype.applyConstraints;i.prototype.applyConstraints=function(c){return this.kind==="audio"&&typeof c=="object"&&(c=JSON.parse(JSON.stringify(c)),o(c,"autoGainControl","mozAutoGainControl"),o(c,"noiseSuppression","mozNoiseSuppression")),l.apply(this,[c])}}}}function Tk(s,t){s.navigator.mediaDevices&&"getDisplayMedia"in s.navigator.mediaDevices||s.navigator.mediaDevices&&(s.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return i.video===!0?i.video={mediaSource:t}:i.video.mediaSource=t,s.navigator.mediaDevices.getUserMedia(i)})}function KS(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Wy(s,t){if(typeof s!="object"||!(s.RTCPeerConnection||s.mozRTCPeerConnection))return;!s.RTCPeerConnection&&s.mozRTCPeerConnection&&(s.RTCPeerConnection=s.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const o=s.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?s.RTCIceCandidate:s.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};s.RTCPeerConnection.prototype[n]=r[n]});const e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=s.RTCPeerConnection.prototype.getStats;s.RTCPeerConnection.prototype.getStats=function(){const[o,r,l]=arguments;return i.apply(this,[o||null]).then(c=>{if(t.version<53&&!r)try{c.forEach(h=>{h.type=e[h.type]||h.type})}catch(h){if(h.name!=="TypeError")throw h;c.forEach((d,u)=>{c.set(u,Object.assign({},d,{type:e[d.type]||d.type}))})}return c}).then(r,l)}}function JS(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender)||s.RTCRtpSender&&"getStats"in s.RTCRtpSender.prototype)return;const t=s.RTCPeerConnection.prototype.getSenders;t&&(s.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach(o=>o._pc=this),n});const e=s.RTCPeerConnection.prototype.addTrack;e&&(s.RTCPeerConnection.prototype.addTrack=function(){const n=e.apply(this,arguments);return n._pc=this,n}),s.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ZS(s){if(!(typeof s=="object"&&s.RTCPeerConnection&&s.RTCRtpSender)||s.RTCRtpSender&&"getStats"in s.RTCRtpReceiver.prototype)return;const t=s.RTCPeerConnection.prototype.getReceivers;t&&(s.RTCPeerConnection.prototype.getReceivers=function(){const i=t.apply(this,[]);return i.forEach(n=>n._pc=this),i}),jc(s,"track",e=>(e.receiver._pc=e.srcElement,e)),s.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function eC(s){!s.RTCPeerConnection||"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(e){nm("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&e.getTracks().includes(i.track)&&this.removeTrack(i)})})}function tC(s){s.DataChannel&&!s.RTCDataChannel&&(s.RTCDataChannel=s.DataChannel)}function iC(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.addTransceiver;t&&(s.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const i=arguments[1],n=i&&"sendEncodings"in i;n&&i.sendEncodings.forEach(r=>{if("rid"in r&&!/^[a-z0-9]{0,16}$/i.test(r.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in r&&!(parseFloat(r.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in r&&!(parseFloat(r.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const o=t.apply(this,arguments);if(n){const{sender:r}=o,l=r.getParameters();(!("encodings"in l)||l.encodings.length===1&&Object.keys(l.encodings[0]).length===0)&&(l.encodings=i.sendEncodings,r.sendEncodings=i.sendEncodings,this.setParametersPromises.push(r.setParameters(l).then(()=>{delete r.sendEncodings}).catch(()=>{delete r.sendEncodings})))}return o})}function nC(s){if(!(typeof s=="object"&&s.RTCRtpSender))return;const t=s.RTCRtpSender.prototype.getParameters;t&&(s.RTCRtpSender.prototype.getParameters=function(){const i=t.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function sC(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function oC(s){if(!(typeof s=="object"&&s.RTCPeerConnection))return;const t=s.RTCPeerConnection.prototype.createAnswer;s.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}const Sv=Object.freeze(Object.defineProperty({__proto__:null,shimAddTransceiver:iC,shimCreateAnswer:oC,shimCreateOffer:sC,shimGetDisplayMedia:Tk,shimGetParameters:nC,shimGetUserMedia:YS,shimOnTrack:KS,shimPeerConnection:Wy,shimRTCDataChannel:tC,shimReceiverGetStats:ZS,shimRemoveStream:eC,shimSenderGetStats:JS},Symbol.toStringTag,{value:"Module"}));function rC(s){if(!(typeof s!="object"||!s.RTCPeerConnection)){if("getLocalStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in s.RTCPeerConnection.prototype)){const t=s.RTCPeerConnection.prototype.addTrack;s.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(n=>t.call(this,n,i)),i.getVideoTracks().forEach(n=>t.call(this,n,i))},s.RTCPeerConnection.prototype.addTrack=function(i,...n){return n&&n.forEach(o=>{this._localStreams?this._localStreams.includes(o)||this._localStreams.push(o):this._localStreams=[o]}),t.apply(this,arguments)}}"removeStream"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(e);if(i===-1)return;this._localStreams.splice(i,1);const n=e.getTracks();this.getSenders().forEach(o=>{n.includes(o.track)&&this.removeTrack(o)})})}}function aC(s){if(!(typeof s!="object"||!s.RTCPeerConnection)&&("getRemoteStreams"in s.RTCPeerConnection.prototype||(s.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in s.RTCPeerConnection.prototype))){Object.defineProperty(s.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(n=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(n))return;this._remoteStreams.push(n);const o=new Event("addstream");o.stream=n,this.dispatchEvent(o)})})}});const t=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(o=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(o)>=0)return;i._remoteStreams.push(o);const r=new Event("addstream");r.stream=o,i.dispatchEvent(r)})}),t.apply(i,arguments)}}}function lC(s){if(typeof s!="object"||!s.RTCPeerConnection)return;const t=s.RTCPeerConnection.prototype,e=t.createOffer,i=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,r=t.addIceCandidate;t.createOffer=function(h,d){const u=arguments.length>=2?arguments[2]:arguments[0],f=e.apply(this,[u]);return d?(f.then(h,d),Promise.resolve()):f},t.createAnswer=function(h,d){const u=arguments.length>=2?arguments[2]:arguments[0],f=i.apply(this,[u]);return d?(f.then(h,d),Promise.resolve()):f};let l=function(c,h,d){const u=n.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u};t.setLocalDescription=l,l=function(c,h,d){const u=o.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u},t.setRemoteDescription=l,l=function(c,h,d){const u=r.apply(this,[c]);return d?(u.then(h,d),Promise.resolve()):u},t.addIceCandidate=l}function cC(s){const t=s&&s.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=n=>i(hC(n))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(i,n,o){t.mediaDevices.getUserMedia(i).then(n,o)}.bind(t))}function hC(s){return s&&s.video!==void 0?Object.assign({},s,{video:LS(s.video)}):s}function dC(s){if(!s.RTCPeerConnection)return;const t=s.RTCPeerConnection;s.RTCPeerConnection=function(i,n){if(i&&i.iceServers){const o=[];for(let r=0;r<i.iceServers.length;r++){let l=i.iceServers[r];!l.hasOwnProperty("urls")&&l.hasOwnProperty("url")?(nm("RTCIceServer.url","RTCIceServer.urls"),l=JSON.parse(JSON.stringify(l)),l.urls=l.url,delete l.url,o.push(l)):o.push(i.iceServers[r])}i.iceServers=o}return new t(i,n)},s.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(s.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function uC(s){typeof s=="object"&&s.RTCTrackEvent&&"receiver"in s.RTCTrackEvent.prototype&&!("transceiver"in s.RTCTrackEvent.prototype)&&Object.defineProperty(s.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function fC(s){const t=s.RTCPeerConnection.prototype.createOffer;s.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const n=this.getTransceivers().find(r=>r.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):i.offerToReceiveAudio===!0&&!n&&this.addTransceiver("audio"),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const o=this.getTransceivers().find(r=>r.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):i.offerToReceiveVideo===!0&&!o&&this.addTransceiver("video")}return t.apply(this,arguments)}}function pC(s){typeof s!="object"||s.AudioContext||(s.AudioContext=s.webkitAudioContext)}const Cv=Object.freeze(Object.defineProperty({__proto__:null,shimAudioContext:pC,shimCallbacksAPI:lC,shimConstraints:hC,shimCreateOfferLegacy:fC,shimGetUserMedia:cC,shimLocalStreamsAPI:rC,shimRTCIceServerUrls:dC,shimRemoteStreamsAPI:aC,shimTrackEventTransceiver:uC},Symbol.toStringTag,{value:"Module"}));function xf(s){if(!s.RTCIceCandidate||s.RTCIceCandidate&&"foundation"in s.RTCIceCandidate.prototype)return;const t=s.RTCIceCandidate;s.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const n=new t(i),o=vf.parseCandidate(i.candidate),r=Object.assign(n,o);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(i)},s.RTCIceCandidate.prototype=t.prototype,jc(s,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new s.RTCIceCandidate(e.candidate),writable:"false"}),e))}function Uh(s,t){if(!s.RTCPeerConnection)return;"sctp"in s.RTCPeerConnection.prototype||Object.defineProperty(s.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const e=function(l){if(!l||!l.sdp)return!1;const c=vf.splitSections(l.sdp);return c.shift(),c.some(h=>{const d=vf.parseMLine(h);return d&&d.kind==="application"&&d.protocol.indexOf("SCTP")!==-1})},i=function(l){const c=l.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const h=parseInt(c[1],10);return h!==h?-1:h},n=function(l){let c=65536;return t.browser==="firefox"&&(t.version<57?l===-1?c=16384:c=2147483637:t.version<60?c=t.version===57?65535:65536:c=2147483637),c},o=function(l,c){let h=65536;t.browser==="firefox"&&t.version===57&&(h=65535);const d=vf.matchPrefix(l.sdp,"a=max-message-size:");return d.length>0?h=parseInt(d[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(h=2147483637),h},r=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){const c=i(arguments[0]),h=n(c),d=o(arguments[0],c);let u;h===0&&d===0?u=Number.POSITIVE_INFINITY:h===0||d===0?u=Math.max(h,d):u=Math.min(h,d);const f={};Object.defineProperty(f,"maxMessageSize",{get(){return u}}),this._sctp=f}return r.apply(this,arguments)}}function Nh(s){if(!(s.RTCPeerConnection&&"createDataChannel"in s.RTCPeerConnection.prototype))return;function t(i,n){const o=i.send;i.send=function(){const l=arguments[0],c=l.length||l.size||l.byteLength;if(i.readyState==="open"&&n.sctp&&c>n.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)}}const e=s.RTCPeerConnection.prototype.createDataChannel;s.RTCPeerConnection.prototype.createDataChannel=function(){const n=e.apply(this,arguments);return t(n,this),n},jc(s,"datachannel",i=>(t(i.channel,i.target),i))}function Vy(s){if(!s.RTCPeerConnection||"connectionState"in s.RTCPeerConnection.prototype)return;const t=s.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=n=>{const o=n.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const r=new Event("connectionstatechange",n);o.dispatchEvent(r)}return n},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function Hy(s,t){if(!s.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const e=s.RTCPeerConnection.prototype.setRemoteDescription;s.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const o=n.sdp.split(`
`).filter(r=>r.trim()!=="a=extmap-allow-mixed").join(`
`);s.RTCSessionDescription&&n instanceof s.RTCSessionDescription?arguments[0]=new s.RTCSessionDescription({type:n.type,sdp:o}):n.sdp=o}return e.apply(this,arguments)}}function wf(s,t){if(!(s.RTCPeerConnection&&s.RTCPeerConnection.prototype))return;const e=s.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(s.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}const Ok=Object.freeze(Object.defineProperty({__proto__:null,removeExtmapAllowMixed:Hy,shimAddIceCandidateNullOrEmpty:wf,shimConnectionState:Vy,shimMaxMessageSize:Uh,shimRTCIceCandidate:xf,shimSendThrowTypeError:Nh},Symbol.toStringTag,{value:"Module"}));function kk({window:s}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const e=pb,i=vk(s),n={browserDetails:i,commonShim:Ok,extractVersion:zh,disableLog:_k,disableWarnings:bk};switch(i.browser){case"chrome":if(!bv||!Ny||!t.shimChrome)return e("Chrome shim is not included in this adapter release."),n;if(i.version===null)return e("Chrome shim can not determine version, not shimming."),n;e("adapter.js shimming chrome."),n.browserShim=bv,wf(s,i),jS(s,i),BS(s),Ny(s,i),FS(s),WS(s,i),zS(s),US(s),NS(s),VS(s,i),xf(s),Vy(s),Uh(s,i),Nh(s),Hy(s,i);break;case"firefox":if(!Sv||!Wy||!t.shimFirefox)return e("Firefox shim is not included in this adapter release."),n;e("adapter.js shimming firefox."),n.browserShim=Sv,wf(s,i),YS(s,i),Wy(s,i),KS(s),eC(s),JS(s),ZS(s),tC(s),iC(s),nC(s),sC(s),oC(s),xf(s),Vy(s),Uh(s,i),Nh(s);break;case"edge":if(!wv||!$y||!t.shimEdge)return e("MS edge shim is not included in this adapter release."),n;e("adapter.js shimming edge."),n.browserShim=wv,qS(s),XS(s),$y(s,i),QS(s),Uh(s,i),Nh(s);break;case"safari":if(!Cv||!t.shimSafari)return e("Safari shim is not included in this adapter release."),n;e("adapter.js shimming safari."),n.browserShim=Cv,wf(s,i),dC(s),fC(s),lC(s),rC(s),aC(s),uC(s),cC(s),pC(s),xf(s),Uh(s,i),Nh(s),Hy(s,i);break;default:e("Unsupported browser!");break}return n}const Pv=kk({window:typeof window>"u"?void 0:window});function ao(s,t,e,i){Object.defineProperty(s,t,{get:e,set:i,enumerable:!0,configurable:!0})}var Cg=Pv.default||Pv,bh=new(function(){function s(){this.isIOS=["iPad","iPhone","iPod"].includes(navigator.platform),this.supportedBrowsers=["firefox","chrome","safari"],this.minFirefoxVersion=59,this.minChromeVersion=72,this.minSafariVersion=605}return s.prototype.isWebRTCSupported=function(){return typeof RTCPeerConnection<"u"},s.prototype.isBrowserSupported=function(){var t=this.getBrowser(),e=this.getVersion(),i=this.supportedBrowsers.includes(t);return i?t==="chrome"?e>=this.minChromeVersion:t==="firefox"?e>=this.minFirefoxVersion:t==="safari"?!this.isIOS&&e>=this.minSafariVersion:!1:!1},s.prototype.getBrowser=function(){return Cg.browserDetails.browser},s.prototype.getVersion=function(){return Cg.browserDetails.version||0},s.prototype.isUnifiedPlanSupported=function(){var t=this.getBrowser(),e=Cg.browserDetails.version||0;if(t==="chrome"&&e<this.minChromeVersion)return!1;if(t==="firefox"&&e>=this.minFirefoxVersion)return!0;if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;var i,n=!1;try{i=new RTCPeerConnection,i.addTransceiver("audio"),n=!0}catch{}finally{i&&i.close()}return n},s.prototype.toString=function(){return`Supports:
    browser:`.concat(this.getBrowser(),`
    version:`).concat(this.getVersion(),`
    isIOS:`).concat(this.isIOS,`
    isWebRTCSupported:`).concat(this.isWebRTCSupported(),`
    isBrowserSupported:`).concat(this.isBrowserSupported(),`
    isUnifiedPlanSupported:`).concat(this.isUnifiedPlanSupported())},s}()),Rv={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:eu-0.turn.peerjs.com:3478","turn:us-0.turn.peerjs.com:3478"],username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},Ek=function(){function s(){this.CLOUD_HOST="0.peerjs.com",this.CLOUD_PORT=443,this.chunkedBrowsers={Chrome:1,chrome:1},this.chunkedMTU=16300,this.defaultConfig=Rv,this.browser=bh.getBrowser(),this.browserVersion=bh.getVersion(),this.supports=function(){var t={browser:bh.isBrowserSupported(),webRTC:bh.isWebRTCSupported(),audioVideo:!1,data:!1,binaryBlob:!1,reliable:!1};if(!t.webRTC)return t;var e;try{e=new RTCPeerConnection(Rv),t.audioVideo=!0;var i=void 0;try{i=e.createDataChannel("_PEERJSTEST",{ordered:!0}),t.data=!0,t.reliable=!!i.ordered;try{i.binaryType="blob",t.binaryBlob=!bh.isIOS}catch{}}catch{}finally{i&&i.close()}}catch{}finally{e&&e.close()}return t}(),this.pack=mv.pack,this.unpack=mv.unpack,this._dataCount=1}return s.prototype.noop=function(){},s.prototype.validateId=function(t){return!t||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(t)},s.prototype.chunk=function(t){for(var e=[],i=t.size,n=Math.ceil(i/Re.chunkedMTU),o=0,r=0;r<i;){var l=Math.min(i,r+Re.chunkedMTU),c=t.slice(r,l),h={__peerData:this._dataCount,n:o,data:c,total:n};e.push(h),r=l,o++}return this._dataCount++,e},s.prototype.blobToArrayBuffer=function(t,e){var i=new FileReader;return i.onload=function(n){n.target&&e(n.target.result)},i.readAsArrayBuffer(t),i},s.prototype.binaryStringToArrayBuffer=function(t){for(var e=new Uint8Array(t.length),i=0;i<t.length;i++)e[i]=t.charCodeAt(i)&255;return e.buffer},s.prototype.randomToken=function(){return Math.random().toString(36).slice(2)},s.prototype.isSecure=function(){return location.protocol==="https:"},s}(),Re=new Ek,mC={};ao(mC,"Peer",()=>Xy,s=>Xy=s);var tu={},Mk=Object.prototype.hasOwnProperty,Di="~";function Nd(){}Object.create&&(Nd.prototype=Object.create(null),new Nd().__proto__||(Di=!1));function Ak(s,t,e){this.fn=s,this.context=t,this.once=e||!1}function gC(s,t,e,i,n){if(typeof e!="function")throw new TypeError("The listener must be a function");var o=new Ak(e,i||s,n),r=Di?Di+t:t;return s._events[r]?s._events[r].fn?s._events[r]=[s._events[r],o]:s._events[r].push(o):(s._events[r]=o,s._eventsCount++),s}function Sf(s,t){--s._eventsCount===0?s._events=new Nd:delete s._events[t]}function bi(){this._events=new Nd,this._eventsCount=0}bi.prototype.eventNames=function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)Mk.call(e,i)&&t.push(Di?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};bi.prototype.listeners=function(t){var e=Di?Di+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,o=i.length,r=new Array(o);n<o;n++)r[n]=i[n].fn;return r};bi.prototype.listenerCount=function(t){var e=Di?Di+t:t,i=this._events[e];return i?i.fn?1:i.length:0};bi.prototype.emit=function(t,e,i,n,o,r){var l=Di?Di+t:t;if(!this._events[l])return!1;var c=this._events[l],h=arguments.length,d,u;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,n),!0;case 5:return c.fn.call(c.context,e,i,n,o),!0;case 6:return c.fn.call(c.context,e,i,n,o,r),!0}for(u=1,d=new Array(h-1);u<h;u++)d[u-1]=arguments[u];c.fn.apply(c.context,d)}else{var f=c.length,p;for(u=0;u<f;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),h){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,i);break;case 4:c[u].fn.call(c[u].context,e,i,n);break;default:if(!d)for(p=1,d=new Array(h-1);p<h;p++)d[p-1]=arguments[p];c[u].fn.apply(c[u].context,d)}}return!0};bi.prototype.on=function(t,e,i){return gC(this,t,e,i,!1)};bi.prototype.once=function(t,e,i){return gC(this,t,e,i,!0)};bi.prototype.removeListener=function(t,e,i,n){var o=Di?Di+t:t;if(!this._events[o])return this;if(!e)return Sf(this,o),this;var r=this._events[o];if(r.fn)r.fn===e&&(!n||r.once)&&(!i||r.context===i)&&Sf(this,o);else{for(var l=0,c=[],h=r.length;l<h;l++)(r[l].fn!==e||n&&!r[l].once||i&&r[l].context!==i)&&c.push(r[l]);c.length?this._events[o]=c.length===1?c[0]:c:Sf(this,o)}return this};bi.prototype.removeAllListeners=function(t){var e;return t?(e=Di?Di+t:t,this._events[e]&&Sf(this,e)):(this._events=new Nd,this._eventsCount=0),this};bi.prototype.off=bi.prototype.removeListener;bi.prototype.addListener=bi.prototype.on;bi.prefixed=Di;bi.EventEmitter=bi;tu=bi;var Y={};ao(Y,"LogLevel",()=>Wi,s=>Wi=s);ao(Y,"default",()=>Tv,s=>Tv=s);var ga=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},ya=function(s,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,o;i<n;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return s.concat(o||Array.prototype.slice.call(t))},Ik="PeerJS: ",Wi;(function(s){s[s.Disabled=0]="Disabled",s[s.Errors=1]="Errors",s[s.Warnings=2]="Warnings",s[s.All=3]="All"})(Wi||(Wi={}));var Dk=function(){function s(){this._logLevel=Wi.Disabled}return Object.defineProperty(s.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){this._logLevel=t},enumerable:!1,configurable:!0}),s.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=Wi.All&&this._print.apply(this,ya([Wi.All],ga(t),!1))},s.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=Wi.Warnings&&this._print.apply(this,ya([Wi.Warnings],ga(t),!1))},s.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logLevel>=Wi.Errors&&this._print.apply(this,ya([Wi.Errors],ga(t),!1))},s.prototype.setLogFunction=function(t){this._print=t},s.prototype._print=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var n=ya([Ik],ga(e),!1);for(var o in n)n[o]instanceof Error&&(n[o]="("+n[o].name+") "+n[o].message);t>=Wi.All?console.log.apply(console,ya([],ga(n),!1)):t>=Wi.Warnings?console.warn.apply(console,ya(["WARNING"],ga(n),!1)):t>=Wi.Errors&&console.error.apply(console,ya(["ERROR"],ga(n),!1))},s}(),Tv=new Dk,yC={};ao(yC,"Socket",()=>Ov,s=>Ov=s);var ns;(function(s){s.Data="data",s.Media="media"})(ns||(ns={}));var ut;(function(s){s.BrowserIncompatible="browser-incompatible",s.Disconnected="disconnected",s.InvalidID="invalid-id",s.InvalidKey="invalid-key",s.Network="network",s.PeerUnavailable="peer-unavailable",s.SslUnavailable="ssl-unavailable",s.ServerError="server-error",s.SocketError="socket-error",s.SocketClosed="socket-closed",s.UnavailableID="unavailable-id",s.WebRTC="webrtc"})(ut||(ut={}));var Co;(function(s){s.Binary="binary",s.BinaryUTF8="binary-utf8",s.JSON="json"})(Co||(Co={}));var jo;(function(s){s.Message="message",s.Disconnected="disconnected",s.Error="error",s.Close="close"})(jo||(jo={}));var Xt;(function(s){s.Heartbeat="HEARTBEAT",s.Candidate="CANDIDATE",s.Offer="OFFER",s.Answer="ANSWER",s.Open="OPEN",s.Error="ERROR",s.IdTaken="ID-TAKEN",s.InvalidKey="INVALID-KEY",s.Leave="LEAVE",s.Expire="EXPIRE"})(Xt||(Xt={}));var mb={};mb=JSON.parse('{"name":"peerjs","version":"1.4.7","keywords":["peerjs","webrtc","p2p","rtc"],"description":"PeerJS client","homepage":"https://peerjs.com","bugs":{"url":"https://github.com/peers/peerjs/issues"},"repository":{"type":"git","url":"https://github.com/peers/peerjs"},"license":"MIT","contributors":["Michelle Bu <michelle@michellebu.com>","afrokick <devbyru@gmail.com>","ericz <really.ez@gmail.com>","Jairo <kidandcat@gmail.com>","Jonas Gloning <34194370+jonasgloning@users.noreply.github.com>","Jairo Caro-Accino Viciana <jairo@galax.be>","Carlos Caballero <carlos.caballero.gonzalez@gmail.com>","hc <hheennrryy@gmail.com>","Muhammad Asif <capripio@gmail.com>","PrashoonB <prashoonbhattacharjee@gmail.com>","Harsh Bardhan Mishra <47351025+HarshCasper@users.noreply.github.com>","akotynski <aleksanderkotbury@gmail.com>","lmb <i@lmb.io>","Jairooo <jairocaro@msn.com>","Moritz StÃ¼ckler <moritz.stueckler@gmail.com>","Simon <crydotsnakegithub@gmail.com>","Denis Lukov <denismassters@gmail.com>","Philipp Hancke <fippo@andyet.net>","Hans Oksendahl <hansoksendahl@gmail.com>","Jess <jessachandler@gmail.com>","khankuan <khankuan@gmail.com>","DUODVK <kurmanov.work@gmail.com>","XiZhao <kwang1imsa@gmail.com>","Matthias Lohr <matthias@lohr.me>","=frank tree <=frnktrb@googlemail.com>","Andre Eckardt <aeckardt@outlook.com>","Chris Cowan <agentme49@gmail.com>","Alex Chuev <alex@chuev.com>","alxnull <alxnull@e.mail.de>","Yemel Jardi <angel.jardi@gmail.com>","Ben Parnell <benjaminparnell.94@gmail.com>","Benny Lichtner <bennlich@gmail.com>","fresheneesz <bitetrudpublic@gmail.com>","bob.barstead@exaptive.com <bob.barstead@exaptive.com>","chandika <chandika@gmail.com>","emersion <contact@emersion.fr>","Christopher Van <cvan@users.noreply.github.com>","eddieherm <edhermoso@gmail.com>","Eduardo Pinho <enet4mikeenet@gmail.com>","Evandro Zanatta <ezanatta@tray.net.br>","Gardner Bickford <gardner@users.noreply.github.com>","Gian Luca <gianluca.cecchi@cynny.com>","PatrickJS <github@gdi2290.com>","jonnyf <github@jonathanfoss.co.uk>","Hizkia Felix <hizkifw@gmail.com>","Hristo Oskov <hristo.oskov@gmail.com>","Isaac Madwed <i.madwed@gmail.com>","Ilya Konanykhin <ilya.konanykhin@gmail.com>","jasonbarry <jasbarry@me.com>","Jonathan Burke <jonathan.burke.1311@googlemail.com>","Josh Hamit <josh.hamit@gmail.com>","Jordan Austin <jrax86@gmail.com>","Joel Wetzell <jwetzell@yahoo.com>","xizhao <kevin.wang@cloudera.com>","Alberto Torres <kungfoobar@gmail.com>","Jonathan Mayol <mayoljonathan@gmail.com>","Jefferson Felix <me@jsfelix.dev>","Rolf Erik Lekang <me@rolflekang.com>","Kevin Mai-Husan Chia <mhchia@users.noreply.github.com>","Pepijn de Vos <pepijndevos@gmail.com>","JooYoung <qkdlql@naver.com>","Tobias Speicher <rootcommander@gmail.com>","Steve Blaurock <sblaurock@gmail.com>","Kyrylo Shegeda <shegeda@ualberta.ca>","Diwank Singh Tomer <singh@diwank.name>","SoÌˆren Balko <Soeren.Balko@gmail.com>","Arpit Solanki <solankiarpit1997@gmail.com>","Yuki Ito <yuki@gnnk.net>","Artur Zayats <zag2art@gmail.com>"],"funding":{"type":"opencollective","url":"https://opencollective.com/peer"},"collective":{"type":"opencollective","url":"https://opencollective.com/peer"},"files":["dist/*"],"sideEffects":["lib/global.ts","lib/supports.ts"],"main":"dist/bundler.cjs","module":"dist/bundler.mjs","browser-minified":"dist/peerjs.min.js","browser-unminified":"dist/peerjs.js","types":"dist/types.d.ts","engines":{"node":">= 10"},"targets":{"types":{"source":"lib/exports.ts"},"main":{"source":"lib/exports.ts","sourceMap":{"inlineSources":true}},"module":{"source":"lib/exports.ts","includeNodeModules":["eventemitter3"],"sourceMap":{"inlineSources":true}},"browser-minified":{"context":"browser","outputFormat":"global","optimize":true,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"},"browser-unminified":{"context":"browser","outputFormat":"global","optimize":false,"engines":{"browsers":"cover 99%, not dead"},"source":"lib/global.ts"}},"scripts":{"contributors":"git-authors-cli --print=false && prettier --write package.json && git add package.json package-lock.json && git commit -m \\"chore(contributors): update and sort contributors list\\"","check":"tsc --noEmit","watch":"parcel watch","build":"rm -rf dist && parcel build","prepublishOnly":"npm run build","test":"mocha -r ts-node/register -r jsdom-global/register test/**/*.ts","format":"prettier --write .","semantic-release":"semantic-release"},"devDependencies":{"@parcel/config-default":"^2.5.0","@parcel/packager-ts":"^2.5.0","@parcel/transformer-typescript-tsc":"^2.5.0","@parcel/transformer-typescript-types":"^2.5.0","@semantic-release/changelog":"^6.0.1","@semantic-release/git":"^10.0.1","@types/chai":"^4.3.0","@types/mocha":"^9.1.0","@types/node":"^17.0.18","chai":"^4.3.6","git-authors-cli":"^1.0.40","jsdom":"^19.0.0","jsdom-global":"^3.0.2","mocha":"^9.2.0","mock-socket":"8.0.5","parcel":"^2.5.0","parcel-transformer-tsc-sourcemaps":"^1.0.2","prettier":"^2.6.2","semantic-release":"^19.0.2","standard":"^16.0.4","ts-node":"^10.5.0","typescript":"^4.5.5"},"dependencies":{"@swc/helpers":"^0.3.13","eventemitter3":"^4.0.7","peerjs-js-binarypack":"1.0.1","webrtc-adapter":"^7.7.1"}}');var Lk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),jk=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},Bk=function(s,t,e){if(e||arguments.length===2)for(var i=0,n=t.length,o;i<n;i++)(o||!(i in t))&&(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return s.concat(o||Array.prototype.slice.call(t))},Fk=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Ov=function(s){Lk(t,s);function t(e,i,n,o,r,l){l===void 0&&(l=5e3);var c=s.call(this)||this;c.pingInterval=l,c._disconnected=!0,c._messagesQueue=[];var h=e?"wss://":"ws://";return c._baseUrl=h+i+":"+n+o+"peerjs?key="+r,c}return t.prototype.start=function(e,i){var n=this;this._id=e;var o="".concat(this._baseUrl,"&id=").concat(e,"&token=").concat(i);this._socket||!this._disconnected||(this._socket=new WebSocket(o+"&version="+mb.version),this._disconnected=!1,this._socket.onmessage=function(r){var l;try{l=JSON.parse(r.data),Y.default.log("Server message received:",l)}catch{Y.default.log("Invalid server message",r.data);return}n.emit(jo.Message,l)},this._socket.onclose=function(r){n._disconnected||(Y.default.log("Socket closed.",r),n._cleanup(),n._disconnected=!0,n.emit(jo.Disconnected))},this._socket.onopen=function(){n._disconnected||(n._sendQueuedMessages(),Y.default.log("Socket open"),n._scheduleHeartbeat())})},t.prototype._scheduleHeartbeat=function(){var e=this;this._wsPingTimer=setTimeout(function(){e._sendHeartbeat()},this.pingInterval)},t.prototype._sendHeartbeat=function(){if(!this._wsOpen()){Y.default.log("Cannot send heartbeat, because socket closed");return}var e=JSON.stringify({type:Xt.Heartbeat});this._socket.send(e),this._scheduleHeartbeat()},t.prototype._wsOpen=function(){return!!this._socket&&this._socket.readyState===1},t.prototype._sendQueuedMessages=function(){var e,i,n=Bk([],jk(this._messagesQueue),!1);this._messagesQueue=[];try{for(var o=Fk(n),r=o.next();!r.done;r=o.next()){var l=r.value;this.send(l)}}catch(c){e={error:c}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},t.prototype.send=function(e){if(!this._disconnected){if(!this._id){this._messagesQueue.push(e);return}if(!e.type){this.emit(jo.Error,"Invalid message");return}if(this._wsOpen()){var i=JSON.stringify(e);this._socket.send(i)}}},t.prototype.close=function(){this._disconnected||(this._cleanup(),this._disconnected=!0)},t.prototype._cleanup=function(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)},t}(tu.EventEmitter),Gy={};ao(Gy,"MediaConnection",()=>Mv,s=>Mv=s);var gb={};ao(gb,"Negotiator",()=>kv,s=>kv=s);var Gf=function(){return Gf=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},Gf.apply(this,arguments)},Du=function(s,t,e,i){function n(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function l(d){try{h(i.next(d))}catch(u){r(u)}}function c(d){try{h(i.throw(d))}catch(u){r(u)}}function h(d){d.done?o(d.value):n(d.value).then(l,c)}h((i=i.apply(s,t||[])).next())})},Lu=function(s,t){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,n,o,r;return r={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(o=h[0]&2?n.return:h[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,h[1])).done)return o;switch(n=0,o&&(h=[h[0]&2,o.value]),h[0]){case 0:case 1:o=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!o||h[1]>o[0]&&h[1]<o[3])){e.label=h[1];break}if(h[0]===6&&e.label<o[1]){e.label=o[1],o=h;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(h);break}o[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(s,e)}catch(d){h=[6,d],n=0}finally{i=o=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},kv=function(){function s(t){this.connection=t}return s.prototype.startConnection=function(t){var e=this._startPeerConnection();if(this.connection.peerConnection=e,this.connection.type===ns.Media&&t._stream&&this._addTracksToConnection(t._stream,e),t.originator){if(this.connection.type===ns.Data){var i=this.connection,n={ordered:!!t.reliable},o=e.createDataChannel(i.label,n);i.initialize(o)}this._makeOffer()}else this.handleSDP("OFFER",t.sdp)},s.prototype._startPeerConnection=function(){Y.default.log("Creating RTCPeerConnection.");var t=new RTCPeerConnection(this.connection.provider.options.config);return this._setupListeners(t),t},s.prototype._setupListeners=function(t){var e=this,i=this.connection.peer,n=this.connection.connectionId,o=this.connection.type,r=this.connection.provider;Y.default.log("Listening for ICE candidates."),t.onicecandidate=function(l){!l.candidate||!l.candidate.candidate||(Y.default.log("Received ICE candidates for ".concat(i,":"),l.candidate),r.socket.send({type:Xt.Candidate,payload:{candidate:l.candidate,type:o,connectionId:n},dst:i}))},t.oniceconnectionstatechange=function(){switch(t.iceConnectionState){case"failed":Y.default.log("iceConnectionState is failed, closing connections to "+i),e.connection.emit("error",new Error("Negotiation of connection to "+i+" failed.")),e.connection.close();break;case"closed":Y.default.log("iceConnectionState is closed, closing connections to "+i),e.connection.emit("error",new Error("Connection to "+i+" closed.")),e.connection.close();break;case"disconnected":Y.default.log("iceConnectionState changed to disconnected on the connection with "+i);break;case"completed":t.onicecandidate=Re.noop;break}e.connection.emit("iceStateChanged",t.iceConnectionState)},Y.default.log("Listening for data channel"),t.ondatachannel=function(l){Y.default.log("Received data channel");var c=l.channel,h=r.getConnection(i,n);h.initialize(c)},Y.default.log("Listening for remote stream"),t.ontrack=function(l){Y.default.log("Received remote stream");var c=l.streams[0],h=r.getConnection(i,n);if(h.type===ns.Media){var d=h;e._addStreamToMediaConnection(c,d)}}},s.prototype.cleanup=function(){Y.default.log("Cleaning up PeerConnection to "+this.connection.peer);var t=this.connection.peerConnection;if(t){this.connection.peerConnection=null,t.onicecandidate=t.oniceconnectionstatechange=t.ondatachannel=t.ontrack=function(){};var e=t.signalingState!=="closed",i=!1;if(this.connection.type===ns.Data){var n=this.connection,o=n.dataChannel;o&&(i=!!o.readyState&&o.readyState!=="closed")}(e||i)&&t.close()}},s.prototype._makeOffer=function(){return Du(this,void 0,Promise,function(){var t,e,i,n,o,r,l;return Lu(this,function(c){switch(c.label){case 0:t=this.connection.peerConnection,e=this.connection.provider,c.label=1;case 1:return c.trys.push([1,7,,8]),[4,t.createOffer(this.connection.options.constraints)];case 2:i=c.sent(),Y.default.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,t.setLocalDescription(i)];case 4:return c.sent(),Y.default.log("Set localDescription:",i,"for:".concat(this.connection.peer)),n={sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata,browser:Re.browser},this.connection.type===ns.Data&&(o=this.connection,n=Gf(Gf({},n),{label:o.label,reliable:o.reliable,serialization:o.serialization})),e.socket.send({type:Xt.Offer,payload:n,dst:this.connection.peer}),[3,6];case 5:return r=c.sent(),r!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(e.emitError(ut.WebRTC,r),Y.default.log("Failed to setLocalDescription, ",r)),[3,6];case 6:return[3,8];case 7:return l=c.sent(),e.emitError(ut.WebRTC,l),Y.default.log("Failed to createOffer, ",l),[3,8];case 8:return[2]}})})},s.prototype._makeAnswer=function(){return Du(this,void 0,Promise,function(){var t,e,i,n,o;return Lu(this,function(r){switch(r.label){case 0:t=this.connection.peerConnection,e=this.connection.provider,r.label=1;case 1:return r.trys.push([1,7,,8]),[4,t.createAnswer()];case 2:i=r.sent(),Y.default.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp),r.label=3;case 3:return r.trys.push([3,5,,6]),[4,t.setLocalDescription(i)];case 4:return r.sent(),Y.default.log("Set localDescription:",i,"for:".concat(this.connection.peer)),e.socket.send({type:Xt.Answer,payload:{sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,browser:Re.browser},dst:this.connection.peer}),[3,6];case 5:return n=r.sent(),e.emitError(ut.WebRTC,n),Y.default.log("Failed to setLocalDescription, ",n),[3,6];case 6:return[3,8];case 7:return o=r.sent(),e.emitError(ut.WebRTC,o),Y.default.log("Failed to create answer, ",o),[3,8];case 8:return[2]}})})},s.prototype.handleSDP=function(t,e){return Du(this,void 0,Promise,function(){var i,n,o,r;return Lu(this,function(l){switch(l.label){case 0:e=new RTCSessionDescription(e),i=this.connection.peerConnection,n=this.connection.provider,Y.default.log("Setting remote description",e),o=this,l.label=1;case 1:return l.trys.push([1,5,,6]),[4,i.setRemoteDescription(e)];case 2:return l.sent(),Y.default.log("Set remoteDescription:".concat(t," for:").concat(this.connection.peer)),t!=="OFFER"?[3,4]:[4,o._makeAnswer()];case 3:l.sent(),l.label=4;case 4:return[3,6];case 5:return r=l.sent(),n.emitError(ut.WebRTC,r),Y.default.log("Failed to setRemoteDescription, ",r),[3,6];case 6:return[2]}})})},s.prototype.handleCandidate=function(t){return Du(this,void 0,Promise,function(){var e,i,n,o,r,l;return Lu(this,function(c){switch(c.label){case 0:Y.default.log("handleCandidate:",t),e=t.candidate,i=t.sdpMLineIndex,n=t.sdpMid,o=this.connection.peerConnection,r=this.connection.provider,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,o.addIceCandidate(new RTCIceCandidate({sdpMid:n,sdpMLineIndex:i,candidate:e}))];case 2:return c.sent(),Y.default.log("Added ICE candidate for:".concat(this.connection.peer)),[3,4];case 3:return l=c.sent(),r.emitError(ut.WebRTC,l),Y.default.log("Failed to handleCandidate, ",l),[3,4];case 4:return[2]}})})},s.prototype._addTracksToConnection=function(t,e){if(Y.default.log("add tracks from stream ".concat(t.id," to peer connection")),!e.addTrack)return Y.default.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");t.getTracks().forEach(function(i){e.addTrack(i,t)})},s.prototype._addStreamToMediaConnection=function(t,e){Y.default.log("add stream ".concat(t.id," to media connection ").concat(e.connectionId)),e.addStream(t)},s}(),yb={};ao(yb,"BaseConnection",()=>Ev,s=>Ev=s);var zk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Ev=function(s){zk(t,s);function t(e,i,n){var o=s.call(this)||this;return o.peer=e,o.provider=i,o.options=n,o._open=!1,o.metadata=n.metadata,o}return Object.defineProperty(t.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),t}(tu.EventEmitter),Uk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),qf=function(){return qf=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},qf.apply(this,arguments)},Nk=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Mv=function(s){Uk(t,s);function t(e,i,n){var o=s.call(this,e,i,n)||this;return o._localStream=o.options._stream,o.connectionId=o.options.connectionId||t.ID_PREFIX+Re.randomToken(),o._negotiator=new gb.Negotiator(o),o._localStream&&o._negotiator.startConnection({_stream:o._localStream,originator:!0}),o}return Object.defineProperty(t.prototype,"type",{get:function(){return ns.Media},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"localStream",{get:function(){return this._localStream},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"remoteStream",{get:function(){return this._remoteStream},enumerable:!1,configurable:!0}),t.prototype.addStream=function(e){Y.default.log("Receiving stream",e),this._remoteStream=e,s.prototype.emit.call(this,"stream",e)},t.prototype.handleMessage=function(e){var i=e.type,n=e.payload;switch(e.type){case Xt.Answer:this._negotiator.handleSDP(i,n.sdp),this._open=!0;break;case Xt.Candidate:this._negotiator.handleCandidate(n.candidate);break;default:Y.default.warn("Unrecognized message type:".concat(i," from peer:").concat(this.peer));break}},t.prototype.answer=function(e,i){var n,o;if(i===void 0&&(i={}),this._localStream){Y.default.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=e,i&&i.sdpTransform&&(this.options.sdpTransform=i.sdpTransform),this._negotiator.startConnection(qf(qf({},this.options._payload),{_stream:e}));var r=this.provider._getMessages(this.connectionId);try{for(var l=Nk(r),c=l.next();!c.done;c=l.next()){var h=c.value;this.handleMessage(h)}}catch(d){n={error:d}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}this._open=!0},t.prototype.close=function(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,s.prototype.emit.call(this,"close"))},t.ID_PREFIX="mc_",t}(yb.BaseConnection),qy={};ao(qy,"DataConnection",()=>Iv,s=>Iv=s);var _C={};ao(_C,"EncodingQueue",()=>Av,s=>Av=s);var $k=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Av=function(s){$k(t,s);function t(){var e=s.call(this)||this;return e.fileReader=new FileReader,e._queue=[],e._processing=!1,e.fileReader.onload=function(i){e._processing=!1,i.target&&e.emit("done",i.target.result),e.doNextTask()},e.fileReader.onerror=function(i){Y.default.error("EncodingQueue error:",i),e._processing=!1,e.destroy(),e.emit("error",i)},e}return Object.defineProperty(t.prototype,"queue",{get:function(){return this._queue},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this.queue.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"processing",{get:function(){return this._processing},enumerable:!1,configurable:!0}),t.prototype.enque=function(e){this.queue.push(e),!this.processing&&this.doNextTask()},t.prototype.destroy=function(){this.fileReader.abort(),this._queue=[]},t.prototype.doNextTask=function(){this.size!==0&&(this.processing||(this._processing=!0,this.fileReader.readAsArrayBuffer(this.queue.shift())))},t}(tu.EventEmitter),Wk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Vk=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Iv=function(s){Wk(t,s);function t(e,i,n){var o=s.call(this,e,i,n)||this;return o.stringify=JSON.stringify,o.parse=JSON.parse,o._buffer=[],o._bufferSize=0,o._buffering=!1,o._chunkedData={},o._encodingQueue=new _C.EncodingQueue,o.connectionId=o.options.connectionId||t.ID_PREFIX+Re.randomToken(),o.label=o.options.label||o.connectionId,o.serialization=o.options.serialization||Co.Binary,o.reliable=!!o.options.reliable,o._encodingQueue.on("done",function(r){o._bufferedSend(r)}),o._encodingQueue.on("error",function(){Y.default.error("DC#".concat(o.connectionId,": Error occured in encoding from blob to arraybuffer, close DC")),o.close()}),o._negotiator=new gb.Negotiator(o),o._negotiator.startConnection(o.options._payload||{originator:!0}),o}return Object.defineProperty(t.prototype,"type",{get:function(){return ns.Data},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dataChannel",{get:function(){return this._dc},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bufferSize",{get:function(){return this._bufferSize},enumerable:!1,configurable:!0}),t.prototype.initialize=function(e){this._dc=e,this._configureDataChannel()},t.prototype._configureDataChannel=function(){var e=this;(!Re.supports.binaryBlob||Re.supports.reliable)&&(this.dataChannel.binaryType="arraybuffer"),this.dataChannel.onopen=function(){Y.default.log("DC#".concat(e.connectionId," dc connection success")),e._open=!0,e.emit("open")},this.dataChannel.onmessage=function(i){Y.default.log("DC#".concat(e.connectionId," dc onmessage:"),i.data),e._handleDataMessage(i)},this.dataChannel.onclose=function(){Y.default.log("DC#".concat(e.connectionId," dc closed for:"),e.peer),e.close()}},t.prototype._handleDataMessage=function(e){var i=this,n=e.data,o=n.constructor,r=this.serialization===Co.Binary||this.serialization===Co.BinaryUTF8,l=n;if(r){if(o===Blob){Re.blobToArrayBuffer(n,function(h){var d=Re.unpack(h);i.emit("data",d)});return}else if(o===ArrayBuffer)l=Re.unpack(n);else if(o===String){var c=Re.binaryStringToArrayBuffer(n);l=Re.unpack(c)}}else this.serialization===Co.JSON&&(l=this.parse(n));if(l.__peerData){this._handleChunk(l);return}s.prototype.emit.call(this,"data",l)},t.prototype._handleChunk=function(e){var i=e.__peerData,n=this._chunkedData[i]||{data:[],count:0,total:e.total};if(n.data[e.n]=e.data,n.count++,this._chunkedData[i]=n,n.total===n.count){delete this._chunkedData[i];var o=new Blob(n.data);this._handleDataMessage({data:o})}},t.prototype.close=function(){this._buffer=[],this._bufferSize=0,this._chunkedData={},this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this._dc=null),this._encodingQueue&&(this._encodingQueue.destroy(),this._encodingQueue.removeAllListeners(),this._encodingQueue=null),this.open&&(this._open=!1,s.prototype.emit.call(this,"close"))},t.prototype.send=function(e,i){if(!this.open){s.prototype.emit.call(this,"error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));return}if(this.serialization===Co.JSON)this._bufferedSend(this.stringify(e));else if(this.serialization===Co.Binary||this.serialization===Co.BinaryUTF8){var n=Re.pack(e);if(!i&&n.size>Re.chunkedMTU){this._sendChunks(n);return}Re.supports.binaryBlob?this._bufferedSend(n):this._encodingQueue.enque(n)}else this._bufferedSend(e)},t.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this._bufferSize=this._buffer.length)},t.prototype._trySend=function(e){var i=this;if(!this.open)return!1;if(this.dataChannel.bufferedAmount>t.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(function(){i._buffering=!1,i._tryBuffer()},50),!1;try{this.dataChannel.send(e)}catch(n){return Y.default.error("DC#:".concat(this.connectionId," Error when sending:"),n),this._buffering=!0,this.close(),!1}return!0},t.prototype._tryBuffer=function(){if(this.open&&this._buffer.length!==0){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}},t.prototype._sendChunks=function(e){var i,n,o=Re.chunk(e);Y.default.log("DC#".concat(this.connectionId," Try to send ").concat(o.length," chunks..."));try{for(var r=Vk(o),l=r.next();!l.done;l=r.next()){var c=l.value;this.send(c,!0)}}catch(h){i={error:h}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}},t.prototype.handleMessage=function(e){var i=e.payload;switch(e.type){case Xt.Answer:this._negotiator.handleSDP(e.type,i.sdp);break;case Xt.Candidate:this._negotiator.handleCandidate(i.candidate);break;default:Y.default.warn("Unrecognized message type:",e.type,"from peer:",this.peer);break}},t.ID_PREFIX="dc_",t.MAX_BUFFERED_AMOUNT=8388608,t}(yb.BaseConnection),bC={};ao(bC,"API",()=>jv,s=>jv=s);var Dv=function(s,t,e,i){function n(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function l(d){try{h(i.next(d))}catch(u){r(u)}}function c(d){try{h(i.throw(d))}catch(u){r(u)}}function h(d){d.done?o(d.value):n(d.value).then(l,c)}h((i=i.apply(s,t||[])).next())})},Lv=function(s,t){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,n,o,r;return r={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function l(h){return function(d){return c([h,d])}}function c(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,n&&(o=h[0]&2?n.return:h[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,h[1])).done)return o;switch(n=0,o&&(h=[h[0]&2,o.value]),h[0]){case 0:case 1:o=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,n=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!o||h[1]>o[0]&&h[1]<o[3])){e.label=h[1];break}if(h[0]===6&&e.label<o[1]){e.label=o[1],o=h;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(h);break}o[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(s,e)}catch(d){h=[6,d],n=0}finally{i=o=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}},jv=function(){function s(t){this._options=t}return s.prototype._buildRequest=function(t){var e=this._options.secure?"https":"http",i=this._options,n=i.host,o=i.port,r=i.path,l=i.key,c=new URL("".concat(e,"://").concat(n,":").concat(o).concat(r).concat(l,"/").concat(t));return c.searchParams.set("ts","".concat(Date.now()).concat(Math.random())),c.searchParams.set("version",mb.version),fetch(c.href,{referrerPolicy:this._options.referrerPolicy})},s.prototype.retrieveId=function(){return Dv(this,void 0,Promise,function(){var t,e,i;return Lv(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("id")];case 1:if(t=n.sent(),t.status!==200)throw new Error("Error. Status:".concat(t.status));return[2,t.text()];case 2:throw e=n.sent(),Y.default.error("Error retrieving ID",e),i="",this._options.path==="/"&&this._options.host!==Re.CLOUD_HOST&&(i=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+i);case 3:return[2]}})})},s.prototype.listAllPeers=function(){return Dv(this,void 0,Promise,function(){var t,e,i;return Lv(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this._buildRequest("peers")];case 1:if(t=n.sent(),t.status!==200)throw t.status===401?(e="",this._options.host===Re.CLOUD_HOST?e="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":e="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+e)):new Error("Error. Status:".concat(t.status));return[2,t.json()];case 2:throw i=n.sent(),Y.default.error("Error retrieving list peers",i),new Error("Could not get list peers from the server."+i);case 3:return[2]}})})},s}(),Hk=function(){var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])},s(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");s(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Kh=function(){return Kh=Object.assign||function(s){for(var t,e=1,i=arguments.length;e<i;e++){t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},Kh.apply(this,arguments)},vh=function(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],i=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Gk=function(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var i=e.call(s),n,o=[],r;try{for(;(t===void 0||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(l){r={error:l}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return o},Xy=function(s){Hk(t,s);function t(e,i){var n=s.call(this)||this;n._id=null,n._lastServerId=null,n._destroyed=!1,n._disconnected=!1,n._open=!1,n._connections=new Map,n._lostMessages=new Map;var o;return e&&e.constructor==Object?i=e:e&&(o=e.toString()),i=Kh({debug:0,host:Re.CLOUD_HOST,port:Re.CLOUD_PORT,path:"/",key:t.DEFAULT_KEY,token:Re.randomToken(),config:Re.defaultConfig,referrerPolicy:"strict-origin-when-cross-origin"},i),n._options=i,n._options.host==="/"&&(n._options.host=window.location.hostname),n._options.path&&(n._options.path[0]!=="/"&&(n._options.path="/"+n._options.path),n._options.path[n._options.path.length-1]!=="/"&&(n._options.path+="/")),n._options.secure===void 0&&n._options.host!==Re.CLOUD_HOST?n._options.secure=Re.isSecure():n._options.host==Re.CLOUD_HOST&&(n._options.secure=!0),n._options.logFunction&&Y.default.setLogFunction(n._options.logFunction),Y.default.logLevel=n._options.debug||0,n._api=new bC.API(i),n._socket=n._createServerConnection(),!Re.supports.audioVideo&&!Re.supports.data?(n._delayedAbort(ut.BrowserIncompatible,"The current browser does not support WebRTC"),n):o&&!Re.validateId(o)?(n._delayedAbort(ut.InvalidID,'ID "'.concat(o,'" is invalid')),n):(o?n._initialize(o):n._api.retrieveId().then(function(r){return n._initialize(r)}).catch(function(r){return n._abort(ut.ServerError,r)}),n)}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"open",{get:function(){return this._open},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"socket",{get:function(){return this._socket},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"connections",{get:function(){var e,i,n=Object.create(null);try{for(var o=vh(this._connections),r=o.next();!r.done;r=o.next()){var l=Gk(r.value,2),c=l[0],h=l[1];n[c]=h}}catch(d){e={error:d}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}return n},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"disconnected",{get:function(){return this._disconnected},enumerable:!1,configurable:!0}),t.prototype._createServerConnection=function(){var e=this,i=new yC.Socket(this._options.secure,this._options.host,this._options.port,this._options.path,this._options.key,this._options.pingInterval);return i.on(jo.Message,function(n){e._handleMessage(n)}),i.on(jo.Error,function(n){e._abort(ut.SocketError,n)}),i.on(jo.Disconnected,function(){e.disconnected||(e.emitError(ut.Network,"Lost connection to server."),e.disconnect())}),i.on(jo.Close,function(){e.disconnected||e._abort(ut.SocketClosed,"Underlying socket is already closed.")}),i},t.prototype._initialize=function(e){this._id=e,this.socket.start(e,this._options.token)},t.prototype._handleMessage=function(e){var i,n,o=e.type,r=e.payload,l=e.src;switch(o){case Xt.Open:this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case Xt.Error:this._abort(ut.ServerError,r.msg);break;case Xt.IdTaken:this._abort(ut.UnavailableID,'ID "'.concat(this.id,'" is taken'));break;case Xt.InvalidKey:this._abort(ut.InvalidKey,'API KEY "'.concat(this._options.key,'" is invalid'));break;case Xt.Leave:Y.default.log("Received leave message from ".concat(l)),this._cleanupPeer(l),this._connections.delete(l);break;case Xt.Expire:this.emitError(ut.PeerUnavailable,"Could not connect to peer ".concat(l));break;case Xt.Offer:var g=r.connectionId,_=this.getConnection(l,g);if(_&&(_.close(),Y.default.warn("Offer received for existing Connection ID:".concat(g))),r.type===ns.Media){var c=new Gy.MediaConnection(l,this,{connectionId:g,_payload:r,metadata:r.metadata});_=c,this._addConnection(l,_),this.emit("call",c)}else if(r.type===ns.Data){var h=new qy.DataConnection(l,this,{connectionId:g,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable});_=h,this._addConnection(l,_),this.emit("connection",h)}else{Y.default.warn("Received malformed connection type:".concat(r.type));return}var d=this._getMessages(g);try{for(var u=vh(d),f=u.next();!f.done;f=u.next()){var p=f.value;_.handleMessage(p)}}catch(y){i={error:y}}finally{try{f&&!f.done&&(n=u.return)&&n.call(u)}finally{if(i)throw i.error}}break;default:if(!r){Y.default.warn("You received a malformed message from ".concat(l," of type ").concat(o));return}var g=r.connectionId,_=this.getConnection(l,g);_&&_.peerConnection?_.handleMessage(e):g?this._storeMessage(g,e):Y.default.warn("You received an unrecognized message:",e);break}},t.prototype._storeMessage=function(e,i){this._lostMessages.has(e)||this._lostMessages.set(e,[]),this._lostMessages.get(e).push(i)},t.prototype._getMessages=function(e){var i=this._lostMessages.get(e);return i?(this._lostMessages.delete(e),i):[]},t.prototype.connect=function(e,i){if(i===void 0&&(i={}),this.disconnected){Y.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError(ut.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}var n=new qy.DataConnection(e,this,i);return this._addConnection(e,n),n},t.prototype.call=function(e,i,n){if(n===void 0&&(n={}),this.disconnected){Y.default.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError(ut.Disconnected,"Cannot connect to new Peer after disconnecting from server.");return}if(!i){Y.default.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}var o=new Gy.MediaConnection(e,this,Kh(Kh({},n),{_stream:i}));return this._addConnection(e,o),o},t.prototype._addConnection=function(e,i){Y.default.log("add connection ".concat(i.type,":").concat(i.connectionId," to peerId:").concat(e)),this._connections.has(e)||this._connections.set(e,[]),this._connections.get(e).push(i)},t.prototype._removeConnection=function(e){var i=this._connections.get(e.peer);if(i){var n=i.indexOf(e);n!==-1&&i.splice(n,1)}this._lostMessages.delete(e.connectionId)},t.prototype.getConnection=function(e,i){var n,o,r=this._connections.get(e);if(!r)return null;try{for(var l=vh(r),c=l.next();!c.done;c=l.next()){var h=c.value;if(h.connectionId===i)return h}}catch(d){n={error:d}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}return null},t.prototype._delayedAbort=function(e,i){var n=this;setTimeout(function(){n._abort(e,i)},0)},t.prototype._abort=function(e,i){Y.default.error("Aborting!"),this.emitError(e,i),this._lastServerId?this.disconnect():this.destroy()},t.prototype.emitError=function(e,i){Y.default.error("Error:",i);var n;typeof i=="string"?n=new Error(i):n=i,n.type=e,this.emit("error",n)},t.prototype.destroy=function(){this.destroyed||(Y.default.log("Destroy peer with ID:".concat(this.id)),this.disconnect(),this._cleanup(),this._destroyed=!0,this.emit("close"))},t.prototype._cleanup=function(){var e,i;try{for(var n=vh(this._connections.keys()),o=n.next();!o.done;o=n.next()){var r=o.value;this._cleanupPeer(r),this._connections.delete(r)}}catch(l){e={error:l}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}this.socket.removeAllListeners()},t.prototype._cleanupPeer=function(e){var i,n,o=this._connections.get(e);if(o)try{for(var r=vh(o),l=r.next();!l.done;l=r.next()){var c=l.value;c.close()}}catch(h){i={error:h}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}},t.prototype.disconnect=function(){if(!this.disconnected){var e=this.id;Y.default.log("Disconnect peer with ID:".concat(e)),this._disconnected=!0,this._open=!1,this.socket.close(),this._lastServerId=e,this._id=null,this.emit("disconnected",e)}},t.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)Y.default.log("Attempting reconnection to server with ID ".concat(this._lastServerId)),this._disconnected=!1,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)Y.default.error("In a hurry? We're still trying to make the initial connection!");else throw new Error("Peer ".concat(this.id," cannot reconnect because it is not disconnected from the server!"))}},t.prototype.listAllPeers=function(e){var i=this;e===void 0&&(e=function(n){}),this._api.listAllPeers().then(function(n){return e(n)}).catch(function(n){return i._abort(ut.ServerError,n)})},t.DEFAULT_KEY="peerjs",t}(tu.EventEmitter),Qy=mC.Peer;const qk=Object.freeze(Object.defineProperty({__proto__:null,get Peer(){return Xy},default:Qy,util:Re},Symbol.toStringTag,{value:"Module"}));let _b;function p3(){return _b}function m3(s){_b=s}function Xk(s,t){return t||(t={}),t={..._b,...t},s?new Qy(s,t):new Qy(t)}async function Bv(){const s=await rs(()=>Promise.resolve().then(()=>qk),void 0,import.meta.url);return console.log(s),s.default===void 0?s:s.default}var Yy;(function(s){s.ConnectionList="connection-list"})(Yy||(Yy={}));class Qk{constructor(){a(this,"_host");a(this,"_client");a(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const t="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(t)}async trySetupHost(t){const e=await Bv(),i=new e(t);i.on("error",n=>{console.error(n),this._host=void 0,this.trySetupClient(t)}),i.on("open",n=>{this._host=new Kk(i)})}async trySetupClient(t){const e=await Bv();this._client=new e,this._client.on("error",i=>{console.error("Client error",i)}),this._client.on("open",i=>{console.log("client connected",i),this._clientData=this._client.connect(t,{metadata:{id:i}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",n=>{console.log("<<",n)})})}}class Yk{constructor(t){a(this,"_peer");this._peer=t}}class Kk extends Yk{constructor(e){var i;super(e);a(this,"_connections",[]);console.log("I AM THE HOST"),(i=this._peer)==null||i.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(e){console.log("host connection",e),e.on("open",()=>{this._connections.push(e),this.broadcastConnection(e)})}broadcastConnection(e){const i=this._connections.map(n=>{var o;return(o=n.metadata)==null?void 0:o.id}).filter(n=>n!==void 0);this.broadcast({type:Yy.ConnectionList,connections:i})}broadcast(e){if(e!=null){console.log(">>",e);for(const i in this._peer.connections){const n=this._peer.connections[i];if(n)if(Array.isArray(n))for(const o of n)o&&o.send(e);else console.warn(n)}}}}var es;(function(s){s[s.OnConnection=0]="OnConnection",s[s.OnRoomJoin=1]="OnRoomJoin",s[s.Queued=2]="Queued",s[s.Immediate=3]="Immediate"})(es||(es={}));const Fv="https://urls.needle.tools/default-networking-backend/index";let zi="wss://networking.needle.tools/socket";const sn=!!S("debugnet"),ju=!!(sn||S("debugowner")),Bu=S("debugnetbin");var Ky;(function(s){s.ConnectionInfo="connection-start-info"})(Ky||(Ky={}));var se;(function(s){s.Join="join-room",s.Leave="leave-room",s.JoinedRoom="joined-room",s.LeftRoom="left-room",s.UserJoinedRoom="user-joined-room",s.UserLeftRoom="user-left-room",s.RoomStateSent="room-state-sent"})(se||(se={}));class g3{constructor(){a(this,"room");a(this,"viewId");a(this,"allowEditing");a(this,"inRoom")}}class y3{constructor(){a(this,"room")}}class _3{constructor(){a(this,"userId")}}var hi;(function(s){s.RequestHasOwner="request-has-owner",s.ResponseHasOwner="response-has-owner",s.RequestIsOwner="request-is-owner",s.ResponseIsOwner="response-is-owner",s.RequestOwnership="request-ownership",s.GainedOwnership="gained-ownership",s.RemoveOwnership="remove-ownership",s.LostOwnership="lost-ownership",s.GainedOwnershipBroadcast="gained-ownership-broadcast",s.LostOwnershipBroadcast="lost-ownership-broadcast"})(hi||(hi={}));class vC{constructor(t,e){a(this,"guid");a(this,"connection");a(this,"_hasOwnership",!1);a(this,"_isOwned");a(this,"_gainSubscription");a(this,"_lostSubscription");a(this,"_hasOwnerResponse");a(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=t,this.guid=e,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),t.beginListen(hi.LostOwnership,this._lostSubscription),t.beginListen(hi.GainedOwnershipBroadcast,this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),t.beginListen(hi.ResponseHasOwner,this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send(hi.RequestHasOwner,{guid:this.guid})}onHasOwnerResponse(t){t.guid===this.guid&&(this._isOwned=t.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen(hi.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this.connection.send(hi.RequestHasOwner,{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(t){t.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen(hi.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=t.value,t.value||(ju&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((t,e)=>{this.requestOwnership();let i=0;const n=()=>{if(i++>10)return e("Timeout");setTimeout(()=>{this.hasOwnership?t(this):n()},100)};n()})}requestOwnership(){return ju&&console.log("Request ownership",this.guid),this.connection.send(hi.RequestOwnership,{guid:this.guid}),this}freeOwnership(){return this.connection.send(hi.RemoveOwnership,{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen(hi.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListen(hi.GainedOwnership,this._gainSubscription),this.connection.stopListen(hi.LostOwnership,this._lostSubscription),this.connection.stopListen(hi.ResponseHasOwner,this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListen(hi.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(t){t.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===t.owner?(ju&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(t){t===this.guid&&(ju&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}class Jk{constructor(t){a(this,"context");a(this,"_peer",null);a(this,"_usersInRoomCopy",[]);a(this,"_defaultMessagesBuffer",[]);a(this,"_defaultMessagesBufferArray",[]);a(this,"netWebSocketUrlProvider");a(this,"_listeners",{});a(this,"_listenersBinary",{});a(this,"connected",!1);a(this,"channelId");a(this,"_connectionId",null);a(this,"_ws");a(this,"_waitingForSocket",{});a(this,"_isInRoom",!1);a(this,"_currentRoomName",null);a(this,"_currentRoomViewId",null);a(this,"_currentRoomAllowEditing",!0);a(this,"_currentInRoom",[]);a(this,"_state",{});a(this,"_currentDelay",-1);a(this,"_connectingToWebsocketPromise",null);this.context=t}get peer(){return this._peer||(this._peer=new Qk),this._peer}tryGetState(t){return t==="invalid"?null:this._state[t]}get connectionId(){return this._connectionId}get isDebugEnabled(){return sn}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}getViewOnlyUrl(){if(this.currentRoomViewId===null)return null;const t=new URL(window.location.href);return t.searchParams.set("view",this.currentRoomViewId),t.href}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}get currentServerUrl(){var t;return((t=this._ws)==null?void 0:t.url)??null}sendPing(){this.send("ping",{time:this.context.time.time})}userIsInRoom(t){return this._currentInRoom.indexOf(t)!==-1}usersInRoom(t=null){t||(t=this._usersInRoomCopy),t.length=0;for(const e of this._currentInRoom)t.push(e);return t}joinRoom(t,e=!1){return t?t.length>1024?(console.error('Room name too long, can not join: "'+t+'". Max length is 1024 characters.'),!1):(this.isInRoom&&this.currentRoomName!==t&&console.warn("Needle Engine is already connected to a networking room. Connecting to multiple rooms is not supported"),this.connect(),sn&&console.log("join: "+t),this.send(se.Join,{room:t,viewOnly:e},es.OnConnection),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}leaveRoom(t=null){return t||(t=this.currentRoomName),t?(this.send(se.Leave,{room:t}),!0):(console.error('Missing room name, can not join: "'+t+'"'),!1)}send(t,e=null,i=es.Queued){if(e===null&&(e={}),i===es.Queued){this._defaultMessagesBuffer.push({key:t,value:e});return}return this.sendWithWebsocket(t,e,i)}sendDeleteRemoteState(t){this.send("delete-state",{guid:t,dontSave:!0}),delete this._state[t]}sendDeleteRemoteStateAll(){this.send("delete-all-state"),this._state={}}sendBinary(t){var e;Bu&&console.log("<< send binary",this.context.time.frame,t.length/1024+" KB"),(e=this._ws)==null||e.send(t)}sendBufferedMessagesNow(){var i;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const t=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(t<=1){this.sendWithWebsocket(o.key,o.value,es.Immediate);break}const r=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(r)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&sn&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const e=JSON.stringify(this._defaultMessagesBufferArray);(i=this._ws)==null||i.send(e)}beginListen(t,e){return this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),e}stopListening(t,e){return this.stopListen(t,e)}stopListen(t,e){if(!e||!this._listeners[t])return;const i=this._listeners[t].indexOf(e);i>=0&&this._listeners[t].splice(i,1)}beginListenBinary(t,e){return this._listenersBinary[t]||(this._listenersBinary[t]=[]),this._listenersBinary[t].push(e),e}stopListenBinary(t,e){if(!this._listenersBinary[t])return;const i=this._listenersBinary[t].indexOf(e);i>=0&&this._listenersBinary[t].splice(i,1)}registerProvider(t){this.netWebSocketUrlProvider=t}async connect(t){var i;if(this.connected&&t&&t!==zi)return Promise.reject("Can not connect to different server url. Please disconnect first.");if(this.connected)return Promise.resolve(!0);t&&console.debug("Connecting to user provided url "+t);const e=t||((i=this.netWebSocketUrlProvider)==null?void 0:i.getWebsocketUrl());return e?zi=e:MT()&&(zi="wss://"+window.location.host+"/socket"),this.connectWebsocket()}disconnect(){var t;(t=this._ws)==null||t.close(),this._ws=void 0,zi=void 0,this._currentRoomAllowEditing=!0,this._currentRoomName=null,this._currentRoomViewId=null,this._isInRoom=!1,this._currentInRoom.length=0,this._state={},this._currentDelay=-1}connectWebsocket(){return this._connectingToWebsocketPromise?this._connectingToWebsocketPromise:this._connectingToWebsocketPromise=new Promise(async(t,e)=>{var h,d;let i=!1;const n=u=>{i||(i=!0,t(u))};if(zi===void 0&&(console.log("Fetch default backend url: "+Fv),zi=await(await fetch(Fv)).text()),zi===void 0){n(!1);return}console.debug(`âŠ¡ Connecting to networking backend on
`+zi);const o=await rs(()=>import("./index.d7be2e3b.js"),[],import.meta.url),r=((h=o.default)==null?void 0:h.WebsocketBuilder)??o.WebsocketBuilder,l=((d=o.default)==null?void 0:d.ExponentialBackoff)??o.ExponentialBackoff,c=new r(zi).withMaxRetries(10).withBackoff(new l(2e3,4)).onOpen(()=>{this._connectingToWebsocketPromise=null,this._ws=c,this.connected=!0,U()||sn?console.log(`âŠž Connected to networking backend
`+zi):console.debug("âŠž Connected to networking backend",zi),n(!0),this.onSendQueued(es.OnConnection)}).onClose(u=>{this._connectingToWebsocketPromise=null,this.connected=!1,this._isInRoom=!1,n(!1);let f="Websocket connection closed...";zi!=null&&zi.includes("/socket")||(f+=' Do you perhaps mean to connect to "/socket"?'),console.error(f)}).onError(u=>{console.error("âŠ  Websocket connection failed..."),n(!1)}).onRetry(()=>{console.log("â†’ Retry connecting to networking websocket")}).build();c.addEventListener(o.WebsocketEvent.message,(u,f)=>{this.onMessage(u,f)})})}onMessage(t,e){const i=e.data;try{if(typeof i!="string"){i.size&&this.handleIncomingBinaryMessage(i);return}const n=JSON.parse(i);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch(n){sn&&i==="pong"?console.log("<<",i):U()&&console.error("Failed to parse message",n)}}async handleIncomingBinaryMessage(t){Bu&&console.log("<< bin",this.context.time.frame);const e=await t.arrayBuffer();var i=new Uint8Array(e);const n=new Ud(i),o=n.getBufferIdentifier(),r=this._listenersBinary[o],l=dk(n),c=uk(l);if(c&&typeof c=="string"&&(this._state[c]=l),!r)return;const h=l??n;for(const d of r)d(h)}handleIncomingStringMessage(t){var n,o;if(sn&&console.log("<<",t.key??t),t.key)switch(t.key){case Ky.ConnectionInfo:if(t.data){const c=t.data;c&&(console.assert(c.id!==void 0&&c.id!==null&&c.id.length>0,"server did not send connection id",c.id),console.debug("Your id is: "+c.id,this.context.alias??""),this._connectionId=c.id)}else console.warn("Expected connection id in "+t.key);break;case se.JoinedRoom:if(sn&&console.log(t),t){this._isInRoom=!0;const c=t;this._currentRoomName=c.room,this._currentRoomViewId=c.viewId,this._currentRoomAllowEditing=c.allowEditing??!0,this._currentInRoom.length=0,this._currentInRoom.push(...c.inRoom),(Bu||U())&&console.debug("Joined Needle Engine Room: "+c.room);const h=new URL(window.location.href);h.searchParams.has("room")&&h.searchParams.delete("room"),h.searchParams.set("view",this._currentRoomViewId),console.debug(`Room view id: ${this._currentRoomViewId}
${h.href}`)}this.onSendQueued(es.OnRoomJoin);break;case se.LeftRoom:const r=t;r.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentRoomAllowEditing=!0,this._currentInRoom.length=0,(Bu||U())&&console.debug("Left Needle Engine Room: "+r.room));break;case se.UserJoinedRoom:if(t.data){const c=t.data;this._currentInRoom.push(c.userId),sn&&console.log(c.userId+" joined","now in room:",this._currentInRoom)}break;case se.UserLeftRoom:if(t.data){const c=t.data,h=this._currentInRoom.indexOf(c.userId);h>=0&&(sn&&console.log(c.userId+" left","now in room:",this._currentInRoom),this._currentInRoom.splice(h,1)),c.userId===this.connectionId&&console.log("you left the room")}break;case"all-room-state-deleted":sn&&console.log("RECEIVED all-room-state-deleted"),this._state={};break;case"ping":case"pong":const l=(n=t.data)==null?void 0:n.time;l&&(this._currentDelay=this.context.time.time-l),sn&&console.log(`Current latency: ${(this._currentDelay*1e3).toFixed()} ms`,"Clients in room: "+((o=this._currentInRoom)==null?void 0:o.length));break}const e=t.data;e&&(this._state[e.guid]=e);let i=this._listeners[t.key];if(i){i=[...i];for(const r of i)try{r(t.data)}catch(l){console.error('Error invoking callback for "'+t.key+'"',l)}}}toMessage(t,e){return{key:t,data:e}}sendWithWebsocket(t,e,i=es.OnRoomJoin){if(!this._ws){const o=this._waitingForSocket[i]||[];o.push(()=>this.sendWithWebsocket(t,e,i)),this._waitingForSocket[i]=o;return}const n=JSON.stringify(this.toMessage(t,e));sn&&console.log(">>",t),this._ws.send(n)}onSendQueued(t){const e=this._waitingForSocket[t];if(e){for(const i of e)i();e.length=0}}}const Jh=S("debugwebxr");class Pg{constructor(t,e){a(this,"controllerStates",[]);a(this,"userId");a(this,"context");a(this,"userStateEvtName");a(this,"onReceivedControllerState",t=>{Jh&&console.log(`XRSync: Received change for ${this.userId}: ${t.type} ${t.handedness}; tracked=${t.isTracking}`);let e=!1;for(let i=0;i<this.controllerStates.length;i++)if(this.controllerStates[i].index===t.index){this.controllerStates[i]=t,e=!0;break}e||this.controllerStates.push(t)});this.userId=t,this.context=e,this.userStateEvtName="xr-sync-user-state-"+t,this.context.connection.beginListen(this.userStateEvtName,this.onReceivedControllerState)}dispose(){this.context.connection.stopListen(this.userStateEvtName,this.onReceivedControllerState)}update(t){if(this.context.connection.isConnected!=!1){for(let e=this.controllerStates.length-1;e>=0;e--){const i=this.controllerStates[e];let n=!1;for(let o=0;o<t.controllers.length;o++)t.controllers[o].index===i.index&&(n=!0);n||(Jh&&console.log(`XRSync: ${i.type} ${i.handedness} removed`,i.index),this.controllerStates.splice(e,1),this.sendControllerRemoved(i))}for(const e of t.controllers)this.updateControllerStates(e)}}onExitXR(t){for(const e of this.controllerStates)this.sendControllerRemoved(e);this.controllerStates.length=0}sendControllerRemoved(t){t.isTracking=!1,t.guid="",this.context.connection.send(this.userStateEvtName,t),this.context.connection.sendDeleteRemoteState(t.guid)}updateControllerStates(t){const e=this.controllerStates.find(i=>i.index===t.index);if(e){let i=!1;i||(i=e.isTracking!=t.isTracking),i&&(e.isTracking=t.isTracking,this.context.connection.send(this.userStateEvtName,e))}else{const i={guid:this.userId+"-"+t.index,isTracking:t.isTracking,handedness:t.side,index:t.index,type:t.hand?"hand":"controller"};this.controllerStates.push(i),this.context.connection.send(this.userStateEvtName,i),Jh&&console.log(`XRSync: ${i.type} ${i.handedness} added`,i.index)}}}class Zk{constructor(t){a(this,"context");a(this,"onJoinedRoom",()=>{if(this.context.connection.connectionId){this._states.has(this.context.connection.connectionId)||(Jh&&console.log("XRSync: Local user joined room",this.context.connection.connectionId),this._states.set(this.context.connection.connectionId,new Pg(this.context.connection.connectionId,this.context)));for(const t of this.context.connection.usersInRoom())this._states.has(t)||this._states.set(t,new Pg(t,this.context))}});a(this,"onLeftRoom",()=>{if(this.context.connection.connectionId&&!this._states.has(this.context.connection.connectionId)){const t=this._states.get(this.context.connection.connectionId);t==null||t.dispose(),this._states.delete(this.context.connection.connectionId)}});a(this,"onOtherUserJoinedRoom",t=>{const e=t.userId;this._states.has(e)||(Jh&&console.log("XRSync: Remote user joined room",e),this._states.set(e,new Pg(e,this.context)))});a(this,"onOtherUserLeftRoom",t=>{const e=t.userId;if(!this._states.has(e)){const i=this._states.get(e);i==null||i.dispose(),this._states.delete(e)}});a(this,"_states",new Map);this.context=t,this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.LeftRoom,this.onLeftRoom),this.context.connection.beginListen(se.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.beginListen(se.UserLeftRoom,this.onOtherUserLeftRoom)}hasState(t){return t?this._states.has(t):!1}isTracking(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.isTracking)||!1}getDeviceType(t,e){if(!t)return;const i=this._states.get(t);if(!i)return;const n=i.controllerStates.find(o=>o.handedness===e);return(n==null?void 0:n.type)||"unknown"}destroy(){this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.LeftRoom,this.onLeftRoom),this.context.connection.stopListen(se.UserJoinedRoom,this.onOtherUserJoinedRoom),this.context.connection.stopListen(se.UserLeftRoom,this.onOtherUserLeftRoom)}onUpdate(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.update(t)}}onExitXR(t){if(this.context.connection.isConnected&&this.context.connection.connectionId){const e=this._states.get(this.context.connection.connectionId);e==null||e.onExitXR(t)}}}class zv{constructor(){a(this,"_fadeToColorQuad");a(this,"_fadeToColorMaterial");a(this,"_requestedFadeValue",0);a(this,"_transitionPromise",null);a(this,"_transitionResolve",null);this._fadeToColorMaterial=new Be({color:0,transparent:!0,depthTest:!1,fog:!1,side:vn}),this._fadeToColorQuad=new X(new ro(10,10),this._fadeToColorMaterial)}dispose(){this._fadeToColorQuad.geometry.dispose(),this._fadeToColorMaterial.dispose()}update(t,e){const i=this._fadeToColorQuad,n=this._fadeToColorMaterial;i.parent!==t&&n.opacity>0?t.add(i):n.opacity===0&&i.removeFromParent(),i.layers.set(2),i.material=this._fadeToColorMaterial,i.position.z=-1,i.renderOrder=1/0;const o=this._requestedFadeValue;n.opacity=N.lerp(n.opacity,o,e/.03),Math.abs(n.opacity-o)<=.01&&this._transitionResolve&&(this._transitionResolve(),this._transitionResolve=null,this._transitionPromise=null,this._requestedFadeValue=0)}remove(){this._fadeToColorQuad.removeFromParent()}fadeTransition(){if(this._transitionPromise)return this._transitionPromise;this._requestedFadeValue=1;const t=new Promise(e=>{this._transitionResolve=e});return this._transitionPromise=t,t}}var Bn;(function(s){s[s.Quad=0]="Quad",s[s.Cube=1]="Cube",s[s.Sphere=2]="Sphere",s[s.Cylinder=3]="Cylinder",s[s.RoundedCube=10]="RoundedCube"})(Bn||(Bn={}));var Kd,Jy;class ll{static createText(t,e){let i=null;const n=(e==null?void 0:e.font)||tE((e==null?void 0:e.familyFamily)||null);n instanceof iT?i=gh(this,Kd,Jy).call(this,t,n,e):i==null&&(i=new os);const o=(e==null?void 0:e.color)||16777215,r=new X(i,(e==null?void 0:e.material)??new It({color:o}));return this.applyDefaultObjectOptions(r,e),n instanceof Promise?n.then(l=>{r.geometry=gh(this,Kd,Jy).call(this,t,l,e),e!=null&&e.onGeometry&&e.onGeometry(r)}):e!=null&&e.onGeometry&&e.onGeometry(r),r}static createOccluder(t){const e=new Be({colorWrite:!1,depthWrite:!0,side:vn});return this.createPrimitive(t,{material:e})}static createPrimitive(t,e){let i;const n=(e==null?void 0:e.color)||16777215;switch(t){case"Quad":case Bn.Quad:{const o=new ro(1,1,1,1),r=(e==null?void 0:e.material)??new It({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new X(o,r),i.name="Quad"}break;case"Cube":case Bn.Cube:{const o=new bc(1,1,1),r=(e==null?void 0:e.material)??new It({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new X(o,r),i.name="Cube"}break;case Bn.RoundedCube:case"RoundedCube":{const o=eE(1,1,1,.1,2),r=(e==null?void 0:e.material)??new It({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new X(o,r),i.name="RoundedCube"}break;case"Sphere":case Bn.Sphere:{const o=new Wp(.5,16,16),r=(e==null?void 0:e.material)??new It({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new X(o,r),i.name="Sphere"}break;case"Cylinder":case Bn.Cylinder:{const o=new jw(.5,.5,1,32),r=(e==null?void 0:e.material)??new It({color:n});e!=null&&e.texture&&"map"in r&&(r.map=e.texture),i=new X(o,r),i.name="Cylinder"}break;case"ShaderBall":i=new Ar,i.name="ShaderBall",iE(i,e);break}return this.applyDefaultObjectOptions(i,e),i}static createSprite(t){const i=new zP({color:16777215});t!=null&&t.texture&&"map"in i&&(i.map=t.texture);const n=new UP(i);return this.applyDefaultObjectOptions(n,t),n}static applyDefaultObjectOptions(t,e){t.receiveShadow=!0,t.castShadow=!0,e!=null&&e.name&&(t.name=e.name),e!=null&&e.position&&(Array.isArray(e.position)?t.position.set(e.position[0],e.position[1],e.position[2]):t.position.set(e.position.x||0,e.position.y||0,e.position.z||0)),e!=null&&e.rotation&&(Array.isArray(e.rotation)?t.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]):t.rotation.set(e.rotation.x||0,e.rotation.y||0,e.rotation.z||0)),e!=null&&e.scale&&(typeof e.scale=="number"?t.scale.set(e.scale,e.scale,e.scale):Array.isArray(e.scale)?t.scale.set(e.scale[0],e.scale[1],e.scale[2]):t.scale.set(e.scale.x||1,e.scale.y||1,e.scale.z||1)),(e==null?void 0:e.receiveShadow)!=null&&(t.receiveShadow=e.receiveShadow),(e==null?void 0:e.castShadow)!=null&&(t.castShadow=e.castShadow),e!=null&&e.parent&&e.parent.add(t)}}Kd=new WeakSet,Jy=function(t,e,i){const n=(i==null?void 0:i.depth)||.1;return new nT(t,{font:e,size:1,depth:n,height:n,bevelEnabled:(i==null?void 0:i.bevel)||!1,bevelThickness:.01,bevelOffset:.01,bevelSize:.01})},On(ll,Kd);function eE(s,t,e,i,n){const o=new NP,r=1e-5,l=i-r;o.absarc(r,r,r,-Math.PI/2,-Math.PI,!0),o.absarc(r,t-l*2,r,Math.PI,Math.PI/2,!0),o.absarc(s-l*2,t-l*2,r,Math.PI/2,0,!0),o.absarc(s-l*2,r,r,0,-Math.PI/2,!0);const c=new $P(o,{bevelEnabled:!0,bevelSegments:n*2,steps:1,bevelSize:l,bevelThickness:i,curveSegments:n,UVGenerator:{generateTopUV:(h,d)=>{const u=[];for(let f=0;f<d.length;f+=3)u.push(new le(d[f]/s,d[f+1]/t));return u},generateSideWallUV:(h,d,u,f,p,g)=>{const _=[];return _.push(new le(d[u]/s,d[u+1]/t)),_.push(new le(d[f]/s,d[f+1]/t)),_.push(new le(d[p]/s,d[p+1]/t)),_.push(new le(d[g]/s,d[g+1]/t)),_}}});return c.scale(1,1,1-i),c.center(),c.index||c.setIndex(Array.from({length:c.attributes.position.count},(h,d)=>d)),c.computeVertexNormals(),c}const Fu=new Map;function tE(s){let t="";switch(s){default:case"OpenSans":t="https://cdn.needle.tools/static/fonts/facetype/Open Sans_Regular_ascii.json";break;case"Helvetiker":t="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/fonts/helvetiker_regular.typeface.json";break}if(Fu.has(t)){const n=Fu.get(t);if(n)return n}const e=new sT,i=new Promise((n,o)=>{e.load(t,r=>{Fu.set(t,r),n(r)},void 0,o)});return Fu.set(t,i),i}let Rg=!1,Tg=null;function iE(s,t){if(Tg===null){const e="https://cdn.needle.tools/static/models/shaderball.glb",i=new Yo,n=sb(null);i.setDRACOLoader(n.dracoLoader),i.setKTX2Loader(n.ktx2Loader),Rg=!0,Tg=i.loadAsync(e).then(o=>{const r=o.scene;return r.position.y-=.5,r}).catch(o=>(console.warn("Failed to load shaderball mesh: "+o.message),Nv())).finally(()=>{Rg=!1})}if(Rg){const e=Nv();e.name="ShaderBall-Placeholder";const i=e.children[0];(i==null?void 0:i.type)==="Mesh"&&Uv(i,t),s.add(e)}Tg.then(e=>{s.children.forEach(o=>{o.name==="ShaderBall-Placeholder"&&s.remove(o)});const i=e.clone(),n=i.children[0];(n==null?void 0:n.type)==="Mesh"&&(n.geometry.attributes.tangent||n.geometry.computeTangents(),Uv(n,t)),s.add(i)})}function Uv(s,t){var i;if((t==null?void 0:t.color)||(t==null?void 0:t.material)||(t==null?void 0:t.texture)){const n=(t==null?void 0:t.material)??((i=s.material)==null?void 0:i.clone())??new It;t.color&&"color"in n&&n.color instanceof de&&n.color.set(t.color),t!=null&&t.texture&&"map"in n&&(n.map=t.texture),s.material=n}}function Nv(){return new Ar().add(ll.createPrimitive("Sphere",{material:new Be({transparent:!0,opacity:.1})}))}const w0=class{constructor(t,e,i){a(this,"_session");a(this,"_mode");a(this,"_init");a(this,"_renderer");a(this,"_camera");a(this,"_scene");a(this,"onEnd",()=>{var t;(t=this._session)==null||t.removeEventListener("end",this.onEnd),this._renderer.setAnimationLoop(null),this._renderer.dispose(),this._scene.clear()});a(this,"_lastTime",0);a(this,"onFrame",(t,e)=>{const i=t-this._lastTime;this.update(t,i),this._camera.parent!==this._scene&&this._scene.add(this._camera),this._renderer.render(this._scene,this._camera)});a(this,"_objects",[]);this._mode=t,this._init=e,this._session=i,this._session.addEventListener("end",this.onEnd),this._renderer=new ol({alpha:!0}),this._renderer.setAnimationLoop(this.onFrame),this._renderer.xr.setSession(i),this._renderer.xr.enabled=!0,this._camera=new Se,this._scene=new bn,this._scene.fog=new Bw(4473924,10,250),this._scene.add(this._camera),this.setupScene()}static get active(){return this._active}static async start(t,e){if(this._active)return console.error("Cannot start a new XR session while one is already active"),null;if(this._requestInFlight)return console.error("Cannot start a new XR session while a request is already in flight"),null;if("xr"in navigator&&navigator.xr){if(!e)return console.error("XRSessionInit must be provided"),null;this._requestInFlight=!0;const i=await navigator.xr.requestSession(t,e);return i.addEventListener("end",()=>{this._active=null}),this._requestInFlight?(this._requestInFlight=!1,this._active=new w0(t,e,i),this._active):(i.end(),null)}return null}static async handoff(){return this._active?this._active.handoff():null}static async stop(){this._requestInFlight=!1,this._active&&(await this._active.end(),await Ko(100)),this._active=null}get isAR(){return this._mode==="immersive-ar"}end(){return this._session?this._session.end():Promise.resolve()}async handoff(){if(!this._session)throw new Error("Cannot handoff a session that has already ended");const t={session:this._session,mode:this._mode,init:this._init};return await this.onBeforeHandoff(),this.onEnd(),this._session=null,t}async onBeforeHandoff(){await Ko(1e3),this._scene.clear()}setupScene(){this._scene.background=new de(0),this._scene.add(new q_(5,10,1118481,1118481));const t=new Ty(16777215,1);t.position.set(0,20,0),t.castShadow=!1,this._scene.add(t);const e=new Ty(16777215,1);e.position.set(0,-1,0),e.castShadow=!1,this._scene.add(e);const i=new X_(16777215,1,100,1);i.position.set(0,2,0),i.castShadow=!1,i.distance=200,this._scene.add(i);const n=50;for(let o=0;o<100;o++){const r=new It({color:2236962,metalness:1,roughness:.8});this.isAR&&(r.emissive=new de(Math.random(),Math.random(),Math.random()),r.emissiveIntensity=Math.random());const l=N.random(0,1)>.5?Bn.Sphere:Bn.Cube,c=ll.createPrimitive(l,{material:r});c.position.x=N.random(-n,n),c.position.y=N.random(-2,n),c.position.z=N.random(-n,n),c.rotation.x=N.random(0,Math.PI*2),c.rotation.y=N.random(0,Math.PI*2),c.rotation.z=N.random(0,Math.PI*2),c.scale.multiplyScalar(.5+Math.random()*10);const h=c.position.distanceTo(this._camera.position)-c.scale.x;h<1&&c.position.multiplyScalar(1+1/h),this._objects.push(c),this._scene.add(c)}}update(t,e){const i=t*4e-4;for(let n=0;n<this._objects.length;n++){const o=this._objects[n];o.position.y+=Math.sin(i+n*.5)*.005,o.rotateY(.002)}}};let Er=w0;a(Er,"_active",null),a(Er,"_requestInFlight",!1);var $d;(function(s){const t=[];function e(){if(!(t!=null&&t.length))return!1;for(const o of t)o.exportAndOpen();return!0}s.exportAndOpen=e;function i(o){t.push(o)}s.registerExporter=i;function n(o){if(!t)return;const r=t.indexOf(o);r>=0&&t.splice(r,1)}s.unregisterExporter=n})($d||($d={}));const ct=S("debugwebxr"),$v=S("stats");let Og=0;function nE(s){let t=null;const e=s;return e.getAROverlayContainer?t=e.getAROverlayContainer():t=s,t}sE();async function sE(){var s;if(S("debugasap")){let t=globalThis["needle:XRSession"];if(t instanceof Promise){delete globalThis["needle:XRSession"],ve.addContextCreatedCallback(async e=>{if(!t)return;lc(!0);const i=await t;if(i){const n=te.getDefaultSessionInit("immersive-vr");te.setSession("immersive-vr",i,n,e.context)}else console.error("NeedleXRSession: ASAP session was rejected");t=void 0});return}}if("xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent)){console.warn("WebXRViewer does not support addEventListener");return}(s=navigator.xr)==null||s.addEventListener("sessiongranted",async()=>{lc(!0),console.log("Received Session Granted..."),await Ko(100);const t=sessionStorage.getItem("needle_xr_session_mode"),e=sessionStorage.getItem("needle_xr_session_init")??null,i=e?JSON.parse(e):null;let n=null;if(xC()&&(await Er.start(t||"immersive-vr",i||te.getDefaultSessionInit("immersive-vr")),await aE(),n=await Er.handoff()),n)te.setSession(n.mode,n.session,n.init,ne.Current);else if(t&&e){console.log("Session Granted: Restore last session");const o=JSON.parse(e);te.start(t,o).catch(r=>console.warn(r))}else te.start("immersive-vr").catch(o=>console.warn("Session Granted failed:",o))},{once:!0})}}function oE(s,t){sessionStorage.setItem("needle_xr_session_mode",s),sessionStorage.setItem("needle_xr_session_init",JSON.stringify(t))}function rE(){sessionStorage.removeItem("needle_xr_session_mode"),sessionStorage.removeItem("needle_xr_session_init")}const bb=new Set;ve.registerCallback(ge.ContextCreationStart,async s=>{bb.add(s.context)});ve.registerCallback(ge.ContextCreated,async s=>{var e;bb.delete(s.context);const t=((e=s.context)==null?void 0:e.domElement.getAttribute("autostart"))||null;lE(t)});function xC(){return bb.size>0}function aE(){return new Promise(s=>{const t=Date.now(),e=setInterval(()=>{(!xC()||Date.now()-t>6e4)&&(clearInterval(e),s())},100)})}K.isDesktop()&&U()&&window.addEventListener("keydown",s=>{(s.key==="x"||s.key==="Escape")&&te.active&&te.stop()});function lE(s){if(s)switch(s==null?void 0:s.toLowerCase()){case"ar":ls.registerWaitForInteraction(()=>{te.start("ar")});break}}const zu=Symbol("initial-fov"),Oo=class{constructor(t,e,i,n){a(this,"context");a(this,"session");a(this,"mode");a(this,"controllers",[]);a(this,"_rigScale",1);a(this,"_lastRigScaleUpdate",-1);a(this,"_rigs",[]);a(this,"_viewerHitTestSource",null);a(this,"_defaultRig");a(this,"_xr_scripts");a(this,"_xr_update_scripts",[]);a(this,"_inactive_scripts",[]);a(this,"_controllerAdded");a(this,"_controllerRemoved");a(this,"_originalCameraWorldPosition");a(this,"_originalCameraWorldRotation");a(this,"_originalCameraWorldScale");a(this,"_originalCameraParent");a(this,"_mainCamera",null);a(this,"onRendererSessionSet",()=>{var t;this.running&&(this.context.renderer.xr.enabled=!0,this.context.renderer.xr.updateCamera(this.context.mainCamera),(t=this.context.mainCameraComponent)==null||t.applyClearFlags())});a(this,"onInputSourceAdded",t=>{if(t.targetRayMode==="screen")return;let e=0;for(let n=0;n<this.session.inputSources.length;n++)if(this.session.inputSources[n]===t){e=n;break}if(this.controllers.find(n=>n.inputSource===t)){console.debug("Controller already exists for input source",e);return}else if(this._newControllers.find(n=>n.inputSource===t)){console.debug("Controller already registered for input source",e);return}const i=new TS(this,t,e);this._newControllers.push(i)});a(this,"_ended",!1);a(this,"_newControllers",[]);a(this,"onEnd",t=>{var o,r,l;if(this._ended)return;this._ended=!0,console.debug("XR Session ended"),rE(),this.onAfterRender(),this.revertCustomForward(),this._didStart=!1,this._previousCameraParent=null,this.requestedCameraNearPlane=null,Yr(this.onBefore,oe.LateUpdate);const e=this.context.pre_render_callbacks.indexOf(this.onBeforeRender);e>=0&&this.context.pre_render_callbacks.splice(e,1);const i=this.context.post_render_callbacks.indexOf(this.onAfterRender);i>=0&&this.context.post_render_callbacks.splice(i,1),this.context.xr=null,this.context.renderer.xr.enabled=!1,this.context.pre_update_oneshot_callbacks.push(()=>{var c,h;(c=this.context.mainCameraComponent)==null||c.applyClearFlags(),(h=this.context.mainCameraComponent)==null||h.applyClippingPlane()}),YO({session:this});for(const c of Oo._xrEndListeners)c({xr:this});const n=[...this.controllers];for(let c=0;c<n.length;c++)this.disconnectInputSource(n[c].inputSource);this.controllers.length=0,this._newControllers.length=0;for(const c of this._xr_scripts)(o=c==null?void 0:c.onLeaveXR)==null||o.call(c,{xr:this});(r=this.sync)==null||r.onExitXR(this),this.context.mainCamera&&((l=this._originalCameraParent)==null||l.add(this.context.mainCamera),this._originalCameraWorldPosition&&ei(this.context.mainCamera,this._originalCameraWorldPosition),this._originalCameraWorldRotation&&no(this.context.mainCamera,this._originalCameraWorldRotation),this._originalCameraWorldScale&&zd(this.context.mainCamera,this._originalCameraWorldScale),this.context.mainCamera instanceof Se&&this.context.mainCamera[zu]&&(this.context.mainCamera.fov=this.context.mainCamera[zu],this.context.mainCamera[zu]=0)),this.context.requestSizeUpdate(),this._defaultRig.gameObject.removeFromParent(),lc(!1)});a(this,"_didStart",!1);a(this,"onBefore",t=>{var n,o,r,l,c,h,d,u;const e=t.xrFrame;if(!e)return;this.context.xr=this,this.context.mainCameraComponent&&this.context.mainCameraComponent!==this._mainCamera&&(this._mainCamera=this.context.mainCameraComponent),((n=this.rig)==null?void 0:n.isActive)==!1&&(ct&&console.warn("Latest rig is not active - trying to activate a different rig",this.rig),this.updateActiveXRRig()),this.rig&&((o=this._mainCamera)!=null&&o.gameObject)&&((l=(r=this._mainCamera)==null?void 0:r.gameObject)==null?void 0:l.parent)!==this.rig.gameObject&&this.rig.gameObject.add((c=this._mainCamera)==null?void 0:c.gameObject),this.internalUpdateState(),this.applyCustomForward();const i={xr:this};if(this._didStart){if(this.context.new_scripts_xr.length>0){const f=[...this.context.new_scripts_xr];for(let p=0;p<f.length;p++){const g=this.context.new_scripts_xr[p];if(!g||g.destroyed||((h=g.supportsXR)==null?void 0:h.call(g,this.mode))==!1){this.context.new_scripts_xr.splice(p,1);continue}if(!g.activeAndEnabled){this.context.new_scripts_xr.splice(p,1),this.markInactive(g);continue}if(this.addScript(g)){this.invokeCallback_EnterXR(g);for(const _ of this.controllers)this.invokeCallback_ControllerAdded(g,_)}}}}else{if(this._didStart=!0,this.mode==="immersive-vr"){const p=Qi(this.context.scene.children);if(p){const g=p.getSize(q());if(g.length()>0){const _=this._defaultRig.gameObject;_.position.set(p.min.x+g.x*.5,p.min.y,p.max.z+g.z*.5+1.5);const y=p.getCenter(q());y.y=_.position.y,_.lookAt(y)}}}QO({session:this}),al();for(const p of Oo._xrStartListeners)p(i);const f=[...this._xr_scripts];ct&&console.log("NeedleXRSession start, handle scripts:",f);for(const p of f){if(p.destroyed){this._script_to_remove.push(p);continue}if(!p.activeAndEnabled){this.markInactive(p);continue}this.invokeCallback_EnterXR(p);for(const g of this.controllers)this.invokeCallback_ControllerAdded(p,g)}}this.syncCameraCullingMask();for(const f of this.controllers)f.onUpdate(e);if(this._newControllers.length>0){const f=[...this._newControllers];this._newControllers.length=0;for(const p of f){if(!p.connected){console.warn("New controller is not connected",p);continue}this.controllers.push(p);for(const g of this._xr_scripts){if(g.destroyed){this._script_to_remove.push(g);continue}g.activeAndEnabled!==!1&&this.invokeCallback_ControllerAdded(g,p)}}this.controllers.sort((p,g)=>p.index-g.index)}ct&&this.context.time.frame%30===0&&this.controllers.length<=0&&this.session.inputSources.length>0&&(lc(!0),console.error("XRControllers are not added but inputSources are present"));for(const f of this._xr_update_scripts){if(f.destroyed===!0){this._script_to_remove.push(f);continue}if(f.activeAndEnabled===!1){this.markInactive(f);continue}f.onUpdateXR&&f.onUpdateXR(i)}if(this.handleInactiveScripts(),this._script_to_remove.length>0){const f=[...new Set(this._script_to_remove)];this._script_to_remove.length=0;for(const p of f)!p.destroyed&&this.running&&((d=p.onLeaveXR)==null||d.call(p,i)),this.removeScript(p)}(u=this.sync)==null||u.onUpdate(this),this.onRenderDebug()});a(this,"onBeforeRender",()=>{this.context.mainCamera&&(this.updateFade(this.context.mainCamera),this.requestedCameraNearPlane!==null&&this.context.mainCamera instanceof Se&&(this.context.mainCamera.near=this.requestedCameraNearPlane,this.requestedCameraNearPlane=null))});a(this,"onAfterRender",()=>{if(this.onUpdateFade_PostRender(),K.isDesktop()||!this._renderOnceOnDevice){const t=this.context.renderer;if(t.xr.isPresenting&&this.context.mainCamera){this._renderOnceOnDevice=!0;const e=t.xr.enabled,i=t.getRenderTarget(),n=this.context.scene.background;t.xr.enabled=!1,t.setRenderTarget(null),this.isPassThrough&&(this.context.scene.background=null),this.context.composer?this.context.composer.render(this.context.time.deltaTime):t.render(this.context.scene,this.context.mainCamera),t.xr.enabled=e,t.setRenderTarget(i),this.context.scene.background=n}}});a(this,"_script_to_remove",[]);a(this,"_camera");a(this,"_cameraRenderParent",new D().rotateY(Math.PI));a(this,"_previousCameraParent");a(this,"_customforward",!0);a(this,"originalCameraNearPlane");a(this,"requestedCameraNearPlane",null);a(this,"_viewerPose");a(this,"_transformOrientation",new H);a(this,"_transformPosition",new x);a(this,"_transition");var o,r;oE(t,n.init),this.session=e,this.mode=t,this.context=i,(ct||S("console"))&&lc(!0),this._xr_scripts=[...n.scripts],this._xr_update_scripts=this._xr_scripts.filter(l=>typeof l.onUpdateXR=="function"),this._controllerAdded=n.controller_added,this._controllerRemoved=n.controller_removed,tr(this.onBefore,oe.LateUpdate),this.context.pre_render_callbacks.push(this.onBeforeRender),this.context.post_render_callbacks.push(this.onAfterRender),((o=n.init.optionalFeatures)!=null&&o.includes("hit-test")||(r=n.init.requiredFeatures)!=null&&r.includes("hit-test"))&&e.requestReferenceSpace("viewer").then(l=>{var c,h;return(h=(c=e.requestHitTestSource)==null?void 0:c.call(e,{space:l}))==null?void 0:h.then(d=>this._viewerHitTestSource=d).catch(d=>console.error(d))}).catch(l=>console.error(l)),this.context.mainCamera&&(this._originalCameraWorldPosition=ae(this.context.mainCamera,new x),this._originalCameraWorldRotation=Le(this.context.mainCamera,new H),this._originalCameraWorldScale=_t(this.context.mainCamera,new x),this._originalCameraParent=this.context.mainCamera.parent,this.context.mainCamera instanceof Se&&(this.context.mainCamera[zu]=this.context.mainCamera.fov)),this._defaultRig=new rk,this.context.scene.add(this._defaultRig.gameObject),this.addRig(this._defaultRig);for(let l=0;l<e.inputSources.length;l++){const c=e.inputSources[l];if(!c.handedness){console.warn("Input source in xr session has no handedness - ignoring",l);continue}this.onInputSourceAdded(c)}this.session.addEventListener("end",this.onEnd),this.session.addEventListener("inputsourceschange",l=>{for(const c of l.removed)this.disconnectInputSource(c);for(const c of l.added)this.onInputSourceAdded(c)}),this.context.xr=this,this.context.renderer.xr.setSession(this.session).then(this.onRendererSessionSet),"controllerAutoUpdate"in this.context.renderer.xr?(console.debug("Disabling three.js controllerAutoUpdate"),this.context.renderer.xr.controllerAutoUpdate=!1):ct&&console.warn("controllerAutoUpdate is not available in three.js - cannot disable it")}static getXRSync(t){return this._sync||(this._sync=new Zk(t)),this._sync}static get currentSessionRequest(){return this._currentSessionRequestMode}static get active(){return this._activeSession}static get activeMode(){var t;return((t=this._activeSession)==null?void 0:t.mode)??null}static get xrSystem(){return"xr"in navigator?navigator.xr:void 0}static isXRSupported(){return Promise.all([this.isVRSupported(),this.isARSupported()]).then(t=>t.some(e=>e)).catch(()=>!1)}static isVRSupported(){return this.isSessionSupported("immersive-vr")}static isARSupported(){return this.isSessionSupported("immersive-ar")}static isSessionSupported(t){var e;return((e=this.xrSystem)==null?void 0:e.isSessionSupported(t).catch(i=>(ct&&console.error(i),!1)))??Promise.resolve(!1)}static onSessionRequestStart(t){this._sessionRequestStartListeners.push(t)}static offSessionRequestStart(t){const e=this._sessionRequestStartListeners.indexOf(t);e>=0&&this._sessionRequestStartListeners.splice(e,1)}static onSessionRequestEnd(t){this._sessionRequestEndListeners.push(t)}static offSessionRequestEnd(t){const e=this._sessionRequestEndListeners.indexOf(t);e>=0&&this._sessionRequestEndListeners.splice(e,1)}static onXRSessionStart(t){this._xrStartListeners.push(t)}static offXRSessionStart(t){const e=this._xrStartListeners.indexOf(t);e>=0&&this._xrStartListeners.splice(e,1)}static onXRSessionEnd(t){this._xrEndListeners.push(t)}static offXRSessionEnd(t){const e=this._xrEndListeners.indexOf(t);e>=0&&this._xrEndListeners.splice(e,1)}static onControllerAdded(t){this._controllerAddedListeners.push(t)}static offControllerAdded(t){const e=this._controllerAddedListeners.indexOf(t);e>=0&&this._controllerAddedListeners.splice(e,1)}static onControllerRemoved(t){this._controllerRemovedListeners.push(t)}static offControllerRemoved(t){const e=this._controllerRemovedListeners.indexOf(t);e>=0&&this._controllerRemovedListeners.splice(e,1)}static offerSession(t,e,i){return"xr"in navigator&&navigator.xr&&"offerSession"in navigator.xr?(typeof navigator.xr.offerSession=="function"&&(console.log("WebXR offerSession is available - requesting mode: "+t),e=="default"&&(e=this.getDefaultSessionInit(t)),navigator.xr.offerSession(t,{...e}).then(n=>Oo.setSession(t,n,e,i)).catch(n=>{console.log("XRSession offer rejected (perhaps because another call to offerSession was made or a call to requestSession was made)")})),!0):!1}static getDefaultSessionInit(t){switch(t){case"immersive-ar":const e=["anchors","local-floor","layers","dom-overlay","hit-test","unbounded"];return K.isVisionOS()||e.push("hand-tracking"),{optionalFeatures:e};case"immersive-vr":const i=["local-floor","bounded-floor","high-fixed-foveation-level","layers"];return K.isVisionOS()||i.push("hand-tracking"),{optionalFeatures:i};default:return console.warn("No default session init for mode",t),{}}}static async start(t,e,i){var l,c,h,d;if(K.isiOS()){if(t==="ar")if(await this.isARSupported())t="immersive-ar";else return $d.exportAndOpen(),null}else t=="ar"&&(t="immersive-ar");if(U()&&S("debugxrpreroom"))return console.warn("Debug: Starting temporary XR session"),await Er.start(t,e||Oo.getDefaultSessionInit(t)),null;if(this._currentSessionRequest)return console.warn("A XRSession is already being requested"),(ct||U())&&ke("A XRSession is already being requested"),this._currentSessionRequest.then(()=>this._activeSession);if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;if(i||(i=ne.Current),i||(i=ve.All[0]),!i)throw new Error("No Needle Engine Context found");switch(e||(e={}),t){case"immersive-ar":{if(await((l=this.xrSystem)==null?void 0:l.isSessionSupported("immersive-ar"))!==!0)return console.error(t+" is not supported by this browser."),null;const f=this.getDefaultSessionInit(t),p=nE(i.domElement);p&&!K.isQuest()&&(f.domOverlay={root:p},f.optionalFeatures.push("dom-overlay")),e={...f,...e}}break;case"immersive-vr":{if(await((c=this.xrSystem)==null?void 0:c.isSessionSupported("immersive-vr"))!==!0)return console.error(t+" is not supported by this browser."),null;e={...this.getDefaultSessionInit(t),...e}}break;default:console.warn("No default session init for mode",t);break}e.optionalFeatures??(e.optionalFeatures=[]),e.requiredFeatures??(e.requiredFeatures=[]),await Er.stop();const n=t=="immersive-ar"?i.scripts_immersive_ar:i.scripts_immersive_vr;ct?console.log(`%cRequesting ${t} session`,"font-weight:bold;",e,n):console.log(`%cRequesting ${t} session`,"font-weight:bold;");for(const u of n)u.onBeforeXR&&u.onBeforeXR(t,e);for(const u of this._sessionRequestStartListeners)u({mode:t,init:e});ct&&nt("Requesting "+t+" session ("+Date.now()+")"),this._currentSessionRequest=(h=navigator==null?void 0:navigator.xr)==null?void 0:h.requestSession(t,e),this._currentSessionRequestMode=t;const o=await((d=this._currentSessionRequest)==null?void 0:d.catch(u=>{console.error(u,"Code: "+u.code),u.code===9&&ke("Make sure your device has the required permissions (e.g. camera access)"),console.log("If the specified XR configuration is not supported (e.g. entering AR doesnt work) - make sure you access the website on a secure connection (HTTPS) and your device has the required permissions (e.g. camera access)"),location.protocol==="http:"&&ke("XR requires a secure connection (HTTPS)")}));this._currentSessionRequest=void 0,this._currentSessionRequestMode=null;for(const u of this._sessionRequestEndListeners)u({mode:t,init:e,newSession:o||null});return o?this.setSession(t,o,e,i):(console.warn("XR Session request was rejected"),null)}static setSession(t,e,i,n){if(this._activeSession)return console.error("A XRSession is already running"),this._activeSession;const o=t=="immersive-ar"?n.scripts_immersive_ar:n.scripts_immersive_vr;return this._activeSession=new Oo(t,e,n,{scripts:o,controller_added:this._controllerAddedListeners,controller_removed:this._controllerRemovedListeners,init:i}),e.addEventListener("end",this.onEnd),ct?console.log(`%cStarted ${t} session`,"font-weight:bold;",o):console.log(`%cStarted ${t} session`,"font-weight:bold;"),this._activeSession}static stop(){const t=this._activeSession;t&&(t[this.$_stop_request]===void 0?(ct&&console.log("[NeedleXRSession] Stopping XR Session... (new)"),t[this.$_stop_request]=setTimeout(()=>{t.end()})):ct&&console.warn("[NeedleXRSession] XR Session stop already requested"))}get sync(){return Oo._sync}get running(){return!this._ended&&this.session!=null}get interactionMode(){return this.session.interactionMode}get visibilityState(){return this.session.visibilityState}get isVisibleBlurred(){return this.session.visibilityState==="visible-blurred"}get isSystemKeyboardSupported(){return this.session.isSystemKeyboardSupported}get environmentBlendMode(){return this.session.environmentBlendMode}get frame(){return this.context.xrFrame}get leftController(){return this.controllers.find(t=>t.side==="left")}get rightController(){return this.controllers.find(t=>t.side==="right")}getController(t){return typeof t=="number"?this.controllers[t]||null:this.controllers.find(e=>e.side===t)||null}get isPassThrough(){return!!(this.environmentBlendMode!=="opaque"&&this.interactionMode==="world-space"||this.mode==="immersive-ar"&&this.environmentBlendMode!=="opaque"&&this.controllers.some(t=>t.inputSource.targetRayMode==="tracked-pointer")||U()&&K.isDesktop()&&this.mode==="immersive-ar")}get isAR(){return this.mode==="immersive-ar"}get isVR(){return this.mode==="immersive-vr"}get isScreenBasedAR(){return this.isAR&&!this.isPassThrough}get posePosition(){return this._transformPosition}get poseOrientation(){return this._transformOrientation}get referenceSpace(){return this.context.renderer.xr.getReferenceSpace()}get viewerPose(){return this._viewerPose}get isTrackingImages(){if(this.frame&&"getImageTrackingResults"in this.frame&&typeof this.frame.getImageTrackingResults=="function")try{const t=this.frame.getImageTrackingResults();for(const e of t)if(e.trackingState==="tracked")return!0}catch{return!1}return!1}get rig(){const t=this._rigs[0]??null;return t!=null&&t.gameObject&&kc(t.gameObject)||(t==null?void 0:t.isActive)===!1?(this.updateActiveXRRig(),this._rigs[0]??null):t}get rigScale(){return this._rigs[0]?(this._lastRigScaleUpdate!==this.context.time.frame&&(this._lastRigScaleUpdate=this.context.time.frame,this._rigScale=this._rigs[0].gameObject.worldScale.x),this._rigScale):1}addRig(t){this._rigs.indexOf(t)>=0||(t.priority===void 0&&(t.priority=0),this._rigs.push(t),this.updateActiveXRRig())}removeRig(t){const e=this._rigs.indexOf(t);e!==-1&&(this._rigs.splice(e,1),this.updateActiveXRRig())}setRigActive(t){const e=this._rigs.indexOf(t),i=this._rigs[0];this._rigs.splice(e,1),this._rigs.unshift(t),t.priority=(i==null?void 0:i.priority)??0,this.updateActiveXRRig()}getUserOffsetInRig(){var i;const t=(i=this.context.mainCamera)==null?void 0:i.position;if(!t||!this.rig)return q(0,0,0);const e=q(t);return e.x*=-1,e.z*=-1,e.applyQuaternion(dn(this.rig.gameObject.quaternion)),e}updateActiveXRRig(){const t=this._rigs[0]??null;this._defaultRig.gameObject.parent!==this.context.scene&&this.context.scene.add(this._defaultRig.gameObject),this._defaultRig.gameObject.visible=!0,this._rigs.includes(this._defaultRig)||this._rigs.push(this._defaultRig);let e=this._rigs[0];e&&e.priority===void 0&&(e.priority=0);for(let i=1;i<this._rigs.length;i++){const n=this._rigs[i];if(n.isActive){if(kc(n.gameObject)){this._rigs.splice(i,1),i--;continue}(!e||e.isActive===!1||n.priority!==void 0&&n.priority>e.priority)&&(e=n)}}if(t!==e){const i=this._rigs.indexOf(e);i>=0&&this._rigs.splice(i,1),this._rigs.unshift(e)}ct&&(t===e?console.log("Updated Active XR Rig:",e,"prev:",t):console.log("Updated Active XRRig:",e," (the same as before)"))}getHitTest(t){if(t)return this.getControllerHitTest(t);if(!this._viewerHitTestSource)return null;const e=this._viewerHitTestSource,i=this.frame.getHitTestResults(e);if(i.length>0){const n=i[0];return this.convertHitTestResult(n)}return null}getControllerHitTest(t){const e=t.getHitTestSource();if(!e)return null;const i=this.frame.getHitTestResultsForTransientInput(e);for(const n of i)if(n.inputSource===t.inputSource)for(const o of n.results)return this.convertHitTestResult(o);return null}convertHitTestResult(t){const e=this.context.renderer.xr.getReferenceSpace(),i=e&&t.getPose(e);if(i){const n=q(i.transform.position),o=dn(i.transform.orientation),r=this.context.mainCamera;if((r==null?void 0:r.parent)!==this._cameraRenderParent&&n.applyMatrix4(cc),r!=null&&r.parent){n.applyMatrix4(r.parent.matrixWorld),o.multiply(Dn);const l=Le(r.parent);l.premultiply(Dn),o.premultiply(l)}return{hit:t,position:n,quaternion:o}}return null}convertSpace(t){const e=q(t.position);e.applyMatrix4(cc);const i=dn(t.orientation);return i.premultiply(Dn),{position:e,quaternion:i}}disconnectInputSource(t){const e=(o,r)=>{if(o.inputSource===t){ct&&console.log("Disconnecting controller",o.index);const l=r.indexOf(o);l>=0&&r.splice(l,1),this.invokeControllerEvent(o,this._controllerRemoved,"removed");const c={xr:this,controller:o,change:"removed"};for(const h of this._xr_scripts)h.onXRControllerRemoved&&h.onXRControllerRemoved(c);o.onDisconnected()}},i=[...this.controllers];for(let o=i.length-1;o>=0;o--){const r=i[o];e(r,this.controllers)}const n=[...this._newControllers];for(let o=n.length-1;o>=0;o--){const r=n[o];e(r,this._newControllers)}}end(){this._ended||this.session.end().catch(t=>console.warn(t))}onRenderDebug(){if(ct)for(const t of this.controllers)t.onRenderDebug();if((ct||$v)&&this.rig&&(Og++,Og>=20)){const t=this.rig.gameObject.worldPosition,e=this.rig.gameObject.worldForward;t.add(e.multiplyScalar(1.5));const i=this.rig.gameObject.worldUp;t.add(i.multiplyScalar(2.5));let n="";if(n+=`${this.context.time.smoothedFps.toFixed(0)} FPS`,n+=`, calls: ${this.context.renderer.info.render.calls}, tris: ${this.context.renderer.info.render.triangles.toLocaleString()}`,ct||$v)for(const o of this.controllers)n+=`
${o.hand?"hand":"ctrl"} ${o.inputSource.handedness}[${o.index}] con:${o.connected} tr:${o.isTracking} hts:${o.hasHitTestSource?"yes":"no"}`;Og=0,G.DrawLabel(t,n,void 0,1/60*20)}}addScript(t){return this._xr_scripts.includes(t)?!1:(ct&&console.log("Register new XRScript",t),this._xr_scripts.push(t),typeof t.onUpdateXR=="function"&&this._xr_update_scripts.push(t),!0)}markInactive(t){if(!(this._inactive_scripts.indexOf(t)>=0)){this.removeScript(t,!1),this._inactive_scripts.push(t);for(const e of this.controllers)this.invokeCallback_ControllerRemoved(t,e);this.invokeCallback_LeaveXR(t)}}handleInactiveScripts(){if(this._inactive_scripts.length>0)for(let t=this._inactive_scripts.length-1;t>=0;t--){const e=this._inactive_scripts[t];if(e.activeAndEnabled){this._inactive_scripts.splice(t,1),this.addScript(e),this.invokeCallback_EnterXR(e);for(const i of this.controllers)this.invokeCallback_ControllerAdded(e,i)}}}removeScript(t,e=!0){ct&&console.log("Remove XRScript",t);const i=this._xr_scripts.indexOf(t);i>=0&&this._xr_scripts.splice(i,1);const n=this._xr_update_scripts.indexOf(t);if(n>=0&&this._xr_update_scripts.splice(n,1),e){const o=this._inactive_scripts.indexOf(t);o>=0&&this._inactive_scripts.splice(o,1)}}invokeCallback_EnterXR(t){t.onEnterXR&&t.onEnterXR({xr:this})}invokeCallback_ControllerAdded(t,e){t.onXRControllerAdded&&t.onXRControllerAdded({xr:this,controller:e,change:"added"})}invokeCallback_ControllerRemoved(t,e){t.onXRControllerRemoved&&t.onXRControllerRemoved({xr:this,controller:e,change:"removed"})}invokeCallback_LeaveXR(t){t.onLeaveXR&&!t.destroyed&&t.onLeaveXR({xr:this})}syncCameraCullingMask(){var i;const t=this.context.xrCamera,e=(i=this.context.mainCameraComponent)==null?void 0:i.cullingMask;if(t&&e!==void 0){for(const n of t.cameras)n.layers.mask=e;t.layers.mask=e}else if(t){for(const n of t.cameras)n.layers.enableAll();t.layers.enableAll()}}invokeControllerEvent(t,e,i){for(let n=e.length-1;n>=0;n--){const o=e[n];if(o)try{o({xr:this,controller:t,change:i})}catch(r){console.error(r)}}}applyCustomForward(){var t;if(this.context.mainCamera&&this._customforward){this._camera=this.context.mainCamera,this._camera.parent!==this._cameraRenderParent&&(this._previousCameraParent=this._camera.parent,(t=this._previousCameraParent)==null||t.add(this._cameraRenderParent)),this._cameraRenderParent.name="XR Camera Render Parent",this._cameraRenderParent.add(this._camera);{let e=.02;const i=.001;if(this.rig){const n=_t(this.rig.gameObject);e*=n.x}this._camera instanceof Se&&Math.abs(this._camera.near-e)>i&&(this.isAR?this.originalCameraNearPlane=this._camera.near:this._camera.near=e,ct&&console.debug(`Setting camera near plane to ${e} (was ${this.originalCameraNearPlane}) to account for XR rendering scale`))}}}revertCustomForward(){this._camera&&this._previousCameraParent&&this._previousCameraParent.add(this._camera),this._previousCameraParent=null,this._camera instanceof Se&&this.originalCameraNearPlane!=null&&(this._camera.near=this.originalCameraNearPlane,this.originalCameraNearPlane=void 0)}internalUpdateState(){const t=this.context.renderer.xr.getReferenceSpace();if(!t){this._viewerPose=void 0;return}if(this._viewerPose=this.frame.getViewerPose(t),this._viewerPose){const e=this._viewerPose.transform;this._transformPosition.set(e.position.x,e.position.y,e.position.z),this._transformOrientation.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w)}}get transition(){return this._transition||(this._transition=new zv),this._transition}fadeTransition(){return this._transition||(this._transition=new zv),this._transition.fadeTransition()}updateFade(t){this._transition&&t instanceof Se&&this._transition.update(t,this.context.time.deltaTime)}onUpdateFade_PostRender(){var t;(t=this._transition)==null||t.remove()}};let te=Oo;a(te,"_sync",null),a(te,"_currentSessionRequestMode",null),a(te,"_currentSessionRequest"),a(te,"_activeSession"),a(te,"_sessionRequestStartListeners",[]),a(te,"_sessionRequestEndListeners",[]),a(te,"_xrStartListeners",[]),a(te,"_xrEndListeners",[]),a(te,"_controllerAddedListeners",[]),a(te,"_controllerRemovedListeners",[]),a(te,"$_stop_request",Symbol()),a(te,"onEnd",()=>{ct&&console.log("XR Session ended"),Oo._activeSession=null});const kg=S("debugwebxr");class cE{static tryFindAvatarObjects(t,e,i){if(i.head&&i.leftHand&&i.rightHand)return;const n=t.name.toLocaleLowerCase();!i.head&&n.includes("head")&&(kg&&console.log("FOUND AVATAR HEAD",t.name),i.head=new he("",e,t)),n.includes("hand")&&(!i.leftHand&&n.includes("left")&&(kg&&console.log("FOUND AVATAR LEFT HAND",t.name),i.leftHand=new he("",e,t)),!i.rightHand&&n.includes("right")&&(kg&&console.log("FOUND AVATAR RIGHT HAND",t.name),i.rightHand=new he("",e,t)));for(let o=0;o<t.children.length;o++){if(i.head&&i.leftHand&&i.rightHand)return;const r=t.children[o];this.tryFindAvatarObjects(r,e,i)}}}const ci=new x,Wv=new x,Vv=new H,hE=S("debuggizmos"),Xn=8947848,Eg=32,In=class{constructor(){}static isGizmo(t){return t[Zy]!==void 0}static setVisible(t){for(const e of Ne.timedObjectsBuffer)e.visible=t}static DrawLabel(t,e,i=.05,n=0,o,r,l){var d;if(!In.enabled)return null;o||(o=Xn);const c=((d=te.active)==null?void 0:d.rigScale)??1,h=Ne.getTextLabel(n,e,i*c,o,r);return l instanceof D&&l.add(h),h.position.x=t.x,h.position.y=t.y,h.position.z=t.z,h}static DrawRay(t,e,i=Xn,n=0,o=!0){if(!In.enabled)return;const r=Ne.getLine(n),l=r.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),ci.set(e.x,e.y,e.z).multiplyScalar(999999999),l.setXYZ(1,t.x+ci.x,t.y+ci.y,t.z+ci.z),l.needsUpdate=!0,r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1}static DrawDirection(t,e,i=Xn,n=0,o=!0,r=1){if(!In.enabled)return;const l=Ne.getLine(n),c=l.geometry.getAttribute("position");c.setXYZ(0,t.x,t.y,t.z),e.w!==void 0?(ci.set(0,0,-r),Vv.set(e.x,e.y,e.z,e.w),ci.applyQuaternion(Vv)):(ci.set(e.x,e.y,e.z),ci.multiplyScalar(r)),c.setXYZ(1,t.x+ci.x,t.y+ci.y,t.z+ci.z),c.needsUpdate=!0,l.material.color.set(i),l.material.depthTest=o,l.material.depthWrite=!1}static DrawLine(t,e,i=Xn,n=0,o=!0){if(!In.enabled)return;const r=Ne.getLine(n),l=r.geometry.getAttribute("position");l.setXYZ(0,t.x,t.y,t.z),l.setXYZ(1,e.x,e.y,e.z),l.needsUpdate=!0,r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1}static DrawCircle(t,e,i,n=Xn,o=0,r=!0){if(!In.enabled)return;const l=Ne.getCircle(o);l.position.set(t.x,t.y,t.z),l.scale.set(i,i,i),l.quaternion.setFromUnitVectors(this._up,ci.set(e.x,e.y,e.z).normalize()),l.material.color.set(n),l.material.depthTest=r,l.material.depthWrite=!1,l.material.fog=!1}static DrawWireSphere(t,e,i=Xn,n=0,o=!0){if(!In.enabled)return;const r=Ne.getSphere(e,n,!0);Cc(r,t.x,t.y,t.z),r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1,r.material.fog=!1}static DrawSphere(t,e,i=Xn,n=0,o=!0){if(!In.enabled)return;const r=Ne.getSphere(e,n,!1);Cc(r,t.x,t.y,t.z),r.material.color.set(i),r.material.depthTest=o,r.material.depthWrite=!1}static DrawWireBox(t,e,i=Xn,n=0,o=!0,r=void 0){if(!In.enabled)return;const l=Ne.getBox(n);l.position.set(t.x,t.y,t.z),l.scale.set(e.x,e.y,e.z),r?l.quaternion.copy(r):l.quaternion.identity(),l.material.color.set(i),l.material.depthTest=o,l.material.wireframe=!0,l.material.depthWrite=!1,l.material.fog=!1}static DrawWireBox3(t,e=Xn,i=0,n=!0){if(!In.enabled)return;const o=Ne.getBox(i);o.position.copy(t.getCenter(ci)),o.scale.copy(t.getSize(ci)),o.material.color.set(e),o.material.depthTest=n,o.material.wireframe=!0,o.material.depthWrite=!1,o.material.fog=!1}static DrawArrow(t,e,i=Xn,n=0,o=!0,r=!1){if(!In.enabled)return;const l=Ne.getArrowHead(n);l.position.set(e.x,e.y,e.z),l.quaternion.setFromUnitVectors(this._up.set(0,1,0),ci.set(e.x,e.y,e.z).sub(Wv.set(t.x,t.y,t.z)).normalize());const h=ci.set(e.x,e.y,e.z).sub(Wv.set(t.x,t.y,t.z)).length()*.1;l.scale.set(h,h,h),l.material.color.set(i),l.material.depthTest=o,l.material.wireframe=r,this.DrawLine(t,e,i,n,o)}static DrawWireMesh(t){const e=Ne.getMesh(t.duration??0);"mesh"in t?(e.geometry=t.mesh.geometry,e.matrix.copy(t.mesh.matrixWorld)):(e.geometry=t.geometry,e.matrix.copy(t.matrix)),e.matrixAutoUpdate=!1,e.matrixWorldAutoUpdate=!1,e.material.color.set(t.color??Xn),e.material.depthTest=t.depthTest??!0,e.material.wireframe=!0}};let G=In;a(G,"enabled",!0),a(G,"_up",new x(0,1,0));const dE=new bc(1,1,1);function vb(s=null){const t=new de(s??14540253),e=new WP(dE);return new Fw(e,new Q_({color:t}))}const Zy=Symbol("GizmoCache");class Ne{static ensureFont(){let t=ze.FontLibrary.getFontFamily(this.familyName);if(!t){t=ze.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","https://uploads.needle.tools/include/font-msdf.json","https://uploads.needle.tools/include/font.png");e==null||e.addEventListener("ready",()=>{ze.update()})}}static getTextLabel(t,e,i,n,o){this.ensureFont();let r=this.textLabelCache.pop(),l=1;o&&typeof o=="string"&&(o==null?void 0:o.length)>=8&&o.startsWith("#")?(l=parseInt(o.substring(7),16)/255,o=o.substring(0,7),hE&&console.log(o,l)):typeof o=="object"&&o.a!==void 0&&(l=o.a);const c={boxSizing:"border-box",fontFamily:this.familyName,width:"auto",fontSize:i,color:n,lineHeight:1,backgroundColor:o??void 0,backgroundOpacity:l,textContent:e,borderRadius:.5*i,padding:.8*i,whiteSpace:"pre",offset:.05*i};if(r)r.set(c);else{r=new Gw(c);const h=this,d=r;d.setText=function(u){this.set({textContent:u}),h.tmuiNeedsUpdate=!0}}return this.tmuiNeedsUpdate=!0,this.registerTimedObject(ne.Current,r,t,this.textLabelCache),r}static getBox(t){let e=this.boxesCache.pop();if(!e){const i=new bc(1,1,1);e=new X(i)}return this.registerTimedObject(ne.Current,e,t,this.boxesCache),e}static getLine(t){let e=this.linesCache.pop();if(!e){e=new vc;let i=e.geometry.getAttribute("position");i||(i=new Hi(new Float32Array(2*3),3),e.geometry.setAttribute("position",i))}return e.frustumCulled=!1,this.registerTimedObject(ne.Current,e,t,this.linesCache),e}static getCircle(t){let e=this.circlesCache.pop();if(!e){e=new vc;let i=e.geometry.getAttribute("position");if(!i){i=new Hi(new Float32Array(Eg*3),3),e.geometry.setAttribute("position",i);const n=q(0,1,0),o=q(0,0,1),r=q(o);r.cross(n).normalize();const l=q(r),c=Math.PI*2/(Eg-1);for(let h=0;h<Eg+1;h++){const d=c*h;n.copy(l).multiplyScalar(Math.cos(d)*1),r.copy(o).multiplyScalar(Math.sin(d)*1);const u=n.add(r);i.setXYZ(h,u.x,u.y,u.z)}}}return e.frustumCulled=!1,this.registerTimedObject(ne.Current,e,t,this.circlesCache),e}static getSphere(t,e,i){let n=this.spheresCache.pop();return n||(n=new X(new Wp(1,8,8))),n.scale.set(t,t,t),n.material.wireframe=i,this.registerTimedObject(ne.Current,n,e,this.spheresCache),n}static getArrowHead(t){let e=this.arrowHeadsCache.pop();return e||(e=new X(new jw(0,.5,1,8))),this.registerTimedObject(ne.Current,e,t,this.arrowHeadsCache),e}static getMesh(t){let e=this.mesh.pop();return e||(e=new X,e.material=new Be),this.registerTimedObject(ne.Current,e,t,this.mesh),e}static registerTimedObject(t,e,i,n){if(!t){console.error("No Needle Engine context available. Did you call a Gizmos function in global scope?");return}const o=this.contextBeforeRenderCallbacks.get(t),r=this.contextPostRenderCallbacks.get(t);if(o){if(t.pre_render_callbacks[t.pre_render_callbacks.length-1]!==o){const l=t.pre_render_callbacks.indexOf(o);l>=0&&t.pre_render_callbacks.splice(l,1),t.pre_render_callbacks.push(o)}}else{const l=()=>{this.onBeforeRender(t,this.timedObjectsBuffer)};this.contextBeforeRenderCallbacks.set(t,l),t.pre_render_callbacks.push(l)}if(r){if(t.post_render_callbacks[t.post_render_callbacks.length-1]!==r){const l=t.post_render_callbacks.indexOf(r);l>=0&&t.post_render_callbacks.splice(l,1),t.post_render_callbacks.push(r)}}else{const l=()=>{this.onPostRender(t,this.timedObjectsBuffer,this.timesBuffer)};this.contextPostRenderCallbacks.set(t,l),t.post_render_callbacks.push(l)}e.traverse(l=>{l.layers.disableAll(),l.layers.enable(2)}),e.renderOrder=999999,e[Zy]=n,e.castShadow=!1,e.receiveShadow=!1,e.isGizmo=!0,this.timedObjectsBuffer.push(e),this.timesBuffer.push(ne.Current.time.realtimeSinceStartup+i),t.scene.add(e)}static onBeforeRender(t,e){this.tmuiNeedsUpdate&&(this.tmuiNeedsUpdate=!1,ze.update());for(let i=0;i<e.length;i++){const n=e[i];if(t.mainCamera&&n instanceof ze.MeshUIBaseElement){if(kc(n))continue;const o=t.isInVR,r=!1,l=!o;Zp(n,t.mainCamera,r,l)}}}static onPostRender(t,e,i){const n=t.time.realtimeSinceStartup;for(let o=e.length-1;o>=0;o--){const r=e[o];n>=i[o]-1e-6&&(e.splice(o,1),i.splice(o,1),r.removeFromParent(),kc(r)!=!0&&r[Zy].push(r))}}}a(Ne,"familyName","needle-gizmos"),a(Ne,"linesCache",[]),a(Ne,"circlesCache",[]),a(Ne,"spheresCache",[]),a(Ne,"boxesCache",[]),a(Ne,"arrowHeadsCache",[]),a(Ne,"mesh",[]),a(Ne,"textLabelCache",[]),a(Ne,"timedObjectsBuffer",new Array),a(Ne,"timesBuffer",new Array),a(Ne,"contextPostRenderCallbacks",new Map),a(Ne,"contextBeforeRenderCallbacks",new Map),a(Ne,"tmuiNeedsUpdate",!1);const Ei=S("debugphysics"),Hv=new Vr;class Kr{constructor(){a(this,"ray");a(this,"cam");a(this,"screenPoint");a(this,"raycaster");a(this,"results");a(this,"targets");a(this,"recursive",!0);a(this,"minDistance");a(this,"maxDistance");a(this,"lineThreshold");a(this,"layerMask");a(this,"ignore");a(this,"testObject");a(this,"useAcceleratedRaycast");a(this,"allowSlowRaycastFallback",!0)}screenPointFromOffset(t,e){this.screenPoint===void 0&&(this.screenPoint=new le),this.screenPoint.x=t/window.innerWidth*2-1,this.screenPoint.y=-(e/window.innerHeight)*2+1}setLayer(t){Hv.set(t),this.layerMask=Hv}setMask(t){this.layerMask||(this.layerMask=new Vr);const e=this.layerMask;e?e.mask=t:this.layerMask=t}}a(Kr,"AllLayers",4294967295);class wC{constructor(t,e,i){a(this,"distance");a(this,"point");a(this,"object");this.object=t,this.distance=e,this.point=i}}const Ep=class{constructor(t){a(this,"context");a(this,"engine");a(this,"raycaster",new Vp);a(this,"defaultRaycastOptions",new Kr);a(this,"targetBuffer",new Array(1));a(this,"defaultThresholds",{Mesh:{},Line:{threshold:-1},LOD:{},Points:{threshold:0},Sprite:{}});a(this,"sphereResults",new Array);a(this,"sphereMask",new Vr);a(this,"sphere",new Hp);a(this,"tempBoundingBox",new Nn);this.context=t}static get raycasting(){return this._raycasting>0}raycastPhysicsFast(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycast(t,e,{maxDistance:i,solid:n}))??null}raycastPhysicsFastAndGetNormal(t,e=void 0,i=1/0,n=!0){var o;return((o=this.context.physics.engine)==null?void 0:o.raycastAndGetNormal(t,e,{maxDistance:i,solid:n}))??null}sphereOverlapPhysics(t,e){var i;return((i=this.context.physics.engine)==null?void 0:i.sphereOverlap(t,e))??null}sphereOverlap(t,e,i=!0,n=!1,o=null){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const r=this.sphereMask;r.enableAll(),r.disable(2);for(const l of this.context.scene.children)this.intersectSphere(l,t,e,r,this.sphereResults,i,n,o);return this.sphereResults.sort((l,c)=>l.distance-c.distance)}raycastFromRay(t,e=null){const i=e??this.defaultRaycastOptions;i.ray=t;const n=this.raycast(i);return i===this.defaultRaycastOptions&&(i.ray=void 0),n}raycast(t=null){Ei&&performance.mark("raycast.start"),t||(t=this.defaultRaycastOptions);const e=t.screenPoint??this.context.input.mousePositionRC,i=t.raycaster??this.raycaster;if(i.near=t.minDistance??0,i.far=t.maxDistance??1/0,i.params=this.defaultThresholds,t.lineThreshold===void 0&&(t.lineThreshold=-1),i.params.Line={threshold:t.lineThreshold},t.ray)i.ray.copy(t.ray);else{const l=t.cam??this.context.mainCamera;if(!l)return Ei&&console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),this.defaultRaycastOptions.results??[];const c=this.context.xrCamera;this.context.isInXR&&c instanceof VP&&c.cameras.length>0?i.setFromCamera(e,c.cameras[0]):i.setFromCamera(e,l)}let n=t.targets;n||(n=this.targetBuffer,n.length=1,n[0]=this.context.scene);let o=t.results;this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),t.layerMask!==void 0?t.layerMask instanceof Vr?i.layers.mask=t.layerMask.mask:i.layers.mask=t.layerMask:(i.layers.enableAll(),i.layers.disable(2)),Ei&&console.time("raycast"),o.length=0,Ep._raycasting++,this.intersect(this.raycaster,n,o,t),o.sort((l,c)=>l.distance-c.distance);const r=t.ignore;return r!==void 0&&r.length>0&&(o=o.filter(l=>!r.includes(l.object))),Ep._raycasting--,Ei&&(console.timeEnd("raycast"),console.warn("#"+this.context.time.frame+", hits:",o!=null&&o.length?[...o]:"nothing"),performance.mark("raycast.end"),performance.measure("raycast","raycast.start","raycast.end")),o}intersect(t,e,i,n){var o,r,l;for(const c of e){if(!c||c.visible===!1||G.isGizmo(c)||n.lineThreshold!==void 0&&n.lineThreshold<0&&c instanceof vc)continue;let h=!0;const d=c,u=d.geometry;if(n.testObject){const f=(o=n.testObject)==null?void 0:o.call(n,c);if(f===!1)continue;f==="continue in children"&&(h=!1)}if(h&&(u&&Gv(u)||(h=!1)),h){const f=eS(c);f&&(d.geometry=f);const p=i.length;let g=!0;if(n.precise===!1&&(g=!1),g||(g=((l=(r=u.getAttribute("position"))==null?void 0:r.array)==null?void 0:l.length)<64),d instanceof Sc&&(g=!1),!g&&fE(d,t,i)||(n.useAcceleratedRaycast!==!1?Xf.runMeshBVHRaycast(t,d,i,this.context,n):t.intersectObject(d,!1,i)),Ei&&i.length!=p){const _=i[i.length-1],y=f?8969557:7798784;G.DrawWireSphere(_.point,.1,y,1,!1),G.DrawWireMesh({mesh:c,depthTest:!1,duration:.2,color:y})}d.geometry=u}n.recursive!==!1&&this.intersect(t,c.children,i,n)}return i}intersectSphere(t,e,i,n,o,r,l,c){let h=t&&t.isMesh&&t.layers.test(n)&&!G.isGizmo(t);h&&(h=t.visible),h&&(h=!(t instanceof vc)),h&&(h=!(t instanceof Sc));const d=t,u=d.geometry;if(h&&c){const f=c(t);if(f===!1)return;f==="continue in children"&&(h=!1)}if(u&&Gv(u)||(h=!1),h){if(l){const f=this.sphere;f.center.copy(e),f.radius=i;const p=o.length;if(Xf.runMeshBVHRaycast(this.sphere,d,o,this.context,{}),p!=o.length&&!r)return}else if(u.boundingBox||u.computeBoundingBox(),u.boundingBox){d.matrixWorldNeedsUpdate&&d.updateWorldMatrix(!1,!1);const f=this.tempBoundingBox.copy(u.boundingBox).applyMatrix4(d.matrixWorld),p=this.sphere;if(p.center.copy(e),p.radius=i,p.intersectsBox(f)){const g=ae(t),_=g.distanceTo(p.center),y=new wC(t,_,g);if(o.push(y),!r)return}}}if(t.children)for(const f of t.children){const p=o.length;if(this.intersectSphere(f,e,i,n,o,r,l,c),p!=o.length&&!r)return}}};let Zh=Ep;a(Zh,"_raycasting",0);function Gv(s){return!(s.index&&s.index.array.length<3)}const _a=new Hp,Uu=new Za,uE=new Lw;function fE(s,t,e){const i=s._computeIntersections;if(!i)return!1;let n=s["_computeIntersections:Needle"];return n||(n=s["_computeIntersections:Needle"]=function(o,r,l){const c=this,h=c.geometry.boundingSphere;if(h){if(c instanceof Sc){Uu.setFromNormalAndCoplanarPoint(q(0,1,0),q(0,-c.position.y,0)),Uu.applyMatrix4(c.matrixWorld,uE);const u=o.ray.intersectPlane(Uu,q());if(u){_a.copy(h),_a.applyMatrix4(c.matrixWorld);const p=q(u).sub(o.ray.origin).length(),g=_a.radius*.5;p<g&&r.push({distance:p,point:u,object:c,normal:Uu.normal.clone()})}return}_a.copy(h),_a.applyMatrix4(c.matrixWorld);const d=o.ray.intersectSphere(_a,q());if(d){const u=q(d).sub(o.ray.origin),f=u.length();if(f>_a.radius){const p=u.clone().normalize();r.push({distance:f,point:d,object:c,normal:p})}}}}),s._computeIntersections=n,t.intersectObject(s,!1,e),s._computeIntersections=i,!0}var Xf;(function(s){function t(b,v,w,P,E){var k,z,L;if(!v.geometry||!v.geometry.hasAttribute("position"))return!1;const T=v.geometry;if(v!=null&&v.isSkinnedMesh){const O=v,A=O.bvhNeedsUpdate;if(!O.staticGenerator)l(),o&&(O.staticGenerator=new o(v),O.staticGenerator.applyWorldTransforms=!1,O.staticGeometry=O.staticGenerator.generate(),T.boundsTree=r==null?void 0:r.call(O.staticGeometry),O.staticGeometryLastUpdate=performance.now()+Math.random()*200,O.bvhNeedsUpdate=!0);else if(T.boundsTree&&(O.autoUpdateMeshBvhInterval!==void 0&&O.autoUpdateMeshBvhInterval>=0||A===!0)){const $=performance.now(),B=$-O.staticGeometryLastUpdate,I=O.autoUpdateMeshBvhInterval??100;(A||B>I)&&(Ei&&console.warn(`Physics: updating skinned mesh bvh for ${v.name} after ${B.toFixed(2)}ms`),O.bvhNeedsUpdate=!1,O.staticGeometryLastUpdate=$,(k=O.staticGenerator)==null||k.generate(O.staticGeometry),T.boundsTree.refit())}}else if(!T.boundsTree){h||y();let O=!0;if((P.xr||T[p]===!1||(z=T.getAttribute("position"))!=null&&z.isInterleavedBufferAttribute||T.index&&((L=T.index)!=null&&L.isInterleavedBufferAttribute))&&(O=!1),O&&u){if(T[f]===void 0){let A=null;if(_.length>0){const $=_.shift();$&&!$.running&&(A=$)}if(!A&&g.length<3&&(A=new u,g.push(A)),A!=null&&!A.running){const $=v.name;Ei&&console.log("<<<< worker start",$,A),T[f]="queued",performance.mark("bvh.create.start");const B=T.clone();try{A.generate(B).then(I=>{T[f]="done",T.boundsTree=I}).catch(I=>{T[f]="failed - "+(I==null?void 0:I.message),T[p]=!1,Ei&&console.error("Failed to generate mesh bvh on worker",I)}).finally(()=>{Ei&&console.log(">>>>> worker done",$,{hasBoundsTre:T.boundsTree!=null}),_.push(A),B.dispose(),performance.mark("bvh.create.end"),performance.measure("bvh.create (worker)","bvh.create.start","bvh.create.end")})}catch(I){console.error("Failed to generate mesh bvh on worker",I)}}else Ei&&console.warn("No worker available")}}else(!d||!O)&&(l(),n&&(performance.mark("bvh.create.start"),T.boundsTree=new n(T),performance.mark("bvh.create.end"),performance.measure("bvh.create","bvh.create.start","bvh.create.end")))}if(b instanceof Vp){const O=b,A=v.raycast;if(T.boundsTree)l(),i&&(v.acceleratedRaycast||(v.acceleratedRaycast=i.bind(v),Ei&&console.debug(`Physics: bind acceleratedRaycast fn to "${v.name}"`)),v.raycast=v.acceleratedRaycast);else if(Ei&&console.warn("No bounds tree found for mesh",v.name,{workerTask:T[f],hasAcceleratedRaycast:i!=null}),E.allowSlowRaycastFallback===!1)return Ei&&console.warn("Skipping raycast because no bounds tree is available and allowSlowRaycastFallback is false"),!1;const $=O.firstHitOnly;return O.firstHitOnly=!1,O.intersectObject(v,!1,w),O.firstHitOnly=$,v.raycast=A,!0}else if(b instanceof Hp){const O=T.boundsTree;if(O){const A=b;if(c.copy(v.matrixWorld).invert(),A.applyMatrix4(c),O.intersectsSphere(A)){const B=ae(v),I=B.distanceTo(A.center),V=new wC(v,I,B);w.push(V)}}return!0}return!1}s.runMeshBVHRaycast=t;let e=!1,i=null,n=null,o=null,r=null;function l(){e||(e=!0,rs(()=>import("./index.23a76d04.js"),["./index.23a76d04.js","./MeshBVH.6b36b726.js","./three@0.169.11.js"],import.meta.url).then(b=>{i=b.acceleratedRaycast,n=b.MeshBVH,o=b.StaticGeometryGenerator,r=b.computeBoundsTree}).catch(b=>{(Ei||U())&&console.error("Failed to load BVH library...",b.message)}))}const c=new ce;let h=!1,d=!1,u=null;const f=Symbol("Needle:MeshBVH-Worker"),p=Symbol("Needle:MeshBVH-CanUseWorker"),g=[],_=[];function y(){h=!0,d=!0,rs(()=>import("./GenerateMeshBVHWorker.14b9b801.js"),["./GenerateMeshBVHWorker.14b9b801.js","./three@0.169.11.js","./MeshBVH.6b36b726.js"],import.meta.url).then(b=>{u=b.GenerateMeshBVHWorker}).catch(b=>{(Ei||U())&&console.warn("Failed to setup mesh bvh worker")}).finally(()=>{d=!1})}})(Xf||(Xf={}));const qv=Symbol("gltf-loader-internal-usage-tracker"),pE=S("debugusers"),Td=class{constructor(t){a(this,"parser");a(this,"_getDependency");a(this,"_loadingId");a(this,"_loadedObjects",new Set);this.parser=t,this._getDependency=this.parser.getDependency,this._loadingId=Date.now().toString()}get name(){return"NEEDLE_internal_usage_tracker"}static isLoading(t){return Td._loadingProcesses>0}beforeRoot(){Td._loadingProcesses++;const t=this,e=this._getDependency;return this.parser.getDependency=function(i,n){const o=e.call(this,i,n);return o.then(r=>(r&&(t._loadedObjects.add(r),r[qv]=t._loadingId),r)),o},null}afterRoot(t){Td._loadingProcesses--,this.parser.getDependency=this._getDependency;for(const e of this._loadedObjects)delete e[qv],e instanceof D&&(e.parent||e instanceof X&&setTimeout(()=>{pE&&console.warn("> GLTF LOADER: Mesh not used in scene!",e),e.material=null,e.geometry=null},1e3));return null}};let ed=Td;a(ed,"_loadingProcesses",0);class mE{constructor(){window.addEventListener("unhandledrejection",t=>{var i;if(t.defaultPrevented)return;const e=(i=t==null?void 0:t.reason)==null?void 0:i.path;if(e){const n=e[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),t.preventDefault())}})}}const sm=S("trackresources");function SC(){return sm==="dispose"}let cl=!0;sm===0&&(cl=!1);function b3(s){cl=s}function gE(){return cl}const CC=Symbol("disposable");function yE(s,t){s&&(s[CC]=t,Ha&&console.warn("Set disposable",t,s))}const PC=Symbol("disposed");function v3(s){return s[PC]===!0}function Ye(s){var t;if(s){if(s[CC]===!1){Ha&&console.warn("Object is marked as not disposable",s);return}if(typeof s=="object"&&(s[PC]=!0),s instanceof bn)Ye(s.environment),Ye(s.background),Ye(s.customDepthMaterial),Ye(s.customDistanceMaterial);else if(s instanceof Ir)Ye(s.geometry),Ye(s.material),Ye(s.skeleton),Ye(s.bindMatrix),Ye(s.bindMatrixInverse),Ye(s.customDepthMaterial),Ye(s.customDistanceMaterial),s.visible=!1;else if(s instanceof X)Ye(s.geometry),Ye(s.material),Ye(s.customDepthMaterial),Ye(s.customDistanceMaterial),s.visible=!1;else if(s instanceof D)s.visible=!1;else if(s instanceof os){Cl(s);for(const e of Object.keys(s.attributes)){const i=s.attributes[e];Ye(i)}}else if(s instanceof Hi||s instanceof zw)Ha&&console.warn("BufferAttribute dispose not supported",s.count);else if(s instanceof Array)for(const e of s)e instanceof Ie&&Ye(e);else if(s instanceof Ie){Cl(s);for(const i of Object.keys(s)){const n=s[i];n instanceof Ke&&Ye(n)}const e=s.uniforms;if(e)for(const i of Object.keys(e)){const n=e[i];n instanceof Ke?Ye(n):n instanceof Un&&Ye(n.value)}}else s instanceof Ke?(Cl(s),Cl(s.source),((t=s.source)==null?void 0:t.data)instanceof ImageBitmap&&Cl(s.source.data)):s instanceof HP?(Cl(s.boneTexture),s.boneTexture=null):s instanceof GP||!(s instanceof D)&&Ha&&console.warn("Unknown object type",s)}}function Cl(s){s&&((Ha||SC()||sm)&&console.warn("ðŸ§¨ FREE",s),s instanceof ImageBitmap||"dispose"in s&&typeof s.dispose=="function"&&s.dispose())}function x3(s){}const _E=new Set;function RC(s,t,e=null,i){if(i||(i=_E,i.clear()),!s)return i;const n=s[Wd];if(n)for(const o of n)i.has(o)||(e==null?void 0:e.call(null,o))!==!1&&(i.add(o),t&&RC(o,!0,e,i));return i}function w3(s){return s[$h]}const Ha=S("debugresourceusers")||S("debugmemory"),Wd=Symbol("needle-resource-users"),$h=Symbol("needle-resource-users-count");function wi(s,t){hb(s,t,function(e,i){cl&&!Zh.raycasting&&(Qf(Wd,this,e,!1),Qf(Wd,this,i,!0))})}cl&&(wi(X.prototype,"material"),wi(X.prototype,"geometry"),wi(Ie.prototype,"map"),wi(Ie.prototype,"bumpMap"),wi(Ie.prototype,"alphaMap"),wi(Ie.prototype,"normalMap"),wi(Ie.prototype,"displacementMap"),wi(Ie.prototype,"roughnessMap"),wi(Ie.prototype,"metalnessMap"),wi(Ie.prototype,"emissiveMap"),wi(Ie.prototype,"specularMap"),wi(Ie.prototype,"envMap"),wi(Ie.prototype,"lightMap"),wi(Ie.prototype,"aoMap"),wi(Ie.prototype,"gradientMap"));function bE(s){if(cl===!1)return;const t=s[Wd];if(t)for(const e of t)Qf(Wd,e,s,!1)}cl&&hb(Ie.prototype,"dispose",function(){bE(this)});let e_=0;function Qf(s,t,e,i){if(e_>0)return;if(Array.isArray(e)){for(const o of e)Qf(s,t,o,i);return}if(!e)return;let n=e[s];if(n||(n=new Set),i){if(t&&!n.has(t)){n.add(t);let o=e[$h]||0;o+=1,e[$h]=o,Ha&&console.warn(`ðŸŸ¢ Added user of "${e.type}"`,t,e,o,"users:",n)}}else if(t&&n.has(t)){n.delete(t);let o=e[$h]||0;o>0&&(o-=1,e[$h]=o),Ha&&console.warn(`ðŸ”´ Removed user of "${e.type}"`,t,e,o,"users:",n),o<=0&&(ed.isLoading(e)||(sm&&console.warn(`ðŸ”´ Removed all user of "${e.type}"`,e),SC()&&Ye(e)))}e[s]=n}try{hb(ol.prototype,"render",function(){e_++},function(){e_--})}catch(s){console.warn("Could not wrap WebGLRenderer.render",s)}const Xv=S("debugcomponentevents");class om{static addComponentLifecylceEventListener(t,e){this.eventListeners.has(t)&&this.eventListeners.set(t,[]);let i=this.eventListeners.get(t);i||(i=[]),i.push(e),this.eventListeners.set(t,i),Xv&&console.log("Added event listener for "+t,this.eventListeners)}static removeComponentLifecylceEventListener(t,e){const i=this.eventListeners.get(t);if(!i)return;const n=i.indexOf(e);n<0||i.splice(n,1)}static dispatchComponentLifecycleEvent(t,e){const i=this.eventListeners.get(t);if(Xv&&console.log("Dispatching event "+t,i),!!i)for(const n of i)n(e)}}a(om,"eventListeners",new Map);const Vd=Symbol("NEEDLE_NEED_UPDATE_INSTANCE"),TC=Symbol("isUsingInstancing"),OC=Symbol("instancingRenderer"),Wh=Symbol("instancingAutoUpdateBounds");class cs{static isUsingInstancing(t){return t[TC]===!0}static getRenderer(t){return t[OC]||null}setAutoUpdateBounds(t,e){const i=cs.getRenderer(t);i&&(i[Wh]=e)}static markDirty(t,e=!0){if(t&&(this.isUsingInstancing(t)&&(t[Vd]=!0,t.matrixWorldNeedsUpdate=!0),e))for(const i of t.children)cs.markDirty(i,!0)}}var Yf;(function(s){s.experimentalSmartHierarchyUpdate=!1})(Yf||(Yf={}));function dc(s,t){try{t?s(t):s()}catch(e){return console.error(e),!1}return!0}const t_=S("debugnewscripts"),vE=S("debughierarchy"),qe=[];function xE(){return qe.length>0}function Kf(s){if(t_&&console.log("Register new components",s.new_scripts.length,[...s.new_scripts],s.alias?"element: "+s.alias:s.hash,s),s.new_scripts_pre_setup_callbacks.length>0){for(const t of s.new_scripts_pre_setup_callbacks)t&&t();s.new_scripts_pre_setup_callbacks.length=0}if(!(s.new_scripts.length<=0)){qe.length=0,s.new_scripts.length>0&&qe.push(...s.new_scripts),s.new_scripts.length=0;for(let t=0;t<qe.length;t++)try{const e=qe[t];if(e.isComponent!==!0){(U()||t_)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,e),qe.splice(t,1),t--;continue}if(e.destroyed)continue;if(!e.gameObject){console.warn(`Component can not be initialized: no GameObject assigned.
Did you add and remove a component in the same frame?`),qe.splice(t,1),t--;continue}e.context=s,td(e.gameObject),xb(e,s)}catch(e){console.error(e),Ao(qe[t],s),qe.splice(t,1),t--}for(let t=0;t<qe.length;t++)try{const e=qe[t];if(e.destroyed){Ao(qe[t],s),qe.splice(t,1),t--;continue}if(e.registering)try{e.registering()}catch(i){console.error(i)}e.__internalAwake!==void 0&&(e.gameObject||console.error("Calling awake for a component without a GameObject",e,e.gameObject),td(e.gameObject),e.activeAndEnabled&&dc(e.__internalAwake.bind(e)))}catch(e){console.error(e),Ao(qe[t],s),qe.splice(t,1),t--}for(let t=0;t<qe.length;t++)try{const e=qe[t];if(e.destroyed||e.enabled===!1||(td(e.gameObject),e.activeAndEnabled===!1))continue;e.__internalEnable!==void 0&&(e.enabled=!0,dc(e.__internalEnable.bind(e)))}catch(e){console.error(e),Ao(qe[t],s),qe.splice(t,1),t--}for(let t=0;t<qe.length;t++)try{const e=qe[t];if(e.destroyed||!e.gameObject)continue;s.new_script_start.push(e)}catch(e){console.error(e),Ao(qe[t],s),qe.splice(t,1),t--}qe.length=0;for(const t of s.new_scripts_post_setup_callbacks)t&&t();s.new_scripts_post_setup_callbacks.length=0}}function wE(s){s&&(s.__internalDisable(!0),Ao(s,s.context))}function kC(s,t){for(let e=0;e<s.new_script_start.length;e++)try{const i=s.new_script_start[e];if(t!==void 0&&i.gameObject!==t||i.destroyed||i.activeAndEnabled===!1)continue;dc(i.__internalAwake.bind(i)),i.enabled&&(dc(i.__internalEnable.bind(i)),dc(i.__internalStart.bind(i)),s.new_script_start.splice(e,1),e--)}catch(i){console.error(i),Ao(s.new_script_start[e],s),s.new_script_start.splice(e,1),e--}}function xb(s,t){t.scripts.indexOf(s)===-1&&(t.scripts.push(s),s.earlyUpdate&&t.scripts_earlyUpdate.push(s),s.update&&t.scripts_update.push(s),s.lateUpdate&&t.scripts_lateUpdate.push(s),s.onBeforeRender&&t.scripts_onBeforeRender.push(s),s.onAfterRender&&t.scripts_onAfterRender.push(s),s.onPausedChanged&&t.scripts_pausedChanged.push(s),Mg(s,null)&&t.new_scripts_xr.push(s),Mg(s,"immersive-vr")&&t.scripts_immersive_vr.push(s),Mg(s,"immersive-ar")&&t.scripts_immersive_ar.push(s))}function Ao(s,t){kn(s,t.new_scripts),kn(s,t.new_script_start),kn(s,t.scripts),kn(s,t.scripts_earlyUpdate),kn(s,t.scripts_update),kn(s,t.scripts_lateUpdate),kn(s,t.scripts_onBeforeRender),kn(s,t.scripts_onAfterRender),kn(s,t.scripts_pausedChanged),kn(s,t.new_scripts_xr),kn(s,t.scripts_immersive_vr),kn(s,t.scripts_immersive_ar),t.stopAllCoroutinesFrom(s)}function kn(s,t){const e=t.indexOf(s);e>=0&&t.splice(e,1)}function Mg(s,t){var e;if(s){const i=s;if(i.onBeforeXR||i.onEnterXR||i.onUpdateXR||i.onLeaveXR||i.onXRControllerAdded||i.onXRControllerRemoved)return!(t!=null&&((e=i.supportsXR)==null?void 0:e.call(i,t))===!1)}return!1}let i_=!0;function Ag(){i_=!0}function Cf(s,t=!1){if(Yf.experimentalSmartHierarchyUpdate){if(!t&&!i_)return;i_=!1}if(s||(s=ve.Current.scene),!s){console.trace("Invalid call - no current context.");return}const e=su(s);EC(s,e,!0)||(t_||U()?console.error(`Error updating hierarchy
Do you have circular references in your project? <a target="_blank" href="https://docs.needle.tools/circular-reference"> Click here for more information.`,s):console.error('Failed to update active state in hierarchy of "'+s.name+'"',s),console.warn(" â†‘ this error might be caused by circular references. Please make sure you don't have files with circular references (e.g. one GLB 1 is loading GLB 2 which is then loading GLB 1 again)."))}function EC(s,t,e,i=0){if(i>1e3)return console.warn("Hierarchy is too deep (> 1000 level) - will abort updating active state"),!1;const n=su(s);if(t&&(t=n,t&&s.parent&&i===0)){const c=s.parent;t=c[jr],t===void 0&&(c instanceof bn||(t=!0))}const r=s[jr]!==t;r&&(s[jr]=t,vE&&console.warn("ACTIVE CHANGE",s.name,n,s.visible,t,"changed?"+r,s),e&&SE(s,c=>{t?c.enabled&&(dc(c.__internalAwake.bind(c)),c.enabled&&c.__internalEnable()):c.__didAwake&&c.enabled&&(c.__didEnable=!1,c.onDisable())}));let l=!0;if(s.children)for(const c of s.children)EC(c,t,e,i+1)===!1&&(l=!1);return l}function td(s){let t=!0,e=s,i=!1;for(;e&&e;){if(e.type==="Scene"&&(i=!0),!su(e)){t=!1;break}e=e.parent}if(!s){console.error("GO is null");return}s[jr]=t&&i}function SE(s,t){var e;if((e=s.userData)!=null&&e.components)for(const i of s.userData.components)t(i)}const Pf=new Map,MC=Symbol("prewarmFlag"),n_=Symbol("waitingForPrewarm"),s_=S("debugprewarm");function CE(s,t){if(!s||s[MC]===!0||s[n_]===!0)return;Pf.has(t)||Pf.set(t,[]),s[n_]=!0,Pf.get(t).push(s),s_&&console.debug("register prewarm",s.name)}let Qv=null,Yv=null;function PE(s){if(!s)return;const t=Pf.get(s);if(!(t!=null&&t.length))return;const e=s.mainCamera;if(e){s_&&console.log("prewarm",t.length,"objects",[...t]);const i=s.renderer;if(i.compile){const n=s.scene;i.compile(n,e),Qv??(Qv=new qP(64)),Yv??(Yv=new XP(.001,9999999,Qv)),Yv.update(i,n);for(const o of t)o[MC]=!0,o[n_]=!1;t.length=0,s_&&console.log("prewarm done")}}}const RE=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function TE(s){return typeof s=="string"&&RE.test(s)}const qt=[];for(let s=0;s<256;++s)qt.push((s+256).toString(16).slice(1));function OE(s,t=0){return qt[s[t+0]]+qt[s[t+1]]+qt[s[t+2]]+qt[s[t+3]]+"-"+qt[s[t+4]]+qt[s[t+5]]+"-"+qt[s[t+6]]+qt[s[t+7]]+"-"+qt[s[t+8]]+qt[s[t+9]]+"-"+qt[s[t+10]]+qt[s[t+11]]+qt[s[t+12]]+qt[s[t+13]]+qt[s[t+14]]+qt[s[t+15]]}function kE(s){if(!TE(s))throw TypeError("Invalid UUID");let t;const e=new Uint8Array(16);return e[0]=(t=parseInt(s.slice(0,8),16))>>>24,e[1]=t>>>16&255,e[2]=t>>>8&255,e[3]=t&255,e[4]=(t=parseInt(s.slice(9,13),16))>>>8,e[5]=t&255,e[6]=(t=parseInt(s.slice(14,18),16))>>>8,e[7]=t&255,e[8]=(t=parseInt(s.slice(19,23),16))>>>8,e[9]=t&255,e[10]=(t=parseInt(s.slice(24,36),16))/1099511627776&255,e[11]=t/4294967296&255,e[12]=t>>>24&255,e[13]=t>>>16&255,e[14]=t>>>8&255,e[15]=t&255,e}function EE(s){s=unescape(encodeURIComponent(s));const t=[];for(let e=0;e<s.length;++e)t.push(s.charCodeAt(e));return t}const ME="6ba7b810-9dad-11d1-80b4-00c04fd430c8",AE="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function IE(s,t,e){function i(n,o,r,l){var c;if(typeof n=="string"&&(n=EE(n)),typeof o=="string"&&(o=kE(o)),((c=o)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let h=new Uint8Array(16+n.length);if(h.set(o),h.set(n,o.length),h=e(h),h[6]=h[6]&15|t,h[8]=h[8]&63|128,r){l=l||0;for(let d=0;d<16;++d)r[l+d]=h[d];return r}return OE(h)}try{i.name=s}catch{}return i.DNS=ME,i.URL=AE,i}function DE(s,t,e,i){switch(s){case 0:return t&e^~t&i;case 1:return t^e^i;case 2:return t&e^t&i^e&i;case 3:return t^e^i}}function Ig(s,t){return s<<t|s>>>32-t}function LE(s){const t=[1518500249,1859775393,2400959708,3395469782],e=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof s=="string"){const r=unescape(encodeURIComponent(s));s=[];for(let l=0;l<r.length;++l)s.push(r.charCodeAt(l))}else Array.isArray(s)||(s=Array.prototype.slice.call(s));s.push(128);const i=s.length/4+2,n=Math.ceil(i/16),o=new Array(n);for(let r=0;r<n;++r){const l=new Uint32Array(16);for(let c=0;c<16;++c)l[c]=s[r*64+c*4]<<24|s[r*64+c*4+1]<<16|s[r*64+c*4+2]<<8|s[r*64+c*4+3];o[r]=l}o[n-1][14]=(s.length-1)*8/Math.pow(2,32),o[n-1][14]=Math.floor(o[n-1][14]),o[n-1][15]=(s.length-1)*8&4294967295;for(let r=0;r<n;++r){const l=new Uint32Array(80);for(let p=0;p<16;++p)l[p]=o[r][p];for(let p=16;p<80;++p)l[p]=Ig(l[p-3]^l[p-8]^l[p-14]^l[p-16],1);let c=e[0],h=e[1],d=e[2],u=e[3],f=e[4];for(let p=0;p<80;++p){const g=Math.floor(p/20),_=Ig(c,5)+DE(g,h,d,u)+f+t[g]+l[p]>>>0;f=u,u=d,d=Ig(h,30)>>>0,h=c,c=_}e[0]=e[0]+c>>>0,e[1]=e[1]+h>>>0,e[2]=e[2]+d>>>0,e[3]=e[3]+u>>>0,e[4]=e[4]+f>>>0}return[e[0]>>24&255,e[0]>>16&255,e[0]>>8&255,e[0]&255,e[1]>>24&255,e[1]>>16&255,e[1]>>8&255,e[1]&255,e[2]>>24&255,e[2]>>16&255,e[2]>>8&255,e[2]&255,e[3]>>24&255,e[3]>>16&255,e[3]>>8&255,e[3]&255,e[4]>>24&255,e[4]>>16&255,e[4]>>8&255,e[4]&255]}const jE=IE("v5",80,LE),Kv=jE;ve.registerCallback(ge.ContextCreated,s=>{const t=s.context;NE(t),FE(t)});const Jf=S("debugcomponents"),Jv="eff8ba80-635d-11ec-90d6-0242ac120003";class yi{constructor(t){a(this,"_originalSeed");a(this,"_seed");typeof t=="string"&&(t=yi.hash(t)),this._originalSeed=t,this._seed=t}get seed(){return this._seed}set seed(t){this._seed=t}reset(){this._seed=this._originalSeed}generateUUID(t){if(typeof t=="string")return Kv(t,Jv);const e=this._seed;return this._seed-=1,Kv(e.toString(),Jv)}initialize(t){typeof t=="string"?this._seed=yi.hash(t):this._seed=t}static createFromString(t){return new yi(this.hash(t))}static hash(t){let e=0;for(let i=0;i<t.length;i++)e=t.charCodeAt(i)+((e<<5)-e);return e}}var Tc;(function(s){s.NewInstanceCreated="new-instance-created",s.InstanceDestroyed="instance-destroyed"})(Tc||(Tc={}));class BE{constructor(t){a(this,"guid");a(this,"dontSave");this.guid=t}}function rm(s,t,e=!0,i){if(!s)return;const n=s;if(Wn(s,e),!t){console.warn("Can not send destroy: No networking connection provided",s.guid);return}if(!t.isConnected){U()&&console.debug("Can not send destroy: not connected",s.guid);return}let o=s.guid;if(!o&&n.uuid&&(o=n.uuid),!o){console.warn("Can not send destroy: failed to find guid",s);return}AC(o,t,i)}function AC(s,t,e){const i=new BE(s);(e==null?void 0:e.saveInRoom)===!1&&(i.dontSave=!0),t.send(Tc.InstanceDestroyed,i,es.Queued)}function FE(s){s.connection.beginListen(Tc.InstanceDestroyed,t=>{Jf&&console.log("[Remote] Destroyed",s.scene,t);const e=VC(t.guid,s.scene);e&&Wn(e)})}class S3{constructor(t,e,i){a(this,"filename");a(this,"hash");a(this,"size");this.filename=t,this.hash=e,this.size=i}}class zE{constructor(t,e){a(this,"guid");a(this,"originalGuid");a(this,"seed");a(this,"visible");a(this,"hostData");a(this,"dontSave");a(this,"parent");a(this,"position");a(this,"rotation");a(this,"scale");a(this,"preventCreation");a(this,"deleteStateOnDisconnect");this.originalGuid=t,this.guid=e}}function IC(s,t,e,i){var c,h;const n=s;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(t.context||(t.context=ne.Current),!t.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=t?{...t}:null,{instance:r,seed:l}=$E(n,t);if(r){const d=r;if(d.guid){Jf&&console.log("[Local] new instance","gameobject:",r==null?void 0:r.guid);const u=new zE(n.guid,d.guid);u.seed=l,t.deleteOnDisconnect===!0&&(u.deleteStateOnDisconnect=!0),o&&(o.position&&(Array.isArray(o.position)?u.position={x:o.position[0],y:o.position[1],z:o.position[2]}:u.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(o.rotation instanceof Ct?o.rotation=new H().setFromEuler(o.rotation):o.rotation instanceof Array&&(o.rotation=new H().fromArray(o.rotation)),u.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(Array.isArray(o.scale)?u.scale={x:o.scale[0],y:o.scale[1],z:o.scale[2]}:u.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),u.position||(u.position={x:d.position.x,y:d.position.y,z:d.position.z}),u.rotation||(u.rotation={x:d.quaternion.x,y:d.quaternion.y,z:d.quaternion.z,w:d.quaternion.w}),u.scale||(u.scale={x:d.scale.x,y:d.scale.y,z:d.scale.z}),u.visible=n.visible,o!=null&&o.parent&&(typeof o.parent=="string"?u.parent=o.parent:u.parent=o.parent.guid),u.hostData=e,i===!1&&(u.dontSave=!0),!((c=t==null?void 0:t.context)==null?void 0:c.connection)&&U()&&console.debug("Object will be instantiated but it will not be synced: not connected",n.guid),t.context.connection.isInRoom&&Dl.push(new WeakRef(d)),(h=t==null?void 0:t.context)==null||h.connection.send(Tc.NewInstanceCreated,u)}else console.warn("Missing guid, can not send new instance event",d)}return r}function UE(){return Math.random()*9999999}const Dl=new Array;function NE(s){s.connection.beginListen(Tc.NewInstanceCreated,async t=>{const e=await VE(t.originalGuid,s.scene);if(t.preventCreation===!0)return;if(!e){console.warn("could not find object that was instantiated: "+t.guid);return}const i=new lo;t.position&&(i.position=new x(t.position.x,t.position.y,t.position.z)),t.rotation&&(i.rotation=new H(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w)),t.scale&&(i.scale=new x(t.scale.x,t.scale.y,t.scale.z)),i.parent=t.parent,t.seed&&(i.idProvider=new yi(t.seed)),i.visible=t.visible,i.context=s,Jf&&s.alias&&console.log("[Remote] instantiate in: "+s.alias);const n=Mc(e,i);Dl.push(new WeakRef(n)),n&&(t.parent==="scene"&&s.scene.add(n),Jf&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,e))}),s.connection.beginListen("left-room",()=>{Dl.length>0&&console.debug(`Left networking room, cleaning up ${Dl.length} instantiated objects`);for(const t of Dl){const e=t.deref();e&&e.destroy()}Dl.length=0})}function $E(s,t){const e=UE(),i=t??new lo;i.idProvider=new yi(e);const n=Mc(s,i);return{seed:e,instance:n}}const DC={};function WE(s,t){DC[s]=t}async function VE(s,t){const e=DC[s];if(e!=null){const i=await e(s);if(i)return i}return LC(s,t)}function LC(s,t){if(t===null||!s)return null;if(t.guid===s)return t;if(t.children)for(const e of t.children){const i=LC(s,e);if(i)return i}return null}const iu=S("gizmos"),Dt=S("debugextension"),Dg=S("debugtypes");class HE{constructor(){a(this,"_types",new Map);Dg&&console.warn("TypeStore: Created",this)}add(t,e){Dg&&console.warn("ADD TYPE",t);const i=this._types.get(t);i?Dg&&i!==e&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",t):this._types.set(t,e)}get(t){return this._types.get(t)||null}getKey(t){for(const[e,i]of this._types)if(i===t)return e;return null}}const GE=Symbol("BuiltInType"),M=new HE,C3=function(s){M.get(s.name)||M.add(s.name,s)},wb=S("debugresolvedependencies"),qE=["/extensions/","extensions/"],XE=[{prefix:"/nodes/",dependencyName:"node"},{prefix:"/meshes/",dependencyName:"mesh"},{prefix:"/materials/",dependencyName:"material"},{prefix:"/textures/",dependencyName:"texture"},{prefix:"/animations/",dependencyName:"animation"},{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function Sb(s,t){wb&&console.log(s,t);const e=[];o_(XE,s,t,e);const i=await Promise.all(e);return typeof t=="string"&&i.length===1?i[0]:i}function QE(s,t){return!s||!t?!1:s["needle:identifier"]!=null&&t["needle:identifier"]!=null?s["needle:identifier"]===t["needle:identifier"]:!1}function YE(s,t){s["needle:identifier"]=t}function o_(s,t,e,i){if(typeof e=="object"&&e!==void 0&&e!==null)for(const n of Object.keys(e)){const o=e[n];if(typeof o=="string"){const r=Zv(t,o);if(r!=null)typeof r.then=="function"?i.push(r.then(l=>e[n]=l)):e[n]=r;else{const l=ex(s,t,o);if(l){i.push(l.then(c=>(e[n]=c,c)));continue}}}else if(Array.isArray(o))for(let r=0;r<o.length;r++){const l=o[r],c=Zv(t,l);if(c!==null){typeof c.then=="function"?i.push(c.then(h=>o[r]=h)):o[r]=c;continue}for(const h of s){const d=jC(h.prefix,l);if(d>=0){wb&&console.log(h,d,h.dependencyName),i.push(t.getDependency(h.dependencyName,d).then(u=>o[r]=u));break}}typeof l=="object"&&o_(s,t,l,i)}else typeof o=="object"&&o_(s,t,o,i)}else if(typeof e=="string"){const n=ex(s,t,e);n&&i.push(n)}}function Zv(s,t){if(s&&s.plugins&&typeof t=="string"){for(const e of qE)if(t.startsWith(e)){let i=t.substring(e.length);const n=i.indexOf("/");n>=0&&(i=i.substring(0,n));const o=s.plugins[i];if(Dt&&console.log(i,o),typeof(o==null?void 0:o.resolve)=="function"){const r=t.substring(e.length+i.length+1);return o.resolve(s,r)}break}}return null}function ex(s,t,e){for(const i of s){const n=jC(i.prefix,e);if(n>=0)return wb&&console.warn("GET DEPENDENCY",i,n,i.dependencyName),t.getDependency(i.dependencyName,n)}return null}function jC(s,t){if(typeof t=="string"&&t.startsWith(s)){const e=t.substring(s.length),i=Number.parseInt(e);if(i>=0)return i}return-1}const Lg="NEEDLE_persistent_assets";function KE(s){return(s==null?void 0:s.___persistentAsset)===!0}class JE{constructor(t){a(this,"parser");this.parser=t}get name(){return Lg}async afterRoot(t){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)!=null&&o.extensions))return;const e=this.parser.json.extensions[Lg];if(!e)return;Dt&&console.log(e);const i=new Array;for(const r of e==null?void 0:e.assets){const l=Sb(this.parser,r);l&&i.push(l)}await Promise.all(i)}resolve(t,e){const i=Number.parseInt(e);if(i>=0){Dt&&console.log(e);const n=t.json.extensions[Lg];if(n){const o=n==null?void 0:n.assets[i];if(o&&typeof o=="object"){o.___persistentAsset=!0;const r=o.__type;r&&M.get(r)}return o}}return null}}const Bs=S("debugserializer");class ZE{constructor(){a(this,"typeMap",new Map)}register(t,e){if(this.typeMap.has(t)){const i=this.typeMap.get(t);if(i===e)return;Bs&&console.warn("Type: "+t+" is already registered",e,i)}Bs&&console.log("Register type serializer",e.name,e,t),this.typeMap.set(t,e)}getSerializer(t){if(t)return this.typeMap.get(t)}getSerializerForConstructor(t,e=0){if(e>20)return;if(!t||!t.constructor){Bs&&console.log("invalid type");return}const i=t.name,n=this.getSerializer(t);if(n!==void 0)return Bs&&console.log("FOUND SERIALIZER",n==null?void 0:n.name,t.name,t.constructor.name,"for type: "+i,n,t,this.typeMap),n;const o=Object.getPrototypeOf(t);if(o&&o!==t){const r=this.getSerializerForConstructor(o,++e);if(r){const l=o.constructor||o.prototype;Bs&&console.log("FOUND SERIALIZER(in constructor) "+l.constructor.name,l.name,l,r),this.register(l,r)}return r}Bs&&console.warn("No serializer found for "+i,t,t.name,t.constructor.name)}}const Zf=new ZE;class Gn{constructor(t,e){a(this,"name");if(this.name=e,Array.isArray(t))for(const i of t)Zf.register(i,this);else Zf.register(t,this)}}class eM{constructor(){a(this,"isDevMode",fs());a(this,"cache",{})}registerDefinedKeys(t,e){if(this.isDevMode&&this.cache[t]===void 0){this.cache[t]=Object.keys(e);const i=e;i.$serializedTypes&&Object.keys(i.$serializedTypes)&&this.cache[t].push(...Object.keys(i.$serializedTypes)),Bs&&console.log("registerDefinedKeys for "+t,this.cache[t],e)}}getDefinedKey(t,e){return this.cache[t]===void 0?!1:this.cache[t].includes(e)}}class BC{constructor(t){a(this,"root");a(this,"gltf");a(this,"gltfId");a(this,"object");a(this,"target");a(this,"nodeId");a(this,"nodeToObject");a(this,"objectToNode");a(this,"context");a(this,"path");a(this,"type");a(this,"serializable");a(this,"implementationInformation");this.root=t}}function tM(s,t){const e=s.$serializedTypes;if(e===void 0)return null;const i={};for(const o in e){const r=s[o];if(r!=null&&typeof r=="object"){const l=Zf.getSerializerForConstructor(r);if(l){i[o]=l.onSerialize(r,t);continue}}i[o]=r}function n(o){const r=M._types;for(const[l,c]of r)if(c===s.constructor)return l;return o.__name||o.constructor.name}return i.name=n(s),typeof s.guid=="string"&&(i.guid=s.guid),i}const Rf=[];function FC(s,t){if(!s)return t;typeof s.$serializedTypes=="object"&&(t||(t={}),Object.assign(t,s.$serializedTypes));const e=Object.getPrototypeOf(s);return FC(e,t)}function r_(s,t,e){if(!s)return!1;if(e.target=s,s.onBeforeDeserialize!==void 0){const n=s.onBeforeDeserialize(t,e);if(typeof n=="boolean")return n}const i=FC(s);if(t){if(typeof t.guid=="string"&&(s.guid=t.guid),i)for(const n in i){let l=function(c){const d=c.type;return d?a_(r,d,e,void 0,s[n]):a_(r,c,e,void 0,s[n])};const o=i[n],r=t[n];if(Bs&&console.log(n,r,s,o),!(s[n]!==void 0&&r===void 0)&&(e.type=void 0,e.path=n,e.serializable=o,!(s.onBeforeDeserializeMember!==void 0&&s.onBeforeDeserializeMember(n,r,e)===!0))){if(o===null)s[n]=r;else{if(Array.isArray(o))for(let c=0;c<o.length;c++){const h=o[c],d=l(h);if(d!==void 0||c===o.length-1){s[n]=d;break}}else s[n]=l(o);Rf.length=0}s.onAfterDeserializeMember!==void 0&&s.onAfterDeserializeMember(n,r,e)}}sM(s,t)}return nM(s,t,e.implementationInformation),s.onAfterDeserialize!==void 0&&s.onAfterDeserialize(t,e),!0}const iM=S("noerrors");function nM(s,t,e){var o,r;if(iM||!t||!fs()||!s||s.constructor&&s.constructor[GE]===!0)return;const i=(o=s.constructor)==null?void 0:o.name,n=Object.getOwnPropertyNames(t);for(const l of n){if(l==="sourceId")continue;const c=s[l];if(c==null)continue;const h=t[l];if((e==null?void 0:e.getDefinedKey(i,l))===!1){const d=l.charAt(0).toUpperCase()+l.slice(1);e.getDefinedKey(i,d)&&(La(Jt.Warn,'<strong>Please rename</strong> "'+d+'" to "'+l+'" in '+i),console.warn('Please use lowercase for field: "'+d+'" in '+i,h,s));continue}if(h!=null){if(typeof h=="object"&&(c===void 0||!c.isObject3D)){if(typeof h.node=="number"||typeof h.guid=="string"){if(h.could_not_resolve)continue;if(!(c!==void 0&&Object.keys(c).length>1)){La(Jt.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(Object3D)
${l}? : Object3D;

in ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">See documentation</a>`),console.warn(i,l,s[l],s);continue}}else if(!Array.isArray(c)){const d=(r=c.constructor)==null?void 0:r.name;if(d==="Object"&&!c.constructor["did_warn:missing_serializable"]){c.constructor["did_warn:missing_serializable"]=!0;const u='You might be missing a @serializable(Type) decorator for field "'+l+'" in '+i+".ts";console.warn(u+`
${l}:`,h,d),La(Jt.Warn,"Dev Warning: Are you missing a type in @serializable? Please check the browser console for details")}}}if(typeof c=="string"&&typeof h=="string"&&(h.endsWith(".gltf")||h.endsWith(".glb"))){La(Jt.Warn,`<strong>Missing serialization for object reference!</strong>

Please change to: 
@serializable(AssetReference)
${l}? : AssetReference;

in script ${i}.ts
<a href="https://docs.needle.tools/serializable" target="_blank">documentation</a>`),console.warn(i,l,s[l],s);continue}}}}function sM(s,t){for(const e of Object.keys(t)){const i=t[e];if(typeof i=="object"&&i!==null&&i!==void 0){const n=s[e];if(!n){Bs&&console.log(e,"is undefined on",s);continue}for(const o of Object.keys(i))if(n[o]===void 0&&tx(i[o])&&!tx(n)){const l=oM(n,o);if(l&&((l==null?void 0:l.writable)===void 0||(l==null?void 0:l.writable)===!1)&&l.set===void 0){Bs&&console.warn('Property is not writable "'+o+'"',n,l,i[o],n[o]);continue}n[o]=i[o]}}}}function oM(s,t){for(;s;){const e=Object.getOwnPropertyDescriptor(s,t);if(e)return e;s=Object.getPrototypeOf(s)}}function tx(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}function a_(s,t,e,i,n){let o=typeof t=="function"&&t.prototype===void 0,r=t;if(o)try{if(r=t==null?void 0:t.call(t,n),o=!1,r==null)return}catch(d){console.error("Error in callback",d,s)}if(e.type=r,!o&&n&&(n instanceof Ie||n instanceof X||n instanceof os||n instanceof Dr))return n;if(i||(i={serializer:Zf.getSerializerForConstructor(r)}),n&&typeof n=="object"&&KE(n)){if(n.__concreteInstance)return n.__concreteInstance;const d=n;if(!d.$serializedTypes&&r.prototype.$serializedTypes&&(d.$serializedTypes=r.prototype.$serializedTypes),d.$serializedTypes&&r_(d,s,e),n&&r!==void 0)try{let u=null;i.serializer&&(u=i.serializer.onDeserialize(s,e)),u||(u=new r,Dt&&console.log("Create concrete instance for persistent asset",n,"instance:",u),Oc(u,n)),n.__concreteInstance=u,n=u}catch(u){console.error("Error creating instance or creating values on instance",u,n,r)}return n}if(Array.isArray(s)){const d=[];for(let u=0;u<s.length;u++){const f=s[u],p=a_(f,t,e,i,f);d.push(p)}return d}const l=i==null?void 0:i.serializer;if(l)return l.onDeserialize(s,e);if(n instanceof Ke)return n;let c;if(s&&(s.isMaterial||s.isTexture||s.isObject3D||s instanceof Dr))c=s;else{if(s===void 0)return;if(s===null&&(r===Ie||r===Ke||r===X||r===Dr))return null;try{c=new r(...rM(s))}catch(d){console.error("Error creating "+e.path,e.target,d);return}}const h=c;return h.$serializedTypes&&r_(h,s,e),c}function rM(s){if(Rf.length=0,typeof s=="object"&&s!==null&&s!==void 0)for(const t of Object.keys(s))Rf.push(s[t]);return Rf}const l_=Symbol("assigned component properties");function Oc(s,t,e,i){var o;if(t==null||s==null)return;s[l_]=!0;const n=((o=s.constructor)==null?void 0:o.name)??"unknown";e==null||e.registerDefinedKeys(n,s);for(const r of Object.keys(t)){const l=aM(s,r);if(typeof(l==null?void 0:l.value)!="function"&&(!l||l.writable===!0||l.set!==void 0)){const c=t[r],h=s[r];s[r]=c,i!=null&&i.onAssigned&&i.onAssigned(s,r,h,c)}}delete s[l_]}function aM(s,t){let e;do e=Object.getOwnPropertyDescriptor(s,t);while(!e&&(s=Object.getPrototypeOf(s)));return e}const zC=Symbol("customVisibilityFlag");function Io(s,t){s.layers[zC]=t}const ix=Symbol("DidPatchLayers");function lM(){const s=Vr.prototype;if(s[ix])return;s[ix]=!0;const t=s.test;s.test=function(e){return this[zC]===!1?!1:t.call(this,e)}}lM();Object.defineProperty(Se.prototype,"fov",{get:function(){return this._fov},set:function(s){const t=s!==this._fov;this._fov=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(Se.prototype,"near",{get:function(){return this._near},set:function(s){const t=s!==this._near;this._near=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});Object.defineProperty(Se.prototype,"far",{get:function(){return this._far},set:function(s){const t=s!==this._far;this._far=s,t&&this.view!==void 0&&this.updateProjectionMatrix()},configurable:!0});const UC=new Map;function cM(s,t){if(!s)return;if(!t){console.warn("No prototype found",s,s.prototype,s.constructor);return}const e=UC.get(t);e&&e.apply(s)}function hM(s){const t=dM(s.prototype);UC.set(s,t)}function dM(s){return new uM(s)}class uM{constructor(t){a(this,"$symbol");a(this,"extensions");a(this,"descriptors");this.$symbol=Symbol("prototype-extension"),this.extensions=Object.keys(t),this.descriptors=new Array;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=Object.getOwnPropertyDescriptor(t,i);n&&this.descriptors.push(n)}}apply(t){if(!t[this.$symbol]){t[this.$symbol]=!0;for(let e=0;e<this.extensions.length;e++){const i=this.extensions[e],n=this.descriptors[e];n&&Object.defineProperty(t,i,n)}}}}const fM=S("debuggetcomponent"),nx=()=>fM||globalThis.NEEDLE_DEBUG_GETCOMPONENT===!0;function pM(s){return s==null||s.isObject3D?s:s.object&&s.object.isObject3D?s.object:s}function NC(s,t){if(!s||!s.userData.components)return t;const e=s.userData.components.indexOf(t);return e<0||(om.dispatchComponentLifecycleEvent("removing-component",t),t.gameObject=null,s.userData.components.splice(e,1)),t}function am(s,t,e){const i=Bc(s,t);return i||Ks(s,t,e)}const $C=new yi("addComponentIdProvider");function uc(s,t,e=!0){s.userData||(s.userData={}),s.userData.components||(s.userData.components=[]),s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=$C.generateUUID()),Pb(s),kb(t,t.context);try{e&&t.__internalAwake&&(td(s),t.activeAndEnabled&&t.__internalAwake()),om.dispatchComponentLifecycleEvent("component-added",t)}catch(i){console.error(i)}return t}function Ks(s,t,e,i){var n;if(typeof t=="function"){const o=new t;e&&o.__internalNewInstanceCreated(e);let r=!0;return(i==null?void 0:i.callAwake)!=null&&(r=i.callAwake),uc(s,o,r)}if(t.destroyed)return console.warn("Can not move/add a destroyed component",t),t;if(t.gameObject===s)return t;if(t.gameObject&&((n=t.gameObject.userData)!=null&&n.components)){const o=t.gameObject.userData.components.indexOf(t);t.gameObject.userData.components.splice(o,1)}if(s.userData||(s.userData={}),!s.userData.components)s.userData.components=[];else if(s.userData.components.includes(t))return t;return s.userData.components.push(t),t.gameObject=s,(t.guid===void 0||t.guid==="invalid")&&(t.guid=$C.generateUUID()),e&&t._internalInit(e),kb(t,t.context),t}function mM(s){if(s.gameObject&&s.gameObject.userData.components){const t=s.gameObject.userData.components.indexOf(s);s.gameObject.userData.components.splice(t,1)}s.__internalDisable&&s.__internalDisable(),Ao(s,s.context??ne.Current),s.destroy(),s.gameObject=null}let sx=!1;function WC(s,t,e){var i;if(s==null)return null;if(!s.isObject3D)return console.error("Object is not object3D"),null;if(!((i=s==null?void 0:s.userData)!=null&&i.components)||(typeof t=="string"&&(sx||(sx=!0,console.warn(`Accessing components by name is not supported.
Please use the component type instead. This may keep working in local development but it will fail when bundling your application.

You can import other modules your main module to get access to types
or if you use npmdefs you can make types available globally using globalThis:
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/globalThis`,t))),nx()&&console.log("[onGetComponent] FIND",t),t==null))return null;for(let n=0;n<s.userData.components.length;n++){const o=s.userData.components[n];let r=Object.getPrototypeOf(o);for(;r;){if(r===t.prototype)if(nx()&&console.log("[onGetComponent] MATCH BY PROTOYPE",r),e)e.push(o);else return o;r=Object.getPrototypeOf(r)}}return e||null}function Bc(s,t){const e=WC(s,t);return e?Array.isArray(e)?e[0]:e:null}function lm(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),WC(s,t,e),e}function cm(s,t,e){var n;if(e===!1&&s[jr]===!1)return null;const i=Bc(s,t);if(e===!1&&(i==null?void 0:i.enabled)===!1)return null;if(i)return i;for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++){const r=cm(s.children[o],t);if(r)return r}return null}function nu(s,t,e,i=!0){var n;e||(e=[]),i&&(e.length=0),lm(s,t,e,!1);for(let o=0;o<((n=s==null?void 0:s.children)==null?void 0:n.length);o++)nu(s.children[o],t,e,!1);return e}function ep(s,t){if(!s)return null;if(Array.isArray(s)){for(let i=0;i<s.length;i++){const n=pM(s[i]),o=ep(n,t);if(o)return o}return null}const e=Bc(s,t);return e||(s.parent?ep(s.parent,t):null)}function Cb(s,t,e,i=!0){return e||(e=[]),i&&(e.length=0),s?(lm(s,t,e,!1),s.parent?Cb(s.parent,t,e,!1):e):e}function hm(s,t=void 0,e=!0){if(!s)return null;if(!t&&(t=ne.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),null;let i=t;if(i.isScene||(i=t==null?void 0:t.scene),!i)return null;const n=cm(i,s,e);return n||null}function gM(s,t,e=void 0){if(!s)return t??[];if(t||(t=[]),t.length=0,!e&&(e=ne.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),t;"scene"in e&&(e=e.scene);const i=e;return i&&nu(i,s,t,!1),t}function Pb(s){s&&s.isObject3D===!0&&cM(s,D)}if(Yf.experimentalSmartHierarchyUpdate){const s=D.prototype.add;D.prototype.add=function(...i){return Ag(),s.apply(this,i)};const t=D.prototype.attach;D.prototype.attach=function(...i){return Ag(),t.apply(this,i)};const e=D.prototype.remove;D.prototype.remove=function(...i){return Ag(),e.apply(this,i)}}D.prototype.SetActive=function(s){this.visible=s};D.prototype.setActive=function(s){this.visible=s};D.prototype.destroy=function(){Wn(this)};D.prototype.addComponent=function(s,t){return Ks(this,s,t)};D.prototype.addNewComponent=function(s,t){return Ks(this,s,t)};D.prototype.removeComponent=function(s){return NC(this,s)};D.prototype.getOrAddComponent=function(s,t){return am(this,s,t)};D.prototype.getComponent=function(s){return Bc(this,s)};D.prototype.getComponents=function(s,t){return lm(this,s,t)};D.prototype.getComponentInChildren=function(s){return cm(this,s)};D.prototype.getComponentsInChildren=function(s,t){return nu(this,s,t)};D.prototype.getComponentInParent=function(s){return ep(this,s)};D.prototype.getComponentsInParent=function(s,t){return Cb(this,s,t)};Object.getOwnPropertyDescriptor(D.prototype,"activeSelf")||Object.defineProperty(D.prototype,"activeSelf",{get:function(){return su(this)},set:function(s){Of(this,s)}});Object.getOwnPropertyDescriptor(D.prototype,"worldPosition")||Object.defineProperty(D.prototype,"worldPosition",{get:function(){return this instanceof Xw?ae(this.object):ae(this)},set:function(s){ei(this,s)}});Object.getOwnPropertyDescriptor(D.prototype,"worldQuaternion")||Object.defineProperty(D.prototype,"worldQuaternion",{get:function(){return this instanceof Xw?Le(this.object):Le(this)},set:function(s){no(this,s)}});Object.getOwnPropertyDescriptor(D.prototype,"worldRotation")||Object.defineProperty(D.prototype,"worldRotation",{get:function(){return lb(this)},set:function(s){CO(this,s)}});Object.getOwnPropertyDescriptor(D.prototype,"worldScale")||Object.defineProperty(D.prototype,"worldScale",{get:function(){return _t(this)},set:function(s){zd(this,s)}});const yM=new ce,_M=new x(0,0,0),bM=new x(0,1,0);Object.getOwnPropertyDescriptor(D.prototype,"worldForward")||Object.defineProperty(D.prototype,"worldForward",{get:function(){return q().set(0,0,1).applyQuaternion(Le(this))},set:function(s){const t=dn().setFromRotationMatrix(yM.lookAt(_M.set(0,0,0),s,bM.set(0,1,0)));this.worldQuaternion=t}});Object.getOwnPropertyDescriptor(D.prototype,"worldRight")||Object.defineProperty(D.prototype,"worldRight",{get:function(){return q().set(1,0,0).applyQuaternion(Le(this))}});Object.getOwnPropertyDescriptor(D.prototype,"worldUp")||Object.defineProperty(D.prototype,"worldUp",{get:function(){return q().set(0,1,0).applyQuaternion(Le(this))}});hM(D);class pe extends de{constructor(e,i,n,o){super();a(this,"alpha",1);typeof e=="number"&&typeof i=="number"&&typeof n=="number"?(this.set(e,i,n),this.alpha=typeof o=="number"?o:1):e!==void 0&&(this.set(e),this.alpha=1)}get isRGBAColor(){return!0}set a(e){this.alpha=e}get a(){return this.alpha}clone(){const e=super.clone();return e.alpha=this.alpha,e}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,"alpha"in e&&typeof e.alpha=="number"?this.alpha=e.alpha:typeof e.a=="number"&&(this.alpha=e.a),this}lerp(e,i){const n=e;return n.alpha!=null&&(this.alpha=N.lerp(this.alpha,n.alpha,i)),super.lerp(e,i)}lerpColors(e,i,n){const o=e,r=i;return o.alpha!=null&&r.alpha!=null&&(this.alpha=N.lerp(o.alpha,r.alpha,n)),super.lerpColors(e,i,n)}multiply(e){const i=e;return i.alpha!=null&&(this.alpha=this.alpha*i.alpha),super.multiply(e)}fromArray(e,i=0){return this.alpha=e[i+3],super.fromArray(e,i)}static fromColorRepresentation(e){if(typeof e=="string"){if(e.trim()==="transparent")return new pe(0,0,0,0);if(e.startsWith("#")&&e.length===9){const i=parseInt(e.slice(1,9),16),n=i>>24&255,o=i>>16&255,r=i>>8&255,l=i>>0&255;return new pe(n/255,o/255,r/255,l/255)}else if(e.startsWith("#")){const i=parseInt(e.slice(1),16),n=i>>16&255,o=i>>8&255,r=i>>0&255;return new pe(n/255,o/255,r/255,1)}else if(e.startsWith("rgba")){const i=e.slice(5,-1).split(",").map(Number);return new pe(i[0]/255,i[1]/255,i[2]/255,i[3])}else if(e.startsWith("rgb")){const i=e.slice(4,-1).split(",").map(Number);return new pe(i[0]/255,i[1]/255,i[2]/255,1)}}else if(Array.isArray(e)){if(e.length===4)return new pe(e[0],e[1],e[2],e[3]);if(e.length===3)return new pe(e[0],e[1],e[2],1);console.error("Invalid color array length. Expected 3 or 4, got "+e.length)}return new pe(e)}}const Tf=S("debuggetcomponent"),Ga=S("debuginstantiate");class lo{constructor(){a(this,"idProvider");a(this,"parent");a(this,"keepWorldPosition");a(this,"position");a(this,"rotation");a(this,"scale");a(this,"visible");a(this,"context");a(this,"components")}clone(){var e,i,n;const t=new lo;return t.idProvider=this.idProvider,t.parent=this.parent,t.keepWorldPosition=this.keepWorldPosition,t.position=Array.isArray(this.position)?[...this.position]:(e=this.position)==null?void 0:e.clone(),t.rotation=Array.isArray(this.rotation)?[...this.rotation]:(i=this.rotation)==null?void 0:i.clone(),t.scale=Array.isArray(this.scale)?[...this.scale]:(n=this.scale)==null?void 0:n.clone(),t.visible=this.visible,t.context=this.context,t.components=this.components,t}cloneAssign(t){var e,i,n;this.idProvider=t.idProvider,this.parent=t.parent,this.keepWorldPosition=t.keepWorldPosition,this.position=Array.isArray(t.position)?[...t.position]:(e=t.position)==null?void 0:e.clone(),this.rotation=Array.isArray(t.rotation)?[...t.rotation]:(i=t.rotation)==null?void 0:i.clone(),this.scale=Array.isArray(t.scale)?[...t.scale]:(n=t.scale)==null?void 0:n.clone(),this.visible=t.visible,this.context=t.context,this.components=t.components}}function su(s){return s.visible}function Of(s,t){return typeof t=="number"&&(t=t>.5),s.visible=t,s.visible}function vM(s){return s[jr]||Rb(s)}function xM(s,t){s[TC]=t}function Rb(s){return cs.isUsingInstancing(s)}function VC(s,t){return Fd(s,t,!0,!0)}const HC=Symbol("isDestroyed");function kc(s){return s[HC]}function wM(s,t){s[HC]=t}const c_=Symbol("isDontDestroy");function xh(s,t=!0){s[c_]=t}const kf=[],Ef=[];function Wn(s,t=!0,e=!1){kf.length=0,Ef.length=0,h_(s,t,!0);for(const i of kf)i.gameObject=null,i.context=null;for(const i of Ef)wM(i,!0),e&&Ye(i);Ef.length=0,kf.length=0}function h_(s,t=!0,e=!0){var r;if(s==null)return;const i=s;if(i.isComponent){if(i[c_])return;kf.push(i);const l=i.gameObject;i.__internalDisable(),i.__internalDestroy(),i.gameObject=l;return}if(s[c_])return;const n=s;Tf&&console.log(n),Ef.push(n);const o=(r=n.userData)==null?void 0:r.components;if(o!=null&&Array.isArray(o)){let l=o.length;for(let c=0;c<o.length;c++){const h=o[c];h_(h,t,!1),o.length<l&&(l=o.length,c--)}}if(t&&n.children)for(const l of n.children)h_(l,t,!1);e&&n.removeFromParent()}function Ec(s,t,e=!0){return GC(s,t,e)}function*Tb(s,t,e=!1,i=999,n=0){if(s!=null&&s.userData.components&&!(n>i)){for(const o of s.userData.components)t&&(o==null?void 0:o.isComponent)===!0&&o instanceof t?yield o:yield o;if(e===!0)for(const o of s.children)yield*Tb(o,t,!0,i,n+1)}}function GC(s,t,e,i=0){var n;if(s){if(s.isObject3D,i>1e3){console.warn("Failed to iterate components: too many levels");return}if((n=s.userData)!=null&&n.components)for(let o=0;o<s.userData.components.length;o++){const r=s.userData.components[o];if((r==null?void 0:r.isComponent)===!0){const l=t(r);if(l!==void 0)return l}}if(e&&s.children){const o=i+1;for(let r=0;r<s.children.length;r++){const l=s.children[r];if(!l)continue;const c=GC(l,t,e,o);if(c!==void 0)return c}}}}function Mc(s,t){if("isAssetReference"in s)return s.instantiate(t??void 0);let e=null;t!=null&&(t.x!==void 0?(e=new lo,e.position=t):e=t);let i=ne.Current;e!=null&&e.context&&(i=e.context),Tf&&i.alias&&console.log("context",i.alias),e&&!e.idProvider&&(e.idProvider=new yi(Date.now()));const n=[],o={},r={},l=qC(i,s,e,n,o,r);l&&(PM(l,o),CM(r,o)),Tf&&(Ly(s,!0),Ly(l,!0));const c={};if((e==null?void 0:e.components)!==!1){for(const h in n){const d=n[h],u=d.guid;e&&e.idProvider&&(d.guid=e.idProvider.generateUUID(),c[u]=d.guid,Tf&&console.log(d.name,d.guid)),kb(d,i),d.__internalNewInstanceCreated&&d.__internalNewInstanceCreated()}for(const h in n){const d=n[h];d.resolveGuids&&d.resolveGuids(c),d.enabled!==!1&&(d.enabled=!0)}Kf(i)}return l}function qC(s,t,e,i,n,o){var d;if(!t||t[fn])return null;const r=t.userData;t.userData={};const l=t.children;t.children=[];const c=t.clone(!1);if(Pb(c),t.userData=r,t.children=l,n[t.uuid]={original:t,clone:c},Ga&&console.log("ADD",t,c),t.type==="SkinnedMesh"&&(o[t.uuid]={original:t,clone:c}),(e==null?void 0:e.visible)!==void 0&&(c.visible=e.visible),e!=null&&e.idProvider){c.uuid=e.idProvider.generateUUID();const u=c;u&&(u.guid=c.uuid)}t.animations&&t.animations.length>0&&(c.animations=[...t.animations]);const h=t.parent;if(h&&h.add(c),e!=null&&e.position)if(Array.isArray(e.position)){const u=new x;u.fromArray(e.position),c.worldPosition=u}else c.worldPosition=e.position;else c.position.copy(t.position);if(e!=null&&e.rotation){if(e.rotation instanceof H)c.worldQuaternion=e.rotation;else if(e.rotation instanceof Ct)c.worldQuaternion=dn().setFromEuler(e.rotation);else if(Array.isArray(e.rotation)){const u=new Ct;u.fromArray(e.rotation),c.worldQuaternion=dn().setFromEuler(u)}}else c.quaternion.copy(t.quaternion);if(e!=null&&e.scale)if(Array.isArray(e.scale)){const u=new x;u.fromArray(e.scale),e.scale=u}else c.scale.copy(e.scale);else c.scale.copy(t.scale);if(e!=null&&e.parent&&e.parent!=="scene"){let u=null;if(typeof e.parent=="string"?u=Fd(e.parent,s.scene,!0):u=e.parent,u){const f=e.keepWorldPosition===!0?u.attach:u.add;f?f.call(u,c):console.error("Invalid parent object",u,"received when instantiating:",t)}else console.warn("could not find parent:",e.parent)}for(const[u,f]of Object.entries(t.userData))u!=="components"&&(c.userData[u]=f);if((d=t.userData)!=null&&d.components){const u=t.userData.components,f=[];c.userData.components=f;for(let p=0;p<u.length;p++){const g=u[p],_=new g.constructor;SM(g,_),g[bf]!==void 0&&(_[bf]=g[bf]),f.push(_),_.gameObject=c,i.push(_),n[g.guid]={original:g,clone:_},om.dispatchComponentLifecycleEvent("component-added",_)}}e&&(e.position=void 0,e.rotation=void 0,e.scale=void 0,e.parent=void 0,e.visible=void 0);for(const u in t.children){const f=t.children[u],p=qC(s,f,e,i,n,o);p&&(n[p.uuid]={original:f,clone:p},c.add(p))}return c}function SM(s,t,e){Oc(t,s,void 0,{})}function CM(s,t){for(const e in s){const i=s[e],n=i.original,o=n.skeleton,r=i.clone;if(!o){console.warn("Skinned mesh has no skeleton?",i);continue}const l=o.bones,c=r.skeleton.clone();r.skeleton=c,r.bindMatrix.clone().copy(n.bindMatrix),r.bindMatrixInverse.copy(n.bindMatrixInverse);const h=[];c.bones=h;for(let d=0;d<l.length;d++){const u=l[d],p=t[u.uuid].clone;h.push(p)}}for(const e in s){const i=s[e].clone;i.skeleton.update(),i.bind(i.skeleton,i.bindMatrix),i.updateMatrixWorld(!0)}}function PM(s,t){var e;for(const i in t){const o=t[i].clone;if(o!=null&&o.isObject3D&&((e=o==null?void 0:o.userData)!=null&&e.components))for(let r=0;r<o.userData.components.length;r++){const l=o.userData.components[r],c=Object.entries(l);for(const[h,d]of c)if(Array.isArray(d)){const u=[];l[h]=u;for(let f=0;f<d.length;f++){const p=d[f];if(typeof p!="object"){u.push(p);continue}const g=ox(l,h,p,t);g!==void 0?(Ga&&console.log("Found new instance for",h,p,"->",g),u.push(g)):(Ga&&console.warn("Could not find new instance for",h,p),u.push(p))}}else if(typeof d=="object"){const u=ox(l,h,d,t);u!==void 0?l[h]=u:Ga&&console.warn("Could not find new instance for",h,d)}}}}function ox(s,t,e,i){var n,o;if(e!=null)if(e.isComponent===!0){const r=e.gameObject;if(r){const l=r.uuid,c=(n=i[l])==null?void 0:n.clone;if(!c){Ga&&console.log("reference did not change",t,s,e);return}const h=r.userData.components.indexOf(e);if(h>=0&&c.isObject3D)return Ga&&console.log(t,l),c.userData.components[h];console.warn("could not find component",t,e)}}else if(e.isObject3D===!0){if(t==="gameObject")return;const r=e;if(r){const l=r.uuid,c=(o=i[l])==null?void 0:o.clone;if(c)return Ga&&console.log(t,"old",e,"new",c),c}}else{if(e.isVector4||e.isVector3||e.isVector2||e.isQuaternion||e.isEuler)return e.clone();if(e.isColor===!0)return e.clone();if(e.isEventList===!0)return e.__internalOnInstantiate(i)}}var XC={exports:{}},QC={exports:{}};(function(){var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,i){return e<<i|e>>>32-i},rotr:function(e,i){return e<<32-i|e>>>i},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var i=0;i<e.length;i++)e[i]=t.endian(e[i]);return e},randomBytes:function(e){for(var i=[];e>0;e--)i.push(Math.floor(Math.random()*256));return i},bytesToWords:function(e){for(var i=[],n=0,o=0;n<e.length;n++,o+=8)i[o>>>5]|=e[n]<<24-o%32;return i},wordsToBytes:function(e){for(var i=[],n=0;n<e.length*32;n+=8)i.push(e[n>>>5]>>>24-n%32&255);return i},bytesToHex:function(e){for(var i=[],n=0;n<e.length;n++)i.push((e[n]>>>4).toString(16)),i.push((e[n]&15).toString(16));return i.join("")},hexToBytes:function(e){for(var i=[],n=0;n<e.length;n+=2)i.push(parseInt(e.substr(n,2),16));return i},bytesToBase64:function(e){for(var i=[],n=0;n<e.length;n+=3)for(var o=e[n]<<16|e[n+1]<<8|e[n+2],r=0;r<4;r++)n*8+r*6<=e.length*8?i.push(s.charAt(o>>>6*(3-r)&63)):i.push("=");return i.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var i=[],n=0,o=0;n<e.length;o=++n%4)o!=0&&i.push((s.indexOf(e.charAt(n-1))&Math.pow(2,-2*o+8)-1)<<o*2|s.indexOf(e.charAt(n))>>>6-o*2);return i}};QC.exports=t})();var RM=QC.exports,d_={utf8:{stringToBytes:function(s){return d_.bin.stringToBytes(unescape(encodeURIComponent(s)))},bytesToString:function(s){return decodeURIComponent(escape(d_.bin.bytesToString(s)))}},bin:{stringToBytes:function(s){for(var t=[],e=0;e<s.length;e++)t.push(s.charCodeAt(e)&255);return t},bytesToString:function(s){for(var t=[],e=0;e<s.length;e++)t.push(String.fromCharCode(s[e]));return t.join("")}}},rx=d_;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var TM=function(s){return s!=null&&(YC(s)||OM(s)||!!s._isBuffer)};function YC(s){return!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function OM(s){return typeof s.readFloatLE=="function"&&typeof s.slice=="function"&&YC(s.slice(0,0))}(function(){var s=RM,t=rx.utf8,e=TM,i=rx.bin,n=function(o,r){o.constructor==String?r&&r.encoding==="binary"?o=i.stringToBytes(o):o=t.stringToBytes(o):e(o)?o=Array.prototype.slice.call(o,0):!Array.isArray(o)&&o.constructor!==Uint8Array&&(o=o.toString());for(var l=s.bytesToWords(o),c=o.length*8,h=1732584193,d=-271733879,u=-1732584194,f=271733878,p=0;p<l.length;p++)l[p]=(l[p]<<8|l[p]>>>24)&16711935|(l[p]<<24|l[p]>>>8)&4278255360;l[c>>>5]|=128<<c%32,l[(c+64>>>9<<4)+14]=c;for(var g=n._ff,_=n._gg,y=n._hh,b=n._ii,p=0;p<l.length;p+=16){var v=h,w=d,P=u,E=f;h=g(h,d,u,f,l[p+0],7,-680876936),f=g(f,h,d,u,l[p+1],12,-389564586),u=g(u,f,h,d,l[p+2],17,606105819),d=g(d,u,f,h,l[p+3],22,-1044525330),h=g(h,d,u,f,l[p+4],7,-176418897),f=g(f,h,d,u,l[p+5],12,1200080426),u=g(u,f,h,d,l[p+6],17,-1473231341),d=g(d,u,f,h,l[p+7],22,-45705983),h=g(h,d,u,f,l[p+8],7,1770035416),f=g(f,h,d,u,l[p+9],12,-1958414417),u=g(u,f,h,d,l[p+10],17,-42063),d=g(d,u,f,h,l[p+11],22,-1990404162),h=g(h,d,u,f,l[p+12],7,1804603682),f=g(f,h,d,u,l[p+13],12,-40341101),u=g(u,f,h,d,l[p+14],17,-1502002290),d=g(d,u,f,h,l[p+15],22,1236535329),h=_(h,d,u,f,l[p+1],5,-165796510),f=_(f,h,d,u,l[p+6],9,-1069501632),u=_(u,f,h,d,l[p+11],14,643717713),d=_(d,u,f,h,l[p+0],20,-373897302),h=_(h,d,u,f,l[p+5],5,-701558691),f=_(f,h,d,u,l[p+10],9,38016083),u=_(u,f,h,d,l[p+15],14,-660478335),d=_(d,u,f,h,l[p+4],20,-405537848),h=_(h,d,u,f,l[p+9],5,568446438),f=_(f,h,d,u,l[p+14],9,-1019803690),u=_(u,f,h,d,l[p+3],14,-187363961),d=_(d,u,f,h,l[p+8],20,1163531501),h=_(h,d,u,f,l[p+13],5,-1444681467),f=_(f,h,d,u,l[p+2],9,-51403784),u=_(u,f,h,d,l[p+7],14,1735328473),d=_(d,u,f,h,l[p+12],20,-1926607734),h=y(h,d,u,f,l[p+5],4,-378558),f=y(f,h,d,u,l[p+8],11,-2022574463),u=y(u,f,h,d,l[p+11],16,1839030562),d=y(d,u,f,h,l[p+14],23,-35309556),h=y(h,d,u,f,l[p+1],4,-1530992060),f=y(f,h,d,u,l[p+4],11,1272893353),u=y(u,f,h,d,l[p+7],16,-155497632),d=y(d,u,f,h,l[p+10],23,-1094730640),h=y(h,d,u,f,l[p+13],4,681279174),f=y(f,h,d,u,l[p+0],11,-358537222),u=y(u,f,h,d,l[p+3],16,-722521979),d=y(d,u,f,h,l[p+6],23,76029189),h=y(h,d,u,f,l[p+9],4,-640364487),f=y(f,h,d,u,l[p+12],11,-421815835),u=y(u,f,h,d,l[p+15],16,530742520),d=y(d,u,f,h,l[p+2],23,-995338651),h=b(h,d,u,f,l[p+0],6,-198630844),f=b(f,h,d,u,l[p+7],10,1126891415),u=b(u,f,h,d,l[p+14],15,-1416354905),d=b(d,u,f,h,l[p+5],21,-57434055),h=b(h,d,u,f,l[p+12],6,1700485571),f=b(f,h,d,u,l[p+3],10,-1894986606),u=b(u,f,h,d,l[p+10],15,-1051523),d=b(d,u,f,h,l[p+1],21,-2054922799),h=b(h,d,u,f,l[p+8],6,1873313359),f=b(f,h,d,u,l[p+15],10,-30611744),u=b(u,f,h,d,l[p+6],15,-1560198380),d=b(d,u,f,h,l[p+13],21,1309151649),h=b(h,d,u,f,l[p+4],6,-145523070),f=b(f,h,d,u,l[p+11],10,-1120210379),u=b(u,f,h,d,l[p+2],15,718787259),d=b(d,u,f,h,l[p+9],21,-343485551),h=h+v>>>0,d=d+w>>>0,u=u+P>>>0,f=f+E>>>0}return s.endian([h,d,u,f])};n._ff=function(o,r,l,c,h,d,u){var f=o+(r&l|~r&c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._gg=function(o,r,l,c,h,d,u){var f=o+(r&c|l&~c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._hh=function(o,r,l,c,h,d,u){var f=o+(r^l^c)+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._ii=function(o,r,l,c,h,d,u){var f=o+(l^(r|~c))+(h>>>0)+u;return(f<<d|f>>>32-d)+r},n._blocksize=16,n._digestsize=16,XC.exports=function(o,r){if(o==null)throw new Error("Illegal argument "+o);var l=s.wordsToBytes(n(o,r));return r&&r.asBytes?l:r&&r.asString?i.bytesToString(l):s.bytesToHex(l)}})();var kM=XC.exports;const ax=im(kM);var Ac;(function(s){s.baseUrl="https://networking.needle.tools";function i(d){return ax(new Uint8Array(d))}s.hashMD5=i;function n(d){const u=ax(new Uint8Array(d),{encoding:"binary",asBytes:!0});return btoa(String.fromCharCode(...u))}s.hashMD5_Base64=n;function o(d){const u=new Uint8Array(d);return crypto.subtle.digest("SHA-256",u).then(p=>btoa(String.fromCharCode(...new Uint8Array(p))))}s.hashSha256=o;function r(d){const u=d.filesize/1024/1024;return Wo()?u<50:u<5}s.canUpload=r;async function l(d,u){var w;const f=s.baseUrl;if(f){if(!d.name)return console.error("Upload: file name is missing"),null}else return console.error("Blob storage base url is not set"),null;let p=null;d instanceof File?p=await d.arrayBuffer():p=d.data;const g=p.byteLength,_=g/1024/1024;if(_>50)return(u==null?void 0:u.silent)!==!0&&ke(`File (${_.toFixed(1)}MB) is too large for uploading (see console for details)`),console.warn(`Your file is too large for uploading (${_.toFixed(1)}MB). Max allowed size is 50MB`),null;if(!Wo()&&_>5)return(u==null?void 0:u.silent)!==!0&&ke('File is too large for uploading. Please get a <a href="https://needle.tools/pricing" target="_blank">commercial license</a> to upload files larger than 5MB'),console.warn(`Your file is too large for uploading (${_.toFixed(1)}MB). Max size is 5MB for non-commercial users. Please get a commercial license at https://needle.tools/pricing for larger files (up to 50MB)`),null;if(g<1)return console.warn(`Your file is too small for uploading (${_.toFixed(1)}MB). Min size is 1 byte`),null;const y=n(p),b={filename:d.name,"Content-Md5":y,"Content-Type":d.type||"application/octet-stream",FileSize:g.toString(),"Content-Disposition":`attachment; filename="${d.name}"`,"x-amz-server-side-encryption":"AES256"},v=await fetch(f+"/api/needle/blob",{method:"POST",headers:b,signal:u==null?void 0:u.abort}).then(P=>P.json()).catch(P=>(console.error(P),null));if(v==null)return console.warn("Upload failed..."),null;if("error"in v)return console.error(v.error),null;if("upload"in v&&v.upload){let T=function(k){var L;return(L=u==null?void 0:u.onProgress)==null||L.call(null,{progress01:0,state:"inprogress"}),fetch(k,{method:"PUT",headers:b,body:p,signal:u==null?void 0:u.abort}).then(O=>{var A;return(A=u==null?void 0:u.onProgress)==null||A.call(null,{progress01:1,state:"finished"}),O}).catch(O=>O)};console.debug("Uploading file",v.upload);let P=!1,E=null;for(let k=0;k<3;k++)try{if(P)break;if((w=u==null?void 0:u.abort)!=null&&w.aborted)return console.debug("Aborted upload"),null;const z=await T(v.upload);z instanceof Error?(E=z,await Ko(1e3*k)):z.ok&&(console.debug("File uploaded successfully"),P=!0)}catch(z){console.error(z)}if(!P)return console.error((E==null?void 0:E.message)||"Failed to upload file"),null}if("download"in v){const P=f+v.download;return console.debug("File found in blob storage",P),{key:v.key,success:!0,download_url:P}}return null}s.upload=l;function c(d){return`${s.baseUrl}/api/needle/blob/${d}`}s.getBlobUrlForKey=c;async function h(d,u){const f=new Y_;f.setResponseType("arraybuffer");const p=await f.loadAsync(d,g=>{u&&u.call(null,g)});return p instanceof ArrayBuffer?new Uint8Array(p):(console.error("Download failed, no arraybuffer returned"),null)}s.download=h})(Ac||(Ac={}));const lr=S("debugaddressables");class EM{constructor(t){a(this,"_context");a(this,"_assetReferences",{});a(this,"preUpdate",()=>{});this._context=t,this._context.pre_update_callbacks.push(this.preUpdate)}dispose(){const t=this._context.pre_update_callbacks.indexOf(this.preUpdate);t>=0&&this._context.pre_update_callbacks.splice(t,1);for(const e in this._assetReferences){const i=this._assetReferences[e];i==null||i.unload()}this._assetReferences={}}findAssetReference(t){return this._assetReferences[t]||null}registerAssetReference(t){return t.url&&(this._assetReferences[t.url]?console.warn("Asset reference already registered",t):this._assetReferences[t.url]=t),t}unregisterAssetReference(t){t.url&&delete this._assetReferences[t.url]}}const jg=Symbol("assetReference"),Ma=class{constructor(...t){a(this,"isAssetReference",!0);a(this,"_rawAsset",null);a(this,"_glbRoot");a(this,"_url");a(this,"_urlName");a(this,"_progressListeners",[]);a(this,"_isLoadingRawBinary",!1);a(this,"_rawBinary");a(this,"_loadingPromise",null);typeof t[0]=="object"?"url"in t[0]?this._url=t[0].url:(this._url="",t[0].asset&&(this.asset=t[0].asset)):(this._url=t[0],t[2]instanceof D&&(this.asset=t[2]));const e=this._url.lastIndexOf("/");if(e>=0){this._urlName=this._url.substring(e+1);const i=this._urlName.lastIndexOf(".");i>=0&&(this._urlName=this._urlName.substring(0,i))}else this._urlName=this._url;WE(this._url,this.onResolvePrefab.bind(this))}static getOrCreateFromUrl(t,e){if(!e&&(e=ne.Current,!e))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.');const i=e.addressables,n=i.findAssetReference(t);if(n)return n;const o=new Ma(t,e.hash);return i.registerAssetReference(o),o}static getOrCreate(t,e,i){if(typeof t=="string"){if(!i&&(i=ne.Current,!i))throw new Error('Context is required when sourceId is a string. When you call this method from a component you can call it with "getOrCreate(this, url)" where "this" is the component.')}else i=t.context,t=t.sourceId;const n=rl(t,e);lr&&console.log("GetOrCreate Addressable from",t,e,"FinalPath=",n);const o=i.addressables,r=o.findAssetReference(n);if(r)return r;const l=new Ma(n,i.hash);return o.registerAssetReference(l),l}get rawAsset(){return this._rawAsset}get asset(){var t;return this._glbRoot??(((t=this._rawAsset)==null?void 0:t.scene)||null)}set asset(t){t?this._rawAsset={animations:t.animations,scene:t,scenes:[t]}:this._rawAsset=null}get uri(){return this._url}get url(){return this._url}get urlName(){return this._urlName}get hasUrl(){return this._url!==void 0&&(this._url.startsWith("http")||this._url.startsWith("blob:")||this._url.startsWith("www.")||this._url.includes("/"))}async onResolvePrefab(t){return t===this.url&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0||kc(this.asset)===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(lr&&console.log("Unload",this.asset),"scene"in this.asset&&this.asset.scene&&Wn(this.asset.scene,!0,!0),Wn(this.asset,!0,!0)),this.asset=null,this._rawBinary=void 0,this._glbRoot=null,this._loadingPromise=null,ne.Current&&ne.Current.addressables.unregisterAssetReference(this)}async preload(){if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,lr&&console.log("Preload",this.url);const t=await Ac.download(this.url,e=>{this.raiseProgressEvent(e)});return this._rawBinary=(t==null?void 0:t.buffer)??null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(t){if(lr&&console.log("[AssetReference] loadAssetAsync",this.url),!this.mustLoad)return this.asset;if(t&&this._progressListeners.push(t),this._loadingPromise!==null)return this._loadingPromise.then(n=>this.asset);const e=ne.Current;if(this._rawBinary){if(!(this._rawBinary instanceof ArrayBuffer))return console.error("[AssetReference] Failed loading â€“ Invalid data. Must be of type ArrayBuffer. "+typeof this._rawBinary),null;this._loadingPromise=so().parseSync(e,this._rawBinary,this.url,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))}else lr&&console.log("Load async",this.url),this._loadingPromise=so().loadSync(e,this.url,this.url,null,n=>{this.raiseProgressEvent(n)});this._loadingPromise.finally(()=>this._loadingPromise=null);const i=await this._loadingPromise;return this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(i),i?(i[jg]=this,this._glbRoot&&(this._glbRoot[jg]=this),this.asset&&(this.asset[jg]=this),Kf(e),i.scene!==void 0&&(this._rawAsset=i),this.asset):null}instantiate(t){return this.onInstantiate(t,!1)}instantiateSynced(t,e=!0){return this.onInstantiate(t,!0,e)}beginListenDownload(t){this._progressListeners.indexOf(t)<0&&this._progressListeners.push(t)}endListenDownload(t){const e=this._progressListeners.indexOf(t);e>=0&&this._progressListeners.splice(e,1)}raiseProgressEvent(t){for(const e of this._progressListeners)e(this,t)}async onInstantiate(t,e=!1,i){const n=ne.Current,o=new lo;if(t instanceof D?o.parent=t:t&&(Object.assign(o,t),o.cloneAssign(t)),o.parent===void 0&&(o.parent=n.scene),this.mustLoad&&await this.loadAssetAsync(),lr&&console.log("Instantiate",this.url,"parent:",t),this.asset){lr&&console.log("Add to scene",this.asset);let r=Ma.currentlyInstantiating.get(this.url);if(r!==void 0&&r>=1e4)return console.error("Recursive or too many instantiations of "+this.url+" in the same frame ("+r+")"),null;try{if(r===void 0&&(r=0),r+=1,Ma.currentlyInstantiating.set(this.url,r),e){o.context=n;const l=this.asset;l.guid=this.url;const c=IC(l,o,void 0,i);if(c)return c}else{const l=Mc(this.asset,o);if(l)return l}}finally{n.post_render_callbacks.push(()=>{r===void 0||r<0?r=0:r-=1,Ma.currentlyInstantiating.set(this.url,r)})}}else lr&&console.warn("Failed to load asset",this.url);return null}tryGetActualGameObjectRoot(t){if(t&&t.scene){const e=t.scene;if(e.isGroup&&e.children.length===1&&e.children[0].name+"glb"===e.name){const i=e.children[0];return i.animations=e.animations,i}else return e}return null}};let he=Ma;a(he,"currentlyInstantiating",new Map);class MM extends Gn{constructor(){super([he],"AssetReferenceSerializer")}onSerialize(t,e){if(t&&t.uri!==void 0&&typeof t.uri=="string")return t.uri}onDeserialize(t,e){if(typeof t=="string")return e.context?e.gltfId?he.getOrCreate(e.gltfId,t,e.context):(console.error("Missing source id"),null):(console.error("Missing context"),null);if(t instanceof D){if(!e.context)return console.error("Missing context"),null;if(!e.gltfId)return console.error("Missing source id"),null;const i=t,n=e.context,o=i.guid??i.uuid,r=n.addressables.findAssetReference(o);if(r)return r;const l=new he(o,void 0,i);return n.addressables.registerAssetReference(l),l}return null}}new MM;const AM=Promise.resolve(null),Od=class{constructor(t){a(this,"url");a(this,"_bitmap");a(this,"_bitmapObject");a(this,"loader",null);this.url=t}static getOrCreate(t){let e=Od.imageReferences.get(t);return e||(e=new Od(t),Od.imageReferences.set(t,e)),e}dispose(){this._bitmapObject&&this._bitmapObject.close(),this._bitmap=void 0}createHTMLImage(){const t=new Image;return t.src=this.url,t}createTexture(){return this.url?(this.loader||(this.loader=new Bd),this.loader.setCrossOrigin("anonymous"),this.loader.loadAsync(this.url).then(t=>{var e;return t&&!((e=t.name)!=null&&e.length)&&(t.name=this.url.split("/").pop()??this.url),t})):(console.error("Can not load texture without url"),AM)}getBitmap(){return this._bitmap?this._bitmap:(this._bitmap=new Promise((t,e)=>{const i=document.createElement("img");i.addEventListener("load",()=>{this._bitmap=createImageBitmap(i).then(n=>(this._bitmapObject=n,t(n),n))}),i.addEventListener("error",n=>{console.error("Failed to load image:"+this.url,n),t(null)}),i.src=this.url}),this._bitmap)}};let id=Od;a(id,"imageReferences",new Map);class IM extends Gn{constructor(){super([id],"ImageReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=rl(e.gltfId,t);return id.getOrCreate(i)}}}new IM;const kd=class{constructor(t){a(this,"url");a(this,"res");this.url=t}static getOrCreate(t){let e=kd.cache.get(t);return e||(e=new kd(t),kd.cache.set(t,e)),e}async loadRaw(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.blob())}async loadText(){return this.res||(this.res=fetch(this.url)),this.res.then(t=>t.text())}};let nd=kd;a(nd,"cache",new Map);class DM extends Gn{constructor(){super([nd],"FileReferenceSerializer")}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"){const i=rl(e.gltfId,t);return nd.getOrCreate(i)}}}new DM;class LM{constructor(t){a(this,"context");a(this,"mixers",[]);this.context=t}onDestroy(){this.mixers.forEach(t=>t.stopAllAction()),this.mixers.length=0}registerAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.registerAnimationMixer called with null or undefined mixer");return}this.mixers.includes(t)||this.mixers.push(t)}unregisterAnimationMixer(t){if(!t){console.warn("AnimationsRegistry.unregisterAnimationMixer called with null or undefined mixer");return}const e=this.mixers.indexOf(t);e!==-1&&this.mixers.splice(e,1)}}class Hd{static tryGetActionsFromMixer(t){const e=t._actions;return e||null}static tryGetAnimationClipsFromObjectHierarchy(t,e){if(e||(e=new Array),t)t.animations&&e.push(...t.animations);else return e;if(t.children)for(const i of t.children)this.tryGetAnimationClipsFromObjectHierarchy(i,e);return e}static autoplayAnimations(t){if(!t||!t.animations)return console.debug("No animations found in file"),null;const e="scene"in t?t.scene:t,i=new Array;for(let o=0;o<t.animations.length;o++){const r=t.animations[o];if(!r.tracks||r.tracks.length<=0){console.warn("Animation has no tracks");continue}for(const l in r.tracks){const c=r.tracks[l],h=xc.parseTrackName(c.name);let d=xc.findNode(e,h.nodeName);if(!d){const f=c.__objectName??c.name.substring(0,c.name.indexOf("."));if(d=e.getObjectByProperty("uuid",f),!d)continue}let u=n(d)||n(e);if(!u){const f=M.get("Animation");if(u=e.addComponent(f),!u){console.error("Failed creating Animation component: No 'Animation' component found in TypeStore");break}}i.push(u),u.addClip&&u.addClip(r)}}return i;function n(o){var l;if(!o)return null;const r=(l=o.userData)==null?void 0:l.components;if(r&&r.length>0)for(let c=0;c<r.length;c++){const h=r[c];if(h.isAnimationComponent===!0)return h}return n(o.parent)}}}function*KC(s,t=null){const e=t?t.time:ne.Current.time,i=e.time;for(;e.time-i<s;)yield}function*P3(s){for(let t=0;t<s;t++)yield}function*jM(s){let t=!0;for(s.then(()=>t=!1),s.catch(()=>t=!1);t;)yield}const lx="NEEDLE_lightmaps",wh=S("debuglightmapsextension")||S("debuglightmaps");var ts;(function(s){s[s.Lightmap=0]="Lightmap",s[s.Skybox=1]="Skybox",s[s.Reflection=2]="Reflection"})(ts||(ts={}));class BM{constructor(t,e,i){a(this,"parser");a(this,"registry");a(this,"source");this.parser=t,this.registry=e,this.source=i}get name(){return lx}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[lx];if(i){const n=i.textures;return n!=null&&n.length?(wh&&console.log(i),new Promise(async(o,r)=>{const l=[];for(const h of n)if(h.pointer){wh&&console.log(h);let d=null;if(h.pointer.startsWith("/textures/")||h.pointer.startsWith("textures/"))wh&&console.log("Load texture from gltf",h.pointer),d=Sb(this.parser,h.pointer).then(u=>this.resolveTexture(h,u));else if(typeof h.pointer=="string"){wh&&console.log("Load texture from path",h.pointer);const u=rl(this.source,h.pointer);let f;u.endsWith(".exr")?f=new ib(this.parser.options.manager):u.endsWith(".hdr")?f=new Qw(this.parser.options.manager):f=new Bd(this.parser.options.manager),d=f.loadAsync(u,void 0).then(p=>this.resolveTexture(h,p))}else h.pointer;d&&l.push(d)}const c=await sS(l);c!=null&&c.anyFailed&&U()&&console.error("Failed to load lightmap extension",c),o()})):null}}return null}resolveTexture(t,e){const i=e;wh&&console.log("Lightmap loaded:",i),i!=null&&i.isTexture&&(this.registry?(i.colorSpace=Xo,this.registry.registerTexture(this.source,t.type,i,t.index)):console.log(ts[t.type],t.pointer,i))}}const Pl=!!S("debuglightmaps");class FM{constructor(t){a(this,"_context");a(this,"_lightmaps",new Map);this._context=t}clear(){this._lightmaps.clear()}registerTexture(t,e,i,n){Pl&&console.log("Registering ",ts[e]+' "'+t+'"',i),this._lightmaps.has(t)||this._lightmaps.set(t,new Map);const o=this._lightmaps.get(t),r=(o==null?void 0:o.get(e))??[];r.length<n&&(r.length=n+1),yE(i,!1),r[n]=i,o==null||o.set(e,r)}tryGetLightmap(t,e=0){return this.tryGet(t,ts.Lightmap,e)}tryGetSkybox(t){return Pl&&console.log("[Get Skybox]",t,this._lightmaps),this.tryGet(t,ts.Skybox,0)}tryGetReflection(t){return Pl&&console.log("[Get Reflection]",t,this._lightmaps),this.tryGet(t,ts.Reflection,0)}tryGet(t,e,i){if(!t)return Pl&&console.warn("Missing source id"),null;const n=this._lightmaps.get(t);if(!n)return Pl&&console.warn(`[Lighting] No ${ts[e]} texture entry for`,t),null;const o=n.get(e);return o===void 0?(Pl&&console.warn(`[Lighting] No ${ts[e]} texture for`,t,"index",i),null):!(o!=null&&o.length)||o.length<=i?null:o[i]}}Ai.lights_fragment_maps=Ai.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );",`
    vec2 lUv = vLightMapUv.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);Ai.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;Ai.lights_fragment_begin=Ai.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);QP.lightmap.lightmapScaleOffset={value:new Ce(1,1,0,0)};const Bg=S("debugprogressive"),Nu=new Nn,$u=new Hp;class JC{constructor(t){a(this,"context");a(this,"_lodsManager");a(this,"_settings",{});this.context=t}get manager(){return this._lodsManager}get skinnedMeshAutoUpdateBoundsInterval(){var t;return((t=this._lodsManager)==null?void 0:t.skinnedMeshAutoUpdateBoundsInterval)||this._settings.skinnedMeshAutoUpdateBoundsInterval||0}set skinnedMeshAutoUpdateBoundsInterval(t){this._settings.skinnedMeshAutoUpdateBoundsInterval=t,this.applySettings()}get targetTriangleDensity(){var t;return((t=this._lodsManager)==null?void 0:t.targetTriangleDensity)||this._settings.targetTriangleDensity||2e5}set targetTriangleDensity(t){this._settings.targetTriangleDensity=t,this.applySettings()}applySettings(){if(this._lodsManager)for(const t in this._settings)this._lodsManager[t]=this._settings[t]}setRenderer(t){var e;(e=this._lodsManager)==null||e.disable(),ma.removePlugin(this),ma.addPlugin(this),ma.debugDrawLine=G.DrawLine,this._lodsManager=ma.get(t,{engine:"needle-engine"}),this.applySettings(),this._lodsManager.enable()}disable(){var t;(t=this._lodsManager)==null||t.disable(),ma.removePlugin(this)}onAfterUpdatedLOD(t,e,i,n,o){Bg&&this.onRenderDebug(i,n,o)}onRenderDebug(t,e,i){var l,c,h;if(!e.geometry||!pt.hasLODLevelAvailable(e.geometry)&&!pt.hasLODLevelAvailable(e.material))return;const n=ma.getObjectLODState(e);if(!n)return;let o=i.mesh_lod;const r=i.mesh_lod!=n.lastLodLevel_Mesh||i.texture_lod!=n.lastLodLevel_Texture;if(Bg&&e.geometry.boundingSphere){const d=e.geometry.boundingSphere;$u.copy(d),$u.applyMatrix4(e.matrixWorld);const u=$u.center,f=$u.radius,p=["#76c43e","#bcc43e","#c4ac3e","#c4673e","#ff3e3e"];if(r)G.DrawWireSphere(u,f,p[o],.1);else{const g=((l=e.geometry.index)==null?void 0:l.count)??0,_=(c=pt.getMeshLODExtension(e.geometry))==null?void 0:c.lods;o=_?Math.min((_==null?void 0:_.length)-1,o):0;let y="";if(_&&n.lastScreenCoverage>0)for(let w=0;w<_.length;w++){const P=_[w].density,E=w==_.length-1;y+=P.toFixed(0)+">"+(P/n.lastScreenCoverage).toFixed(0)+(E?"":",")}const b=_?(h=_[o])==null?void 0:h.density:-1;let v="LOD "+i.mesh_lod+`
TEX `+i.texture_lod;if(Bg=="density"&&(v+=`
`+g+` tris
`+(b/n.lastScreenCoverage).toFixed(0)+` dens
`+(n.lastScreenCoverage*100).toFixed(1)+`% cov
`+(n.lastCentrality*100).toFixed(1)+`% centr
`+(Nu.min.x.toFixed(2)+"-"+Nu.max.x.toFixed(2)+"x"+Nu.min.y.toFixed(2)+"-"+Nu.max.y.toFixed(2))+" scr"),n.lastScreenCoverage>.1){const w=t,P=w.worldForward,E=w.worldPosition,k=q(P).multiplyScalar(f*.7).add(u),z=k.distanceTo(E),L=p[Math.min(p.length-1,Math.max(0,o))]+"88",O=this.context.domHeight>0?screen.height/this.context.domHeight:1,A=t.isPerspectiveCamera?Math.tan(t.fov*Math.PI/180/2):1;G.DrawLabel(k,v,z*.012*O*A,void 0,16777215,L)}}}}}a(JC,"GLTF_PROGRESSIVE_LODSMANAGER_TYPE",ma);const zM=S("debugplayerview");var No;(function(s){s.Browser="browser",s.Headset="headset",s.Handheld="handheld"})(No||(No={}));class UM{constructor(t,e){a(this,"userId");a(this,"context");a(this,"viewDevice",No.Browser);a(this,"removed",!1);a(this,"_object");this.userId=t,this.context=e}get currentObject(){return this._object}set currentObject(t){this._object=t}get isConnected(){return this.context.connection.userIsInRoom(this.userId)}}class NM{constructor(t){a(this,"context");a(this,"playerViews",new Map);this.context=t}setPlayerView(t,e,i){let n=this.playerViews.get(t);n||(n=new UM(t,this.context),this.playerViews.set(t,n)),n.viewDevice=i,n.currentObject=e,n.removed=!1}getPlayerView(t){if(!t)return;if(!this.context.connection.userIsInRoom(t)){this.playerViews.delete(t);return}return this.playerViews.get(t)}removePlayerView(t,e){const i=this.playerViews.get(t);(i==null?void 0:i.viewDevice)===e&&(zM&&console.log("REMOVE",t),i.removed=!0,this.playerViews.delete(t))}}new Y_;const ou=new Uint8Array(4);ou[0]=255;ou[1]=255;ou[2]=255;ou[3]=255;const $M=new K_(ou,1,1,Gp);function Ob(s,t=1){const e="alpha"in s,i=t*t,n=new Uint8Array(4*i),o=Math.floor(s.r*255),r=Math.floor(s.g*255),l=Math.floor(s.b*255);for(let h=0;h<i;h++){const d=h*4;n[d+0]=o,n[d+1]=r,n[d+2]=l,e?n[d+3]=Math.floor(s.alpha*255):n[d+3]=255}const c=new K_(n,t,t);return c.needsUpdate=!0,c}function WM(s,t,e,i=1,n=3){const r=i*n,l=[s,t,e],c=l.length,h=new Uint8Array(4*c*r),d=new de;for(let f=0;f<n;f++){const p=Math.floor(f/n*c),g=N.clamp(p+1,0,c-1),_=l[p],y=l[g],b=f/n*c%1;d.lerpColors(_,y,b);const v=Math.floor(d.r*255),w=Math.floor(d.g*255),P=Math.floor(d.b*255);for(let E=0;E<i;E++){const T=(f*i+E)*4;h[T+0]=v,h[T+1]=w,h[T+2]=P,h[T+3]=255}}const u=new K_(h,i,n);return u.needsUpdate=!0,u}var cx;(function(s){s[s.Vertex=0]="Vertex",s[s.Fragment=1]="Fragment"})(cx||(cx={}));function tp(s,t){const e=s.elements;t||(t=[]),t.length=0;for(let i=0;i<16;i+=4){const n=e[i],o=e[i+1],r=e[i+2],l=e[i+3],c=new Ce(n,o,r,l);t.push(c)}return t}const Fg=[],hx=[];function VM(s,t){if(Fg.length===0)for(let e=0;e<27;e++)Fg.push(0);t||(t=Fg);for(let e=0;e<27;e++)hx[e]=t[e];t=hx,s.unity_SHAr={value:new Ce(t[9],t[3],t[6],t[0])},s.unity_SHBr={value:new Ce(t[12],t[15],t[18],t[21])},s.unity_SHAg={value:new Ce(t[10],t[4],t[7],t[1])},s.unity_SHBg={value:new Ce(t[13],t[16],t[19],t[22])},s.unity_SHAb={value:new Ce(t[11],t[5],t[8],t[2])},s.unity_SHBb={value:new Ce(t[14],t[17],t[20],t[23])},s.unity_SHC={value:new Ce(t[24],t[25],t[26],1)}}class HM{constructor(t,e,i){a(this,"vertexShader");a(this,"fragmentShader");a(this,"technique");this.vertexShader=t,this.fragmentShader=e,this.technique=i}}async function GM(s,t){if(!s)return console.error("Can not find technique: no shader data"),null;const e=s.programs[t],i=e.vertexShader,n=e.fragmentShader;if(i!==void 0&&n!==void 0){const o=s.shaders[i],r=s.shaders[n];if(o.uri&&r.uri||o.code&&r.code){if(!o.code&&o.uri&&await dx(o),!r.code&&r.uri&&await dx(r),!o.code||!r.code)return null;const l=s.techniques[t];return new HM(o.code,r.code,l)}}return console.error("Shader technique not found",t),null}async function dx(s){const t=s.uri;if(t)if(t.endsWith(".glsl")){const i=await new Y_().loadAsync(t);s.code=i.toString()}else s.code=qM(s.uri)}function qM(s){return decodeURIComponent(Array.prototype.map.call(atob(s),function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""))}const Qn=S("debugenvlight");var $s;(function(s){s[s.Skybox=0]="Skybox",s[s.Trilight=1]="Trilight",s[s.Flat=3]="Flat",s[s.Custom=4]="Custom"})($s||($s={}));var Gd;(function(s){s[s.Skybox=0]="Skybox",s[s.Custom=1]="Custom"})(Gd||(Gd={}));class XM{constructor(t){a(this,"context");a(this,"_currentLightSettingsId");a(this,"_sceneLightSettings");a(this,"_timevec4",new Ce);a(this,"__currentReflectionId",null);a(this,"_lighting",{});this.context=t,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const t=this.context.time;this._timevec4.x=t.time,this._timevec4.y=Math.sin(t.time),this._timevec4.z=Math.cos(t.time),this._timevec4.w=t.deltaTime}get timeVec4(){return this._timevec4}get environmentIntensity(){if(!this._sceneLightSettings||!this._currentLightSettingsId)return 1;const t=this._sceneLightSettings.get(this._currentLightSettingsId);return t?t.ambientIntensity:1}get sceneLightSettings(){var t;return(t=this._sceneLightSettings)==null?void 0:t.values()}enable(t){var i;t instanceof he&&(t=t.url);const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?(Qn&&console.log("Enable scene light settings",t,e),t!==this._currentLightSettingsId&&this._currentLightSettingsId&&this.disable(this._currentLightSettingsId),this._currentLightSettingsId=t,e.enabled=!0,!0):(Qn&&console.warn("No light settings found for",t),!1)}disable(t){var i;if(t instanceof he&&(t=t.url),t==null)return!1;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);return e?(Qn&&console.log("Disable scene light settings",t,e),e.enabled=!1,!0):!1}disableCurrent(){if(this._currentLightSettingsId){const t=this._currentLightSettingsId;return this.disable(this._currentLightSettingsId),t}return null}internalRegisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not register:",t);return}Qn&&console.log("Register "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings||(this._sceneLightSettings=new Map),this._sceneLightSettings.set(e,t)}internalUnregisterSceneLightSettings(t){const e=t.sourceId;if(!e){console.error("Missing source id for scene light settings, can not unregister:",t);return}Qn&&console.log("Unregister "+(t==null?void 0:t.sourceId)+" lighting",t),this._sceneLightSettings&&this._sceneLightSettings.delete(e)}internalRegisterReflection(t,e){Qn&&console.log("Register reflection",t,e);const i=new QM(this.context,e,1);this._lighting[t]=i}internalGetReflection(t){return this._lighting[t]}internalEnableReflection(t){var i;this.__currentReflectionId=t;const e=(i=this._sceneLightSettings)==null?void 0:i.get(t);switch(Qn&&console.log("Enable reflection",t,e?$s[e.ambientMode]:"Unknown ambient mode",e),e==null?void 0:e.ambientMode){case $s.Skybox:case $s.Custom:const n=this.internalGetReflection(t);if(n&&n.Source){Qn&&console.log("Setting environment reflection",n);const o=this.context.scene,r=n.Source;r.mapping=zo,o.environment=r;return}else Qn&&console.warn("Could not find reflection for source",t);break}if((e==null?void 0:e.environmentReflectionSource)===Gd.Custom)switch(e==null?void 0:e.ambientMode){case $s.Trilight:if(e.ambientTrilight){const n=e.ambientTrilight,o=WM(n[0],n[1],n[2],64,64);o.colorSpace=Qo,o.mapping=zo,this.context.scene.environment=o}else console.error("Missing ambient trilight",e.sourceId);return;case $s.Flat:if(e.ambientLight){const n=Ob(e.ambientLight,64);n.colorSpace=Qo,n.mapping=zo,this.context.scene.environment=n}else console.error("Missing ambientlight",e.sourceId);return;default:return}}internalDisableReflection(t){if(t&&t!==this.__currentReflectionId){Qn&&console.log("Not disabling reflection for",t,"because it is not the current light settings id",this.__currentReflectionId);return}Qn&&console.log("Disable reflection",t);const e=this.context.scene;e.environment=null}}class QM{constructor(t,e,i=1){a(this,"_source");this._source=e,e.mapping=zo}get Source(){return this._source}}const ux=S("timescale");let u_=1;typeof ux=="number"&&(u_=ux);class YM{constructor(){a(this,"_time",0);a(this,"_deltaTime",0);a(this,"_deltaTimeUnscaled",0);a(this,"timeScale",1);a(this,"_frame",0);a(this,"clock",new YP);a(this,"_smoothedFps",0);a(this,"_smoothedDeltaTime",0);a(this,"_fpsSamples",[]);a(this,"_fpsSampleIndex",0);typeof u_=="number"&&(this.timeScale=u_)}get time(){return this._time}set time(t){this._time=t}get deltaTime(){return this._deltaTime}set deltaTime(t){this._deltaTime=t}get deltaTimeUnscaled(){return this._deltaTimeUnscaled}get frame(){return this._frame}set frame(t){this._frame=t}get frameCount(){return this.frame}get realtimeSinceStartup(){return this.clock.elapsedTime}get fps(){return 1/this.deltaTime}get smoothedFps(){return this._smoothedFps}get smoothedDeltaTime(){return 1/this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this._deltaTimeUnscaled=this.deltaTime,this.deltaTime<=0&&(this.deltaTime=1e-12),this.deltaTime*=this.timeScale,this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<60?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%60]=this.deltaTime;let t=0;for(let e=0;e<this._fpsSamples.length;e++)t+=this._fpsSamples[e];this._smoothedDeltaTime=t/this._fpsSamples.length,this._smoothedFps=1/this._smoothedDeltaTime}}let fx=!1;function ZC(s){fx||(fx=!0,KM(),JM())}ZC();function KM(){const s=`
float startCompression = 0.8;
float desaturation = 0.5;
// Patched tonemapping function
vec3 NeutralToneMapping( vec3 color ) {
    color *= toneMappingExposure;
    
    float d = 1. - startCompression;
    // float peak = dot(color, vec3(0.299, 0.587, 0.114));
    float peak = max(color.r, max(color.g, color.b));
    if (peak < startCompression) return color;
    float newPeak = 1. - d * d / (peak + d - startCompression);
    float invPeak = 1. / peak;
    
    float extraBrightness = dot(color * (1. - startCompression * invPeak), vec3(1, 1, 1));
    
    color *= newPeak * invPeak;
    float g = 1. - 3. / (desaturation * extraBrightness + 3.);
    return mix(color, vec3(1, 1, 1), g);
}
`,t="vec3 NeutralToneMapping( vec3 color ) {",e=`return mix( color, vec3( newPeak ), g );
}`,i=Ai.tonemapping_pars_fragment.indexOf(t),n=Ai.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=Ai.tonemapping_pars_fragment.substring(i,n+e.length);Ai.tonemapping_pars_fragment=Ai.tonemapping_pars_fragment.replace(o,s)}else U()&&console.error("Couldn't find NeutralToneMapping in ShaderChunk.tonemapping_pars_fragment")}function JM(){const s=`
// 0: Default, 1: Golden, 2: Punchy
#define AGX_LOOK 0        

vec3 userSlope = vec3(1.0);
vec3 userOffset = vec3(0.0);
vec3 userPower = vec3(1.0);
float userSaturation = 1.0;

// Mean error^2: 3.6705141e-06
vec3 _agxDefaultContrastApprox(vec3 x) {
    vec3 x2 = x * x;
    vec3 x4 = x2 * x2;
    
    return  + 15.5     * x4 * x2
            - 40.14    * x4 * x
            + 31.96    * x4
            - 6.868    * x2 * x
            + 0.4298   * x2
            + 0.1191   * x
            - 0.00232;
}

vec3 _agx(vec3 val) {
    const mat3 agx_mat = mat3(
        0.842479062253094, 0.0423282422610123, 0.0423756549057051,
        0.0784335999999992,  0.878468636469772,  0.0784336,
        0.0792237451477643, 0.0791661274605434, 0.879142973793104);
    
    const float min_ev = -12.47393;
    const float max_ev = 4.026069;

    // val = pow(val, vec3(2.2)); 

    // Input transform (inset)
    val = agx_mat * val;
    
    // Log2 space encoding
    val = clamp(log2(val), min_ev, max_ev);
    val = (val - min_ev) / (max_ev - min_ev);
    
    // Apply sigmoid function approximation
    val = _agxDefaultContrastApprox(val);

    return val;
}

vec3 _agxEotf(vec3 val) {
    const mat3 agx_mat_inv = mat3(
        1.19687900512017, -0.0528968517574562, -0.0529716355144438,
        -0.0980208811401368, 1.15190312990417, -0.0980434501171241,
        -0.0990297440797205, -0.0989611768448433, 1.15107367264116);
        
    // Inverse input transform (outset)
    val = agx_mat_inv * val;
    
    // sRGB IEC 61966-2-1 2.2 Exponent Reference EOTF Display
    // NOTE: We're linearizing the output here. Comment/adjust when
    // *not* using a sRGB render target
    val = pow(val, vec3(2.2)); 

    return val;
}

vec3 _agxLook(vec3 val) {
    const vec3 lw = vec3(0.2126, 0.7152, 0.0722);
    float luma = dot(val, lw);
    
    // Default
    vec3 offset = vec3(0.0);
    vec3 slope = vec3(1.0);
    vec3 power = vec3(1.0);
    float sat = 1.0;
    
    #if AGX_LOOK == 1
    // Golden
    slope = vec3(1.0, 0.9, 0.5);
    power = vec3(0.8);
    sat = 0.8;
    #elif AGX_LOOK == 2
    // Punchy
    slope = vec3(1.0);
    power = vec3(1.35, 1.35, 1.35);
    sat = 1.4;
    #endif        
    
    // Needle
    slope = vec3(1.05);
    power = vec3(1.10, 1.10, 1.10);
    sat = 1.15;

    // User
    // slope = userSlope;
    // offset = userOffset;
    // power = userPower;
    // sat = userSaturation;
    
    // ASC CDL
    val = pow(val * slope + offset, power);
    return luma + sat * (val - luma);
}


vec3 AgXToneMapping( vec3 color ) {
    // apply AGX
    color *= toneMappingExposure;
    color = max(color, vec3(0.001)); // Prevent NaN
    color = _agx(color);
    color = _agxLook(color); // Optional
    color = _agxEotf(color);
    return color;
`,t="vec3 AgXToneMapping( vec3 color ) {",e="return color;",i=Ai.tonemapping_pars_fragment.indexOf(t),n=Ai.tonemapping_pars_fragment.indexOf(e,i);if(i>=0&&n>=0){const o=Ai.tonemapping_pars_fragment.substring(i,n+e.length);Ai.tonemapping_pars_fragment=Ai.tonemapping_pars_fragment.replace(o,s)}else U()&&console.error("Couldn't find AgXToneMapping in ShaderChunk.tonemapping_pars_fragment")}function e1(s){if(typeof s=="string")switch(s=s.toLowerCase(),s){case"none":return Ff;case"neutral":return wc;case"aces":return Xp;case"agx":return qp;case"khronos_neutral":return wc;default:console.warn("[PostProcessing] Unknown tone mapping mode",s);return}}function mi(s){const t=document.createElement("span");return t.style.maxWidth="48px",t.style.maxHeight="48px",t.style.overflow="hidden",t.classList.add("material-symbols-outlined","notranslate"),t.setAttribute("translate","no"),t.innerText=s,t}function ZM(s){var e;return((e=s.classList)==null?void 0:e.contains("material-symbols-outlined"))||!1}const Wu=new Map;async function px(s){const t="Material Symbols Outlined";if(document.fonts.check(`1em '${t}'`)||(console.log("Font not loaded yet"),await document.fonts.ready),Wu.has(s))return Wu.get(s);const e=document.createElement("canvas"),i=48;e.width=i,e.height=i;const n=e.getContext("2d");if(n){n.font=`${i}px '${t}'`,n.fillStyle="black",n.fillText(s,0,i);const o=e.toDataURL(),r=new Ke;return r.name=s+" icon",r.image=new Image,r.image.src=o,r.needsUpdate=!0,Wu.set(s,r),r}return Wu.set(s,null),null}const Mp=class{constructor(){a(this,"_fullscreenButton");a(this,"_muteButton");a(this,"_qrButton");a(this,"_customQRButtonUrl")}static get instance(){return this.getOrCreate()}static getOrCreate(){return this._instance||(this._instance=new Mp),this._instance}static create(){return new Mp}get fullscreenButton(){return this._fullscreenButton}createFullscreenButton(t){if(this._fullscreenButton)return this._fullscreenButton;if(!document.fullscreenEnabled)return U()&&console.warn("NeedleMenu: Fullscreen button could not be created, device doesn't support the Fullscreen API"),null;const e=document.createElement("button");this._fullscreenButton=e,e.classList.add("fullscreen-button"),e.title="Click to enter fullscreen mode";const i=mi("fullscreen"),n=mi("fullscreen_exit");return e.appendChild(i),e.onclick=()=>{document.fullscreenElement?document.exitFullscreen():"webkitRequestFullscreen"in t.domElement&&typeof t.domElement.webkitRequestFullscreen=="function"?t.domElement.webkitRequestFullscreen():"requestFullscreen"in t.domElement&&t.domElement.requestFullscreen()},document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(i.remove(),e.appendChild(n),e.title="Click to enter fullscreen mode"):(n.remove(),e.appendChild(i),e.title="Click to exit fullscreen mode")}),globalThis.addEventListener("needle-xrsession-start",()=>{e.style.display="none"}),globalThis.addEventListener("needle-xrsession-end",()=>{e.style.display=""}),e}get muteButton(){return this._muteButton}createMuteButton(t){if(this._muteButton)return this._muteButton;const e=document.createElement("button");this._muteButton=e,e.classList.add("mute-button"),e.title="Click to mute/unmute";const i=mi("volume_off"),n=mi("volume_up");return t.application.muted?e.appendChild(i):e.appendChild(n),e.onclick=()=>{t.application.muted?(i.remove(),e.appendChild(n),t.application.muted=!1):(n.remove(),e.appendChild(i),t.application.muted=!0)},e}get qrButton(){return this._qrButton}set qrButtonUrl(t){try{new URL(t),this._customQRButtonUrl=t}catch{console.warn(`[Needle] QR code button URL is not a valid URL '${t}'`)}}get qrButtonUrl(){return this._customQRButtonUrl||window.location.href}createQRCode(){if(this._qrButton)return this._qrButton;const t=this,e=document.createElement("button");this._qrButton=e,e.innerText="QR Code",e.prepend(mi("qr_code")),e.title="Scan this QR code with your phone to open this page",this.hideElementDuringXRSession(e);const i=document.createElement("div");i.style.cssText=`
            position: fixed;
            display: inline-block;
            padding: 0.5rem;
            background-color: white;
            border-radius: 0.4rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        `;const n=document.createElement("div");n.classList.add("qr-code-container"),i.appendChild(n),e.addEventListener("click",()=>{if(i.parentNode)return r();U()&&window.location.href.includes("://localhost")&&ke("To access your website from another device in the same local network you have to use the IP address instead of localhost. The IP address is logged in your development server console when you start the server."),o()});async function o(){await l();const h=document.body.querySelector("needle-engine")||document.body;h.appendChild(i);const d=n.getBoundingClientRect(),u=e.getBoundingClientRect();i.style.left=u.left+u.width*.5-d.width*.5+"px";const f=u.top<d.height,p="1.3rem";f?i.style.top=`calc(${u.bottom}px + ${i.style.padding} + 0.0rem)`:i.style.top=`calc(${u.top-d.height}px - ${i.style.padding} - ${p})`,i.style.opacity="0",i.style.pointerEvents="all",i.style.transition="opacity 0.2s ease-in-out",setTimeout(()=>{i.style.opacity="1",window.addEventListener("click",r,{once:!0})}),window.addEventListener("resize",r),window.addEventListener("scroll",r),document.fullscreenElement?document.fullscreenElement.appendChild(i):h.appendChild(i)}function r(){i.style.pointerEvents="none",i.style.transition="opacity 0.2s",i.style.opacity="0",setTimeout(()=>{var c;return(c=i.parentNode)==null?void 0:c.removeChild(i)},500),window.removeEventListener("click",r),window.removeEventListener("resize",r),window.removeEventListener("scroll",r)}async function l(){const h=await QT({text:t.qrButtonUrl,width:200,height:200});n.innerHTML="",n.appendChild(h)}return e.addEventListener("pointerenter",()=>{l()},{once:!0}),e}hideElementDuringXRSession(t){ub(e=>{t["previous-display"]=t.style.display,t.style.display="none"}),PS(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}};let Hs=Mp;a(Hs,"_instance");function ip(s,t){const e=(t==null?void 0:t.element)||document.head,i=Array.from(e.querySelectorAll(`link[rel=stylesheet][href*='${s}']`));if(i.length<=0){const n=document.createElement("link");n.href=s,n.rel="stylesheet",e.appendChild(n),i.push(n)}if(t!=null&&t.loadedCallback)for(let n=0;n<i.length;n++)t!=null&&t.loadedCallback&&i[n].addEventListener("load",t.loadedCallback)}function t1(){ip("https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap")}const f_="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=block",np="needle-logo-element";class i1 extends HTMLElement{constructor(){super();a(this,"_root");a(this,"wrapper");a(this,"logoElement",document.createElement("img"));a(this,"textElement",document.createElement("span"));this._root=this.attachShadow({mode:"closed"});const e=document.createElement("template");e.innerHTML=`<style>
        :host {
            position: relative;
            min-width: fit-content;
            /* height: 100%; can not have height 100% because of align-items: stretch; in the parent */
            display: flex;
        }

        .wrapper {
            position: relative;
            display: grid;
            grid-template-columns: auto auto;
            padding: .1rem;
        }
        .wrapper:hover {
            cursor: pointer;
        }
        img {
            width: 95px;
            height: 100%;
            align-self: end;
            margin-left: 0.6rem;
        }
        span {
            font-size: 1rem;
            white-space: nowrap;
        }
        </style>
        <div class="wrapper">
            <img class="logo" src=${zT} />
        </div>
        `,this._root.appendChild(e.content.cloneNode(!0)),this.wrapper=this._root.querySelector(".wrapper"),this._root.appendChild(this.wrapper),this.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")}),this.wrapper.setAttribute("title","Made with Needle Engine")}static get elementName(){return np}static create(){return document.createElement(np)}setLogoVisible(e){this.logoElement.style.display=e?"block":"none"}}customElements.get(np)||customElements.define(np,i1);const zg=S("debugspatialmenu");class eA{constructor(t,e){a(this,"_context");a(this,"needleMenu");a(this,"htmlButtonsMap",new Map);a(this,"enabled",!0);a(this,"userRequestedMenu",!1);a(this,"uiisDirty",!1);a(this,"_showNeedleLogo");a(this,"_wasInXR",!1);a(this,"preRender",()=>{var e;if(!this.enabled){(e=this.menu)==null||e.removeFromParent();return}zg&&K.isDesktop()&&this.updateMenu();const t=this._context.xr;if(!(t!=null&&t.running)){this._wasInXR&&(this._wasInXR=!1,this.onExitXR());return}this._wasInXR||(this._wasInXR=!0,this.onEnterXR()),this.updateMenu()});a(this,"_menuTarget",new D);a(this,"positionFilter",new cS(90,.5));a(this,"familyName","Needle Spatial Menu");a(this,"menu");a(this,"_poweredByNeedleElement");var n;this._context=t,this._context.pre_render_callbacks.push(this.preRender),this.needleMenu=e;const i=(n=this.needleMenu.shadowRoot)==null?void 0:n.querySelector(".options");i?new MutationObserver(r=>{if(this.enabled&&!(this._context.isInXR==!1&&!zg))for(const l of r)l.type==="childList"&&(l.addedNodes.forEach(c=>{this.createButtonFromHTMLNode(c)}),l.removedNodes.forEach(c=>{const h=c,d=this.htmlButtonsMap.get(h);d&&(this.htmlButtonsMap.delete(h),d.remove(),ze.update())}))}).observe(i,{childList:!0}):console.error("Could not find options container in needle menu")}setEnabled(t){var e;this.enabled=t,t||(e=this.menu)==null||e.removeFromParent()}setDisplay(t){return this.enabled?(this.userRequestedMenu=t,!0):!1}onDestroy(){const t=this._context.pre_render_callbacks.indexOf(this.preRender);t>-1&&this._context.pre_render_callbacks.splice(t,1)}markDirty(){this.uiisDirty=!0}showNeedleLogo(t){this._showNeedleLogo=t}onEnterXR(){var e;const t=(e=this.needleMenu.shadowRoot)==null?void 0:e.querySelector(".options");t&&t.childNodes.forEach(i=>{this.createButtonFromHTMLNode(i)})}onExitXR(){var t;(t=this.menu)==null||t.removeFromParent()}createButtonFromHTMLNode(t){const e=this.getMenu(),i=this.htmlButtonsMap.get(t);if(i){i.add();return}if(t instanceof HTMLButtonElement){const n=this.createButton(e,t);this.htmlButtonsMap.set(t,n),n.add()}else t instanceof HTMLSlotElement&&t.assignedNodes().forEach(n=>{this.createButtonFromHTMLNode(n)})}updateMenu(){var o,r;const t=this.getMenu();this.handleNeedleWatermark(),this._context.scene.add(t);const e=this._context.mainCamera,i=this._context.xr,n=(i==null?void 0:i.rigScale)||1;if(e){const l=e.worldPosition,c=e.worldForward.multiplyScalar(-1),h=c.y>.6,d=c.y>.4,u=(t.visible?d:h)||this.userRequestedMenu,f=!t.visible&&u;t.visible=u||K.isDesktop()&&zg,c.multiplyScalar(3*n),l.add(c),(f||!1)&&(t.position.copy(this._menuTarget.position),t.position.y+=.25,this._menuTarget.position.copy(t.position),this.positionFilter.reset(t.position),t.quaternion.copy(this._menuTarget.quaternion),this.markDirty());const g=this._menuTarget.position.distanceTo(l);(f||g>1.5*n)&&(this.ensureRenderOnTop(this.menu),this._menuTarget.position.copy(l),this._context.scene.add(this._menuTarget),Zp(this._menuTarget,this._context.mainCamera,!0,!0),this._menuTarget.removeFromParent()),this.positionFilter.filter(this._menuTarget.position,t.position,this._context.time.time);const _=5;(o=this.menu)==null||o.quaternion.slerp(this._menuTarget.quaternion,this._context.time.deltaTime*_),(r=this.menu)==null||r.scale.setScalar(n)}this.uiisDirty&&(this.uiisDirty=!1,ze.update())}ensureRenderOnTop(t,e=0){t instanceof X&&(t.material.depthTest=!1,t.material.depthWrite=!1),t.renderOrder=1e3+e*2;for(const i of t.children)this.ensureRenderOnTop(i,e+1)}get isVisible(){var t;return(t=this.menu)==null?void 0:t.visible}getMenu(){if(this.menu)return this.menu;this.ensureFont(),this.menu=new ze.Block({boxSizing:"border-box",fontFamily:this.familyName,height:"auto",fontSize:.1,color:0,lineHeight:1,backgroundColor:16777215,backgroundOpacity:.55,borderRadius:1,whiteSpace:"pre-wrap",flexDirection:"row",alignItems:"center",padding:new Ce(0,.05,0,.05),borderColor:0,borderOpacity:.05,borderWidth:.005});const t=M.get("ObjectRaycaster");return t&&uc(this.menu,new t),this.menu}handleNeedleWatermark(){var t;if(!this._poweredByNeedleElement){this._poweredByNeedleElement=new ze.Block({width:"auto",height:"auto",fontSize:.05,whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",margin:.02,borderRadius:.02,padding:.02,backgroundColor:16777215,backgroundOpacity:1}),this._poweredByNeedleElement["needle:use_eventsystem"]=!0;const e=new mx(this._context,()=>globalThis.open("https://needle.tools","_self"));uc(this._poweredByNeedleElement,e);const i=new ze.Text({textContent:"Powered by",width:"auto",height:"auto"}),n=new ze.Text({textContent:"needle",width:"auto",height:"auto",fontSize:.07,margin:new Ce(0,0,0,.02)});this._poweredByNeedleElement.add(i),this._poweredByNeedleElement.add(n),(t=this.menu)==null||t.add(this._poweredByNeedleElement),this.markDirty(),new Bd().load("./include/needle/poweredbyneedle.webp",r=>{var c;e.allowModifyUI=!1,i.removeFromParent(),n.removeFromParent();const l=r.image.width/r.image.height;(c=this._poweredByNeedleElement)==null||c.set({backgroundImage:r,backgroundOpacity:1,width:.1*l,height:.1}),this.markDirty()})}if(this.menu){const e=this.menu.children.indexOf(this._poweredByNeedleElement);if(!this._showNeedleLogo&&$o())e>=0&&(this._poweredByNeedleElement.removeFromParent(),this.markDirty());else{this._poweredByNeedleElement.visible=!0,this.menu.add(this._poweredByNeedleElement);const i=this.menu.children.indexOf(this._poweredByNeedleElement);e!==i&&this.markDirty()}}}ensureFont(){let t=ze.FontLibrary.getFontFamily(this.familyName);if(!t){t=ze.FontLibrary.addFontFamily(this.familyName);const e=t.addVariant("normal","normal","./include/needle/arial-msdf.json","./include/needle/arial.png");e==null||e.addEventListener("ready",()=>{this.markDirty()})}}createButton(t,e){const i=new ze.Block({width:"auto",height:"auto",whiteSpace:"pre-wrap",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",backgroundColor:16777215,backgroundOpacity:0,padding:.02,margin:.01,borderRadius:.02,cursor:"pointer",fontSize:.05}),n=new ze.Text({textContent:"",width:"auto",justifyContent:"center",alignItems:"center",backgroundOpacity:0,backgroundColor:16777215,fontFamily:this.familyName,color:0,borderRadius:.02,padding:.01});i.add(n),i["needle:use_eventsystem"]=!0;const o=new mx(this._context,()=>e.click());return uc(i,o),new tA(this,t,e,i,n)}}class tA{constructor(t,e,i,n,o){a(this,"menu");a(this,"root");a(this,"htmlbutton");a(this,"spatialContainer");a(this,"spatialText");a(this,"spatialIcon");a(this,"_lastText","");a(this,"_lastTexture");this.menu=t,this.root=e,this.htmlbutton=i,this.spatialContainer=n,this.spatialText=o,new MutationObserver(l=>{for(const c of l)c.type==="attributes"?c.attributeName==="style"&&this.updateVisible():c.type==="childList"&&this.updateText()}).observe(i,{attributes:!0,childList:!0}),this.updateText()}add(){this.spatialContainer.parent!=this.root&&(this.root.add(this.spatialContainer),this.menu.markDirty(),this.updateVisible(),this.updateText())}remove(){this.spatialContainer.parent&&(this.spatialContainer.removeFromParent(),this.menu.markDirty())}updateVisible(){const t=this.spatialContainer.visible;this.spatialContainer.visible=this.htmlbutton.style.display!=="none",t!==this.spatialContainer.visible&&this.menu.markDirty()}updateText(){let t="",e="";this.htmlbutton.childNodes.forEach(i=>{i.nodeType===Node.TEXT_NODE?t+=i.textContent:i instanceof HTMLElement&&ZM(i)&&i.textContent&&(e=i.textContent)}),this._lastText!==t&&(this._lastText=t,this.spatialText.name=t,this.spatialText.set({textContent:t}),this.menu.markDirty()),t.length<=0?this.spatialText.parent&&(this.spatialText.removeFromParent(),this.menu.markDirty()):this.spatialText.parent||(this.spatialContainer.add(this.spatialText),this.menu.markDirty()),e&&this.createIcon(e)}async createIcon(t){var i;if(!this.spatialIcon){const n=await px(t);if(n&&!this.spatialIcon){const r=new ze.Block({width:.08,height:.08,backgroundColor:16777215,backgroundImage:n,backgroundOpacity:1,margin:new Ce(0,.005,0,0)});this.spatialIcon=r,this.spatialContainer.add(r),this.menu.markDirty()}}if(t!=this._lastTexture){this._lastTexture=t;const n=await px(t);n&&((i=this.spatialIcon)==null||i.set({backgroundImage:n}),this.menu.markDirty())}const e=this.spatialContainer.children.indexOf(this.spatialIcon);e>0&&(this.spatialContainer.children.splice(e,1),this.spatialContainer.children.unshift(this.spatialIcon),this.menu.markDirty())}}class mx{constructor(t,e){a(this,"isComponent",!0);a(this,"enabled",!0);a(this,"gameObject");a(this,"allowModifyUI",!0);a(this,"context");a(this,"onclick");this.context=t,this.onclick=e}get activeAndEnabled(){return!0}__internalAwake(){}__internalEnable(){}__internalDisable(){}__internalStart(){}onEnable(){}onDisable(){}get element(){return this.gameObject}onPointerEnter(){this.context.input.setCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:1}),ze.update())}onPointerExit(){this.context.input.unsetCursor("pointer"),this.allowModifyUI&&(this.element.set({backgroundOpacity:0}),ze.update())}onPointerDown(t){t.use()}onPointerUp(t){t.use()}onPointerClick(t){t.use(),this.onclick()}}const Ra="needle-menu",sd=S("debugmenu"),gx=S("debugnoncommercial");let iA=class{constructor(t){a(this,"_context");a(this,"_menu");a(this,"_spatialMenu");a(this,"onPostMessage",t=>{if(t.origin===globalThis.location.origin&&typeof t.data=="object"){const e=t.data,i=e.type;if(i==="needle:menu"){const n=e.button;if(n){if(!n.label)return console.error("NeedleMenu: buttoninfo.label is required");if(!n.onclick)return console.error("NeedleMenu: buttoninfo.onclick is required");const o=document.createElement("button");if(o.textContent=n.label,n.icon){const r=mi(n.icon);o.prepend(r)}n.priority&&o.setAttribute("priority",n.priority.toString()),o.onclick=()=>{if(n.onclick){const r=n.onclick.startsWith("http")||n.onclick.startsWith("www."),l=n.target||"_blank";r?globalThis.open(n.onclick,l):console.error("NeedleMenu: onclick is not a valid link",n.onclick)}},this._menu.appendChild(o)}else sd&&console.error("NeedleMenu: unknown postMessage event",e)}else sd&&console.warn("NeedleMenu: unknown postMessage type",i,e)}});a(this,"onStartXR",t=>{t.session.isScreenBasedAR&&(this._menu.previousParent=this._menu.parentNode,this._context.arOverlayElement.appendChild(this._menu),t.session.session.addEventListener("end",this.onExitXR),this._menu.closeFoldout())});a(this,"onExitXR",()=>{this._menu.previousParent&&(this._menu.previousParent.appendChild(this._menu),delete this._menu.previousParent)});a(this,"_muteButton");a(this,"_fullscreenButton");this._menu=sp.getOrCreate(t.domElement,t),this._context=t,this._spatialMenu=new eA(t,this._menu),window.addEventListener("message",this.onPostMessage),ub(this.onStartXR)}onDestroy(){window.removeEventListener("message",this.onPostMessage),this._menu.remove(),this._spatialMenu.onDestroy()}setPosition(t){this._menu.setPosition(t)}setVisible(t){this._menu.setVisible(t)}showNeedleLogo(t){var e;this._menu.showNeedleLogo(t),(e=this._spatialMenu)==null||e.showNeedleLogo(t)}get logoIsVisible(){return this._menu.logoIsVisible}showSpatialMenu(t){this._spatialMenu.setEnabled(t)}setSpatialMenuVisible(t){this._spatialMenu.setDisplay(t)}get spatialMenuIsVisible(){return this._spatialMenu.isVisible}showQRCodeButton(t){if(t==="desktop-only"&&(t=!K.isMobileDevice()),t){const e=Hs.getOrCreate().createQRCode();return e.style.display="",this._menu.appendChild(e),e}else{const e=Hs.getOrCreate().qrButton;return e&&(e.style.display="none"),e??null}}showAudioPlaybackOption(t){var e;if(!t){(e=this._muteButton)==null||e.remove();return}this._muteButton=Hs.getOrCreate().createMuteButton(this._context),this._muteButton.setAttribute("priority","100"),this._menu.appendChild(this._muteButton)}showFullscreenOption(t){var e;if(!t){(e=this._fullscreenButton)==null||e.remove();return}this._fullscreenButton=Hs.getOrCreate().createFullscreenButton(this._context),this._fullscreenButton&&(this._fullscreenButton.setAttribute("priority","150"),this._menu.appendChild(this._fullscreenButton))}appendChild(t){return this._menu.appendChild(t)}};var Jd;const S0=class extends HTMLElement{constructor(){var u,f,p,g,_,y;super();a(this,"_domElement",null);a(this,"_context",null);a(this,"_sizeChangeInterval");On(this,Jd,e=>{if(!e.defaultPrevented&&e.target==this._domElement&&e instanceof PointerEvent&&e.button===0&&this.root.classList.contains("open")){const i=this.foldout.getBoundingClientRect(),n=e;n.clientX>i.left&&n.clientX<i.right&&n.clientY>i.top&&n.clientY<i.bottom||this.root.classList.toggle("open",!1)}});a(this,"_userRequestedLogoVisible");a(this,"_userRequestedMenuVisible");a(this,"root");a(this,"wrapper");a(this,"options");a(this,"logoContainer");a(this,"compactMenuButton");a(this,"foldout");a(this,"_isHandlingChange",!1);a(this,"_didSort",new Map);a(this,"_lastAvailableWidthChange",0);a(this,"_timeoutHandle",0);a(this,"handleSizeChange",(e,i)=>{if(!this._domElement)return;const n=this._domElement.clientWidth;if(n<100){clearTimeout(this._timeoutHandle),this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style");return}const o=20*2,r=n-o;if(!i&&Math.abs(r-this._lastAvailableWidthChange)<1)return;this._lastAvailableWidthChange=r,clearTimeout(this._timeoutHandle),this._timeoutHandle=setTimeout(()=>{const h=c();h<0?(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")):h>0&&(this.root.classList.remove("compact"),this.foldout.classList.remove("floating-panel-style"),c()<0&&(this.root.classList.add("compact"),this.foldout.classList.add("floating-panel-style")))},5);const l=()=>this.options.clientWidth+this.logoContainer.clientWidth,c=()=>r-l()});const e=document.createElement("template");e.innerHTML=`<style>

        /** Styling attributes that ensure the nested menu z-index does not cause it to overlay elements outside of <needle-engine> */
        :host {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
            top: 0;
            pointer-events: none;
        }

        #root {
            position: absolute;
            width: auto;
            max-width: 95%;
            left: 50%;
            transform: translateX(-50%);
            top: min(20px, 10vh);
            padding: 0.3rem;
            display: flex;
            visibility: visible;
            flex-direction: row-reverse; /* if we overflow this should be right aligned so the logo is always visible */
            pointer-events: all;
            z-index: 1000;
        }

        /** hide the menu if it's empty **/
        #root.has-no-options.logo-hidden {
            display: none; 
        }

        /** using a div here because then we can change the class for placement **/
        #root.bottom {
            top: auto;
            bottom: min(30px, 10vh);
        }
        #root.top {
            top: calc(.7rem + env(safe-area-inset-top));
        }
        
        .wrapper {
            position: relative;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: stretch;
            gap: 0px;
            padding: 0 0rem;
        }

        .wrapper > *, .options > button, .options > select, ::slotted(*) {
            position: relative;
            border: none;
            border-radius: 0;
            outline: 1px solid rgba(0,0,0,0);
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 2.3rem;
            max-width: 100%;

            /** basic font settings for all entries **/
            font-size: 1rem;
            font-family: 'Roboto Flex', sans-serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-weight: 200;
            font-variation-settings: "wdth" 100;
            color: rgb(20,20,20);
        }

        .options > select[multiple]:hover {
            max-height: 300px;
        }

        .floating-panel-style {
            background: rgba(255, 255, 255, .4);
            outline: rgb(0 0 0 / 5%) 1px solid;
            border: 1px solid rgba(255, 255, 255, .1);
            box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0,0,0,.05);
            border-radius: 1.5rem;
            /** 
             * to make nested background filter work 
             * https://stackoverflow.com/questions/60997948/backdrop-filter-not-working-for-nested-elements-in-chrome 
             **/
            &::before {
                content: '';
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                z-index: -1;
                border-radius: 1.5rem;
                -webkit-backdrop-filter: blur(8px);
                backdrop-filter: blur(8px);
            }
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .options {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .options > *, ::slotted(*) {
            max-height: 2.25rem;
            padding: .4rem .5rem;
        }
        
        :host .options > *, ::slotted(*) {
            background: transparent;
            border: none;
            white-space: nowrap;
            transition: all 0.1s linear .02s;
            border-radius: 1.5rem;
            user-select: none;
        }
        :host .options > *:hover, ::slotted(*:hover) {
            cursor: pointer;
            color: black;
            background: rgba(245, 245, 245, .8);
            box-shadow: inset 0 0 1rem rgba(0,0,30,.2);
            outline: rgba(0,0,0,.1) 1px solid;
        }
        :host .options > *:active, ::slotted(*:active) {
            background: rgba(255, 255, 255, .8);
            box-shadow: inset 0px 1px 1px rgba(255,255,255,.5), inset 0 0 2rem rgba(0,0,30,.2), inset 0px 2px 4px rgba(0,0,20,.5);
            transition: all 0.05s linear;
        }
        :host .options > *:focus, ::slotted(*:focus) {
            outline: rgba(255,255,255,.5) 1px solid;
        }
        :host .options > *:focus-visible, ::slotted(*:focus-visible) {
            outline: rgba(0,0,0,.5) 1px solid;
        }

        :host .options > *:disabled, ::slotted(*:disabled) {
            background: rgba(0,0,0,.05);
            color: rgba(60,60,60,.7);
            pointer-events: none;
        }

        button, ::slotted(button) {
            gap: 0.3rem;
        }

        /** XR button animation **/
        :host button.this-mode-is-requested {
            background: repeating-linear-gradient(to right, #fff 0%, #fff 40%, #aaffff 55%, #fff 80%);
            background-size: 200% auto;
            background-position: 0 100%;
            animation: AnimationName .7s ease infinite forwards;
        }
        :host button.other-mode-is-requested {
            opacity: .5;
        }
        
        @keyframes AnimationName {
            0% { background-position: 0% 0 }
            100% { background-position: -200% 0 }
        }




        .logo {
            cursor: pointer;
            padding-left: 0.6rem;
            padding-bottom: .02rem;
            margin-right: 0.5rem;
        }
        .logo-hidden {
            .logo {
                display: none;
            }
        }
        :host .has-options .logo {
            border-left: 1px solid rgba(40,40,40,.4);
            margin-left: 0.3rem;
            margin-right: 0.5rem;
        }

        .logo > span {
            white-space: nowrap;
        }



        /** COMPACT */

        /** Hide the menu button normally **/
        .compact-menu-button { display: none; }
        /** And show it when we're in compact mode **/
        .compact .compact-menu-button {
            position: relative;
            display: block;
            background: none;
            border: none;
            border-radius: 2rem;

            margin: 0;
            padding: 0 .3rem;
            padding-top: .2rem;

            z-index: 100;

            color: #000;

            &:hover {
                background: rgba(255,255,255,.2);
                cursor: pointer;
            }
            &:focus {
                outline: 1px solid rgba(255,255,255,.5);
            }
            &:focus-visible {
                outline: 1px solid rgba(0,0,0,.5);
            }
            & .expanded-click-area {
                position: absolute;
                left: 0;
                right: 0;
                top: 10%;
                bottom: 10%;
                transform: scale(1.8);
            }
        }  
        .has-no-options .compact-menu-button {
            display: none;
        }
        .open .compact-menu-button {
            background: rgba(255,255,255,.2);
        }
        .logo-visible .compact-menu-button { 
            margin-left: .2rem;
        }
        
        /** Open and hide menu **/
        .compact .foldout { 
            display: none;
        }
        .open .options, .open .foldout {
            display: flex;
            justify-content: center;
        }
        .compact .wrapper {
            padding: 0;
        }
        .compact .wrapper, .compact .options {
            height: auto;
            max-height: initial;
            flex-direction: row;
            gap: .12rem;
        }
        .compact .options { 
            flex-wrap: wrap;
            gap: .3rem;
        }
        .compact .top .options {
            height: auto;
            flex-direction: row;
        }
        .compact .bottom .wrapper {
            height: auto;
            flex-direction: column;
        }

        .compact .foldout {
            max-height: min(100ch, calc(100vh - 100px));
            overflow: auto;
            overflow-x: hidden;
            align-items: center;

            position: fixed;
            bottom: calc(100% + 5px);
            z-index: 100;
            width: auto;
            left: .2rem;
            right: .2rem;
            padding: .2rem;

        }
        .compact.logo-hidden .foldout {
            /** for when there's no logo we want to center the foldout **/
            min-width: 24ch;
            margin-left: 50%;
            transform: translateX(calc(-50% - .2rem));
        }
        
        .compact.top .foldout {
            top: calc(100% + 5px);
            bottom: auto;
        }

        ::-webkit-scrollbar {
            max-width: 7px;
            background: rgba(100,100,100,.2);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .3);
            border-radius: .2rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(150,150,150);
        }

        .compact .options > *, .compact .options > ::slotted(*) {
            font-size: 1.2rem;
            padding: .6rem .5rem;
            width: 100%;
        }
        .compact.has-options .logo {
            border: none;
            padding-left: 0;
            margin-left: 1rem;
            margin-bottom: .02rem;
        }
        .compact .options {
            /** e.g. if we have a very wide menu item like a select with long option names we don't want to overflow **/
            max-width: 100%;

            & > button, & > select {
                display: flex;
                flex-basis: 100%;
                min-height: 3rem;
            }
            & > button.row2 {
                //border: 1px solid red !important;
                display: flex;
                flex: 1;
                flex-basis: 30%;
            }
        }

        /** If there's really not enough space then just hide all options **/
        @media (max-width: 100px) or (max-height: 100px){
            .foldout {
                display: none !important;
            }
            .compact-menu-button {
                display: none !important;
            }
        }
        
        /* dark mode */
        /*
        @media (prefers-color-scheme: dark) {
            :host {
                background: rgba(0,0,0, .6);
            }
            :host button {
                color: rgba(200,200,200);
            }
            :host button:hover {
                background: rgba(100,100,100, .8);
            }
        }
        */

        </style>
        
        <div id="root" class="logo-hidden floating-panel-style bottom">
            <div class="wrapper">
                <div class="foldout">
                    <div class="options" part="options">
                        <slot></slot>
                    </div>
                    <div class="options" part="options">
                        <slot name="end"></slot>
                    </div>
                </div>
                <div style="user-select:none" class="logo">
                    <span class="madewith notranslate">powered by</span>
                </div>
            </div>
            <button class="compact-menu-button">
                <div class="expanded-click-area"></div>
            </button>
        </div>
        `;const i=this.attachShadow({mode:"open"});t1(),ip(f_,{loadedCallback:()=>{this.handleSizeChange()}}),ip(f_,{element:i});const n=e.content.cloneNode(!0);i==null||i.appendChild(n),this.root=i.querySelector("#root"),this.wrapper=(u=this.root)==null?void 0:u.querySelector(".wrapper"),this.options=(f=this.root)==null?void 0:f.querySelector(".options"),this.logoContainer=(p=this.root)==null?void 0:p.querySelector(".logo"),this.compactMenuButton=(g=this.root)==null?void 0:g.querySelector(".compact-menu-button"),this.compactMenuButton.append(mi("more_vert")),this.foldout=(_=this.root)==null?void 0:_.querySelector(".foldout"),(y=this.root)==null||y.appendChild(this.wrapper),this.wrapper.classList.add("wrapper");const o=i1.create();o.style.minHeight="1rem",this.logoContainer.append(o),this.logoContainer.addEventListener("click",()=>{globalThis.open("https://needle.tools","_blank")});try{window.requestAnimationFrame(()=>aA(b=>{if(b==!0&&Wo()&&!gx){let v=this._userRequestedLogoVisible;v===void 0&&(v=!1),this.___onSetLogoVisible(v)}else this.___onSetLogoVisible(!0)}))}catch(b){console.error("[Needle Menu] License check failed.",b)}this.compactMenuButton.addEventListener("click",b=>{b.preventDefault(),this.root.classList.toggle("open")});let r=this._context;setTimeout(()=>r=this._context);let l=0;const c=(b,v)=>{var w,P,E;sd&&console.log("Set menu visible",v),r!=null&&r.isInAR&&r.arOverlayElement?b!=r.arOverlayElement&&r.arOverlayElement.appendChild(this):this.parentNode!=((w=this._domElement)==null?void 0:w.shadowRoot)&&((E=(P=this._domElement)==null?void 0:P.shadowRoot)==null||E.appendChild(this)),this.style.display=v?"flex":"none",this.style.visibility="visible",this.style.opacity="1"};let h=!1;new MutationObserver(b=>{var v;if(!h)try{h=!0,this.onChangeDetected(b);const w=this==null?void 0:this.parentNode;if((this.style.display!="flex"||this.style.visibility!="visible"||this.style.opacity!="1"||w!=((v=this._domElement)==null?void 0:v.shadowRoot))&&!Wo()){const P=l++;fs()&&this._userRequestedMenuVisible===!1?(P===0&&c(w,this._userRequestedMenuVisible),P===1&&console.warn("Needle Menu Warning: You need a PRO license to hide the Needle Engine menu â†’ The menu will be visible in your deployed website if you don't have a PRO license. See https://needle.tools/pricing for details.")):P===0?c(w,!0):setTimeout(()=>c(w,!0),5)}}finally{h=!1}}).observe(this.root,{childList:!0,subtree:!0,attributes:!0}),sd&&this.___insertDebugOptions()}static create(){return document.createElement(Ra,{is:Ra})}static getOrCreate(e,i){let n=e.querySelector(Ra);return!n&&e.shadowRoot&&(n=e.shadowRoot.querySelector(Ra)),n||(n=window.document.body.querySelector(Ra)),n||(n=S0.create(),e.shadowRoot?e.shadowRoot.appendChild(n):e.appendChild(n)),n._domElement=e,n._context=i,n}connectedCallback(){window.addEventListener("resize",this.handleSizeChange),this.handleMenuVisible(),this._sizeChangeInterval=setInterval(()=>this.handleSizeChange(void 0,!0),5e3),setTimeout(()=>{var e,i;(e=this._domElement)==null||e.addEventListener("resize",this.handleSizeChange),(i=this._domElement)==null||i.addEventListener("click",be(this,Jd))},1)}disconnectedCallback(){var e,i;window.removeEventListener("resize",this.handleSizeChange),clearInterval(this._sizeChangeInterval),(e=this._domElement)==null||e.removeEventListener("resize",this.handleSizeChange),(i=this._context)==null||i.domElement.removeEventListener("click",be(this,Jd))}showNeedleLogo(e){this._userRequestedLogoVisible=e,!(!e&&(!Wo()||gx)&&(console.warn("[Needle Engine] You need a PRO license to hide the Needle Engine logo in production."),!fs()))&&this.___onSetLogoVisible(e)}get logoIsVisible(){return!this.root.classList.contains("logo-hidden")}___onSetLogoVisible(e){this.logoContainer.style.display="",this.logoContainer.style.opacity="1",this.logoContainer.style.visibility="visible",e?(this.root.classList.remove("logo-hidden"),this.root.classList.add("logo-visible")):(this.root.classList.remove("logo-visible"),this.root.classList.add("logo-hidden"))}setPosition(e){if(e!=="top"&&e!=="bottom")return console.error("NeedleMenu.setPosition: invalid position",e);this.root.classList.remove("top","bottom"),this.root.classList.add(e)}setVisible(e){this._userRequestedMenuVisible=e,this.style.display=e?"flex":"none"}closeFoldout(){this.root.classList.remove("open")}append(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.options.appendChild(n)}else this.options.appendChild(i)}appendChild(e){var n;if(!(e instanceof Node)){const o=document.createElement("button");if(o.textContent=e.label,o.onclick=e.onClick,o.setAttribute("priority",((n=e.priority)==null?void 0:n.toString())??"0"),e.title&&(o.title=e.title),e.icon){const r=mi(e.icon);e.iconSide==="right"?o.appendChild(r):o.prepend(r)}e.class&&o.classList.add(e.class),e=o}return this.options.appendChild(e)}prepend(...e){for(const i of e)if(typeof i=="string"){const n=document.createTextNode(i);this.options.prepend(n)}else this.options.prepend(i)}onChangeDetected(e){if(!this._isHandlingChange){this._isHandlingChange=!0;try{this.handleMenuVisible();for(const i of e)i.target==this.options&&this.onOptionsChildrenChanged(i)}finally{this._isHandlingChange=!1}}}onOptionsChildrenChanged(e){if(this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions),this.handleSizeChange(void 0,!0),e.type==="childList"&&e.addedNodes.length>0){const i=Array.from(this.options.children);i.sort((o,r)=>{const l=parseInt(o.getAttribute("priority")||"0"),c=parseInt(r.getAttribute("priority")||"0");return l-c});let n=!1;for(let o=0;o<i.length;o++){const r=this.options.children[o],l=i[o];if(r!==l){n=!0;break}}if(n)for(const o of i)this.options.appendChild(o)}}handleMenuVisible(){sd&&console.log("Update VisibleState: Any Content?",this.hasAnyContent),this.hasAnyContent?this.root.style.display="":this.root.style.display="none",this.root.classList.toggle("has-options",this.hasAnyVisibleOptions),this.root.classList.toggle("has-no-options",!this.hasAnyVisibleOptions)}get hasAnyContent(){return!!(this.logoContainer.style.display!="none"||this.hasAnyVisibleOptions)}get hasAnyVisibleOptions(){for(let e=0;e<this.options.children.length;e++){const i=this.options.children[e];if(i.tagName==="SLOT"){const o=i.assignedNodes();for(const r of o)if(r instanceof HTMLElement&&r.style.display!="none")return!0}else if(i.style.display!="none")return!0}return!1}___insertDebugOptions(){window.addEventListener("keydown",n=>{n.key==="p"&&this.setPosition(this.root.classList.contains("top")?"bottom":"top")});const e=document.createElement("button");e.textContent="Hide Buttons",e.onclick=()=>{const n=new Array(this.options.children.length);for(let o=0;o<this.options.children.length;o++)n[o]=this.options.children[o];for(const o of n)this.options.removeChild(o);setTimeout(()=>{for(const o of n)this.options.appendChild(o)},1e3)},this.appendChild(e);const i=document.createElement("button");i.textContent="Toggle Logo",i.addEventListener("click",()=>{this.logoContainer.style.display=this.logoContainer.style.display==="none"?"":"none"}),this.appendChild(i)}};let sp=S0;Jd=new WeakMap;customElements.get(Ra)||customElements.define(Ra,sp);const yt=S("debugcontext"),nA=S("stats"),sA=S("debugactive"),oA=S("debugframerate"),rA=S("debugcoroutine"),T3={};class O3{constructor(){a(this,"name");a(this,"alias");a(this,"hash");a(this,"runInBackground");a(this,"domElement");a(this,"renderer");a(this,"camera");a(this,"scene")}}var oe;(function(s){s[s.Start=-1]="Start",s[s.EarlyUpdate=0]="EarlyUpdate",s[s.Update=1]="Update",s[s.LateUpdate=2]="LateUpdate",s[s.OnBeforeRender=3]="OnBeforeRender",s[s.OnAfterRender=4]="OnAfterRender",s[s.PrePhysicsStep=9]="PrePhysicsStep",s[s.PostPhysicsStep=10]="PostPhysicsStep",s[s.Undefined=-1]="Undefined"})(oe||(oe={}));function kb(s,t){if(!s)return;if(!s.isComponent){(U()||yt)&&console.error(`Registered script is not a Needle Engine component. 
The script will be ignored. Please make sure your component extends "Behaviour" imported from "@needle-tools/engine"
`,s);return}t||(t=ne.Current,yt&&console.warn("> Registering component without context"));const e=t==null?void 0:t.new_scripts;e.includes(s)||e.push(s)}const Fe=class{constructor(t){a(this,"name");a(this,"alias");a(this,"isManagedExternally",!1);a(this,"isPaused",!1);a(this,"runInBackground",!1);a(this,"targetFrameRate");a(this,"physicsSteps",1);a(this,"hash");a(this,"domElement");a(this,"_resolutionScaleFactor",1);a(this,"_boundingClientRectFrame",-1);a(this,"_boundingClientRect",null);a(this,"_domX");a(this,"_domY");a(this,"xr",null);a(this,"_xrFrame",null);a(this,"_currentFrameEvent",oe.Undefined);a(this,"scene");a(this,"renderer");a(this,"composer",null);a(this,"scripts",[]);a(this,"scripts_pausedChanged",[]);a(this,"scripts_earlyUpdate",[]);a(this,"scripts_update",[]);a(this,"scripts_lateUpdate",[]);a(this,"scripts_onBeforeRender",[]);a(this,"scripts_onAfterRender",[]);a(this,"scripts_WithCorroutines",[]);a(this,"scripts_immersive_vr",[]);a(this,"scripts_immersive_ar",[]);a(this,"coroutines",{});a(this,"post_setup_callbacks",[]);a(this,"pre_update_callbacks",[]);a(this,"pre_render_callbacks",[]);a(this,"post_render_callbacks",[]);a(this,"pre_update_oneshot_callbacks",[]);a(this,"new_scripts",[]);a(this,"new_script_start",[]);a(this,"new_scripts_pre_setup_callbacks",[]);a(this,"new_scripts_post_setup_callbacks",[]);a(this,"new_scripts_xr",[]);a(this,"mainCameraComponent");a(this,"_mainCamera",null);a(this,"_fallbackCamera",null);a(this,"application");a(this,"animations");a(this,"time");a(this,"input");a(this,"physics");a(this,"connection");a(this,"assets");a(this,"mainLight",null);a(this,"sceneLighting");a(this,"addressables");a(this,"lightmaps");a(this,"players");a(this,"lodsManager");a(this,"menu");a(this,"_needsUpdateSize",!1);a(this,"_isCreated",!1);a(this,"_isCreating",!1);a(this,"_isVisible",!1);a(this,"_stats",nA?new oT:null);a(this,"_intersectionObserver",null);a(this,"_disposeCallbacks",[]);a(this,"maxRenderResolution");a(this,"_devicePixelRatio","auto");a(this,"_originalCreationArgs");a(this,"onUnhandledRejection",t=>{this.onError(t.reason)});a(this,"_cameraStack",[]);a(this,"_onBeforeRenderListeners",new Map);a(this,"_onAfterRenderListeners",new Map);a(this,"_requireDepthTexture",!1);a(this,"_requireColorTexture",!1);a(this,"_renderTarget");a(this,"_isRendering",!1);a(this,"_needsVisibleUpdate",!0);a(this,"_lastStyleComputedResult");a(this,"_createId",0);a(this,"_renderlooperrors",0);a(this,"focusRectSettings",{damping:.05});a(this,"_focusRect",null);a(this,"_lastTimestamp",0);a(this,"_accumulatedTime",0);a(this,"_dispatchReadyAfterFrame",!1);a(this,"_tempClearColor",new de);a(this,"_tempClearColor2",new de);a(this,"_contextRestoreTries",0);a(this,"_wasPaused",!1);this.name=(t==null?void 0:t.name)||"",this.alias=t==null?void 0:t.alias,this.domElement=(t==null?void 0:t.domElement)||document.body,this.hash=t==null?void 0:t.hash,t!=null&&t.renderer&&(this.renderer=t.renderer,this.isManagedExternally=!0),(t==null?void 0:t.runInBackground)!==void 0&&(this.runInBackground=t.runInBackground),t!=null&&t.scene?this.scene=t.scene:this.scene=new bn,t!=null&&t.camera&&(this._mainCamera=t.camera),this.application=new ls(this),this.time=new YM,this.input=new sk(this),this.physics=new Zh(this),this.connection=new Jk(this),this.assets=new mE,this.sceneLighting=new XM(this),this.addressables=new EM(this),this.lightmaps=new FM(this),this.players=new NM(this),this.menu=new iA(this),this.lodsManager=new JC(this),this.animations=new LM(this);const e=()=>this._needsUpdateSize=!0;window.addEventListener("resize",e),this._disposeCallbacks.push(()=>window.removeEventListener("resize",e));const i=new ResizeObserver(n=>this._needsUpdateSize=!0);i.observe(this.domElement),this._disposeCallbacks.push(()=>i.disconnect()),this._intersectionObserver=new IntersectionObserver(n=>{this._isVisible=n[0].isIntersecting}),this._disposeCallbacks.push(()=>{var n;return(n=this._intersectionObserver)==null?void 0:n.disconnect()}),ve.register(this)}static get DefaultTargetFrameRate(){return Fe._defaultTargetFramerate.value}static set DefaultTargetFrameRate(t){Fe._defaultTargetFramerate.value=t}static get DefaultWebGLRendererParameters(){return Fe._defaultWebglRendererParameters}get version(){return as}static get Current(){return ve.Current}static set Current(t){ve.Current=t}static get All(){return ve.All}appendHTMLElement(t){return this.domElement.shadowRoot?this.domElement.shadowRoot.appendChild(t):this.domElement.appendChild(t)}get resolutionScaleFactor(){return this._resolutionScaleFactor}set resolutionScaleFactor(t){if(t!==this._resolutionScaleFactor&&typeof t=="number"){if(t<=0){console.error("Invalid resolution scale factor",t);return}this._resolutionScaleFactor=t,this.updateSize()}}calculateBoundingClientRect(){if(this.xr){this._domX=0,this._domY=0;return}this._boundingClientRectFrame!==this.time.frame&&(this._boundingClientRectFrame=this.time.frame,this._boundingClientRect=this.domElement.getBoundingClientRect(),this._domX=this._boundingClientRect.x,this._domY=this._boundingClientRect.y)}get domWidth(){return this.isInAR?window.innerWidth:this.domElement.clientWidth}get domHeight(){return this.isInAR?window.innerHeight:this.domElement.clientHeight}get domX(){return this.calculateBoundingClientRect(),this._domX}get domY(){return this.calculateBoundingClientRect(),this._domY}get isInXR(){var t,e;return((e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.isPresenting)||!1}get xrSessionMode(){var t;return(t=this.xr)==null?void 0:t.mode}get isInVR(){return this.xrSessionMode==="immersive-vr"}get isInAR(){return this.xrSessionMode==="immersive-ar"}get isInPassThrough(){return this.xr?this.xr.isPassThrough:!1}get xrSession(){var t,e;return(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getSession()}get xrFrame(){return this._xrFrame}get xrCamera(){var t,e;return this.renderer.xr.isPresenting?(e=(t=this.renderer)==null?void 0:t.xr)==null?void 0:e.getCamera():void 0}get arOverlayElement(){const t=this.domElement;return typeof t.getAROverlayContainer=="function"?t.getAROverlayContainer():this.domElement}get currentFrameEvent(){return this._currentFrameEvent}get mainCamera(){if(this._mainCamera)return this._mainCamera;if(this.mainCameraComponent){const t=this.mainCameraComponent;return t.threeCamera||t.buildCamera(),t.threeCamera}return this._fallbackCamera||(this._fallbackCamera=new Se(75,this.domWidth/this.domHeight,.1,1e3)),this._fallbackCamera}set mainCamera(t){this._mainCamera=t}get rendererData(){return this.sceneLighting}get isCreated(){return this._isCreated}createNewRenderer(t){var e,i,n;if((e=this.renderer)==null||e.dispose(),t={...Fe.DefaultWebGLRendererParameters,...t},!t.canvas){const o=(n=(i=this.domElement)==null?void 0:i.shadowRoot)==null?void 0:n.querySelector("canvas");o&&(t.canvas=o,yt&&console.log("Using canvas from shadow root",o))}return yt&&console.log("Using Renderer Parameters:",t,this.domElement),this.renderer=new ol(t),this.renderer.debug.checkShaderErrors=U()||S("checkshadererrors")===!0,this.renderer.toneMappingExposure=1,this.renderer.toneMapping=Ff,this.renderer.setClearColor(new de("lightgrey"),0),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=KP,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputColorSpace=Qo,this.renderer.nodes={library:new JP,modelViewMatrix:null,modelNormalViewMatrix:null},this.lodsManager.setRenderer(this.renderer),this.input.bindEvents(),this.renderer}internalOnUpdateVisible(){var t,e;(t=this._intersectionObserver)==null||t.disconnect(),(e=this._intersectionObserver)==null||e.observe(this.domElement)}requestSizeUpdate(){this._needsUpdateSize=!0}get devicePixelRatio(){return this._devicePixelRatio}set devicePixelRatio(t){t!==this._devicePixelRatio&&(this._devicePixelRatio=t,this._needsUpdateSize=!0)}updateSize(t=!1){var e,i,n;if(t||!this.isManagedExternally&&((e=this.renderer.xr)==null?void 0:e.isPresenting)===!1){this._needsUpdateSize=!1;const o=this.resolutionScaleFactor;let r=this.domWidth*o,l=this.domHeight*o;this.maxRenderResolution&&(this.maxRenderResolution.x=Math.max(1,this.maxRenderResolution.x),r=Math.min(this.maxRenderResolution.x,r),this.maxRenderResolution.y=Math.max(1,this.maxRenderResolution.y),l=Math.min(this.maxRenderResolution.y,l));const c=this.mainCamera;this.updateAspect(c),this.renderer.setSize(r,l,!0),this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%";const h=typeof this.devicePixelRatio=="number"?this.devicePixelRatio:this.devicePixelRatio==="auto"?Math.min(2,window.devicePixelRatio):void 0;h!==void 0&&this.renderer.setPixelRatio(h),this.composer&&((i=this.composer.setSize)==null||i.call(this.composer,r,l),h!==void 0&&"setPixelRatio"in this.composer&&typeof this.composer.setPixelRatio=="function"&&((n=this.composer.setPixelRatio)==null||n.call(this.composer,window.devicePixelRatio)))}}updateAspect(t,e,i){if(!t)return;e===void 0&&(e=this.domWidth),i===void 0&&(i=this.domHeight);const n=e/i;if(t.isPerspectiveCamera){const o=t,r=o.aspect;o.aspect=n,r!==o.aspect&&t.updateProjectionMatrix()}else if(t.isOrthographicCamera){const o=t,r=o.top-o.bottom,c=r*n/2,h=r/2;(o.left!=-c||o.top!=h)&&(o.left=-c,o.right=c,o.top=h,o.bottom=-h,t.updateProjectionMatrix())}}recreate(){this.clear(),this.create(this._originalCreationArgs)}async onCreate(t){return this.create(t)}async create(t){try{this._isCreating=!0,t!==this._originalCreationArgs&&(this._originalCreationArgs=Kp(t)),window.addEventListener("unhandledrejection",this.onUnhandledRejection);const e=await this.internalOnCreate(t);return this._isCreated=e,e}finally{window.removeEventListener("unhandledrejection",this.onUnhandledRejection),this._isCreating=!1}}onError(t){this.domElement.dispatchEvent(new CustomEvent("error",{detail:t}))}clear(){var t,e,i,n;ve.dispatchCallback(ge.ContextClearing,this),ws(this,ge.ContextClearing),Wn(this.scene,!0,!0),this.scene=new bn,(t=this.addressables)==null||t.dispose(),(e=this.lightmaps)==null||e.clear(),(n=(i=this.physics)==null?void 0:i.engine)==null||n.clearCaches(),this.lodsManager.disable(),this._onBeforeRenderListeners.clear(),this._onAfterRenderListeners.clear(),this.isManagedExternally||this.renderer&&(this.renderer.renderLists.dispose(),this.renderer.state.reset(),this.renderer.resetState()),ve.dispatchCallback(ge.ContextCleared,this)}dispose(){this.internalOnDestroy()}onDestroy(){this.internalOnDestroy()}internalOnDestroy(){var t,e;Fe.Current=this,ve.dispatchCallback(ge.ContextDestroying,this),ws(this,ge.ContextDestroying),this.clear(),(t=this.renderer)==null||t.setAnimationLoop(null),this.renderer&&(this.renderer.setClearAlpha(0),this.renderer.clear(),this.isManagedExternally||(yt&&console.log("Disposing renderer"),this.renderer.dispose())),this.scene=null,this.renderer=null,this.input.dispose(),this.menu.onDestroy(),this.animations.onDestroy();for(const i of this._disposeCallbacks)try{i()}catch(n){console.error("Error in on dispose callback:",n,i)}(e=this.domElement)!=null&&e.parentElement&&this.domElement.parentElement.removeChild(this.domElement),this._isCreated=!1,ve.dispatchCallback(ge.ContextDestroyed,this),ws(this,ge.ContextDestroyed),ve.unregister(this),Fe.Current===this&&(Fe.Current=null)}registerCoroutineUpdate(t,e,i){return typeof(e==null?void 0:e.next)!="function"?(console.error("Registered invalid coroutine function from "+t.name+`
Coroutine functions must be generators: "*myCoroutine() {...}"
Start a coroutine from a component by calling "this.startCoroutine(myCoroutine())"`),e):(this.coroutines[i]||(this.coroutines[i]=[]),this.coroutines[i].push({comp:t,main:e}),e)}unregisterCoroutineUpdate(t,e){if(!this.coroutines[e])return;const i=this.coroutines[e].findIndex(n=>n.main===t);i>=0&&this.coroutines[e].splice(i,1)}stopAllCoroutinesFrom(t){for(const e in this.coroutines){const i=this.coroutines[e];for(let n=i.length-1;n>=0;n--)i[n].comp===t&&i.splice(n,1)}}setCurrentCamera(t){var n;if(!t)return;if(t.threeCamera||t.buildCamera(),!t.threeCamera){console.warn("Camera component is missing camera",t);return}const e=this._cameraStack.indexOf(t);e>=0&&this._cameraStack.splice(e,1),this._cameraStack.push(t),this.mainCameraComponent=t;const i=t.threeCamera;i.isPerspectiveCamera&&this.updateAspect(i),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}removeCamera(t){if(!t)return;const e=this._cameraStack.indexOf(t);if(e>=0&&this._cameraStack.splice(e,1),this.mainCameraComponent===t&&(this.mainCameraComponent=void 0,this._cameraStack.length>0)){const i=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(i)}}addBeforeRenderListener(t,e){if(!this._onBeforeRenderListeners.has(t.uuid)){const i=[];this._onBeforeRenderListeners.set(t.uuid,i),t.onBeforeRender=this._createRenderCallbackWrapper(i)}this._onBeforeRenderListeners.get(t.uuid).push(e)}removeBeforeRenderListener(t,e){if(this._onBeforeRenderListeners.has(t.uuid)){const i=this._onBeforeRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}addAfterRenderListener(t,e){var i;if(!this._onAfterRenderListeners.has(t.uuid)){const n=[];this._onAfterRenderListeners.set(t.uuid,n),t.onAfterRender=this._createRenderCallbackWrapper(n)}(i=this._onAfterRenderListeners.get(t.uuid))==null||i.push(e)}removeAfterRenderListener(t,e){if(this._onAfterRenderListeners.has(t.uuid)){const i=this._onAfterRenderListeners.get(t.uuid),n=i.indexOf(e);n>=0&&i.splice(n,1)}}_createRenderCallbackWrapper(t){return(e,i,n,o,r,l)=>{for(let c=0;c<t.length;c++){const h=t[c];h(e,i,n,o,r,l)}}}get isRendering(){return this._isRendering}setRequireDepth(t){this._requireDepthTexture=t}setRequireColor(t){this._requireColorTexture=t}get depthTexture(){var t;return((t=this._renderTarget)==null?void 0:t.depthTexture)||null}get opaqueColorTexture(){var t;return((t=this._renderTarget)==null?void 0:t.texture)||null}get isVisibleToUser(){if(this.isInXR)return!0;if(!this._isVisible)return!1;if(!this._needsVisibleUpdate&&this._lastStyleComputedResult!==void 0)return this._lastStyleComputedResult;this._needsVisibleUpdate=!1;const t=getComputedStyle(this.domElement);return this._lastStyleComputedResult=t.visibility!=="hidden"&&t.display!=="none"&&t.opacity!=="0",this._lastStyleComputedResult}async internalOnCreate(t){var h,d,u,f,p,g,_;const e=++this._createId;yt&&console.log("Creating context",this.name,t);const i=globalThis["needle:dependencies:ready"];i instanceof Promise&&(yt&&console.log("Waiting for dependencies to be ready"),await i.catch(y=>{if(yt||U()){if(tm("Needle Engine dependencies failed to load. Please check the console for more details"),y instanceof ReferenceError){let b="YourComponentName";const v=y.message.indexOf("'");if(v>0){const w=y.message.indexOf("'",v+1);if(w>0){const P=y.message.substring(v+1,w);P.length>3&&(b=P)}}console.error(`Needle Engine dependencies failed to load:

# Make sure you don't have circular imports in your scripts!

Possible solutions: 
â†’ Replace @serializable(${b}) in your script with @serializable(Behaviour)
â†’ If you only need type information try importing the type only, e.g: import { type ${b} }

---`,y);return}console.error("Needle Engine dependencies failed to load",y)}}).then(()=>{yt&&console.log("Needle Engine dependencies are ready")})),this.clear();const n=this.renderer,o=!n||n.isDisposed===!0;this.isManagedExternally===!1&&o?this.createNewRenderer():this.lodsManager.setRenderer(this.renderer),(h=this.renderer)==null||h.setAnimationLoop(null),Fe.Current=this,await ve.dispatchCallback(ge.ContextCreationStart,this);let r=!0,l;try{Fe.Current=this,t?l=await this.internalLoadInitialContent(e,t):l=[]}catch(y){console.error(y),r=!1}if(!r)return this.onError("Failed to load initial content"),!1;if(e!==this._createId||(d=t==null?void 0:t.abortSignal)!=null&&d.aborted)return!1;if(this.internalOnUpdateVisible(),!this.renderer)return yt&&console.warn("Context has no renderer (perhaps it was disconnected?",this.domElement.isConnected),!1;!this.isManagedExternally&&!this.domElement.shadowRoot&&this.domElement.prepend(this.renderer.domElement),Fe.Current=this,Fe.Current=this;for(let y=0;y<this.new_scripts.length;y++){const b=this.new_scripts[y];if(b.gameObject!==void 0&&b.gameObject!==null){b.gameObject.userData===void 0&&(b.gameObject.userData={}),b.gameObject.userData.components===void 0&&(b.gameObject.userData.components=[]);const v=b.gameObject.userData.components;v.includes(b)||v.push(b)}}if(this.post_setup_callbacks)for(let y=0;y<this.post_setup_callbacks.length;y++)Fe.Current=this,await this.post_setup_callbacks[y](this);if(!this._mainCamera){Fe.Current=this;let y=null;Ec(this.scene,b=>{const v=b;if(v!=null&&v.isCamera){if(td(v.gameObject),!v.activeAndEnabled)return;if(v.tag==="MainCamera")return y=v,!0;y=v}}),y?this.setCurrentCamera(y):!ve.dispatchCallback(ge.MissingCamera,this,{files:l})&&!this.mainCamera&&!this.isManagedExternally&&console.warn("Missing camera in main scene",this)}this.input.bindEvents(),Fe.Current=this,Kf(this),this.physics.engine&&((u=this.physics.engine)==null||u.step(0),(f=this.physics.engine)==null||f.postStep()),!this.isManagedExternally&&this.composer&&this.mainCamera,this._needsUpdateSize=!0,this._stats&&(this._stats.showPanel(0),this._stats.dom.style.position="absolute",(p=this.domElement.shadowRoot)==null||p.appendChild(this._stats.dom)),yt&&Ly(this.scene,!0),this.targetFrameRate===void 0?(yt&&console.warn("No target framerate set, using default",Fe.DefaultTargetFrameRate),this.targetFrameRate=Fe._defaultTargetFramerate):yt&&console.log("Target framerate set to",this.targetFrameRate),this._dispatchReadyAfterFrame=!0;const c=ve.dispatchCallback(ge.ContextCreated,this,{files:l});if(c){const y=this.domElement;"internalSetLoadingMessage"in y&&typeof y.internalSetLoadingMessage=="function"&&(y==null||y.internalSetLoadingMessage("finish loading")),await c}return(g=t==null?void 0:t.abortSignal)!=null&&g.aborted?!1:(ws(this,ge.ContextCreated),yt&&console.log("Context Created...",this.renderer,this.renderer.domElement),this._isCreating=!1,!this.isManagedExternally&&!((_=t==null?void 0:t.abortSignal)!=null&&_.aborted)&&this.restartRenderLoop(),!0)}async internalLoadInitialContent(t,e){var c,h,d,u;const i=new Array;if(e.files.length===0)return i;const n=[...e.files],o={name:"",progress:null,index:0,count:n.length},r=so(),l=0;for(let f=0;f<n.length;f++){if((c=e.abortSignal)!=null&&c.aborted){yt&&console.log("Aborting loading because of abort signal");break}if(t!==this._createId){yt&&console.log("Aborting loading because create id changed",t,this._createId);break}const p=n[f];(h=e==null?void 0:e.onLoadingStart)==null||h.call(this,f,p),yt&&console.log("Context Load "+p);const g=await r.loadSync(this,p,p,l,_=>{var y,b;(y=e.abortSignal)!=null&&y.aborted||(o.name=p,o.progress=_,o.index=f,o.count=n.length,(b=e.onLoadingProgress)==null||b.call(this,o))});(d=e==null?void 0:e.onLoadingFinished)==null||d.call(this,f,p,g??null),g?i.push({src:p,file:g}):console.warn("Could not load file: "+p)}if(t!==this._createId||(u=e.abortSignal)!=null&&u.aborted){yt&&console.log("Aborting loading because create id changed or abort signal was set",t,this._createId);for(const f of i)if(f&&f.file)for(const p of f.file.scenes)Wn(p,!0,!0)}else{let f=!1;for(const p of i)p&&p.file&&(p.file.scene?(f=!0,this.scene.add(p.file.scene)):console.warn("No scene found in loaded file"));if(!f){for(const p of i)if(p&&p.file&&"parser"in p.file){let g=0;if(!Array.isArray(p.file.parser.json.materials))continue;for(let _=0;_<p.file.parser.json.materials.length;_++){const y=await p.file.parser.getDependency("material",_),b=new D;b.position.x=_*1.1,b.position.y=g,this.scene.add(b),ll.createPrimitive("ShaderBall",{parent:b,material:y})}g+=1}}}return i}restartRenderLoop(){return this.renderer?this._isCreating?(console.warn("Can not start render loop while creating context"),!1):(this.renderer.setAnimationLoop((t,e)=>{this.isManagedExternally||this.update(t,e)}),!0):(console.error("Can not start render loop without renderer"),!1)}update(t,e){if(e===void 0&&(e=null),U()||yt||xE())try{this.internalStep(t,e),this._renderlooperrors=0}catch(i){this._renderlooperrors+=1,(U()||yt)&&(i instanceof Error||i instanceof TypeError)&&nt("Caught unhandled exception during render-loop - see console for details.",Jt.Error),console.error("Frame #"+this.time.frame+`
`,i),this._renderlooperrors>=3&&(console.warn("Stopping render loop due to error"),this.renderer.setAnimationLoop(null)),this.domElement.dispatchEvent(new CustomEvent("error",{detail:i}))}else this.internalStep(t,e)}updatePhysics(t){this.internalUpdatePhysics(t)}setCameraFocusRect(t,e){this._focusRect=t,e&&Object.assign(this.focusRectSettings,e)}get focusRect(){return this._focusRect}internalStep(t,e){this.internalOnBeforeRender(t,e)!==!1&&(this.internalOnRender(),this.internalOnAfterRender())}internalOnBeforeRender(t,e){var n;this.renderer.info.autoReset=!!e,this.renderer.info.autoReset===!1&&this.renderer.info.reset(),this._needsVisibleUpdate=!0;const i=e!==null&&this._xrFrame===null;if(this._xrFrame=e,i&&this.domElement.dispatchEvent(new CustomEvent("xr-session-started",{detail:{context:this,session:this.xrSession,frame:e}})),this._currentFrameEvent=oe.Undefined,this.isManagedExternally===!1&&this.isInXR===!1&&this.targetFrameRate!==void 0){this._lastTimestamp===0&&(this._lastTimestamp=t),this._accumulatedTime+=(t-this._lastTimestamp)/1e3,this._lastTimestamp=t;let o=this.targetFrameRate;if(typeof o=="object"&&(o=o.value),this._accumulatedTime<1/(o+1))return!1;this._accumulatedTime=0}if((n=this._stats)==null||n.begin(),Fe.Current=this,this.onHandlePaused())return!1;for(Fe.Current=this,this.time.update(),oA&&console.log("FPS",this.time.smoothedFps.toFixed(0)),Kf(this),Cf(this.scene),kC(this),ws(this,oe.Start);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_oneshot_callbacks){for(const o in this.pre_update_oneshot_callbacks)this.pre_update_oneshot_callbacks[o]();this.pre_update_oneshot_callbacks.length=0}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();this._currentFrameEvent=oe.EarlyUpdate;for(let o=0;o<this.scripts_earlyUpdate.length;o++){const r=this.scripts_earlyUpdate[o];r.activeAndEnabled&&r.earlyUpdate!==void 0&&(Fe.Current=this,r.earlyUpdate())}this.executeCoroutines(oe.EarlyUpdate),ws(this,oe.EarlyUpdate),this._currentFrameEvent=oe.Update;for(let o=0;o<this.scripts_update.length;o++){const r=this.scripts_update[o];r.activeAndEnabled&&r.update!==void 0&&(Fe.Current=this,r.update())}this.executeCoroutines(oe.Update),ws(this,oe.Update),this._currentFrameEvent=oe.LateUpdate;for(let o=0;o<this.scripts_lateUpdate.length;o++){const r=this.scripts_lateUpdate[o];r.activeAndEnabled&&r.lateUpdate!==void 0&&(Fe.Current=this,r.lateUpdate())}if(this.executeCoroutines(oe.LateUpdate),ws(this,oe.LateUpdate),this.physicsSteps===void 0&&(this.physicsSteps=1),this.physics.engine&&this.physicsSteps>0&&this.internalUpdatePhysics(this.physicsSteps),this.isVisibleToUser||this.runInBackground){if(this._focusRect&&this.mainCamera instanceof Se){const o=this.focusRectSettings,r=o.damping>0?this.time.deltaTime/o.damping:1;fO(this._focusRect,r,this.mainCamera,this.renderer)}this._currentFrameEvent=oe.OnBeforeRender;for(let o=0;o<this.scripts_onBeforeRender.length;o++){const r=this.scripts_onBeforeRender[o];r.activeAndEnabled&&r.onBeforeRender!==void 0&&(Fe.Current=this,r.onBeforeRender(e))}if(this.executeCoroutines(oe.OnBeforeRender),ws(this,oe.OnBeforeRender),this._needsUpdateSize&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o](e)}return!0}internalUpdatePhysics(t){if(!this.physics.engine)return!1;const e=t,i=this.time.deltaTime/e;for(let n=0;n<e;n++)this._currentFrameEvent=oe.PrePhysicsStep,this.executeCoroutines(oe.PrePhysicsStep),this.physics.engine.step(i),this._currentFrameEvent=oe.PostPhysicsStep,this.executeCoroutines(oe.PostPhysicsStep);return this.physics.engine.postStep(),!0}internalOnRender(){this.isManagedExternally||(PE(this),this._currentFrameEvent=oe.Undefined,rT.update(),this.renderNow(),this._currentFrameEvent=oe.OnAfterRender)}internalOnAfterRender(){if(this.isVisibleToUser||this.runInBackground){for(let t=0;t<this.scripts_onAfterRender.length;t++){const e=this.scripts_onAfterRender[t];e.activeAndEnabled&&e.onAfterRender!==void 0&&(Fe.Current=this,e.onAfterRender())}if(this.executeCoroutines(oe.OnAfterRender),ws(this,oe.OnAfterRender),this.post_render_callbacks)for(const t in this.post_render_callbacks)this.post_render_callbacks[t]()}this._currentFrameEvent=-1,this.connection.sendBufferedMessagesNow(),this._stats&&(this._stats.end(),this.time.frameCount%150===0&&console.log(this.renderer.info.render.calls+" DrawCalls",`
Render:`,{...this.renderer.info.render},`
Memory:`,{...this.renderer.info.memory},`
Target Framerate: `+this.targetFrameRate)),this._dispatchReadyAfterFrame&&(this._dispatchReadyAfterFrame=!1,this.domElement.dispatchEvent(new CustomEvent("ready")),ve.dispatchCallback(ge.ContextFirstFrameRendered,this))}renderNow(t){var e;if(!t&&(t=this.mainCamera,!t))return!1;if(this.handleRendererContextLost(),this._isRendering=!0,this.renderRequiredTextures(),this.renderer.toneMapping!==Ff&&ZC(),this.composer&&!this.isInXR){t&&"setMainCamera"in this.composer&&((e=this.composer.passes[0])==null?void 0:e.mainCamera)!=t&&this.composer.setMainCamera(t);const i=this.renderer.getClearColor(this._tempClearColor),n=this.renderer.getClearAlpha();this._tempClearColor2.copy(i),this.renderer.setClearColor(i.convertSRGBToLinear(),this.renderer.getClearAlpha()),this.composer.render(this.time.deltaTime),this.renderer.setClearColor(this._tempClearColor2,n)}else t&&(this.isInXR&&K.isMacOS()&&this.renderer.clearDepth(),this.renderer.render(this.scene,t));return this._isRendering=!1,!0}handleRendererContextLost(){this.time.frame%10&&this.renderer.getContext().isContextLost()&&this._contextRestoreTries++<100&&(console.warn("Attempting to recover WebGL context..."),this.renderer.forceContextRestore())}onHandlePaused(){const t=this.evaluatePaused();if(this._wasPaused!==t){sA&&console.log("Paused?",t,"context:"+this.alias);for(let e=0;e<this.scripts_pausedChanged.length;e++){const i=this.scripts_pausedChanged[e];i.activeAndEnabled&&i.onPausedChanged!==void 0&&(Fe.Current=this,i.onPausedChanged(t,this._wasPaused))}}return this._wasPaused=t,t}evaluatePaused(){return this.isInXR?!1:this.isPaused?!0:this.runInBackground?!1:!this.isVisibleToUser}renderRequiredTextures(){if(!this.mainCamera||!this._requireDepthTexture&&!this._requireColorTexture)return;if(!this._renderTarget){if(this._renderTarget=new io(this.domWidth,this.domHeight),this._requireDepthTexture){const i=new Uw(this.domWidth,this.domHeight);this._renderTarget.depthTexture=i}this._requireColorTexture&&(this._renderTarget.texture=new Ke,this._renderTarget.texture.generateMipmaps=!1,this._renderTarget.texture.minFilter=zf,this._renderTarget.texture.magFilter=zf,this._renderTarget.texture.format=Gp)}const t=this._renderTarget;t.texture&&(t.texture.colorSpace=this.renderer.outputColorSpace);const e=this.renderer.getRenderTarget();this.renderer.setRenderTarget(t),this.renderer.render(this.scene,this.mainCamera),this.renderer.setRenderTarget(e)}executeCoroutines(t){var i;if(this.coroutines[t]){const n=this.coroutines[t];for(let o=0;o<n.length;o++)try{const r=n[o];if(!r.comp||r.comp.destroyed||!r.main||r.comp.enabled===!1){rA&&console.log("Removing coroutine",r.comp,r.comp.enabled),n.splice(o,1),--o;continue}const c=r.chained;if(c&&c.length>0){const f=c[c.length-1].next();if(f.done&&c.pop(),e(f)&&(r.chained||(r.chained=[]),r.chained.push(f.value)),!f.done)continue}const h=r.main.next();if(h.done===!0){n.splice(o,1),--o;continue}const d=h.value;if(e(d)){if(d.next().done)continue;r.chained||(r.chained=[]),r.chained.push(d)}else if(d instanceof Promise){const u=d;r.chained||(r.chained=[]);const f=jM(u);(i=r.chained)==null||i.push(f);continue}}catch(r){console.error(r)}}function e(n){return!!(n&&n.next&&n.return)}}};let ne=Fe;a(ne,"_defaultTargetFramerate",{value:90,toString(){return this.value}}),a(ne,"_defaultWebglRendererParameters",{antialias:!0,alpha:!1,powerPreference:K.isiOS()||K.isMacOS()?"default":"high-performance",stencil:!0});const pn=S("debuglicense"),n1=[];let Js="basic";pn&&console.log("License Type: "+Js);function $o(){switch(Js){case"pro":case"enterprise":return!0}return!1}function dm(){switch(Js){case"indie":return!0}return!1}function Eb(){switch(Js){case"edu":return!0}return!1}function Wo(){return $o()||dm()||Eb()}function aA(s){if($o()||dm()||Eb())return s(!0);n1.push(s)}function Vu(s){for(const t of n1)try{t(s)}catch{}}ve.registerCallback(ge.ContextRegistered,s=>{hA(s.context),cA(s.context),setTimeout(()=>uA(s.context),2e3)});let Br,p_=!1,Vh="";async function lA(){if(Br)return Br;if(Js==="basic")try{const s="https://engine.needle.tools/licensing/check?location="+encodeURIComponent(window.location.href)+"&version="+as+"&generator="+encodeURIComponent(cb),t=await fetch(s,{method:"GET"}).catch(e=>{pn&&console.error("License check failed",e)});(t==null?void 0:t.status)===200?(p_=!1,pn&&console.log("License check succeeded"),Js="pro",Vu(!0)):(t==null?void 0:t.status)===403?(Vu(!1),p_=!0,Vh=await t.text()):(Vu(!1),pn&&console.log("License check failed with status "+(t==null?void 0:t.status)))}catch(s){Vu(!1),pn&&console.error("License check failed",s)}else pn&&console.log('Runtime license check is skipped because license is already applied as "'+Js+'"')}Br=lA();async function cA(s){function t(){const n=document.createElement("div");n.className="needle-forbidden",n.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: all;
        zIndex: 2147483647;
        line-height: 1.5;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        `;const o=n.style.cssText,r=document.createElement("div");n.appendChild(r),r.style.cssText=`
        position: absolute;
        left: 0;
        right: 0;
        top:0;
        bottom: 0;
        padding: 10%;
        color: white;
        font-size: 20px;
        font-family: sans-serif;
        text-align: center;
        pointer-events: all;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,.3);
        text-shadow: 0 0 2px black;
        `;const l=r.style.cssText,c=(Vh==null?void 0:Vh.length)>1?Vh:"This web application has been paused.<br/>You might be in violation of the Needle Engine terms of use.<br/>Please contact the Needle support if you think this is a mistake.";return r.innerHTML=c,setInterval(()=>{r.innerHTML!==c&&(r.innerHTML=c),r.parentNode!==n&&n.appendChild(r),n.style.cssText!==o&&(n.style.cssText=o),r.style.cssText!==l&&(r.style.cssText=l)},500),n}let e=t();const i=e.style.cssText;setInterval(()=>{var n;p_===!0&&(e.style.cssText!==i&&(e=t()),s.domElement.shadowRoot?e.parentNode!==s.domElement.shadowRoot&&((n=s.domElement.shadowRoot)==null||n.appendChild(e)):e.parentNode!=document.body&&document.body.appendChild(e))},500)}async function hA(s){try{if(!$o()&&!dm())return Ug(s)}catch(t){return pn&&console.log("License check failed",t),Ug(s)}pn&&Ug(s)}async function Ug(s){let t=!1;s.domElement.addEventListener("ready",()=>t=!0),await(Br==null?void 0:Br.catch(()=>{})),!($o()||dm())&&(Wo()===!1&&dA(),t?m_(s):s.domElement.addEventListener("ready",()=>{m_(s)}))}function m_(s){var r;const t=`
        position: relative;
        display: block;
        background-size: 20px;
        background-position: 10px 5px;
        background-repeat:no-repeat;
        background-image:url('${s1}');
        background-max-size: 40px;
        padding: 10px;
        padding-left: 30px;
    `;if(Js==="edu")console.log("%c This project is supported by Needle for Education â€“ https://needle.tools",t);else return;const e=document.createElement("div");e.className="needle-non-commercial-use",e.innerHTML="Made with Needle for Education",(r=s.domElement.shadowRoot)==null||r.appendChild(e);let i=`
        position: absolute;
        font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
        font-size: 12px;
        color: rgb(100, 100, 100);
        /*mix-blend-mode: difference;*/
        background-color: transparent;
        z-index: 10000;

        cursor: pointer;
        user-select: none;
        opacity: 0;

        bottom: 6px;
        right: 12px;
        transform: translateY(0px);
        transition: all .5s ease-in-out 1s;
    `;e.style.cssText=i,e.addEventListener("click",()=>{window.open("https://needle.tools","_blank")});let n=e.style.cssText;setTimeout(()=>{i=i.replace("opacity: 0","opacity: 1"),i=i.replace("transform: translateY(10px)","transform: translateY(0)"),e.style.cssText=i,n=e.style.cssText},100);const o=setInterval(()=>{const l=s.domElement.shadowRoot||s.domElement;e.parentNode!==l&&l.appendChild(e),n!=e.style.cssText&&(e.style.cssText=i,n=e.style.cssText)},1e3);Eb()&&setTimeout(()=>{clearInterval(o),e==null||e.remove();const c=5;setTimeout(()=>{s.domElement.parentNode&&m_(s)},1e3*60*c)},2e4)}const s1="data:image/webp;base64,UklGRrABAABXRUJQVlA4WAoAAAAQAAAAHwAAHwAAQUxQSKEAAAARN6CmbSM4WR7vdARON11EBDq3fLiNbVtVzpMCPlKAEzsx0Y/x+Ovuv4dn0EFE/ydAvz6YggXzgh5sVgXM/zOC/4sii7qgGvB5N7hmuQYwkvazWAu1JPW41FXSHq6pnaQWvqYH18Fc0j1hO/BFTtIeSBlJi5w6qIIO7IOrwhFsB2Yxukif0FTRLpXswHR8MxbslKe9VZsn/Ub5C7YFOpqSTABWUDgg6AAAAFAGAJ0BKiAAIAA+7VyoTqmkpCI3+qgBMB2JbACdMt69DwMIQBLhkTO6XwY00UEDK6cNIDnuNibPf0EgAP7Y1myuiQHLDsF/0h5unrGh6WAbv7aegg2ZMd3uRKfT/3SJztcaujYfTvMXspfCTmYcoO6a+vhC3ss4M8uM58t4siiu59I4aOl59e9Sr6xoxYlHf2v+NnBNpJYeJf8jABQAId/PXuBkLEFkiCucgSGEcfhvajql/j3reCGl0M5/9gQWy7ayNPs+wlvIxFnNfSlfuND4CZOCyxOHhRqOmHN4ULHo3tCSrUNvgAA=";let yx=0;async function dA(s){var o;const t=Date.now();if(t-yx<2e3)return;yx=t;const e=`
        position: relative;
        display: block;
        font-size: 18px;
        background-size: 20px;
        background-position: 10px 5px;
        background-repeat:no-repeat;
        background-image:url('${s1}');
        background-max-size: 40px;
        margin-bottom: 5px;
        margin-top: .3em;
        margin-bottom: .5em;
        padding: .2em;
        padding-left: 25px;
        border-radius: .5em;
        border: 2px solid rgba(160,160,160,.3);
    `,n=`Needle Engine â€” No license active, commercial use is not allowed. Visit https://needle.tools/pricing for more information and licensing options! v${as}`;(o=ne.Current)!=null&&o.xr?console.log(n):console.log("%c "+n,e)}async function uA(s){var e,i;if(window.crossOriginIsolated)return;if(Js==="pro"){const n=(e=s==null?void 0:s.domElement)==null?void 0:e.getAttribute("no-telemetry");if(n===""||n==="true"||n==="1"){pn&&console.debug("Telemetry is disabled");return}pn&&console.debug("Telemetry attribute: "+n)}try{const n="https://needle-engine-analytics-v2-r26roub2hq-lz.a.run.app";if(n){const o=window.location.href.split("?")[0];let r="api/v2/new/request";n.endsWith("/")||(r="/"+r);const l=Js,c=`${n}${r}`;pn&&console.debug("Sending beacon");const h={license:l,url:o,hostname:window.location.hostname,pathname:window.location.pathname,version:as,generator:cb,build_time:vS,public_key:_f},d=(i=navigator.sendBeacon)==null?void 0:i.call(navigator,c,JSON.stringify(h));pn&&console.debug("Sent beacon: "+d)}}catch(n){pn&&console.log("Failed to send non-commercial usage message to analytics backend",n)}}function o1(s,t){return tr(s,ge.ContextCreated,t),()=>Yr(s,ge.ContextCreated)}function fA(s,t){return tr(s,ge.ContextClearing,t),()=>Yr(s,ge.ContextClearing)}function pA(s,t){return tr(s,ge.ContextDestroying,t),()=>Yr(s,ge.ContextDestroying)}function um(s,t){return tr(s,oe.Start,t),()=>Yr(s,oe.Start)}function r1(s,t){return tr(s,oe.Update,t),()=>Yr(s,oe.Update)}function mA(s,t){return tr(s,oe.OnBeforeRender,t),()=>Yr(s,oe.OnBeforeRender)}function gA(s,t){return tr(s,oe.OnAfterRender,t),()=>Yr(s,oe.OnAfterRender)}const yA=S("debugdecoders");let Ng=null;function a1(){if(!Ng){const s=sb(null);Ng={dracoLoader:s.dracoLoader,ktx2Loader:s.ktx2Loader,meshoptDecoder:s.meshoptDecoder}}return Ng}function _x(s){s!==void 0&&typeof s=="string"&&xT(s)}function bx(s){if(s!==void 0&&typeof s=="string"&&s!=="js"){const t=a1();yA&&console.log("Setting draco decoder type to",s),t.dracoLoader.setDecoderConfig({type:s})}}function vx(s){s!==void 0&&typeof s=="string"&&wT(s)}function Mb(s,t){const e=a1();return t.renderer?e.ktx2Loader.detectSupport(t.renderer):console.warn("No renderer provided to detect ktx2 support - loading KTX2 textures will probably fail"),ST(s),s.dracoLoader||s.setDRACOLoader(e.dracoLoader),s.ktx2Loader||s.setKTX2Loader(e.ktx2Loader),s.meshoptDecoder||s.setMeshoptDecoder(e.meshoptDecoder),CT(s,{progressive:!0}),s}const Rt=function(s){return m(s)},m=function(s){if(s===void 0&&(s=null),!Array.isArray(s))s=xx(s);else for(let t=0;t<s.length;t++){const e=s[t];s[t]=xx(e)}return function(t,e){if(!t){const n=typeof e=="string"?e:e.name;console.warn(`@serializable without a target at '${n}'.`);return}typeof e!="string"&&(e=e.name),Object.getOwnPropertyDescriptor(t,"$serializedTypes")||(t.$serializedTypes={});const i=t.$serializedTypes=t.$serializedTypes||{};i[e]=s}};function xx(s){var t,e;switch((e=(t=s==null?void 0:s.prototype)==null?void 0:t.constructor)==null?void 0:e.name){case"Number":case"String":case"Boolean":return null}return s}const Fr=S("debughotreload");let qd=!1;const od=new Map;function k3(){return qd}function wx(){return globalThis.NEEDLE_HOT_RELOAD_ENABLED===!0}function _A(s){var i;if(qd){Fr&&console.warn("[Needle Engine] Hot reloading is in progress, not registering instance",s);return}Fr&&console.log("[Needle Engine] Registering hot reload instance",s);const e=s.constructor.name;od.has(e)?(i=od.get(e))==null||i.push(s):od.set(e,[s])}function bA(s){if(qd){Fr&&console.warn("[Needle Engine] Hot reloading is in progress, not unregistering instance",s);return}Fr&&console.log("[Needle Engine] Unregistering hot reload instance",s);const e=s.constructor.name,i=od.get(e);if(!i)return;const n=i.indexOf(s);n!==-1&&i.splice(n,1)}let Sx=!1;function vA(){if(Fr||Sx)return;Sx=!0;const s=console.error;console.error=(...t)=>{if(t.length){const e=t[0];if(typeof e=="string"&&e.includes("[hmr] Failed to reload ")){console.log("[Needle Engine] Hot reloading failed"),window.location.reload();return}}s.apply(console,t)}}function E3(s){Fr&&console.log("[HMR] Apply changes",s,Object.keys(s)),vA();for(const t of Object.keys(s))try{qd=!0;const e=M.get(t);if(!e){Fr&&console.log("[HMR] Type not found: "+t);continue}const i=s[t],n=od.get(i.name);let o="[Needle Engine] Updating type: "+t;const r=(n==null?void 0:n.length)??-1;r>0?o+=" x"+r:o+=" (No instances registered)",console.log(o);const l=Object.getOwnPropertyNames(e.prototype),c=Object.getOwnPropertyDescriptors(i.prototype);for(const h in c)c[h].writable&&(e.prototype[h]=s[t].prototype[h]);for(const h of l)c[h]||delete e.prototype[h];if(n){const h=new i,d=Object.getOwnPropertyDescriptors(h);for(const u of n){const f=u,p=f.isComponent===!0,g=p?f.activeAndEnabled:!0,_=p?f.context:void 0;try{if(p&&_&&Ao(f,_),p&&g&&(f.enabled=!1),u.onBeforeHotReloadFields&&u.onBeforeHotReloadFields()===!1)continue;for(const y in d)if(d[y].writable){if(u[y]===void 0)u[y]=h[y];else if(typeof u[y]=="function"&&!u[y].prototype){const v=u[y],w=v.name,P="bound ";if(w===P)continue;const E=v.name.substring(P.length),T=i.prototype[E];T&&(u[y]=T.bind(u))}}u.onAfterHotReloadFields&&u.onAfterHotReloadFields()}finally{p&&_&&xb(f,_),p&&g&&(f.enabled=!0)}}}}catch(e){if(Fr)console.error(e);else return!1}finally{qd=!1,La(Jt.Log,"Script changes applied (HMR)")}return!0}class C extends D{constructor(){super(...arguments);a(this,"guid")}static isDestroyed(e){return kc(e)}static setActive(e,i,n=!0){e&&(Of(e,i),Cf(e),i&&n&&kC(ne.Current,e))}static isActiveSelf(e){return su(e)}static isActiveInHierarchy(e){return vM(e)}static markAsInstancedRendered(e,i){xM(e,i)}static isUsingInstancing(e){return Rb(e)}static foreachComponent(e,i,n=!0){return Ec(e,i,n)}static instantiateSynced(e,i){return e?IC(e,i):null}static instantiate(e,i=null){return"isAssetReference"in e,Mc(e,i)}static destroySynced(e,i,n=!0){if(!e)return;const o=e;i=i??ne.Current,rm(o,i.connection,n)}static destroy(e,i=!0){return Wn(e,i)}static add(e,i,n){if(!(!e||!i)){if(e===i){console.warn("Can not add object to self",e);return}n||(n=ne.Current),i.add(e),Of(e,!0),Cf(e),n?C.foreachComponent(e,o=>{xb(o,n),!o.__internalDidAwakeAndStart&&n.new_script_start.includes(o)===!1&&n.new_script_start.push(o)},!0):console.warn("Missing context")}}static remove(e){var i;e&&((i=e.parent)==null||i.remove(e),Of(e,!1),Cf(e),C.foreachComponent(e,n=>{wE(n)},!0))}static invokeOnChildren(e,i,...n){this.invoke(e,i,!0,n)}static invoke(e,i,n=!1,...o){e&&this.foreachComponent(e,r=>{const l=r[i];l&&typeof l=="function"&&(l==null||l.call(r,...o))},n)}static addNewComponent(e,i,n,o=!0){return Ks(e,i,n,{callAwake:o})}static addComponent(e,i,n,o){return Ks(e,i,n,o)}static moveComponent(e,i){return Ks(e,i)}static removeComponent(e){return NC(e.gameObject,e),e}static getOrAddComponent(e,i){return am(e,i)}static getComponent(e,i){return e===null?null:Bc(e,i)}static getComponents(e,i,n=null){return e===null?n??[]:lm(e,i,n)}static findByGuid(e,i){return VC(e,i)}static findObjectOfType(e,i,n=!0){return hm(e,i??ne.Current,n)}static findObjectsOfType(e,i){const n=[];return gM(e,n,i),n}static getComponentInChildren(e,i){return cm(e,i)}static getComponentsInChildren(e,i,n=null){return nu(e,i,n??void 0)}static getComponentInParent(e,i){return ep(e,i)}static getComponentsInParent(e,i,n=null){return Cb(e,i,n)}static getAllComponents(e){var o;const i=(o=e.userData)==null?void 0:o.components;return i?[...i]:[]}static*iterateComponents(e){var n;const i=(n=e==null?void 0:e.userData)==null?void 0:n.components;if(i&&Array.isArray(i))for(let o=0;o<i.length;o++)yield i[o]}}const Ed=class{constructor(t){a(this,"__context");a(this,"__name");a(this,"gameObject");a(this,"guid","invalid");a(this,"sourceId");a(this,"__didAwake",!1);a(this,"__didStart",!1);a(this,"__didEnable",!1);a(this,"__isEnabled");a(this,"__destroyed",!1);a(this,"_eventListeners",new Map);this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t),wx()&&_A(this)}get isComponent(){return!0}get context(){return this.__context??ne.Current}set context(t){this.__context=t}get scene(){return this.context.scene}get layer(){var t,e;return(e=(t=this.gameObject)==null?void 0:t.userData)==null?void 0:e.layer}get name(){var t,e;return(t=this.gameObject)!=null&&t.name?this.gameObject.name:(e=this.gameObject)==null?void 0:e.userData.name}set name(t){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=t,this.__name=t):this.__name=t}get tag(){var t;return(t=this.gameObject)==null?void 0:t.userData.tag}set tag(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.tag=t)}get static(){var t;return(t=this.gameObject)==null?void 0:t.userData.static}set static(t){this.gameObject&&(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.static=t)}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const t=this.gameObject[jr];return t===void 0?!0:t}set __isActiveInHierarchy(t){this.gameObject&&(this.gameObject[jr]=t)}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(t,e=oe.Update){return this.context.registerCoroutineUpdate(this,t,e)}stopCoroutine(t,e=oe.Update){this.context.unregisterCoroutineUpdate(t,e)}get destroyed(){return this.__destroyed}destroy(){this.__destroyed||this.__internalDestroy()}get __internalDidAwakeAndStart(){return this.__didAwake&&this.__didStart}__internalNewInstanceCreated(t){return this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1,this._internalInit(t),this}_internalInit(t){if(typeof t=="object")for(const e of Object.keys(t)){const i=t[e];typeof i!="function"&&(this[e]=i)}}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(t){return this.__destroyed?(U()&&console.warn("[Needle Engine Dev] Trying to enable destroyed component"),!1):this.__didAwake?this.__didEnable?(t!==!0&&(this.__isEnabled=!0),!1):(this.__didEnable=!0,this.__isEnabled=!0,this.onEnable(),!0):!1}__internalDisable(t){if(this.__didAwake){if(!this.__didEnable){t!==!0&&(this.__isEnabled=!1);return}this.__didEnable=!1,this.__isEnabled=!1,this.onDisable()}}__internalDestroy(){var t;this.__destroyed||(this.__destroyed=!0,this.__didAwake&&((t=this.onDestroy)==null||t.call(this),this.dispatchEvent(new CustomEvent("destroyed",{detail:this}))),mM(this),wx()&&bA(this))}get enabled(){return typeof this.__isEnabled=="boolean"?this.__isEnabled:!0}set enabled(t){if(this.__destroyed){U()&&console.warn(`[Needle Engine Dev] Trying to ${t?"enable":"disable"} destroyed component`);return}if(typeof t=="number"&&(t>=.5?t=!0:t=!1),!this.__didAwake){this.__isEnabled=t;return}t?this.__internalEnable():this.__internalDisable()}get worldPosition(){return ae(this.gameObject)}set worldPosition(t){ei(this.gameObject,t)}setWorldPosition(t,e,i){Cc(this.gameObject,t,e,i)}get worldQuaternion(){return Le(this.gameObject)}set worldQuaternion(t){no(this.gameObject,t)}setWorldQuaternion(t,e,i,n){dS(this.gameObject,t,e,i,n)}get worldEuler(){return uS(this.gameObject)}set worldEuler(t){fS(this.gameObject,t)}get worldRotation(){return this.gameObject.worldRotation}set worldRotation(t){this.setWorldRotation(t.x,t.y,t.z,!0)}setWorldRotation(t,e,i,n=!0){em(this.gameObject,t,e,i,n)}get forward(){return Ed._forward.set(0,0,-1).applyQuaternion(this.worldQuaternion)}get right(){return Ed._right.set(1,0,0).applyQuaternion(this.worldQuaternion)}get up(){return Ed._up.set(0,1,0).applyQuaternion(this.worldQuaternion)}addEventListener(t,e){this._eventListeners[t]=this._eventListeners[t]||[],this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}dispatchEvent(t){if(!t||!this._eventListeners[t.type])return!1;const e=this._eventListeners[t.type];for(let i=0;i<e.length;i++)e[i](t);return!1}};let j=Ed;a(j,"_forward",new x),a(j,"_right",new x),a(j,"_up",new x);const xA=Object.freeze(Object.defineProperty({__proto__:null,Behaviour:j,Component:j,GameObject:C},Symbol.toStringTag,{value:"Module"}));var l1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class fm extends j{constructor(){super(...arguments);a(this,"from");a(this,"to");a(this,"width",0);a(this,"centered",!0);a(this,"_centerPos")}awake(){this._centerPos=new x}update(){if(!this.from||!this.to)return;const e=ae(this.from).clone(),i=ae(this.to).clone(),n=e.distanceTo(i);this._centerPos.copy(e),this._centerPos.add(i),this._centerPos.multiplyScalar(.5),ei(this.gameObject,this.centered?this._centerPos:e),this.gameObject.lookAt(ae(this.to).clone()),this.gameObject.scale.set(this.width,this.width,n)}}l1([m(C)],fm.prototype,"from",void 0);l1([m(C)],fm.prototype,"to",void 0);var hl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const cr=S("debuganimation");let c1=class{constructor(){a(this,"x");a(this,"y")}};class Yi extends j{constructor(){super(...arguments);a(this,"playAutomatically",!0);a(this,"randomStartTime",!0);a(this,"minMaxSpeed");a(this,"minMaxOffsetNormalized");a(this,"loop",!0);a(this,"clampWhenFinished",!1);a(this,"_tempAnimationClipBeforeGameObjectExisted",null);a(this,"_tempAnimationsArray");a(this,"mixer");a(this,"_actions");a(this,"_handles")}get isAnimationComponent(){return!0}addClip(e){this.animations||(this.animations=[]),this.animations.includes(e)||this.animations.push(e)}get time(){if(this.actions){for(const e of this.actions)if(e.isRunning())return e.time}return 0}set time(e){if(this.actions)for(const i of this.actions)i.time=e}get duration(){if(this.actions){for(const e of this.actions)if(e.isRunning())return e.getClip().duration}return 0}get clip(){var e;return(e=this.animations)!=null&&e.length?this.animations[0]:null}set clip(e){if(!this.__didAwake){cr&&console.warn("Assign clip during serialization",e),this._tempAnimationClipBeforeGameObjectExisted=e;return}e&&(this.gameObject.animations||(this.gameObject.animations=[]),!this.animations.includes(e)&&(this.animations.length>0?this.animations.splice(0,0,e):this.animations.push(e)))}set clips(e){this.animations=e}set animations(e){e==null||!Array.isArray(e)||(this.gameObject?this.gameObject.animations=e:this._tempAnimationsArray=e)}get animations(){var e;return((e=this.gameObject)==null?void 0:e.animations)||this._tempAnimationsArray||[]}get actions(){return this._actions}set actions(e){this._actions=e}awake(){this.mixer=void 0,cr&&console.log("Animation Awake",this.name,this),this._tempAnimationsArray&&(this.animations=this._tempAnimationsArray,this._tempAnimationsArray=void 0),this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.actions=[],this._handles=[]}onEnable(){var e;if(this.playAutomatically&&((e=this.animations)==null?void 0:e.length)>0){const i=Math.floor(Math.random()*this.animations.length),n=this.animations[i];this.play(i,{exclusive:!0,fadeDuration:0,startTime:this.randomStartTime?Math.random()*n.duration:0,loop:this.loop,clampWhenFinished:this.clampWhenFinished})}}update(){this.mixer&&(this.mixer.update(this.context.time.deltaTime),this._handles.forEach(e=>e.update()))}onDisable(){this.mixer&&this.mixer.stopAllAction()}onDestroy(){this.context.animations.unregisterAnimationMixer(this.mixer)}getAction(e){var i;return((i=this.actions)==null?void 0:i.find(n=>n.getClip().name===e))||null}get isPlaying(){if(this.actions){for(let e=0;e<this.actions.length;e++)if(this.actions[e].isRunning())return!0}return!1}stopAll(e){if(this.actions)for(const i of this.actions)e!=null&&e.fadeDuration?i.fadeOut(e.fadeDuration):i.stop()}stop(e,i){if(e===void 0){this.stopAll();return}else if(typeof e=="number"){if(e>=this.animations.length){cr&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}i!=null&&i.fadeDuration?n.fadeOut(i.fadeDuration):n.stop()}pause(e,i=!1){if(e===void 0){for(const o of this.actions)o.paused=!i;return}else if(typeof e=="number"){if(e>=this.animations.length){cr&&console.log("No animation at index",e);return}e=this.animations[e]}else typeof e=="string"&&(e=this.animations.find(o=>o.name===e));if(!e){console.error("Could not find clip",e);return}const n=this.actions.find(o=>o.getClip()===e);if(!n){console.error("Could not find action",e);return}n.paused=!i}resume(){for(const e of this.actions)e.paused=!1}play(e=0,i){if(cr&&console.log("PLAY",e),this.ensureMixer(),!this.mixer){cr&&console.warn("Missing mixer",this);return}e===void 0&&(e=0);let n=e;if(typeof e=="number"){if(e>=this.animations.length){cr&&console.log("No animation at index",e);return}n=this.animations[e]}else typeof e=="string"&&(n=this.animations.find(r=>r.name===e));if(!n){console.error("Could not find clip",e);return}i||(i={});for(const r of this.actions)if(r.getClip()===n)return this.internalOnPlay(r,i);if(!n.tracks){console.warn("Clip is no AnimationClip",n);return}const o=this.mixer.clipAction(n);return this.actions.push(o),this.internalOnPlay(o,i)}internalOnPlay(e,i){var n=this.actions.find(l=>l===e);if(n===e&&n.isRunning()&&n.time<n.getClip().duration){const l=this.tryFindHandle(e);if(n.paused&&(n.paused=!1),l)return l.waitForFinish()}if(i.loop===void 0&&(i.loop=this.loop),i.clampWhenFinished===void 0&&(i.clampWhenFinished=this.clampWhenFinished),i.minMaxOffsetNormalized===void 0&&this.randomStartTime&&(i.minMaxOffsetNormalized=this.minMaxOffsetNormalized),i.minMaxSpeed===void 0&&(i.minMaxSpeed=this.minMaxSpeed),(i==null?void 0:i.exclusive)??!0)for(const l of this.actions)l!=n&&(i.fadeDuration?l.fadeOut(i.fadeDuration):l.stop());if(i!=null&&i.fadeDuration&&e.fadeIn(i.fadeDuration),e.enabled=!0,(i==null?void 0:i.startTime)!=null)e.time=i.startTime;else if(i!=null&&i.minMaxOffsetNormalized&&i.minMaxOffsetNormalized.x!=0&&i.minMaxOffsetNormalized.y!=0){const l=e.getClip();e.time=N.lerp(i.minMaxOffsetNormalized.x,i.minMaxOffsetNormalized.y,Math.random())*l.duration}else e.time>=e.getClip().duration&&(e.time=0);i!=null&&i.minMaxSpeed?e.timeScale=N.lerp(i.minMaxSpeed.x,i.minMaxSpeed.y,Math.random()):e.timeScale=(i==null?void 0:i.speed)??1,(i==null?void 0:i.loop)!=null?e.loop=i.loop?ZP:Oy:e.loop=Oy,i!=null&&i.clampWhenFinished&&(e.clampWhenFinished=!0),e.paused=!1,e.play(),cr&&console.log("PLAY",e.getClip().name,e);const r=new wA(e,this.mixer,i,l=>{this._handles.splice(this._handles.indexOf(r),1)});return this._handles.push(r),r.waitForFinish()}tryFindHandle(e){for(const i of this._handles)if(i.action===e)return i}ensureMixer(){if(!this.mixer){const e="animationMixer";this.gameObject[e]&&(this.mixer=this.gameObject[e]),(!this.mixer||!this.mixer.clipAction)&&(this.mixer=new J_(this.gameObject),this.gameObject[e]=this.mixer)}this.context.animations.registerAnimationMixer(this.mixer)}}hl([m()],Yi.prototype,"playAutomatically",void 0);hl([m()],Yi.prototype,"randomStartTime",void 0);hl([m(c1)],Yi.prototype,"minMaxSpeed",void 0);hl([m(c1)],Yi.prototype,"minMaxOffsetNormalized",void 0);hl([m()],Yi.prototype,"loop",void 0);hl([m()],Yi.prototype,"clampWhenFinished",void 0);hl([m(Dr)],Yi.prototype,"clips",null);class wA{constructor(t,e,i,n){a(this,"mixer");a(this,"action");a(this,"promise",null);a(this,"_options");a(this,"_resolveCallback",null);a(this,"_resolvedOrRejectedCallback");a(this,"onFinished",t=>{t.action===this.action&&this.onResolve()});this.action=t,this.mixer=e,this._resolvedOrRejectedCallback=n,this._options=i}waitForFinish(){return this.promise?this.promise:(this.promise=new Promise(t=>{this._resolveCallback=t}),this.mixer.addEventListener("finished",this.onFinished),this.promise)}update(){this._options&&this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=this._options.startTime??0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var t,e;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(e=this._resolveCallback)==null||e.call(this,this.action)}dispose(){this.mixer.removeEventListener("finished",this.onFinished)}}const Mf=Symbol("objectIsAnimatedData");function Cx(s,t,e){if(!s)return;if(s[Mf]===void 0){if(!e)return;s[Mf]=new Set}const i=s[Mf];e?i.add(t):i.has(t)&&i.delete(t)}function SA(s){if(!s)return!1;const t=s[Mf];return t!==void 0&&t.size>0}class A3{constructor(){a(this,"_context")}get context(){return this._context??ne.Current}get isStateMachineBehaviour(){return!0}}class Hu{constructor(t,e,i,n){a(this,"name");a(this,"nameHash");a(this,"normalizedTime");a(this,"length");a(this,"speed");a(this,"action");a(this,"hasTransitions");var o;this.name=t.name,this.nameHash=t.hash,this.normalizedTime=e,this.length=i,this.speed=n,this.action=t.motion.action||null,this.hasTransitions=((o=t.transitions)==null?void 0:o.length)>0||!1}}function CA(s,t){return{name:"Empty",isLooping:!1,guid:(t==null?void 0:t.generateUUID())??Fo.generateUUID(),index:-1,clip:new Dr(s,0,[])}}var xr;(function(s){s[s.If=1]="If",s[s.IfNot=2]="IfNot",s[s.Greater=3]="Greater",s[s.Less=4]="Less",s[s.Equals=6]="Equals",s[s.NotEqual=7]="NotEqual"})(xr||(xr={}));var g_;(function(s){s[s.Float=1]="Float",s[s.Int=3]="Int",s[s.Bool=4]="Bool",s[s.Trigger=9]="Trigger"})(g_||(g_={}));const xt=S("debuganimatorcontroller"),Gu=S("debugrootmotion");class hs{constructor(t){a(this,"_speed",1);a(this,"normalizedStartOffset",0);a(this,"animator");a(this,"model");a(this,"_mixer");a(this,"_activeState");a(this,"_activeStates",[]);a(this,"_heldActions",[]);a(this,"rootMotionHandler");this.model=t,xt&&console.log(this)}static createFromClips(t,e={looping:!1,autoTransition:!0,transitionDuration:0}){const i=[];for(let r=0;r<t.length;r++){const l=t[r],c=[];if(e.autoTransition!==!1){const d=e.transitionDuration??0,u=d/l.duration;let f=r;(e.autoTransition===void 0||e.autoTransition===!0)&&(f=(r+1)%t.length),c.push({exitTime:1-u,offset:0,duration:d,hasExitTime:!0,destinationState:f,conditions:[]})}const h={name:l.name,hash:r,motion:{name:l.name,clip:l,isLooping:(e==null?void 0:e.looping)??!1},transitions:c,behaviours:[]};i.push(h)}const n={name:"AnimatorController",guid:new yi(Date.now()).generateUUID(),parameters:[],layers:[{name:"Base Layer",stateMachine:{defaultState:0,states:i}}]};return new hs(n)}play(t,e=-1,i=Number.NEGATIVE_INFINITY,n=0){if(e<0)e=0;else if(e>=this.model.layers.length){console.warn("invalid layer");return}const r=this.model.layers[e].stateMachine;for(const l of r.states)if(l.name===t||l.hash===t){xt&&console.log("transition to ",l),this.transitionTo(l,n,i);return}console.warn("Could not find "+t+" to play")}reset(){this.setStartTransition()}setBool(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(r=>r[i]===t).forEach(r=>r.value=e)}getBool(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??!1}setFloat(t,e){var o,r;const i=typeof t=="string"?"name":"hash",n=(r=(o=this.model)==null?void 0:o.parameters)==null?void 0:r.filter(l=>l[i]===t);return n.forEach(l=>l.value=e),(n==null?void 0:n.length)>0}getFloat(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??0}setInteger(t,e){var n,o;const i=typeof t=="string"?"name":"hash";return(o=(n=this.model)==null?void 0:n.parameters)==null?void 0:o.filter(r=>r[i]===t).forEach(r=>r.value=e)}getInteger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??0}setTrigger(t){var i,n;xt&&console.log("SET TRIGGER",t);const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!0)}resetTrigger(t){var i,n;const e=typeof t=="string"?"name":"hash";return(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.filter(o=>o[e]===t).forEach(o=>o.value=!1)}getTrigger(t){var i,n,o;const e=typeof t=="string"?"name":"hash";return((o=(n=(i=this.model)==null?void 0:i.parameters)==null?void 0:n.find(r=>r[e]===t))==null?void 0:o.value)??!1}isInTransition(){return this._activeStates.length>1}setSpeed(t){this._speed=t}FindState(t){return this.findState(t)}findState(t){if(!t)return null;if(Array.isArray(this.model.layers)){for(const e of this.model.layers)for(const i of e.stateMachine.states)if(i.name===t||i.hash==t)return i}return null}getCurrentStateInfo(){if(!this._activeState)return null;const t=this._activeState.motion.action;if(!t)return null;const e=this._activeState.motion.clip.duration,i=e<=0?0:Math.abs(t.time/e);return new Hu(this._activeState,i,e,this._speed)}get currentAction(){if(!this._activeState)return null;const t=this._activeState.motion.action;return t||null}get context(){var t;return(t=this.animator)==null?void 0:t.context}get mixer(){return this._mixer}dispose(){var t;if(this._mixer.stopAllAction(),this.animator){this._mixer.uncacheRoot(this.animator.gameObject);for(const e of this._activeStates)e.motion.clip&&this.mixer.uncacheAction(e.motion.clip,this.animator.gameObject)}(t=this.context)==null||t.animations.unregisterAnimationMixer(this._mixer)}bind(t){var e,i;t?this.animator!==t&&(this._mixer&&(this._mixer.stopAllAction(),(e=this.context)==null||e.animations.unregisterAnimationMixer(this._mixer)),this.animator=t,this._mixer=new J_(this.animator.gameObject),(i=this.context)==null||i.animations.registerAnimationMixer(this._mixer),this.createActions(this.animator)):console.error("AnimatorController.bind: animator is null")}clone(){if(typeof this.model=="string")return console.warn("AnimatorController has not been resolved, can not create model from string",this.model),null;xt&&console.warn("AnimatorController clone()",this.model);const t=Kp(this.model,(i,n,o)=>o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||PO(o)||o.tracks!==void 0||o instanceof hs));return console.assert(t!==this.model),new hs(t)}update(t){var i,n;if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates(t);const e=this.animator.context.time.deltaTime;this.animator.applyRootMotion&&((i=this.rootMotionHandler)==null||i.onBeforeUpdate(t)),this._mixer.update(e),this.animator.applyRootMotion&&((n=this.rootMotionHandler)==null||n.onAfterUpdate(t))}get activeState(){return this._activeState}updateActiveStates(t){for(let e=0;e<this._activeStates.length;e++){const i=this._activeStates[e],n=i.motion;if(!n.action)this._activeStates.splice(e,1),e--;else{const o=n.action;o.weight=t,o.getEffectiveWeight()<=0&&!o.isRunning()&&(xt&&console.debug("REMOVE",i.name,o.getEffectiveWeight(),o.isRunning(),o.isScheduled()),this._activeStates.splice(e,1),e--)}}}setStartTransition(){var t;this.model.layers.length>1&&(xt||U())&&console.warn("Multiple layers are not supported yet "+((t=this.animator)==null?void 0:t.name));for(const e of this.model.layers){const i=e.stateMachine;i.defaultState===void 0&&(xt&&console.warn("AnimatorController default state is undefined, will assign state 0 as default",e),i.defaultState=0);const n=i.states[i.defaultState];this.transitionTo(n,0,this.normalizedStartOffset);break}}evaluateTransitions(){var o;let t=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;t=!0}const e=this._activeState,i=e.motion.action;for(const r of e.transitions){if(!r.hasExitTime&&r.conditions.length<=0)continue;let l=!0;for(const c of r.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(l)if(i){const c=e.motion.clip.duration,h=c<=0?1:Math.abs(i.time/c);let d=r.exitTime;i.timeScale<0&&(d=1-d);let u=!1;if(r.hasExitTime?i.timeScale>0?u=h>=r.exitTime:i.timeScale<0&&(u=1-h>=r.exitTime):u=!0,u){for(const f of r.conditions){const p=this.model.parameters.find(g=>g.name===f.parameter);(p==null?void 0:p.type)===g_.Trigger&&p.value&&(p.value=!1)}if(i.clampWhenFinished=!0,xt){const f=this.getState(r.destinationState,0);console.log(`Transition to ${r.destinationState} / ${f==null?void 0:f.name}`,r,`
Timescale: `+i.timeScale,`
Normalized time: `+h.toFixed(3),`
Exit Time: `+d,r.hasExitTime)}this.transitionTo(r.destinationState,r.duration,r.offset);return}}else{this.transitionTo(r.destinationState,r.duration,r.offset);return}}i&&this.setTimescale(i,e);let n=!1;if(e.motion.isLooping&&i&&(i.time>=i.getClip().duration?(n=!0,i.reset(),i.time=0,i.play()):i.time<=0&&i.timeScale<0&&(n=!0,i.reset(),i.time=i.getClip().duration,i.play())),!n&&e&&!t&&i&&this.animator&&e.behaviours){const r=i==null?void 0:i.getClip().duration,l=i.time/r,c=new Hu(this._activeState,l,r,this._speed);for(const h of e.behaviours)h.instance&&((o=h.instance.onStateUpdate)==null||o.call(h.instance,this.animator,c,0))}}setTimescale(t,e){let i=e.speed??1;e.speedParameter&&(i*=this.getFloat(e.speedParameter)),i!==void 0&&(t.timeScale=i*this._speed)}getState(t,e){return typeof t=="number"&&(t==-1&&(t=this.model.layers[e].stateMachine.defaultState,t===void 0&&(xt&&console.warn("AnimatorController default state is undefined: ",this.model,"Layer: "+e),t=0)),t=this.model.layers[e].stateMachine.states[t]),t}releaseHeldActions(t){for(const e of this._heldActions)e.fadeOut(t);this._heldActions.length=0}transitionTo(t,e,i){var d,u,f,p,g,_,y,b;if(!this.animator)return;const n=0;if(t=this.getState(t,n),!(t!=null&&t.motion)||!t.motion.clip||!(t.motion.clip instanceof Dr))return;const o=this._activeState===t;if(o){const v=t.motion;if(!v.action_loopback&&v.clip){const w=this.rootMotionHandler?this.animator.gameObject.matrix.clone():null;this._mixer.uncacheAction(v.clip,this.animator.gameObject),w&&w.decompose(this.animator.gameObject.position,this.animator.gameObject.quaternion,this.animator.gameObject.scale),v.action_loopback=this.createAction(v.clip)}}if((d=this._activeState)!=null&&d.behaviours&&this._activeState.motion.action){const v=(u=this._activeState)==null?void 0:u.motion.clip.duration,w=this._activeState.motion.action.time/v,P=new Hu(this._activeState,w,v,this._speed);for(const E of this._activeState.behaviours)(p=(f=E.instance)==null?void 0:f.onStateExit)==null||p.call(E.instance,this.animator,P,n)}const r=(g=this._activeState)==null?void 0:g.motion.action;o&&(t.motion.action=t.motion.action_loopback,t.motion.action_loopback=r);const l=this._activeState;this._activeState=t;const c=(_=t.motion)==null?void 0:_.action,h=t.motion.clip;if((h==null?void 0:h.duration)<=0&&h.tracks.length<=0?r&&this._heldActions.push(r):r&&(r.fadeOut(e),this.releaseHeldActions(e)),c){if(i=Math.max(0,Math.min(1,i)),t.cycleOffsetParameter){let w=this.getFloat(t.cycleOffsetParameter);typeof w=="number"?(w<0&&(w+=1),i+=w,i%=1):xt&&console.warn("AnimatorController cycle offset parameter is not a number",t.cycleOffsetParameter)}else typeof t.cycleOffset=="number"&&(i+=t.cycleOffset,i%=1);c.isRunning()&&c.stop(),c.reset(),c.enabled=!0,this.setTimescale(c,t);const v=t.motion.clip.duration;if(c.time=o?0:i*v,c.timeScale<0&&(c.time=v-c.time),c.clampWhenFinished=!0,c.setLoop(Oy,0),e>0?c.fadeIn(e):c.weight=1,c.play(),this.rootMotionHandler&&this.rootMotionHandler.onStart(c),this._activeStates.includes(t)||this._activeStates.push(t),this._activeState.behaviours){const w=new Hu(t,i,v,this._speed);for(const P of this._activeState.behaviours)(b=(y=P.instance)==null?void 0:y.onStateEnter)==null||b.call(P.instance,this.animator,w,n)}}else xt&&(t.__warned_no_motion||(t.__warned_no_motion=!0,console.warn("No action",t.motion,this)));xt&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+t.name,e,r,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}createAction(t){var i,n;if(this._mixer.existingAction(t)&&this._mixer.uncacheAction(t,(i=this.animator)==null?void 0:i.gameObject),(n=this.animator)!=null&&n.applyRootMotion){this.rootMotionHandler||(this.rootMotionHandler=new PA(this));const o=this.animator.gameObject;return this.rootMotionHandler.createClip(this._mixer,o,t)}else return this._mixer.clipAction(t)}evaluateCondition(t){const e=this.model.parameters.find(i=>i.name===t.parameter);if(!e)return!1;switch(t.mode){case xr.If:return e.value===!0;case xr.IfNot:return e.value===!1;case xr.Greater:return e.value>t.threshold;case xr.Less:return e.value<t.threshold;case xr.Equals:return e.value===t.threshold;case xr.NotEqual:return e.value!==t.threshold}return!1}createActions(t){var e,i,n,o;xt&&console.log("AnimatorController createActions",this.model);for(const r of this.model.layers){const l=r.stateMachine;for(let c=0;c<l.states.length;c++){const h=l.states[c];h.transitions||(h.transitions=[]);for(const d of h.transitions)d.conditions||(d.conditions=[]);if(h.motion||(xt&&console.warn("No motion",h),h.motion=CA(h.name)),this.animator&&h.motion.clips){const d=(e=h.motion.clips)==null?void 0:e.find(u=>{var f,p;return u.node.name===((p=(f=this.animator)==null?void 0:f.gameObject)==null?void 0:p.name)});d?h.motion.clip=d.clip:(xt||U())&&console.warn('Could not find clip for animator "'+((n=(i=this.animator)==null?void 0:i.gameObject)==null?void 0:n.name)+'"',h.motion.clips.map(u=>u.node.name))}if(!h.motion.clip){xt&&console.warn("No clip assigned to state",h);const d=new Dr(void 0,void 0,[]);h.motion.clip=d}if((o=h.motion)!=null&&o.clip){const d=h.motion.clip;if(d instanceof Dr){const u=this.createAction(d);h.motion.action=u}else(xt||U())&&console.warn("No valid animationclip assigned",h)}if(h.behaviours&&Array.isArray(h.behaviours))for(const d of h.behaviours){if(!(d!=null&&d.typeName))continue;const u=M.get(d.typeName);if(u){const f=new u;f.isStateMachineBehaviour&&(f._context=this.context??void 0,Oc(f,d.properties),d.instance=f),xt&&console.log("Created animator controller behaviour",h.name,d.typeName,d.properties,f)}else(xt||U())&&console.warn("Could not find AnimatorBehaviour type: "+d.typeName)}}}}*enumerateActions(){if(this.model.layers)for(const t of this.model.layers){const e=t.stateMachine;for(let i=0;i<e.states.length;i++){const n=e.states[i];n!=null&&n.motion&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}}class Px{constructor(t,e){a(this,"track");a(this,"createdInterpolant");a(this,"originalEvaluate");a(this,"customEvaluate");this.track=t;const i=t,n=i.createInterpolant.bind(t);i.createInterpolant=()=>(i.createInterpolant=n,this.createdInterpolant=n(),this.originalEvaluate=this.createdInterpolant.evaluate.bind(this.createdInterpolant),this.customEvaluate=o=>{if(!this.originalEvaluate)return;const r=this.originalEvaluate(o);return e(o,r)},this.createdInterpolant.evaluate=this.customEvaluate,this.createdInterpolant)}dispose(){this.createdInterpolant&&this.originalEvaluate&&(this.createdInterpolant.evaluate=this.originalEvaluate),this.track=void 0,this.createdInterpolant=null,this.originalEvaluate=void 0,this.customEvaluate=void 0}}const St=class{constructor(t,e,i,n,o){a(this,"_action");a(this,"root");a(this,"clip");a(this,"positionWrapper",null);a(this,"rotationWrapper",null);a(this,"context");a(this,"positionChange",new x);a(this,"rotationChange",new H);a(this,"_prevTime",0);if(this.context=t,this.root=e,this.clip=i,St.firstKeyframeRotation[this.cacheId]||(St.firstKeyframeRotation[this.cacheId]=new H),o){const r=o.values;St.firstKeyframeRotation[this.cacheId].set(r[0],r[1],r[2],r[3])}St.spaceRotation[this.cacheId]||(St.spaceRotation[this.cacheId]=new H),St.effectiveSpaceRotation[this.cacheId]||(St.effectiveSpaceRotation[this.cacheId]=new H),St.clipOffsetRotation[this.cacheId]=new H,o&&St.clipOffsetRotation[this.cacheId].set(o.values[0],o.values[1],o.values[2],o.values[3]).invert(),this.handlePosition(i,n),this.handleRotation(i,o)}set action(t){this._action=t}get action(){return this._action}get cacheId(){return this.root.uuid}onStart(t){if(t.getClip()!==this.clip)return;St.lastObjRotation[this.cacheId]||(St.lastObjRotation[this.cacheId]=this.root.quaternion.clone());const e=St.lastObjRotation[this.cacheId];if(St.spaceRotation[this.cacheId].copy(e),Gu){const i=new Ct().setFromQuaternion(e);console.log("START",this.clip.name,N.toDegrees(i.y),this.root.position.z)}}getClipRotationOffset(){return St.clipOffsetRotation[this.cacheId]}handlePosition(t,e){if(e){const i=this.root;Gu&&i.add(new yn),St.lastObjPosition[this.cacheId]||(St.lastObjPosition[this.cacheId]=this.root.position.clone());const n=new x,o=new x;this.positionWrapper=new Px(e,(r,l)=>{const c=this.action.getEffectiveWeight();return Gu&&i.position.length()>8&&i.position.set(0,i.position.y,0),r>this._prevTime&&(n.set(l[0],l[1],l[2]),n.sub(o),n.multiplyScalar(c),n.applyQuaternion(this.getClipRotationOffset()),n.applyQuaternion(i.quaternion),this.positionChange.copy(n)),o.fromArray(l),this._prevTime=r,l[0]=0,l[1]=0,l[2]=0,l})}}handleRotation(t,e){if(e){if(Gu){const r=e.values,l=new Ct().setFromQuaternion(new H(r[0],r[1],r[2],r[3]));console.log(t.name,e.name,"FIRST ROTATION IN TRACK",N.toDegrees(l.y));const c=e.values.length-4,h=new H().set(r[c],r[c+1],r[c+2],r[c+3]),d=new Ct().setFromQuaternion(h);console.log(t.name,e.name,"LAST ROTATION IN TRACK",N.toDegrees(d.y))}let i=0;const n=new H,o=new H;this.rotationWrapper=new Px(e,(r,l)=>(r>i&&(o.set(l[0],l[1],l[2],l[3]),n.invert(),o.multiply(n),this.rotationChange.copy(o)),n.fromArray(l),i=r,l[0]=0,l[1]=0,l[2]=0,l[3]=1,l))}}onBeforeUpdate(t){this.positionChange.set(0,0,0),this.rotationChange.set(0,0,0,1)}onAfterUpdate(t){return!this.action||(t*=this.action.getEffectiveWeight(),t<=0)?!1:(this.positionChange.multiplyScalar(t),this.rotationChange.slerp(St.identityQuaternion,1-t),!0)}};let Ps=St;a(Ps,"lastObjPosition",{}),a(Ps,"lastObjRotation",{}),a(Ps,"firstKeyframeRotation",{}),a(Ps,"spaceRotation",{}),a(Ps,"effectiveSpaceRotation",{}),a(Ps,"clipOffsetRotation",{}),a(Ps,"identityQuaternion",new H);class PA{constructor(t){a(this,"controller");a(this,"handler",[]);a(this,"root");a(this,"basePosition",new x);a(this,"baseQuaternion",new H);a(this,"baseRotation",new Ct);a(this,"summedPosition",new x);a(this,"summedRotation",new H);this.controller=t}createClip(t,e,i){this.root=e,e&&"name"in e&&e.name;const n=this.findRootTrack(i,".position"),o=this.findRootTrack(i,".quaternion"),r=new Ps(this.controller.context,e,i,n,o);this.handler.push(r);const l=t.clipAction(i);return r.action=l,l}onStart(t){for(const e of this.handler)e.onStart(t)}onBeforeUpdate(t){this.basePosition.copy(this.root.position),this.baseQuaternion.copy(this.root.quaternion);for(const e of this.handler)e.onBeforeUpdate(t)}onAfterUpdate(t){if(!(t<=0)){this.root.position.copy(this.basePosition),this.root.quaternion.copy(this.baseQuaternion),this.summedPosition.set(0,0,0),this.summedRotation.set(0,0,0,1);for(const e of this.handler)e.onAfterUpdate(t)&&(this.summedPosition.add(e.positionChange),this.summedRotation.multiply(e.rotationChange));this.root.position.add(this.summedPosition),this.root.quaternion.multiply(this.summedRotation)}}findRootTrack(t,e){const i=t.tracks;if(!i)return null;for(const n of i)if(n.name.endsWith(e))return n;return null}}class RA extends Gn{onSerialize(t,e){}onDeserialize(t,e){if(e.type===hs&&(t==null?void 0:t.__type)==="AnimatorController")return new hs(t)}}new RA(hs);var pm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const En=S("debuganimator");class ii extends j{constructor(){super(...arguments);a(this,"applyRootMotion",!1);a(this,"hasRootMotion",!1);a(this,"keepAnimatorControllerStateOnDisable",!1);a(this,"_parametersAreDirty",!1);a(this,"_isDirty",!1);a(this,"_speed",1);a(this,"_normalizedStartOffset",0);a(this,"_animatorController",null);a(this,"_initializeWithRuntimeAnimatorController")}get isAnimationComponent(){return!0}set runtimeAnimatorController(e){var i;this._animatorController&&this._animatorController.model===e||(e?e instanceof hs?(e.animator&&e.animator!==this&&(console.warn("AnimatorController can not be bound to multiple animators",(i=e.model)==null?void 0:i.name),e.model||console.error("AnimatorController has no model"),e=new hs(e.model)),this._animatorController=e,this._animatorController.bind(this)):(En&&console.log("Assign animator controller",e,this),this._animatorController=new hs(e),this.__didAwake&&this._animatorController.bind(this)):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}getCurrentStateInfo(){var e;return(e=this.runtimeAnimatorController)==null?void 0:e.getCurrentStateInfo()}get currentAction(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.currentAction)||null}get parametersAreDirty(){return this._parametersAreDirty}get isDirty(){return this._isDirty}Play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){this.play(e,i,n,o)}play(e,i=-1,n=Number.NEGATIVE_INFINITY,o=0){var r;(r=this.runtimeAnimatorController)==null||r.play(e,i,n,o),this._isDirty=!0}Reset(){this.reset()}reset(){var e;(e=this._animatorController)==null||e.reset(),this._isDirty=!0}SetBool(e,i){this.setBool(e,i)}setBool(e,i){var n,o;En&&console.log("setBool",e,i),((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))!==i&&(this._parametersAreDirty=!0),(o=this.runtimeAnimatorController)==null||o.setBool(e,i)}GetBool(e){return this.getBool(e)}getBool(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getBool(e))??!1;return En&&console.log("getBool",e,i),i}toggleBool(e){this.setBool(e,!this.getBool(e))}SetFloat(e,i){this.setFloat(e,i)}setFloat(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))!==i&&(this._parametersAreDirty=!0),En&&console.log("setFloat",e,i),(o=this.runtimeAnimatorController)==null||o.setFloat(e,i)}GetFloat(e){return this.getFloat(e)}getFloat(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getFloat(e))??-1;return En&&console.log("getFloat",e,i),i}SetInteger(e,i){this.setInteger(e,i)}setInteger(e,i){var n,o;((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))!==i&&(this._parametersAreDirty=!0),En&&console.log("setInteger",e,i),(o=this.runtimeAnimatorController)==null||o.setInteger(e,i)}GetInteger(e){return this.getInteger(e)}getInteger(e){var n;const i=((n=this.runtimeAnimatorController)==null?void 0:n.getInteger(e))??-1;return En&&console.log("getInteger",e,i),i}SetTrigger(e){this.setTrigger(e)}setTrigger(e){var i;this._parametersAreDirty=!0,En&&console.log("setTrigger",e),(i=this.runtimeAnimatorController)==null||i.setTrigger(e)}ResetTrigger(e){this.resetTrigger(e)}resetTrigger(e){var i;this._parametersAreDirty=!0,En&&console.log("resetTrigger",e),(i=this.runtimeAnimatorController)==null||i.resetTrigger(e)}GetTrigger(e){this.getTrigger(e)}getTrigger(e){var n;const i=(n=this.runtimeAnimatorController)==null?void 0:n.getTrigger(e);return En&&console.log("getTrigger",e,i),i}IsInTransition(){return this.isInTransition()}isInTransition(){var e;return((e=this.runtimeAnimatorController)==null?void 0:e.isInTransition())??!1}SetSpeed(e){return this.setSpeed(e)}setSpeed(e){var i;e!==this._speed&&(En&&console.log("setSpeed",e),this._speed=e,((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(e))}set minMaxSpeed(e){var i;this._speed=N.lerp(e.x,e.y,Math.random()),((i=this._animatorController)==null?void 0:i.animator)==this&&this._animatorController.setSpeed(this._speed)}set minMaxOffsetNormalized(e){var i;this._normalizedStartOffset=N.lerp(e.x,e.y,Math.random()),((i=this.runtimeAnimatorController)==null?void 0:i.animator)==this&&(this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset)}awake(){En&&console.log("ANIMATOR",this.name,this),this.gameObject&&this.initializeRuntimeAnimatorController()}initializeRuntimeAnimatorController(e=!1){const i=e||this.runtimeAnimatorController!==this._initializeWithRuntimeAnimatorController;if(this.runtimeAnimatorController&&i){const n=this.runtimeAnimatorController.clone();this._initializeWithRuntimeAnimatorController=n,n?(console.assert(this.runtimeAnimatorController!==n),this.runtimeAnimatorController=n,console.assert(this.runtimeAnimatorController===n),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.setSpeed(this._speed),this.runtimeAnimatorController.normalizedStartOffset=this._normalizedStartOffset):console.warn("Could not clone animator controller",this.runtimeAnimatorController)}}onDisable(){var e;this.keepAnimatorControllerStateOnDisable||(e=this._animatorController)==null||e.reset()}onBeforeRender(){this._isDirty=!1,this._parametersAreDirty=!1,!SA(this.gameObject)&&this._animatorController&&this._animatorController.update(1)}}pm([m()],ii.prototype,"applyRootMotion",void 0);pm([m()],ii.prototype,"hasRootMotion",void 0);pm([m()],ii.prototype,"keepAnimatorControllerStateOnDisable",void 0);pm([m()],ii.prototype,"runtimeAnimatorController",null);const Rx=Symbol("previous-visibility"),Zl=class extends io{render(t,e,i){if("addPass"in i)this._unsupported_effectcomposer_warning||(console.warn("RenderTexture.render() does not yet support EffectComposer"),this._unsupported_effectcomposer_warning=!0);else if(i instanceof ol){this.onBeforeRender();const o=i.getRenderTarget(),r=i.xr.enabled;i.xr.enabled=!1,i.setRenderTarget(this),i.clear(!0,!0,!0),i.render(t,e),i.setRenderTarget(o),i.xr.enabled=r,this.onAfterRender()}}onBeforeRender(){Zl._userSet.clear();const t=RC(this.texture,!0,null,Zl._userSet);for(const e of t)e instanceof X&&(e[Rx]=e.visible,e.visible=!1)}onAfterRender(){for(const t of Zl._userSet)t instanceof X&&(t.visible=t[Rx]);Zl._userSet.clear()}};let qa=Zl;a(qa,"_userSet",new Set);var ru=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const qu=S("debuggroundprojection");class ir extends j{constructor(){super(...arguments);a(this,"applyOnAwake",!1);a(this,"autoFit",!0);a(this,"_radius",50);a(this,"_height",3);a(this,"_arblending",0);a(this,"_lastBackground");a(this,"_lastRadius");a(this,"_lastHeight");a(this,"_projection");a(this,"_watcher");a(this,"_needsTextureUpdate",!1);a(this,"_blurrynessShader",null);a(this,"_lastBlurriness",-1)}set radius(e){this._radius=e,this._projection&&this.updateProjection()}get radius(){return this._radius}set height(e){this._height=e,this._projection&&this.updateProjection()}get height(){return this._height}set arBlending(e){this._arblending=e,this._needsTextureUpdate=!0}get arBlending(){return this._arblending}awake(){this.applyOnAwake&&this.updateAndCreate()}onEnable(){this.context.time.frameCount>0&&this.applyOnAwake&&this.updateAndCreate(),this._watcher||(this._watcher=new Lr(this.context.scene,"background"),this._watcher.subscribeWrite(e=>{qu&&console.log("Background changed",this.context.scene.background),this._needsTextureUpdate=!0}))}onDisable(){var e,i;(e=this._watcher)==null||e.revoke(),(i=this._projection)==null||i.removeFromParent()}onEnterXR(){this.activeAndEnabled&&(this._needsTextureUpdate=!0,this.updateProjection())}async onLeaveXR(){this.activeAndEnabled&&(await Jp(1),this.updateProjection())}onBeforeRender(){this._projection&&this.scene.backgroundRotation&&this._projection.rotation.copy(this.scene.backgroundRotation),this.context.scene.backgroundBlurriness!==void 0&&this._lastBlurriness!=this.context.scene.backgroundBlurriness&&this.context.scene.backgroundBlurriness>.001?this.updateProjection():this._needsTextureUpdate&&this.context.scene.background instanceof Ke&&this.updateBlurriness(this.context.scene.background,this.context.scene.backgroundBlurriness)}updateAndCreate(){var e;this.updateProjection(),(e=this._watcher)==null||e.apply()}updateProjection(){var r,l,c,h,d,u;if(!this.context.scene.background){(r=this._projection)==null||r.removeFromParent();return}const e=this.context.scene.background;if(!(e instanceof Ke)){(l=this._projection)==null||l.removeFromParent();return}if(((c=this.context.xr)!=null&&c.isPassThrough||(h=this.context.xr)!=null&&h.isAR)&&this.arBlending===0){(d=this._projection)==null||d.removeFromParent();return}if(!this.gameObject||this.destroyed)return;let i=!0;const n=0,o=e!==this._lastBackground||this._height!==this._lastHeight||this._radius!==this._lastRadius;if(!this._projection||o){qu&&console.log("Create/Update Ground Projection",e.name),(u=this._projection)==null||u.removeFromParent();try{this._projection=new Sc(e,this._height,this._radius,64)}catch(f){console.error("Error creating three GroundProjection",f);return}this._projection.position.y=this._height-n,this._projection.name="GroundProjection",pS(this._projection,!1)}else i=!1;if(this._projection.parent||this.gameObject.add(this._projection),this.autoFit&&i){this._projection.updateWorldMatrix(!0,!0);const f=Qi(this.context.scene.children,[this._projection]),p=f.min.y;if(p<1/0){const g=q();g.x=f.min.x+(f.max.x-f.min.x)*.5;const _=_t(this.gameObject).x;g.y=p+this._height*_-n,g.z=f.min.z+(f.max.z-f.min.z)*.5,ei(this._projection,g)}qu&&G.DrawWireBox3(f,65280,5)}this.context.scene.backgroundBlurriness>.001&&this._needsTextureUpdate&&this.updateBlurriness(e,this.context.scene.backgroundBlurriness),this._lastBackground=e,this._lastHeight=this._height,this._lastRadius=this._radius,this._needsTextureUpdate=!1}updateBlurriness(e,i){var o;if(this._projection){if(!e)return}else return;this._needsTextureUpdate=!1,qu&&console.log("Update Blurriness",i),this._blurrynessShader??(this._blurrynessShader=new to({name:"GroundProjectionBlurriness",uniforms:{map:{value:e},blurriness:{value:i},blending:{value:0},alphaFactor:{value:1}},vertexShader:TA,fragmentShader:OA})),this._blurrynessShader.depthWrite=!1,this._blurrynessShader.uniforms.map.value=e,this._blurrynessShader.uniforms.blurriness.value=i,this._lastBlurriness=i,e.needsUpdate=!0;const n=this._projection.material.transparent;this._projection.material.transparent=(((o=this.context.xr)==null?void 0:o.isAR)===!0&&this.arBlending>1e-6)??!1,this._projection.material.transparent?this._blurrynessShader.uniforms.blending.value=this.arBlending:this._blurrynessShader.uniforms.blending.value=0,this.context.isInPassThrough?this._blurrynessShader.uniforms.alphaFactor.value=.95:this._blurrynessShader.uniforms.alphaFactor.value=1,n!==this._projection.material.transparent&&(this._projection.material.needsUpdate=!0),this._projection.material.map=cn.copyTexture(e,this._blurrynessShader),this._projection.material.depthTest=!0,this._projection.material.depthWrite=!1}}ru([m()],ir.prototype,"applyOnAwake",void 0);ru([m()],ir.prototype,"autoFit",void 0);ru([m()],ir.prototype,"radius",null);ru([m()],ir.prototype,"height",null);ru([m()],ir.prototype,"arBlending",null);const TA=`
  varying vec2 vUv;

  void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,OA=`
  uniform sampler2D map;
  uniform float blurriness;
  uniform float alphaFactor;
  uniform float blending;
  varying vec2 vUv;

  const float PI = 3.14159265359;

  // Gaussian function
  float gaussian(float x, float sigma) {
    return exp(-(x * x) / (2.0 * sigma * sigma)) / (sqrt(2.0 * PI) * sigma);
  }

  // Custom smoothstep function for desired falloff
  float customSmoothstep(float edge0, float edge1, float x) {
    float t = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);
    return t * t * (3.0 - 2.0 * t);
  }

  void main() {
    vec2 center = vec2(0.0, 0.0);
    vec2 pos = vUv;
    pos.x = 0.0; // Only consider vertical distance
    float distance = length(pos - center);
    
    // Calculate blur amount based on custom falloff
    float blurAmount = customSmoothstep(0.5, 1.0, distance * 2.0);
    blurAmount = clamp(blurAmount, 0.0, 1.0); // Ensure blur amount is within valid range

    // Gaussian blur
    vec2 pixelSize = 1.0 / vec2(textureSize(map, 0));
    vec4 color = vec4(0.0);
    float totalWeight = 0.0;
    int blurSize = int(60.0 * min(1.0, blurriness) * blurAmount); // Adjust blur size based on distance and blurriness
    float lodLevel = log2(float(blurSize)) * 0.5; // Compute LOD level

    for (int x = -blurSize; x <= blurSize; x++) {
        for (int y = -blurSize; y <= blurSize; y++) {
            vec2 offset = vec2(float(x), float(y)) * pixelSize * blurAmount;
            float weight = gaussian(length(vec2(float(x), float(y))), 1000.0 * blurAmount); // Use a fixed sigma value
            color += textureLod(map, vUv + offset, lodLevel) * weight;
            totalWeight += weight;
        }
    }

    color = totalWeight > 0.0 ? color / totalWeight : texture2D(map, vUv);

    gl_FragColor = color;

    float brightness = dot(gl_FragColor.rgb, vec3(0.299, 0.587, 0.114));
    float stepFactor = blending - brightness * .1;
    gl_FragColor.a = pow(1.0 - blending * customSmoothstep(0.35 * stepFactor, 0.45 * stepFactor, distance), 5.);
    gl_FragColor.a *= alphaFactor;
    // gl_FragColor.rgb = vec3(1.0);

    // #include <tonemapping_fragment>
    // #include <colorspace_fragment>
    
    // Uncomment to visualize blur amount
    // gl_FragColor = vec4(blurAmount, 0.0, 0.0, 1.0);
  }
`;var Ab=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Fc extends j{constructor(){super(...arguments);a(this,"constraintActive",!0);a(this,"locked",!1);a(this,"sources",[])}setConstraintPosition(e){const i=this.sources[0];i&&(i.worldPosition=e)}}Ab([m()],Fc.prototype,"constraintActive",void 0);Ab([m()],Fc.prototype,"locked",void 0);Ab([m(D)],Fc.prototype,"sources",void 0);let Xa=class{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(t,e,i,n){return t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}};class h1{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}position(t){return(t||new Xa).__init(this.bb_pos,this.bb)}rotation(t){return(t||new Xa).__init(this.bb_pos+12,this.bb)}scale(t){return(t||new Xa).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(t,e,i,n,o,r,l,c,h,d){return t.prep(4,36),t.prep(4,12),t.writeFloat32(d),t.writeFloat32(h),t.writeFloat32(c),t.prep(4,12),t.writeFloat32(l),t.writeFloat32(r),t.writeFloat32(o),t.prep(4,12),t.writeFloat32(n),t.writeFloat32(i),t.writeFloat32(e),t.offset()}}class Do{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedTransformModel(t,e){return(e||new Do).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedTransformModel(t,e){return t.setPosition(t.position()+fb),(e||new Do).__init(t.readInt32(t.position())+t.position(),t)}guid(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}fast(){const t=this.bb.__offset(this.bb_pos,6);return t?!!this.bb.readInt8(this.bb_pos+t):!1}transform(t){const e=this.bb.__offset(this.bb_pos,8);return e?(t||new h1).__init(this.bb_pos+e,this.bb):null}dontSave(){const t=this.bb.__offset(this.bb_pos,10);return t?!!this.bb.readInt8(this.bb_pos+t):!1}static startSyncedTransformModel(t){t.startObject(4)}static addGuid(t,e){t.addFieldOffset(0,e,0)}static addFast(t,e){t.addFieldInt8(1,+e,0)}static addTransform(t,e){t.addFieldStruct(2,e,0)}static addDontSave(t,e){t.addFieldInt8(3,+e,0)}static endSyncedTransformModel(t){return t.endObject()}static finishSyncedTransformModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedTransformModelBuffer(t,e){t.finish(e,void 0,!0)}}var F;(function(s){(function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await rs(()=>import("./rapier3d.4fc9302c.js"),[],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n})(s.RAPIER_PHYSICS||(s.RAPIER_PHYSICS={})),function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await rs(()=>import("./postprocessing.1c56ce23.js"),["./postprocessing.1c56ce23.js","./three@0.169.11.js"],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n}(s.POSTPROCESSING||(s.POSTPROCESSING={})),function(t){t.MAYBEMODULE=null;const e=[];function i(){return t.MODULE?Promise.resolve(t.MODULE):new Promise(o=>{e.push(o)})}t.ready=i;async function n(){if(t.MODULE)return t.MODULE;const o=await rs(()=>import("./postprocessing.ao.df4d5005.js"),["./postprocessing.ao.df4d5005.js","./three@0.169.11.js","./three-examples.d0f093e2.js","./postprocessing.1c56ce23.js"],import.meta.url);return t.MODULE=o,t.MAYBEMODULE=o,e.forEach(r=>r(o)),e.length=0,o}t.load=n}(s.POSTPROCESSING_AO||(s.POSTPROCESSING_AO={}))})(F||(F={}));var Ot;(function(s){s[s.Average=0]="Average",s[s.Multiply=1]="Multiply",s[s.Minimum=2]="Minimum",s[s.Maximum=3]="Maximum"})(Ot||(Ot={}));var op;(function(s){s[s.Discrete=0]="Discrete",s[s.Continuous=1]="Continuous"})(op||(op={}));var ht;(function(s){s[s.None=0]="None",s[s.FreezePositionX=2]="FreezePositionX",s[s.FreezePositionY=4]="FreezePositionY",s[s.FreezePositionZ=8]="FreezePositionZ",s[s.FreezePosition=14]="FreezePosition",s[s.FreezeRotationX=16]="FreezeRotationX",s[s.FreezeRotationY=32]="FreezeRotationY",s[s.FreezeRotationZ=64]="FreezeRotationZ",s[s.FreezeRotation=112]="FreezeRotation",s[s.FreezeAll=126]="FreezeAll"})(ht||(ht={}));var $l;(function(s){s[s.None=0]="None",s[s.X=2]="X",s[s.Y=4]="Y",s[s.Z=8]="Z",s[s.All=-1]="All"})($l||($l={}));const vi=function(s,t){return function(e,i,n){kA(e,i,n,s,t)}};function kA(s,t,e,i,n){if(!n&&!i&&!s.onValidate)return;if(e!==void 0){console.error("Invalid usage of validate decorator. Only fields can be validated.",s,t,e),nt("Invalid usage of validate decorator. Only fields can be validated. Property: "+t,Jt.Error);return}let o="";if(typeof t=="string"?o=t:o=t.name,s.__internalAwake){const r=Symbol(o),l=s.__internalAwake;s.__internalAwake=function(){var c;if(!this.onValidate){U()&&console.warn('Usage of @validate decorate detected but there is no onValidate method in your class: "'+((c=s.constructor)==null?void 0:c.name)+'"');return}if(this[r]===void 0){this[r]=this[o];const h=this[o];if(h instanceof le||h instanceof x||h instanceof Ce||h instanceof H){const d=this[o];ob(d,()=>{this.onValidate(o)})}Object.defineProperty(this,o,{set:function(d){var u;if(this[l_]===!0)this[r]=d;else{i==null||i.call(this,d);const f=this[r];this[r]=d,(u=this.onValidate)==null||u.call(this,o,f)}},get:function(){return n==null||n.call(this),this[r]}})}l.call(this)}}}const D3=function(s){return function(t,e,i){let n="";typeof e=="string"?n=e:n=e.name;const o=s.prototype,r=Object.getOwnPropertyDescriptor(o,n);if(!(r!=null&&r.value)){console.warn("Can not apply prefix: type does not have method named",e,s);return}const l=r.value,c=t[n];Object.defineProperty(o,n,{value:function(...h){const d=c==null?void 0:c.call(this,...h);if(d instanceof Promise){d.then(u=>{if(u!==!1)return l.call(this,...h)});return}if(d!==!1)return l.call(this,...h)}})}};var xn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class EA{constructor(t,e){a(this,"positionChanged",!1);a(this,"rotationChanged",!1);a(this,"position");a(this,"quaternion");a(this,"_positionKeys",["x","y","z"]);a(this,"_quaternionKeys",["_x","_y","_z","_w"]);a(this,"mute",!1);a(this,"context");a(this,"obj");a(this,"_positionWatch");a(this,"_rotationWatch");this.context=e,this.obj=t}get isDirty(){return this.positionChanged||this.rotationChanged}reset(t=!1){if(this.positionChanged=!1,this.rotationChanged=!1,this.mute=!1,t){if(this.position)for(const e of this._positionKeys)delete this.position[e];if(this.quaternion)for(const e of this._quaternionKeys)delete this.quaternion[e]}}syncValues(){for(const t of this._positionKeys)this.position[t]=this.obj.position[t];for(const t of this._quaternionKeys)this.quaternion[t]=this.obj.quaternion[t]}applyValues(){if(this.positionChanged&&this.position)for(const t of this._positionKeys){const e=this.position[t];e!==void 0&&(this.obj.position[t]=e)}if(this.rotationChanged&&this.quaternion)for(const t of this._quaternionKeys){const e=this.quaternion[t];e!==void 0&&(this.obj.quaternion[t]=e)}}start(t,e){this.reset(),t&&(this._positionWatch||(this._positionWatch=new Lr(this.obj.position,["x","y","z"])),this._positionWatch.apply(),this.position={},this._positionWatch.subscribeWrite((o,r)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.position[r];Math.abs(l-o)<1e-5||(this.position[r]=o,this.positionChanged=!0)})),e&&(this._rotationWatch||(this._rotationWatch=new Lr(this.obj.quaternion,["_x","_y","_z","_w"])),this._rotationWatch.apply(),this.quaternion={},this._rotationWatch.subscribeWrite((o,r)=>{var c;if((c=this.context.physics.engine)!=null&&c.isUpdating||this.mute)return;const l=this.quaternion[r];Math.abs(l-o)<1e-5||(this.quaternion[r]=o,this.rotationChanged=!0)}));const i=this.obj.matrixWorld.multiplyMatrices.bind(this.obj.matrixWorld),n=new ce;this.obj.matrixWorld.multiplyMatrices=(o,r)=>{var l;return(l=this.context.physics.engine)!=null&&l.isUpdating||this.mute||n.equals(o)||(this.positionChanged=!0,this.rotationChanged=!0,n.copy(o)),i(o,r)}}stop(){var t,e;(t=this._positionWatch)==null||t.revoke(),(e=this._rotationWatch)==null||e.revoke()}}const Md=class extends j{constructor(){super(...arguments);a(this,"autoMass",!0);a(this,"_mass",0);a(this,"useGravity",!0);a(this,"centerOfMass",new x(0,0,0));a(this,"constraints",ht.None);a(this,"isKinematic",!1);a(this,"drag",0);a(this,"angularDrag",1);a(this,"detectCollisions",!0);a(this,"sleepThreshold",.01);a(this,"collisionDetectionMode",op.Discrete);a(this,"_gravityScale",1);a(this,"dominanceGroup",0);a(this,"_propertiesChanged",!1);a(this,"_currentVelocity",new x);a(this,"_smoothedVelocity",new x);a(this,"_smoothedVelocityGetter",new x);a(this,"_lastPosition",new x);a(this,"_watch")}get isRigidbody(){return!0}set mass(e){e!==this._mass&&(this._mass=e,this._propertiesChanged=!0,this.__didAwake&&(this.autoMass=!1))}get mass(){var e,i;return this.autoMass?((i=(e=this.context.physics.engine)==null?void 0:e.getBody(this))==null?void 0:i.mass())??-1:this._mass}get lockPositionX(){return(this.constraints&ht.FreezePositionX)!==0}get lockPositionY(){return(this.constraints&ht.FreezePositionY)!==0}get lockPositionZ(){return(this.constraints&ht.FreezePositionZ)!==0}get lockRotationX(){return(this.constraints&ht.FreezeRotationX)!==0}get lockRotationY(){return(this.constraints&ht.FreezeRotationY)!==0}get lockRotationZ(){return(this.constraints&ht.FreezeRotationZ)!==0}set lockPositionX(e){e?this.constraints|=ht.FreezePositionX:this.constraints&=~ht.FreezePositionX}set lockPositionY(e){e?this.constraints|=ht.FreezePositionY:this.constraints&=~ht.FreezePositionY}set lockPositionZ(e){e?this.constraints|=ht.FreezePositionZ:this.constraints&=~ht.FreezePositionZ}set lockRotationX(e){e?this.constraints|=ht.FreezeRotationX:this.constraints&=~ht.FreezeRotationX}set lockRotationY(e){e?this.constraints|=ht.FreezeRotationY:this.constraints&=~ht.FreezeRotationY}set lockRotationZ(e){e?this.constraints|=ht.FreezeRotationZ:this.constraints&=~ht.FreezeRotationZ}set gravityScale(e){this._gravityScale=e}get gravityScale(){return this._gravityScale}awake(){this._watch=void 0,this._propertiesChanged=!1}onEnable(){this._watch||(this._watch=new EA(this.gameObject,this.context)),this._watch.start(!0,!0),this.startCoroutine(this.beforePhysics(),oe.LateUpdate),U()&&(globalThis.true?F.RAPIER_PHYSICS.ready().then(async()=>{var e;await Jp(3),(e=this.context.physics.engine)!=null&&e.getBody(this)||console.warn(`Rigidbody could not be created. Ensure "${this.name}" has a Collider component.`)}):console.warn("Rigidbody could not be created: Rapier physics are explicitly disabled."))}onDisable(){var e,i;(e=this._watch)==null||e.stop(),(i=this.context.physics.engine)==null||i.removeBody(this)}onDestroy(){var e;(e=this.context.physics.engine)==null||e.removeBody(this)}onValidate(){this._propertiesChanged=!0}*beforePhysics(){var e,i,n,o;for(;;)this._propertiesChanged&&(this._propertiesChanged=!1,(e=this.context.physics.engine)==null||e.updateProperties(this)),(i=this._watch)!=null&&i.isDirty?(this._watch.mute=!0,this._watch.applyValues(),(n=this.context.physics.engine)==null||n.updateBody(this,this._watch.positionChanged,this._watch.rotationChanged),this._watch.reset()):(o=this._watch)==null||o.syncValues(),this.captureVelocity(),yield}teleport(e,i=!0){var n;(n=this._watch)==null||n.reset(!0),i?this.gameObject.position.set(e.x,e.y,e.z):this.setWorldPosition(e.x,e.y,e.z),this.resetForcesAndTorques(),this.resetVelocities()}resetForces(e=!0){var i;(i=this.context.physics.engine)==null||i.resetForces(this,e)}resetTorques(e=!0){var i;(i=this.context.physics.engine)==null||i.resetTorques(this,e)}resetVelocities(){this.setVelocity(0,0,0),this.setAngularVelocity(0,0,0)}resetForcesAndTorques(){this.resetForces(),this.resetTorques()}wakeUp(){var e;(e=this.context.physics.engine)==null||e.wakeup(this)}get isSleeping(){var e;return(e=this.context.physics.engine)==null?void 0:e.isSleeping(this)}updateProperties(){var e;return this._propertiesChanged=!1,(e=this.context.physics.engine)==null?void 0:e.updateProperties(this)}applyForce(e,i,n=!0){var o;this._propertiesChanged&&this.updateProperties(),(o=this.context.physics.engine)==null||o.addForce(this,e,n)}applyImpulse(e,i=!0){var n;this._propertiesChanged&&this.updateProperties(),(n=this.context.physics.engine)==null||n.applyImpulse(this,e,i)}setForce(e,i,n,o=!0){var r,l,c;(r=this.context.physics.engine)==null||r.resetForces(this,o),typeof e=="number"?(i??(i=0),n??(n=0),(l=this.context.physics.engine)==null||l.addForce(this,{x:e,y:i,z:n},o)):(c=this.context.physics.engine)==null||c.addForce(this,e,o)}getVelocity(){var i;const e=(i=this.context.physics.engine)==null?void 0:i.getLinearVelocity(this);return e?(this._currentVelocity.x=e.x,this._currentVelocity.y=e.y,this._currentVelocity.z=e.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setVelocity(e,i,n,o=!0){var r,l;if(e instanceof x){const c=e;(r=this.context.physics.engine)==null||r.setLinearVelocity(this,c,o);return}i===void 0||n===void 0||(l=this.context.physics.engine)==null||l.setLinearVelocity(this,{x:e,y:i,z:n},o)}getAngularVelocity(){var i;const e=(i=this.context.physics.engine)==null?void 0:i.getAngularVelocity(this);return e?(this._currentVelocity.x=e.x,this._currentVelocity.y=e.y,this._currentVelocity.z=e.z,this._currentVelocity):this._currentVelocity.set(0,0,0)}setAngularVelocity(e,i,n,o=!0){var r,l;if(typeof e=="object"){const c=e;(r=this.context.physics.engine)==null||r.setAngularVelocity(this,c,o);return}if(i===void 0||n===void 0||typeof i=="boolean"){console.warn("setAngularVelocity expects either a Vec3 or 3 numbers");return}(l=this.context.physics.engine)==null||l.setAngularVelocity(this,{x:e,y:i,z:n},o)}setTorque(e,i,n){typeof e=="number"?this.setAngularVelocity(e,i,n):this.setAngularVelocity(e)}get smoothedVelocity(){return this._smoothedVelocityGetter.copy(this._smoothedVelocity),this._smoothedVelocityGetter.multiplyScalar(1/this.context.time.deltaTime)}setBodyFromGameObject(e=null){}captureVelocity(){const e=this.gameObject.matrixWorld;Md.tempPosition.setFromMatrixPosition(e);const i=Md.tempPosition.sub(this._lastPosition);this._lastPosition.copy(Md.tempPosition),this._smoothedVelocity.lerp(i,this.context.time.deltaTime/.1)}};let xe=Md;a(xe,"tempPosition",new x);xn([vi()],xe.prototype,"autoMass",void 0);xn([m()],xe.prototype,"mass",null);xn([vi(),m()],xe.prototype,"useGravity",void 0);xn([m(x)],xe.prototype,"centerOfMass",void 0);xn([vi(),m()],xe.prototype,"constraints",void 0);xn([vi(),m()],xe.prototype,"isKinematic",void 0);xn([vi(),m()],xe.prototype,"drag",void 0);xn([vi(),m()],xe.prototype,"angularDrag",void 0);xn([vi(),m()],xe.prototype,"detectCollisions",void 0);xn([vi(),m()],xe.prototype,"sleepThreshold",void 0);xn([vi(),m()],xe.prototype,"collisionDetectionMode",void 0);xn([vi()],xe.prototype,"_gravityScale",void 0);xn([vi()],xe.prototype,"dominanceGroup",void 0);new x;new x;const yr=S("debugsync"),Xd="STRS";ES(Xd,Do.getRootAsSyncedTransformModel);const Ss=new eu;function d1(s,t,e=!0){Ss.clear();const i=Ss.createString(s);Do.startSyncedTransformModel(Ss),Do.addGuid(Ss,i),Do.addFast(Ss,e);const n=t.worldPosition,o=t.worldEuler,r=t.gameObject.scale;Do.addTransform(Ss,h1.createTransform(Ss,n.x,n.y,n.z,o.x,o.y,o.z,r.x,r.y,r.z));const l=Do.endSyncedTransformModel(Ss);return Ss.finish(l,Xd),Ss.asUint8Array()}let y_=0,rd=0;r1(s=>{var i;const e=((i=s.connection.currentServerUrl)==null?void 0:i.includes("glitch"))?10:40;rd=Math.floor(y_/e),y_=0,yr&&rd>0&&console.log("Sync Transform Fast Interval",rd)});class oo extends j{constructor(){super(...arguments);a(this,"overridePhysics",!0);a(this,"interpolatePosition",!0);a(this,"interpolateRotation",!0);a(this,"fastMode",!1);a(this,"syncDestroy",!1);a(this,"_model",null);a(this,"_needsUpdate",!0);a(this,"rb",null);a(this,"_wasKinematic",!1);a(this,"_receivedDataBefore",!1);a(this,"_targetPosition");a(this,"_targetRotation");a(this,"_receivedFastUpdate",!1);a(this,"_shouldRequestOwnership",!1);a(this,"joinedRoomCallback",null);a(this,"receivedDataCallback",null);a(this,"tempEuler",new Ct);a(this,"receivedUpdate",!1);a(this,"lastPosition");a(this,"lastRotation");a(this,"lastScale")}requestOwnership(){yr&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}freeOwnership(){var e;(e=this._model)==null||e.freeOwnership()}hasOwnership(){var e;return((e=this._model)==null?void 0:e.hasOwnership)??void 0}isOwned(){var e;return(e=this._model)==null?void 0:e.isOwned}awake(){yr&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new x,this._targetRotation=new H,this.lastPosition=new x,this.lastRotation=new H,this.lastScale=new x,this.rb=C.getComponentInChildren(this.gameObject,xe),this.rb&&(this._wasKinematic=this.rb.isKinematic),this.receivedUpdate=!0,this._model=new vC(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(se.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinary(Xd,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&AC(this.guid,this.context.connection),this._model=null,this.context.connection.stopListen(se.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(Xd,this.receivedDataCallback)}tryGetLastState(){const e=this.context.connection.tryGetState(this.guid);e&&this.onReceivedData(e)}onReceivedData(e){var i;if(!this.destroyed&&typeof e.guid=="function"&&e.guid()===this.guid){yr&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,e),this.receivedUpdate=!0,this._receivedFastUpdate=e.fast();const n=e.transform();if(n){cs.markDirty(this.gameObject,!0);const o=n.position();o&&(this.interpolatePosition&&((i=this._targetPosition)==null||i.set(o.x(),o.y(),o.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(o.x(),o.y(),o.z()));const r=n.rotation();r&&(this.tempEuler.set(r.x(),r.y(),r.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&fS(this.gameObject,this.tempEuler));const l=n.scale();l&&this.gameObject.scale.set(l.x(),l.y(),l.z())}this._receivedDataBefore=!0}}onEnable(){this.lastPosition.copy(this.worldPosition),this.lastRotation.copy(this.worldQuaternion),this.lastScale.copy(this.gameObject.scale),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){yr&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());const e=this.worldPosition,i=this.worldQuaternion,n=this.gameObject.scale;if(this._model.isOwned&&!this.receivedUpdate){const l=this._model.hasOwnership||this.fastMode?1e-4:.001;(e.distanceTo(this.lastPosition)>l||i.angleTo(this.lastRotation)>l||n.distanceTo(this.lastScale)>l)&&(this._model.hasOwnership?this._needsUpdate=!0:(yr&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastPosition),this.worldPosition=this.lastPosition,e.copy(this.lastPosition),this.worldQuaternion=this.lastRotation,i.copy(this.lastRotation),this.gameObject.scale.copy(this.lastScale),cs.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&cs.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastPosition.copy(e),this.lastRotation.copy(i),this.lastScale.copy(n),!this._model||!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership)return;this.rb&&this.overridePhysics&&this._wasKinematic!==void 0&&(yr&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.isKinematic=this._wasKinematic);const o=10,r=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%o===0||r)){if(y_++,r&&rd>0&&this.context.time.frameCount%rd!==0)return;yr&&console.debug("[SyncedTransform] Send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this._needsUpdate=!1;const l=d1(this.guid,this,!!r);this.context.connection.sendBinary(l)}}}class mm{constructor(t,e){a(this,"event");a(this,"button");a(this,"buttonName");a(this,"_used",!1);a(this,"_propagationStopped",!1);a(this,"z__pointer_ctured",!1);a(this,"z__pointer_cture_rleased",!1);a(this,"inputSource");a(this,"object");a(this,"point");a(this,"normal");a(this,"face");a(this,"distance");a(this,"instanceId");a(this,"intersection");a(this,"isDown");a(this,"isUp");a(this,"isPressed");a(this,"isClick");a(this,"isDoubleClick");a(this,"input");this.event=e,this.input=t,this.button=e.button}get deviceIndex(){return this.event.deviceIndex}get pointerId(){return this.event.pointerId}get pressure(){return this.event.pressure}get used(){return this._used}use(){this._used||(this._used=!0,this.event.use())}get propagationStopped(){return this._propagationStopped}stopPropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}stopImmediatePropagation(){this._propagationStopped=!0,this.event.stopImmediatePropagation()}setPointerCapture(){this.z__pointer_ctured=!0}releasePointerCapture(){this.z__pointer_cture_rleased=!0}get mode(){return this.event.mode}clone(){const t=new mm(this.input,this.event);return Object.assign(t,this),t}Use(){this.use()}StopPropagation(){this.event.stopImmediatePropagation()}}function __(s,t){return C.foreachComponent(s,i=>{if(!i.enabled)return;const n=i;if(t)switch(t){case"pointerdown":if(n.onPointerDown)return!0;break;case"pointerup":if(n.onPointerUp||n.onPointerClick)return!0;break;case"pointermove":if(n.onPointerEnter||n.onPointerExit||n.onPointerMove)return!0;break}else if(n.onPointerDown||n.onPointerUp||n.onPointerEnter||n.onPointerExit||n.onPointerClick)return!0},!1)===!0}const vo=new Array;class Cr{constructor(t,e,i,n){a(this,"enabled",!0);a(this,"target");a(this,"methodName");a(this,"arguments");this.target=t,this.methodName=e||null,this.arguments=i,n!=null&&(this.enabled=n)}get canClone(){return this.target instanceof Object}invoke(...t){if(this.enabled!==!1){if(typeof this.target=="function")this.arguments?(vo.length=0,t!==void 0&&t.length>0&&vo.push(...t),vo.push(...this.arguments),this.target(...this.arguments),vo.length=0):this.target(...t);else if(this.methodName!=null){const e=this.target[this.methodName];typeof e=="function"?this.arguments?(vo.length=0,t!==void 0&&t.length>0&&vo.push(...t),vo.push(...this.arguments),e.call(this.target,...vo),vo.length=0):e.call(this.target,...t):this.arguments?this.target[this.methodName]=this.arguments[0]||t[0]:this.target[this.methodName]=t[0]}}}}const MA=s=>/^[A-Z]*$/.test(s);class Ib extends Event{constructor(){super(...arguments);a(this,"args")}}class we{constructor(t){a(this,"isEventList",!0);a(this,"target");a(this,"key");a(this,"_isInvoking",!1);a(this,"methods",[]);a(this,"_methodsCopy",[]);if(this.methods=[],Array.isArray(t))for(const e of t)e instanceof Cr?this.methods.push(e):typeof e=="function"&&this.methods.push(new Cr(e));else typeof t=="function"&&this.methods.push(new Cr(t))}__internalOnInstantiate(t){var n;const e=new Array;for(let o=0;o<this.methods.length;o++){const r=this.methods[o];if(!(r.target instanceof Function)){const l=r.target;let c=l==null?void 0:l.uuid;if(l&&(c=l.guid),c){const h=t[c];if(h){const d=(n=r.arguments)==null?void 0:n.map(u=>u instanceof Object&&u.uuid?t[u.uuid]:u!=null&&u.isComponent?t[u.guid]:u);e.push(new Cr(h.clone,r.methodName,d,r.enabled))}else U()&&console.warn("Could not find target for event listener")}}}return new we(e)}setEventTarget(t,e){if(this.key=t,this.target=e,this.key!==void 0){let i="",n=!1;for(const o of this.key)n&&MA(o)&&(i+="-"),n=!0,i+=o.toLowerCase();this.key=i}}get listenerCount(){var t;return((t=this.methods)==null?void 0:t.length)??0}get isInvoking(){return this._isInvoking}static from(...t){return new we(t)}invoke(...t){var e;if(this._isInvoking)return console.warn("Circular event invocation detected. Please check your event listeners for circular references.",this),!1;if(((e=this.methods)==null?void 0:e.length)<=0)return!1;this._isInvoking=!0;try{this._methodsCopy.length=0,this._methodsCopy.push(...this.methods);for(const i of this._methodsCopy)i.invoke(...t);if(typeof this.target=="object"&&typeof this.key=="string"){const i=this.target.dispatchEvent;if(typeof i=="function"){const n=new Ib(this.key);n.args=t,i.call(this.target,n)}}}finally{this._isInvoking=!1,this._methodsCopy.length=0}return!0}addEventListener(t){return this.methods.push(new Cr(t)),t}removeEventListener(t){if(t)for(let e=this.methods.length-1;e>=0;e--)this.methods[e].target===t&&(this.methods[e].enabled=!1,this.methods.splice(e,1))}removeAllEventListeners(){this.methods.length=0}}class AA extends Gn{constructor(){super([de,pe],"ColorSerializer")}onDeserialize(t){if(t!=null)return t.a!==void 0?new pe(t.r,t.g,t.b,t.a):t.alpha!==void 0?new pe(t.r,t.g,t.b,t.alpha):new de(t.r,t.g,t.b)}onSerialize(t){if(t!=null)return t.a!==void 0?{r:t.r,g:t.g,b:t.b,a:t.a}:{r:t.r,g:t.g,b:t.b}}}const L3=new AA;class IA extends Gn{constructor(){super([Ct],"EulerSerializer")}onDeserialize(t,e){if(t!=null){if(t.order)return new Ct(t.x,t.y,t.z,t.order);if(t.x!=null)return new Ct(t.x,t.y,t.z)}}onSerialize(t,e){return{x:t.x,y:t.y,z:t.z,order:t.order}}}const j3=new IA;class DA extends Gn{constructor(){super(D,"ObjectSerializer")}onSerialize(t,e){if(e.objectToNode!==void 0&&t.uuid){const i=e.objectToNode[t.uuid];return Dt&&console.log(i,t.name,t.uuid),{node:i}}}onDeserialize(t,e){var i,n,o;if(typeof t=="string"){if(t.endsWith(".glb")||t.endsWith(".gltf")){if(e.serializable instanceof Array&&e.serializable.includes(he))return;U()&&ke("Detected wrong usage of @serializable with Object3D or GameObject. Instead you should use AssetReference here! Please see the console for details.");const r=(n=(i=e.target)==null?void 0:i.constructor)==null?void 0:n.name;console.warn(`Wrong usage of @serializable detected in your script "${r}"

It looks like you used @serializable(Object3D) or @serializable(GameObject) for a prefab or scene reference which is exported to a separate glTF file.

To fix this please change your code to:

@serializable(AssetReference)
${e.path}! : AssetReference;
\0`)}return}if(t){if(t.node!==void 0&&e.nodeToObject){const r=e.nodeToObject[t.node];return Dt&&console.log("Deserialized object reference?",t,r,e==null?void 0:e.nodeToObject),r||console.warn("Did not find node: "+t.node,e.nodeToObject,e.object),r}else if(t.guid){if(!e.context){console.error("Missing context");return}let r;const l=(o=e.gltf)==null?void 0:o.scene;return l&&(r=C.findByGuid(t.guid,l)),r||(r=C.findByGuid(t.guid,e.context.scene)),r?(r&&r.isComponent===!0&&(Dt&&console.warn("Deserialized object reference is a component"),r=r.gameObject),Dt&&console.log("Deserialized object reference?",t,r,e==null?void 0:e.nodeToObject)):((U()||Dt)&&console.warn("Could not resolve object reference",e.path,t,e.target,e.context.scene),t.could_not_resolve=!0),r}}}}const LA=new DA;class jA extends Gn{constructor(){super([j,j],"ComponentSerializer")}onSerialize(t,e){if(t!=null&&t.guid)return{guid:t.guid}}onDeserialize(t,e){var i;if(t!=null&&t.guid){if(t.___persistentAsset){Dt&&console.log("Skipping component deserialization because it's a persistent asset",t);return}const n=e.path;Dt&&console.log(t.guid,e.root,e.object,e.target);let o=this.findObjectForGuid(t.guid,e.root);if(o||e.context&&(o=this.findObjectForGuid(t.guid,(i=e.context)==null?void 0:i.scene),o))return o;(U()||Dt)&&console.warn('Could not resolve component reference: "'+n+'" using guid '+t.guid,e.target),t.could_not_resolve=!0;return}}findObjectForGuid(t,e){if(e.guid===t)return e;const i=C.foreachComponent(e,n=>{if(n.guid===t)return n},!1);if(i!==void 0)return i;for(let n=0;n<e.children.length;n++){const o=e.children[n],r=this.findObjectForGuid(t,o);if(r)return r}}}const $g=new jA;class BA extends Gn{constructor(){super([we])}onSerialize(t,e){console.log("TODO: SERIALIZE EVENT")}onDeserialize(t,e){var i,n,o,r;if(typeof t=="function")return new we([new Cr(t,null,[],!0)]);if(t&&t.type==="EventList"){Dt&&console.log("DESERIALIZE EVENT",t);const l=new Array;if(t.calls&&Array.isArray(t.calls))for(const d of t.calls){let p=function(g){if(typeof g=="object"){let _=LA.onDeserialize(g,e);if(_||(_=$g.onDeserialize(g,e)),_)return _}return g};Dt&&console.log(d);let u=$g.findObjectForGuid(d.target,e.root);!u&&((i=e.context)!=null&&i.scene)&&(u=$g.findObjectForGuid(d.target,(n=e.context)==null?void 0:n.scene));const f=((o=d.method)==null?void 0:o.length)>0;if(u&&f){const g=()=>{const y=d.method[0].toUpperCase()+d.method.slice(1);if(typeof u[y]=="function"){console.warn(`EventList method:
Could not find method ${d.method} on object ${u.name}. Please rename ${d.method} to ${y}?
`,u[y],`
 in script: `,u),ke("EventList methods must start with lowercase letter, see console for details");return}else console.warn(`EventList method:
Could not find method ${d.method} on object ${u.name}`,u,typeof u[d.method])};if(typeof u[d.method]!="function"){let y=!1,b=u;for(;b;){const v=Object.getOwnPropertyDescriptor(b,d.method);if(v&&(v.writable===!0||v.set)){y=!0;break}b=Object.getPrototypeOf(b)}!y&&(U()||Dt)&&g()}}if(u){let g=d.argument;if(g!==void 0?g=p(g):d.arguments!==void 0&&(g=d.arguments.map(p)),!u[d.method])console.warn(`EventList method not found: "${d.method}" on ${u==null?void 0:u.name}`);else{g!==void 0&&!Array.isArray(g)&&(g=[g]);const y=new Cr(u,d.method,g,d.enabled);l.push(y)}}else U()&&console.warn(`[Dev] EventList: Could not find event listener in scene (${(r=e.object)==null?void 0:r.name})`,d)}const c=new we(l);Dt&&console.log(c);const h=e.target;return h!==void 0&&e.path!==void 0&&c.setEventTarget(e.path,h),c}}}const B3=new BA,rp=new WeakMap,FA=Ke.prototype.clone;Ke.prototype.clone=function(){const s=FA.call(this);return rp.has(s)||rp.set(s,this),s};class zA extends Gn{constructor(){super([qa,io])}onSerialize(t,e){}onDeserialize(t,e){if(t instanceof Ke&&e.type===qa){let i=t;rp.has(i)&&(i=rp.get(i)),i.isRenderTargetTexture=!0,i.flipY=!0,i.offset.y=1,i.repeat.y=-1,i.needsUpdate=!0,i.mipmaps=[],i instanceof eR&&(i.isCompressedTexture=!1,i.format=Gp);const n=new qa(i.image.width,i.image.height,{colorSpace:Xo});return n.texture=i,n}}}new zA;class UA extends Gn{constructor(){super([URL])}onSerialize(t,e){return null}onDeserialize(t,e){if(typeof t=="string"&&t.length>0)return rl(e.gltfId,t)}}new UA;var NA=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Ic extends j{awake(){Xi.createIfNoneExists(this.context)}onEnable(){var t;(t=Xi.get(this.context))==null||t.register(this)}onDisable(){var t;(t=Xi.get(this.context))==null||t.unregister(this)}}class Vn extends Ic{constructor(){super(...arguments);a(this,"targets",null);a(this,"raycastHits",[]);a(this,"ignoreSkinnedMeshes",!1)}start(){this.targets=[this.gameObject]}performRaycast(e=null){if(!this.targets)return null;e??(e=new Kr),e.targets=this.targets,e.results=this.raycastHits,e.useAcceleratedRaycast=!0;const i=e.testObject;this.ignoreSkinnedMeshes&&(e.testObject=o=>o instanceof Ir?"continue in children":i?i(o):!0);const n=this.context.physics.raycast(e);return e.testObject=i,n}}NA([m()],Vn.prototype,"ignoreSkinnedMeshes",void 0);class Db extends Vn{constructor(){super(),this.ignoreSkinnedMeshes=!0}}const C0=class extends Ic{performRaycast(t){if(!te.active||!C0.allow||!(t!=null&&t.ray))return null;const e=t.ray.origin,i=.015;return this.context.physics.sphereOverlap(e,i,!1,!0)}};let Qa=C0;a(Qa,"allow",!0);class u1{static getObject(t){const e=t[fn];return e&&(e.isComponent===!0?t=e.gameObject:t=e),t}static isInteractable(t,e){if(e&&(e.canvasGroup=void 0,e.graphic=void 0),t==null||!t.visible||(t=this.getObject(t),!t.visible))return!1;const i=this.tryFindCanvasGroup(t);if((i==null?void 0:i.isCanvasGroup)===!0&&(e&&(e.canvasGroup=i),i.blocksRaycasts===!1||i.interactable===!1))return!1;const n=Ec(t,o=>{if(o.isGraphic===!0)return o},!1);return e&&(n==null?void 0:n.isGraphic)===!0&&(e.graphic=n),!((n==null?void 0:n.raycastTarget)===!1||(n==null?void 0:n.layer)===2)}static tryFindCanvasGroup(t){if(!t)return null;const e=Ec(t,i=>{const n=i;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n},!1);return e!==void 0?e:this.tryFindCanvasGroup(t.parent)}}function Lb(s){const t=s[fn];return t||(s.parent?Lb(s.parent):null)}function $A(s){return s.isUI===!0||typeof s[fn]=="object"}function ap(s,t){if(!s)return;const e=s.material;if((e==null?void 0:e.isMaterial)===!0){const i=s.parent;i&&i.isText,e.side=t.doubleSided??!0?vn:Gr,e.shadowSide=t.doubleSided?vn:Gr,s.castShadow=t.castShadows?t.castShadows:!1,s.receiveShadow=t.receiveShadows?t.receiveShadows:!1}for(const i of s.children)ap(i,t)}function Ll(s,t,e){s[t]===void 0&&console.warn("Field",t,"is undefined on",s);const i=Proxy.revocable(s[t],{set(r,l,c,h){const d=r[l],u=Reflect.set(r,l,c,h);return e(c,d),u}}),n=i.revoke,o=s[t];return i.revoke=()=>{s[t]=o,n()},s[t]=i.proxy,i}const Tx=Symbol("Scheduled action");function WA(s,t,e=oe.OnBeforeRender){let i=s[Tx];i||(i=s[Tx]={});const n=t.name;i[e]||(i[e]={});const o=i[e];if(o[n])return;function*l(){t==null||t.call(s),o[n]=null}const c=s.startCoroutine(l(),e);o[n]=c}const _r=S("debugeventsystem");var Dc;(function(s){s.BeforeHandleInput="BeforeHandleInput",s.AfterHandleInput="AfterHandleInput"})(Dc||(Dc={}));o1(s=>{Xi.createIfNoneExists(s)});class Xi extends j{constructor(){super(...arguments);a(this,"raycaster",[]);a(this,"pressedByID",new Map);a(this,"hoveredByID",new Map);a(this,"onPointerEvent",e=>{if(e===void 0||e.propagationStopped||e.defaultPrevented||e.used)return;const i=new mm(this.context.input,e);this._currentPointerEventName=e.type,i.inputSource=this.context.input,i.isClick=e.isClick,i.isDoubleClick=e.isDoubleClick,i.isDown=e.type==_e.PointerDown,i.isUp=e.type==_e.PointerUp,i.isPressed=this.context.input.getPointerPressed(e.pointerId);const n=new Kr;e.hasRay?n.ray=e.ray:n.screenPoint=this.context.input.getPointerPositionRC(e.pointerId),n.allowSlowRaycastFallback=e.isClick||e.isDoubleClick;const o=this.performRaycast(n);if(_r&&(i.isDown?console.log("DOWN",{id:i.pointerId,hits:o.length}):i.isUp&&console.log("UP",{id:i.pointerId,hits:o.length}),i.isClick&&console.log("CLICK",{id:i.pointerId,hits:o.length})),o){for(const l of o)l.event=e,e.intersections.push(l);e.origin.onPointerHits&&e.origin.onPointerHits({sender:this,event:e,hits:o})}_r&&i.isClick&&nt("EventSystem: "+i.pointerId+" - "+this.context.time.frame+" - Up:"+i.isUp+", Down:"+i.isDown);const r={sender:this,args:i,hasActiveUI:this.currentActiveMeshUIComponents.length>0};this.dispatchEvent(new CustomEvent(Dc.BeforeHandleInput,{detail:r})),this.handleIntersections(o,i),this.dispatchEvent(new CustomEvent(Dc.AfterHandleInput,{detail:r}))});a(this,"_sortedHits",[]);a(this,"_testObjectsCache",new Map);a(this,"_currentlyActiveRaycaster",null);a(this,"_currentPointerEventName",null);a(this,"shouldRaycastObject",e=>{var r;const i=e&&"getComponent"in e?e.getComponent(Ic):null;if(i&&i!=this._currentlyActiveRaycaster)return!1;let n=null;if($A(e)&&(n=(r=e[fn])==null?void 0:r.gameObject),this._testObjectsCache.has(e)||n&&this._testObjectsCache.has(n))return this._testObjectsCache.get(e)===!1?"continue in children":!0;{let l=__(e,this._currentPointerEventName);if(!l&&n&&(l=__(n,this._currentPointerEventName)),l){this._testObjectsCache.set(e,!0);for(const c of e.children)this.shouldRaycastObject_AddToYesCache(c);return!0}return this._testObjectsCache.set(e,!1),"continue in children"}});a(this,"_sortingBuffer",[]);a(this,"_noDepthTestingResults",[]);a(this,"out",{});a(this,"_capturedPointer",{});a(this,"pointerEnterSymbol",Symbol("pointerEnter"));a(this,"pointerExitSymbol",Symbol("pointerExit"));a(this,"currentActiveMeshUIComponents",[])}static ensureUpdateMeshUI(e,i,n=!1){Pr.update(e,i,n)}static markUIDirty(e){Pr.markDirty()}static createIfNoneExists(e){e.scene.getComponent(Xi)||e.scene.addComponent(Xi)}static get(e){return this.createIfNoneExists(e),e.scene.getComponent(Xi)}static get instance(){return this.get(ne.Current)}register(e){var i;e&&this.raycaster&&!this.raycaster.includes(e)&&((i=this.raycaster)==null||i.push(e))}unregister(e){var n,o;const i=(n=this.raycaster)==null?void 0:n.indexOf(e);i!==void 0&&i!==-1&&((o=this.raycaster)==null||o.splice(i,1))}get hasActiveUI(){return this.currentActiveMeshUIComponents.length>0}get isHoveringObjects(){return this.hoveredByID.size>0}awake(){this.gameObject!==this.context.scene&&(console.debug(`[Needle Engine] EventSystem is only allowed on the scene root. Disabling EventSystem on '${this.gameObject.name}'`),this.enabled=!1)}start(){this.context.scene.getComponent(Ic)||this.context.scene.addComponent(Vn)}onEnable(){this.context.input.addEventListener(_e.PointerDown,this.onPointerEvent),this.context.input.addEventListener(_e.PointerUp,this.onPointerEvent),this.context.input.addEventListener(_e.PointerMove,this.onPointerEvent)}onDisable(){this.context.input.removeEventListener(_e.PointerDown,this.onPointerEvent),this.context.input.removeEventListener(_e.PointerUp,this.onPointerEvent),this.context.input.removeEventListener(_e.PointerMove,this.onPointerEvent)}onBeforeRender(){this.resetMeshUIStates()}shouldRaycastObject_AddToYesCache(e){this._testObjectsCache.set(e,!0);for(const i of e.children)this.shouldRaycastObject_AddToYesCache(i)}performRaycast(e){if(!this.raycaster)return null;this._testObjectsCache.clear(),this._sortedHits.length=0,e.testObject=this.shouldRaycastObject;for(const i of this.raycaster){if(!i.activeAndEnabled)continue;this._currentlyActiveRaycaster=i;const n=i.performRaycast(e);this._currentlyActiveRaycaster=null,n&&n.length>0&&this._sortedHits.push(...n)}return this._sortedHits.sort((i,n)=>i.distance-n.distance),this._sortedHits}assignHitInformation(e,i){i?(e.intersection=i,e.point=i.point,e.normal=i.normal,e.face=i.face,e.distance=i.distance,e.instanceId=i.instanceId):(e.intersection=void 0,e.point=void 0,e.normal=void 0,e.face=void 0,e.distance=void 0,e.instanceId=void 0)}handleIntersections(e,i){var o;if(e!=null&&e.length){e=this.sortCandidates(e);for(const r of e){if(i.event.immediatePropagationStopped)return!1;if(this.assignHitInformation(i,r),this.handleEventOnObject(r.object,i))return!0}}this.assignHitInformation(i,e==null?void 0:e[0]),this.invokePointerCapture(i);const n=this.hoveredByID.get(i.pointerId);return n&&this.propagatePointerExit(n.obj,n.data,null),this.hoveredByID.delete(i.pointerId),i.isUp&&((o=this.pressedByID.get(i.pointerId))==null||o.handlers.forEach(r=>this.invokeOnPointerUp(i,r)),this.pressedByID.delete(i.pointerId)),!1}sortCandidates(e){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let i=0;i<e.length;i++){const n=e[i],o=n.object;if(o.material&&o.material.depthTest===!1){this._noDepthTestingResults.push(n);continue}this._sortingBuffer.push(n)}for(const i of this._sortingBuffer)this._noDepthTestingResults.push(i);return this._noDepthTestingResults}handleEventOnObject(e,i){if(!this.testIsVisible(e))return i.isClick&&_r&&console.log("not allowed",e),!1;if(i.pointerId===void 0)return _r&&console.error("Event without pointer can't be handled",i),!1;i.object=e;const n=e.parent,o=i.isClick??!1;let r=null;if(n&&n.isUI){const u=(i.isPressed||i.isClick)??!1;if(n[fn]){const f=n[fn].gameObject;if(f){if(!u1.isInteractable(f,this.out))return!1;r=this.out.canvasGroup??null,this.handleMeshUIIntersection(e,u),e=f}}}o&&_r&&console.log(this.context.time.frame,e);const l=this.hoveredByID.get(i.pointerId),c=l==null?void 0:l.obj;c!==e&&c&&this.propagatePointerExit(c,l.data,e);const d=this.hoveredByID.get(i.pointerId);if(d?(d.obj=e,d.data=i):this.hoveredByID.set(i.pointerId,{obj:e,data:i}),i.isDown){const u=this.pressedByID.get(i.pointerId);u?(u.obj=e,u.data=i):this.pressedByID.set(i.pointerId,{obj:e,data:i,handlers:new Set})}return(r===null||r.interactable)&&this.handleMainInteraction(e,i,c??null),!0}propagate(e,i){for(;e;)C.foreachComponent(e,n=>{i(n)},!1),e=e.parent}handleMainInteraction(e,i,n){const o=this.pressedByID.get(i.pointerId),r=n!==e;let l=!0;switch(i.event.pointerType){case"mouse":case"touch":const c=this.context.input.getPointerPositionLastFrame(i.pointerId),h=this.context.input.getPointerPosition(i.pointerId);l=c&&!N.approximately(c,h);break}this.propagate(e,c=>{var d;const h=c;h.interactable!==!1&&(!h.activeAndEnabled||!h.enabled||(h.onPointerEnter&&r&&this.handlePointerEnter(h,i),i.isDown&&h.onPointerDown&&(h.onPointerDown(i),o==null||o.handlers.add(h),this.handlePointerCapture(i,h)),h.onPointerMove&&(l&&h.onPointerMove(i),this.handlePointerCapture(i,h)),i.isUp&&(h.onPointerUp&&(this.invokeOnPointerUp(i,h),o==null||o.handlers.delete(h)),h.onPointerExit&&((d=i.event)==null?void 0:d.pointerType)===kr.Touch&&(this.handlePointerExit(h,i),this.hoveredByID.delete(i.pointerId))),i.isClick&&h.onPointerClick&&h.onPointerClick(i)))}),i.isUp&&(o==null||o.handlers.forEach(c=>{this.invokeOnPointerUp(i,c)}),this.pressedByID.delete(i.pointerId))}propagatePointerExit(e,i,n){this.propagate(e,o=>{if(!o.gameObject||o.destroyed)return;const r=o;if(r.onPointerExit||r.onPointerEnter){if(n&&this.isChild(n,o.gameObject))return;this.handlePointerExit(r,i)}})}invokeOnPointerUp(e,i){var n;(n=i.onPointerUp)==null||n.call(i,e),this.releasePointerCapture(e,i)}handlePointerEnter(e,i){e.onPointerEnter&&this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!0)&&e.onPointerEnter(i),this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!1)}handlePointerExit(e,i){e.onPointerExit&&this.updatePointerState(e,i.pointerId,this.pointerExitSymbol,!0)&&e.onPointerExit(i),this.updatePointerState(e,i.pointerId,this.pointerEnterSymbol,!1)}updatePointerState(e,i,n,o){let r=e[n];if(o)return r&&r.includes(i)?!1:(r=r||[],r.push(i),e[n]=r,!0);{if(!r||!r.includes(i))return!1;const l=r.indexOf(i);return l!==-1&&r.splice(l,1),!0}}handlePointerCapture(e,i){if(e.z__pointer_ctured){e.z__pointer_ctured=!1;const n=e.pointerId;if(i.onPointerMove){const o=this._capturedPointer[n]||[];o.push(i),this._capturedPointer[n]=o}else U()&&!i.z__warned_no_pointermove&&(i.z__warned_no_pointermove=!0,console.warn("PointerCapture was requested but the component doesn't implement onPointerMove. It will not receive any pointer events"))}else e.z__pointer_cture_rleased&&(e.z__pointer_cture_rleased=!1,this.releasePointerCapture(e,i))}releasePointerCapture(e,i){const n=e.pointerId;if(this._capturedPointer[n]){const o=this._capturedPointer[n].indexOf(i);o!==-1&&(this._capturedPointer[n].splice(o,1),_r&&console.log("released pointer capture",n,i,this._capturedPointer))}}invokePointerCapture(e){var i;if(e.event.type===_e.PointerMove){const n=e.pointerId,o=this._capturedPointer[n];if(o){_r&&console.log("Captured",n,o);for(let r=0;r<o.length;r++){const l=o[r];if(l.destroyed){o.splice(r,1),r--;continue}(i=l.onPointerMove)==null||i.call(l,e)}}}}isChild(e,i){return!e||!i?!1:e===i?!0:e.parent?this.isChild(e.parent,i):!1}handleMeshUiObjectWithoutShadowDom(e,i){return!e||!e.isUI?!0:this.handleMeshUIIntersection(e,i)}handleMeshUIIntersection(e,i){const n=Pr.updateState(e,i);return n&&this.currentActiveMeshUIComponents.push(n),n!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&Pr.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let e=0;e<this.currentActiveMeshUIComponents.length;e++){const i=this.currentActiveMeshUIComponents[e];Pr.resetState(i)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(e){return e?C.isActiveSelf(e)?this.testIsVisible(e.parent):!1:!0}}class Pr{static markDirty(){this.needsUpdate=!0}static update(t,e,i=!1){if(i){t.update();return}const n=e.time.frameCount;for(const o of this.lastUpdateFrame)if(o.context===e){if(n===o.frame)return;o.frame=n;let r=this.needsUpdate||n<1;o.nextUpdate<=n&&(r=!0),r&&(_r&&console.log("Update threemeshui"),this.needsUpdate=!1,o.nextUpdate=n+60,t.update());return}this.lastUpdateFrame=[{context:e,frame:n,nextUpdate:n+60}],t.update(),this.needsUpdate=!1}static updateState(t,e){let i=null;if(t&&(i=this.findBlockOrTextInParent(t),i&&i!==this.lastSelected)){if(i.interactable===!1)return null;this.needsUpdate=!0}return i}static resetLastSelected(){const t=this.lastSelected;t&&(this.lastSelected=null,this.resetState(t))}static resetState(t){t&&(this.needsUpdate=!0)}static findBlockOrTextInParent(t){return t?t.isBlock||t.isText?t:this.findBlockOrTextInParent(t.parent):null}}a(Pr,"lastSelected",null),a(Pr,"lastUpdateFrame",[]),a(Pr,"needsUpdate",!1);var Ze=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Si=S("debugorbit"),Wg=S("freecam"),Sh=S("debugcamerafit"),Xu=S("smoothcam"),VA={LEFT:"",UP:"",RIGHT:"",BOTTOM:""};let Vg;var b_;(function(s){s.CameraTargetReached="target-reached"})(b_||(b_={}));class lp extends CustomEvent{constructor(t,e){super(b_.CameraTargetReached,{detail:{controls:t,type:e}})}}class Ee extends j{constructor(){super(...arguments);a(this,"autoTarget",!0);a(this,"autoFit",!1);a(this,"enableRotate",!0);a(this,"autoRotate",!1);a(this,"autoRotateSpeed",1);a(this,"minAzimuthAngle",1/0);a(this,"maxAzimuthAngle",1/0);a(this,"minPolarAngle",0);a(this,"maxPolarAngle",Math.PI);a(this,"enableKeys",!1);a(this,"enableDamping",!0);a(this,"dampingFactor",.1);a(this,"enableZoom",!0);a(this,"minZoom",0);a(this,"maxZoom",1/0);a(this,"zoomSpeed",1);a(this,"zoomToCursor",!1);a(this,"enablePan",!0);a(this,"lookAtConstraint",null);a(this,"lookAtConstraint01",1);a(this,"allowInterrupt",!0);a(this,"middleClickToFocus",!0);a(this,"doubleClickToFocus",!0);a(this,"clickBackgroundToFitScene",2);a(this,"_targetElement",null);a(this,"debugLog",!1);a(this,"targetLerpDuration",1);a(this,"_controls",null);a(this,"_cameraObject",null);a(this,"_lookTargetLerpActive",!1);a(this,"_lookTargetStartPosition",new x);a(this,"_lookTargetEndPosition",new x);a(this,"_lookTargetLerp01",0);a(this,"_lookTargetLerpDuration",0);a(this,"_cameraLerpActive",!1);a(this,"_cameraStartPosition",new x);a(this,"_cameraEndPosition",new x);a(this,"_cameraLerp01",0);a(this,"_cameraLerpDuration",0);a(this,"_fovLerpActive",!1);a(this,"_fovLerpStartValue",0);a(this,"_fovLerpEndValue",0);a(this,"_fovLerp01",0);a(this,"_fovLerpDuration",0);a(this,"_inputs",0);a(this,"_enableTime",0);a(this,"_startedListeningToKeyEvents",!1);a(this,"_eventSystem");a(this,"_afterHandleInputFn");a(this,"_camera",null);a(this,"_syncedTransform");a(this,"_didSetTarget",0);a(this,"_activePointerEvents");a(this,"_lastTimeClickOnBackground",-1);a(this,"_clickOnBackgroundCount",0);a(this,"_onPointerDown",e=>{this._activePointerEvents.push(e)});a(this,"_onPointerDownLate",e=>{e.used&&this._controls&&(this._controls.enabled=!1)});a(this,"_onPointerUp",e=>{for(let i=this._activePointerEvents.length-1;i>=0;i--){const n=this._activePointerEvents[i];if(n.pointerId===e.pointerId&&n.button===e.button){this._activePointerEvents.splice(i,1);break}}if(this.clickBackgroundToFitScene>0&&e.isClick&&e.button===0){if(e.hasRay||e.intersections.push(...this.context.physics.raycast()),e.intersections.length<=0){const i=this.context.time.time-this._lastTimeClickOnBackground;this._lastTimeClickOnBackground=this.context.time.time,this.clickBackgroundToFitScene<=1||i<this.clickBackgroundToFitScene*.15?(this._clickOnBackgroundCount+=1,this._clickOnBackgroundCount>=this.clickBackgroundToFitScene-1&&this.fitCamera(this.context.scene.children,{immediate:!1})):this._clickOnBackgroundCount=0}Si&&console.log(this.clickBackgroundToFitScene,e.intersections.length,this._clickOnBackgroundCount)}});a(this,"_onPointerUpLate",e=>{this.doubleClickToFocus&&e.isDoubleClick&&!e.used&&this.setTargetFromRaycast()});a(this,"_orbitStartAngle",0);a(this,"_zoomStartDistance",0);a(this,"onControlsChangeStarted",()=>{Si&&console.debug("OrbitControls: Change started"),this._controls&&(this._orbitStartAngle=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle(),this._zoomStartDistance=this._controls.getDistance()),this._syncedTransform&&this._syncedTransform.requestOwnership()});a(this,"onControlsChangeEnded",()=>{if(Si&&console.debug("OrbitControls: Change ended",{autoTarget:this.autoTarget}),this._controls&&this.autoTarget){const i=this._controls.getAzimuthalAngle()+this._controls.getPolarAngle()-this._orbitStartAngle;Math.abs(i)<.01?(Si&&console.debug("OrbitControls: Update target",{deltaAngle:i}),this.updateTargetNow({allowSlowRaycastFallback:!1})):Si&&console.debug("OrbitControls: No target update",{deltaAngle:i})}});a(this,"_shouldDisable",!1);a(this,"__onPreRender",()=>{const e=this.context.pre_render_callbacks.indexOf(this.__onPreRender);e>=0&&this.context.pre_render_callbacks.splice(e,1),this.autoFit&&(this.autoFit=!1,this.fitCamera({centerCamera:"y",immediate:!0,objects:this.scene.children}))});a(this,"_haveAttachedKeyboardEvents",!1)}get isCameraController(){return!0}get controls(){return this._controls}get controllerObject(){return this._cameraObject}onStartInteraction(e){var i;(i=this.controls)==null||i.addEventListener("start",e)}get targetElement(){var e;return((e=this._controls)==null?void 0:e.domElement)??this._targetElement}set targetElement(e){this._targetElement=e,this._controls&&this._controls.domElement!==e&&(this._controls.disconnect(),this._controls.domElement=e,this._controls.connect())}get targetLerpSpeed(){return 5}set targetLerpSpeed(e){this.targetLerpDuration=1/e}rotateLeft(e){var i;(i=this._controls)==null||i._rotateLeft(e)}rotateUp(e){var i;(i=this._controls)==null||i._rotateUp(e)}pan(e,i){var n;(n=this._controls)==null||n._pan(e,i)}zoomIn(e){var i,n;e>0?(i=this._controls)==null||i._dollyIn(1-e):e<0&&((n=this._controls)==null||n._dollyOut(1+e))}awake(){Si&&console.debug("OrbitControls",this),this._didSetTarget=0,this._startedListeningToKeyEvents=!1}start(){this._eventSystem=Xi.get(this.context)??void 0,this._eventSystem&&(this._afterHandleInputFn=this.afterHandleInput.bind(this),this._eventSystem.addEventListener(Dc.AfterHandleInput,this._afterHandleInputFn))}onDestroy(){var e,i;(e=this._controls)==null||e.dispose(),(i=this._eventSystem)==null||i.removeEventListener(Dc.AfterHandleInput,this._afterHandleInputFn)}onEnable(){this._didSetTarget=0,this._enableTime=this.context.time.time;const e=C.getComponent(this.gameObject,Pe);this._camera=e;let i=e==null?void 0:e.threeCamera;if(!i&&this.gameObject instanceof Se&&(i=this.gameObject),i&&X0(i,this,!0),!this._controls&&i instanceof D){this._cameraObject=i;const n=this.targetElement??this.context.renderer.domElement,o=i==null?void 0:i.quaternion.clone();this._controls=new Yw(i,n),i==null||i.quaternion.copy(o),Vg===void 0&&(Vg={...this._controls.keys});const r=ae(i),l=this.gameObject.worldForward,c=2.5,h=r.clone().sub(l.multiplyScalar(c));this._controls.target.copy(h)}if(this._controls)if(Wg&&(this.enablePan=!0,this.enableZoom=!0,this.middleClickToFocus=!0,K.isMobileDevice()&&(this.doubleClickToFocus=!0)),this._controls.addEventListener("start",this.onControlsChangeStarted),this._controls.addEventListener("endMovement",this.onControlsChangeEnded),!this._startedListeningToKeyEvents&&this.enableKeys)this._startedListeningToKeyEvents=!0,this._controls.listenToKeyEvents(this.context.domElement);else try{this._controls.stopListenToKeyEvents()}catch{}this._syncedTransform=C.getComponent(this.gameObject,oo)??void 0,this.context.pre_render_callbacks.push(this.__onPreRender),this._activePointerEvents=[],this.context.input.addEventListener("pointerdown",this._onPointerDown,{queue:qi.Early}),this.context.input.addEventListener("pointerdown",this._onPointerDownLate,{queue:qi.Late}),this.context.input.addEventListener("pointerup",this._onPointerUp,{queue:qi.Early}),this.context.input.addEventListener("pointerup",this._onPointerUpLate,{queue:qi.Late})}onDisable(){var e;if((e=this._camera)!=null&&e.threeCamera&&X0(this._camera.threeCamera,this,!1),this._controls){this._controls.enabled=!1,this._controls.autoRotate=!1,this._controls.removeEventListener("start",this.onControlsChangeStarted),this._controls.removeEventListener("endMovement",this.onControlsChangeEnded);try{this._controls.stopListenToKeyEvents()}catch{}this._startedListeningToKeyEvents=!1}this._activePointerEvents.length=0,this.context.input.removeEventListener("pointerdown",this._onPointerDown),this.context.input.removeEventListener("pointerdown",this._onPointerDownLate),this.context.input.removeEventListener("pointerup",this._onPointerUp),this.context.input.removeEventListener("pointerup",this._onPointerUpLate)}updateTargetNow(e){var r,l,c;const i=new Hr((r=this._cameraObject)==null?void 0:r.worldPosition,(l=this._cameraObject)==null?void 0:l.worldForward.multiplyScalar(-1)),n=this.context.physics.raycastFromRay(i,e),o=n.length>0?n[0]:void 0;o&&o.distance>this.minZoom&&o.distance<this.maxZoom?(Si&&G.DrawWireSphere(o.point,.1,16711680,2),(c=this._controls)==null||c.target.copy(n[0].point)):Si&&console.log("OrbitControls: No hit found when updating target",{hits:[...n]})}afterHandleInput(e){e.detail.args.pointerId===0&&(e.detail.args.isDown?this._controls&&this._eventSystem&&(this._shouldDisable=this._eventSystem.hasActiveUI):(!e.detail.args.isPressed||e.detail.args.isUp)&&(this._shouldDisable=!1))}onPausedChanged(e){this._controls&&e&&(this._controls.enabled=!1)}onBeforeRender(){var i,n,o,r;if(!this._controls)return;if(this._cameraObject!==this.context.mainCamera){this._controls.enabled=!1;return}if(this._controls.enabled=!0,(this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2)||this.context.input.mouseWheelChanged||this.context.input.getPointerPressed(0)&&((i=this.context.input.getPointerPositionDelta(0))!=null&&i.length())||0>.1)&&(this._inputs+=1),this._inputs>0&&this.allowInterrupt&&(this.enableRotate&&(this.autoRotate=!1),this._cameraLerpActive=!1,this._lookTargetLerpActive=!1),this._inputs=0,this.autoTarget&&this._didSetTarget++===0){const l=C.getComponent(this.gameObject,Pe);if(l&&!this.setLookTargetFromConstraint()){this.debugLog&&console.log("NO TARGET");const c=ae(l.threeCamera),h=Math.max(.01,c.length()),d=new x(0,0,-h).applyMatrix4(l.threeCamera.matrixWorld);Si&&G.DrawLine(c,d,5592575,10),this.setLookTargetPosition(d,!0)}if(!this.setLookTargetFromConstraint()){const c=new Kr;c.screenPoint=new le(0,0),c.lineThreshold=.1;const h=this.context.physics.raycast(c);h.length>0&&this.setLookTargetPosition(h[0].point,!0),Sh&&console.log("OrbitControls hits",...h)}}if(this.middleClickToFocus&&this.context.input.getPointerClicked(1)&&this.setTargetFromRaycast(),this._lookTargetLerpActive||this._cameraLerpActive||this._fovLerpActive){if(this._cameraLerpActive&&this._cameraObject)if(this._cameraLerp01+=this.context.time.deltaTime/this._cameraLerpDuration,this._cameraLerp01>=1)this._cameraObject.position.copy(this._cameraEndPosition),this._cameraLerpActive=!1,this.dispatchEvent(new lp(this,"camera"));else{const l=N.easeInOutCubic(this._cameraLerp01);this._cameraObject.position.lerpVectors(this._cameraStartPosition,this._cameraEndPosition,l)}if(this._lookTargetLerpActive)if(this._lookTargetLerp01+=this.context.time.deltaTime/this._lookTargetLerpDuration,this._lookTargetLerp01>=1)this.lerpLookTarget(this._lookTargetEndPosition,this._lookTargetEndPosition,1),this._lookTargetLerpActive=!1,this.dispatchEvent(new lp(this,"lookat"));else{const l=N.easeInOutCubic(this._lookTargetLerp01);this.lerpLookTarget(this._lookTargetStartPosition,this._lookTargetEndPosition,l)}if(this._fovLerpActive&&this._cameraObject){const l=this._cameraObject;if(this._fovLerp01+=this.context.time.deltaTime/this._fovLerpDuration,this._fovLerp01>=1)l.fov=this._fovLerpEndValue,this._fovLerpActive=!1;else{const c=N.easeInOutCubic(this._fovLerp01);l.fov=N.lerp(this._fovLerpStartValue,this._fovLerpEndValue,c)}l.updateProjectionMatrix()}}if(this._controls){if(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!this._shouldDisable&&this._camera===this.context.mainCameraComponent&&!this.context.isInXR&&!this._activePointerEvents.some(l=>l.used),this._controls.keys=this.enableKeys?Vg:VA,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,this._controls.zoomSpeed=this.zoomSpeed,this._controls.zoomToCursor=this.zoomToCursor,this._controls.enableDamping=this.enableDamping,this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan,this._controls.enableRotate=this.enableRotate,this._controls.minAzimuthAngle=this.minAzimuthAngle,this._controls.maxAzimuthAngle=this.maxAzimuthAngle,this._controls.minPolarAngle=this.minPolarAngle,this._controls.maxPolarAngle=this.maxPolarAngle,Wg||(((o=(n=this._camera)==null?void 0:n.threeCamera)==null?void 0:o.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom,this._controls.minZoom=0,this._controls.maxZoom=1/0):(this._controls.minDistance=0,this._controls.maxDistance=1/0,this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom)),typeof Xu=="number"||Xu===!0){this._controls.enableDamping=!0;const l=typeof Xu=="number"?Xu:.99;this._controls.dampingFactor=Math.max(.001,1-Math.min(1,l))}this.allowInterrupt||(this._lookTargetLerpActive&&(this._controls.enablePan=!1),this._cameraLerpActive&&(this._controls.enableRotate=!1,this._controls.autoRotate=!1),(this._lookTargetLerpActive||this._cameraLerpActive)&&(this._controls.enableZoom=!1)),this.context.isInXR||(!Wg&&((r=this.lookAtConstraint)!=null&&r.locked)&&!this._lookTargetLerpActive&&this.setLookTargetFromConstraint(0,this.lookAtConstraint01),this._controls.update(this.context.time.deltaTime),Si&&G.DrawWireSphere(this._controls.target,.1,65280))}}setCameraAndLookTarget(e,i=!1){if(!e)return(U()||Si)&&console.warn("[OrbitControls] setCameraAndLookTarget target is null"),!1;if(!(e instanceof D)&&!(e instanceof Pe))return(U()||Si)&&console.warn("[OrbitControls] setCameraAndLookTarget target is not an Object3D or Camera"),!1;e instanceof Pe&&(e=e.gameObject);const n=e.worldPosition,o=e.worldForward;e instanceof tR&&(Si&&console.debug("[OrbitControls] setCameraAndLookTarget flip forward direction for camera"),o.multiplyScalar(-1));const r=new Hr(n,o);return Si&&G.DrawRay(r.origin,r.direction,16711680,10),this.setTargetFromRaycast(r,i)||this.setLookTargetPosition(r.at(2,q()),i),this.setCameraTargetPosition(n,i),!0}setCameraTargetPosition(e,i=!1){var n;e&&(e instanceof D&&(e=ae(e)),this._cameraEndPosition||(this._cameraEndPosition=new x),this._cameraEndPosition.copy(e),i===!0?(this._cameraLerpActive=!1,this._cameraObject&&this._cameraObject.position.copy(this._cameraEndPosition)):this._cameraObject&&(this._cameraLerpActive=!0,this._cameraLerp01=0,this._cameraStartPosition.copy((n=this._cameraObject)==null?void 0:n.position),typeof i=="number"?this._cameraLerpDuration=i:this._cameraLerpDuration=this.targetLerpDuration))}get cameraLerpActive(){return this._cameraLerpActive}stopCameraLerp(){this._cameraLerpActive=!1}setFieldOfView(e,i=!1){var o;if(!this._controls||typeof e!="number")return;const n=(o=this._camera)==null?void 0:o.threeCamera;n&&(i===!0?n.fov=e:(this._fovLerpActive=!0,this._fovLerp01=0,this._fovLerpStartValue=n.fov,this._fovLerpEndValue=e,typeof i=="number"?this._fovLerpDuration=i:this._fovLerpDuration=this.targetLerpDuration))}setLookTargetPosition(e=null,i=!1){this._controls&&e&&(e instanceof D&&(e=ae(e)),this._lookTargetEndPosition.copy(e),this._didSetTarget++,Si&&(console.warn("OrbitControls: setLookTargetPosition",e,i),G.DrawWireSphere(this._lookTargetEndPosition,.2,16711680,2)),i===!0?this.lerpLookTarget(this._lookTargetEndPosition,this._lookTargetEndPosition,1):(this._lookTargetLerpActive=!0,this._lookTargetLerp01=0,this._lookTargetStartPosition.copy(this._controls.target),typeof i=="number"?this._lookTargetLerpDuration=i:this._lookTargetLerpDuration=this.targetLerpDuration))}get lookTargetLerpActive(){return this._lookTargetLerpActive}stopLookTargetLerp(){this._lookTargetLerpActive=!1}setLookTargetFromConstraint(e=0,i=1){var o,r;if(!this._controls||((o=this.lookAtConstraint)==null?void 0:o.enabled)===!1)return!1;const n=(r=this.lookAtConstraint)==null?void 0:r.sources;if(n&&n.length>0){const l=n[e];if(l)return l.getWorldPosition(this._lookTargetEndPosition),this.lerpLookTarget(this._controls.target,this._lookTargetEndPosition,i),!0}return!1}lerpLookTarget(e,i,n){this._controls&&(n>=1?this._controls.target.copy(i):this._controls.target.lerpVectors(e,i,n),this.lookAtConstraint&&this.lookAtConstraint.setConstraintPosition(this._controls.target))}setTargetFromRaycast(e,i=!1){if(!this.controls)return!1;const n=e?this.context.physics.raycastFromRay(e):this.context.physics.raycast();for(const o of n)if(o.distance>0&&C.isActiveInHierarchy(o.object)){const r=Lb(o.object);if(r){const l=r.canvas;if(l!=null&&l.screenspace)break}return this.setLookTargetPosition(o.point,i),!0}return!1}fitCamera(e,i){var A,$;if(this.context.isInXR){console.warn("[OrbitControls] Can not fit camera while XR session is active");return}let n;if(Array.isArray(e)||e&&"type"in e?n=e:e&&typeof e=="object"&&!(e instanceof D)&&!Array.isArray(e)&&(i=e,n=i.objects),n&&!Array.isArray(n)&&(n=[n]),(!Array.isArray(n)||n&&n.length<=0)&&(n=this.context.scene.children),!Array.isArray(n)||n.length<=0){console.warn("No objects to fit camera to...");return}const o=this._cameraObject,r=this._controls;if(!o||!r){console.warn("No camera or controls found to fit camera to objects...");return}i||(i={});const{immediate:l=!1,centerCamera:c,cameraNearFar:h="auto",fitOffset:d=1.1,fov:u=o==null?void 0:o.fov}=i,f=new x,p=new x,g=Qi(n,void 0,($=(A=this._camera)==null?void 0:A.threeCamera)==null?void 0:$.layers),_=g.clone();g.getCenter(p);const y=new x;if(g.getSize(y),o.updateMatrixWorld(),g.applyMatrix4(o.matrixWorldInverse),g.getSize(f),g.setFromCenterAndSize(p,f),Number.isNaN(f.x)||Number.isNaN(f.y)||Number.isNaN(f.z)){console.warn("Camera fit size resultet in NaN",o,g,[...n]);return}if(f.length()<=1e-10){Sh&&console.warn("Camera fit size is zero",g,[...n]);return}const b=u,v=2*Math.atan(Math.tan(b*Math.PI/360/2)*o.aspect)/Math.PI*360,w=f.y/(2*Math.atan(Math.PI*b/360)),P=f.x/(2*Math.atan(Math.PI*v/360)),E=d*Math.max(w,P)+f.z/2;Sh&&console.log("Fit camera to objects",{fitHeightDistance:w,fitWidthDistance:P,distance:E,verticalFov:b,horizontalFov:v}),this.maxZoom=E*10,this.minZoom=E*.01;const T=.05,k=p.clone();if(k.y-=f.y*T,i.targetOffset&&(i.targetOffset.x!==void 0&&(k.x+=i.targetOffset.x),i.targetOffset.y!==void 0&&(k.y+=i.targetOffset.y),i.targetOffset.z!==void 0&&(k.z+=i.targetOffset.z)),i.relativeTargetOffset&&(i.relativeTargetOffset.x!==void 0&&(k.x+=i.relativeTargetOffset.x*f.x),i.relativeTargetOffset.y!==void 0&&(k.y+=i.relativeTargetOffset.y*f.y),i.relativeTargetOffset.z!==void 0&&(k.z+=i.relativeTargetOffset.z*f.z)),this.setLookTargetPosition(k,l),this.setFieldOfView(i.fov,l),h==null||h=="auto"){const B=C.findObjectOfType(ir),I=B?B.radius:0,V=Math.max(y.x,y.y,y.z,I);o.near=E/100,o.far=V+E*10,o.updateProjectionMatrix(),B&&(this.maxZoom=Math.max(Math.min(this.maxZoom,I*.5),E))}const z=r.getDistance();z<this.minZoom&&(this.minZoom=z*.9),z>this.maxZoom&&(this.maxZoom=z*1.1);const L=p.clone();i.fitDirection?L.sub(new x().copy(i.fitDirection).multiplyScalar(1e6)):L.sub(o.worldPosition),c==="y"&&(L.y=0),L.normalize(),L.multiplyScalar(E),c==="y"&&(L.y+=-T*4*E);let O=p.clone().sub(L);i.cameraOffset&&(i.cameraOffset.x!==void 0&&(O.x+=i.cameraOffset.x),i.cameraOffset.y!==void 0&&(O.y+=i.cameraOffset.y),i.cameraOffset.z!==void 0&&(O.z+=i.cameraOffset.z)),i.relativeCameraOffset&&(i.relativeCameraOffset.x!==void 0&&(O.x+=i.relativeCameraOffset.x*f.x),i.relativeCameraOffset.y!==void 0&&(O.y+=i.relativeCameraOffset.y*f.y),i.relativeCameraOffset.z!==void 0&&(O.z+=i.relativeCameraOffset.z*f.z)),o.parent&&(O=o.parent.worldToLocal(O)),this.setCameraTargetPosition(O,l),(Sh||i.debug)&&(G.DrawWireBox3(g,16777011,10),G.DrawWireBox3(_,65280,10),!this._haveAttachedKeyboardEvents&&Sh&&(this._haveAttachedKeyboardEvents=!0,document.body.addEventListener("keydown",B=>{if(B.code==="KeyF"){let I;this._cameraObject instanceof Se&&(I=Math.random()*Math.random()*170+10),this.fitCamera({objects:n,fitOffset:d,immediate:!1,fov:I})}B.code==="KeyV"&&this._cameraObject instanceof Se&&(this._cameraObject.fov=60)}))),this.onBeforeRender()}}Ze([m()],Ee.prototype,"autoTarget",void 0);Ze([m()],Ee.prototype,"autoFit",void 0);Ze([m()],Ee.prototype,"enableRotate",void 0);Ze([m()],Ee.prototype,"autoRotate",void 0);Ze([m()],Ee.prototype,"autoRotateSpeed",void 0);Ze([m()],Ee.prototype,"minAzimuthAngle",void 0);Ze([m()],Ee.prototype,"maxAzimuthAngle",void 0);Ze([m()],Ee.prototype,"minPolarAngle",void 0);Ze([m()],Ee.prototype,"maxPolarAngle",void 0);Ze([m()],Ee.prototype,"enableKeys",void 0);Ze([m()],Ee.prototype,"enableDamping",void 0);Ze([m()],Ee.prototype,"dampingFactor",void 0);Ze([m()],Ee.prototype,"enableZoom",void 0);Ze([m()],Ee.prototype,"minZoom",void 0);Ze([m()],Ee.prototype,"maxZoom",void 0);Ze([m()],Ee.prototype,"zoomSpeed",void 0);Ze([m()],Ee.prototype,"enablePan",void 0);Ze([m(Fc)],Ee.prototype,"lookAtConstraint",void 0);Ze([m()],Ee.prototype,"lookAtConstraint01",void 0);Ze([m()],Ee.prototype,"allowInterrupt",void 0);Ze([m()],Ee.prototype,"middleClickToFocus",void 0);Ze([m()],Ee.prototype,"doubleClickToFocus",void 0);Ze([m()],Ee.prototype,"clickBackgroundToFitScene",void 0);Ze([m()],Ee.prototype,"targetLerpDuration",void 0);var Li=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},ui;(function(s){s[s.None=0]="None",s[s.Skybox=1]="Skybox",s[s.SolidColor=2]="SolidColor",s[s.Uninitialized=4]="Uninitialized"})(ui||(ui={}));const br=S("debugcam"),Ox=S("debugscreenpointtoray"),ec=class extends j{constructor(){super(...arguments);a(this,"_nearClipPlane",.1);a(this,"_farClipPlane",1e3);a(this,"orthographic",!1);a(this,"orthographicSize",5);a(this,"ARBackgroundAlpha",0);a(this,"_cullingMask",4294967295);a(this,"_backgroundBlurriness");a(this,"_backgroundIntensity");a(this,"_backgroundRotation");a(this,"_environmentIntensity");a(this,"_targetTexture",null);a(this,"_backgroundColor");a(this,"_fov");a(this,"_cam",null);a(this,"_clearFlags",ui.SolidColor);a(this,"_skybox");a(this,"_frustum");a(this,"_projScreenMatrix",new ce)}get isCamera(){return!0}get aspect(){return this._cam instanceof Se?this._cam.aspect:this.context.domWidth/this.context.domHeight}set aspect(e){this._cam instanceof Se&&this._cam.aspect!==e&&(this._cam.aspect=e,this._cam.updateProjectionMatrix())}get fieldOfView(){return this._cam instanceof Se?this._cam.fov:this._fov}set fieldOfView(e){const i=this.fieldOfView!=e;if(this._fov=e,i&&this._cam&&this._cam instanceof Se){if(this._fov===void 0){console.warn("Can not set undefined fov on PerspectiveCamera");return}this._cam.fov=this._fov,this._cam.updateProjectionMatrix()}}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(e){const i=this._nearClipPlane!=e;this._nearClipPlane=e,this._cam&&(i||this._cam.near!=e)&&(this._cam.near=e,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(e){const i=this._farClipPlane!=e;this._farClipPlane=e,this._cam&&(i||this._cam.far!=e)&&(this._cam.far=e,this._cam.updateProjectionMatrix())}applyClippingPlane(){this._cam&&(this._cam.near=this._nearClipPlane,this._cam.far=this._farClipPlane,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(e){if(typeof e=="string")switch(e){case"skybox":e=ui.Skybox;break;case"solidcolor":e=ui.SolidColor;break;default:e=ui.None;break}e!==this._clearFlags&&(this._clearFlags=e,this.applyClearFlagsIfIsActiveCamera())}set cullingMask(e){this._cullingMask=e,this._cam&&(this._cam.layers.mask=e)}get cullingMask(){return this._cam?this._cam.layers.mask:this._cullingMask}set cullingLayer(e){this.cullingMask=(1<<e|0)>>>0}set backgroundBlurriness(e){e!==this._backgroundBlurriness&&(e===void 0?this._backgroundBlurriness=void 0:this._backgroundBlurriness=Math.min(Math.max(e,0),1),this.applyClearFlagsIfIsActiveCamera())}get backgroundBlurriness(){return this._backgroundBlurriness}set backgroundIntensity(e){e!==this._backgroundIntensity&&(e===void 0?this._backgroundIntensity=void 0:this._backgroundIntensity=Math.min(Math.max(e,0),10),this.applyClearFlagsIfIsActiveCamera())}get backgroundIntensity(){return this._backgroundIntensity}set backgroundRotation(e){e!==this._backgroundRotation&&(e===void 0?this._backgroundRotation=void 0:this._backgroundRotation=e,this.applyClearFlagsIfIsActiveCamera())}get backgroundRotation(){return this._backgroundRotation}set environmentIntensity(e){this._environmentIntensity=e}get environmentIntensity(){return this._environmentIntensity}get backgroundColor(){return this._backgroundColor??null}set backgroundColor(e){e&&(this._backgroundColor||(this._backgroundColor=new pe(1,1,1,1)),this._backgroundColor.copy(e),(!("alpha"in e)||e.alpha===void 0)&&(this._backgroundColor.alpha=1),this.applyClearFlagsIfIsActiveCamera())}set targetTexture(e){this._targetTexture=e}get targetTexture(){return this._targetTexture}get cam(){return this.threeCamera}get threeCamera(){return this.activeAndEnabled&&this.buildCamera(),this._cam}screenPointToRay(e,i,n){const o=this.threeCamera,r=ec._origin;r.set(e,i,-1),this.context.input.convertScreenspaceToRaycastSpace(r),Ox&&console.log("screenPointToRay",e.toFixed(2),i.toFixed(2),"now:",r.x.toFixed(2),r.y.toFixed(2),"isInXR:"+this.context.isInXR),r.z=-1,r.unproject(o);const l=ec._direction.set(r.x,r.y,r.z),c=ae(o);return l.sub(c),l.normalize(),n?(n.set(c,l),n):new Hr(c.clone(),l.clone())}getFrustum(){return this._frustum||(this._frustum=new D0,this.updateFrustum()),this._frustum}updateFrustum(){this._frustum||(this._frustum=new D0),this._frustum.setFromProjectionMatrix(this.getProjectionScreenMatrix(this._projScreenMatrix,!0),this.context.renderer.coordinateSystem)}getProjectionScreenMatrix(e,i){return i&&this._projScreenMatrix.multiplyMatrices(this.threeCamera.projectionMatrix,this.threeCamera.matrixWorldInverse),e===this._projScreenMatrix?e:e.copy(this._projScreenMatrix)}awake(){Ox&&window.addEventListener("pointerdown",e=>{const i=e.clientX,n=e.clientY;console.log("touch",i.toFixed(2),n.toFixed(2));const o=this.screenPointToRay(i,n),r="#"+Math.floor(Math.random()*16777215).toString(16);G.DrawRay(o.origin,o.direction,r,10)})}onEnable(){br&&console.log(`Camera enabled: "${this.name}". ClearFlags=${ui[this._clearFlags]}`,this),this.buildCamera(),(this.tag=="MainCamera"||!this.context.mainCameraComponent)&&(this.context.setCurrentCamera(this),GA(this)),this.applyClearFlagsIfIsActiveCamera({applySkybox:!0})}onDisable(){this.context.removeCamera(this)}onLeaveXR(e){this.fieldOfView=this._fov}onBeforeRender(){if(this._cam&&(this._frustum&&this.updateFrustum(),this._clearFlags===ui.SolidColor&&this.applyClearFlagsIfIsActiveCamera(),this._targetTexture)){this.context.isManagedExternally&&(this._warnedAboutExternalRenderer||(this._warnedAboutExternalRenderer=!0,console.warn("Rendering with external renderer is not supported yet. This may not work or throw errors. Please remove the the target texture from your camera: "+this.name,this.targetTexture))),this.context.composer;const e=this.context.renderer;if(e){const i=this.context.mainCameraComponent;this.applyClearFlags(),this._targetTexture.render(this.context.scene,this._cam,e),i==null||i.applyClearFlags()}}}buildCamera(){if(this._cam)return;const e=this.gameObject.isCamera;let i=null;if(e?(i=this.gameObject,i==null||i.layers.enableAll(),i instanceof Se&&(this._fov=i.fov)):i=this.gameObject.children[0],i&&i.isCamera)i instanceof Se&&(this._fov&&(i.fov=this._fov),i.near=this._nearClipPlane,i.far=this._farClipPlane,i.updateProjectionMatrix());else if(!this.orthographic)i=new Se(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),this.fieldOfView&&(i.fov=this.fieldOfView),this.gameObject.add(i);else{const n=this.orthographicSize*100;i=new $p(window.innerWidth/-n,window.innerWidth/n,window.innerHeight/n,window.innerHeight/-n,this._nearClipPlane,this._farClipPlane),this.gameObject.add(i)}this._cam=i,this._cam.layers.mask=this._cullingMask,this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(e){this.context.mainCameraComponent===this&&this.applyClearFlags(e)}applyClearFlags(e){var n;if(!this._cam){br&&console.log("Camera does not exist (apply clear flags)");return}if(this.fieldOfView=this.fieldOfView,br){const o=`[Camera] Apply ClearFlags: ${ui[this._clearFlags]} - "${this.name}"`;console.debug(o)}const i=this.context.domElement.getAttribute("background-image")||this.context.domElement.getAttribute("background-color");switch(this._clearFlags){case ui.None:return;case ui.Skybox:if(ec.backgroundShouldBeTransparent(this.context)&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}(!this.scene.background||!this._skybox||(e==null?void 0:e.applySkybox)===!0)&&this.applySceneSkybox(),this._backgroundBlurriness!==void 0&&!this.context.domElement.getAttribute("background-blurriness")?this.context.scene.backgroundBlurriness=this._backgroundBlurriness:br&&console.warn(`Camera "${this.name}" has no background blurriness`),this._backgroundIntensity!==void 0&&!this.context.domElement.getAttribute("background-intensity")&&(this.context.scene.backgroundIntensity=this._backgroundIntensity),this._backgroundRotation!==void 0&&!this.context.domElement.getAttribute("background-rotation")?this.context.scene.backgroundRotation=this._backgroundRotation:br&&console.warn(`Camera "${this.name}" has no background intensity`);break;case ui.SolidColor:if(this._backgroundColor&&!i){let o=this._backgroundColor.alpha;ec.backgroundShouldBeTransparent(this.context)&&(o=this.ARBackgroundAlpha??0),this.context.scene.background=null,(n=this.context.xr)!=null&&n.isVR?this.context.renderer.setClearColor(gO(this._backgroundColor).convertLinearToSRGB()):this.context.renderer.setClearColor(this._backgroundColor,o)}else this._backgroundColor||br&&console.warn(`[Camera] has no background color "${this.name}" `);break;case ui.Uninitialized:i||(this.context.scene.background=null,this.context.renderer.setClearColor(0,0));break}}applySceneSkybox(){this._skybox||(this._skybox=new HA(this)),this._skybox.apply()}static backgroundShouldBeTransparent(e){var r,l,c,h;const i=(r=e.renderer.xr)==null?void 0:r.getSession();if(!i)return!1;if(typeof i._transparent=="boolean")return i._transparent;const n=i.environmentBlendMode;br&&nt("Environment blend mode: "+n+" on "+navigator.userAgent);let o=n==="additive"||n==="alpha-blend";return e.isInAR&&n==="opaque"&&((l=navigator.userAgent)!=null&&l.includes("OculusBrowser")||(c=navigator.userAgent)!=null&&c.includes("Mozilla")&&((h=navigator.userAgent)!=null&&h.includes("Mobile WebXRViewer/v2")))&&(o=!0),i._transparent=o,o}};let Pe=ec;a(Pe,"_origin",new x),a(Pe,"_direction",new x);Li([m()],Pe.prototype,"aspect",null);Li([m()],Pe.prototype,"fieldOfView",null);Li([m()],Pe.prototype,"nearClipPlane",null);Li([m()],Pe.prototype,"farClipPlane",null);Li([m()],Pe.prototype,"clearFlags",null);Li([m()],Pe.prototype,"orthographic",void 0);Li([m()],Pe.prototype,"orthographicSize",void 0);Li([m()],Pe.prototype,"ARBackgroundAlpha",void 0);Li([m()],Pe.prototype,"cullingMask",null);Li([m()],Pe.prototype,"backgroundBlurriness",null);Li([m()],Pe.prototype,"backgroundIntensity",null);Li([m(Ct)],Pe.prototype,"backgroundRotation",null);Li([m()],Pe.prototype,"environmentIntensity",null);Li([m(pe)],Pe.prototype,"backgroundColor",null);Li([m(qa)],Pe.prototype,"targetTexture",null);class HA{constructor(t){a(this,"_camera");a(this,"_skybox");this._camera=t}get context(){var t;return(t=this._camera)==null?void 0:t.context}apply(){var t;if(this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),!this._skybox)this._did_log_failed_to_find_skybox||(this._did_log_failed_to_find_skybox=!0,console.warn(`Camera "${this._camera.name}" has no skybox texture. ${this._camera.sourceId}`));else if(this.context.scene.background!==this._skybox){const e=this.context.domElement.getAttribute("background-image")||this.context.domElement.getAttribute("background-color");br&&console.debug(`[Camera] Apply Skybox ${(t=this._skybox)==null?void 0:t.name} ${e} - "${this._camera.name}"`),e!=null&&e.length||(this._skybox.mapping=zo,this.context.scene.background=this._skybox)}}}function GA(s){S("freecam")&&s.context.mainCameraComponent===s&&C.getOrAddComponent(s.gameObject,Ee)}class Mr extends j{constructor(){super(...arguments);a(this,"_listener",null);a(this,"onInteraction",()=>{this.destroyed||this.listener==null||this.addListenerIfItExists()})}get listener(){return this._listener==null&&(this._listener=new iR),this._listener}onEnable(){ls.registerWaitForInteraction(this.onInteraction),this.addListenerIfItExists()}onDisable(){ls.unregisterWaitForInteraction(this.onInteraction),this.removeListenerIfItExists()}addListenerIfItExists(){const e=this._listener;if(!e||e!=null&&e.parent)return;const i=this.context.mainCameraComponent||C.getComponentInParent(this.gameObject,Pe);i!=null&&i.threeCamera?i.threeCamera.add(e):this.gameObject.add(e),e.filter?(e.gain.connect(e.filter),e.filter.connect(e.context.destination)):e.gain.connect(e.context.destination)}removeListenerIfItExists(){const e=this._listener;e&&(e.removeFromParent(),e.filter&&e.filter.disconnect(),e.gain&&e.gain.disconnect())}}var ys=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Vt=S("debugaudio");var ad;(function(s){s[s.Logarithmic=0]="Logarithmic",s[s.Linear=1]="Linear",s[s.Custom=2]="Custom"})(ad||(ad={}));class Oe extends j{constructor(){super(...arguments);a(this,"clip","");a(this,"playOnAwake",!1);a(this,"preload",!0);a(this,"playInBackground",!0);a(this,"_spatialBlend",0);a(this,"_minDistance",1);a(this,"_maxDistance",100);a(this,"_volume",1);a(this,"rollOffMode",0);a(this,"_loop",!1);a(this,"sound",null);a(this,"helper",null);a(this,"wasPlaying",!1);a(this,"audioLoader",null);a(this,"shouldPlay",!1);a(this,"_lastClipStartedLoading",null);a(this,"_audioElement",null);a(this,"onVisibilityChanged",()=>{switch(document.visibilityState){case"hidden":(this.playInBackground===!1||K.isMobileDevice())&&(this.wasPlaying=this.isPlaying,this.isPlaying&&this.pause());break;case"visible":Vt&&console.log("visible",this.enabled,this.playOnAwake,!this.isPlaying,Oe.userInteractionRegistered,this.wasPlaying),this.enabled&&this.playOnAwake&&!this.isPlaying&&Oe.userInteractionRegistered&&this.wasPlaying&&this.play();break}});a(this,"onApplicationMuteChanged",()=>{var e,i;this.context.application.muted?(e=this.sound)==null||e.setVolume(0):(i=this.sound)==null||i.setVolume(this.volume)});a(this,"createAudio",e=>{if(this.destroyed){Vt&&console.warn("AudioSource destroyed, not creating audio",this.name);return}Vt&&console.log("AudioBuffer finished loading",e);const i=this.Sound;if(!i){Vt&&console.warn("Failed getting sound?",this.name);return}i.isPlaying&&i.stop(),e&&i.setBuffer(e),i.loop=this._loop,this.context.application.muted?i.setVolume(0):i.setVolume(this.volume),i.autoplay=this.shouldPlay&&Oe.userInteractionRegistered,this.applySpatialDistanceSettings(),i.isPlaying&&i.stop(),Oe.registerWaitForAllowAudio(this.__onAllowAudioCallback)});a(this,"__onAllowAudioCallback",()=>{this.shouldPlay&&this.play()});a(this,"_lastContextTime",0);a(this,"_hasEnded",!0);a(this,"_needUpdateSpatialDistanceSettings",!1)}static get userInteractionRegistered(){return ls.userInteractionRegistered}static registerWaitForAllowAudio(e){ls.registerWaitForInteraction(e)}get isPlaying(){var e;return((e=this.sound)==null?void 0:e.isPlaying)??!1}get duration(){var e,i;return(i=(e=this.sound)==null?void 0:e.buffer)==null?void 0:i.duration}get time01(){var i;const e=this.duration;return e&&this.sound?((i=this.sound)==null?void 0:i.context.currentTime)/e:0}set time01(e){const i=this.duration;i&&this.sound&&(this.time=e*i)}get time(){var e,i;return(e=this.sound)!=null&&e.source?((i=this.sound.source)==null?void 0:i.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(e){if(this.sound){if(e===this.sound.offset)return;const i=this.isPlaying;this.stop(),this.sound.offset=e,i&&this.play()}}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(e){this._loop=e,this.sound&&this.sound.setLoop(e)}get spatialBlend(){return this._spatialBlend}set spatialBlend(e){e!==this._spatialBlend&&(this._spatialBlend=e,this._needUpdateSpatialDistanceSettings=!0)}get minDistance(){return this._minDistance}set minDistance(e){this._minDistance!==e&&(this._minDistance=e,this._needUpdateSpatialDistanceSettings=!0)}get maxDistance(){return this._maxDistance}set maxDistance(e){this._maxDistance!==e&&(this._maxDistance=e,this._needUpdateSpatialDistanceSettings=!0)}get volume(){return this._volume}set volume(e){this._volume=e,this.sound&&!this.context.application.muted&&(Vt&&console.log(this.name,"audio set volume",e),this.sound.setVolume(e))}set pitch(e){this.sound&&this.sound.setPlaybackRate(e)}get pitch(){return this.sound?this.sound.getPlaybackRate():1}get Sound(){var e;if(!this.sound&&Oe.userInteractionRegistered){let i=this.gameObject.getComponent(Mr)??this.context.mainCamera.getComponent(Mr)??hm(Mr,this.context,!1);!i&&this.context.mainCamera&&(i=this.context.mainCamera.addComponent(Mr)),i!=null&&i.listener?(this.sound=new nR(i.listener),(e=this.gameObject)==null||e.add(this.sound)):Vt&&console.warn("No audio listener found in scene - can not play audio")}return this.sound}get ShouldPlay(){return this.shouldPlay}get audioContext(){var e;return(e=this.sound)==null?void 0:e.context}awake(){Vt&&console.log("[AudioSource]",this),this.audioLoader=new ky,this.playOnAwake&&(this.shouldPlay=!0),this.preload&&typeof this.clip=="string"&&this.audioLoader.load(this.clip,this.createAudio,()=>{},console.error)}onEnable(){this.sound&&this.gameObject.add(this.sound),Oe.userInteractionRegistered?this.playOnAwake&&this.context.application.isVisible&&this.play():Oe.registerWaitForAllowAudio(()=>{this.enabled&&!this.destroyed&&this.shouldPlay&&this.onNewClip(this.clip)}),globalThis.addEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.addEventListener(Va.MuteChanged,this.onApplicationMuteChanged)}onDisable(){globalThis.removeEventListener("visibilitychange",this.onVisibilityChanged),this.context.application.removeEventListener(Va.MuteChanged,this.onApplicationMuteChanged),this.pause()}applySpatialDistanceSettings(){const e=this.sound;if(!e)return;this._needUpdateSpatialDistanceSettings=!1;const i=N.lerp(10*this._maxDistance/Math.max(1e-4,this.spatialBlend),this._minDistance,this.spatialBlend);switch(Vt&&console.log(this.name,this._minDistance,this._maxDistance,this.spatialBlend,"Ref distance="+i),e.setRefDistance(i),e.setMaxDistance(Math.max(.01,this._maxDistance)),this.rollOffMode){case ad.Logarithmic:e.setDistanceModel("exponential");break;case ad.Linear:e.setDistanceModel("linear");break;case ad.Custom:console.warn("Custom rolloff for AudioSource is not supported: "+this.name);break}this.spatialBlend>0?Vt&&!this.helper&&(this.helper=new aT(e,e.getRefDistance()),e.add(this.helper)):this.helper&&this.helper.parent&&this.helper.removeFromParent()}async onNewClip(e){if(e&&(this.clip=e),typeof e=="string")if(Vt&&console.log(e),e.endsWith(".mp3")||e.endsWith(".wav")){if(this.audioLoader||(this.audioLoader=new ky),this.shouldPlay=!0,this._lastClipStartedLoading===e){Vt&&console.log("Is currently loading:",this._lastClipStartedLoading,this);return}this._lastClipStartedLoading=e,Vt&&console.log("load audio",e);const i=await this.audioLoader.loadAsync(e).catch(console.error);if(this.destroyed)return;this._lastClipStartedLoading===e&&(this._lastClipStartedLoading=null),i&&this.createAudio(i)}else console.warn("Unsupported audio clip type",e);else this.shouldPlay=!0,this.createAudio()}play(e=void 0){var n,o,r;!e&&this.clip&&(e=this.clip),e!==void 0&&typeof e!="string"&&!(e instanceof MediaStream)&&(U()&&console.warn("Called play on AudioSource with unknown argument type:",e+`
Using the assigned clip instead:`,this.clip),e=this.clip);let i=!this.sound||e&&e!==this.clip;if(typeof e=="string"&&!this.audioLoader&&(i=!0),(e instanceof MediaStream||typeof e=="string")&&(this.clip=e),i){this.shouldPlay=!0,this.onNewClip(e);return}if(this.shouldPlay=!0,this._hasEnded=!1,Vt&&console.log("play",(n=this.sound)==null?void 0:n.getVolume(),this.sound),this.sound&&!this.sound.isPlaying){const l=this.context.application.muted;l&&this.sound.setVolume(0),(o=this.gameObject)==null||o.add(this.sound),this.clip instanceof MediaStream?(this.sound.setMediaStreamSource(this.clip),this._audioElement||(this._audioElement=document.createElement("audio"),this._audioElement.style.display="none"),this._audioElement.parentNode||(r=this.context.domElement.shadowRoot)==null||r.append(this._audioElement),this._audioElement.srcObject=this.clip,this._audioElement.autoplay=!1):(this._audioElement&&this._audioElement.remove(),this.sound.play(l?.1:0))}}pause(){var e,i;Vt&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&this.sound.source&&(this._lastContextTime=(e=this.sound)==null?void 0:e.context.currentTime,this.sound.pause()),(i=this._audioElement)==null||i.remove()}stop(){var e,i;Vt&&console.log("Pause",this),this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.source&&(this._lastContextTime=(e=this.sound)==null?void 0:e.context.currentTime,Vt&&console.log(this._lastContextTime),this.sound.stop()),(i=this._audioElement)==null||i.remove()}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this._needUpdateSpatialDistanceSettings&&this.applySpatialDistanceSettings(),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,Vt&&console.log("Audio clip ended",this.clip),this.dispatchEvent(new CustomEvent("ended",{detail:this})))}}ys([m(URL)],Oe.prototype,"clip",void 0);ys([m()],Oe.prototype,"playOnAwake",void 0);ys([m()],Oe.prototype,"preload",void 0);ys([m()],Oe.prototype,"playInBackground",void 0);ys([m()],Oe.prototype,"loop",null);ys([m()],Oe.prototype,"spatialBlend",null);ys([m()],Oe.prototype,"minDistance",null);ys([m()],Oe.prototype,"maxDistance",null);ys([m()],Oe.prototype,"volume",null);ys([m()],Oe.prototype,"pitch",null);ys([m()],Oe.prototype,"rollOffMode",void 0);const qA=S("debugavatar"),Kn=class extends j{constructor(){super(...arguments);a(this,"connectionId");a(this,"avatar")}static getAvatar(e){return e>=0&&e<Kn.instances.length?Kn.instances[e]:null}static onAvatarMarkerCreated(e){return Kn._onNewAvatarMarkerAdded.push(e),e}static onAvatarMarkerDestroyed(e){return Kn._onAvatarMarkerDestroyed.push(e),e}awake(){Kn.instances.push(this),qA&&console.log(this);for(const e of Kn._onNewAvatarMarkerAdded)e({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){Kn.instances.splice(Kn.instances.indexOf(this),1);for(const e of Kn._onAvatarMarkerDestroyed)e({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}};let Lt=Kn;a(Lt,"instances",[]),a(Lt,"_onNewAvatarMarkerAdded",[]),a(Lt,"_onAvatarMarkerDestroyed",[]);class zr{static Add(t,e,i=null){if(e){for(const n of this.Pois)if(n.obj===e)return;this.Pois.push({obj:e,avatar:i}),this.LastChangeTime=t.time.time}}static Remove(t,e){var i;if(e){for(const n of this.Pois)if(n.obj===e){this.Pois.splice(this.Pois.indexOf(n),1),this.LastChangeTime=(t==null?void 0:t.time.time)??((i=ne.Current)==null?void 0:i.time.time);return}}}}a(zr,"Pois",[]),a(zr,"LastChangeTime",0);var cp;(function(s){s.TargetChanged="avatar-look-target-changed"})(cp||(cp={}));class XA{constructor(){a(this,"guid");a(this,"position",new x)}}class hp extends j{constructor(){super(...arguments);a(this,"target",null);a(this,"avatar",null);a(this,"_model",null);a(this,"_targetModel",new XA);a(this,"_currentTargetObject",null);a(this,"_lastUpdateTime",0);a(this,"_lookDuration",0);a(this,"_lastPoiChangedTime",0)}set controlledTarget(e){this.target=e;const i=M.get("MoveRandom");if(i&&this.target){const n=C.getComponent(this.target,i);n&&n.destroy()}}awake(){if(this.avatar=C.getComponentInParent(this.gameObject,Lt),this.avatar){const e=C.getComponentInParent(this.gameObject,Lt);this._model=new vC(this.context.connection,this.guid),e!=null&&e.isLocalAvatar&&this._model.requestOwnership()}this.context.connection.beginListen(cp.TargetChanged,e=>{var i;this.target&&e&&e.guid===((i=this.avatar)==null?void 0:i.guid)&&ei(this.target,e.position)})}update(){var i;if((!this.context.connection.isConnected||(i=this._model)!=null&&i.hasOwnership)&&(zr.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=zr.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10===0&&this.target)){const n=ae(this._currentTargetObject);ei(this.target,n),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send(cp.TargetChanged,this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(n))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const i=zr.Pois;if(i.length>0){const n=i[Math.floor(Math.random()*i.length)];if(n&&n.obj){if(n.avatar&&n.avatar===this.avatar)return;this._currentTargetObject=n.obj}}}}}function QA(s){const t=s;return!!(t.parser&&t.parser.json)}var dp;(function(s){s[s.None=0]="None",s[s.DontExport=1]="DontExport"})(dp||(dp={}));function YA(s){return s&&s.isComponent}const F3=Symbol("object"),Hg=new $n(()=>new x,20);class KA{constructor(t,e,i,n,o,r){a(this,"_point");a(this,"_normal");a(this,"_tangentVelocity");a(this,"distance");a(this,"impulse");a(this,"friction");this._point=t,this.distance=e,this._normal=i,this.impulse=n,this.friction=o,this._tangentVelocity=r}get point(){return Hg.get().set(this._point.x,this._point.y,this._point.z)}get normal(){return Hg.get().set(this._normal.x,this._normal.y,this._normal.z)}get tangentVelocity(){return Hg.get().set(this._tangentVelocity.x,this._tangentVelocity.y,this._tangentVelocity.z)}}class JA{constructor(t,e,i){a(this,"contacts");a(this,"me");a(this,"_collider");a(this,"_gameObject");this.me=t,this._collider=e,this._gameObject=e.gameObject,this.contacts=i}get collider(){return this._collider}get gameObject(){return this._gameObject}get rigidBody(){var t;return(t=this.collider)==null?void 0:t.attachedRigidbody}}class ZA{constructor(t,e){a(this,"object");a(this,"collider");this.object=t,this.collider=e}}const tt=S("debugnetworkingstreams");var at;(function(s){s.Connected="peer-user-connected",s.StreamReceived="receive-stream",s.StreamEnded="call-ended",s.Disconnected="peer-user-disconnected",s.UserJoined="user-joined"})(at||(at={}));class f1{constructor(t,e){a(this,"type",at.StreamEnded);a(this,"userId");a(this,"direction");this.userId=t,this.direction=e}}class e2{constructor(t,e,i){a(this,"type",at.StreamReceived);a(this,"userId");a(this,"stream");a(this,"target");this.userId=t,this.stream=e,this.target=i}}class t2{constructor(t,e){a(this,"guid");a(this,"peerId");a(this,"dontSave",!0);this.guid=t.id,this.peerId=e}}var Lo;(function(s){s.Incoming="incoming",s.Outgoing="outgoing"})(Lo||(Lo={}));class i2 extends Z_{constructor(e,i,n,o=null){super();a(this,"peerId");a(this,"userId");a(this,"direction");a(this,"call");a(this,"_stream",null);a(this,"_isDisposed",!1);this.peerId=i.peer,this.userId=e,this.call=i,this.direction=n,this._stream=o,i.on("stream",r=>{if(tt&&console.log("Receive stream",`
Audio:`,r.getAudioTracks(),`
Video:`,r.getVideoTracks()),this._stream=r,n===Lo.Incoming){const l=new e2(e,r,this);this.dispatchEvent(l)}}),i.on("close",()=>{this.dispatchEvent(new f1(e,n))})}get stream(){return this._stream}close(){this._isDisposed||(this._isDisposed=!0,this.call.close(),Bo(this._stream))}get isOpen(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connected"}get isOpening(){var e;return((e=this.call.peerConnection)==null?void 0:e.connectionState)==="connecting"}get isClosed(){return!this.isOpen||this._isDisposed}}function kx(s){return s=s.replace("a=fmtp:111 minptime=10;useinbandfec=1","a=fmtp:111 ptime=5;useinbandfec=1;stereo=1;maxplaybackrate=48000;maxaveragebitrat=128000;sprop-stereo=1"),s}const tc=class extends Z_{constructor(e,i){var o;super();a(this,"updateCalls",()=>{var e;for(let i=this._incomingCalls.length-1;i>=0;i--){const n=this._incomingCalls[i];n.isClosed&&!n.isOpening&&this._incomingCalls.splice(i,1)}for(let i=this._outgoingCalls.length-1;i>=0;i--){const n=this._outgoingCalls[i];let o=!1;n.isClosed&&!n.isOpening&&((e=n.stream)!=null&&e.active?tt&&console.warn("!!! Stream is still active, don't remove call",n.userId,"Your id: "+this.context.connection.connectionId):(tt&&console.warn("!!! Remove closed call",n.userId),o=!0)),this.context.connection.userIsInRoom(n.userId)===!1&&(tt&&console.warn("!!! User is not in room anymore, remove call",n.userId),o=!0),o&&(n.close(),this._outgoingCalls.splice(i,1))}});a(this,"id");a(this,"context");a(this,"_incomingCalls",[]);a(this,"_outgoingCalls",[]);a(this,"_peer");a(this,"_enabled",!1);a(this,"_enabledPeer",!1);a(this,"onConnectRoomFn",this.onConnectRoom.bind(this));a(this,"onPeerConnect",e=>{if(tt&&console.log("PEER opened as",e),e===null){console.error("Peer connection failed",e);return}this.context.connection.send(at.Connected,new t2(this,e))});a(this,"onPeerClose",()=>{tt&&console.log("PEER closed"),this.updateCalls()});a(this,"onPeerDisconnected",()=>{tt&&console.log("PEER disconnected"),this.updateCalls()});a(this,"onPeerError",e=>{tt&&console.error("PEER error",e)});a(this,"onPeerReceivingCall",e=>{e.answer(void 0,{sdpTransform:i=>kx(i)}),this.registerCall(e,Lo.Incoming,null)});this.context=e,this.id=i,this.setupPeer();const n=(o=Object.getOwnPropertyDescriptor(navigator,"getUserMedia"))==null?void 0:o.writable;try{n?navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia:tt&&console.warn("[PeerJs] getUserMedia is not writable")}catch(r){tt&&console.error("[PeerJs] Error setting getUserMedia",r)}}static getOrCreate(e,i){if(tc.instances.has(i))return tc.instances.get(i);const n=new tc(e,i);return tc.instances.set(i,n),n}getMyPeerId(){if(this.context.connection.connectionId)return this.getPeerIdFromUserId(this.context.connection.connectionId)}getPeerIdFromUserId(e){return this.id+"-"+e}getUserIdFromPeerId(e){return e.substring(this.id.length+1)}makeCall(e,i){var r;if(!(i!=null&&i.id)){tt?console.warn("Can not make a call: mediastream has no id or is undefined"):console.debug("Can not make a call: mediastream has no id or is undefined");return}const n={metadata:{userId:this.context.connection.connectionId,streamId:i.id},sdpTransform:l=>kx(l)},o=(r=this._peer)==null?void 0:r.call(e,i,n);if(o){const l=this.registerCall(o,Lo.Outgoing,i);return tt&&console.warn(`ðŸ“ž CALL ${e}`,`
Outgoing:`,this._outgoingCalls,`
Incoming:`,this._incomingCalls),l}else tt&&console.error("Failed to make call",e,i,this._peer)}closeAll(){for(const e of this._incomingCalls)e.close();for(const e of this._outgoingCalls)e.close();this.updateCalls()}get peer(){return this._peer}get incomingCalls(){return this._incomingCalls}enable(){this._enabled||(this._enabled=!0,this.context.connection.beginListen(se.JoinedRoom,this.onConnectRoomFn),this.subscribePeerEvents())}disable(){this._enabled&&(this._enabled=!1,this.context.connection.stopListen(se.JoinedRoom,this.onConnectRoomFn),this.unsubscribePeerEvents())}onConnectRoom(){this.setupPeer()}setupPeer(){if(this.context.connection.connectionId&&!this._enabledPeer){if(this._enabledPeer=!0,!this._peer){const e=this.getMyPeerId();e?this._peer=Xk(e):console.error("Failed to setup peerjs because we dont have a connection id",this.context.connection.connectionId)}this._enabled&&this.subscribePeerEvents()}}subscribePeerEvents(){this._peer&&(this._peer.on("open",this.onPeerConnect),this._peer.on("close",this.onPeerClose),this._peer.on("call",this.onPeerReceivingCall),this._peer.on("disconnected",this.onPeerDisconnected),this._peer.on("error",this.onPeerError))}unsubscribePeerEvents(){this._peer&&(this._peer.off("open",this.onPeerConnect),this._peer.off("close",this.onPeerClose),this._peer.off("call",this.onPeerReceivingCall),this._peer.off("disconnected",this.onPeerDisconnected),this._peer.off("error",this.onPeerError))}registerCall(e,i,n){const o=e.metadata;(!o||!o.userId)&&console.error("Missing call metadata",e);const r=o.userId;i===Lo.Incoming&&tt?console.warn("â† Receive call from",e.metadata,e.connectionId):tt&&console.warn("â†’ Make call to",e.metadata);const l=i===Lo.Incoming?this._incomingCalls:this._outgoingCalls,c=new i2(r,e,i,n);return l.push(c),e.on("error",h=>{console.error("Call error",h)}),e.on("close",()=>{tt&&console.log("Call ended",e.metadata);const h=l.indexOf(c);h!==-1&&l.splice(h,1),c.close(),this.dispatchEvent(new f1(r,i))}),c.addEventListener(at.StreamEnded,h=>{this.dispatchEvent(h)}),i===Lo.Incoming&&(c.addEventListener(at.StreamReceived,h=>{this.dispatchEvent(h)}),e.on("stream",()=>{tt&&console.log("Received stream for call",e.metadata);let h=0;const d=setInterval(()=>{const u=h===0;!c.isOpen&&u&&(tt&&console.warn("Close call because stream is not active",e.metadata),h+=1,clearInterval(d),c.close())},2e3)})),c}};let fc=tc;a(fc,"instances",new Map);class gm extends Z_{constructor(e,i){super();a(this,"context");a(this,"peer");a(this,"_sendingStreams",new Map);a(this,"debug",!1);a(this,"_enabled",!1);a(this,"_tickIntervalId");a(this,"tick",()=>{this.updateSendingCalls()});a(this,"onJoinedRoom",e=>{this._sendingStreams.size>0&&(this.debug&&console.warn(`${e!=null&&e.userId?`User ${e.userId}`:"You"} joined room`,e,this._sendingStreams.size),this.updateSendingCalls())});a(this,"onLeftRoom",e=>{this.debug&&console.warn(`${(e==null?void 0:e.userId)||"You"} left room`,e),this.stopCallsToUsersThatAreNotInTheRoomAnymore(),this.peer.closeAll()});a(this,"onCallStreamReceived",e=>{this.debug&&console.log("Call with "+e.userId+" started"),this.dispatchEvent({type:at.StreamReceived,target:this,stream:e.stream,userId:e.userId}),this.debug&&this.debugLogCurrentState()});a(this,"onCallEnded",e=>{this.debug&&console.log("Call with "+e.userId+" ended"),this.dispatchEvent(e),this.debug&&this.debugLogCurrentState()});a(this,"onUserConnected",e=>{if(this.peer.id===e.guid){this.debug&&console.log("PEER USER CONNECTED",e.guid,e,this._sendingStreams.size);const i=this._sendingStreams.keys().next().value;this.peer.makeCall(e.peerId,i)}else tt&&console.log("Unknown user connected",e.guid,e.peerId)});a(this,"onUserLeft",e=>{this.debug&&console.log("User left room: "+e.userId),this.stopCallsToUsersThatAreNotInTheRoomAnymore()});if(YA(e)){const n=e;e=n.context,i=fc.getOrCreate(n.context,n.guid)}else typeof i=="string"&&(i=fc.getOrCreate(e,i));if(e){if(!(e instanceof ne))throw new Error("Failed to create NetworkedStreams because context is not an instance of Context")}else throw new Error("Failed to create NetworkedStreams because context is undefined");if(!i)throw new Error("Failed to create NetworkedStreams because peer is undefined");this.context=e,this.peer=i,tt&&(this.debug=!0)}static create(e,i){const n=fc.getOrCreate(e.context,i||e.context.connection.connectionId||e.guid);return new gm(e.context,n)}startSendingStream(e){this._sendingStreams.has(e)?console.warn("Received start sending stream with stream that is already being sent"):(this._sendingStreams.set(e,[]),this.updateSendingCalls())}stopSendingStream(e){if(e){const i=this._sendingStreams.get(e);if(i){for(const n of i)n.close();i.length=0}this._sendingStreams.delete(e),i&&this.debug&&this.debugLogCurrentState()}this.updateSendingCalls()}get enabled(){return this._enabled}enable(){this._enabled||(this._enabled=!0,this.peer.enable(),this.peer.addEventListener(at.StreamReceived,this.onCallStreamReceived),this.peer.addEventListener(at.StreamEnded,this.onCallEnded),this.context.connection.beginListen(at.Connected,this.onUserConnected),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.UserJoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.UserLeftRoom,this.onUserLeft),this.context.connection.beginListen(se.LeftRoom,this.onLeftRoom),this._tickIntervalId=setInterval(this.tick,5e3))}disable(){this._enabled&&(this._enabled=!1,this.peer.disable(),this.peer.removeEventListener(at.StreamReceived,this.onCallStreamReceived),this.peer.removeEventListener(at.StreamEnded,this.onCallEnded),this.context.connection.stopListen(at.Connected,this.onUserConnected),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.UserJoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.UserLeftRoom,this.onUserLeft),this.context.connection.stopListen(se.LeftRoom,this.onLeftRoom),this._tickIntervalId!=null&&(clearInterval(this._tickIntervalId),this._tickIntervalId=void 0))}updateSendingCalls(){const e=this.context.connection.connectionId;for(const i of this._sendingStreams.keys()){const n=this._sendingStreams.get(i)||[];for(const o of this.context.connection.usersInRoom()){if(o===e)continue;const r=this.peer.getPeerIdFromUserId(o);if(n.find(c=>{var h;return c.peerId===r&&c.direction===Lo.Outgoing&&!c.isClosed&&((h=c.stream)==null?void 0:h.active)}))tt&&console.debug("Already have a call with user "+o+" / peer "+r);else{const c=this.peer.makeCall(r,i);c&&n.push(c)}}this._sendingStreams.set(i,n)}this.stopCallsToUsersThatAreNotInTheRoomAnymore()}stopCallsToUsersThatAreNotInTheRoomAnymore(){for(const e of this._sendingStreams.keys()){const i=this._sendingStreams.get(e);if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];this.context.connection.userIsInRoom(o.userId)?tt&&(this.context.connection.connectionId===o.userId?console.warn(`You are still in the room [${n}] ${o.userId}`):console.log(`User is still in room [${n}] ${o.userId}`)):(tt&&console.log(`Remove call ${[n]} to user that is not in room anymore ${o.userId}`),o.close(),i.splice(n,1))}}this.peer.updateCalls(),this.debug&&this.debugLogCurrentState()}debugLogCurrentState(){console.warn(`You (${this.context.connection.connectionId}) are currently sending ${this._sendingStreams.size} and receiving ${this.peer.incomingCalls.length} calls (${this.peer.incomingCalls.map(e=>e.userId).join(", ")})`,this.peer.incomingCalls)}}function Bo(s){if(s&&s instanceof MediaStream)for(const t of s.getTracks())t.stop()}var jb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const n2="noVoip",s2=S("debugvoip");class dl extends j{constructor(){super(...arguments);a(this,"autoConnect",!0);a(this,"runInBackground",!0);a(this,"createMenuButton",!0);a(this,"debug",!1);a(this,"_net");a(this,"_menubutton");a(this,"_allowSending",!0);a(this,"_outputStream",null);a(this,"onJoinedRoom",async()=>{this.debug&&console.log("VOIP: Joined room"),await Ko(300),this.autoConnect&&!this.isSending&&this._allowSending&&this.connect()});a(this,"onLeftRoom",()=>{this.debug&&console.log("VOIP: Left room"),this.disconnect();for(const e of this._incomingStreams.values())Bo(e.srcObject);this._incomingStreams.clear()});a(this,"_incomingStreams",new Map);a(this,"onReceiveStream",e=>{const i=e.target.userId,n=e.stream;let o=this._incomingStreams.get(i);o||(o=new Audio,this._incomingStreams.set(i,o)),o.srcObject=n,o.setAttribute("autoplay","true"),ls.registerWaitForInteraction(()=>{o==null||o.play().catch(r=>{console.error("VOIP: Failed to play audio",r)})})});a(this,"onStreamEnded",e=>{const i=this._incomingStreams.get(e.userId);Bo(i==null?void 0:i.srcObject),this._incomingStreams.delete(e.userId)});a(this,"onEnabledChanged",()=>{for(const e of this._incomingStreams){const i=e[1];i.muted=!this.enabled}});a(this,"onVisibilityChanged",()=>{if(this.runInBackground)return;const i=!(document.visibilityState==="visible");this.setMuted(i);for(const n of this._incomingStreams){const o=n[1];o.muted=i}})}awake(){s2&&(this.debug=!0),this.debug&&(console.log("VOIP debugging: press 'v' to toggle mute or 'c' to toggle connect/disconnect"),window.addEventListener("keydown",async e=>{switch(e.key.toLowerCase()){case"v":console.log("MUTE?",!this.isMuted),this.setMuted(!this.isMuted);break;case"c":this.isSending?this.disconnect():this.connect();break}}),window.addEventListener("blur",()=>{console.log("VOIP: MUTE ON BLUR"),this.setMuted(!0)}),window.addEventListener("focus",()=>{console.log("VOIP: UNMUTE ON FOCUS"),this.setMuted(!1)}))}onEnable(){this._net||(this._net=gm.create(this)),this.debug&&(this._net.debug=!0),this._net.addEventListener(at.StreamReceived,this.onReceiveStream),this._net.addEventListener(at.StreamEnded,this.onStreamEnded),this._net.enable(),this.autoConnect&&this.context.connection.isConnected&&this.connect(),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.addEventListener("visibilitychange",this.onVisibilityChanged)}onDisable(){var e;this._net&&(this._net.stopSendingStream(this._outputStream),this._net.removeEventListener(at.StreamReceived,this.onReceiveStream),this._net.removeEventListener(at.StreamEnded,this.onStreamEnded),(e=this._net)==null||e.disable()),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.LeftRoom,this.onLeftRoom),this.onEnabledChanged(),this.updateButton(),window.removeEventListener("visibilitychange",this.onVisibilityChanged)}onDestroy(){var e;(e=this._menubutton)==null||e.remove(),this._menubutton=void 0}get isSending(){return this._outputStream!=null&&this._outputStream.active}async connect(e){var i,n;if(!this._net)return console.error("Cannot connect to voice chat - NetworkedStreams not initialized. Make sure the component is enabled before calling this method."),!1;if(this.context.connection.isConnected){if(!await K.microphonePermissionsGranted())return console.error("Cannot connect to voice chat - microphone permissions not granted"),this.updateButton(),!1}else return console.error("Cannot connect to voice chat - not connected to server"),this.updateButton(),!1;return this._allowSending=!0,(i=this._net)==null||i.stopSendingStream(this._outputStream),Bo(this._outputStream),this._outputStream=await this.getAudioStream(e),this._outputStream?(this.debug&&console.log("VOIP: Got audio stream"),(n=this._net)==null||n.startSendingStream(this._outputStream),this.updateButton(),!0):(this.updateButton(),await K.microphonePermissionsGranted()?console.error("VOIP: Could not get audio stream - please make sure to connect an audio device and grant microphone permissions"):tm("Microphone permissions not granted: Please grant microphone permissions to use voice chat"),(this.debug||U())&&console.log("VOIP: Failed to get audio stream"),!1)}disconnect(e){var i;e!=null&&e.remember&&(this._allowSending=!1),(i=this._net)==null||i.stopSendingStream(this._outputStream),Bo(this._outputStream),this._outputStream=null,this.updateButton()}setMuted(e){var n;const i=(n=this._outputStream)==null?void 0:n.getAudioTracks();if(i)for(const o of i)o.enabled=!e}get isMuted(){var i;if(this._outputStream===null)return!1;const e=(i=this._outputStream)==null?void 0:i.getAudioTracks();if(e){for(const n of e)if(!n.enabled)return!0}return!1}async updateButton(){var e;if(this.createMenuButton){if(this._menubutton||(this._menubutton=document.createElement("button"),this._menubutton.addEventListener("click",()=>{this.isSending?this.disconnect({remember:!0}):this.connect(),K.microphonePermissionsGranted().then(i=>{i||ke("<strong>Microphone permissions not granted</strong>. Please allow your browser to use the microphone to be able to talk. Click on the button on the left side of your browser's address bar to allow microphone permissions.")})})),this._menubutton){this.context.menu.appendChild(this._menubutton),this.activeAndEnabled?this._menubutton.style.display="":this._menubutton.style.display="none",this._menubutton.title=this.isSending?"Click to disable your microphone":"Click to enable your microphone";let i=(this.isSending,""),n=this.isSending?"mic":"mic_off";await K.microphonePermissionsGranted()||(i="No Permission",n="mic_off",this._menubutton.title="Microphone permissions not granted. Please allow your browser to use the microphone to be able to talk. This can usually be done in the addressbar of the webpage."),this._menubutton.innerText=i,this._menubutton.prepend(mi(n)),this.context.connection.isConnected==!1?this._menubutton.setAttribute("disabled",""):this._menubutton.removeAttribute("disabled")}}else this.activeAndEnabled||(e=this._menubutton)==null||e.remove()}getFrequency(e){return this.unsupported_getfrequency||(this.unsupported_getfrequency=!0,U()&&ke("VOIP: getFrequency is currently not supported"),console.warn("VOIP: getFrequency is currently not supported")),null}async getAudioStream(e){if(!navigator.mediaDevices.getUserMedia)return console.error("No getDisplayMedia support"),null;const i=async o=>await navigator.mediaDevices.getUserMedia({audio:o??!0,video:!1}).catch(r=>(console.warn("VOIP failed getting audio stream",r),null)),n=await i(e);if(!n)return null;if(K.isiOS()&&(e==null?void 0:e.deviceId)===void 0){const r=(await navigator.mediaDevices.enumerateDevices()).find(l=>(l.kind==="audioinput"||l.kind==="audiooutput")&&!l.label.includes("iPhone"));if(r){const l=Object.assign({},e);return l.deviceId=r.deviceId,await i(l)}}return n}}jb([m()],dl.prototype,"autoConnect",void 0);jb([m()],dl.prototype,"runInBackground",void 0);jb([m()],dl.prototype,"createMenuButton",void 0);var p1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const o2=S("debugmouth");class ym extends j{constructor(){super(...arguments);a(this,"idle",[]);a(this,"talking",[]);a(this,"marker",null);a(this,"voip",null);a(this,"lastMouthChangeTime",0);a(this,"mouthChangeLength",0)}awake(){setTimeout(()=>{this.voip=C.findObjectOfType(dl,this.context),this.marker||(this.marker=C.getComponentInParent(this.gameObject,Lt))},3e3)}update(){var n;if(!this.voip||this.context.time.frameCount%10!==0)return;let e=((n=this.marker)==null?void 0:n.connectionId)??null;if(!e){o2&&(e=null);return}const i=this.voip.getFrequency(e)??0;this.updateLips(i)}updateLips(e){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&e>30){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,i)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const i=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,i)}}}setMouthShapeActive(e,i){if(e){e!=this.idle?this.idle.map(n=>n.visible=!1):this.talking.map(n=>n.visible=!1);for(let n=0;n<e.length;n++){const o=e[n];o&&(o.visible=n===i)}}}}p1([m(D)],ym.prototype,"idle",void 0);p1([m(D)],ym.prototype,"talking",void 0);class m1 extends j{constructor(){super(...arguments);a(this,"voip",null);a(this,"marker",null);a(this,"_startPosition",null)}awake(){this.voip=C.findObjectOfType(dl,this.context),this.marker=C.getComponentInParent(this.gameObject,Lt)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!==0)return;const e=this.marker.connectionId,i=this.voip.getFrequency(e);if(i==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());const n=i/100;this.gameObject.position.y=this._startPosition.y+n*.07}}var r2=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const jl=S("debugxrflags"),g1=S("disablexrflags");g1&&console.warn("XRFlags are disabled");var Fn;(function(s){s[s.Never=0]="Never",s[s.Browser=1]="Browser",s[s.AR=2]="AR",s[s.VR=4]="VR",s[s.FirstPerson=8]="FirstPerson",s[s.ThirdPerson=16]="ThirdPerson",s[s.All=4294967295]="All"})(Fn||(Fn={}));const P0=class{constructor(){a(this,"Mask",Fn.Browser|Fn.ThirdPerson)}Has(t){return(this.Mask&t)!==0}Set(t){jl&&console.warn("Set XR flag state to",t),this.Mask=t,Qt.Apply()}Enable(t){this.Mask|=t,Qt.Apply()}Disable(t){this.Mask&=~t,Qt.Apply()}Toggle(t){this.Mask^=t,Qt.Apply()}EnableAll(){this.Mask=-1,Qt.Apply()}DisableAll(){this.Mask=0,Qt.Apply()}};let Ii=P0;a(Ii,"Global",new P0);const Is=class extends j{constructor(){super(...arguments);a(this,"visibleIn")}static Apply(){for(const e of this.registry)e.UpdateVisible(Ii.Global)}awake(){Is.registry.push(this)}onEnable(){Is.firstApply?this.UpdateVisible(Ii.Global):(Is.firstApply=!0,Is.Apply())}onDestroy(){const e=Is.registry.indexOf(this);e>=0&&Is.registry.splice(e,1)}get isOn(){return this.gameObject.visible}UpdateVisible(e=null){if(g1)return;let i;const n=e;if(n&&typeof n=="number"&&(console.assert(typeof n=="number","XRFlag.UpdateVisible: state must be a number",n),jl&&console.log(n),Is.buffer.Mask=n,e=Is.buffer),e instanceof Ii?(jl&&console.warn(this.name,"use passed in mask",e.Mask,this.visibleIn),i=e.Has(this.visibleIn)):(jl&&console.log(this.name,"use global mask"),Ii.Global.Has(this.visibleIn)),i!==void 0)if(i)jl&&console.log(this.name,"is visible",this.gameObject.uuid),C.setActive(this.gameObject,!0);else{if(jl&&console.log(this.name,"is not visible",this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}};let Qt=Is;a(Qt,"registry",[]),a(Qt,"firstApply"),a(Qt,"buffer",new Ii);r2([m()],Qt.prototype,"visibleIn",void 0);var _m=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class zc extends j{constructor(){super(...arguments);a(this,"eyes",[]);a(this,"lastBlinkTime",0);a(this,"blinkLength",0);a(this,"eyesOpen",!0);a(this,"state",null)}awake(){this.state=C.getComponentInParent(this.gameObject,Qt)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const i of this.eyes)i&&(i.visible=this.eyesOpen)}}}_m([m(D)],zc.prototype,"eyes",void 0);_m([m()],zc.prototype,"lastBlinkTime",void 0);_m([m()],zc.prototype,"blinkLength",void 0);_m([m()],zc.prototype,"eyesOpen",void 0);var Bb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const R0=class extends j{constructor(){super(...arguments);a(this,"head",null);a(this,"eyes",null);a(this,"target",null);a(this,"brain",null);a(this,"vec",new x);a(this,"currentTargetPoint",new x)}awake(){this.brain||(this.brain=C.getComponentInParent(this.gameObject,hp)),this.brain||(this.brain=C.addComponent(this.gameObject,hp)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const e=this.target;if(e&&this.head){const i=this.eyes;if(i){const n=ae(e);this.currentTargetPoint.lerp(n,this.context.time.deltaTime/.1);const o=ae(this.head),r=this.vec.copy(this.currentTargetPoint).sub(o).normalize();if(r.length()<.1)return;const l=R0.forward;if(l.set(0,0,1),l.applyQuaternion(Le(this.head)),l.dot(r)>.45)for(let h=0;h<i.length;h++)i[h].lookAt(this.currentTargetPoint)}}}};let Ur=R0;a(Ur,"forward",new x(0,0,1));Bb([m(D)],Ur.prototype,"head",void 0);Bb([m(D)],Ur.prototype,"eyes",void 0);Bb([m(D)],Ur.prototype,"target",void 0);var Fb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class au extends j{constructor(){super(...arguments);a(this,"length",1);a(this,"depthTest",!0);a(this,"isGizmo",!1);a(this,"_axes",null)}onEnable(){if(this.isGizmo&&!iu)return;this._axes||(this._axes=new yn(this.length)),this._axes.layers.disableAll(),this._axes.layers.set(this.layer),this.gameObject.add(this._axes);const e=this._axes.material;e&&e.depthTest!==void 0&&(e.depthTest=this.depthTest)}onDisable(){this._axes&&this.gameObject.remove(this._axes)}}Fb([m()],au.prototype,"length",void 0);Fb([m()],au.prototype,"depthTest",void 0);Fb([m()],au.prototype,"isGizmo",void 0);class y1 extends j{constructor(){super(...arguments);a(this,"from");a(this,"to");a(this,"hint");a(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;const e=ae(this.to).clone(),i=ae(this.from).clone(),n=e.distanceTo(i),o=e.clone();o.sub(i);const r=i.clone();r.add(e),r.multiplyScalar(.5);const l=ae(this.hint).clone();l.sub(r);const c=new x;c.crossVectors(l,o),c.crossVectors(o,c),c.normalize();const h=n*.5,d=Math.max(this.desiredDistance,h),u=Math.sqrt(d*d-h*h),f=c.clone();f.multiplyScalar(u),f.add(r),ei(this.gameObject,f);const p=r.clone();p.sub(c),this.gameObject.lookAt(p)}}const a2=S("gizmos"),l2=S("debugboxhelper"),Jn=class extends j{constructor(){super(...arguments);a(this,"box",null);a(this,"_lastMatrixUpdateFrame",-1);a(this,"_helper",null);a(this,"_color",null)}isInBox(e){var n;if(!e)return;if(this.box||(this.box=new Nn),Qi([e],void 0,void 0,Jn.testBox),Jn.testBox.isEmpty()){const o=ae(e,Jn._position);Jn.testBox.setFromCenterAndSize(o,Jn._emptyObjectSize)}this.updateBox();const i=(n=this.box)==null?void 0:n.intersectsBox(Jn.testBox);return i&&l2&&G.DrawWireBox3(Jn.testBox,16711680,5),i}intersects(e){return e?this.updateBox(!1).intersectsBox(e):!1}updateBox(e=!1){if(this.box||(this.box=new Nn),e||this.context.time.frameCount!=this._lastMatrixUpdateFrame){const i=this._lastMatrixUpdateFrame<0;this._lastMatrixUpdateFrame=this.context.time.frameCount;const n=i,o=ae(this.gameObject,Jn._position,n),r=_t(this.gameObject,Jn._size);this.box.setFromCenterAndSize(o,r)}return this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(e=null,i=!1){var n;if(!(!a2&&!i)){if(this._helper){e&&((n=this._color)==null||n.set(e)),this.gameObject.add(this._helper);return}this._helper=vb(e),this.gameObject.add(this._helper)}}};let un=Jn;a(un,"testBox",new Nn),a(un,"_position",new x),a(un,"_size",new x(.01,.01,.01)),a(un,"_emptyObjectSize",new x(.01,.01,.01));var Ki=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class wn extends j{constructor(){super(...arguments);a(this,"attachedRigidbody",null);a(this,"isTrigger",!1);a(this,"sharedMaterial");a(this,"membership",[0]);a(this,"filter");a(this,"updateProperties",()=>{var e;(e=this.context.physics.engine)==null||e.updateProperties(this)})}get isCollider(){return!0}awake(){super.awake(),this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(xe))}start(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(xe))}onEnable(){this.attachedRigidbody||(this.attachedRigidbody=this.gameObject.getComponentInParent(xe))}onDisable(){var e;(e=this.context.physics.engine)==null||e.removeBody(this)}get body(){var e;return(e=this.context.physics.engine)==null?void 0:e.getBody(this)}updatePhysicsMaterial(){var e;(e=this.context.physics.engine)==null||e.updatePhysicsMaterial(this)}}Ki([m(xe)],wn.prototype,"attachedRigidbody",void 0);Ki([m()],wn.prototype,"isTrigger",void 0);Ki([m()],wn.prototype,"sharedMaterial",void 0);Ki([m()],wn.prototype,"membership",void 0);Ki([m()],wn.prototype,"filter",void 0);class lu extends wn{constructor(){super(...arguments);a(this,"radius",.5);a(this,"center",new x(0,0,0))}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addSphereCollider(this),ob(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),nS(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}}Ki([vi(),m()],lu.prototype,"radius",void 0);Ki([m(x)],lu.prototype,"center",void 0);class ul extends wn{constructor(){super(...arguments);a(this,"size",new x(1,1,1));a(this,"center",new x(0,0,0))}static add(e,i){const n=Ks(e,ul);return n.autoFit(),(i==null?void 0:i.rigidbody)===!0&&Ks(e,xe,{isKinematic:!1}),n}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addBoxCollider(this,this.size),ob(this.gameObject.scale,this.updateProperties)}onDisable(){super.onDisable(),nS(this.gameObject.scale,this.updateProperties)}onValidate(){this.updateProperties()}autoFit(e){const i=this.gameObject,n=i.position.clone(),o=i.quaternion.clone(),r=i.scale.clone(),l=i.parent;i.position.set(0,0,0),i.quaternion.set(0,0,0,1),i.scale.set(1,1,1),i.parent=null,i.updateMatrix();const c=Qi([i]);i.position.copy(n),i.quaternion.copy(o),i.scale.copy(r),i.parent=l,(e==null?void 0:e.debug)===!0&&G.DrawWireBox3(c,16768256,20),this.size=c.getSize(new x)||new x(1,1,1),this.center=c.getCenter(new x)||new x(0,0,0),this.size.length()<=0&&this.size.set(.01,.01,.01)}}Ki([vi(),m(x)],ul.prototype,"size",void 0);Ki([m(x)],ul.prototype,"center",void 0);class fl extends wn{constructor(){super(...arguments);a(this,"sharedMesh");a(this,"convex",!1)}onEnable(){var i,n,o;if(super.onEnable(),!this.context.physics.engine)return;(i=this.sharedMesh)!=null&&i.isMesh||(this.gameObject instanceof X||this.gameObject instanceof Ar)&&(this.sharedMesh=this.gameObject);const e=0;if((n=this.sharedMesh)!=null&&n.isMesh)this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex),pt.assignMeshLOD(this.sharedMesh,e).then(r=>{r&&this.activeAndEnabled&&this.context.physics.engine&&this.sharedMesh&&(this.context.physics.engine.removeBody(this),this.sharedMesh.geometry=r,this.context.physics.engine.addMeshCollider(this,this.sharedMesh,this.convex))});else{const r=this.sharedMesh;if(r!=null&&r.isGroup){console.warn(`MeshCollider mesh is a group "${((o=this.sharedMesh)==null?void 0:o.name)||this.gameObject.name}", adding all children as colliders. This is currently not fully supported (colliders can not be removed from world again)`,this);const l=new Array;for(const c in r.children){const h=r.children[c];h.isMesh&&(this.context.physics.engine.addMeshCollider(this,h,this.convex),l.push(pt.assignMeshLOD(h,e)))}Promise.all(l).then(c=>{var d,u;if(c.some(f=>f)==!1)return;(d=this.context.physics.engine)==null||d.removeBody(this);const h=new X;for(const f of c)f&&this.activeAndEnabled&&(h.geometry=f,(u=this.context.physics.engine)==null||u.addMeshCollider(this,h,this.convex))})}else(U()||S("showcolliders"))&&console.warn(`[MeshCollider] A MeshCollider mesh is assigned to an unknown object on "${this.gameObject.name}", but it's neither a Mesh nor a Group. Please double check that you attached the collider component to the right object and report a bug otherwise!`,this)}}}Ki([m(X)],fl.prototype,"sharedMesh",void 0);Ki([m()],fl.prototype,"convex",void 0);class qr extends wn{constructor(){super(...arguments);a(this,"center",new x(0,0,0));a(this,"radius",.5);a(this,"height",2)}onEnable(){var e;super.onEnable(),(e=this.context.physics.engine)==null||e.addCapsuleCollider(this,this.height,this.radius)}}Ki([m(x)],qr.prototype,"center",void 0);Ki([m()],qr.prototype,"radius",void 0);Ki([m()],qr.prototype,"height",void 0);var nr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ex=S("debugcharactercontroller");class Uc extends j{constructor(){super(...arguments);a(this,"center",new x(0,0,0));a(this,"radius",.5);a(this,"height",2);a(this,"_rigidbody",null);a(this,"_activeGroundCollisions");a(this,"_contactVelocity",new x)}get rigidbody(){return this._rigidbody?this._rigidbody:(this._rigidbody=this.gameObject.getComponent(xe),this._rigidbody||(this._rigidbody=this.gameObject.addComponent(xe)),this.rigidbody)}awake(){this._activeGroundCollisions=new Set}onEnable(){const e=this.rigidbody;let i=this.gameObject.getComponent(qr);i||(i=this.gameObject.addComponent(qr)),i.center.copy(this.center),i.radius=this.radius,i.height=this.height;const n=new x(0,0,1),o=new x(1,0,0),r=new x(0,1,0),l=this.gameObject.getWorldDirection(new x);l.y=0;const c=o.dot(l)<0?-1:1,h=n.angleTo(l)*c;this.gameObject.setRotationFromAxisAngle(r,h),e.lockRotationX=!0,e.lockRotationY=!0,e.lockRotationZ=!0}move(e){this.gameObject.position.add(e)}onCollisionEnter(e){(e.contacts.length==0||e.contacts.some(i=>i.normal.y>.2))&&(this._activeGroundCollisions.add(e),Ex&&console.log(`Collision(${this._activeGroundCollisions.size}): ${e.contacts.map(i=>i.normal.y.toFixed(2)).join(", ")} - ${this.isGrounded}`))}onCollisionExit(e){this._activeGroundCollisions.delete(e),Ex&&console.log(`Collision(${this._activeGroundCollisions.size}) - ${this.isGrounded}`)}get isGrounded(){return this._activeGroundCollisions.size>0}get contactVelocity(){var e;this._contactVelocity.set(0,0,0);for(const i of this._activeGroundCollisions){const n=(e=this.context.physics.engine)==null?void 0:e.getLinearVelocity(i.collider);n&&(this._contactVelocity.x+=n.x,this._contactVelocity.y+=n.y,this._contactVelocity.z+=n.z)}return this._contactVelocity}}nr([m(x)],Uc.prototype,"center",void 0);nr([m()],Uc.prototype,"radius",void 0);nr([m()],Uc.prototype,"height",void 0);class Jr extends j{constructor(){super(...arguments);a(this,"controller");a(this,"movementSpeed",2);a(this,"rotationSpeed",2);a(this,"jumpForce",1);a(this,"doubleJumpForce",2);a(this,"animator");a(this,"lookForward",!0);a(this,"lookInput",new le(0,0));a(this,"moveInput",new le(0,0));a(this,"jumpInput",!1);a(this,"_currentSpeed",new x(0,0,0));a(this,"_currentAngularSpeed",new x(0,0,0));a(this,"_temp",new x(0,0,0));a(this,"_jumpCount",0);a(this,"_currentRotation");a(this,"_raycastOptions",new Kr)}awake(){this._currentRotation=new H}update(){const e=this.context.input;e.isKeyPressed("KeyW")?this.moveInput.y+=1:e.isKeyPressed("KeyS")&&(this.moveInput.y-=1),e.isKeyPressed("KeyD")?this.lookInput.x+=1:e.isKeyPressed("KeyA")&&(this.lookInput.x-=1),this.jumpInput||(this.jumpInput=e.isKeyDown("Space"))}move(e){this.moveInput.add(e)}look(e){this.lookInput.add(e)}jump(){this.jumpInput=!0}onBeforeRender(){this.handleInput(this.moveInput,this.lookInput,this.jumpInput),this.lookInput.set(0,0),this.moveInput.set(0,0),this.jumpInput=!1}handleInput(e,i,n){var o,r,l,c,h,d,u,f,p,g,_;if((o=this.controller)!=null&&o.isGrounded&&(this._jumpCount=0,this.doubleJumpForce>0&&((r=this.animator)==null||r.setBool("doubleJump",!1))),this._currentSpeed.z+=e.y*this.movementSpeed*this.context.time.deltaTime,(l=this.animator)==null||l.setBool("running",e.length()>.01),(h=this.animator)==null||h.setBool("jumping",((c=this.controller)==null?void 0:c.isGrounded)===!0&&n),this._temp.copy(this._currentSpeed),this._temp.applyQuaternion(this.gameObject.quaternion),this.controller?this.controller.move(this._temp):this.gameObject.position.add(this._temp),this._currentAngularSpeed.y+=N.toRadians(-i.x*this.rotationSpeed)*this.context.time.deltaTime,this.lookForward&&Math.abs(this._currentAngularSpeed.y)<.01){const y=this.context.mainCameraComponent.forward;y.y=0,y.normalize(),this._currentRotation.setFromUnitVectors(new x(0,0,1),y),this.gameObject.quaternion.slerp(this._currentRotation,this.context.time.deltaTime*10)}if(this.gameObject.rotateY(this._currentAngularSpeed.y),this._currentSpeed.multiplyScalar(1-this.context.time.deltaTime*10),this._currentAngularSpeed.y*=1-this.context.time.deltaTime*10,this.controller&&n&&this.jumpForce>0){let y=(d=this.controller)==null?void 0:d.isGrounded;if(this.doubleJumpForce>0&&!((u=this.controller)!=null&&u.isGrounded)&&this._jumpCount===1&&(y=!0,(f=this.animator)==null||f.setBool("doubleJump",!0)),y){this._jumpCount+=1;const b=this.controller.rigidbody,v=this._jumpCount===2?this.doubleJumpForce:this.jumpForce;b.applyImpulse(new x(0,1,0).multiplyScalar(v))}}if(this.controller){const y=(p=this.controller)==null?void 0:p.rigidbody.getVelocity().y;if(y<-1){this._raycastOptions.ray||(this._raycastOptions.ray=new Hr),this._raycastOptions.ray.origin.copy(ae(this.gameObject)),this._raycastOptions.ray.direction.set(0,-1,0);const b=this.layer;this.gameObject.layers.disableAll(),this.gameObject.layers.set(2);const v=this.context.physics.raycast(this._raycastOptions);this.gameObject.layers.set(b),(v.length&&v[0].distance>2||y<-10)&&((g=this.animator)==null||g.setBool("falling",!0))}else(_=this.animator)==null||_.setBool("falling",!1)}}}nr([m(Uc)],Jr.prototype,"controller",void 0);nr([m()],Jr.prototype,"movementSpeed",void 0);nr([m()],Jr.prototype,"rotationSpeed",void 0);nr([m()],Jr.prototype,"jumpForce",void 0);nr([m()],Jr.prototype,"doubleJumpForce",void 0);nr([m(ii)],Jr.prototype,"animator",void 0);var Nc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ch=S("debugcontactshadows");um(s=>{const t=s.domElement.getAttribute("contactshadows")||s.domElement.getAttribute("contact-shadows");if(t!=null&&t!="0"&&t!="false"){console.debug("Auto-creating ContactShadows because of `contactshadows` attribute");const e=_n.auto(s),i=parseFloat(t);isNaN(i)||(e.opacity=i,e.darkness=i)}});const ic=class extends j{constructor(){super(...arguments);a(this,"autoFit",!1);a(this,"darkness",.5);a(this,"opacity",.5);a(this,"blur",4);a(this,"occludeBelowGround",!1);a(this,"backfaceShadows",!0);a(this,"minSize");a(this,"manualUpdate",!1);a(this,"_needsUpdate",!1);a(this,"shadowsRoot",new D);a(this,"shadowCamera");a(this,"shadowGroup",new Ar);a(this,"renderTarget");a(this,"renderTargetBlur");a(this,"plane");a(this,"occluderMesh");a(this,"blurPlane");a(this,"depthMaterial");a(this,"horizontalBlurMaterial");a(this,"verticalBlurMaterial");a(this,"textureSize",512)}static auto(e,i){if(e||(e=ne.Current),!e)throw new Error("No context provided and no current context set.");let n=this._instances.get(e);if(!n||n.destroyed){const o=new D;n=Ks(o,ic,{autoFit:!1,occludeBelowGround:!1}),this._instances.set(e,n)}return e.scene.add(n.gameObject),n.fitShadows(i),n}set needsUpdate(e){this._needsUpdate=e}get needsUpdate(){return this._needsUpdate}fitShadows(e={}){Ch&&console.warn("Fitting shadows to scene"),Dy(this.shadowsRoot,!1);const i=e.object||this.context.scene,n=Qi(i,[this.shadowsRoot]),o=Math.max(1,this.blur/32),r=n.max.x-n.min.x,l=n.max.z-n.min.z;n.expandByVector(new x(o*r,0,o*l)),Ch&&G.DrawWireBox3(n,16776960,60),this.gameObject.parent&&n.applyMatrix4(this.gameObject.parent.matrixWorld.clone().invert());const c=n.min,h=Math.max(1e-5,(n.max.y-c.y)*.002);n.max.y+=h,this.shadowsRoot.position.set((c.x+n.max.x)/2,c.y-h,(c.z+n.max.z)/2),this.shadowsRoot.scale.set(n.max.x-c.x,n.max.y-c.y,n.max.z-c.z),e.positionOffset&&(e.positionOffset.x!==void 0&&(this.shadowsRoot.position.x+=e.positionOffset.x),e.positionOffset.y!==void 0&&(this.shadowsRoot.position.y+=e.positionOffset.y),e.positionOffset.z!==void 0&&(this.shadowsRoot.position.z+=e.positionOffset.z)),e.scaleFactor&&(e.scaleFactor.x!==void 0&&(this.shadowsRoot.scale.x*=e.scaleFactor.x),e.scaleFactor.y!==void 0&&(this.shadowsRoot.scale.y*=e.scaleFactor.y),e.scaleFactor.z!==void 0&&(this.shadowsRoot.scale.z*=e.scaleFactor.z)),this.applyMinSize(),this.shadowsRoot.matrixWorldNeedsUpdate=!0,Ch&&console.log("Fitted shadows to scene",this.shadowsRoot.scale.clone())}awake(){ic._instances.set(this.context,this),this.shadowsRoot.hideFlags=dp.DontExport,Dy(this.shadowsRoot,!1)}start(){Ch&&console.log("Create ContactShadows on "+this.gameObject.name,this),this.gameObject.add(this.shadowsRoot),this.shadowsRoot.add(this.shadowGroup),this.renderTarget=new io(this.textureSize,this.textureSize),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new io(this.textureSize,this.textureSize),this.renderTargetBlur.texture.generateMipmaps=!1;const e=new ro(1,1).rotateX(Math.PI/2);this.gameObject instanceof X&&(console.warn("ContactShadows can not be added to a Mesh. Please add it to a Group or an empty Object"),Io(this.gameObject,!1));const i=new Be({map:this.renderTarget.texture,opacity:this.opacity,color:0,transparent:!0,depthWrite:!1,side:Gr});this.plane=new X(e,i),this.plane.scale.y=-1,this.plane.layers.set(2),this.shadowsRoot.add(this.plane),this.plane&&(this.plane.renderOrder=1),this.occluderMesh=new X(this.plane.geometry,new Be({depthWrite:!0,stencilWrite:!0,colorWrite:!1,side:Qp})).translateY(-1e-4),this.occluderMesh.renderOrder=-100,this.occluderMesh.layers.set(2),this.shadowsRoot.add(this.occluderMesh),this.blurPlane=new X(e),this.blurPlane.visible=!1,this.shadowGroup.add(this.blurPlane);const n=0,o=1;this.shadowCamera=new $p(-1/2,1/2,1/2,-1/2,n,o),this.shadowCamera.layers.enableAll(),this.shadowCamera.rotation.x=Math.PI/2,this.shadowGroup.add(this.shadowCamera),this.depthMaterial=new sR,this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.blending=oR,this.depthMaterial.blendEquation=rR,this.depthMaterial.onBeforeCompile=r=>{this.depthMaterial&&(r.uniforms.darkness=this.depthMaterial.userData.darkness,r.fragmentShader=`
                uniform float darkness;
                ${r.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 1.0 ), ( 1.0 - fragCoordZ ) * darkness * opacity * (gl_FrontFacing ? 1.0 : 0.66) );")}
            `)},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new to(lT),this.horizontalBlurMaterial.depthTest=!1,this.verticalBlurMaterial=new to(cT),this.verticalBlurMaterial.depthTest=!1,this.shadowGroup.visible=!1,this.autoFit?this.fitShadows():this.applyMinSize()}onEnable(){this._needsUpdate=!0}onDestroy(){var i,n,o,r,l,c,h,d;ic._instances.get(this.context)===this&&ic._instances.delete(this.context),(i=this.renderTarget)==null||i.dispose(),(n=this.renderTargetBlur)==null||n.dispose(),(o=this.depthMaterial)==null||o.dispose(),(r=this.horizontalBlurMaterial)==null||r.dispose(),(l=this.verticalBlurMaterial)==null||l.dispose(),(c=this.blurPlane)==null||c.geometry.dispose(),(h=this.plane)==null||h.geometry.dispose(),(d=this.occluderMesh)==null||d.geometry.dispose()}onBeforeRender(e){if(this.manualUpdate&&!this._needsUpdate)return;if(this._needsUpdate=!1,!this.renderTarget||!this.renderTargetBlur||!this.depthMaterial||!this.shadowCamera||!this.blurPlane||!this.shadowGroup||!this.plane||!this.horizontalBlurMaterial||!this.verticalBlurMaterial){Ch&&console.error("ContactShadows: not initialized yet");return}const i=this.context.scene,n=this.context.renderer,o=n.getRenderTarget();this.shadowGroup.visible=!0,this.occluderMesh&&(this.occluderMesh.visible=!1);const r=this.plane.visible;this.plane.visible=!1,this.gameObject instanceof X&&Io(this.gameObject,!1);const l=i.background;i.background=null,i.overrideMaterial=this.depthMaterial,this.backfaceShadows?this.depthMaterial.side=vn:this.depthMaterial.side=Gr;const c=n.getClearAlpha();n.setClearAlpha(0);const h=n.xr.enabled;n.xr.enabled=!1;const d=this.context.scene.matrixWorldAutoUpdate;this.context.scene.matrixWorldAutoUpdate=!1;const u=n.renderLists.get(i,0),f=u.transparent;Mx.length=0,u.transparent=Mx,Gg.length=0;for(const g of u.opaque){if(!g.object.visible)continue;const _=g.material;let y=g.material.colorWrite==!1||_.wireframe===!0||kO(g.object)===!1;!y&&g.material.isLineMaterial&&(y=!0),!y&&g.material.isPointsMaterial&&(y=!0),y&&(Gg.push(g.object),g.object["needle:visible"]=g.object.visible,g.object.visible=!1)}n.setRenderTarget(this.renderTarget),n.clear(),n.render(i,this.shadowCamera),u.transparent=f;for(const g of Gg)g["needle:visible"]!=null&&(g.visible=g["needle:visible"]);i.overrideMaterial=null;const p=Math.max(this.blur,.05);this.blurShadow(p*2),this.blurShadow(p*.5),this.shadowGroup.visible=!1,this.occluderMesh&&(this.occluderMesh.visible=this.occludeBelowGround),this.plane.visible=r,n.setRenderTarget(o),n.setClearAlpha(c),i.background=l,n.xr.enabled=h,this.context.scene.matrixWorldAutoUpdate=d}blurShadow(e){if(!this.blurPlane||!this.shadowCamera||!this.renderTarget||!this.renderTargetBlur||!this.horizontalBlurMaterial||!this.verticalBlurMaterial)return;this.blurPlane.visible=!0;const i=this.shadowsRoot.worldScale,n=(i.x+i.z)/2,o=i.z/n,r=i.x/n;this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=e*1/this.textureSize*o;const l=this.context.renderer,c=l.getRenderTarget();l.setRenderTarget(this.renderTargetBlur),l.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=e*1/this.textureSize*r,l.setRenderTarget(this.renderTarget),l.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1,l.setRenderTarget(c)}applyMinSize(){this.minSize&&this.shadowsRoot.scale.set(Math.max(this.minSize.x||0,this.shadowsRoot.scale.x),Math.max(this.minSize.y||0,this.shadowsRoot.scale.y),Math.max(this.minSize.z||0,this.shadowsRoot.scale.z))}};let _n=ic;a(_n,"_instances",new Map);Nc([m()],_n.prototype,"autoFit",void 0);Nc([m()],_n.prototype,"darkness",void 0);Nc([m()],_n.prototype,"opacity",void 0);Nc([m()],_n.prototype,"blur",void 0);Nc([m()],_n.prototype,"occludeBelowGround",void 0);Nc([m()],_n.prototype,"backfaceShadows",void 0);const Mx=[],Gg=new Array,c2=S("logstats");class _1 extends j{onEnable(){console.log(this),c2&&this.startCoroutine(this.run(),oe.OnAfterRender)}*run(){for(;this.enabled;){const t=this.context.renderer.info;console.log(t.memory,t.render,t.programs),yield}}}class bm extends j{constructor(){super(...arguments);a(this,"isUsed",!0);a(this,"usedBy",null)}}class b1 extends j{}const Ax=S("debugdeletable"),Ad=class extends un{onEnable(){Ad._instances.push(this)}onDisable(){const t=Ad._instances.indexOf(this);t>=0&&Ad._instances.splice(t,1)}};let pc=Ad;a(pc,"_instances",[]);class v1 extends j{update(){for(const t of pc._instances){const e=this.gameObject;if(t.isInBox(e)===!0){const n=C.getComponentInParent(this.gameObject,bm);if(n)Ax&&console.warn("DeleteBox: Not deleting object with usage marker",this.guid,n);else{if(Ax)try{if(t.box){const o=t.box,r=un.testBox;G.DrawWireBox3(o,16711680,5),G.DrawWireBox3(r,255,5),console.log("DeleteBox: Destroying",this.gameObject,{deleteBoxArea:o,deletedObjectArea:r})}else console.log("DeleteBox: Destroying",this.gameObject)}catch{}rm(this.gameObject,this.context.connection)}}}}}var h2=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},up;(function(s){s[s.Never=0]="Never",s[s.Desktop=1]="Desktop",s[s.Mobile=2]="Mobile"})(up||(up={}));class zb extends j{constructor(){super(...arguments);a(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||C.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:K.isMobileDevice()?(this.visibleOn&up.Mobile)!==0:(this.visibleOn&up.Desktop)!==0}}h2([m()],zb.prototype,"visibleOn",void 0);var pl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Gs=S("debugdrag"),qg=[];var pi;(function(s){s[s.XZPlane=0]="XZPlane",s[s.Attached=1]="Attached",s[s.HitNormal=2]="HitNormal",s[s.DynamicViewAngle=3]="DynamicViewAngle",s[s.SnapToSurfaces=4]="SnapToSurfaces",s[s.None=5]="None"})(pi||(pi={}));const an=class extends j{constructor(){super(...arguments);a(this,"dragMode",pi.DynamicViewAngle);a(this,"snapGridResolution",0);a(this,"keepRotation",!0);a(this,"xrDragMode",pi.Attached);a(this,"xrKeepRotation",!1);a(this,"xrDistanceDragFactor",1);a(this,"showGizmo",!1);a(this,"_rigidbody",null);a(this,"_targetObject",null);a(this,"_dragHelper",null);a(this,"_draggingRigidbodies",[]);a(this,"_potentialDragStartEvt",null);a(this,"_dragHandlers",new Map);a(this,"_totalMovement",new x);a(this,"_marker",null);a(this,"_isDragging",!1);a(this,"_didDrag",!1)}static get HasAnySelected(){return this._active>0}static get CurrentlySelected(){qg.length=0;for(const e of this._instances)e._isDragging&&qg.push(e);return qg}get draggedObject(){return this._targetObject}setTargetObject(e){var n,o;this._targetObject=e;for(const r of this._dragHandlers.values())r.setTargetObject(e);const i="_rigidbody-was-kinematic";((n=this._rigidbody)==null?void 0:n[i])===!1&&(this._rigidbody.isKinematic=!1,this._rigidbody[i]=void 0),this._rigidbody=null,e&&(this._rigidbody=C.getComponentInChildren(e,xe),((o=this._rigidbody)==null?void 0:o.isKinematic)===!1&&(this._rigidbody.isKinematic=!0,this._rigidbody[i]=!1))}awake(){this._potentialDragStartEvt=null,this._dragHandlers=new Map,this._totalMovement=new x,this._marker=null,this._isDragging=!1,this._didDrag=!1,this._dragHelper=null,this._draggingRigidbodies=[]}start(){this.gameObject.getComponentInParent(Vn)||this.gameObject.addComponent(Vn)}onEnable(){an._instances.push(this)}onDisable(){an._instances=an._instances.filter(e=>e!==this)}allowEdit(e=null){return this.context.connection.allowEditing}onPointerEnter(e){if(!this.allowEdit(this.gameObject)||e.mode!=="screen"||(e.event.mode==="tracked-pointer"||e.event.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===pi.None)return;const o=C.getComponentInParent(e.object,an);!o||o!==this||(an.lastHovered=e.object,this.context.domElement.style.cursor="pointer")}onPointerMove(e){(this._isDragging||this._potentialDragStartEvt!==null)&&e.use()}onPointerExit(e){this.allowEdit(this.gameObject)&&e.mode==="screen"&&an.lastHovered===e.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(e){if(!(!this.allowEdit(this.gameObject)||e.used||(e.mode==="tracked-pointer"||e.mode==="transient-pointer"?this.xrDragMode:this.dragMode)===pi.None)&&(an.lastHovered=e.object,e.button===0)){this._dragHandlers.size===0&&(this._didDrag=!1,this._totalMovement.set(0,0,0),this._potentialDragStartEvt=e),this._targetObject||this.setTargetObject(this.gameObject),an._active+=1;const o=new Xg(this,this._targetObject);if(this._dragHandlers.set(e.event.space,o),o.onDragStart(e),this._dragHandlers.size===2){const r=this._dragHandlers.values(),l=r.next().value,c=r.next().value;if(l instanceof Xg&&c instanceof Xg){const h=new d2(this,this._targetObject,l,c);this._dragHandlers.set(this.gameObject,h),h.onDragStart(e)}else console.error("Attempting to construct a MultiTouchDragHandler with invalid DragPointerHandlers. This is likely a bug.",{a:l,b:c})}e.use()}}onPointerUp(e){if(Gs&&G.DrawLabel(e.point??this.gameObject.worldPosition,"POINTERUP:"+e.pointerId+", "+e.button,.03,3),!this.allowEdit(this.gameObject)||e.button!==0)return;this._potentialDragStartEvt=null;const i=this._dragHandlers.get(e.event.space),n=this._dragHandlers.get(this.gameObject);n&&(n.handlerA===i||n.handlerB===i)&&(this._dragHandlers.delete(this.gameObject),n.onDragEnd(e)),i&&(an._active>0&&(an._active-=1),this.setTargetObject(null),i.onDragEnd&&i.onDragEnd(e),this._dragHandlers.delete(e.event.space),this._dragHandlers.size===0&&this.onLastDragEnd(e),e.use())}update(){for(const e of this._dragHandlers.values())e.collectMovementInfo&&e.collectMovementInfo(),e.getTotalMovement&&this._totalMovement.add(e.getTotalMovement());if(this._potentialDragStartEvt){if(!this._didDrag)if(this._totalMovement.length()>3e-4)this._didDrag=!0;else return;const e=this._potentialDragStartEvt;this._potentialDragStartEvt=null,this.onFirstDragStart(e)}for(const e of this._dragHandlers.values())e.onDragUpdate&&e.onDragUpdate(this._dragHandlers.size);this._dragHelper&&this._dragHelper.hasSelected&&this.onAnyDragUpdate()}onFirstDragStart(e){if(!e||!e.object)return;const i=C.getComponentInParent(e.object,an);if(!i||i!==this&&i._isDragging)return;const n=this._targetObject||this.gameObject;if(!n)return;this._isDragging=!0;const o=C.getComponentInChildren(n,oo);Gs&&console.log("DRAG START",o,n),o&&(o.fastMode=!0,o==null||o.requestOwnership()),this._marker=C.addComponent(n,bm),this._draggingRigidbodies.length=0;const r=C.getComponentsInChildren(n,xe);r&&this._draggingRigidbodies.push(...r)}onAnyDragUpdate(){if(!this._dragHelper)return;this._dragHelper.showGizmo=this.showGizmo,this._dragHelper.onUpdate(this.context);for(const i of this._draggingRigidbodies)i.wakeUp(),i.resetVelocities(),i.resetForcesAndTorques();const e=this._targetObject||this.gameObject;cs.markDirty(e)}onLastDragEnd(e){if(!this||!this._isDragging)return;this._isDragging=!1;for(const n of this._draggingRigidbodies)n.setVelocity(n.smoothedVelocity);if(this._draggingRigidbodies.length=0,this._targetObject=null,e!=null&&e.object){const n=C.getComponentInChildren(e.object,oo);n&&(n.fastMode=!1)}if(this._marker&&this._marker.destroy(),!this._dragHelper)return;const i=this._dragHelper.selected;Gs&&console.log("DRAG END",i,i==null?void 0:i.visible),this._dragHelper.setSelected(null,this.context)}};let jt=an;a(jt,"_active",0),a(jt,"_instances",[]),a(jt,"lastHovered");pl([m()],jt.prototype,"dragMode",void 0);pl([m()],jt.prototype,"snapGridResolution",void 0);pl([m()],jt.prototype,"keepRotation",void 0);pl([m()],jt.prototype,"xrDragMode",void 0);pl([m()],jt.prototype,"xrKeepRotation",void 0);pl([m()],jt.prototype,"xrDistanceDragFactor",void 0);pl([m()],jt.prototype,"showGizmo",void 0);class d2{constructor(t,e,i,n){a(this,"handlerA");a(this,"handlerB");a(this,"context");a(this,"settings");a(this,"gameObject");a(this,"_handlerAAttachmentPoint",new x);a(this,"_handlerBAttachmentPoint",new x);a(this,"_followObject");a(this,"_manipulatorObject");a(this,"_deviceMode");a(this,"_followObjectStartWorldQuaternion",new H);a(this,"_manipulatorPosOffset",new x);a(this,"_manipulatorRotOffset",new H);a(this,"_manipulatorScaleOffset",new x);a(this,"_tempVec1",new x);a(this,"_tempVec2",new x);a(this,"_tempVec3",new x);a(this,"tempLookMatrix",new ce);a(this,"_initialScale",new x);a(this,"_initialDistance",0);var r,l;this.context=t.context,this.settings=t,this.gameObject=e,this.handlerA=i,this.handlerB=n,this._followObject=new D,this._manipulatorObject=new D,this.context.scene.add(this._manipulatorObject);const o=(l=(r=te.active)==null?void 0:r.rig)==null?void 0:l.gameObject;if(!this.handlerA||!this.handlerB||!this.handlerA.hitPointInLocalSpace||!this.handlerB.hitPointInLocalSpace){console.error("Invalid: MultiTouchDragHandler needs two valid DragPointerHandlers with hitPointInLocalSpace set.");return}if(this._tempVec1.copy(this.handlerA.hitPointInLocalSpace),this._tempVec2.copy(this.handlerB.hitPointInLocalSpace),this.gameObject.localToWorld(this._tempVec1),this.gameObject.localToWorld(this._tempVec2),o&&(o.worldToLocal(this._tempVec1),o.worldToLocal(this._tempVec2)),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.02?(Gs&&console.log("Finding alternative drag attachment points since initial distance is too low: "+this._initialDistance.toFixed(2)),this.handlerA.followObject.parent.getWorldPosition(this._tempVec1),this.handlerB.followObject.parent.getWorldPosition(this._tempVec2),this._handlerAAttachmentPoint.copy(this._tempVec1),this._handlerBAttachmentPoint.copy(this._tempVec2),this.gameObject.worldToLocal(this._handlerAAttachmentPoint),this.gameObject.worldToLocal(this._handlerBAttachmentPoint),this._initialDistance=this._tempVec1.distanceTo(this._tempVec2),this._initialDistance<.001&&(console.warn("Not supported right now â€“ controller drag points for multitouch are too close!"),this._initialDistance=1)):(this._handlerAAttachmentPoint.copy(this.handlerA.hitPointInLocalSpace),this._handlerBAttachmentPoint.copy(this.handlerB.hitPointInLocalSpace)),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._initialScale.copy(e.scale),Gs){this._followObject.add(new yn(2)),this._manipulatorObject.add(new yn(5));const c=h=>`${h.x.toFixed(2)}, ${h.y.toFixed(2)}, ${h.z.toFixed(2)}`;G.DrawLine(this._tempVec1,this._tempVec2,65535,0,!1),G.DrawLabel(this._tempVec3,"A:B "+this._initialDistance.toFixed(2)+`
`+c(this._tempVec1)+`
`+c(this._tempVec2),.03,5)}}onDragStart(t){this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.matrix.identity(),this._deviceMode=t.mode,this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this.alignManipulator(),this._manipulatorObject.attach(this._followObject),this._manipulatorPosOffset.copy(this._followObject.position),this._manipulatorRotOffset.copy(this._followObject.quaternion),this._manipulatorScaleOffset.copy(this._followObject.scale)}onDragEnd(t){if(!this.handlerA||!this.handlerB){console.error("onDragEnd called on MultiTouchDragHandler without valid handlers. This is likely a bug.");return}this.handlerA.recenter(),this.handlerB.recenter(),this._manipulatorObject.removeFromParent(),this._followObject.removeFromParent(),this._manipulatorObject.destroy(),this._followObject.destroy()}alignManipulator(){if(!this.handlerA||!this.handlerB){console.error("alignManipulator called on MultiTouchDragHandler without valid handlers. This is likely a bug.",this);return}if(!this.handlerA.followObject||!this.handlerB.followObject){console.error("alignManipulator called on MultiTouchDragHandler without valid follow objects. This is likely a bug.",this.handlerA,this.handlerB);return}this._tempVec1.copy(this._handlerAAttachmentPoint),this._tempVec2.copy(this._handlerBAttachmentPoint),this.handlerA.followObject.localToWorld(this._tempVec1),this.handlerB.followObject.localToWorld(this._tempVec2),this._tempVec3.lerpVectors(this._tempVec1,this._tempVec2,.5),this._manipulatorObject.position.copy(this._tempVec3);const t=this.context.mainCamera;this.tempLookMatrix.lookAt(this._tempVec3,this._tempVec2,t.worldUp),this._manipulatorObject.quaternion.setFromRotationMatrix(this.tempLookMatrix);const e=this._tempVec1.distanceTo(this._tempVec2);this._manipulatorObject.scale.copy(this._initialScale).multiplyScalar(e/this._initialDistance),this._manipulatorObject.updateMatrix(),this._manipulatorObject.updateMatrixWorld(!0),Gs&&(G.DrawLabel(this._tempVec3.clone().add(new x(0,.2,0)),"A:B "+e.toFixed(2),.03),G.DrawLine(this._tempVec1,this._tempVec2,65280,0,!1))}onDragUpdate(){this.alignManipulator();const t=30,e=1;this._followObject.position.copy(this._manipulatorPosOffset),this._followObject.quaternion.copy(this._manipulatorRotOffset),this._followObject.scale.copy(this._manipulatorScaleOffset);const i=this.gameObject,n=this._followObject;if(!i){console.error("MultiTouchDragHandler has no dragged object. This is likely a bug.");return}n.updateMatrix(),n.updateMatrixWorld(!0);const r=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrKeepRotation:this.settings.keepRotation;if(this.settings.snapGridResolution>0){const u=this._followObject.worldPosition,f=this.settings.snapGridResolution;u.x=Math.round(u.x/f)*f,u.y=Math.round(u.y/f)*f,u.z=Math.round(u.z/f)*f,this._followObject.worldPosition=u,this._followObject.updateMatrix()}r&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const l=N.clamp01(this.context.time.deltaTime*t*e),c=i.worldPosition;c.lerp(n.worldPosition,l),i.worldPosition=c;const h=i.worldQuaternion;h.slerp(n.worldQuaternion,l),i.worldQuaternion=h;const d=i.worldScale;d.lerp(n.worldScale,l),i.worldScale=d}setTargetObject(t){this.gameObject=t}}class Xg{constructor(t,e){a(this,"context");a(this,"gameObject");a(this,"settings");a(this,"_lastRig");a(this,"_followObject");a(this,"_totalMovement",new x);a(this,"_totalMovementAlongRayDirection",0);a(this,"_grabStartDistance",0);a(this,"_deviceMode");a(this,"_followObjectStartPosition",new x);a(this,"_followObjectStartQuaternion",new H);a(this,"_followObjectStartWorldQuaternion",new H);a(this,"_lastDragPosRigSpace");a(this,"_tempVec",new x);a(this,"_tempMat",new ce);a(this,"_hitPointInLocalSpace",new x);a(this,"_hitNormalInLocalSpace",new x);a(this,"_bottomCenter",new x);a(this,"_backCenter",new x);a(this,"_backBottomCenter",new x);a(this,"_bounds",new Nn);a(this,"_dragPlane",new Za(new x(0,1,0)));a(this,"_draggedOverObject",null);a(this,"_draggedOverObjectLastSetUp",null);a(this,"_draggedOverObjectLastNormal",new x);a(this,"_draggedOverObjectDuration",0);a(this,"_hasLastSurfaceHitPoint",!1);a(this,"_lastSurfaceHitPoint",new x);this.settings=t,this.context=t.context,this.gameObject=e,this._followObject=new D}getTotalMovement(){return this._totalMovement}get followObject(){return this._followObject}get hitPointInLocalSpace(){return this._hitPointInLocalSpace}setTargetObject(t){this.gameObject=t}recenter(){var o,r;if(!this._followObject.parent){console.warn("Error: space follow object doesn't have parent but recenter() is called. This is likely a bug");return}if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}const t=this._followObject.parent;this.gameObject.add(this._followObject),this._followObject.matrixAutoUpdate=!1,this._followObject.position.set(0,0,0),this._followObject.quaternion.set(0,0,0,1),this._followObject.scale.set(1,1,1),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0),t.attach(this._followObject),this._followObjectStartPosition.copy(this._followObject.position),this._followObjectStartQuaternion.copy(this._followObject.quaternion),this._followObjectStartWorldQuaternion.copy(this._followObject.worldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const e=this._hitPointInLocalSpace.clone();this.gameObject.localToWorld(e),this._grabStartDistance=e.distanceTo(t.worldPosition);const i=(r=(o=te.active)==null?void 0:o.rig)==null?void 0:r.gameObject,n=(i==null?void 0:i.worldScale.x)||1;this._grabStartDistance/=n,this._totalMovementAlongRayDirection=0,this._lastDragPosRigSpace=void 0,Gs&&(G.DrawLine(e,t.worldPosition,65280,.5,!1),G.DrawLabel(t.worldPosition.add(new x(0,.1,0)),this._grabStartDistance.toFixed(2),.03,.5))}onDragStart(t){if(!this.gameObject){console.warn("Error: space follow object doesn't have a gameObject");return}if(t.event.space.add(this._followObject),this._lastDragPosRigSpace=void 0,t.point&&t.normal)this._hitPointInLocalSpace.copy(t.point),this.gameObject.worldToLocal(this._hitPointInLocalSpace),this._hitNormalInLocalSpace.copy(t.normal);else if(t){const _=t.event.space,y=_.worldPosition;this.gameObject.worldToLocal(y),this._hitPointInLocalSpace.copy(y);const b=_.worldUp;this._tempMat.copy(this.gameObject.matrixWorld).invert(),b.transformDirection(this._tempMat),this._hitNormalInLocalSpace.copy(b)}this.recenter(),this._totalMovement.set(0,0,0),this._deviceMode=t.mode;const i=this._followObject.parent.worldForward,o=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer"?this.settings.xrDragMode:this.settings.dragMode,r=this._hitPointInLocalSpace.clone();switch(this.gameObject.localToWorld(r),o){case pi.XZPlane:const _=new x(0,1,0);this.gameObject.parent&&_.transformDirection(this.gameObject.parent.matrixWorld.clone().invert()),this._dragPlane.setFromNormalAndCoplanarPoint(_,r);break;case pi.HitNormal:const y=this._hitNormalInLocalSpace.clone();y.transformDirection(this.gameObject.matrixWorld),this._dragPlane.setFromNormalAndCoplanarPoint(y,r);break;case pi.Attached:this._dragPlane.setFromNormalAndCoplanarPoint(i,r);break;case pi.DynamicViewAngle:this.setPlaneViewAligned(r,!0);break;case pi.SnapToSurfaces:this.setPlaneViewAligned(r,!1);break;case pi.None:break}const l=this.gameObject.parent,c=this.gameObject.position.clone(),h=this.gameObject.quaternion.clone(),d=this.gameObject.scale.clone(),u=this.gameObject.matrixWorld.clone();l&&l.remove(this.gameObject),this.gameObject.position.set(0,0,0),this.gameObject.quaternion.set(0,0,0,1),this.gameObject.scale.set(1,1,1);const f=Qi([this.gameObject]);f.expandByPoint(this.gameObject.worldPosition);const p=new x;f.getCenter(p);const g=new x;f.getSize(g),this._bottomCenter.copy(p.clone().add(new x(0,-g.y/2,0))),this._backCenter.copy(p.clone().add(new x(0,0,g.z/2))),this._backBottomCenter.copy(p.clone().add(new x(0,-g.y/2,g.z/2))),this._bounds.copy(f),l&&l.add(this.gameObject),this.gameObject.position.copy(c),this.gameObject.quaternion.copy(h),this.gameObject.scale.copy(d),this.gameObject.matrixWorld.copy(u),this._draggedOverObject=null,this._draggedOverObjectLastSetUp=null,this._draggedOverObjectLastNormal.set(0,1,0),this._draggedOverObjectDuration=0}collectMovementInfo(){var o,r;if(!this._followObject.parent)return;const t=this._followObject.parent;this._followObject.updateMatrix();const e=t.worldPosition,i=(r=(o=te.active)==null?void 0:o.rig)==null?void 0:r.gameObject;i&&i.worldToLocal(e),(this._lastDragPosRigSpace===void 0||i!=this._lastRig)&&(this._lastDragPosRigSpace=e.clone(),this._lastRig=i),this._tempVec.copy(e).sub(this._lastDragPosRigSpace);const n=t.worldForward;if(i&&(this._tempMat.copy(i.matrixWorld).invert(),n.transformDirection(this._tempMat)),this._totalMovementAlongRayDirection+=n.dot(this._tempVec),this._tempVec.x=Math.abs(this._tempVec.x),this._tempVec.y=Math.abs(this._tempVec.y),this._tempVec.z=Math.abs(this._tempVec.z),this._totalMovement.add(this._tempVec),this._lastDragPosRigSpace.copy(e),Gs){let l=e;i&&(l=l.clone(),l.transformDirection(i.matrixWorld)),G.DrawRay(l,n,255)}}onDragUpdate(t){if(t>1)return;const e=this.gameObject;if(!e||!this._followObject){console.warn("Warning: DragPointerHandler doesn't have a dragged object. This is likely a bug.");return}const i=this._followObject.parent;if(!i){console.warn("Warning: DragPointerHandler doesn't have a drag source. This is likely a bug.");return}this._followObject.updateMatrix();const n=i.worldPosition,o=i.worldForward,r=this._deviceMode==="tracked-pointer"||this._deviceMode==="transient-pointer",l=r?this.settings.xrKeepRotation:this.settings.keepRotation,c=r?this.settings.xrDragMode:this.settings.dragMode;if(c===pi.None)return;const h=10;l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion),this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);let d=1,u=2;if(r&&this._grabStartDistance>.5){const v=1+this._totalMovementAlongRayDirection*(2*this.settings.xrDistanceDragFactor);d=Math.max(0,v),d=d*d*d}else this._grabStartDistance<=.5&&(u=3);this._followObject.position.copy(this._followObjectStartPosition),l||this._followObject.quaternion.copy(this._followObjectStartQuaternion),this._followObject.position.multiplyScalar(d),this._followObject.updateMatrix();const f=this._hasLastSurfaceHitPoint;this._hasLastSurfaceHitPoint=!1;const p=new Hr(n,o);if(c==pi.SnapToSurfaces){const v=this.context.physics.raycastFromRay(p,{testObject:w=>w!==this.followObject&&w!==i&&w!==e});if(v.length>0){const w=v[0];if(this._draggedOverObject===w.object?this._draggedOverObjectDuration+=this.context.time.deltaTime:(this._draggedOverObject=w.object,this._draggedOverObjectDuration=0),w.face){this._hasLastSurfaceHitPoint=!0,this._lastSurfaceHitPoint.copy(w.point);const P=.15,E=this._draggedOverObjectDuration>=P,T=.001,k=this._totalMovement.length()>=T,z=q(w.normal||w.face.normal).applyQuaternion(w.object.worldQuaternion);if((E||k)&&(this._draggedOverObjectLastSetUp!==this._draggedOverObject||this._draggedOverObjectLastNormal.dot(z)<.999999||this.context.time.frame%60===0)){this._draggedOverObjectLastSetUp=this._draggedOverObject,this._draggedOverObjectLastNormal.copy(w.face.normal);const L=q(),O=q();this._bounds.getCenter(L),this._bounds.getSize(O),L.sub(O.multiplyScalar(.5).multiply(z)),this._hitPointInLocalSpace.copy(L),this._hitNormalInLocalSpace.copy(w.face.normal),this._bounds.getCenter(L),this._bounds.getSize(O),L.add(O.multiplyScalar(.5).multiply(w.face.normal));const A=q(this._hitPointInLocalSpace).add(L);this._followObject.localToWorld(A);const $=w.point;this._dragPlane.setFromNormalAndCoplanarPoint(z,$)}else if(!(E||k))return}}else f&&this.gameObject&&this.setPlaneViewAligned(this.gameObject.worldPosition,!1)}if(c!==pi.Attached&&p.intersectPlane(this._dragPlane,this._tempVec)){this._followObject.worldPosition=this._tempVec,this._followObject.updateMatrix(),this._followObject.updateMatrixWorld(!0);const v=q(this._hitPointInLocalSpace);this._followObject.localToWorld(v),Gs&&G.DrawLine(v,this._tempVec,65535,0,!1),this._followObject.worldPosition=this._tempVec.multiplyScalar(2).sub(v),this._followObject.updateMatrix(),this._followObject.updateMatrix()}if(this.settings.snapGridResolution>0){const v=this._followObject.worldPosition,w=this.settings.snapGridResolution;v.x=Math.round(v.x/w)*w,v.y=Math.round(v.y/w)*w,v.z=Math.round(v.z/w)*w,this._followObject.worldPosition=v,this._followObject.updateMatrix()}l&&(this._followObject.worldQuaternion=this._followObjectStartWorldQuaternion,this._followObject.updateMatrix());const g=N.clamp01(this.context.time.deltaTime*h*u),_=N.clamp01(this.context.time.deltaTime*h*.5*u),y=e.worldPosition;y.lerp(this._followObject.worldPosition,g),e.worldPosition=y;const b=e.worldQuaternion;if(b.slerp(this._followObject.worldQuaternion,_),e.worldQuaternion=b,Gs){const v=this._hitPointInLocalSpace.clone();e.localToWorld(v),G.DrawSphere(v,.02,16711680);const w=this._hitNormalInLocalSpace.clone();w.applyQuaternion(b),G.DrawRay(v,w,16711680),G.DrawLabel(y.add(new x(0,.25,0)),`Distance: ${this._totalMovement.length().toFixed(2)}

                Along Ray: ${this._totalMovementAlongRayDirection.toFixed(2)}

                Session: ${!!te.active}

                Device: ${this._deviceMode}

                `,.03);const P=this._bottomCenter.clone(),E=this._backCenter.clone(),T=this._backBottomCenter.clone();e.localToWorld(P),e.localToWorld(E),e.localToWorld(T),G.DrawSphere(P,.01,65280,0,!1),G.DrawSphere(E,.01,255,0,!1),G.DrawSphere(T,.01,16711935,0,!1),G.DrawLine(P,T,65535,0,!1),G.DrawLine(T,E,65535,0,!1)}}onDragEnd(t){console.assert(this._followObject.parent===t.event.space,"Drag end: _followObject is not parented to the space object"),this._followObject.removeFromParent(),this._followObject.destroy(),this._lastDragPosRigSpace=void 0}setPlaneViewAligned(t,e){if(!this._followObject.parent)return!1;const i=this._followObject.parent.worldForward,n=q(0,1,0),o=i,r=n.angleTo(o),l=.5;return e&&(r>Math.PI/2+l||r<Math.PI/2-l)?this._dragPlane.setFromNormalAndCoplanarPoint(n,t):this._dragPlane.setFromNormalAndCoplanarPoint(i,t),!0}}const T0=class{constructor(t){a(this,"showGizmo",!0);a(this,"useViewAngle",!0);a(this,"_selected",null);a(this,"_context",null);a(this,"_camera");a(this,"_cameraPlane",new Za);a(this,"_hasGroundPlane",!1);a(this,"_groundPlane",new Za);a(this,"_groundOffset",new x);a(this,"_groundOffsetFactor",0);a(this,"_groundDistance",0);a(this,"_groundPlanePoint",new x);a(this,"_raycaster",new Vp);a(this,"_cameraPlaneOffset",new x);a(this,"_intersection",new x);a(this,"_worldPosition",new x);a(this,"_inverseMatrix",new ce);a(this,"_rbs",[]);a(this,"_groundLine");a(this,"_groundMarker");a(this,"_groundOffsetVector",new x(0,1,0));a(this,"_requireUpdateGroundPlane",!0);a(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=t;const e=new vc(T0.geometry),i=e.material;i.color=new de(.4,.4,.4),e.layers.set(2),e.name="line",e.scale.y=1,this._groundLine=e;const n=new Wp(.5,22,22),o=new Be({color:i.color}),r=new X(n,o);r.visible=!1,r.layers.set(2),this._groundMarker=r}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(t,e){if(this._selected&&e)for(const i of this._rbs)i.wakeUp(),i.setVelocity(0,0,0);if(this._selected&&zr.Remove(e,this._selected),this._selected=t,this._context=e,this._rbs.length=0,t?(e.scene.add(this._groundLine),e.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!e){console.error("DragHelper: no context");return}zr.Add(e,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this.onUpdateScreenSpacePlane()}}onUpdate(t){this._selected}onUpdateWorldPosition(t,e,i){if(this._selected){if(i){const n=ae(this._selected);n.y=t.y,t=n}if(ei(this._selected,t),ei(this._groundLine,t),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundLine.visible=this.showGizmo,this._groundMarker.visible=e!==null&&this.showGizmo,e){const n=ae(this._camera).distanceTo(e)*.01;this._groundMarker.scale.set(n,n,n),ei(this._groundMarker,e)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const t=this._context.input.getPointerPositionRC(0);t&&(this._raycaster.setFromCamera(t,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const t=ae(this._selected),e=new Hr(q(0,.1,0).add(t),q(0,-1,0)),i=new Kr;i.testObject=o=>o!==this._selected;const n=this._context.physics.raycastFromRay(e,i);for(let o=0;o<n.length;o++){const r=n[o];if(!r.face||this.contains(this._selected,r.object))continue;const l=q(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,r.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(e.direction.multiplyScalar(-1),e.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(t),this._groundOffset.copy(this._intersection).sub(t)}contains(t,e){if(t===e)return!0;if(t.children){for(const i of t.children)if(this.contains(i,e))return!0}return!1}};let Qg=T0;a(Qg,"geometry",new os().setFromPoints([new x(0,0,0),new x(0,-1,0)]));var Ix;(function(s){s.File_Spawned="file-spawned"})(Ix||(Ix={}));class z3{constructor(t,e,i,n,o,r,l,c,h){a(this,"guid");a(this,"file_name");a(this,"file_hash");a(this,"file_size");a(this,"position");a(this,"scale");a(this,"seed");a(this,"sender");a(this,"downloadUrl");a(this,"parentGuid");a(this,"boundsSize");this.seed=e,this.guid=i,this.file_name=n,this.file_hash=o,this.file_size=r,this.position=l,this.scale=c,this.sender=t,this.downloadUrl=h}}var Ta;(function(s){const t=new Map;function e(n){var u;t.has(n.guid)&&i(n.guid);const o=new D;t.set(n.guid,o);const r=new D;r.position.y=-.5,o.add(r);const l=new X(new bc(1,1,1,1,1,1),new Be({color:14540253,wireframe:!0,transparent:!0,opacity:.3}));l.position.y=.5,r.add(l);const c=new D;r.add(c);const h=new X(new bc(1,1,1,1,1,1),new Be({color:12307660,transparent:!0,opacity:.4}));h.position.y=.5,c.scale.y=.01,c.add(h);const d=new X(new ro(1,1,1,1),new Be({color:34,transparent:!0,opacity:.05,depthTest:!1}));return d.rotateX(-Math.PI/2),d.position.y=.51,h.add(d),n.parent.add(o),o.rotateY(Math.PI/2),n.position&&((u=o.position)==null||u.copy(n.position)),n.size&&(o.worldScale=new x().copy(n.size)),o.position.y=o.scale.y/2,{object:o,onProgress:f=>{c instanceof D&&c.scale.set(1,f,1)}}}s.addPreview=e;function i(n){const o=t.get(n);o&&(t.delete(n),o.removeFromParent())}s.removePreview=i})(Ta||(Ta={}));const Wl=[],Af=[];var Dx;(function(s){function t(i,n){const o={name:n==null?void 0:n.name,priority:(n==null?void 0:n.priority)??0,callback:i};return Wl.push(o),Wl.sort((r,l)=>r.priority===l.priority?0:r.priority>l.priority?-1:1),()=>{const r=Wl.indexOf(o);r>=0&&Wl.splice(r,1)}}s.onCreateCustomModelLoader=t;function e(i){return Af.push(i),()=>{const n=Af.indexOf(i);n>=0&&Af.splice(n,1)}}s.onDetermineModelMimetype=e})(Dx||(Dx={}));const ld=S("debugfileformat");function u2(s){switch((s.split(".").pop()||s).toUpperCase()){case"GLTF":return"model/gltf+json";case"VRM":return"model/vrm";case"GLB":return"model/gltf-binary";case"FBX":return"model/fbx";case"USD":return"model/vnd.usd+zip";case"USDA":return"model/vnd.usda+zip";case"USDZ":return"model/vnd.usdz+zip";case"OBJ":return"model/obj";default:return null}}async function f2(s,t){var o;const{useExtension:e=!0}=t;if(e){const r=s,l=new URL(r,globalThis.location.href);let c=null;const h=l.searchParams.get("filetype");switch(h&&(c=h.toUpperCase()),c!=null&&c.length||(c=(o=l.pathname.split(".").pop())==null?void 0:o.toUpperCase()),ld&&console.warn(`[Needle Engine] Try to use file extension to determine type: '${c}'`),c){case"GLTF":return"model/gltf+json";case"VRM":return"model/vrm";case"GLB":return"model/gltf-binary";case"FBX":return"model/fbx";case"USD":return"model/vnd.usd+zip";case"USDA":return"model/vnd.usda+zip";case"USDZ":return"model/vnd.usdz+zip";case"OBJ":return"model/obj"}}const i=s;if(!s.startsWith("blob:")){const r=new URL(s,globalThis.location.href);r.searchParams.append("range","true"),s=r.toString()}const n=await fetch(s,{method:"GET",headers:{range:"bytes=0-32"}}).catch(r=>null);if(n!=null&&n.ok){const r=await n.arrayBuffer(),l=p2(i,r,n);return ld&&console.log("[Needle Engine] Determined file type from header: "+l),l}return"unknown"}function p2(s,t,e){if(t.byteLength<4)return"unknown";const i=new Uint8Array(t);ld&&console.warn(`[Needle Engine] Trying to determine file type from binary data
`,'"'+new TextDecoder().decode(t)+`"
`,i);const n=new TextDecoder().decode(t).replace(/\s/g,"");if(n[0]==="{"&&n[1]==='"')return console.debug("GLTF detected"),"model/gltf+json";if(i[0]==103&&i[1]==108&&i[2]==84&&i[3]==70&&(i[4]==10||i[4]===2))return console.debug("GLTF .bin detected"),"model/gltf+json";if(i[0]==103&&i[1]==108&&i[2]==84&&i[3]==70&&i[4]==98)return console.debug("GLB detected"),"model/gltf-binary";if(i[0]==80&&i[1]==75&&i[2]==3&&i[3]==4)return console.debug("USDZ detected"),"model/vnd.usdz+zip";if(i[0]==80&&i[1]==88&&i[2]==82&&i[3]==45&&i[4]==85&&i[5]==83&&i[6]==68&&i[7]==67)return console.debug("Binary USD detected"),"model/vnd.usd";if(i[0]==35&&i[1]==117&&i[2]==115&&i[3]==100&&i[4]==97)return console.debug("ASCII USD detected"),"model/vnd.usda";if(i[0]==75&&i[1]==97&&i[2]==121&&i[3]==100&&i[4]==97&&i[5]==114&&i[6]==97&&i[7]==32)return console.debug("Binary FBX detected"),"model/fbx";if(i[0]==59&&i[1]==32&&i[2]==70&&i[3]==66&&i[4]==88&&i[5]==32)return console.debug("ASCII FBX detected"),"model/fbx";if(i[0]==35&&i[1]==32&&i[2]==66&&i[3]==108&&i[4]==101&&i[5]==110&&i[6]==100&&i[7]==101&&i[8]==114&&i[9]==32)return console.debug("OBJ detected"),"model/obj";if(i[0]==35&&i[1]==32&&i[2]==65&&i[3]==108&&i[4]==105&&i[5]==97&&i[6]==115&&i[7]==32&&i[8]==79&&i[9]==66&&i[10]==74)return console.debug("OBJ detected"),"model/obj";if(e.headers.has("content-type")){const o=e.headers.get("content-type");if(o!=null&&o.startsWith("image/"))return console.debug("Image detected, not a model file"),"unsupported";switch(console.debug("Content-Type: "+o),o){case"model/gltf+json":case"model/gltf-binary":case"model/vrm":case"model/vnd.usdz+zip":case"model/vnd.usd+zip":case"model/vnd.usd":case"model/vnd.usda+zip":case"model/vnd.usda":case"model/vnd.usdc":case"model/fbx":case"model/vnd.autodesk.fbx":case"model/obj":return o}}if(i[0]==118&&i[1]==32||i[0]==102&&i[1]==32)return console.debug("OBJ detected (the file has no header and starts with vertex or face)"),"obj";if(i[0]==35&&i[1]==32&&i[2]==70&&i[3]==105&&i[4]==108&&i[5]==101&&i[6]==32&&i[7]==101&&i[8]==120&&i[9]==112&&i[10]==111&&i[11]==114&&i[12]==116&&i[13]==101&&i[14]==100&&i[15]==32&&i[16]==98&&i[17]==121&&i[18]==32&&i[19]==90&&i[20]==66&&i[21]==114&&i[22]==117&&i[23]==115&&i[24]==104)return console.debug("OBJ detected (exported by ZBrush)"),"obj";if(i[0]==109&&i[1]==116&&i[2]==108&&i[3]==108&&i[4]==105&&i[5]==98)return console.debug("OBJ detected (mtllib)"),"obj";for(const o of Af){const r=o({url:s,response:e,contentType:e.headers.get("content-type"),bytes:i});if(r)return ld&&console.debug(`Mimetype callback returned: ${r}`),r}if(U()||ld){const o=new TextDecoder().decode(t.slice(0,Math.min(t.byteLength,32)));console.warn(`Could not determine file type.

Consider registering a custom loader via the 'onCreateCustomModelLoader' callback: 'NeedleEngineModelLoader.onCreateCustomModelLoader(args => { })'

Content-Type: "${e.headers.get("content-type")}
"Text: "${o}"
Binary:`,i)}else console.debug("Could not determine file type from binary data");return"unknown"}var $c=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ln=S("debugdroplistener");var fp;(function(s){s.FileDropped="file-dropped",s.ObjectAdded="object-added"})(fp||(fp={}));class m2 extends CustomEvent{constructor(t){super(fp.ObjectAdded,{detail:t})}}const g2="blob";class Zr extends j{constructor(){super(...arguments);a(this,"dropArea");a(this,"fitIntoVolume",!1);a(this,"fitVolumeSize",new x(1,1,1));a(this,"placeAtHitPosition",!0);a(this,"useNetworking",!1);a(this,"onDropped",new we);a(this,"onNetworkEvent",e=>{var i;if(!this.useNetworking){ln&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if((i=e.guid)!=null&&i.startsWith(this.guid)){const n=e.url;if(console.debug("[DropListener] Received networked event",e),n)if(Array.isArray(n))for(const o of n)this.addFromUrl(o,{screenposition:new le,point:e.point,size:e.size},!0);else this.addFromUrl(n,{screenposition:new le,point:e.point,size:e.size},!0)}});a(this,"handlePaste",e=>{if(this.context.connection.allowEditing===!1||e.defaultPrevented)return;navigator.clipboard.readText().then(n=>{if(n&&(n.startsWith("http")||n.startsWith("https")||n.startsWith("blob"))){const r={screenposition:new le(this.context.input.mousePosition.x,this.context.input.mousePosition.y)};this.testIfIsInDropArea(r)&&this.addFromUrl(n,r,!1)}}).catch(console.warn)});a(this,"onDrag",e=>{this.context.connection.allowEditing!==!1&&e.preventDefault()});a(this,"onDrop",async e=>{if(this.context.connection.allowEditing===!1||(ln&&console.log(e),!(e!=null&&e.dataTransfer))||e["droplistener:handled"])return;e.preventDefault();const i={screenposition:new le(e.offsetX,e.offsetY)};if(this.dropArea&&this.testIfIsInDropArea(i)===!1)return;e["droplistener:handled"]=!0;const n=e.dataTransfer.items;if(!n)return;const o=[];for(const r in n){const l=n[r];if(l.kind==="file"){const c=l.getAsFile();if(!c)continue;o.push(c)}else l.kind==="string"&&l.type=="text/plain"&&l.getAsString(c=>{this.addFromUrl(c,i,!1)})}o.length>0&&await this.addFromFiles(o,i)});a(this,"_abort",null);a(this,"_addedObjects",new Array);a(this,"_addedModels",new Array)}loadFromURL(e,i){return this.addFromUrl(e,{screenposition:new le,point:i==null?void 0:i.point,size:i==null?void 0:i.size},!1)}forgetObjects(){this.removePreviouslyAddedObjects(!1)}onEnable(){this.context.renderer.domElement.addEventListener("dragover",this.onDrag),this.context.renderer.domElement.addEventListener("drop",this.onDrop),window.addEventListener("paste",this.handlePaste),this.context.connection.beginListen("droplistener",this.onNetworkEvent)}onDisable(){this.context.renderer.domElement.removeEventListener("dragover",this.onDrag),this.context.renderer.domElement.removeEventListener("drop",this.onDrop),window.removeEventListener("paste",this.handlePaste),this.context.connection.stopListen("droplistener",this.onNetworkEvent)}async addFromUrl(e,i,n){ln&&console.log("dropped url",e);try{if(e.startsWith("https://github.com/")){const l=e.split("/"),c=l[3],h=l[4],d=l[6],u=l.slice(7).join("/");e=`https://raw.githubusercontent.com/${c}/${h}/${d}/${u}`}else e.startsWith("https://polyhaven.com/a")&&(e=y2(e));if(!e)return null;const o=e.toLowerCase();if(o.endsWith(".hdr")||o.endsWith(".hdri")||o.endsWith(".exr")||o.endsWith(".png")||o.endsWith(".jpg")||o.endsWith(".jpeg"))return console.warn(`Fileformat is not supported: ${o}`),null;this.removePreviouslyAddedObjects();const r=await pp.loadFileFromURL(new URL(e),{guid:this.guid,context:this.context,parent:this.gameObject,point:i.point,size:i.size});if(r&&this._addedObjects.length<=0)return i.url=e,this.onObjectLoaded(r,i,n)}catch{console.warn("String is not a valid URL",e)}return null}async addFromFiles(e,i){var n,o;if(ln&&console.log("Add files",e),!!Array.isArray(e)&&e.length){this.deleteDropEvent(),this.removePreviouslyAddedObjects(),$f(g2,null),(n=this._abort)==null||n.abort("New files dropped"),this._abort=new AbortController;for(const r of e){if(!r)continue;if(r.type.startsWith("image/")){ln&&console.warn("Ignoring dropped image file",r.name,r.type);continue}else if(r.name.endsWith(".bin")){ln&&console.warn("Ignoring dropped binary file",r.name,r.type);continue}console.debug("Load file "+r.name+" + "+r.type);const l=await pp.loadFile(r,this.context,{guid:this.guid});if(l){this.dispatchEvent(new CustomEvent(fp.FileDropped,{detail:r})),i.file=r;const c=this.onObjectLoaded(l,i,!1);c&&this.context.connection.isConnected&&this.useNetworking&&(console.debug("Uploading dropped file to blob storage"),Ac.upload(r,{abort:(o=this._abort)==null?void 0:o.signal}).then(h=>{h!=null&&h.download_url&&this._addedObjects.includes(c)&&this.sendDropEvent(h.download_url,c,l.contentMD5)}).catch(console.warn));break}}}}removePreviouslyAddedObjects(e=!0){if(e)for(const i of this._addedObjects)i.parent===this.gameObject&&Wn(i,!0,!0);this._addedObjects.length=0,this._addedModels.length=0}onObjectLoaded(e,i,n){var d,u;const{model:o,contentMD5:r}=e;if(ln&&console.log(`Dropped ${this.gameObject.name}`,o),!(o!=null&&o.scene))return console.warn("No object specified to add to scene",o),null;this.removePreviouslyAddedObjects();const l=o.scene;this.gameObject.attach(l),l.position.set(0,0,0),l.quaternion.identity(),this._addedObjects.push(l),this._addedModels.push(o);const c=new Nn().setFromCenterAndSize(new x(0,this.fitVolumeSize.y*.5,0).add(this.gameObject.worldPosition),this.fitVolumeSize);if(ln&&G.DrawWireBox3(c,255,5),this.fitIntoVolume&&EO(l,c,{position:!this.placeAtHitPosition}),this.placeAtHitPosition&&i&&i.screenposition){l.visible=!1;const f=this.context.physics.raycast({screenPoint:this.context.input.convertScreenspaceToRaycastSpace(i.screenposition.clone())});if(l.visible=!0,f&&f.length>0)for(const p of f){const g=p.point.clone();ln&&console.log("Place object at hit",p),MO(l,g);break}}Hd.autoplayAnimations(o);const h=new m2({sender:this,gltf:o,model:o,object:l,contentMD5:r,dropped:i.file||(i.url?new URL(i.url):void 0)});return this.dispatchEvent(h),(d=this.onDropped)==null||d.invoke(h.detail),!n&&((u=i.url)!=null&&u.startsWith("http"))&&this.context.connection.isConnected&&l&&this.sendDropEvent(i.url,l,r),l}async sendDropEvent(e,i,n){if(!this.useNetworking){ln&&console.debug("[DropListener] Ignoring networked event because networking is disabled",e);return}if(this.context.connection.isConnected){console.debug('Sending drop event "'+i.name+'"',e);const o=Qi([i]),r={name:i.name,guid:this.guid,url:e,point:i.worldPosition.clone(),size:o.getSize(new x),contentMD5:n};this.context.connection.send("droplistener",r)}}deleteDropEvent(){this.context.connection.sendDeleteRemoteState(this.guid)}testIfIsInDropArea(e){if(this.dropArea){const i=this.context.input.convertScreenspaceToRaycastSpace(e.screenposition.clone());if(!this.context.physics.raycast({targets:[this.dropArea],screenPoint:i,recursive:!0,testObject:o=>!this._addedObjects.includes(o)}).length)return U()&&console.log(`Dropped outside of drop area for DropListener "${this.name}".`),!1}return!0}}$c([m(D)],Zr.prototype,"dropArea",void 0);$c([m()],Zr.prototype,"fitIntoVolume",void 0);$c([m(x)],Zr.prototype,"fitVolumeSize",void 0);$c([m()],Zr.prototype,"placeAtHitPosition",void 0);$c([m()],Zr.prototype,"useNetworking",void 0);$c([m(we)],Zr.prototype,"onDropped",void 0);function y2(s){if(!s.startsWith("https://polyhaven.com/"))return s;const t="https://dl.polyhaven.org/file/ph-assets/Models/gltf/4k/",n=new URL(s).pathname.split("/").pop(),o=`${t}${n}/${n}_4k.gltf`;return console.log("Resolved polyhaven asset url",s,"â†’",o),o}var pp;(function(s){async function t(i,n,o){const r=o.guid,l=new yi(r),c=new Blob([i],{type:i.type||u2(i.name)||void 0}),h=URL.createObjectURL(c),d=await so().loadSync(n,h,i.name,l).catch(u=>(console.error(`Failed to load file "${i.name}" (${i.type}):`,u),null));return URL.revokeObjectURL(h),d?new Promise((u,f)=>{const p=new FileReader;p.readAsArrayBuffer(i),p.onloadend=async g=>{const _=p.result,y=Ac.hashMD5(_);return u({model:d,contentMD5:y})}}):(console.warn(`Failed to load "${i.name}" (${i.type})`),null)}s.loadFile=t;async function e(i,n){return new Promise(async(o,r)=>{const l=new yi(n.guid),c=i.toString();ln&&G.DrawWireSphere(n.point,.1,16711680,3);const h=Ta.addPreview({guid:n.guid,parent:n.parent,position:n==null?void 0:n.point,size:n==null?void 0:n.size}),d=await so().loadSync(n.context,c,c,l,u=>{h.onProgress(u.loaded/u.total)}).catch(console.warn);if(d){const u=await fetch(c).then(p=>p.arrayBuffer()),f=Ac.hashMD5(u);ln?setTimeout(()=>Ta.removePreview(n.guid),3e3):Ta.removePreview(n.guid),o({model:d,contentMD5:f})}else ln?setTimeout(()=>Ta.removePreview(n.guid),3e3):Ta.removePreview(n.guid),console.warn("Unsupported file type: "+i.toString())})}s.loadFileFromURL=e})(pp||(pp={}));var Ub=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ml extends j{constructor(){super(...arguments);a(this,"parent",null);a(this,"object",null);a(this,"limitCount",60);a(this,"_currentCount",0);a(this,"_startPosition",null);a(this,"_startQuaternion",null);a(this,"_forwardPointerEvents",new Map)}start(){var e,i;if(this._currentCount=0,this._startPosition=null,this._startQuaternion=null,this.object||(this.object=this.gameObject),this.object){if(this.object===this.gameObject){const o=new yi(this.guid);this.object=C.instantiate(this.object,{idProvider:o,keepWorldPosition:!1});const r=C.getComponent(this.object,ml);r==null||r.destroy();let l=this.object.getComponentInChildren(jt);l||(l=this.object.addComponent(jt,{dragMode:pi.SnapToSurfaces}),l.guid=o.generateUUID());let c=C.getComponent(l.gameObject,oo);c||(c=l.gameObject.addComponent(oo),c.guid=o.generateUUID())}this.object.visible=!1;const n=this.gameObject.getComponent(jt);n&&(n.enabled=!1),this._startPosition=((e=this.object.position)==null?void 0:e.clone())??new x(0,0,0),this._startQuaternion=((i=this.object.quaternion)==null?void 0:i.clone())??new H(0,0,0,1)}this.gameObject.getComponentInParent(Vn)||this.gameObject.addComponent(Vn)}onEnable(){this.startCoroutine(this.cloneLimitIntervalFn())}onPointerEnter(e){e.used||this.object&&this.context.connection.allowEditing&&e.button===0&&this.context.input.setCursor("pointer")}onPointerExit(e){e.used||this.object&&this.context.connection.allowEditing&&e.button===0&&this.context.input.unsetCursor("pointer")}onPointerDown(e){if(e.used||!this.object||!this.context.connection.allowEditing||e.button!==0)return;const i=this.handleDuplication();if(i){const n=C.getComponent(i,jt);n?(n.onPointerDown(e),this._forwardPointerEvents.set(e.event.space,n)):U()&&console.warn(`Duplicated object (${i.name}) does not have DragControls`)}else this._currentCount>=this.limitCount?console.warn(`[Duplicatable] Limit of ${this.limitCount} objects created within a few seconds reached. Please wait a moment before creating more objects.`):console.warn("[Duplicatable] Could not duplicate object.")}onPointerUp(e){if(e.used)return;const i=this._forwardPointerEvents.get(e.event.space);i&&(i.onPointerUp(e),this._forwardPointerEvents.delete(e.event.space))}*cloneLimitIntervalFn(){for(;this.activeAndEnabled&&!this.destroyed;)this._currentCount>0?this._currentCount-=1:this._currentCount<0&&(this._currentCount=0),yield KC(1)}handleDuplication(){var n;if(!this.object||this.limitCount>0&&this._currentCount>=this.limitCount||this.object===this.gameObject)return null;if(C.isDestroyed(this.object))return this.object=null,null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const e=new lo;this.parent||(this.parent=this.gameObject.parent),this.parent&&(e.parent=this.parent.guid??((n=this.parent.userData)==null?void 0:n.guid),e.keepWorldPosition=!0),e.position=this.worldPosition,e.rotation=this.worldQuaternion,e.context=this.context,this._currentCount+=1;const i=C.instantiateSynced(this.object,e);return console.assert(i!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),i}}Ub([m(D)],ml.prototype,"parent",void 0);Ub([m(D)],ml.prototype,"object",void 0);Ub([m()],ml.prototype,"limitCount",void 0);var Rs;(function(s){s[s.PointerEnter=0]="PointerEnter",s[s.PointerExit=1]="PointerExit",s[s.PointerDown=2]="PointerDown",s[s.PointerUp=3]="PointerUp",s[s.PointerClick=4]="PointerClick",s[s.Drag=5]="Drag",s[s.Drop=6]="Drop",s[s.Scroll=7]="Scroll",s[s.UpdateSelected=8]="UpdateSelected",s[s.Select=9]="Select",s[s.Deselect=10]="Deselect",s[s.Move=11]="Move",s[s.InitializePotentialDrag=12]="InitializePotentialDrag",s[s.BeginDrag=13]="BeginDrag",s[s.EndDrag=14]="EndDrag",s[s.Submit=15]="Submit",s[s.Cancel=16]="Cancel"})(Rs||(Rs={}));var Nb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class $b{constructor(){a(this,"eventID");a(this,"callback",new we)}}Nb([m()],$b.prototype,"eventID",void 0);Nb([m(we)],$b.prototype,"callback",void 0);class Wb extends j{constructor(){super(...arguments);a(this,"triggers",[])}invoke(e){var i;if(this.triggers)for(const n of this.triggers)n.eventID===e&&((i=n.callback)==null||i.invoke())}hasTrigger(e){var i;return((i=this.triggers)==null?void 0:i.some(n=>n.eventID===e))??!1}shouldChangeCursor(){return this.hasTrigger(Rs.PointerClick)||this.hasTrigger(Rs.PointerDown)||this.hasTrigger(Rs.PointerUp)}onPointerClick(e){this.invoke(Rs.PointerClick)}onPointerEnter(e){this.shouldChangeCursor()&&this.context.input.setCursor("pointer"),this.invoke(Rs.PointerEnter)}onPointerExit(e){this.shouldChangeCursor()&&this.context.input.unsetCursor("pointer"),this.invoke(Rs.PointerExit)}onPointerDown(e){this.invoke(Rs.PointerDown)}onPointerUp(e){this.invoke(Rs.PointerUp)}}Nb([m($b)],Wb.prototype,"triggers",void 0);class x1{constructor(t){a(this,"writer");this.writer=t}writeNode(t){}}class _2 extends x1{beforeWriteNode(t,e){G.isGizmo(t)&&(e.keep=!1)}}class w1 extends x1{beforeWriteTexture(t,e){t.isRenderTargetTexture&&(e.newTexture=Ob(new pe(1,1,1,0)))}}function v_(s){const t=dp.DontExport;return!(s.hideFlags&t)}const Yg=S("debugexr");class b2{constructor(t){a(this,"parser");this.parser=t,Yg&&console.log(t)}get name(){return"EXT_texture_exr"}loadTexture(t){const e=this.name,i=this.parser,o=i.json.textures[t];if(Yg&&console.log("EXT_texture_exr.loadTexture",t,o),!o.extensions||!o.extensions[e])return null;const r=o.extensions[e],l=new ib(i.options.manager);return Yg&&console.log("EXT_texture_exr.loadTexture",r),i.loadTextureImage(t,r.source,l)}}typeof window<"u"&&window.addEventListener("unhandledrejection",s=>{});const xo=Dt,Qu="$___Export_Components",v2="NEEDLE_components";var kL;class x2{constructor(){a(this,kL)}}kL=Il;class w2{constructor(t,e,i){a(this,"node");a(this,"nodeIndex");a(this,"nodeDef");this.node=t,this.nodeIndex=e,this.nodeDef=i}}class S1{constructor(){a(this,"parser");a(this,"nodeToObjectMap",{});a(this,"gltf",null);a(this,"exportContext");a(this,"objectToNodeMap",{});a(this,"context");a(this,"writer")}get name(){return v2}registerExport(t){t.register(e=>{if("serializeUserData"in e){const i=e.serializeUserData.bind(e);this.writer=e,e.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o)&&(e.extensionsUsed[this.name]=!0),i(n,o)}finally{this.afterSerializeUserData(n,o)}}}return this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(t,e){var n;const i=(n=t.userData)==null?void 0:n.components;return!i||i.length<=0?!1:(delete t.userData.components,t[Qu]=i,!0)}afterSerializeUserData(t,e){if(t.type==="Scene"&&xo&&console.log("DONE",JSON.stringify(e)),t[Qu]===void 0)return;const i=t[Qu];delete t[Qu],i!==null&&(t.userData.components=i)}writeNode(t,e){const i=this.writer.json.nodes.length;xo&&console.log(t.name,i,t.uuid);const n=new w2(t,i,e);this.exportContext[i]=n,this.objectToNodeMap[t.uuid]=i}afterParse(t){var e;xo&&console.log("AFTER",t);for(const i in this.exportContext){const n=this.exportContext[i],o=n.node,r=n.nodeDef,l=n.nodeIndex,c=(e=o.userData)==null?void 0:e.components;if(!c||c.length<=0)continue;const h=new x2;r.extensions=r.extensions||{},r.extensions[this.name]=h,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const d=[];for(const u of c){this.context.target=u;const f=so().writeBuiltinComponentData(u,this.context);f!==null&&d.push(f)}d.length>0&&(h[Il]=d,xo&&console.log("DID WRITE",o,"nodeIndex",l,d))}}beforeRoot(){return xo&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(t){this.gltf=t;const e=t.parser,i=e==null?void 0:e.extensions;if(!i)return;const n=i[this.name];xo&&console.log("After root",t,this.parser,i);const o=[];if(n===!0){const r=e.json.nodes;if(r){for(let l=0;l<r.length;l++){const c=await e.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<r.length;l++){const c=r[l],h=l,d=c.extensions;if(!d)continue;const u=d[this.name];if(!u)continue;xo&&console.log("NODE",c);const f=this.nodeToObjectMap[h];if(!f){console.error("Could not find object for node index: "+h,c,e);continue}Pb(f),o.push(this.createComponents(f,u))}}}await Promise.all(o);for(const r of e.associations.keys()){const l=e.associations.get(r);if((l==null?void 0:l.materials)!=null){const c="/materials/"+l.materials;YE(r,c)}}}async createComponents(t,e){if(!e)return;const i=e[Il];if(i){const n=new Array;xo&&console.log(t.name,i);for(const o in i){const r=i[o];xo&&console.log("Serialized data",JSON.parse(JSON.stringify(r))),r&&this.parser&&n.push(Sb(this.parser,r).catch(l=>console.error(`Error while resolving references (see console for details)
`,l,t,r))),t.userData=t.userData||{},t.userData[Il]=t.userData[Il]||[],t.userData[Il].push(r)}await Promise.all(n).catch(o=>{console.error("Error while loading components",o)})}}}const Lx="NEEDLE_gameobject_data";class S2{constructor(t){a(this,"parser");this.parser=t}get name(){return Lx}afterRoot(t){var i;const e=[];for(let n=0;n<((i=this.parser.json.nodes)==null?void 0:i.length);n++){const o=this.parser.json.nodes[n];if(o&&o.extensions){const r=o.extensions[Lx];if(r){const l=this.findAndApplyExtensionData(n,r);e.push(l)}}}return Promise.all(e).then(()=>null)}async findAndApplyExtensionData(t,e){const i=await this.parser.getDependency("node",t);i&&this.applyExtensionData(i,e)}applyExtensionData(t,e){e.layers===void 0&&(e.layers=0),t.userData.layer=e.layers,t.layers.disableAll(),t.layers.set(e.layers),t.userData.tag=e.tag??"none",t.hideFlags=0,t.userData.static=e.static??!1,t.visible=e.activeSelf??!0,t.guid=e.guid}}const jx="NEEDLE_lighting_settings",Bl=S("debugenvlight");class C2{constructor(t,e,i){a(this,"parser");a(this,"sourceId");a(this,"context");this.parser=t,this.sourceId=e,this.context=i}get name(){return jx}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[jx];if(i){Bl&&console.log('Loaded "'+this.name+'", src: "'+this.sourceId+'"',i);let n;if(t.scene.children.length===1){const o=t.scene.children[0];n=C.addComponent(o,x_,{},{callAwake:!1})}else{const o=new D;o.name="LightSettings "+this.sourceId,t.scene.add(o),n=C.addComponent(o,x_,{},{callAwake:!1})}n.sourceId=this.sourceId,n.ambientIntensity=i.ambientIntensity,n.ambientLight=new de().fromArray(i.ambientLight),Array.isArray(i.ambientTrilight)&&(n.ambientTrilight=i.ambientTrilight.map(o=>new de().fromArray(o))),n.ambientMode=i.ambientMode,n.environmentReflectionSource=i.environmentReflectionSource}}return null}}ve.registerCallback(ge.ContextCreated,s=>{const t=s.context,e=C.findObjectOfType(x_,t);e!=null&&e.sourceId&&(e.enabled=!0)});class x_ extends j{constructor(){super(...arguments);a(this,"ambientMode",$s.Skybox);a(this,"ambientLight");a(this,"ambientTrilight");a(this,"ambientIntensity",1);a(this,"environmentReflectionSource",Gd.Skybox);a(this,"_hasReflection",!1);a(this,"_ambientLightObj");a(this,"_hemisphereLightObj")}awake(){var i;if(this.sourceId){const n=this.environmentReflectionSource===Gd.Skybox?ts.Skybox:ts.Reflection,o=this.context.lightmaps.tryGet(this.sourceId,n,0);this._hasReflection=o!=null,o&&this.context.sceneLighting.internalRegisterReflection(this.sourceId,o)}this.enabled=!1,this.context.sceneLighting.internalRegisterSceneLightSettings(this),Bl&&window.addEventListener("keydown",n=>{if(!this.destroyed)switch(n.key){case"l":this.enabled=!this.enabled;break}});const e=(i=this.gameObject.userData)==null?void 0:i.components;if(e){const n=e.indexOf(this);e.splice(n,1),e.push(this)}}onDestroy(){this.context.sceneLighting.internalUnregisterSceneLightSettings(this)}calculateIntensityFactor(e){const i=Math.max(e.r,e.g,e.b);return 2.2*N.lerp(0,1.33,i)}onEnable(){if(Bl&&console.warn("ðŸ’¡ðŸŸ¡ >>> Enable lighting",this.sourceId,this.enabled,this),this.ambientMode==$s.Flat){if(this.ambientLight&&!this._ambientLightObj){const e=this.calculateIntensityFactor(this.ambientLight);this._ambientLightObj=new aR(this.ambientLight,this.ambientIntensity*e),Bl&&console.log("Created ambient light",this.sourceId,this._ambientLightObj,this.ambientIntensity,e)}this._ambientLightObj&&this.gameObject.add(this._ambientLightObj)}else if(this.ambientMode===$s.Trilight){if(this.ambientTrilight){const e=this.ambientTrilight[0],i=this.ambientTrilight[this.ambientTrilight.length-1],n=this.calculateIntensityFactor(i);this._hemisphereLightObj=new lR(i,e,this.ambientIntensity*n),this.gameObject.add(this._hemisphereLightObj),Bl&&console.log("Created hemisphere ambient light",this.sourceId,this._hemisphereLightObj,this.ambientIntensity,n)}}else this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent();this.sourceId&&(this.context.domElement.getAttribute("environment-image")||this.context.sceneLighting.internalEnableReflection(this.sourceId))}onDisable(){Bl&&console.warn("ðŸ’¡âš« <<< Disable lighting:",this.sourceId,this),this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._hemisphereLightObj&&this._hemisphereLightObj.removeFromParent(),this.sourceId&&this.context.sceneLighting.internalDisableReflection(this.sourceId)}}const Kg=S("debugstencil");function P2(s,t){return(s&1<<t.layer)!=0}const R2=Symbol("stencils"),Aa=class{constructor(t,e){a(this,"parser");a(this,"source");this.parser=t,this.source=e}get name(){return"NEEDLE_render_objects"}static applyStencil(t){if(!t)return;const e=t.sourceId;if(Kg&&console.log(e,Aa.stencils),!e)return;const i=Aa.stencils[e];if(i)for(let n=i.length-1;n>=0;n--){const o=i[n];if(P2(o.layer,t)){Kg&&console.log(o),setTimeout(()=>{fs()&&Rb(t.gameObject)&&(ke("Stencil not supported on instanced objects"),console.warn("Stencil not supported on instanced objects",t))},500);for(let r=0;r<t.sharedMaterials.length;r++){let l=t.sharedMaterials[r];l&&(l=l.clone(),l[R2]=!0,l.stencilWrite=!0,l.stencilWriteMask=255,l.stencilFuncMask=255,l.stencilRef=o.value,l.stencilFunc=o.compareFunc,l.stencilZPass=o.passOp,l.stencilFail=o.failOp,l.stencilZFail=o.zFailOp,t.sharedMaterials[r]=l)}t.gameObject.renderOrder=o.event*1e3+o.index*50;break}}}afterRoot(t){const e=this.parser.json.extensions;if(e){const i=e[O2];if(i){Kg&&console.log(i);const n=i.stencil;if(n&&Array.isArray(n))for(const o of n){const r={...o};r.compareFunc=T2(r.compareFunc),r.passOp=Jg(r.passOp),r.failOp=Jg(r.failOp),r.zFailOp=Jg(r.zFailOp),Aa.stencils[this.source]||(Aa.stencils[this.source]=[]),Aa.stencils[this.source].push(r)}}}return null}};let cd=Aa;a(cd,"stencils",{});var Ts;(function(s){s[s.Keep=0]="Keep",s[s.Zero=1]="Zero",s[s.Replace=2]="Replace",s[s.IncrementSaturate=3]="IncrementSaturate",s[s.DecrementSaturate=4]="DecrementSaturate",s[s.Invert=5]="Invert",s[s.IncrementWrap=6]="IncrementWrap",s[s.DecrementWrap=7]="DecrementWrap"})(Ts||(Ts={}));var Os;(function(s){s[s.Disabled=0]="Disabled",s[s.Never=1]="Never",s[s.Less=2]="Less",s[s.Equal=3]="Equal",s[s.LessEqual=4]="LessEqual",s[s.Greater=5]="Greater",s[s.NotEqual=6]="NotEqual",s[s.GreaterEqual=7]="GreaterEqual",s[s.Always=8]="Always"})(Os||(Os={}));function Jg(s){switch(s){case Ts.Keep:return gR;case Ts.Zero:return mR;case Ts.Replace:return pR;case Ts.IncrementSaturate:return fR;case Ts.DecrementSaturate:return uR;case Ts.IncrementWrap:return dR;case Ts.DecrementWrap:return hR;case Ts.Invert:return cR}return 0}function T2(s){switch(s){case Os.Never:return L0;case Os.Less:return SR;case Os.Equal:return wR;case Os.LessEqual:return xR;case Os.Greater:return vR;case Os.NotEqual:return bR;case Os.GreaterEqual:return _R;case Os.Always:return yR}return L0}const O2="NEEDLE_render_objects";var Bx;(function(s){s[s.Fragment=35632]="Fragment",s[s.Vertex=35633]="Vertex"})(Bx||(Bx={}));var w_;(function(s){s[s.INT=5124]="INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_3D=35680]="SAMPLER_3D",s[s.SAMPLER_CUBE=35681]="SAMPLER_CUBE",s[s.UNKNOWN=0]="UNKNOWN"})(w_||(w_={}));const ks=S("debugcustomshader"),Rl="NEEDLE_techniques_webgl";var Fx;(function(s){s[s.INT=5124]="INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_3D=35680]="SAMPLER_3D",s[s.SAMPLER_CUBE=35681]="SAMPLER_CUBE",s[s.UNKNOWN=0]="UNKNOWN"})(Fx||(Fx={}));class k2{constructor(){a(this,"objectToWorldMatrix",new ce);a(this,"worldToObjectMatrix",new ce);a(this,"objectToWorld",new Array);a(this,"worldToObject",new Array)}updateFrom(t){this.objectToWorldMatrix.copy(t.matrixWorld),tp(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(t.matrixWorld).invert(),tp(this.worldToObjectMatrix,this.worldToObject)}}var hd;(function(s){s[s.Off=0]="Off",s[s.Front=1]="Front",s[s.Back=2]="Back"})(hd||(hd={}));var Po;(function(s){s[s.Never=1]="Never",s[s.Less=2]="Less",s[s.Equal=3]="Equal",s[s.LEqual=4]="LEqual",s[s.Greater=5]="Greater",s[s.NotEqual=6]="NotEqual",s[s.GEqual=7]="GEqual",s[s.Always=8]="Always"})(Po||(Po={}));const Xe=class extends Nw{constructor(e,...i){super(...i);a(this,"identifier");a(this,"onBeforeRenderSceneCallback",this.onBeforeRenderScene.bind(this));a(this,"_sphericalHarmonicsName","unity_SpecCube0");a(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");a(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");a(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");a(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");a(this,"_rendererData",new k2);this.identifier=e,ks&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName],(this.depthTextureUniform||this.opaqueTextureUniform)&&ne.Current.pre_render_callbacks.push(this.onBeforeRenderSceneCallback)}clone(){const e=super.clone();return C1(e),e}dispose(){super.dispose();const e=ne.Current.pre_render_callbacks.indexOf(this.onBeforeRenderSceneCallback);e>=0&&ne.Current.pre_render_callbacks.splice(e,1)}get depthTextureUniform(){if(this.uniforms)return this.uniforms._CameraDepthTexture}get opaqueTextureUniform(){if(this.uniforms)return this.uniforms._CameraOpaqueTexture}onBeforeRenderScene(){this.opaqueTextureUniform&&ne.Current.setRequireColor(!0),this.depthTextureUniform&&ne.Current.setRequireDepth(!0)}onBeforeRender(e,i,n,o,r,l){o.attributes.tangent||o.computeTangents(),this.onUpdateUniforms(n,r)}onUpdateUniforms(e,i){const n=ne.Current;if(e&&(Xe.viewProjection&&this.uniforms[this._viewProjectionName]&&(Xe.viewProjection.copy(e.projectionMatrix).multiply(e.matrixWorldInverse),tp(Xe.viewProjection,Xe._viewProjectionValues)),Xe.viewMatrix&&this.uniforms[this._viewMatrixName]&&(Xe.viewMatrix.copy(e.matrixWorldInverse),tp(Xe.viewMatrix,Xe._viewMatrixValues)),this.uniforms[Xe._worldSpaceCameraPosName]&&Xe._worldSpaceCameraPos.setFromMatrixPosition(e.matrixWorld)),this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=n.sceneLighting.timeVec4),this.uniforms._Time){const c=this.uniforms._Time.value;c.x=n.sceneLighting.timeVec4.x/20,c.y=n.sceneLighting.timeVec4.x,c.z=n.sceneLighting.timeVec4.x*2,c.w=n.sceneLighting.timeVec4.x*3}if(this.uniforms._SinTime){const c=this.uniforms._SinTime.value;c.x=Math.sin(n.sceneLighting.timeVec4.x/8),c.y=Math.sin(n.sceneLighting.timeVec4.x/4),c.z=Math.sin(n.sceneLighting.timeVec4.x/2),c.w=Math.sin(n.sceneLighting.timeVec4.x)}if(this.uniforms._CosTime){const c=this.uniforms._CosTime.value;c.x=Math.cos(n.sceneLighting.timeVec4.x/8),c.y=Math.cos(n.sceneLighting.timeVec4.x/4),c.z=Math.cos(n.sceneLighting.timeVec4.x/2),c.w=Math.cos(n.sceneLighting.timeVec4.x)}if(this.uniforms.unity_DeltaTime){const c=this.uniforms.unity_DeltaTime.value;c.x=n.time.deltaTime,c.y=1/n.time.deltaTime,c.z=n.time.smoothedDeltaTime,c.w=1/n.time.smoothedDeltaTime}const o=n.mainLight;if(o){const c=ae(o.gameObject,Xe._mainLightPosition);this.uniforms._MainLightPosition={value:c.normalize()},Xe._mainLightColor.set(o.color.r,o.color.g,o.color.b,0),this.uniforms._MainLightColor={value:Xe._mainLightColor};const h=o.intensity;Xe._lightData.z=h,this.uniforms.unity_LightData={value:Xe._lightData}}if(e&&(Xe.viewProjection&&this.uniforms[this._viewProjectionName]&&(this.uniforms[this._viewProjectionName].value=Xe._viewProjectionValues),Xe.viewMatrix&&this.uniforms[this._viewMatrixName]&&(this.uniforms[this._viewMatrixName].value=Xe._viewMatrixValues),this.uniforms[Xe._worldSpaceCameraPosName]&&(this.uniforms[Xe._worldSpaceCameraPosName]={value:Xe._worldSpaceCameraPos}),n.mainCameraComponent)){if(this.uniforms._ProjectionParams){const c=this.uniforms._ProjectionParams.value;c.x=1,c.y=n.mainCameraComponent.nearClipPlane,c.z=n.mainCameraComponent.farClipPlane,c.w=1/c.z,this.uniforms._ProjectionParams.value=c}if(this.uniforms._ZBufferParams){const c=this.uniforms._ZBufferParams.value,h=n.mainCameraComponent;c.x=1-h.farClipPlane/h.nearClipPlane,c.y=h.farClipPlane/h.nearClipPlane,c.z=c.x/h.farClipPlane,c.w=c.y/h.farClipPlane,this.uniforms._ZBufferParams.value=c}if(this.uniforms._ScreenParams){const c=this.uniforms._ScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScreenParams.value=c}if(this.uniforms._ScaledScreenParams){const c=this.uniforms._ScaledScreenParams.value;c.x=n.domWidth,c.y=n.domHeight,c.z=1+1/c.x,c.w=1+1/c.y,this.uniforms._ScaledScreenParams.value=c}}const r=this.depthTextureUniform;r&&(r.value=n.depthTexture);const l=this.opaqueTextureUniform;if(l&&(l.value=n.opaqueColorTexture),i){const c=this._rendererData;c.updateFrom(i),this.uniforms[this._worldToObjectName].value=c.worldToObject,this.uniforms[this._objToWorldName].value=c.objectToWorld}this.uniformsNeedUpdate=!0}};let Mn=Xe;a(Mn,"viewProjection",new ce),a(Mn,"_viewProjectionValues",[]),a(Mn,"viewMatrix",new ce),a(Mn,"_viewMatrixValues",[]),a(Mn,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),a(Mn,"_worldSpaceCameraPos",new x),a(Mn,"_mainLightColor",new Ce),a(Mn,"_mainLightPosition",new x),a(Mn,"_lightData",new Ce);class E2{constructor(t,e){a(this,"parser");a(this,"identifier");this.parser=t,this.identifier=e}get name(){return Rl}loadMaterial(t){const e=this.parser.json.materials[t];if(!e)return ks&&console.log(t,this.parser.json.materials),null;if(!e.extensions||!e.extensions[Rl])return ks&&console.log(`Material ${t} does not use NEEDLE_techniques_webgl`),null;ks&&console.log(`Material ${t} uses NEEDLE_techniques_webgl`,e);const i=e.extensions[Rl].technique;if(i<0)return console.debug(`Material ${t} does not have a valid technique index`),null;const n=this.parser.json.extensions[Rl];if(!n)return ks?console.error("Missing shader data",this.parser.json.extensions):console.debug("Missing custom shader data in parser.json.extensions"),null;ks&&console.log(n);const o=n.techniques[i];return o?new Promise(async(r,l)=>{var b,v,w;const c=await GM(n,o.program),h=c==null?void 0:c.fragmentShader,d=c==null?void 0:c.vertexShader;if(!h||!d)return l();ks&&console.log("loadMaterial",e,c);const u={},f=o.uniforms;(d.includes("_Time")||h.includes("_Time"))&&(u._Time={value:new Ce(0,0,0,0)}),(d.includes("_SinTime")||h.includes("_SinTime"))&&(u._SinTime={value:new Ce(0,0,0,0)}),(d.includes("_CosTime")||h.includes("_CosTime"))&&(u._CosTime={value:new Ce(0,0,0,0)}),(d.includes("unity_DeltaTime")||h.includes("unity_DeltaTime"))&&(u.unity_DeltaTime={value:new Ce(0,0,0,0)});for(const P in f){const E=P;switch(E){case"_TimeParameters":const T=new Ce;u[E]={value:T};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":u[E]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":u[E]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":u[E]={value:null};break;default:case"_ScreenParams":case"_ZBufferParams":case"_ProjectionParams":u[E]={value:[0,0,0,0]};break;case"_CameraOpaqueTexture":case"_CameraDepthTexture":u[E]={value:null};break}}let p=!1;if(e.extensions&&e.extensions[Rl]){const P=e.extensions[Rl];if(P.technique===i){ks&&console.log(e.name,"Material Properties",P);for(const E in P.values){const T=P.values[E];if(typeof T=="string"){if(T.startsWith("/textures/")){const k=T.substring(10),z=Number.parseInt(k);if(z>=0){const L=await this.parser.getDependency("texture",z);L instanceof Ke&&(L.colorSpace=Xo,L.needsUpdate=!0),u[E]={value:L};continue}}switch(E){case"alphaMode":T==="BLEND"&&(p=!0);continue}}if(Array.isArray(T)&&T.length===4){u[E]={value:new Ce(T[0],T[1],T[2],T[3])};continue}u[E]={value:T}}}}const g=new Mn(this.identifier,{name:e.name??"",uniforms:u,vertexShader:d,fragmentShader:h,lights:!1});switch(g.glslVersion=CR,g.vertexShader=g.vertexShader.replace("#version 300 es",""),g.fragmentShader=g.fragmentShader.replace("#version 300 es",""),(b=u._Cull)==null?void 0:b.value){case hd.Off:g.side=vn;break;case hd.Front:g.side=Qp;break;case hd.Back:g.side=Gr;break;default:g.side=Gr;break}switch((v=u._ZTest)==null?void 0:v.value){case Po.Equal:g.depthTest=!0,g.depthFunc=MR;break;case Po.NotEqual:g.depthTest=!0,g.depthFunc=ER;break;case Po.Less:g.depthTest=!0,g.depthFunc=kR;break;case Po.LEqual:g.depthTest=!0,g.depthFunc=OR;break;case Po.Greater:g.depthTest=!0,g.depthFunc=TR;break;case Po.GEqual:g.depthTest=!0,g.depthFunc=RR;break;case Po.Always:g.depthTest=!1,g.depthFunc=PR;break}g.transparent=p,p&&(g.depthWrite=!1),VM(u),g.onUpdateUniforms();for(const P in f){const E=P,T=f[P].type;if(((w=u[E])==null?void 0:w.value)===void 0)switch(T){case w_.SAMPLER_2D:u[E]={value:$M},console.warn("Missing/unassigned texture, fallback to white: "+E);break;default:E==="unity_OrthoParams"||console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+E,f[P]);break}}ks&&console.log(g.uuid,u),C1(g),r(g)}):null}}function C1(s){if(s.uniforms){ks&&console.log("Uniforms:",s.uniforms);for(const e in s.uniforms)switch(t(e,e),e){case"_Color":t("color",e);break}}function t(e,i){Object.getOwnPropertyDescriptor(s,e)||Object.defineProperty(s,e,{get:()=>s.uniforms[i].value,set:n=>{s.uniforms[i].value=n,s.needsUpdate=!0}})}}const M2=S("debugextensions");let mp;const A2=rs(()=>import("./index.7ca59d31.js"),["./index.7ca59d31.js","./three@0.169.11.js"],import.meta.url).then(async s=>(mp=s.GLTFAnimationPointerExtension,mp)).catch(s=>{console.warn("Failed to import GLTFLoaderAnimationPointer. Please use @needle-tools/three-animationpointer for full KHR_animation support",s)}),el=new Array;function U3(s){el.includes(s)||el.push(s)}function N3(s){const t=el.indexOf(s);t>=0&&el.splice(t,1)}function P1(s){if(s instanceof Yo){const t=new S1;return s.register(e=>(t.parser=e,t)),t}return null}class I2{resolvePath(t){return t.includes("/extensions/builtin_components/")?t.replace("/extensions/builtin_components/","/userData/components/"):t.includes("extensions/builtin_components/")?t.replace("extensions/builtin_components/","/userData/components/"):t}}async function S_(s,t,e){const i=e.indexOf("?");i>=0&&(e=e.substring(0,i)),s.register(n=>new S2(n)),s.register(n=>new JE(n)),s.register(n=>new BM(n,t.lightmaps,e)),s.register(n=>new C2(n,e,t)),s.register(n=>new E2(n,e)),s.register(n=>new cd(n,e)),s.register(n=>new pt(n)),s.register(n=>new b2(n)),gE()&&s.register(n=>new ed(n)),await A2.catch(n=>{}),s.register(n=>{if(mp){const o=new mp(n);return o.setAnimationPointerResolver.bind(o)(new I2),o}else return(M2||U())&&console.error("Missing KHR_animation_pointer extension..."),{name:"KHR_animation_pointer_NOT_AVAILABLE"}});for(const n of el)n.onImport&&n.onImport(s,e,t)}function R1(s,t){for(const e of el)e.onExport&&e.onExport(s,t)}function D2(s,t,e){for(const i of el)i.onLoaded&&i.onLoaded(s,t,e)}var T1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Ph=S("debugreflectionprobe"),zx=S("noreflectionprobe"),Zg=Symbol("reflectionProbeKey"),Ux=Symbol("original material"),Ds=class extends j{constructor(){var e;super();a(this,"_texture");a(this,"center");a(this,"size");a(this,"_boxHelper");Ds._probes.has(this.context)||Ds._probes.set(this.context,[]),(e=Ds._probes.get(this.context))==null||e.push(this)}static isUsingReflectionProbe(e){var i;return!!(e[Zg]||(i=e[Ux])!=null&&i[Zg])}static get(e,i,n,o){if(!e||e.isObject3D!==!0||zx)return null;const r=Ds._probes.get(i);if(r){for(const l of r)if(l.__didAwake||l.__internalAwake(),l.activeAndEnabled){if(o){if(l.gameObject===o)return l}else if(l.isInBox(e))return Ph&&console.log("Found reflection probe",e.name,l.name),l}}return Ph&&console.debug("Did not find reflection probe",e.name,n,e),null}set texture(e){if(e&&!(e instanceof Ke)){console.error("ReflectionProbe.texture must be a Texture",e);return}this._texture=e,e&&(e.mapping=zo,e.colorSpace=Xo,e.needsUpdate=!0)}get texture(){return this._texture}isInBox(e){var i;return(i=this._boxHelper)==null?void 0:i.isInBox(e)}awake(){this._boxHelper=this.gameObject.addComponent(un),this._boxHelper.updateBox(!0),Ph&&this._boxHelper.showHelper(5592320,!0),this._texture&&(this._texture.mapping=zo,this._texture.colorSpace=Xo,this._texture.needsUpdate=!0)}start(){!this._texture&&U()&&(console.warn(`[ReflectionProbe] Missing texture. Please assign a custom cubemap texture. To use reflection probes assign them to your renderer's "anchor" property.`),ke("ReflectionProbe configuration hint: See browser console for details"))}onDestroy(){const e=Ds._probes.get(this.context);if(e){const i=e.indexOf(this);i>=0&&e.splice(i,1)}}onSet(e){var n;if(zx||!this.enabled||((n=e.sharedMaterials)==null?void 0:n.length)<=0||!this.texture)return;let i=Ds._rendererMaterialsCache.get(e);i||(i=[],Ds._rendererMaterialsCache.set(e,i));for(let o=0;o<e.sharedMaterials.length;o++){const r=e.sharedMaterials[o];if(!r||r.envMap===void 0||r instanceof Be)continue;let l=i[o];const c=r===(l==null?void 0:l.copy),h=!l||l.material.uuid!==r.uuid||l.copy.version!==r.version;if(!c&&h){if(Ph){let f="";l?l.material!==r?f="reference changed; cached instance?: "+c:l.copy.version!==r.version&&(f="version changed"):f="not cached",console.warn("Cloning material",r.name,r.version,"Reason:",f,`
`,r.uuid,`
`,l==null?void 0:l.copy.uuid,`
`,e.name)}const u=r.clone();u.version=r.version,l?(l.copy=u,l.material=r):(l={material:r,copy:u},i.push(l)),u[Zg]=this,u[Ux]=r,Ph&&console.log("Set reflection",e.name,e.guid)}l&&l.copy&&(l.copy.onBeforeCompile=r.onBeforeCompile);const d=l==null?void 0:l.copy;d.envMap=this.texture,e.sharedMaterials[o]=d}}onUnset(e){const i=Ds._rendererMaterialsCache.get(e);if(i)for(let n=0;n<i.length;n++){const o=i[n];e.sharedMaterials[n]=o.material}}};let qs=Ds;a(qs,"_probes",new Map),a(qs,"_rendererMaterialsCache",new Map);T1([m(x)],qs.prototype,"center",void 0);T1([m(x)],qs.prototype,"size",void 0);const Ui=S("debuginstancing"),Ap=class{constructor(){a(this,"objs",[])}setup(t,e,i,n,o,r=0){t.applySettings(e);const l=this.tryCreateOrAddInstance(e,i,o);if(l){n===null&&(n=[]),n.push(l),pt.assignTextureLOD(l.renderer.material,0);for(let c=0;c<t.sharedMeshes.length;c++){const h=t.sharedMeshes[c],d=h.geometry;pt.assignMeshLOD(h,0).then(u=>{u&&t.activeAndEnabled&&d!=u&&l.setGeometry(u)})}}else if(r<=0&&e.type!=="Mesh"){const c=r+1;for(const h of e.children)n=this.setup(t,h,i,n,o,c)}return r===0&&o.useMatrixWorldAutoUpdate&&n&&n.length>=0&&this.autoUpdateInstanceMatrix(e),n}tryCreateOrAddInstance(t,e,i){if(t.type==="Mesh"){const n=i.foundMeshes;if(i.foundMeshes+=1,!i.rend.enableInstancing)return null;if(i.rend.enableInstancing!==!0){if(n>=i.rend.enableInstancing.length)return Ui&&console.error("Something is wrong with instance setup",t,i.rend.enableInstancing,n),null;if(!i.rend.enableInstancing[n])return null}const o=t,r=o.material;for(const u of this.objs){if(!u.canAdd(o.geometry,r))continue;return u.addInstance(o)}let l=Ap.getStartInstanceCount(t);(!l||l<0)&&(l=4);let c=t.name;c!=null&&c.length||(c=$T());const h=new O1(c,o.geometry,r,l,e);return this.objs.push(h),h.addInstance(o)}return null}autoUpdateInstanceMatrix(t){const e=t.matrixWorld.multiplyMatrices.bind(t.matrixWorld),i=t.matrixWorld.clone(),n=(o,r)=>{const l=e(o,r);return(t[Vd]||i.equals(l)===!1)&&(i.copy(l),t[Vd]=!0),l};t.matrixWorld.multiplyMatrices=n}};let ja=Ap;a(ja,"instance",new Ap),a(ja,"getStartInstanceCount",t=>4);const Id=class{constructor(t,e){a(this,"object");a(this,"renderer");a(this,"__instanceIndex",-1);a(this,"__reservedVertexRange",0);a(this,"__reservedIndexRange",0);a(this,"__geometryIndex",-1);a(this,"meshInformation");this.__instanceIndex=-1,this.object=t,this.renderer=e,t[OC]=e,this.meshInformation=Oa(t.geometry),Id.all.push(this)}get name(){return this.object.name}get isActive(){return this.__instanceIndex>=0}get vertexCount(){return this.object.geometry.attributes.position.count}get maxVertexCount(){return Math.max(this.meshInformation.vertexCount,this.vertexCount)}get reservedVertexCount(){return this.__reservedVertexRange}get indexCount(){return this.object.geometry.index?this.object.geometry.index.count:0}get maxIndexCount(){return Math.max(this.meshInformation.indexCount,this.indexCount)}get reservedIndexCount(){return this.__reservedIndexRange}updateMeshInformation(){const t=Oa(this.object.geometry),e=this.meshInformation.vertexCount,i=this.meshInformation.indexCount;return Object.assign(this.meshInformation,t),e!==this.meshInformation.vertexCount||i!==this.meshInformation.indexCount}updateInstanceMatrix(t=!1,e=!0){this.__instanceIndex<0||(e&&this.object.updateWorldMatrix(!0,t),this.renderer.updateInstance(this.object.matrixWorld,this.__instanceIndex))}setMatrix(t){this.__instanceIndex<0||this.renderer.updateInstance(t,this.__instanceIndex)}setGeometry(t){if(this.__geometryIndex<0)return!1;const e=this;if(this.vertexCount>this.__reservedVertexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved vertex range is too small: ${this.__reservedVertexRange.toLocaleString()} < ${this.vertexCount.toLocaleString()} vertices for ${this.name}`);if(this.indexCount>this.__reservedIndexRange)return i(`Instancing: Can not update geometry (${this.name}), reserved index range is too small: ${this.__reservedIndexRange.toLocaleString()} < ${this.indexCount.toLocaleString()} indices for ${this.name}`);return this.renderer.updateGeometry(t,this.__geometryIndex);function i(n){return e.updateMeshInformation()&&(e.renderer.remove(e,!0),e.renderer.add(e))?!0:((U()||Ui)&&console.error(n),!1)}}add(){this.__instanceIndex>=0||(this.renderer.add(this),C.markAsInstancedRendered(this.object,!0))}remove(t){if(!(this.__instanceIndex<0)&&(this.renderer.remove(this,t),C.markAsInstancedRendered(this.object,!1),t)){const e=Id.all.indexOf(this);e>=0&&Id.all.splice(e,1)}}};let dd=Id;a(dd,"all",[]);class O1{constructor(t,e,i,n,o){a(this,"allowResize",!0);a(this,"name","");a(this,"geometry");a(this,"material");a(this,"_context");a(this,"_batchedMesh");a(this,"_handles",[]);a(this,"_geometryIds",new Map);a(this,"_maxInstanceCount");a(this,"_currentInstanceCount",0);a(this,"_currentVertexCount",0);a(this,"_currentIndexCount",0);a(this,"_maxVertexCount");a(this,"_maxIndexCount");a(this,"_needUpdateBounds",!1);a(this,"_debugMaterial",null);a(this,"onBeforeRender",()=>{this._batchedMesh.layers.enableAll(),this._needUpdateBounds&&this._batchedMesh[Wh]===!0&&(Ui==="verbose"&&console.log("Update instancing bounds",this.name,this._batchedMesh.matrixWorldNeedsUpdate),this.updateBounds())});a(this,"onAfterRender",()=>{this._batchedMesh.layers.disableAll()});this.name=t,this.geometry=e,this.material=i,this._context=o,this._maxInstanceCount=Math.max(2,n),Ui&&(this._debugMaterial=Nx());const r=this.tryEstimateVertexCountSize(this._maxInstanceCount,[e],n);this._maxVertexCount=r.vertexCount,this._maxIndexCount=r.indexCount,this._batchedMesh=new j0(this._maxInstanceCount,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material),this._batchedMesh[Wh]=!0,this._batchedMesh.visible=!0,this._context.scene.add(this._batchedMesh),i instanceof Nw&&(i.defines.USE_INSTANCING=!0,i.needsUpdate=!0),o.pre_render_callbacks.push(this.onBeforeRender),o.post_render_callbacks.push(this.onAfterRender),Ui&&console.log(`Instanced renderer created with ${this._maxInstanceCount} instances, ${this._maxVertexCount} max vertices and ${this._maxIndexCount} max indices for "${t}"`)}get batchedMesh(){return this._batchedMesh}get visible(){return this._batchedMesh.visible}set visible(t){this._batchedMesh.visible=t}get castShadow(){return this._batchedMesh.castShadow}set castShadow(t){this._batchedMesh.castShadow=t}set receiveShadow(t){this._batchedMesh.receiveShadow=t}get count(){return this._currentInstanceCount}updateBounds(t=!0,e=!0){if(this._needUpdateBounds=!1,t&&this._batchedMesh.computeBoundingBox(),e&&this._batchedMesh.computeBoundingSphere(),Ui&&this._batchedMesh.boundingSphere){const i=this._batchedMesh.boundingSphere;G.DrawWireSphere(i.center,i.radius,65280)}}canAdd(t,e){return this._maxVertexCount>1e7||e!==this.material||!this.validateGeometry(t)?!1:!!(!this.mustGrow(t)||this.allowResize)}dispose(){Ui&&console.warn("Dispose instanced renderer",this.name),this._context.scene.remove(this._batchedMesh),this._batchedMesh.dispose(),this._batchedMesh=null,this._handles=[]}addInstance(t){const e=new dd(t,this);t.castShadow===!0&&this._batchedMesh.castShadow===!1&&(this._batchedMesh.castShadow=!0),t.receiveShadow===!0&&this._batchedMesh.receiveShadow===!1&&(this._batchedMesh.receiveShadow=!0);try{this.add(e)}catch(i){if(console.error(`Failed adding mesh to instancing (object name: "${t.name}", instances: ${this._currentInstanceCount.toLocaleString()}/${this._maxInstanceCount.toLocaleString()}, vertices: ${this._currentVertexCount.toLocaleString()}/${this._maxVertexCount.toLocaleString()}, indices: ${this._currentIndexCount.toLocaleString()}/${this._maxIndexCount.toLocaleString()})
`,i),U()){tm("Failed instancing mesh. See the browser console for details.");debugger}return null}return e}add(t){const e=t.object.geometry;if(!e||!e.attributes)return console.error("Cannot add object to instancing without geometry",t.name),!1;if(this.mustGrow(e))if(this.allowResize)this.grow(e);else return console.error("Cannot add instance, max count reached",this.name,this.count,this._maxInstanceCount),!1;return t.object.updateWorldMatrix(!0,!0),this.addGeometry(t),this._handles[t.__instanceIndex]=t,this._currentInstanceCount+=1,this.markNeedsUpdate(),this._currentInstanceCount>0&&(this._batchedMesh.visible=!0),!0}remove(t,e){t&&(t.__instanceIndex<0||this._handles[t.__instanceIndex]!=t||this._currentInstanceCount<=0||(this.removeGeometry(t,e),this._handles[t.__instanceIndex]=null,t.__instanceIndex=-1,this._currentInstanceCount>0&&(this._currentInstanceCount-=1),this._currentInstanceCount<=0&&(this._batchedMesh.visible=!1),this.markNeedsUpdate()))}updateInstance(t,e){this._batchedMesh.setMatrixAt(e,t),this.markNeedsUpdate()}updateGeometry(t,e){return this.validateGeometry(t)?(this.mustGrow()&&this.grow(t),Ui&&console.debug("[Instancing] UPDATE GEOMETRY at "+e,this._batchedMesh._geometryCount,t.name,Oa(t),t.attributes.position.count,t.index?t.index.count:0),this._batchedMesh.setGeometryAt(e,t),this._geometryIds.set(t,e),this.markNeedsUpdate(),!0):!1}validateGeometry(t){const e=this.geometry;for(const i in e.attributes)if(i!=="batchId"&&!t.hasAttribute(i))return U()&&console.warn(`BatchedMesh: Added geometry missing "${i}". All geometries must have consistent attributes.`),!1;return!0}markNeedsUpdate(){Ui==="verbose"&&console.warn("Marking instanced mesh dirty",this.name),this._needUpdateBounds=!0}mustGrow(t){if(this.count>=this._maxInstanceCount)return!0;if(!t||!t.attributes)return!1;const e=Oa(t),i=e.vertexCount,n=e.indexCount;return this._currentVertexCount+i>this._maxVertexCount||this._currentIndexCount+n>this._maxIndexCount}grow(t){var h,d;const i=Math.ceil(this._maxInstanceCount*2),n=this.tryEstimateVertexCountSize(i,[t]),o=Math.max(this._maxVertexCount,n.vertexCount),r=Math.max(this._maxIndexCount,n.indexCount,Math.ceil(this._maxVertexCount*2));if(Ui){const u=Oa(t);console.warn(`[Instancing] Growing Buffer
Mesh: "${this.name}${(h=t.name)!=null&&h.length?"/"+t.name:""}"
${u.vertexCount} vertices, ${u.indexCount} indices
Max count ${this._maxInstanceCount} â†’ ${i}
Max vertex count ${this._maxVertexCount} -> ${o}
Max index count ${this._maxIndexCount} -> ${r}`),this._debugMaterial=Nx()}else U()&&console.debug(`[Instancing] Growing Buffer
Mesh: "${this.name}${(d=t.name)!=null&&d.length?"/"+t.name:""}"
Max count ${this._maxInstanceCount} â†’ ${i}
Max vertex count ${this._maxVertexCount} -> ${o}
Max index count ${this._maxIndexCount} -> ${r}`);this._maxVertexCount=o,this._maxIndexCount=r;const l=new j0(i,this._maxVertexCount,this._maxIndexCount,this._debugMaterial??this.material);l.layers=this._batchedMesh.layers,l.castShadow=this._batchedMesh.castShadow,l.receiveShadow=this._batchedMesh.receiveShadow,l.visible=this._batchedMesh.visible,l[Wh]=this._batchedMesh[Wh],l.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,l.matrixWorldNeedsUpdate=this._batchedMesh.matrixWorldNeedsUpdate,l.matrixAutoUpdate=this._batchedMesh.matrixAutoUpdate,l.matrixWorld.copy(this._batchedMesh.matrixWorld),l.matrix.copy(this._batchedMesh.matrix),this._batchedMesh.dispose(),this._batchedMesh.removeFromParent(),this._geometryIds.clear(),this._batchedMesh=l,this._maxInstanceCount=i;const c=[...this._handles];this._handles=[];for(const u of c)u&&u.__instanceIndex>=0&&(this.addGeometry(u),this._handles[u.__instanceIndex]=u);this._context.scene.add(l)}tryEstimateVertexCountSize(t,e,i=1){const n=new Map;for(const u of this._handles)if(u&&u.__instanceIndex>=0&&u.object.geometry)if(n.has(u.object.geometry)){const f=n.get(u.object.geometry);f.count+=1}else{const p={count:1,...Oa(u.object.geometry)};n.set(u.object.geometry,p)}let o=0,r=0;for(const[u,f]of n)o+=f.vertexCount*f.count,r+=f.indexCount*f.count;let c=Math.ceil(o/Math.max(1,this._currentInstanceCount))*t,d=Math.ceil(r/Math.max(1,this._currentInstanceCount))*t*2;if(e)for(const u of e){const f=Oa(u);f!=null&&(c+=f.vertexCount*i,d+=f.indexCount*i)}return{vertexCount:c,indexCount:d}}addGeometry(t){const i=t.object.geometry;if(!i)return;let n=this._geometryIds.get(i);n==null?(Ui&&console.debug(`[Instancing] > ADD NEW GEOMETRY "${t.name} (${i.name}; ${i.uuid})"
${this._currentInstanceCount} instances, ${t.maxVertexCount} max vertices, ${t.maxIndexCount} max indices`),n=this._batchedMesh.addGeometry(i,t.maxVertexCount,t.maxIndexCount),this._geometryIds.set(i,n)):Ui==="verbose"&&console.log(`[Instancing] > ADD INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances`),this._currentVertexCount+=t.maxVertexCount,this._currentIndexCount+=t.maxIndexCount;const o=this._batchedMesh.addInstance(n);t.__geometryIndex=n,t.__instanceIndex=o,t.__reservedVertexRange=t.maxVertexCount,t.__reservedIndexRange=t.maxIndexCount,this._batchedMesh.setMatrixAt(o,t.object.matrixWorld),Ui&&console.debug(`[Instancing] > ADDED INSTANCE "${t.name}"
GEOMETRY_ID=${n}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`)}removeGeometry(t,e){if(t.__instanceIndex<0){console.warn("Cannot remove geometry, instance index is invalid",t.name);return}Ui&&console.debug(`[Instancing] < REMOVE INSTANCE "${t.name}" at [${t.__instanceIndex}]
GEOMETRY_ID=${t.__geometryIndex}
${this._currentInstanceCount} instances
Index: ${t.__instanceIndex}`),this._batchedMesh.deleteInstance(t.__instanceIndex)}}a(O1,"nullMatrix",new ce);function Oa(s){var n,o;if(!s)return U()&&console.error("Cannot get mesh information from null geometry"),{vertexCount:0,indexCount:0};let t=((o=(n=s.attributes)==null?void 0:n.position)==null?void 0:o.count)||0,e=s.index?s.index.count:0;const i=pt.getMeshLODExtension(s);if(i){const r=i.lods[0];let l=r.vertexCount,c=r.indexCount;const h=Math.min(200,Math.ceil(l*.05));l+=h,c+=20,t=Math.max(t,l),e=Math.max(e,c)}return t=Math.ceil(t),e=Math.ceil(e),{vertexCount:t,indexCount:e}}function Nx(){const s=new It({color:new de(Math.random(),Math.random(),Math.random())});return s.emissive=s.color,s.emissiveIntensity=.3,S("wireframe")&&(s.wireframe=!0),s}const Tl=S("debuglightmaps");class C_{constructor(t,e){a(this,"lightmapIndex",-1);a(this,"lightmapScaleOffset",new Ce(1,1,0,0));a(this,"context");a(this,"gameObject");a(this,"lightmapTexture",null);a(this,"lightmapScaleOffsetUniform",{value:new Ce(1,1,0,0)});a(this,"lightmapUniform",{value:null});a(this,"onBeforeCompile",(t,e)=>{Tl&&console.log(`Lightmaps, before compile
`,t),this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,t.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform});this.gameObject=t,this.context=e}get lightmap(){return this.lightmapTexture}set lightmap(t){t!==this.lightmapTexture&&(this.lightmapTexture=t,this.applyLightmap(),this.lightmapTexture&&pt.assignTextureLOD(this.lightmapTexture,0).then(e=>{e!=null&&e.isTexture&&(this.lightmapTexture=e)}))}init(t,e,i){console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=t,!(this.lightmapIndex<0)&&(this.lightmapScaleOffset=e,this.lightmapTexture=i,pt.assignTextureLOD(i,0).then(n=>{n!=null&&n.isTexture&&(this.lightmapTexture=n)}),Tl=="show"?(console.log("Lightmap:",this.gameObject.name,t,`
ScaleOffset:`,e,`
Texture:`,i),this.setLightmapDebugMaterial()):Tl&&console.log("Use debuglightmaps=show to render lightmaps only in the scene."),this.applyLightmap())}updateLightmapUniforms(t){const e=t.uniforms;e&&e.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,e.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}applyLightmap(){if(this.gameObject.type==="Object3D"){Tl&&console.warn("Can not add lightmap. Is this object missing a renderer?",this.gameObject.name);return}if(this.gameObject.type==="Group"){this.gameObject["Needle:Multimaterial-LightmapWarning"]===void 0&&(this.gameObject["Needle:Multimaterial-LightmapWarning"]=!0,console.warn("Lightmap on multimaterial object is not supported yet... please open a feature request on https://github.com/needle-tools/needle-engine-support if your project requires it"));return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const t=this.gameObject;if(t.geometry.getAttribute("uv1")||t.geometry.setAttribute("uv1",t.geometry.getAttribute("uv")),Array.isArray(this.gameObject.material)){const e=this.gameObject.material;for(let i=0;i<e.length;i++)e[i]=this.ensureLightmapMaterial(e[i])}else this.gameObject.material=this.ensureLightmapMaterial(this.gameObject.material);if(this.lightmapIndex>=0&&this.lightmapTexture){this.lightmapTexture.channel=1;const e=this.gameObject.material;if(Array.isArray(e))for(const i of e)this.assignLightmapTexture(i);else e&&this.assignLightmapTexture(e)}}ensureLightmapMaterial(t){var e;if(t.userData||(t.userData={}),t["NEEDLE:lightmap-material-version"]!=t.version&&t["NEEDLE:lightmap-material-version"]==null){Tl&&console.warn("Cloning material for lightmap "+t.name);const i=t.clone();(e=i.name)!=null&&e.includes("(lightmap)")||(i.name=t.name+" (lightmap)"),t=i,t.onBeforeCompile=this.onBeforeCompile}return t}assignLightmapTexture(t){!t||t instanceof Ey&&t.transmission>0||!(t.lightMap!==this.lightmapTexture||t["NEEDLE:lightmap-material-version"]!==t.version)||(Tl&&console.log("Assigning lightmap",t.name,t.version,t),t.lightMap=this.lightmapTexture,t["NEEDLE:lightmap-material-version"]=t.version)}setLightmapDebugMaterial(){this.gameObject.material=new to({vertexShader:`
                varying vec2 vUv1;
                void main()
                {
                    vUv1 = uv1;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightMap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv1;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv1.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightMap, lUv);
                    gl_FragColor = lightMapTexel;
                    gl_FragColor.a = 1.;
                }
                `,defines:{USE_LIGHTMAP:""}})}}var sr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Fl=S("debugrenderer"),$x=S("debugskinnedmesh"),Wx=S("noinstancing"),L2=S("wireframe");var Vl;(function(s){s[s.Off=0]="Off",s[s.BlendProbes=1]="BlendProbes",s[s.BlendProbesAndSkybox=2]="BlendProbesAndSkybox",s[s.Simple=3]="Simple"})(Vl||(Vl={}));class j2{constructor(){a(this,"path",null);a(this,"asset",null);a(this,"default")}}var Vx;(function(s){s[s.Both=0]="Both",s[s.Back=1]="Back",s[s.Front=2]="Front"})(Vx||(Vx={}));class B2{constructor(t,e){a(this,"_renderer");a(this,"_targets",[]);a(this,"_indexMapMaxIndex");a(this,"_indexMap");a(this,"_changed",!1);this._renderer=t;const i=this.setMaterial.bind(this),n=this.getMaterial.bind(this),o=t.gameObject;if(this._targets=[],o)switch(o.type){case"Group":this._targets=[...o.children];break;case"SkinnedMesh":case"Mesh":this._targets.push(o);break}let r=!1,l,c=0;for(let h=0;h<this._targets.length;h++){const d=this._targets[h];if(!d)continue;const u=d.material;if(u){u.shadowSide=u.side;for(let f=0;f<e.length;f++){const p=e[f];if(!p){r=!0;continue}if(u.name===p.name){l===void 0&&(l=new Map),l.set(f,h),c=Math.max(c,f);break}}}}if(r){this._indexMapMaxIndex=c,this._indexMap=l;const h=`Renderer ${t.name} was initialized with missing materials - this may lead to unexpected behaviour when trying to access sharedMaterials by index.`;console.warn(h),fs()&&ke("Found renderer with missing materials: please check the console for details.")}return new Proxy(this,{get(h,d){if(typeof d=="string"){const u=parseInt(d);if(!isNaN(u))return n(u)}return h[d]},set(h,d,u){return typeof d=="string"&&i(u,Number.parseInt(d)),Reflect.set(h,d,u)?(u instanceof Ie&&(h.changed=!0),!0):!1}})}get changed(){return this._changed}set changed(t){t===!0&&Fl&&console.warn("SharedMaterials have changed: "+this._renderer.name,this),this._changed=t}is(t){return this._renderer===t}get length(){return this._indexMapMaxIndex!==void 0?this._indexMapMaxIndex+1:this._targets.length}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.getMaterial(t)}resolveIndex(t){const e=this._indexMap;return e&&e.has(t)?e.get(t):t}setMaterial(t,e){if(e=this.resolveIndex(e),e<0||e>=this._targets.length)return;const i=this._targets[e];!i||i.material===void 0||(i.material=t,this.changed=!0)}getMaterial(t){if(t=this.resolveIndex(t),t<0)return null;const e=this._targets;if(t>=e.length)return null;const i=e[t];return i?i.material:null}}class Ve extends j{constructor(){super(...arguments);a(this,"receiveShadows",!1);a(this,"shadowCastingMode",gp.Off);a(this,"lightmapIndex",-1);a(this,"lightmapScaleOffset",new Ce(1,1,0,0));a(this,"enableInstancing");a(this,"renderOrder");a(this,"allowOcclusionWhenDynamic",!0);a(this,"probeAnchor");a(this,"reflectionProbeUsage",Vl.Off);a(this,"_lightmaps");a(this,"_sharedMeshes",[]);a(this,"_sharedMaterials");a(this,"_originalMaterials");a(this,"_probeAnchorLastFrame");a(this,"_lightmapTextureOverride");a(this,"allowProgressiveLoading",!0);a(this,"_firstFrame",-1);a(this,"_isInstancingEnabled",!1);a(this,"_handles");a(this,"_handlesTempArray",[]);a(this,"onBeforeRenderThree",(e,i,n,o,r,l)=>{var c;if(r.envMapIntensity!==void 0){const h=this.hasLightmap?Math.PI:1,d=((c=this.context.mainCameraComponent)==null?void 0:c.environmentIntensity)??1;r.envMapIntensity=Math.max(0,d*this.context.sceneLighting.environmentIntensity/h)}if(this._lightmaps)for(const h of this._lightmaps)h.updateLightmapUniforms(r),h.applyLightmap()});a(this,"_reflectionProbe",null)}static setInstanced(e,i){const n=am(e,Ve);return n.setInstancingEnabled(i),n}static isInstanced(e){const i=Bc(e,Ve);return i?i.isInstancingActive:cs.isUsingInstancing(e)}static setVisible(e,i){Io(e,i)}get sharedMesh(){if(this.gameObject.type==="Mesh")return this.gameObject;if(this.gameObject.type==="SkinnesMesh")return this.gameObject;if(this.gameObject.type==="Group")return this.gameObject.children[0]}get sharedMeshes(){if(this.destroyed||!this.gameObject)return this._sharedMeshes;if(this._sharedMeshes.length=0,this.gameObject.type==="Group")for(const e of this.gameObject.children)(e.type==="Mesh"||e.type==="SkinnedMesh")&&this._sharedMeshes.push(e);else(this.gameObject.type==="Mesh"||this.gameObject.type==="SkinnedMesh")&&this._sharedMeshes.push(this.gameObject);return this._sharedMeshes}get sharedMaterial(){return this.sharedMaterials[0]}set sharedMaterial(e){this.sharedMaterials[0]!==e&&(this.sharedMaterials[0]=e,this.applyLightmapping())}get material(){return this.sharedMaterials[0]}set material(e){this.sharedMaterial=e}set sharedMaterials(e){if(!this._originalMaterials)this._originalMaterials=e;else if(e){let i=!1;for(let n=0;n<this._sharedMaterials.length;n++){const o=n<e.length?e[n]:null;o&&o instanceof Ie?this.sharedMaterials[n]=o:i||(i=!0,console.warn("Can not assign null as material: "+this.name,o))}}}get sharedMaterials(){return this.__didAwake?((!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._originalMaterials||(this._originalMaterials=[]),this._sharedMaterials=new B2(this,this._originalMaterials)),this._sharedMaterials):null}static get shouldSuppressInstancing(){return Wx}get lightmap(){var e;return(e=this._lightmaps)!=null&&e.length?this._lightmaps[0].lightmap:null}set lightmap(e){var i;if(this._lightmapTextureOverride=e,e===void 0&&(e=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(i=this._lightmaps)!=null&&i.length)for(const n of this._lightmaps)n.lightmap=e}get hasLightmap(){const e=this.lightmap;return e!=null}registering(){this.enabled||this.setVisibility(!1)}awake(){if(this._firstFrame=this.context.time.frame,Fl&&console.log("Renderer ",this.name,this),this.clearInstancingState(),this.probeAnchor&&Fl&&this.probeAnchor.add(new yn(.2)),this._reflectionProbe=null,this.isMultiMaterialObject(this.gameObject)){for(const e of this.gameObject.children)this.context.addBeforeRenderListener(e,this.onBeforeRenderThree),e.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let e=0;for(let i=0;i<this.gameObject.children.length;i++){const n=this.gameObject.children[i];if(!(!this.isMeshOrSkinnedMesh(n)||C.getComponent(n,Ve))){if(this.renderOrder.length<=e){console.warn("Incorrect renderOrder element count",this,this.renderOrder.length+" but expected "+this.gameObject.children.length,"Index: "+e,"ChildElement:",n);continue}n.renderOrder=this.renderOrder[e],e+=1}}}}else this.isMeshOrSkinnedMesh(this.gameObject)?(this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree),this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0])):this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree);if(this.applyLightmapping(),L2)for(let e=0;e<this.sharedMaterials.length;e++){const i=this.sharedMaterials[e];i&&(i.wireframe=!0)}}applyLightmapping(){var e;if(this.lightmapIndex>=0){const i=this.gameObject.type,n=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(n){if(this._lightmaps||(this._lightmaps=[]),i==="Mesh"){const o=this.gameObject.material;if(o!=null&&o.isMeshBasicMaterial)o&&console.warn("Lightmapping is not supported on MeshBasicMaterial",o.name);else{if(this._lightmaps.length<=0){const l=new C_(this.gameObject,this.context);this._lightmaps.push(l)}this._lightmaps[0].init(this.lightmapIndex,this.lightmapScaleOffset,n)}}else if(this.isMultiMaterialObject(this.gameObject)&&this.sharedMaterials.length>0)for(let o=0;o<this.gameObject.children.length;o++){const r=this.gameObject.children[o];if(!((e=r.material)!=null&&e.isMeshBasicMaterial)){let l;o>=this._lightmaps.length?(l=new C_(r,this.context),this._lightmaps.push(l)):l=this._lightmaps[o],l.init(this.lightmapIndex,this.lightmapScaleOffset,n)}}}else Fl&&console.warn("Lightmap not found",this.sourceId,this.lightmapIndex)}}get isInstancingActive(){return this._handles!=null&&this._handles.length>0&&this._isInstancingEnabled}get instances(){if(!this._handles||this._handles.length<=0)return null;if(this._handlesTempArray.length=0,this._handles)for(const e of this._handles)this._handlesTempArray.push(e);return this._handlesTempArray}setInstancingEnabled(e){if(this._isInstancingEnabled===e)return e&&(this._handles===void 0||this._handles!=null&&this._handles.length>0);if(this._isInstancingEnabled=e,e){if(this.enableInstancing===void 0&&(this.enableInstancing=!0),this._handles===void 0){if(this._handles=ja.instance.setup(this,this.gameObject,this.context,null,{rend:this,foundMeshes:0,useMatrixWorldAutoUpdate:this.useInstanceMatrixWorldAutoUpdate()}),this._handles)return C.markAsInstancedRendered(this.gameObject,!0),!0}else if(this._handles!==null){for(const i of this._handles)i.updateInstanceMatrix(!0),i.add();return C.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this._handles)for(const i of this._handles)i.remove(this.destroyed);return!0}return!1}clearInstancingState(){this._isInstancingEnabled=!1,this._handles=void 0}useInstanceMatrixWorldAutoUpdate(){return!0}start(){if(this.enableInstancing&&!Wx&&(this.setInstancingEnabled(!0),cs.markDirty(this.gameObject)),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.isMultiMaterialObject(this.gameObject))for(let e=0;e<this.gameObject.children.length;e++){const i=this.gameObject.children[e];i.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this.sharedMeshes,this.setVisibility(!0),this._isInstancingEnabled||this.enableInstancing==!0||Array.isArray(this.enableInstancing)&&this.enableInstancing.some(i=>i)?this.__internalDidAwakeAndStart&&this.setInstancingEnabled(!0):this.enabled&&this.applyStencil(),this.updateReflectionProbe()}onDisable(){this.setVisibility(!1),this._handles&&this._handles.length>0&&this.setInstancingEnabled(!1)}onDestroy(){if(this._handles=null,this.isMultiMaterialObject(this.gameObject))for(const e of this.gameObject.children)this.context.removeBeforeRenderListener(e,this.onBeforeRenderThree);else this.context.removeBeforeRenderListener(this.gameObject,this.onBeforeRenderThree)}onBeforeRender(){var e,i,n,o,r;if(this.gameObject){if(this._probeAnchorLastFrame!==this.probeAnchor&&((e=this._reflectionProbe)==null||e.onUnset(this),this.updateReflectionProbe()),Fl==this.name&&this.gameObject instanceof X){this.gameObject.geometry.computeBoundingSphere();const l=q(this.gameObject.geometry.boundingSphere.center).applyMatrix4(this.gameObject.matrixWorld);G.DrawWireSphere(l,this.gameObject.geometry.boundingSphere.radius,56831)}if(this.isMultiMaterialObject(this.gameObject)&&((i=this.gameObject.children)==null?void 0:i.length)>0)for(const l of this.gameObject.children)this.applySettings(l);else this.applySettings(this.gameObject);if((n=this.sharedMaterials)!=null&&n.changed&&(this.sharedMaterials.changed=!1,this.applyLightmapping()),(o=this._handles)!=null&&o.length&&this.gameObject[Vd]===!0){this.gameObject[Vd]=!1;for(let c=this._handles.length-1;c>=0;c--)this._handles[c].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this._handles&&this._handles.length<=0&&C.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this._handles)for(let l=0;l<this._handles.length;l++){const c=this._handles[l];Io(c.object,!1)}if(this.reflectionProbeUsage!==Vl.Off&&this._reflectionProbe&&((r=this._lightmaps)!=null&&r.length||this._reflectionProbe.onSet(this)),this._sharedMaterials)for(const l of this._sharedMaterials)l&&"envMap"in l&&"envMapIntensity"in l&&!qs.isUsingReflectionProbe(l)&&(l.envMap=this.context.scene.environment);else Fl&&console.warn("[Renderer] sharedMaterials not initialized yet: "+this.name)}}onAfterRender(){if(this._isInstancingEnabled&&this._handles)for(let e=0;e<this._handles.length;e++){const i=this._handles[e];Io(i.object,!0)}this.reflectionProbeUsage!==Vl.Off&&this._reflectionProbe&&this._reflectionProbe.onUnset(this),this.static&&this.gameObject.matrixAutoUpdate&&(this.gameObject.matrixAutoUpdate=!1)}applyStencil(){cd.applyStencil(this)}applySettings(e){e.receiveShadow=this.receiveShadows,this.shadowCastingMode==gp.On?e.castShadow=!0:e.castShadow=!1}updateReflectionProbe(){this._reflectionProbe=null,this.reflectionProbeUsage!==Vl.Off&&(this.startCoroutine(this._updateReflectionProbe(),oe.LateUpdate),this._probeAnchorLastFrame=this.probeAnchor)}*_updateReflectionProbe(){const e=this.probeAnchor||this.gameObject,i=!!this.probeAnchor;this._reflectionProbe=qs.get(e,this.context,i,this.probeAnchor)}setVisibility(e){if(!this.isMultiMaterialObject(this.gameObject))Io(this.gameObject,e);else for(const i of this.gameObject.children)this.isMeshOrSkinnedMesh(i)&&Io(i,e)}isMultiMaterialObject(e){return e.type==="Group"}isMeshOrSkinnedMesh(e){return e.type==="Mesh"||e.type==="SkinnedMesh"}}sr([m()],Ve.prototype,"receiveShadows",void 0);sr([m()],Ve.prototype,"shadowCastingMode",void 0);sr([m()],Ve.prototype,"lightmapIndex",void 0);sr([m(Ce)],Ve.prototype,"lightmapScaleOffset",void 0);sr([m()],Ve.prototype,"enableInstancing",void 0);sr([m()],Ve.prototype,"renderOrder",void 0);sr([m()],Ve.prototype,"allowOcclusionWhenDynamic",void 0);sr([m(D)],Ve.prototype,"probeAnchor",void 0);sr([m()],Ve.prototype,"reflectionProbeUsage",void 0);class vm extends Ve{}class k1 extends vm{constructor(){super(...arguments);a(this,"_needUpdateBoundingSphere",!1)}awake(){var e;super.awake(),$x&&console.log('SkinnedMeshRenderer for "'+this.name+'"',this),this.allowOcclusionWhenDynamic=!1;for(const i of this.sharedMeshes)(e=i.parent)==null||e.updateWorldMatrix(!1,!0),this.markBoundsDirty()}onAfterRender(){if(super.onAfterRender(),this._needUpdateBoundingSphere){for(const e of this.sharedMeshes)if(e instanceof Ir){this._needUpdateBoundingSphere=!1;try{const i=e.geometry,n=eS(e);n&&(e.geometry=n),e.computeBoundingSphere(),e.geometry=i}catch(i){console.error(`Error updating bounding sphere for ${e.name}`,i)}}}if($x){for(const e of this.sharedMeshes)if(e instanceof Ir&&e.boundingSphere){const i=q(e.boundingSphere.center).applyMatrix4(e.matrixWorld);G.DrawWireSphere(i,e.boundingSphere.radius,"red")}}}markBoundsDirty(){this._needUpdateBoundingSphere=!0}}var gp;(function(s){s[s.Off=0]="Off",s[s.On=1]="On",s[s.TwoSided=2]="TwoSided",s[s.ShadowsOnly=3]="ShadowsOnly"})(gp||(gp={}));var E1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Yu=S("debuggltfexport");class M1 extends un{constructor(){super(...arguments);a(this,"sceneRoot")}}class Ws extends j{constructor(){super(...arguments);a(this,"binary",!0);a(this,"objects",[]);a(this,"ext")}async exportNow(e,i){Yu&&console.log("Exporting objects as glTF",this.objects),e||(e="scene"),(!this.objects||this.objects.length<=0)&&(this.objects=[this.context.scene]);const n={binary:this.binary,pivot:Ws.calculateCenter(this.objects),...i},o=await this.export(this.objects,n).catch(r=>(console.error(r),!1));return o===!1?!1:(this.binary?e.endsWith(".glb")||(e+=".glb"):e.endsWith(".gltf")||(e+=".gltf"),this.binary?Ws.saveArrayBuffer(o,e):Ws.saveJson(o,e),!0)}async export(e,i){if(!e||e.length<=0){console.warn("No objects set to export");return}const n=new Kw;n.register(d=>new $w(d)),n.register(d=>new w1(d)),R1(n,this.context),Ws.filterTopmostParent(e);const o={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:(i==null?void 0:i.animations)||Ws.collectAnimations(e),...i},r=new Array,l=new D;i!=null&&i.pivot&&l.position.sub(i.pivot),Yu&&console.log("EXPORT",e),e.forEach(d=>{d&&v_(d)&&(l.children.push(d),d.matrixAutoUpdate=!1,d.matrix.copy(d.matrixWorld),C.getComponentsInChildren(d,Ve).forEach(u=>{C.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}),d.traverse(u=>{if(!v_(u)){const f=u.parent;u.removeFromParent(),r.push(()=>{f&&f.add(u)})}}))});const c=new BC(l);return i!=null&&i.needleComponents&&(this.ext=new S1),this.ext&&(this.ext.registerExport(n),this.ext.context=c),new Promise((d,u)=>{Yu&&console.log("Starting glTF export.");try{n==null||n.parse(l,f=>{h(),d(f)},f=>{h(),u(f)},o)}catch(f){console.error(f),u(f)}finally{r.forEach(f=>f()),Yu&&console.log("Finished glTF export.")}});function h(){e.forEach(d=>{d&&(d.matrixAutoUpdate=!0,C.getComponentsInChildren(d,Ve).forEach(u=>{C.isActiveInHierarchy(u.gameObject)&&u.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(e,i){this.save(new Blob([e],{type:"application/octet-stream"}),i)}static saveJson(e,i){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),i)}static save(e,i){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),typeof e=="string"?n.href=e:n.href=URL.createObjectURL(e),n.download=i,n.click(),n.remove()}static collectAnimations(e,i){i=i||[];for(const n of e)n&&n.traverseVisible(o=>{o.animations&&o.animations.length>0&&i.push(...o.animations)});return i}static calculateCenter(e,i){const n=i||new x;return n.set(0,0,0),e.forEach(o=>{n.add(ae(o))}),n.divideScalar(e.length),n}static filterTopmostParent(e){if(!(e.length<=0))for(let i=0;i<e.length;i++){let n=e[i];if(!n){e.splice(i,1),i--;continue}for(;n.parent;){if(e.includes(n.parent)){e.splice(i,1),i--;break}n=n.parent}}}}E1([m()],Ws.prototype,"binary",void 0);E1([m(D)],Ws.prototype,"objects",void 0);typeof globalThis!==void 0&&!("OffscreenCanvas"in globalThis)&&(globalThis.OffscreenCanvas=class{constructor(t,e){a(this,"canvas");return this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.canvas.convertToBlob=(i,n)=>new Promise(o=>{this.canvas.toBlob(o,i,n)}),this.canvas}});const F2=S("debugprogress");function z2(s){s=s||new Date;const t=s.getMonth()+1,e=s.getDate(),i=s.getHours(),n=s.getMinutes(),o=s.getSeconds(),r=(t<10?"0":"")+t,l=(e<10?"0":"")+e,c=(i<10?"0":"")+i,h=(n<10?"0":"")+n,d=(o<10?"0":"")+o;return s.getFullYear()+r+l+"-"+c+h+d}class ye{static start(t,e){typeof e=="string"&&(e={parentScope:e});const i=new U2(t,e);Hh.set(t,i)}static report(t,e){const i=Hh.get(t);if(!i){console.warn("Reporting progress for non-existing scope",t);return}typeof e=="string"&&(e={message:e,autoStep:!0}),i.report(e)}static end(t){const e=Hh.get(t);e&&(e.end(),Hh.delete(t))}}const Hh=new Map;class U2{constructor(t,e){a(this,"scopeLabel");a(this,"parentScope");a(this,"childScopes",[]);a(this,"parentDepth",0);a(this,"lastStep",0);a(this,"lastAutoStepWeight",1);a(this,"lastTotalSteps",0);a(this,"onProgress");a(this,"showLogs",!1);a(this,"selfProgress",0);a(this,"totalProgress",0);a(this,"selfReports",0);a(this,"totalReports",0);this.parentScope=e!=null&&e.parentScope?Hh.get(e.parentScope):void 0,this.parentScope&&(this.parentScope.childScopes.push(this),this.parentDepth=this.parentScope.parentDepth+1),this.scopeLabel=" ".repeat(this.parentDepth*2)+t,this.showLogs=(e==null?void 0:e.logTimings)??!!F2,this.showLogs&&console.time(this.scopeLabel),this.onProgress=e==null?void 0:e.onProgress}report(t,e=!1){if(t){if(t.totalSteps!==void 0&&(this.lastTotalSteps=t.totalSteps),t.currentStep!==void 0&&(this.lastStep=t.currentStep),t.autoStep!==void 0){if(t.currentStep===void 0){this.lastStep===void 0&&(this.lastStep=0);const n=typeof t.autoStep=="number"?t.autoStep:1;this.lastStep+=this.lastAutoStepWeight,this.lastAutoStepWeight=n,t.currentStep=this.lastStep}t.totalSteps=this.lastTotalSteps}t.progress!==void 0?this.selfProgress=t.progress:t.currentStep!==void 0&&t.totalSteps!==void 0&&(this.selfProgress=t.currentStep/t.totalSteps)}if(this.childScopes.length>0){let n=0,o=0;for(const l of this.childScopes)n+=l.selfProgress,o+=1;o>0&&(n/=o);const r=this.lastAutoStepWeight/(this.lastTotalSteps??1);this.totalProgress=this.selfProgress+n*r}else this.totalProgress=this.selfProgress;this.selfProgress=Math.min(1,this.selfProgress),this.totalProgress=Math.min(1,this.totalProgress);let i=(this.totalProgress*100).toFixed(3)+"%";this.childScopes.length>0&&(i+=" ("+(this.selfProgress*100).toFixed(3)+"% self)"),t!=null&&t.message&&(i=t.message+" â€“ "+i),this.lastStep!==void 0&&this.lastTotalSteps!==void 0&&(i="Step "+(this.lastStep+(this.lastAutoStepWeight!=1?"â€“"+(this.lastStep+this.lastAutoStepWeight):"")+"/"+this.lastTotalSteps)+" "+i),e?this.totalReports++:(this.selfReports++,this.totalReports++),this.showLogs&&console.timeLog(this.scopeLabel,i),this.onProgress&&this.onProgress(this.totalProgress),this.parentScope&&this.parentScope.report(void 0,!0)}end(){this.report({progress:1,autoStep:!0},!0),this.showLogs&&(console.timeLog(this.scopeLabel,"Total reports: "+this.totalReports,"Self reports: "+this.selfReports),console.timeEnd(this.scopeLabel));let t=!1;for(const e of this.childScopes)if(!(e.selfProgress>=1)){t=!0;break}t&&console.warn("Progress end with child scopes that are still running",this),this.onProgress=void 0}}const et="</StageRoot/Materials";function N2(s,t,e){const i=new Map,n=_=>{const y=_.type___needle,b=i.get(y)||new Map;if(i.set(y,b),!b.has(_)){const v=`${y}${b.size?`_${b.size}`:""}`;b.set(_,v)}return b.get(_)},o=s.colorNode?Ku(s.colorNode):[],r=s.colorNode?`color3f inputs:diffuseColor.connect = ${et}/${t}/${n(o.values().next().value)}.outputs:out>`:"",l=s.roughnessNode?Ku(s.roughnessNode):[],c=s.roughnessNode?`float inputs:roughness.connect = ${et}/${t}/${n(l.values().next().value)}.outputs:out>`:"",h=s.normalNode?Ku(s.normalNode):[],d=s.normalNode?`float3 inputs:normal.connect = ${et}/${t}/${n(h.values().next().value)}.outputs:out>`:"",u=s.metalnessNode?Ku(s.metalnessNode):[],f=s.metalnessNode?`float inputs:metallic.connect = ${et}/${t}/${n(u.values().next().value)}.outputs:out>`:"",p=new Set([...o,...l,...h,...u]),g=V2(p,t,e,n);return console.debug(g),`

	def Material "${t}" ${s.name?`(
		displayName = "${s.name}"
	)`:""}
	{
		token outputs:mtlx:surface.connect = ${et}/${t}/N_mtlxsurface.outputs:surface>

		def Shader "N_mtlxsurface"
		{
			uniform token info:id = "ND_UsdPreviewSurface_surfaceshader"
			${r}
			${c}
			${d}
			${f}
			token outputs:surface
		}
		
		${g}
		
	}`}function Ku(s){const t=y=>{if(y.nodeType)return y.nodeType;switch(y.type){case"TimerNode":return"float";case"TextureNode":return;case"ConvertNode":return y.convertTo;default:return}},e=y=>{const b=new Set,v=w=>{var P;if(!(!w.isNode||b.has(w))){w.nodeType___needle||(w.nodeType___needle=t(w)),w.shaderNode?(w.type___needle="ShaderCallNodeInternal",w.shaderNodeLayoutName___needle=w.shaderNode.layout.name.slice(3)):w.type___needle=w.type,b.add(w);for(const E in w)(P=w[E])!=null&&P.isNode&&(v(w[E]),w.nodeType___needle||(w.nodeType___needle=w[E].nodeType___needle)),Array.isArray(w[E])&&w[E].forEach(T=>{T.isNode&&(v(T),w.nodeType___needle||(w.nodeType___needle=T.nodeType___needle))})}};return v(y),b},i=y=>{if(y.type==="ConvertNode"){if(y.convertTo===y.node.nodeType___needle)return!0;if(y.node.type==="ConstNode"){if(y.convertTo==="vec4"&&y.node.value.isVector4)return!0;if(y.convertTo==="vec3"&&y.node.value.isVector3)return!0;if(y.convertTo==="vec2"&&y.node.value.isVector2)return!0;if(y.convertTo==="color"&&y.node.value.isColor)return!0;if(y.convertTo==="float"&&typeof y.node.value=="number")return!0}else if(y.node.type=="SplitNode"&&y.convertTo=="float"&&y.node.components.length===1)return!0}return!1},n=y=>{for(;o(y);)!y.node&&y.shaderNode?y=y.inputNodes[0]:y=y.node??y.aNode??y.bNode??y.cNode;return y},o=y=>{const b=["UniformNode","UniformGroupNode","ShaderNodeInternal"];return!y||i(y)||b.includes(y.type___needle)||y.type___needle===void 0},r=(y,b)=>{var v;for(const w of b)for(const P in w){if((v=w[P])!=null&&v.isNode&&w[P]===y)return{parent:w,label:P};if(Array.isArray(w[P])&&w[P].find(T=>T.isNode&&T===y))return{parent:w,label:P}}return null},l=(y,b)=>{if(y.shaderNode)y.inputNodes[0]=n(y.inputNodes[0]);else if(Array.isArray(y.nodes))for(let v=0;v<y.nodes.length;v++)y.nodes[v]&&o(y.nodes[v])&&(y.nodes[v]=n(y.nodes[v]));else b.forEach(v=>{y[v]&&o(y[v])&&(y[v]=n(y[v]))})},c=y=>{y.type==="MathNode"&&y.method==="mix"&&(y.cNode.nodeType___needle="float",y.cNode.type==="ConvertNode"&&(y.cNode.convertTo="float"))},h=(y,b)=>{b.label==="cNode"&&b.parent.type==="MathNode"&&b.parent.method==="mix"||(b.parent.type==="JoinNode"?y.nodeType___needle="float":y.nodeType___needle=b.parent.nodeType___needle)},d=y=>(y==null?void 0:y.type)==="ConvertNode"&&y.nodeType___needle==="color"&&y.node.nodeType___needle==="vec4",u=(y,b)=>{y.convertTo="vec3",y.nodeType___needle="vec3";const v={type:"ConvertNode",convertTo:"color",node:y,isNode:!0,nodeType___needle:"color",type___needle:"ConvertNode"},w=r(y,b);return w!=null&&w.parent&&(w.parent[w.label]=v),v},f=y=>(y==null?void 0:y.type)==="ConvertNode"&&y.node.type==="TextureNode"&&y.nodeType___needle!==y.node.nodeType___needle,p=y=>{const b=new Set;for(let v of y)if(!o(v)){if(c(v),v.type=="SplitNode"){const w=r(v,y);if(v.components.length===1)v.nodeType___needle="float";else if(w)v.nodeType___needle=w.parent.nodeType___needle;else throw new Error("SplitNode without parent found, this should not happen")}if(l(v,["node","aNode","bNode","cNode"]),v.type=="ConstNode"&&v.nodeType==null&&h(v,r(v,y)),d(v)&&b.add(u(v,y)),f(v)){v.node.nodeType___needle=v.convertTo;const w=r(v,y);w!=null&&w.parent&&(w.parent[w.label]=v.node),v=v.node}b.add(v)}return b},g=e(s);return p(g)}function $2(s,t){switch(t){case"float4":return s.isVector4?`(${s.x}, ${s.y}, ${s.z}, ${s.w})`:`(${s}, ${s}, ${s}, ${s})`;case"float3":return s.isVector3?`(${s.x}, ${s.y}, ${s.z})`:`(${s}, ${s}, ${s})`;case"float2":return s.isVector2?`(${s.x}, ${s.y})`:`(${s}, ${s})`;case"color3f":return s.isColor?`(${s.r}, ${s.g}, ${s.b})`:`(${s}, ${s}, ${s})`;default:return s.isVector4||s.isVector3||s.isVector2?`${s.x}`:s.isColor?`${s.r}`:`${s}`}}function W2(s,t,e,i){const n="        ",o=p=>({float:"float",vec2:"vector2",vec3:"vector3",vec4:"vector4",color:"color3"})[p]||"float",r=p=>({float:"float",vec2:"float2",vec3:"float3",vec4:"float4",color:"color3f"})[p]||"float",l=s.type___needle,c=s.nodeType___needle,h=o(c);let d=r(c),u="";const f=new Array;switch(l){case"UniformGroupNode":case"UniformNode":return"";case"TimerNode":u="time_float";break;case"ConstNode":u="constant_"+h,f.push(`${d} inputs:value = ${$2(s.value,d)}`);break;case"JoinNode":u="combine"+s.nodes.length+"_"+h;let p=1;for(const w of s.nodes)f.push(`float inputs:in${p++}.connect = ${et}/${t}/${e(w)}.outputs:out>`);break;case"ConvertNode":u="convert_"+o(s.node.nodeType___needle)+"_"+h,s.node&&f.push(`${r(s.node.nodeType___needle)} inputs:in.connect = ${et}/${t}/${e(s.node)}.outputs:out>`);break;case"MathNode":u=s.method+"_"+h,s.aNode&&!s.bNode&&f.push(`${r(s.aNode.nodeType___needle)} inputs:in.connect = ${et}/${t}/${e(s.aNode)}.outputs:out>`),s.aNode&&s.bNode&&!s.cNode&&(f.push(`${r(s.aNode.nodeType___needle)} inputs:in1.connect = ${et}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`${r(s.bNode.nodeType___needle)} inputs:in2.connect = ${et}/${t}/${e(s.bNode)}.outputs:out>`)),s.aNode&&s.bNode&&s.cNode&&s.method=="clamp"&&(f.push(`${r(s.aNode.nodeType___needle)} inputs:in.connect = ${et}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`${r(s.bNode.nodeType___needle)} inputs:low.connect = ${et}/${t}/${e(s.bNode)}.outputs:out>`),f.push(`${r(s.cNode.nodeType___needle)} inputs:high.connect = ${et}/${t}/${e(s.cNode)}.outputs:out>`)),s.aNode&&s.bNode&&s.cNode&&s.method=="mix"&&(f.push(`${r(s.aNode.nodeType___needle)} inputs:fg.connect = ${et}/${t}/${e(s.bNode)}.outputs:out>`),f.push(`${r(s.bNode.nodeType___needle)} inputs:bg.connect = ${et}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`float inputs:mix.connect = ${et}/${t}/${e(s.cNode)}.outputs:out>`));break;case"OperatorNode":let _="";switch(s.op){case"*":_="multiply";break;case"/":_="divide";break;case"+":_="add";break;case"-":_="subtract";break}if(u=_+"_"+h,s.aNode&&!s.bNode&&f.push(`${r(s.aNode.nodeType___needle)} inputs:in.connect = ${et}/${t}/${e(s.aNode)}.outputs:out>`),s.aNode&&s.bNode){const w=r(s.aNode.nodeType___needle),P=r(s.bNode.nodeType___needle);(w==="color3f"&&P==="float"||P==="float"&&P==="color3f")&&(u=_+"_color3FA"),f.push(`${w} inputs:in1.connect = ${et}/${t}/${e(s.aNode)}.outputs:out>`),f.push(`${P} inputs:in2.connect = ${et}/${t}/${e(s.bNode)}.outputs:out>`)}break;case"TextureNode":s.uvNode?(u="tiledimage_"+h,f.push(`float2 inputs:texcoord.connect = ${et}/${t}/${e(s.uvNode)}.outputs:out>`)):u="image_"+h;const y=s._value,b=Vb.includes(y.format),v=H2(y);f.push(`asset inputs:file = @textures/${v}.${b?"png":"jpg"}@`),i[v]={texture:y,scale:void 0};break;case"NormalMapNode":d="float3",u="normalmap",f.push(`${d} inputs:in.connect = ${et}/${t}/${e(s.node)}.outputs:out>`);break;case"AttributeNode":u="geompropvalue_"+h,f.push('string inputs:geomprop = "st"');break;case"ShaderCallNodeInternal":u=s.shaderNodeLayoutName___needle+"_"+h,f.push(`${d} inputs:in.connect = ${et}/${t}/${e(s.inputNodes[0])}.outputs:out>`);break;case"SplitNode":u="swizzle_"+o(s.node.nodeType___needle)+"_"+h,f.push(`${r(s.node.nodeType___needle)} inputs:in.connect = ${et}/${t}/${e(s.node)}.outputs:out>`),f.push(`string inputs:channels = "${s.components}"`);break}return`
	${n}def Shader "${e(s)}"
	${n}{
		${n}uniform token info:id = "ND_${u}"
		${n}${d} outputs:out
		${n}${f.length>0?f.join(`
				`):""}
	${n}}
	`}function V2(s,t,e,i){let n="";for(const o of s)n+=W2(o,t,i,e);return n}function H2(s){var t;return ps(s.name)+"_"+(((t=s.source)==null?void 0:t.id)??s.id)}function ps(s){return s=s.replace(/[^a-zA-Z0-9_]/g,""),s.match(/^[a-zA-Z_]/)||(s="_"+s),s}function A1(s){return s=s.replace('"','\\"'),s}function I1(s){if(s.length===0)return null;const t=s.map(i=>{const n=new Array;for(;i.parent;)n.unshift(i.parent),i=i.parent;return n});return t[0].findLast(i=>t.every(n=>n.includes(i)))||null}function D1(s){const t=I1(s),e=new Set;for(const i of s){let n=i.parent;for(;n&&n!==t;)s.includes(n)||e.add(n),n=n.parent}return e}const G2=new x,q2=new H,X2=new x(1,1,1),Ia=class{constructor(t,e,i=null,n=null,o=null,r=null,l=null,c=null){a(this,"uuid");a(this,"name");a(this,"type");a(this,"extraSchemas",[]);a(this,"displayName");a(this,"visibility");a(this,"transform",null);a(this,"_isDynamic");a(this,"geometry");a(this,"material");a(this,"camera");a(this,"parent");a(this,"skinnedMesh");a(this,"children",[]);a(this,"animations");a(this,"_eventListeners");a(this,"needsTranslate",!1);a(this,"needsOrient",!1);a(this,"needsScale",!1);var h,d,u;this.uuid=t,this.name=ps(e),this.displayName=e,i?this.transform={position:((h=i.position)==null?void 0:h.clone())||null,quaternion:((d=i.quaternion)==null?void 0:d.clone())||null,scale:((u=i.scale)==null?void 0:u.clone())||null}:this.transform=null,this.geometry=n,this.material=o,this.camera=r,this.parent=null,this.children=[],this._eventListeners={},this._isDynamic=!1,this.skinnedMesh=l,this.animations=c}getMatrix(){if(!this.transform)return new ce;const{position:t,quaternion:e,scale:i}=this.transform,n=new ce;return n.compose(t||G2,e||q2,i||X2),n}setMatrix(t){if(!t||!(t instanceof ce)){this.transform=null;return}const e=new x,i=new H,n=new x;t.decompose(e,i,n),this.transform={position:e,quaternion:i,scale:n}}get matrix(){return this.getMatrix()}set matrix(t){this.setMatrix(t)}get isDynamic(){return this._isDynamic}set isDynamic(t){this._isDynamic=t}static createEmptyParent(t){const e=new Ia(Fo.generateUUID(),t.name+"_empty_"+Ia.USDObject_export_id++,t.transform),i=t.parent;return i&&i.add(e),e.add(t),e.isDynamic=!0,t.transform=null,e}static createEmpty(){const t=new Ia(Fo.generateUUID(),"Empty_"+Ia.USDObject_export_id++);return t.isDynamic=!0,t}is(t){return t?this.uuid===t.uuid:!1}isEmpty(){return!this.geometry}clone(){const t=new Ia(Fo.generateUUID(),this.name,this.transform,this.geometry,this.material);return t.isDynamic=this.isDynamic,t}deepClone(){const t=this.clone();for(const e of this.children)e&&t.add(e.deepClone());return t}getPath(){let t=this.parent,e=this.name;for(;t;)e=(t.parent?t.name:t.name+"/Scenes/Scene")+"/"+e,t=t.parent;return"</"+e+">"}add(t){t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t)}remove(t){const e=this.children.indexOf(t);e>=0&&(t.parent===this&&(t.parent=null),this.children.splice(e,1))}addEventListener(t,e){this._eventListeners[t]||(this._eventListeners[t]=[]),this._eventListeners[t].push(e)}removeEventListener(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>=0&&this._eventListeners[t].splice(i,1)}onSerialize(t,e){const i=this._eventListeners.serialize;i&&i.forEach(n=>n(t,e))}};let gi=Ia;a(gi,"USDObject_export_id",0);class L1 extends gi{constructor(){super(void 0,"StageRoot",null,null,null,null);a(this,"stageLength");this.children=[],this.stageLength=200}get isDocumentRoot(){return!0}get isDynamic(){return!1}add(e){e.parent=this,this.children.push(e)}remove(e){const i=this.children.indexOf(e);i>=0&&(e.parent===this&&(e.parent=null),this.children.splice(i,1))}traverse(e,i=null){if(i!==null?e(i):i=this,i.children)for(const n of i.children)this.traverse(e,n)}findById(e){let i=!1;function n(o){if(!i){if(o.uuid===e)return i=!0,o;if(o.children)for(const r of o.children){if(!r)continue;const l=n(r);if(l)return l}}}return n(this)}buildHeader(e){var u,f,p;const i=(u=e.extensions)==null?void 0:u.find(g=>(g==null?void 0:g.extensionName)==="animation"),n=(f=e.extensions)==null?void 0:f.find(g=>(g==null?void 0:g.extensionName)==="Behaviour"),o=(p=e.extensions)==null?void 0:p.find(g=>(g==null?void 0:g.extensionName)==="Physics"),r=(i==null?void 0:i.getStartTimeCode())??0,l=(i==null?void 0:i.getEndTimeCode())??0;let c="";const h=i==null?void 0:i.registeredClips;if(h)for(const g of h)c+=`	# Animation: ${g.name}, start=${i.getStartTimeByClip(g)*60}, length=${g.duration*60}
`;const d=c;return`#usda 1.0
(
	customLayerData = {
		string creator = "Needle Engine ${as}"
		dictionary Needle = {
			bool animations = ${i?1:0}
			bool interactive = ${n?1:0}
			bool physics = ${o?1:0}
			bool quickLookCompatible = ${e.quickLookCompatible?1:0}
		}
	}
	defaultPrim = "${ps(this.name)}"
	metersPerUnit = 1
	upAxis = "Y"
	startTimeCode = ${r}
	endTimeCode = ${l}
	timeCodesPerSecond = 60
	framesPerSecond = 60
	doc = """Generated by Needle Engine USDZ Exporter ${as}"""
${d}
)
`}}const Ol=`
`,Ri="</StageRoot/Materials";class Q2{constructor(){a(this,"str");a(this,"indent");this.str="",this.indent=0}clear(){this.str="",this.indent=0}beginBlock(t=void 0,e="{",i=!0){t!==void 0?(t=this.applyIndent(t),this.str+=t,i?(this.str+=Ol,this.str+=this.applyIndent(e)):this.str+=" "+e):this.str+=this.applyIndent(e),this.str+=Ol,this.indent+=1}closeBlock(t="}"){this.indent-=1,this.str+=this.applyIndent(t)+Ol}beginArray(t){t=this.applyIndent(t+" = ["),this.str+=t,this.str+=Ol,this.indent+=1}closeArray(){this.indent-=1,this.str+=this.applyIndent("]")+Ol}appendLine(t=""){t=this.applyIndent(t),this.str+=t,this.str+=Ol}toString(){return this.str}applyIndent(t){let e="";for(let i=0;i<this.indent;i++)e+="	";return e+t}}class Y2{constructor(t,e,i){a(this,"root");a(this,"exporter");a(this,"extensions",[]);a(this,"quickLookCompatible");a(this,"exportInvisible");a(this,"materials");a(this,"textures");a(this,"files");a(this,"document");a(this,"output");a(this,"animations");this.root=t,this.exporter=e,this.quickLookCompatible=i.quickLookCompatible,this.exportInvisible=i.exportInvisible,i.extensions&&(this.extensions=i.extensions),this.materials=new Map,this.textures={},this.files={},this.document=new L1,this.output="",this.animations=[]}}class ey{constructor(){a(this,"ar",{anchoring:{type:"plane"},planeAnchoring:{alignment:"horizontal"}});a(this,"quickLookCompatible",!1);a(this,"extensions",[]);a(this,"maxTextureSize",4096);a(this,"exportInvisible",!1)}}let K2=class{constructor(){a(this,"debug");a(this,"pruneUnusedNodes");a(this,"sceneAnchoringOptions",new ey);a(this,"extensions",[]);a(this,"keepObject");a(this,"beforeWritingDocument");this.debug=!1,this.pruneUnusedNodes=!0}async parse(t,e=new ey){var v,w;e=Object.assign(new ey,e),this.sceneAnchoringOptions=e;const i=new Y2(t,this,e);this.extensions=i.extensions;const n=i.files,o="model.usda";n[o]=null;const r=i.materials,l=i.textures;ye.report("export-usdz","Invoking onBeforeBuildDocument"),await If(i,"onBeforeBuildDocument"),ye.report("export-usdz","Done onBeforeBuildDocument"),ye.report("export-usdz","Reparent bones to common ancestor");const c=[],h=new Set;t==null||t.traverse(P=>{if(!(!e.exportInvisible&&!P.visible)&&P instanceof Ir){const E=P.skeleton.bones,T=I1(E);if(T){const k={object:P,originalParent:P.parent,newParent:T};c.push(k),h.add(k.object.uuid),k.newParent&&h.add(k.newParent.uuid),k.originalParent&&h.add(k.originalParent.uuid)}}});for(const P of c){const{object:E,originalParent:T,newParent:k}=P;k.add(E)}ye.report("export-usdz","Traversing hierarchy"),t&&j1(t,i.document,i,this.keepObject),ye.report("export-usdz","Invoking onAfterBuildDocument"),await If(i,"onAfterBuildDocument");const d=i.extensions.find(P=>P.extensionName==="Behaviour"),u=(d==null?void 0:d.getAllTargetUuids())??new Set;if(this.pruneUnusedNodes){const P={allBehaviorTargets:u,debug:!1,boneReparentings:h,quickLookCompatible:i.quickLookCompatible};this.debug&&Hx(i.document,"Hierarchy BEFORE pruning",P),B1(i.document,P),this.debug&&Hx(i.document,"Hierarchy AFTER pruning")}else this.debug&&console.log("Pruning of empty nodes is disabled. This may result in a larger USDZ file.");ye.report("export-usdz",{message:"Parsing document",autoStep:10}),await J2(i,()=>(ye.report("export-usdz","Building materials"),lI(r,l,e.quickLookCompatible))),ye.report("export-usdz","Invoking onAfterSerialize"),await If(i,"onAfterSerialize");for(const P of c){const{object:E,originalParent:T,newParent:k}=P;T&&T.add(E)}(w=(v=i.exporter)==null?void 0:v.beforeWritingDocument)==null||w.call(v);const p=i.document.buildHeader(i)+`
`+i.output;this.debug&&console.log(p),n[o]=Jw(p),i.output="",ye.report("export-usdz",{message:"Exporting textures",autoStep:10}),ye.start("export-usdz-textures",{parentScope:"export-usdz",logTimings:!1});const g=new ol({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),_=Object.keys(l).length;ye.report("export-usdz-textures",{totalSteps:_*3,currentStep:0});const y=async P=>{const E=l[P],T=E.texture,k=Vb.includes(T.format);let z={imageData:T.image};ye.report("export-usdz-textures",{message:"read back texture",autoStep:!0});const L=E.scale!==void 0&&E.scale.x!==1&&E.scale.y!==1&&E.scale.z!==1&&E.scale.w!==1;(T.isCompressedTexture||T.isRenderTargetTexture||L)&&(z=await Z2(T,e.maxTextureSize,g,E.scale)),ye.report("export-usdz-textures",{message:"convert texture to canvas",autoStep:!0});const O=await tI(z.imageBitmap||z.imageData,e.maxTextureSize).catch(A=>{console.error("Error converting texture to canvas",T,A)});if(O){ye.report("export-usdz-textures",{message:"convert canvas to blob",autoStep:!0});const A=await O.convertToBlob({type:k?"image/png":"image/jpeg",quality:.95});n[`textures/${P}.${k?"png":"jpg"}`]=new Uint8Array(await A.arrayBuffer())}else console.warn("Can`t export texture: ",T)};for(const P in l)await y(P);g.dispose(),ye.end("export-usdz-textures");let b=0;for(const P in n){const E=n[P],T=34+P.length;b+=T;const k=b&63;if(k!==4){const z=64-k,L=new Uint8Array(z);n[P]=[E,{extra:{12345:L}}]}b=E.length}return ye.report("export-usdz","zip archive"),hT(n,{level:0})}};function j1(s,t,e,i){var c;if(!e.exportInvisible&&!s.visible)return;let n,o,r;const l={position:s.position,quaternion:s.quaternion,scale:s.scale};if(s.position.x===0&&s.position.y===0&&s.position.z===0&&(l.position=null),s.quaternion.x===0&&s.quaternion.y===0&&s.quaternion.z===0&&s.quaternion.w===1&&(l.quaternion=null),s.scale.x===1&&s.scale.y===1&&s.scale.z===1&&(l.scale=null),(s instanceof X||s instanceof Ir)&&(o=s.geometry,r=s.material),i&&!i(s)&&(o=void 0,r=void 0),(s instanceof X||s instanceof Ir)&&r&&typeof r=="object"&&(r instanceof It||r instanceof Be||r.isMeshPhysicalNodeMaterial||r instanceof Ie&&r.type==="MeshLineMaterial")){const h=ef(s),d=s instanceof Ir?s:null;n=new gi(s.uuid,h,l,o,r,void 0,d,s.animations)}else if(s instanceof Se||s instanceof $p){const h=ef(s);n=new gi(s.uuid,h,l,void 0,void 0,s)}else{const h=ef(s);n=new gi(s.uuid,h,l,void 0,void 0,void 0,void 0,s.animations)}if(n){if(n.displayName=((c=s.userData)==null?void 0:c.name)||s.name,n.visibility=s.visible?void 0:"invisible",t&&t.add(n),t=n,e.extensions)for(const h of e.extensions)h.onExportObject&&h.onExportObject.call(h,s,n,e)}else{const h=ef(s),d=new gi(s.uuid,h,{position:s.position,quaternion:s.quaternion,scale:s.scale});t&&t.add(d),t=d}for(const h of s.children)j1(h,t,e,i)}function Hx(s,t,...e){const i={};let n=0;function o(r,l){n++;let c=r.displayName||r.name;c+=" ("+r.uuid+")",(r.geometry||r.material||r.camera||r.skinnedMesh)&&(c+=" ("+(r.geometry?"geo, ":"")+(r.material?"mat, ":"")+(r.camera?"cam, ":"")+(r.skinnedMesh?"skin, ":"")+")"),l[c]={};const d={object:r};r.material&&(d.mat=!0),r.geometry&&(d.geo=!0),r.camera&&(d.cam=!0),r.skinnedMesh&&(d.skin=!0),l[c]._self=d;for(const u of r.children)u&&o(u,l[c])}o(s,i),console.log(t+" ("+n+" nodes)",i,...e)}function B1(s,t){var h;let e=!0;const i=new Array,n=new Array;if(s.children.length===0)e=!0;else{const d=[...s.children];for(const u of d)if(u){const f=B1(u,t);t.debug&&(f?i.push(u):n.push(u)),e=e&&f}}const o=t.allBehaviorTargets.has(s.uuid),r=s.geometry||s.material||s.camera&&!t.quickLookCompatible||s.skinnedMesh||!1,l=t.boneReparentings.has(s.uuid),c=e&&!o&&!r&&!l;return c?(t.debug&&console.log("Pruned object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:r,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),(h=s.parent)==null||h.remove(s)):t.debug&&console.log("Kept object:",(s.displayName||s.name)+" ("+s.uuid+")",{isVisible:r,isBehaviorSourceOrTarget:o,allChildsWerePruned:e,isBoneReparenting:l,object:s,prunedChilds:i,keptChilds:n}),c}async function J2(s,t){ye.start("export-usdz-resources","export-usdz");const e=[];for(const c of s.document.children)F1(c,s,e);const i=e.length;for(let c=0;c<i;c++)ye.report("export-usdz-resources",{totalSteps:i,currentStep:c}),await new Promise((h,d)=>{e[c](),h()});ye.end("export-usdz-resources");const n=new Q2,o=s.exporter.sceneAnchoringOptions.ar;n.beginBlock(`def Xform "${s.document.name}"`),n.beginBlock(`def Scope "Scenes" (
		kind = "sceneLibrary"
	)`),n.beginBlock('def Xform "Scene"',"(",!1),n.appendLine('apiSchemas = ["Preliminary_AnchoringAPI"]'),n.appendLine("customData = {"),n.appendLine("	bool preliminary_collidesWithEnvironment = 0"),n.appendLine('	string sceneName = "Scene"'),n.appendLine("}"),n.appendLine('sceneName = "Scene"'),n.closeBlock(")"),n.beginBlock(),n.appendLine(`token preliminary:anchoring:type = "${o.anchoring.type}"`),o.anchoring.type==="plane"&&n.appendLine(`token preliminary:planeAnchoring:alignment = "${o.planeAnchoring.alignment}"`),o.anchoring.type==="image"&&n.appendLine(`rel preliminary:imageAnchoring:referenceImage = </${s.document.name}/Scenes/Scene/AnchoringReferenceImage>`),n.appendLine();const r=c=>{if(!c)return 0;let h=1;for(const d of c.children)h+=r(d);return h},l=r(s.document);ye.start("export-usdz-xforms","export-usdz"),ye.report("export-usdz-xforms",{totalSteps:l,currentStep:1});for(const c of s.document.children)z1(c,n,s);ye.end("export-usdz-xforms"),ye.report("export-usdz","invoke onAfterHierarchy"),await If(s,"onAfterHierarchy",n),n.closeBlock(),n.closeBlock(),n.appendLine(t()),n.closeBlock(),ye.report("export-usdz","write to string"),s.output+=n.toString()}function F1(s,t,e){if(!s)return;const i=s.geometry,n=s.material;if(i)if(n&&("isMeshStandardMaterial"in n&&n.isMeshStandardMaterial||"isMeshBasicMaterial"in n&&n.isMeshBasicMaterial||n.type==="MeshLineMaterial")){const o="geometries/"+P_(i,s.name)+".usda";if(!(o in t.files)){const r=()=>{var c,h;const l=oI(i,(h=(c=s.skinnedMesh)==null?void 0:c.skeleton)==null?void 0:h.bones,t.quickLookCompatible);t.files[o]=sI(l)};e.push(r)}}else console.warn("NeedleUSDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",n==null?void 0:n.name);n&&(n.uuid in t.materials||(t.materials[n.uuid]=n));for(const o of s.children)F1(o,t,e)}async function If(s,t,e=null){if(s.extensions){for(const i of s.extensions)if(i&&typeof i[t]=="function"){const o=i[t].call(i,s,e);o instanceof Promise&&await o}}}let Ju=null,Ci=null,ty,kl,Zu;async function Z2(s,t=1/0,e=null,i=void 0){ty||(ty=new ro(2,2,1,1)),kl||(kl=new to({uniforms:{blitTexture:new Un(s),flipY:new Un(!1),scale:new Un(new Ce(1,1,1,1))},vertexShader:`
            varying vec2 vUv;
			uniform bool flipY;
            void main(){
                vUv = uv;
				if (flipY)
					vUv.y = 1. - vUv.y;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture;
			uniform vec4 scale; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = sRGBTransferOETF( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
				
				gl_FragColor.rgba *= scale.rgba;
            }`}));const n=kl.uniforms;n.blitTexture.value=s,n.flipY.value=!1,n.scale.value=new Ce(1,1,1,1),i!==void 0&&n.scale.value.copy(i),kl.defines.IS_SRGB=s.colorSpace==Qo,kl.needsUpdate=!0,Zu||(Zu=new X(ty,kl),Zu.frustumCulled=!1);const o=new Se,r=new bn;r.add(Zu),e||(e=Ju=new ol({antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}));const l=Math.min(s.image.width,t),c=Math.min(s.image.height,t);Ci&&(Ci.width!==l||Ci.height!==c)&&(Ci.dispose(),Ci=null),Ci||(Ci=new io(l,c,{format:Gp,type:AR,minFilter:Uf,magFilter:Uf})),e.setRenderTarget(Ci),e.setSize(l,c),e.clear(),e.render(r,o),Ju&&(Ju.dispose(),Ju=null);const h=new Uint8ClampedArray(Ci.width*Ci.height*4);e.readRenderTargetPixels(Ci,0,0,Ci.width,Ci.height,h);const d=new ImageData(h,Ci.width,Ci.height,void 0),u=await createImageBitmap(d,{premultiplyAlpha:"none"});return{imageData:d,imageBitmap:u}}function eI(s){return typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap}async function tI(s,t=4096){const e=t/Math.max(s.width,s.height),i=s.width*Math.min(1,e),n=s.height*Math.min(1,e),o=new OffscreenCanvas(i,n),r={premultiplyAlpha:"none"};s.width!==i&&(r.resizeWidth=i),s.height!==n&&(r.resizeHeight=n);const l=await createImageBitmap(s,r),c=o.getContext("bitmaprenderer");return c&&c.transferFromImageBitmap(l),o}async function iI(s,t=void 0,e=!1,i=4096){if(eI(s)){const n=i/Math.max(s.width,s.height),o=new OffscreenCanvas(s.width*Math.min(1,n),s.height*Math.min(1,n)),r=o.getContext("2d",{alpha:!0,premultipliedAlpha:!1});if(!r)throw new Error("Could not get canvas 2D context");if(e===!0&&(r.translate(0,o.height),r.scale(1,-1)),r.drawImage(s,0,0,o.width,o.height),t!==void 0){const l=t.x,c=t.y,h=t.z,d=t.w,u=r.getImageData(0,0,o.width,o.height),f=u.data;for(let p=0;p<f.length;p+=4)f[p+0]=f[p+0]*l,f[p+1]=f[p+1]*c,f[p+2]=f[p+2]*h,f[p+3]=f[p+3]*d;r.putImageData(u,0,0)}return o}else throw new Error("NeedleUSDZExporter: No valid image data found. Unable to process texture.")}const $e=7;function nI(){return`#usda 1.0
(
    customLayerData = {
        string creator = "Needle Engine USDZExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)
`}function sI(s,t){let e=nI();return e+=s,Jw(e)}function ef(s){return s.name.replace(/[-<>\(\)\[\]Â§$%&\/\\\=\?\,\;]/g,"")+"_"+s.id}function Gx(s){return ps(s.name||"bone_"+s.uuid)}function P_(s,t){return ps(s.name||"Geometry")+"_"+s.id}function xm(s){return ps(s.name||"Material")+"_"+s.id}function mc(s,t){let e=Gx(s),i=s.parent;for(;i&&i!==t;)e=Gx(i)+"/"+e,i=i.parent;return e}function z1(s,t,e){var p;if(s==null)return;ye.report("export-usdz-xforms",{message:"buildXform "+s.displayName||s.name,autoStep:!0});const i=s.transform,n=s.geometry,o=s.material,r=s.camera,l=s.name;if(s.animations)for(const g of s.animations)e.animations.push(g);const c=n&&n.isBufferGeometry&&n.attributes.skinIndex!==void 0&&n.attributes.skinIndex.count>0,h=c?"SkelRoot":"Xform",d=new Array,u=o&&o instanceof Be&&o.color&&o.color.r===1&&o.color.g===1&&o.color.b===1&&!o.map&&o.opacity===1&&(n==null?void 0:n.attributes.color);if(n!=null&&n.attributes.color&&!u&&console.warn("NeedleUSDZExporter: Geometry has vertex colors. Vertex colors will only be shown in QuickLook for unlit materials with white color and no texture. Otherwise, they will be ignored.",s.displayName),t.appendLine(),n?(t.beginBlock(`def ${h} "${l}"`,"(",!1),e.quickLookCompatible&&o&&o.side===vn&&!c?t.appendLine(`prepend references = @./geometries/${P_(n)}.usda@</Geometry_doubleSided>`):t.appendLine(`prepend references = @./geometries/${P_(n)}.usda@</Geometry>`),u||d.push("MaterialBindingAPI"),c&&d.push("SkelBindingAPI")):r&&!e.quickLookCompatible?t.beginBlock(`def Camera "${l}"`,"(",!1):s.type!==void 0?t.beginBlock(`def ${s.type} "${l}"`):t.beginBlock(`def Xform "${l}"`,"(",!1),s.type===void 0&&((p=s.extraSchemas)!=null&&p.length&&d.push(...s.extraSchemas),d.length&&t.appendLine(`prepend apiSchemas = [${d.map(g=>`"${g}"`).join(", ")}]`)),s.displayName&&t.appendLine(`displayName = "${A1(s.displayName)}"`),(r||s.type===void 0)&&(t.closeBlock(")"),t.beginBlock()),n&&o){if(!u){const g=xm(o);t.appendLine(`rel material:binding = </StageRoot/Materials/${g}>`)}!e.quickLookCompatible&&o.side===vn&&(t.beginBlock('over "Geometry" '),t.appendLine("uniform bool doubleSided = 1"),t.closeBlock())}let f=!1;if(c?(t.appendLine("rel skel:skeleton = <Rig>"),t.appendLine("rel skel:animationSource = <Rig/_anim>"),f=!1):s.type===void 0&&i&&(f=f||i.position!==null||i.quaternion!==null||i.scale!==null,i.position&&(s.needsTranslate=!0,t.appendLine(`double3 xformOp:translate = (${me(i.position.x)}, ${me(i.position.y)}, ${me(i.position.z)})`)),i.quaternion&&(s.needsOrient=!0,t.appendLine(`quatf xformOp:orient = (${me(i.quaternion.w)}, ${me(i.quaternion.x)}, ${me(i.quaternion.y)}, ${me(i.quaternion.z)})`)),i.scale&&(s.needsScale=!0,t.appendLine(`double3 xformOp:scale = (${me(i.scale.x)}, ${me(i.scale.y)}, ${me(i.scale.z)})`))),s.visibility!==void 0&&t.appendLine(`token visibility = "${s.visibility}"`),r&&!e.quickLookCompatible&&("isOrthographicCamera"in r&&r.isOrthographicCamera?(t.appendLine(`float2 clippingRange = (${r.near}, ${r.far})`),t.appendLine(`float horizontalAperture = ${((Math.abs(r.left)+Math.abs(r.right))*10).toPrecision($e)}`),t.appendLine(`float verticalAperture = ${((Math.abs(r.top)+Math.abs(r.bottom))*10).toPrecision($e)}`),t.appendLine('token projection = "orthographic"')):"isPerspectiveCamera"in r&&r.isPerspectiveCamera&&(t.appendLine(`float2 clippingRange = (${r.near.toPrecision($e)}, ${r.far.toPrecision($e)})`),t.appendLine(`float focalLength = ${r.getFocalLength().toPrecision($e)}`),t.appendLine(`float focusDistance = ${r.focus.toPrecision($e)}`),t.appendLine(`float horizontalAperture = ${r.getFilmWidth().toPrecision($e)}`),t.appendLine('token projection = "perspective"'),t.appendLine(`float verticalAperture = ${r.getFilmHeight().toPrecision($e)}`))),s.onSerialize&&s.onSerialize(t,e),s.type===void 0){const g=new Array;s.needsTranslate&&g.push('"xformOp:translate"'),s.needsOrient&&g.push('"xformOp:orient"'),s.needsScale&&g.push('"xformOp:scale"'),g.length&&t.appendLine(`uniform token[] xformOpOrder = [${g.join(", ")}]`)}if(s.children){t.appendLine();for(const g of s.children)z1(g,t,e)}t.closeBlock()}function me(s){return Number.isInteger(s)?s.toString():s.toFixed(10)}function qx(s){const t=s.elements;return`( ${tf(t,0)}, ${tf(t,4)}, ${tf(t,8)}, ${tf(t,12)} )`}function tf(s,t){return`(${me(s[t+0])}, ${me(s[t+1])}, ${me(s[t+2])}, ${me(s[t+3])})`}function oI(s,t=[],e=!0){return`
def "Geometry"
${rI(s,t,e)}
`}function rI(s,t=[],e=!0){const i="Geometry",n=s.attributes,o=n.position.count,r=t&&t.length>0,l=[],c=[];let h=new Array,d=n.skinIndex;if(r){const f=[];for(const y of t)l.push({bone:y,index:t.indexOf(y)}),f.push(y.uuid);let p=1e4;for(;f.length<t.length&&p-- >0;)for(const y of l){const b=y.bone.children;for(const v of b)f.indexOf(v.uuid)===-1&&t.indexOf(v)!==-1&&(l.push({bone:v,index:t.indexOf(v)}),f.push(v.uuid))}p<=0&&console.error("Failed to sort bones in skinned mesh",l,t,f);for(const y of D1(t))l.push({bone:y,index:l.length});const g=l[0].bone.parent;l.sort((y,b)=>mc(y.bone,g)>mc(b.bone,g)?1:-1),l.map(y=>'"'+mc(y.bone,g)+'"').join(", ");for(const y in l)c[l[y].index]=parseInt(y);const _=n.skinIndex;h=new Array;for(let y=0;y<_.count;y++){const b=_.getX(y),v=_.getY(y),w=_.getZ(y),P=_.getW(y);h.push(c[b],c[v],c[w],c[P])}d=new Hi(new Uint16Array(h),4)}const u=n.skinWeight&&n.skinIndex;return`
{	
    def Mesh "${i}" ${u?`(
        prepend apiSchemas = ["SkelBindingAPI"]
    )`:""}
    {
        int[] faceVertexCounts = [${iy(s)}]
        int[] faceVertexIndices = [${ny(s)}]
		${n.normal||e?`normal3f[] normals = [${Df(n.normal,o)}] (
            interpolation = "vertex"
        )`:""}
        point3f[] points = [${Df(n.position,o)}]
        ${n.uv?`texCoord2f[] primvars:st = [${U1(n.uv,o,!0)}] (
            interpolation = "vertex"
        )`:""}
		${n.uv1?sy("st1",n.uv1):""}
		${n.uv2?sy("st2",n.uv2):""}
		${n.uv3?sy("st3",n.uv3):""}
		${u?`matrix4d primvars:skel:geomBindTransform = ( (1, 0, 0, 0), (0, 1, 0, 0), (0, 0, 1, 0), (0, 0, 0, 1) ) (
				elementSize = 1
				interpolation = "constant"
			)`:""}
		${n.skinIndex?`int[] primvars:skel:jointIndices = [${Xx(d,!0)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.skinWeight?`float[] primvars:skel:jointWeights = [${Xx(n.skinWeight)}] (
			elementSize = 4
			interpolation = "vertex"
		)`:""}
		${n.color?`color3f[] primvars:displayColor = [${Df(n.color,o)}] (
			interpolation = "vertex"
		)`:""}
        uniform token subdivisionScheme = "none"
    }
}
${e?`
# This is a workaround for QuickLook/RealityKit not supporting the doubleSided attribute. We're adding a second
# geometry definition here, that uses the same mesh data but appends extra faces with reversed winding order.
def "${i}_doubleSided" (
	prepend references = </Geometry>
)
{
	over "Geometry"
	{
		int[] faceVertexCounts = [${iy(s)+", "+iy(s)}]
		int[] faceVertexIndices = [${ny(s)+", "+ny(s,!0)}]
	}
}
`:""}
`}function iy(s){const t=s.index!==null?s.index.count:s.attributes.position.count;return Array(Math.floor(t/3)).fill(3).join(", ")}function ny(s,t=!1){const e=s.index,i=[];if(e!==null)for(let n=0;n<e.count;n++){let o=n;t&&(o=n%3===0?n+2:n%3===2?n-2:n),i.push(e.getX(o))}else{const n=s.attributes.position.count;for(let o=0;o<n;o++){let r=o;t&&(r=o%3===0?o+2:o%3===2?o-2:o),i.push(r)}}return i.join(", ")}function sy(s,t){const e=t.itemSize;switch(e){case 2:return`texCoord2f[] primvars:${s} = [${U1(t,e,!0)}] (
				interpolation = "vertex"
			)`;case 3:return`texCoord3f[] primvars:${s} = [${Df(t,e)}] (
				interpolation = "vertex"
			)`;case 4:return`double4[] primvars:${s} = [${aI(t,e)}] (
				interpolation = "vertex"
			)`;default:return console.warn("USDZExporter: Attribute with "+e+" components are currently not supported. Results may be undefined for "+s+"."),""}}function Df(s,t){if(s===void 0)return console.warn("USDZExporter: A mesh attribute is missing and will be set with placeholder data. The result may look incorrect."),Array(t).fill("(0, 0, 1)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i);e.push(`(${n.toPrecision($e)}, ${o.toPrecision($e)}, ${r.toPrecision($e)})`)}return e.join(", ")}function aI(s,t){if(s===void 0)return console.warn("USDZExporter: Attribute is missing. Results may be undefined."),Array(t).fill("(0, 0, 0, 0)").join(", ");const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i)||0,l=s.getW(i)||0;e.push(`(${n.toPrecision($e)}, ${o.toPrecision($e)}, ${r.toPrecision($e)}, ${l.toPrecision($e)})`)}return e.join(", ")}function Xx(s,t=!1){const e=[];for(let i=0;i<s.count;i++){const n=s.getX(i),o=s.getY(i),r=s.getZ(i),l=s.getW(i);e.push(`${t?n:n.toPrecision($e)}`),e.push(`${t?o:o.toPrecision($e)}`),e.push(`${t?r:r.toPrecision($e)}`),e.push(`${t?l:l.toPrecision($e)}`)}return e.join(", ")}function U1(s,t,e=!1){if(s===void 0)return console.warn("USDZExporter: UVs missing."),Array(t).fill("(0, 0)").join(", ");const i=[];for(let n=0;n<s.count;n++){const o=s.getX(n);let r=s.getY(n);e&&(r=1-r),i.push(`(${o.toPrecision($e)}, ${r.toPrecision($e)})`)}return i.join(", ")}function lI(s,t,e=!1){const i=[];for(const n in s){const o=s[n];i.push(cI(o,t,e))}return`
	def "Materials"
    {
${i.join("")}
    }`}function An(s){var t;return ps(s.name)+"_"+(((t=s.source)==null?void 0:t.id)??s.id)}function hr(s,t,e,i,n,o,r=void 0,l=void 0){const c=An(s),h=c+(l!==void 0&&l!==1?"_"+l:""),d=e&&l!==void 0&&l!==1,u=d?new Ce(1,1,1,l):void 0;l===void 0&&(l=1),d&&(l=1),u&&u.w<=.05&&(u.w=.05),i[h]={texture:s,scale:u};const f=s.channel>0?"st"+s.channel:"st";o.add(s.channel);const p=Vb.includes(s.format),g={1e3:"repeat",1001:"clamp",1002:"mirror"},_=s.repeat.clone(),y=s.offset.clone(),b=s.rotation,v=Math.sin(b),w=Math.cos(b);y.y=1-y.y-_.y,e?(_.x===0&&(_.x=1e-4),_.y===0&&(_.y=1e-4),y.x=y.x/_.x,y.y=y.y/_.y,y.x+=v/_.x,y.y+=w-1):(y.x+=v*_.x,y.y+=(1-w)*_.y);const P=xm(n),E=_.x!=1||_.y!=1||y.x!=0||y.y!=0||b!=0,T=`${Ri}/${P}/${"uvReader_"+f}.outputs:result>`,k=`${Ri}/${P}/Transform2d_${t}.outputs:result>`,z=t!=="normal"&&r&&(r.r!==1||r.g!==1||r.b!==1||l!==1)||!1,L=t==="normal",O=n instanceof It&&n.normalScale?n.normalScale.x*2:2,A=O.toFixed($e),$=(-1*(O/2)).toFixed($e),B=(1-O).toFixed($e);return`
		${E?`def Shader "Transform2d_${t}" (
			sdrMetadata = {
				string role = "math"
			}
		)
		{
			uniform token info:id = "UsdTransform2d"
			float2 inputs:in.connect = ${T}
			float2 inputs:scale = ${Yx(_)}
			float2 inputs:translation = ${Yx(y)}
			float inputs:rotation = ${(b/Math.PI*180).toFixed($e)}
			float2 outputs:result
		}
		`:""}
		def Shader "${c}_${t}"
		{
			uniform token info:id = "UsdUVTexture"
			asset inputs:file = @textures/${h}.${p?"png":"jpg"}@
			token inputs:sourceColorSpace = "${s.colorSpace==="srgb"?"sRGB":"raw"}"
			float2 inputs:st.connect = ${E?k:T}
			${z?`
			float4 inputs:scale = (${r?r.r+", "+r.g+", "+r.b:"1, 1, 1"}, ${l})
			`:""}
			${L?`
			float4 inputs:scale = (${A}, ${A}, ${A}, 1)
			float4 inputs:bias = (${$}, ${$}, ${B}, 0)
			`:""}
			token inputs:wrapS = "${g[s.wrapS]}"
			token inputs:wrapT = "${g[s.wrapT]}"
			float outputs:r
			float outputs:g
			float outputs:b
			float3 outputs:rgb
			${n.transparent||n.alphaTest>0?"float outputs:a":""}
		}`}function cI(s,t,e=!1){var f,p,g;const i=xm(s);if(s.colorWrite===!1||((f=s.userData)==null?void 0:f.isShadowCatcherMaterial)||((p=s.userData)==null?void 0:p.isLightBlendMaterial)){const _=s.userData.isLightBlendMaterial||s.userData.isShadowCatcherMaterial?"ND_realitykit_shadowreceiver_surfaceshader":"ND_realitykit_occlusion_surfaceshader";return`

		def Material "${i}" ${s.name?`(
			displayName = "${s.name}"
		)`:""}
		{
			token outputs:mtlx:surface.connect = ${Ri}/${i}/Occlusion.outputs:out>

			def Shader "Occlusion"
			{
				uniform token info:id = "${_}"
				token outputs:out
			}
		}`}const o="                ",r=[],l=[],c=new Set;if(s.isMeshPhysicalNodeMaterial===!0)return N2(s,i,t);let h=s.transparent||s.alphaTest?s.opacity:1,d=!1,u=!1;if(s instanceof Ey&&s.transmission!==void 0&&(h*=1-s.transmission*(1-s.roughness*.5)),s.map?(r.push(`${o}color3f inputs:diffuseColor.connect = ${Ri}/${i}/${An(s.map)}_diffuse.outputs:rgb>`),s instanceof Be&&s.transparent&&s.alphaTest==0&&e?(r.push(`${o}float inputs:opacity.connect = ${Ri}/${i}/${An(s.map)}_diffuse.outputs:a>`),d=!0,r.push(`${o}float inputs:opacityThreshold = ${1e-10}`),u=!0):s.transparent?(r.push(`${o}float inputs:opacity.connect = ${Ri}/${i}/${An(s.map)}_diffuse.outputs:a>`),d=!0):s.alphaTest>0&&(r.push(`${o}float inputs:opacity.connect = ${Ri}/${i}/${An(s.map)}_diffuse.outputs:a>`),d=!0,r.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),u=!0),l.push(hr(s.map,"diffuse",e,t,s,c,s.color,h))):r.push(`${o}color3f inputs:diffuseColor = ${Qx(s.color)}`),s.alphaHash&&e&&(u?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping alphaHash opacity threshold."):(r.push(`${o}float inputs:opacityThreshold = 0.0000000001`),u=!0)),s.aoMap&&(r.push(`${o}float inputs:occlusion.connect = ${Ri}/${i}/${An(s.aoMap)}_occlusion.outputs:r>`),l.push(hr(s.aoMap,"occlusion",e,t,s,c))),s.alphaMap?(r.push(`${o}float inputs:opacity.connect = ${Ri}/${i}/${An(s.alphaMap)}_opacity.outputs:r>`),r.push(`${o}float inputs:opacityThreshold = 0.0000000001`),d=!0,u=!0,l.push(hr(s.alphaMap,"opacity",e,t,s,c,new de(1,1,1),h))):(d?console.warn("Opacity for "+s.name+" was already connected. Skipping default opacity."):(r.push(`${o}float inputs:opacity = ${h}`),d=!0),s.alphaTest>0&&(u?console.warn("Opacity threshold for "+s.name+" was already connected. Skipping default opacity threshold."):(r.push(`${o}float inputs:opacityThreshold = ${s.alphaTest}`),u=!0))),s instanceof It){if(s.emissiveMap){r.push(`${o}color3f inputs:emissiveColor.connect = ${Ri}/${i}/${An(s.emissiveMap)}_emissive.outputs:rgb>`);const _=s.emissive.clone();_.multiplyScalar(s.emissiveIntensity),l.push(hr(s.emissiveMap,"emissive",e,t,s,c,_))}else if(((g=s.emissive)==null?void 0:g.getHex())>0){const _=s.emissive.clone();_.multiplyScalar(s.emissiveIntensity),r.push(`${o}color3f inputs:emissiveColor = ${Qx(_)}`)}s.normalMap&&(r.push(`${o}normal3f inputs:normal.connect = ${Ri}/${i}/${An(s.normalMap)}_normal.outputs:rgb>`),l.push(hr(s.normalMap,"normal",e,t,s,c))),s.roughnessMap&&s.roughness===1?(r.push(`${o}float inputs:roughness.connect = ${Ri}/${i}/${An(s.roughnessMap)}_roughness.outputs:g>`),l.push(hr(s.roughnessMap,"roughness",e,t,s,c))):r.push(`${o}float inputs:roughness = ${s.roughness!==void 0?s.roughness:1}`),s.metalnessMap&&s.metalness===1?(r.push(`${o}float inputs:metallic.connect = ${Ri}/${i}/${An(s.metalnessMap)}_metallic.outputs:b>`),l.push(hr(s.metalnessMap,"metallic",e,t,s,c))):r.push(`${o}float inputs:metallic = ${s.metalness!==void 0?s.metalness:0}`)}return s instanceof Ey&&(r.push(`${o}float inputs:clearcoat = ${s.clearcoat}`),r.push(`${o}float inputs:clearcoatRoughness = ${s.clearcoatRoughness}`),r.push(`${o}float inputs:ior = ${s.ior}`),!s.transparent&&!(s.alphaTest>0)&&s.transmissionMap&&(r.push(`${o}float inputs:opacity.connect = ${Ri}/${i}/${An(s.transmissionMap)}_transmission.outputs:r>`),l.push(hr(s.transmissionMap,"transmission",e,t,s,c)))),c.size>2?console.warn("USDZExporter: Material "+s.name+" uses more than 2 UV channels. Currently, only UV0 and UV1 are supported."):c.size===2&&(!c.has(0)||!c.has(1))&&console.warn("USDZExporter: Material "+s.name+" uses UV channels other than 0 and 1. Currently, only UV0 and UV1 are supported."),`

		def Material "${i}" ${s.name?`(
			displayName = "${A1(s.name)}"
		)`:""}
		{
			token outputs:surface.connect = ${Ri}/${i}/PreviewSurface.outputs:surface>

			def Shader "PreviewSurface"
			{
				uniform token info:id = "UsdPreviewSurface"
${r.join(`
`)}
				int inputs:useSpecularWorkflow = ${s instanceof Be?"1":"0"}
				token outputs:surface
			}
${l.length>0?`
${c.has(0)?`
			def Shader "uvReader_st"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${c.has(1)?`
			def Shader "uvReader_st1"
			{
				uniform token info:id = "UsdPrimvarReader_float2"
				token inputs:varname = "st1"
				float2 inputs:fallback = (0.0, 0.0)
				float2 outputs:result
			}
`:""}
${l.join(`
`)}`:""}
		}`}function Qx(s){return`(${s.r}, ${s.g}, ${s.b})`}function Yx(s){return`(${s.x}, ${s.y})`}const Vb=[1023,33777,33778,33779,35842,35843,37496,37808,37809,37810,37811,37812,37813,37814,37815,37816,37817,37818,37819,37820,37821,36492];S("debugusdz");const O0=class{constructor(t,e,i){a(this,"id");a(this,"trigger");a(this,"action");a(this,"exclusive",!1);this.id="Behavior_"+ps(t)+"_"+O0.global_id++,this.trigger=e,this.action=i}makeExclusive(t){return this.exclusive=t,this}writeTo(t,e,i){if(!this.trigger||!this.action)return;i.beginBlock(`def Preliminary_Behavior "${this.id}"`);let n="";if(Array.isArray(this.trigger)){n="[";for(let o=0;o<this.trigger.length;o++){const r=this.trigger[o];n+="<"+r.id+">",o+1<this.trigger.length&&(n+=", ")}n+="]"}else n=`<${this.trigger.id}>`;if(i.appendLine(`rel triggers = ${n}`),i.appendLine(`rel actions = <${this.action.id}>`),i.appendLine(`uniform bool exclusive = ${this.exclusive?1:0}`),i.appendLine(),Array.isArray(this.trigger))for(const o of this.trigger)o.writeTo(e,i),i.appendLine();else this.trigger.writeTo(e,i);i.appendLine(),this.action.writeTo(e,i),i.closeBlock()}};let ti=O0;a(ti,"global_id",0);const El=new Set;function R_(s,t){var i,n;let e="";if(Array.isArray(s)){El.clear();let o="[ ";for(let r=0;r<s.length;r++){let l=s[r];if(!l){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}if(typeof l=="string"){if(El.has(l))continue;o+=l,El.add(l)}else if(typeof l=="object"){if(l.isObject3D&&(l=t.findById(l.uuid),!l)){console.warn("Invalid target object in behavior",s+". Is the object exported?");continue}const c=(i=l.getPath)==null?void 0:i.call(l);if(El.has(c))continue;o+=c,El.add(c)}r+1<s.length&&(o+=", ")}o+=" ]",e=o,El.clear()}else if(typeof s=="object"){const o=s;if(o.isObject3D&&(s=t.findById(o.uuid)),!s)throw console.error("Invalid target object in behavior, the target object is likely missing from USDZ export. Is the object exported?",o),new Error(`Invalid target object in behavior, the target object is likely missing from USDZ export. Please report a bug. uuid: ${o.uuid}.`);e=(n=s.getPath)==null?void 0:n.call(s)}return e}const k0=class{constructor(t,e){a(this,"id");a(this,"targetId");a(this,"tokenId");a(this,"type");a(this,"distance");t&&(this.targetId=t),e?this.id=e:this.id="Trigger_"+k0.global_id++}writeTo(t,e){e.beginBlock(`def Preliminary_Trigger "${this.id}"`),this.targetId&&(typeof this.targetId!="string"&&(this.targetId=R_(this.targetId,t)),e.appendLine("rel affectedObjects = "+this.targetId)),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.type&&e.appendLine(`token type = "${this.type}"`),typeof this.distance=="number"&&e.appendLine(`double distance = ${this.distance}`),e.closeBlock()}};let Nr=k0;a(Nr,"global_id",0);function Kx(s,t={direct:!0,indirect:!0}){const e=gi.createEmpty();e.name="InputTarget_"+e.name,e.displayName=void 0,e.type="RealityKitComponent",e.onSerialize=i=>{i.appendLine("bool allowsDirectInput = "+(t.direct?1:0)),i.appendLine("bool allowsIndirectInput = "+(t.indirect?1:0)),i.appendLine('uniform token info:id = "RealityKit.InputTarget"')},s.add(e)}class _i{static sceneStartTrigger(){if(this.__sceneStartTrigger!==void 0)return this.__sceneStartTrigger;const t=new Nr(void 0,"SceneStart");return t.tokenId="SceneTransition",t.type="enter",this.__sceneStartTrigger=t,t}static tapTrigger(t,e={direct:!0,indirect:!0}){const i=new Nr(t);if(Array.isArray(t)&&t.length>1)for(const n of t)n instanceof gi&&Kx(n,e);else t instanceof gi&&Kx(t,e);return i.tokenId="TapGesture",i}static isTapTrigger(t){return(t==null?void 0:t.tokenId)==="TapGesture"}static proximityToCameraTrigger(t,e){const i=new Nr(t);return i.tokenId="ProximityToCamera",i.distance=e,i}}a(_i,"__sceneStartTrigger");class Ba{constructor(t,e){a(this,"id");a(this,"actions");a(this,"loops",0);a(this,"performCount",1);a(this,"type","serial");a(this,"multiplePerformOperation");this.id=t,this.actions=e}static getId(){return this.global_id++}addAction(t){return this.actions.push(t),this}makeParallel(){return this.type="parallel",this}makeSequence(){return this.type="serial",this}makeLooping(){return this.loops=1,this.performCount=0,this}makeRepeat(t){return this.performCount=t,this}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),e.beginArray("rel actions");for(const i of this.actions){if(!i)continue;const n=i===this.actions[this.actions.length-1];e.appendLine("<"+i.id+">"+(n?"":", "))}e.closeArray(),e.appendLine(),e.appendLine('token info:id = "Group"'),e.appendLine(`bool loops = ${this.loops}`),e.appendLine(`int performCount = ${this.loops>0?0:Math.max(0,this.performCount)}`),e.appendLine(`token type = "${this.type}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),e.appendLine();for(const i of this.actions)i&&(i.writeTo(t,e),e.appendLine());e.closeBlock()}}a(Ba,"global_id",0);const Ip=class{constructor(t,e){a(this,"id");a(this,"tokenId");a(this,"affectedObjects");a(this,"easeType");a(this,"motionType");a(this,"duration");a(this,"moveDistance");a(this,"style");a(this,"type");a(this,"front");a(this,"up");a(this,"start");a(this,"animationSpeed");a(this,"reversed");a(this,"pingPong");a(this,"xFormTarget");a(this,"audio");a(this,"gain");a(this,"auralMode");a(this,"multiplePerformOperation");a(this,"velocity");a(this,"comment");a(this,"animationName");t&&(this.affectedObjects=t),e?this.id=e:this.id="Action",this.id+="_"+Ip.global_id++}clone(){const t=new Ip,e=t.id;return Object.assign(t,this),t.id=e,t}writeTo(t,e){e.beginBlock(`def Preliminary_Action "${this.id}"`),this.comment&&e.appendLine(`# ${this.comment}`),this.affectedObjects&&(typeof this.affectedObjects!="string"&&(this.affectedObjects=R_(this.affectedObjects,t)),e.appendLine("rel affectedObjects = "+this.affectedObjects)),typeof this.duration=="number"&&(typeof this.animationSpeed=="number"&&this.animationSpeed!==1?e.appendLine(`double duration = ${this.duration/this.animationSpeed} `):e.appendLine(`double duration = ${this.duration} `)),this.easeType&&e.appendLine(`token easeType = "${this.easeType}"`),this.tokenId&&e.appendLine(`token info:id = "${this.tokenId}"`),this.tokenId==="ChangeScene"&&e.appendLine("rel scene = </StageRoot/Scenes/Scene>"),this.motionType!==void 0&&e.appendLine(`token motionType = "${this.motionType}"`),typeof this.moveDistance=="number"&&e.appendLine(`double moveDistance = ${this.moveDistance} `),this.style&&e.appendLine(`token style = "${this.style}"`),this.type&&e.appendLine(`token type = "${this.type}"`),this.front&&e.appendLine(`vector3d front = (${this.front.x}, ${this.front.y}, ${this.front.z})`),this.up&&e.appendLine(`vector3d upVector = (${this.up.x}, ${this.up.y}, ${this.up.z})`),typeof this.start=="number"&&e.appendLine(`double start = ${this.start} `),typeof this.animationSpeed=="number"&&e.appendLine(`double animationSpeed = ${this.animationSpeed.toFixed(2)} `),typeof this.reversed=="boolean"&&e.appendLine(`bool reversed = ${this.reversed}`),typeof this.pingPong=="boolean"&&e.appendLine(`bool reverses = ${this.pingPong}`),this.xFormTarget&&(typeof this.xFormTarget!="string"&&(this.xFormTarget=R_(this.xFormTarget,t)),e.appendLine(`rel xformTarget = ${this.xFormTarget}`)),typeof this.audio=="string"&&e.appendLine(`asset audio = @${this.audio}@`),typeof this.gain=="number"&&e.appendLine(`double gain = ${this.gain}`),typeof this.auralMode=="string"&&e.appendLine(`token auralMode = "${this.auralMode}"`),typeof this.multiplePerformOperation=="string"&&e.appendLine(`token multiplePerformOperation = "${this.multiplePerformOperation}"`),typeof this.velocity=="object"&&e.appendLine(`vector3d velocity = (${this.velocity.x}, ${this.velocity.y}, ${this.velocity.z})`),e.closeBlock()}};let hn=Ip;a(hn,"global_id",0);class zn{constructor(t,e,i){a(this,"x",0);a(this,"y",0);a(this,"z",0);this.x=t,this.y=e,this.z=i}static get up(){return new zn(0,1,0)}static get right(){return new zn(1,0,0)}static get forward(){return new zn(0,0,1)}static get back(){return new zn(0,0,-1)}static get zero(){return new zn(0,0,0)}}class Te{static sequence(...t){return new Ba("Group_"+Ba.getId(),t).makeSequence()}static parallel(...t){return new Ba("Group_"+Ba.getId(),t).makeParallel()}static fadeAction(t,e,i){const n=new hn(t);return n.tokenId="Visibility",n.type=i?"show":"hide",n.duration=e,n.style="basic",n.motionType="none",n.moveDistance=0,n.easeType="none",n}static startAnimationAction(t,e,i=!1,n=!1){const o=new hn(t);o.tokenId="StartAnimation";const r=e.start,l=e.duration,c=e.speed,h=e.clipName;if(o.comment=`Animation: ${h}, start=${r*60}, length=${l*60}, end=${(r+l)*60}`,o.animationName=h,o.start=r,o.duration=l,o.animationSpeed=c,o.reversed=i,o.pingPong=n,o.multiplePerformOperation="allow",i&&(o.start-=l),n){o.pingPong=!1;const d=o.clone();return d.reversed=!i,d.start=o.start,d.reversed&&(d.start-=l),Te.sequence(o,d)}return o}static waitAction(t){const e=new hn;return e.tokenId="Wait",e.duration=t,e.motionType=void 0,e}static lookAtCameraAction(t,e,i,n){const o=new hn(t);return o.tokenId="LookAtCamera",o.duration=e===void 0?9999999999999:e,o.front=i??zn.forward,o.up=n??zn.up,o}static emphasize(t,e,i="bounce",n=1,o="basic"){const r=new hn(t);return r.tokenId="Emphasize",r.duration=e,r.style=o??"basic",r.motionType=i,r.moveDistance=n,r}static transformAction(t,e,i,n,o="inout"){const r=new hn(t);return r.tokenId="Transform",r.duration=i,r.duration=Math.max(1e-6,i),r.type=n,r.easeType=i>0?o:"none",Array.isArray(e)&&console.error("Transform target must not be an array",e),r.xFormTarget=e,r}static playAudioAction(t,e,i="play",n=1,o="spatial"){const r=new hn(t);return r.tokenId="Audio",r.type=i,r.audio=e,r.gain=n,r.auralMode=o,r.multiplePerformOperation="allow",r}static impulseAction(t,e){const i=new hn(t);return i.tokenId="Impulse",i.velocity=e,i}}class hI{constructor(t){a(this,"object");a(this,"model");this.object=t}get id(){return this.object.uuid}apply(t){if(!this.model&&(this.model=t.findById(this.object.uuid),!this.model)){console.error("could not find model with id "+this.object.uuid);return}this.onApply(t)}}class N1 extends hI{constructor(e,i,n,o){super(e);a(this,"matrix");a(this,"material");a(this,"geometry");a(this,"_enableAction");a(this,"_disableAction");this.matrix=i,this.material=n,this.geometry=o}onApply(e){var o,r;const i=this.model;if(!i)return;(o=i.parent)!=null&&o.isDynamic||gi.createEmptyParent(i);const n=i.clone();this.matrix&&n.setMatrix(this.matrix),this.material&&(n.material=this.material),this.geometry&&(n.geometry=this.geometry),(r=i.parent)==null||r.add(n)}enable(){return this._enableAction?this._enableAction:(this._enableAction=Te.fadeAction(this.object,0,!0),this._enableAction)}disable(){return this._disableAction?this._disableAction:(this._disableAction=Te.fadeAction(this.object,0,!1),this._disableAction)}}class dI{constructor(t){a(this,"actions");a(this,"sortedActions");this.actions=[...t]}organize(){this.sortedActions={};for(const t of this.actions){const e=t.id;this.sortedActions[e]||(this.sortedActions[e]=[]),this.sortedActions[e].push(t)}}getActions(t){return this.sortedActions||this.organize(),this.sortedActions[t.uuid]}}const Fs=S("debugusdzanimation"),T_=S("debugusdzanimationserialization");class Fa{constructor(t,e,i){a(this,"_start");a(this,"ext");a(this,"root");a(this,"_nearestAnimatedRoot");a(this,"clip");a(this,"speed");this.ext=t,this.root=e,this.clip=i,this._nearestAnimatedRoot=this.getNearestAnimatedRoot()}get start(){return this._start===void 0&&(this._start=this.ext.getStartTimeByClip(this.clip)),this._start}get duration(){var t;return((t=this.clip)==null?void 0:t.duration)??it.restPoseClipDuration}get nearestAnimatedRoot(){return this._nearestAnimatedRoot}get clipName(){var t;return((t=this.clip)==null?void 0:t.name)??"rest"}static isDescendantOf(t,e){let i=e;if(!i||!t)return!1;for(;i;){if(!i)return!1;if(i===t)return!0;i=i.parent}return!1}getNearestAnimatedRoot(){var e;let t;try{for(const i of((e=this.clip)==null?void 0:e.tracks)??[]){const n=xc.parseTrackName(i.name);let o=xc.findNode(this.root,n.nodeName);if(o)if(!t)t=o;else{if(o===t||Fa.isDescendantOf(t,o))continue;if(!Fa.isDescendantOf(o,t)){for(;!Fa.isDescendantOf(o,t)&&o.parent;)o=o.parent;Fa.isDescendantOf(o,t)||console.error("USDZExporter: Animation clip targets multiple roots that are not parent/child. Please report a bug",this.root,this.clip,t,o)}t=o}}}catch(i){console.error("USDZExporter: Exception when trying to find nearest animated root. Please report a bug",i),t=void 0}return t}}const Dd=class{constructor(t,e,i){a(this,"clip");a(this,"pos");a(this,"rot");a(this,"scale");a(this,"root");a(this,"target");a(this,"duration",0);a(this,"useRootMotion",!1);if(this.root=t,this.target=e,this.clip=i,i?this.duration=i.duration:this.duration=Dd.restPoseClipDuration,i&&i.tracks){const o=Math.max(...i.tracks.map(r=>r.times[r.times.length-1]));o!==this.duration&&(console.warn("USDZExporter: Animation clip duration does not match the maximum time value in the tracks.",i,o,this.duration),this.duration=o)}const n=C.getComponent(t,ii);n&&(this.useRootMotion=n.applyRootMotion)}addTrack(t){var e,i;if(!this.clip){console.error("This is a rest clip but you're trying to add tracks to it â€“ this is likely a bug");return}t.name.endsWith("position")?this.pos=t:t.name.endsWith("quaternion")?this.rot=t:t.name.endsWith("scale")?this.scale=t:(t.name.endsWith("activeSelf")?console.warn("[USDZ] Animation of enabled/disabled state is not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((e=this.root)==null?void 0:e.name)??this.target.name)+". Animate scale 0/1 instead."):console.warn("[USDZ] Animation track type not supported for USDZ export and will NOT be exported: "+t.name+" on "+(((i=this.root)==null?void 0:i.name)??this.target.name)+". Only .position, .rotation, .scale are supported."),U()&&ke("[USDZ] Some animations can't be exported. See console for details."))}getFrames(){var t,e,i,n,o,r;return this.clip?Math.max(((e=(t=this.pos)==null?void 0:t.times)==null?void 0:e.length)??0,((n=(i=this.rot)==null?void 0:i.times)==null?void 0:n.length)??0,((r=(o=this.scale)==null?void 0:o.times)==null?void 0:r.length)??0):2}getDuration(){return this.duration}getSortedTimesArray(t=!0,e=!0,i=!0){var c,h,d;if(!this.clip)return[0,this.duration];const n=(c=this.pos)==null?void 0:c.times,o=(h=this.rot)==null?void 0:h.times,r=(d=this.scale)==null?void 0:d.times,l=[];if(t&&n)for(const u of n)l.push(u);if(e&&o)for(const u of o)l.push(u);if(i&&r)for(const u of r)l.push(u);return l.includes(0)||l.push(0),l.sort((u,f)=>u-f),[...new Set(l)]}*getValues(t,e=!0,i=!0,n=!0){var p,g,_;const o=new x,r=new H,l=new x(1,1,1),c=this.target,h=e?(p=this.pos)==null?void 0:p.createInterpolant():void 0,d=i?(g=this.rot)==null?void 0:g.createInterpolant():void 0,u=n?(_=this.scale)==null?void 0:_.createInterpolant():void 0;h||o.set(c.position.x,c.position.y,c.position.z),d||r.set(c.quaternion.x,c.quaternion.y,c.quaternion.z,c.quaternion.w),u||l.set(c.scale.x,c.scale.y,c.scale.z),h&&h.valueSize!==3&&(h.valueSize=3),d&&d.valueSize!==4&&(d.valueSize=4),u&&u.valueSize!==3&&(u.valueSize=3);const f=0;for(let y=0-f;y<t.length+f;y++){let b=0,v=0;if(y<0?(b=t[0],v=b-Dd.animationDurationPadding/2+1/60):y>=t.length?(b=t[t.length-1],v=b+Dd.animationDurationPadding/2-1/60):(b=t[y],v=b),h){const w=h.evaluate(b);o.set(w[0],w[1],w[2])}if(d){const w=d.evaluate(b);r.set(w[0],w[1],w[2],w[3])}if(u){const w=u.evaluate(b);l.set(w[0],w[1],w[2])}if(this.useRootMotion&&c===this.root){const w=new ce;w.compose(o,r,l),w.multiply(c.matrix),w.decompose(o,r,l)}yield{time:v,translation:o,rotation:r,scale:l,index:y}}}};let it=Dd;a(it,"frameRate",60),a(it,"animationDurationPadding",6/60),a(it,"restPoseClipDuration",6/60);class Hb{constructor(t){a(this,"dict",new Map);a(this,"rootTargetMap",new Map);a(this,"rootAndClipToRegisteredAnimationMap",new Map);a(this,"rootToRegisteredClip",new Map);a(this,"lastClipEndTime",0);a(this,"clipToStartTime",new Map);a(this,"clipToHoldClip",new Map);a(this,"serializers",[]);a(this,"injectRestPoses",!1);a(this,"injectImplicitBehaviours",!1);this.injectRestPoses=t,this.injectImplicitBehaviours=t}get extensionName(){return"animation"}get animationData(){return this.dict}get registeredClips(){return this.clipToStartTime.keys()}get animatedRoots(){return this.rootTargetMap.keys()}get holdClipMap(){return this.clipToHoldClip}getStartTimeCode(){return!this.injectRestPoses||this.rootAndClipToRegisteredAnimationMap.size===0?0:(it.restPoseClipDuration+it.animationDurationPadding)*60}getEndTimeCode(){let t=0;for(const[e,i]of this.rootAndClipToRegisteredAnimationMap){const n=i.start+i.duration;n>t&&(t=n)}return t*60}getClipCount(t){var i;return((i=this.rootToRegisteredClip.get(t))==null?void 0:i.length)??0??0}getStartTimeByClip(t){return t?this.clipToStartTime.has(t)?this.clipToStartTime.get(t):(console.error("USDZExporter: Missing start time for clip â€“ please report a bug.",t),0):0}registerAnimation(t,e){var h;if(!t)return null;this.rootTargetMap.has(t)||this.rootTargetMap.set(t,[]);const i=t.uuid+((e==null?void 0:e.uuid)??"-rest");if(this.rootAndClipToRegisteredAnimationMap.has(i))return this.rootAndClipToRegisteredAnimationMap.get(i);Fs&&console.log("registerAnimation",t,e);const n=this.injectRestPoses?1:0,o=(((h=this.rootToRegisteredClip.get(t))==null?void 0:h.length)??0)+n,r=this.rootTargetMap.get(t),l=new Set(r);if(e&&e.tracks)for(const d of e.tracks){const u=xc.parseTrackName(d.name),f=xc.findNode(t,u.nodeName);if(!f){console.warn("no object found for track",d.name,"using "+t.name+" instead");continue}this.dict.has(f)||this.dict.set(f,[]);const p=this.dict.get(f);if(!p){console.warn("no transform data found for target ",f,"at slot "+o+", this is likely a bug");continue}l.delete(f),this.injectRestPoses&&!p[0]&&(console.log("Injecting rest pose",f,e,"at slot",o),p[0]=new it(null,f,null));let g=p[o];g||(g=new it(t,f,e),p[o]=g),g.addTrack(d),r!=null&&r.includes(f)||r==null||r.push(f)}Fs&&console.log("Unregistered nodes for this clip",l,"clip",e,"at slot",o,"for root",t,"targets",r);for(const d of l){const u=this.dict.get(d);if(!u)continue;if(this.injectRestPoses&&!u[0]){console.warn("Adding rest pose for ",d,e,"at slot",o,"This is likely a bug, should have been added earlier.");const p=new it(null,d,null);u[0]=p}let f=u[o];f||(Fs&&console.log("Adding padding clip for ",d,e,"at slot",o),f=new it(t,d,e),u[o]=f)}const c=new Fa(this,t,e);if(this.rootAndClipToRegisteredAnimationMap.set(i,c),Fs&&console.log({root:t,clip:e,info:c}),e){const d=this.rootToRegisteredClip.get(t);if(d?d.push(e):this.rootToRegisteredClip.set(t,[e]),!this.clipToStartTime.get(e)){this.lastClipEndTime==null&&(this.lastClipEndTime=it.restPoseClipDuration);let f=this.lastClipEndTime+it.animationDurationPadding,p=f+e.duration;const g=Math.round(f*60)/60,_=Math.round(p*60)/60;Math.abs(g-f)<.01&&(f=g),Math.abs(_-p)<.01&&(p=_),f=Math.ceil(f),p=f+e.duration,this.clipToStartTime.set(e,f),this.lastClipEndTime=p}}return c}onAfterHierarchy(t){Fs&&console.log("Animation clips per animation target node",this.dict)}onAfterBuildDocument(t){var e,i;Fs&&console.log("Animation data",{dict:this.dict,rootTargetMap:this.rootTargetMap,rootToRegisteredClip:this.rootToRegisteredClip});for(const n of this.rootTargetMap.keys()){const o=this.rootTargetMap.get(n);if(!o)continue;let r;const l=[];for(const c of o){const h=this.dict.get(c);if(!h){console.error("No data found for target on USDZ export â€“ please report a bug!",c);continue}r===void 0&&(r=h==null?void 0:h.length),r!==(h==null?void 0:h.length)&&console.error("Different array lengths for targets â€“ please report a bug!",h);for(let d=0;d<h.length;d++){let u=h[d];if(!u){const p=d-(this.injectRestPoses?1:0);h[d]=new it(null,c,this.rootToRegisteredClip.get(n)[p]),u=h[d]}const f=u.getDuration();if(l[d]===void 0)l[d]=f;else if(l[d]!==f){console.error("Error during UDSZ export: Encountered different animation durations for animated targets. Please report a bug!",{datas:h,target:c}),l[d]=f;continue}}}}for(const n of this.serializers){const o=(e=n.model)==null?void 0:e.parent,r=(o==null?void 0:o.isDynamic)===!0;T_&&console.log(r,(i=n.model)==null?void 0:i.parent),r&&n.registerCallback(o)}}onExportObject(t,e,i){C.foreachComponent(t,o=>{const r=o;typeof r.createAnimation=="function"&&r.createAnimation(this,e,i)},!1);const n=new uI(t,this);this.serializers.push(n),n.registerCallback(e)}}class uI{constructor(t,e){a(this,"model");a(this,"object");a(this,"animationData");a(this,"ext");a(this,"callback");this.object=t,this.animationData=e.animationData,this.ext=e}registerCallback(t){this.model&&this.callback&&this.model.removeEventListener("serialize",this.callback),this.callback||(this.callback=this.onSerialize.bind(this)),T_&&console.log("REPARENT",t),this.model=t,this.callback&&this.model.addEventListener("serialize",this.callback)}skinnedMeshExport(t,e,i){var r;const n=this.model,o=this.animationData;if(n&&n.skinnedMesh){let p=function(B){const I=[];for(const[V,ie]of B){let Z=`${V} : [`;const J=[];for(const ue of ie)J.push(`(${me(ue.x)}, ${me(ue.y)}, ${me(ue.z)})`);Z=Z.concat(J.join(", ")),Z=Z.concat("],"),I.push(Z)}return I},g=function(B){const I=[];for(const[V,ie]of B){let Z=`${V} : [`;const J=[];for(const ue of ie)J.push(`(${me(ue.w)}, ${me(ue.x)}, ${me(ue.y)}, ${me(ue.z)})`);Z=Z.concat(J.join(", ")),Z=Z.concat("],"),I.push(Z)}return I},_=function(B){let I,V=!0;const ie=new Map;for(const[J,ue]of B){I===void 0&&(I=ue.length),I!==ue.length&&(V=!1);let Ae=0;for(const He of ue)Ae++,He||(ie.has(J)||ie.set(J,[]),ie.get(J).push(Ae))}Fs&&console.log("Bone count: ",B.size,"TransformData entries per bone: ",I,"Undefined bone entries: ",ie),console.assert(V,"All bones should have the same number of TransformData entries",B),console.assert(ie.size===0,"All TransformData entries should be set",ie);const Z=[];for(const[J,ue]of B)for(let Ae=0;Ae<ue.length;Ae++){const He=ue[Ae],ai=i.getStartTimeByClip(He.clip);Z.length<=Ae&&Z.push({pos:[],rot:[],scale:[],timeOffset:ai});const Wt=Z[Ae];Wt.pos.push(...He.getSortedTimesArray(!0,!1,!1)),Wt.rot.push(...He.getSortedTimesArray(!1,!0,!1)),Wt.scale.push(...He.getSortedTimesArray(!1,!1,!0))}for(const J of Z)J.pos.sort((ue,Ae)=>ue-Ae),J.rot.sort((ue,Ae)=>ue-Ae),J.scale.sort((ue,Ae)=>ue-Ae),J.pos=[...new Set(J.pos)],J.rot=[...new Set(J.rot)],J.scale=[...new Set(J.scale)];return Z},y=function(B,I,V){const ie=new Map,Z=new Map,J=new Map,ue=I.length;for(const Ae of V){const He=B.get(Ae);let ai;He?console.assert(He.length===ue,"We should have the same number of TransformData entries for each bone",He,I):ai=new it(null,Ae,null);for(let Wt=0;Wt<ue;Wt++){const Zi=He?He[Wt]:ai,en=I[Wt];for(const{time:xi,translation:xs}of Zi.getValues(en.pos,!0,!1,!1)){const Me=(xi+en.timeOffset)*60;ie.has(Me)||ie.set(Me,new Array),ie.get(Me).push(xs.clone())}for(const{time:xi,rotation:xs}of Zi.getValues(en.rot,!1,!0,!1)){const Me=(xi+en.timeOffset)*60;Z.has(Me)||Z.set(Me,new Array),Z.get(Me).push(xs.clone())}for(const{time:xi,scale:xs}of Zi.getValues(en.scale,!1,!1,!0)){const Me=(xi+en.timeOffset)*60;J.has(Me)||J.set(Me,new Array),J.get(Me).push(xs.clone())}}}return{position:ie.size==0?void 0:ie,quaternion:Z.size==0?void 0:Z,scale:J.size==0?void 0:J}},b=function(B){const I=[];for(const V of B)I.push(`(${me(V.x)}, ${me(V.y)}, ${me(V.z)})`);return I.join(", ")},v=function(B){const I=[];for(const V of B)I.push(`(${me(V.w)}, ${me(V.x)}, ${me(V.y)}, ${me(V.z)})`);return I.join(", ")},w=function(B){const I=new Map;if(Fs){const V=new Array;for(const[ie,Z]of o)V.push(ie.uuid+": "+Z.length+" "+Z.map(J=>{var ue;return(ue=J.clip)==null?void 0:ue.uuid.substring(0,6)}).join(" "));console.log(`getPerBoneTransformData
`+V.join(`
`))}for(const V of B){const ie=o.get(V);ie&&I.set(V,ie)}return I},P=function(B){const I=w(B),V=_(I);return y(I,V,B)};const l=n.skinnedMesh.skeleton,c=new Array,h=[],d=[];for(const B of l.bones){h.push(B),d.push(B.uuid);const I=l.boneInverses[l.bones.indexOf(B)];c.push({bone:B,inverse:I})}let u=1e4;for(;d.length<l.bones.length&&u-- >0;)for(const B of h){const I=B.children;for(const V of I)if(d.indexOf(V.uuid)===-1&&l.bones.indexOf(V)!==-1){h.push(V),d.push(V.uuid);const ie=l.boneInverses[l.bones.indexOf(V)];c.push({bone:V,inverse:ie})}}u<=0&&console.error("Failed to sort bones in skinned mesh",n.skinnedMesh,l.bones,d);for(const B of D1(l.bones))c.push({bone:B,inverse:B.matrixWorld.clone().invert()});const f=c[0].bone.parent;f||console.error("No bone parent found for skinned mesh during USDZ export",n.skinnedMesh),c.sort((B,I)=>mc(B.bone,f)>mc(I.bone,f)?1:-1);const E=e.quickLookCompatible,T=[],k=[],z=[],L=[];for(const{bone:B}of c){if(E){const I=B.scale;I.x==0&&(I.x=1e-5),I.y==0&&(I.y=1e-5),I.z==0&&(I.z=1e-5),T.push(new ce().compose(B.position,B.quaternion,B.scale))}else T.push(B.matrix.clone());k.push(B.position),z.push(B.quaternion),L.push(B.scale)}const O=c.map(B=>'"'+mc(B.bone,f)+'"').join(", "),A=c.map(B=>qx(B.inverse.clone().invert())).join(", ");t.beginBlock('def Skeleton "Rig"'),t.appendLine(`uniform matrix4d[] bindTransforms = [${A}]`),t.appendLine(`uniform token[] joints = [${O}]`),t.appendLine('uniform token purpose = "guide"'),t.appendLine(`uniform matrix4d[] restTransforms = [${T.map(B=>qx(B)).join(", ")}]`);const $=P(c.map(B=>B.bone));if(Fs){let B=1e7,I=0;for(const V of((r=$.position)==null?void 0:r.keys())??[])B=Math.min(B,V),I=Math.max(I,V);console.log("Time samples",B,I,$)}if(t.beginBlock('def SkelAnimation "_anim"'),t.appendLine(`uniform token[] joints = [${O}]`),t.appendLine(`quatf[] rotations = [${v(z)}]`),$&&$.quaternion){t.beginBlock("quatf[] rotations.timeSamples = {","");const B=g($.quaternion);for(const I of B)t.appendLine(I);t.closeBlock()}if(t.appendLine(`half3[] scales = [${b(L)}]`),$&&$.scale){t.beginBlock("half3[] scales.timeSamples = {","");const B=p($.scale);for(const I of B)t.appendLine(I);t.closeBlock()}if(t.appendLine(`float3[] translations = [${b(k)}]`),$&&$.position){t.beginBlock("float3[] translations.timeSamples = {","");const B=p($.position);for(const I of B)t.appendLine(I);t.closeBlock()}t.closeBlock(),t.closeBlock()}}onSerialize(t,e){if(!this.model)return;const i=this.animationData.get(this.object);if(i)for(let d=0;d<i.length;d++)i[d]===void 0&&(i[d]=new it(null,this.object,null));const n=this.ext;this.skinnedMeshExport(t,e,n);const o=this.object,r=this.model,l=this.animationData.get(o);if(!l||o.isSkinnedMesh)return;T_&&console.log("SERIALIZE",this.model.name,this.object.type,l);const c=Intl.NumberFormat("en-US",{maximumFractionDigits:3,minimumFractionDigits:0,useGrouping:!1});function h(d,u){var p;if(d.some(g=>g&&{position:g.pos,rotation:g.rot,scale:g.scale}[u])){switch(u){case"position":r.needsTranslate=!0,t.beginBlock("double3 xformOp:translate.timeSamples = {","");break;case"rotation":r.needsOrient=!0,t.beginBlock("quatf xformOp:orient.timeSamples = {","");break;case"scale":r.needsScale=!0,t.beginBlock("double3 xformOp:scale.timeSamples = {","");break}for(let g=0;g<d.length;g++){const _=d[g];if(!_)continue;const y=n.getStartTimeByClip(_.clip),b=_.getSortedTimesArray(u==="position",u==="rotation",u==="scale");if(!b||b.length===0){console.error("got an animated object but no time values?",o,_);continue}const v=!_.clip,w=u==="position"&&(_.pos||v),P=u==="rotation"&&(_.rot||v),E=u==="scale"&&(_.scale||v);if(w||P||E){const T=((p=_.clip)==null?void 0:p.name)??"rest",k=_.getDuration();Fs&&console.log("Write .timeSamples:",T,y,k,d),t.appendLine("# "+T+": start="+c.format(y*it.frameRate)+", length="+c.format(k*it.frameRate)+", frames="+_.getFrames())}if(w)for(const{time:T,translation:k}of _.getValues(b,!0,!1,!1)){const L=`${c.format((y+T)*it.frameRate)}: (${me(k.x)}, ${me(k.y)}, ${me(k.z)}),`;t.appendLine(L)}if(P)for(const{time:T,rotation:k}of _.getValues(b,!1,!0,!1)){const L=`${c.format((y+T)*it.frameRate)}: (${me(k.w)}, ${me(k.x)}, ${me(k.y)}, ${me(k.z)}),`;t.appendLine(L)}if(E)for(const{time:T,scale:k}of _.getValues(b,!1,!1,!0)){const L=`${c.format((y+T)*it.frameRate)}: (${me(k.x)}, ${me(k.y)}, ${me(k.z)}),`;t.appendLine(L)}}t.closeBlock()}}h(l,"position"),h(l,"rotation"),h(l,"scale")}}const fI=S("debugusdz");class Wc{constructor(){a(this,"files",new Array)}static getName(t){var o;const e=t.split(".").pop();let n=(o=t.split(".").slice(0,-1).join(".").split("/").pop())==null?void 0:o.replace(".","_");return n||(n="Audio_"+Math.random().toString(36).substring(2,15)),ps(n)+"."+e}get extensionName(){return"Audio"}onExportObject(t,e,i){const n=C.getComponents(t,Oe);if(n.length)for(const o of n){if(!o.clip||typeof o.clip!="string"||!o.playOnAwake)continue;const r=o.clip.split("/").pop()||"Audio",l=Wc.getName(o.clip),c=ps(l);if(!this.files.some(h=>h.path===o.clip)){this.files.push({path:o.clip,name:l});const h=l.toLowerCase();i.quickLookCompatible&&!h.endsWith(".mp3")&&!h.endsWith(".wav")&&!h.endsWith(".m4a")&&console.error("Audio file "+o.clip+" from "+o.name+" is not an MP3 or WAV file. QuickLook may not support playing it.")}i.quickLookCompatible||e.addEventListener("serialize",(h,d)=>{h.appendLine(),h.beginBlock(`def SpatialAudio "${c}"`,"(",!1),h.appendLine(`displayName = "${r}"`),h.closeBlock(")"),h.beginBlock(),h.appendLine(`uniform asset filePath = @audio/${l}@`),h.appendLine(`uniform token auralMode = "${o.spatialBlend>0?"spatial":"nonSpatial"}"`),h.appendLine(`uniform token playbackMode = "${o.loop?"loopFromStage":"onceFromStart"}"`),h.appendLine(`uniform float gain = ${o.volume}`),h.closeBlock()})}}async onAfterSerialize(t){for(const e of this.files){const i="audio/"+e.name;if(t.files[i]){fI&&console.warn("Audio file with name "+i+" already exists in the context. Skipping.");continue}const r=await(await(await fetch(e.path)).blob()).arrayBuffer(),l=new Uint8Array(r);t.files[i]=l}}}var ot=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Jx=S("debugusdzbehaviours");function cu(s){s&&(s.getComponentInParent(Ic)||(U()&&console.debug('Raycaster on "'+s.name+'" was automatically added, because no raycaster was found in the parent hierarchy.'),s.addComponent(Vn)))}class Vc extends j{constructor(){super(...arguments);a(this,"object");a(this,"target");a(this,"duration",1);a(this,"relativeMotion",!1);a(this,"coroutine",null);a(this,"targetPos",new x);a(this,"targetRot",new H);a(this,"targetScale",new x)}start(){cu(this.gameObject)}onPointerClick(e){e.use(),this.coroutine&&this.stopCoroutine(this.coroutine),this.relativeMotion?this.coroutine=this.startCoroutine(this.moveRelative()):this.coroutine=this.startCoroutine(this.moveToTarget())}*moveToTarget(){if(!this.target||!this.object)return;const e=ae(this.object).clone(),i=ae(this.target).clone(),n=Le(this.object).clone(),o=Le(this.target).clone(),r=_t(this.object).clone(),l=_t(this.target).clone(),c=e.distanceTo(i),h=n.angleTo(o),d=r.distanceTo(l);if(c<.01&&h<.01&&d<.01){ei(this.object,i),no(this.object,o),zd(this.object,l),this.coroutine=null;return}let u=0,f=0;for(;u<1;)u+=this.context.time.deltaTime/this.duration,u>1&&(u=1),f=u<.5?4*u*u*u:1-Math.pow(-2*u+2,3)/2,this.targetPos.lerpVectors(e,i,f),this.targetRot.slerpQuaternions(n,o,f),this.targetScale.lerpVectors(r,l,f),ei(this.object,this.targetPos),no(this.object,this.targetRot),zd(this.object,this.targetScale),yield;this.coroutine=null}*moveRelative(){if(!this.target||!this.object)return;const e=this.object.position.clone(),i=this.object.quaternion.clone(),n=this.object.scale.clone(),o=this.target.position.clone(),r=this.target.quaternion.clone(),l=this.target.scale.clone();o.applyQuaternion(this.object.quaternion),this.targetPos.copy(this.object.position).add(o),this.targetRot.copy(this.object.quaternion).multiply(r),this.targetScale.copy(this.object.scale).multiply(l);let c=0,h=0;for(;c<1;)c+=this.context.time.deltaTime/this.duration,c>1&&(c=1),h=c<.5?4*c*c*c:1-Math.pow(-2*c+2,3)/2,this.object.position.lerpVectors(e,this.targetPos,h),this.object.quaternion.slerpQuaternions(i,this.targetRot,h),this.object.scale.lerpVectors(n,this.targetScale,h),yield;this.coroutine=null}beforeCreateDocument(e){var i;if(this.target&&this.object&&this.gameObject){const n=new ti("Move to "+((i=this.target)==null?void 0:i.name),_i.tapTrigger(this.gameObject),Te.transformAction(this.object,this.target,this.duration,this.relativeMotion?"relative":"absolute"));e.addBehavior(n)}}}ot([m(D)],Vc.prototype,"object",void 0);ot([m(D)],Vc.prototype,"target",void 0);ot([m()],Vc.prototype,"duration",void 0);ot([m()],Vc.prototype,"relativeMotion",void 0);const di=class extends j{constructor(){super(...arguments);a(this,"materialToSwitch");a(this,"variantMaterial");a(this,"fadeDuration",0);a(this,"_objectsWithThisMaterial",null);a(this,"selfModel");a(this,"targetModels")}start(){var e;this._objectsWithThisMaterial=this.objectsWithThisMaterial,cu(this.gameObject),U()&&this._objectsWithThisMaterial.length<=0&&console.warn('ChangeMaterialOnClick: No objects found with material "'+((e=this.materialToSwitch)==null?void 0:e.name)+'"')}onPointerEnter(e){this.context.input.setCursor("pointer")}onPointerExit(e){this.context.input.unsetCursor("pointer")}onPointerClick(e){if(e.use(),!!this.variantMaterial)for(let i=0;i<this.objectsWithThisMaterial.length;i++){const n=this.objectsWithThisMaterial[i];n.material=this.variantMaterial}}get objectsWithThisMaterial(){return this._objectsWithThisMaterial!=null?this._objectsWithThisMaterial:(this._objectsWithThisMaterial=[],this.variantMaterial&&this.materialToSwitch&&this.context.scene.traverse(e=>{if(e instanceof X)if(Array.isArray(e.material)){for(const i of e.material)if(i===this.materialToSwitch){this.objectsWithThisMaterial.push(e);break}}else e.material===this.materialToSwitch?this.objectsWithThisMaterial.push(e):QE(e.material,this.materialToSwitch)&&this.objectsWithThisMaterial.push(e)}),this._objectsWithThisMaterial)}async beforeCreateDocument(e,i){this.targetModels=[],di._materialTriggersPerId={},di.variantSwitchIndex=0,this.materialToSwitch&&await pt.assignTextureLOD(this.materialToSwitch,0),this.variantMaterial&&await pt.assignTextureLOD(this.variantMaterial,0)}createBehaviours(e,i,n){this.objectsWithThisMaterial.find(r=>r.uuid===i.uuid)&&this.targetModels.push(i),this.gameObject.uuid===i.uuid&&(this.selfModel=i,this.materialToSwitch&&(di._materialTriggersPerId[this.materialToSwitch.uuid]||(di._materialTriggersPerId[this.materialToSwitch.uuid]=[]),di._materialTriggersPerId[this.materialToSwitch.uuid].push(this)))}afterCreateDocument(e,i){if(!this.materialToSwitch)return;const n=di._materialTriggersPerId[this.materialToSwitch.uuid];if(n){const o={};for(const r of n){const l=r.createVariants();l&&l.length>0&&(o[r.selfModel.uuid]=l)}for(const r of n){const l=[];for(const c in o)c!==r.selfModel.uuid&&l.push(...o[c]);r.createAndAttachBehaviors(e,o[r.selfModel.uuid],l)}}delete di._materialTriggersPerId[this.materialToSwitch.uuid]}createAndAttachBehaviors(e,i,n){const o=[],r=Math.max(0,this.fadeDuration);o.push(Te.fadeAction([...this.targetModels,...n],r,!1)),o.push(Te.fadeAction(i,r,!0)),e.addBehavior(new ti("Select_"+this.selfModel.name,_i.tapTrigger(this.selfModel),Te.parallel(...o))),di._parallelStartHiddenActions.push(...i),di._startHiddenBehaviour||(di._startHiddenBehaviour=new ti("StartHidden_"+this.selfModel.name,_i.sceneStartTrigger(),Te.fadeAction(di._parallelStartHiddenActions,r,!1)),e.addBehavior(di._startHiddenBehaviour))}static getMaterialName(e){return ps(e.name||"Material")+"_"+e.id}createVariants(){if(!this.variantMaterial)return null;const e=[];for(const i of this.targetModels){const n=i.clone();n.name+="_Variant_"+di.variantSwitchIndex+++"_"+di.getMaterialName(this.variantMaterial),n.displayName=n.displayName+": Variant with material "+this.variantMaterial.name,n.material=this.variantMaterial,n.geometry=i.geometry,n.transform=i.transform,(!i.parent||!i.parent.isEmpty())&&gi.createEmptyParent(i),i.parent&&i.parent.add(n),e.push(n)}return e}};let is=di;a(is,"_materialTriggersPerId",{}),a(is,"_startHiddenBehaviour",null),a(is,"_parallelStartHiddenActions",[]),a(is,"variantSwitchIndex",0);ot([m(Ie)],is.prototype,"materialToSwitch",void 0);ot([m(Ie)],is.prototype,"variantMaterial",void 0);ot([m()],is.prototype,"fadeDuration",void 0);const Qe=class extends j{constructor(){super(...arguments);a(this,"target");a(this,"toggleOnClick",!1);a(this,"targetState",!0);a(this,"hideSelf",!0);a(this,"selfModel");a(this,"selfModelClone");a(this,"targetModel");a(this,"toggleModel");a(this,"stateBeforeCreatingDocument",!1);a(this,"targetStateBeforeCreatingDocument",!1)}start(){cu(this.gameObject)}onPointerClick(e){e.use(),!this.toggleOnClick&&this.hideSelf&&(this.gameObject.visible=!1),this.target&&(this.target.visible=this.toggleOnClick?!this.target.visible:this.targetState)}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.selfModel=i,this.selfModelClone=i.clone())}beforeCreateDocument(){this.target&&(this.gameObject[Qe.wasVisible]===void 0&&(this.gameObject[Qe.wasVisible]=this.gameObject.activeSelf),this.target[Qe.wasVisible]===void 0&&(this.target[Qe.wasVisible]=this.target.activeSelf),this.stateBeforeCreatingDocument=this.gameObject[Qe.wasVisible],this.targetStateBeforeCreatingDocument=this.target[Qe.wasVisible],this.gameObject.visible=!0,this.target.visible=!0)}afterCreateDocument(e,i){if(!this.target)return;this.targetModel=i.document.findById(this.target.uuid);const n=this.selfModel;if(this.selfModel&&this.targetModel){let o=this.selfModel,r=this.targetState;if(this.toggleOnClick)if(r=!this.targetStateBeforeCreatingDocument,!this.selfModelClone.geometry)(!this.selfModel.parent||this.selfModel.parent.isEmpty())&&L1.createEmptyParent(this.selfModel),this.toggleModel=this.selfModel.deepClone(),this.toggleModel.name+="_toggle",this.selfModel.parent.add(this.toggleModel);else{if(!this.gameObject[Qe.toggleClone]){const h=this.selfModelClone.clone();h.setMatrix(new ce),h.name+="_toggle"+Qe.clonedToggleIndex++,n.add(h),this.gameObject[Qe.toggleClone]=h,console.warn("USDZExport: Toggle "+this.gameObject.name+" doesn't have geometry. It will be deep cloned and nested behaviours will likely not work.")}const c=this.gameObject[Qe.toggleClone];if(!this.gameObject[Qe.reverseToggleClone]){const h=this.selfModelClone.clone();h.setMatrix(new ce),h.name+="_toggleReverse"+Qe.clonedToggleIndex++,n.add(h),this.gameObject[Qe.reverseToggleClone]=h}this.toggleModel=this.gameObject[Qe.reverseToggleClone],(!this.toggleModel.geometry||!c.geometry)&&console.error("triggers without childs and without geometry won't work!",this,n.geometry),o=c,n.geometry=null,n.material=null}if(this.toggleModel){if(this.toggleOnClick){const c=[];c.push(Te.fadeAction(o,0,!1)),c.push(Te.fadeAction(this.toggleModel,0,!0)),c.push(Te.fadeAction(this.targetModel,0,r)),e.addBehavior(new ti("Toggle_"+o.name+"_ToggleTo"+(r?"On":"Off"),_i.tapTrigger(o),Te.parallel(...c)));const h=[];h.push(Te.fadeAction(this.toggleModel,0,!1)),h.push(Te.fadeAction(o,0,!0)),h.push(Te.fadeAction(this.targetModel,0,!r)),e.addBehavior(new ti("Toggle_"+o.name+"_ToggleTo"+(r?"Off":"On"),_i.tapTrigger(this.toggleModel),Te.parallel(...h)))}}else{const c=[];this.hideSelf&&c.push(Te.fadeAction(o,0,!1)),c.push(Te.fadeAction(this.targetModel,0,r)),e.addBehavior(new ti("Toggle_"+o.name+"_ToggleTo"+(r?"On":"Off"),_i.tapTrigger(o),c.length>1?Te.parallel(...c):c[0]))}const l=new Array;this.targetStateBeforeCreatingDocument||l.push(this.targetModel),this.stateBeforeCreatingDocument||l.push(n),this.toggleModel&&l.push(this.toggleModel),za.add(l,e)}}afterSerialize(e,i){this.gameObject[Qe.wasVisible]!==void 0&&(this.gameObject.visible=this.gameObject[Qe.wasVisible],delete this.gameObject[Qe.wasVisible]),this.target&&this.target[Qe.wasVisible]!==void 0&&(this.target.visible=this.target[Qe.wasVisible],delete this.target[Qe.wasVisible]),delete this.gameObject[Qe.toggleClone],delete this.gameObject[Qe.reverseToggleClone]}};let Ln=Qe;a(Ln,"clonedToggleIndex",0),a(Ln,"wasVisible",Symbol("usdz_SetActiveOnClick_wasVisible")),a(Ln,"toggleClone",Symbol("clone for toggling")),a(Ln,"reverseToggleClone",Symbol("clone for reverse toggling"));ot([m(D)],Ln.prototype,"target",void 0);ot([m()],Ln.prototype,"toggleOnClick",void 0);ot([m()],Ln.prototype,"targetState",void 0);ot([m()],Ln.prototype,"hideSelf",void 0);const ko=class extends j{constructor(){super(...arguments);a(this,"wasVisible",!1)}static add(e,i){const n=Array.isArray(e)?e:[e];for(const o of n)ko._fadeObjects.includes(o)||(console.log("adding hide on start",o),ko._fadeObjects.push(o));ko._fadeBehaviour===void 0&&(ko._fadeBehaviour=new ti("HideOnStart",_i.sceneStartTrigger(),Te.fadeAction(ko._fadeObjects,0,!1)),i.addBehavior(ko._fadeBehaviour))}start(){C.setActive(this.gameObject,!1)}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.wasVisible||ko.add(i,e))}beforeCreateDocument(){this.wasVisible=C.isActiveSelf(this.gameObject)}};let za=ko;a(za,"_fadeBehaviour"),a(za,"_fadeObjects",[]);class hu extends j{constructor(){super(...arguments);a(this,"target");a(this,"duration",.5);a(this,"motionType","bounce")}beforeCreateDocument(){}createBehaviours(e,i,n){if(this.target&&i.uuid===this.gameObject.uuid){const o=new ti("emphasize "+this.name,_i.tapTrigger(this.gameObject),Te.emphasize(this.target,this.duration,this.motionType,void 0,"basic"));e.addBehavior(o)}}afterCreateDocument(e,i){}}ot([m()],hu.prototype,"target",void 0);ot([m()],hu.prototype,"duration",void 0);ot([m()],hu.prototype,"motionType",void 0);class tl extends j{constructor(){super(...arguments);a(this,"target");a(this,"clip","");a(this,"toggleOnClick",!1);a(this,"trigger","tap")}start(){cu(this.gameObject)}ensureAudioSource(){if(!this.target){const e=this.gameObject.addComponent(Oe);e&&(this.target=e,e.spatialBlend=1,e.volume=1,e.loop=!1,e.preload=!0)}}onPointerClick(e){var i;e.use(),!(!((i=this.target)!=null&&i.clip)&&!this.clip)&&(this.ensureAudioSource(),this.target&&(this.target.isPlaying&&this.toggleOnClick?this.target.stop():(!this.toggleOnClick&&this.target.isPlaying&&this.target.stop(),this.clip?this.target.play(this.clip):this.target.play())))}createBehaviours(e,i,n){if(!(!this.target&&!this.clip)&&i.uuid===this.gameObject.uuid){const o=this.clip?this.clip:this.target?this.target.clip:void 0;if(!o||typeof o!="string")return;const r=this.target?this.target.gameObject:this.gameObject;Wc.getName(o);const l=this.target?this.target.volume:1,c=this.target&&this.target.spatialBlend==0?"nonSpatial":"spatial";let h=!1;this.gameObject.traverse(p=>{p instanceof X&&p.visible&&(h=!0)}),h=!0;const d=e.addAudioClip(o);let u=Te.playAudioAction(r,d,"play",l,c);this.target&&this.target.loop&&(u=Te.sequence(u).makeLooping());const f=this.name?"_"+this.name:"";if(h&&this.trigger==="tap"){this.toggleOnClick&&(u.multiplePerformOperation="stop");const p=new ti("playAudio"+f,_i.tapTrigger(i),u);e.addBehavior(p)}if(this.target&&this.target.playOnAwake&&this.target.enabled)if(h&&this.trigger==="tap")console.warn("USDZExport: Audio sources that are played on tap can't also auto-play at scene start due to a QuickLook bug.");else{const p=new ti("playAudioOnStart"+f,_i.sceneStartTrigger(),u);e.addBehavior(p)}}}}ot([m(Oe)],tl.prototype,"target",void 0);ot([m(URL)],tl.prototype,"clip",void 0);ot([m()],tl.prototype,"toggleOnClick",void 0);const Zn=class extends j{constructor(){super(...arguments);a(this,"animator");a(this,"stateName");a(this,"trigger","tap");a(this,"animation");a(this,"selfModel");a(this,"stateAnimationModel");a(this,"animationSequence",new Array);a(this,"animationLoopAfterSequence",new Array);a(this,"randomOffsetNormalized",0)}get target(){var e,i;return((e=this.animator)==null?void 0:e.gameObject)||((i=this.animation)==null?void 0:i.gameObject)}start(){cu(this.gameObject)}onPointerClick(e){var i;e.use(),this.target&&this.stateName&&((i=this.animator)==null||i.play(this.stateName,0,0,.1))}createBehaviours(e,i,n){i.uuid===this.gameObject.uuid&&(this.selfModel=i)}afterSerialize(){if(Zn.rootsWithExclusivePlayback.size>1){const e='Multiple root objects targeted by more than one animation. To work around QuickLook bug FB13410767, animations will be set as "exclusive" and activating them will stop other animations being marked as exclusive.';U()&&ke(e),console.warn(e,...Zn.rootsWithExclusivePlayback)}Zn.animationActions=[],Zn.rootsWithExclusivePlayback=new Set}afterCreateDocument(e,i){if(this.animationSequence===void 0&&this.animationLoopAfterSequence===void 0||!this.stateAnimationModel||!this.target)return;const n=i.document,o=i.extensions.find(c=>c instanceof Hb);if(!o)return;const r=o.getClipCount(this.target)>1;r&&(U()&&console.warn("Setting exclusive playback for "+this.target.name+"@"+this.stateName+" because it has "+o.getClipCount(this.target)+" animations. This works around QuickLook bug FB13410767."),Zn.rootsWithExclusivePlayback.add(this.target));const l=this.name?this.name:"";n.traverse(c=>{var h,d;if(c.uuid===((h=this.target)==null?void 0:h.uuid)){const u=Zn.getActionForSequences(n,c,this.animationSequence,this.animationLoopAfterSequence,this.randomOffsetNormalized),f=new ti(this.trigger+"_"+l+"_toPlayAnimation_"+this.stateName+"_on_"+((d=this.target)==null?void 0:d.name),this.trigger=="tap"?_i.tapTrigger(this.selfModel):_i.sceneStartTrigger(),u);r&&f.makeExclusive(!0),e.addBehavior(f)}})}static getActionForSequences(e,i,n,o,r){const l=(h,d)=>{let u=Zn.animationActions.find(f=>f.affectedObjects==h&&f.start==d.start&&f.duration==d.duration&&f.animationSpeed==d.speed);return u||(u=Te.startAnimationAction(h,d),Zn.animationActions.push(u)),u},c=Te.sequence();if(n&&n.length>0)for(const h of n)c.addAction(l(i,h));if(o&&o.length>0){const h=c.actions.length==0?c:Te.sequence();for(const d of o)h.addAction(l(i,d));h.makeLooping(),c!==h&&c.addAction(h)}return r&&r>0&&c.actions.unshift(Te.waitAction(r)),c}static getAndRegisterAnimationSequences(e,i,n){var _,y,b,v,w,P,E,T;if(!i)return;const o=i.getComponent(ii),r=i.getComponent(Yi);if(!o&&!r)return;if(o&&!n)throw new Error("PlayAnimationOnClick: No stateName specified for animator "+o.name+" on "+i.name);let l=[],c=[];if(r){const k=e.registerAnimation(i,r.clip);k&&(r.loop?c.push(k):l.push(k));let z=0;if(r.minMaxOffsetNormalized){const L=r.minMaxOffsetNormalized.x,O=r.minMaxOffsetNormalized.y;z=(((_=r.clip)==null?void 0:_.duration)||1)*(L+Math.random()*(O-L))}return{animationSequence:l,animationLoopAfterSequence:c,randomTimeOffset:z}}const h=o==null?void 0:o.runtimeAnimatorController;let d=h==null?void 0:h.findState(n),u=[],f=[];if(h&&d){const k=new Array;k.push(d);let z=!1;for(;k.length<100;){if(!d||d===null||!d.transitions||d.transitions.length===0){(y=d.motion)!=null&&y.isLooping&&(z=!0);break}const L=d.transitions.find(A=>A.conditions.length===0),O=L?h.getState(L.destinationState,0):null;if(O&&k.includes(O)){d=O,z=!0;break}else if(L){if(d=O,!d)break;k.push(d)}else{z=((b=d.motion)==null?void 0:b.isLooping)??!1;break}}if(z&&d){const L=k.indexOf(d);u=k.slice(0,L),f=k.slice(L),Jx&&console.log("found loop from "+n,"states until loop",u,"states looping",f)}else u=k,f=[],Jx&&console.log("found no loop from "+n,"states",u);if(!f.length){const L=u[u.length-1],O=(v=L.motion)==null?void 0:v.clip;if(O){let A;if(e.holdClipMap.has(O))A=e.holdClipMap.get(O);else{const $=L.name+"_hold";A=O.clone(),A.duration=1,A.name=$;const B=O.duration;A.tracks=O.tracks.map(I=>{const V=I.clone();V.times=new Float32Array([0,B]);const ie=I.values.length,Z=I.getValueSize(),J=I.values.slice(ie-Z,ie);return V.values=new Float32Array(2*Z),V.values.set(J,0),V.values.set(J,Z),V}),A.name=$,e.holdClipMap.set(O,A)}if(A){const $={name:A.name,motion:{clip:A,isLooping:!1,name:A.name},speed:1,transitions:[],behaviours:[],hash:L.hash+1};f.push($)}}}}if(u.length===1&&(!((w=u[0].motion)!=null&&w.clip)||((E=(P=u[0].motion)==null?void 0:P.clip.tracks)==null?void 0:E.length)===0)){l=new Array;const k=e.registerAnimation(i,null);k&&l.push(k);return}if(u=u.filter(k=>{var z,L,O;return((z=k.motion)==null?void 0:z.clip)&&((O=(L=k.motion)==null?void 0:L.clip.tracks)==null?void 0:O.length)>0}),f=f.filter(k=>{var z,L,O;return((z=k.motion)==null?void 0:z.clip)&&((O=(L=k.motion)==null?void 0:L.clip.tracks)==null?void 0:O.length)>0}),u.length===0&&f.length===0){console.warn("No clips found for state "+n+" on "+(o==null?void 0:o.name)+", can't export animation data");return}const p=(k,z)=>{if(!i)return;const L=e.registerAnimation(i,k.motion.clip??null);L?(L.speed=k.speed,z.push(L)):console.warn("Couldn't register animation for state "+k.name+" on "+(o==null?void 0:o.name))};if(u.length>0){l=new Array;for(const k of u)p(k,l)}if(f.length>0){c=new Array;for(const k of f)p(k,c)}let g=0;if(o&&h&&o.minMaxOffsetNormalized){const k=o.minMaxOffsetNormalized.x,z=o.minMaxOffsetNormalized.y,L=u.length?u[0]:f.length?f[0]:null;g=(((T=L==null?void 0:L.motion.clip)==null?void 0:T.duration)||1)*(k+Math.random()*(z-k))}return{animationSequence:l,animationLoopAfterSequence:c,randomTimeOffset:g}}createAnimation(e,i,n){if(!this.target||!this.animator&&!this.animation)return;const o=Zn.getAndRegisterAnimationSequences(e,this.target,this.stateName);o&&(this.animationSequence=o.animationSequence,this.animationLoopAfterSequence=o.animationLoopAfterSequence,this.randomOffsetNormalized=o.randomTimeOffset,this.stateAnimationModel=i)}};let Xs=Zn;a(Xs,"animationActions",[]),a(Xs,"rootsWithExclusivePlayback",new Set);ot([m(ii)],Xs.prototype,"animator",void 0);ot([m()],Xs.prototype,"stateName",void 0);class du extends j{constructor(){super(...arguments);a(this,"target")}getType(){}getDuration(){}}ot([m(D)],du.prototype,"target",void 0);class wm extends j{constructor(){super(...arguments);a(this,"target")}}ot([m(du)],wm.prototype,"target",void 0);class Sm extends du{constructor(){super(...arguments);a(this,"type",ud.Hide);a(this,"duration",1)}getType(){switch(this.type){case ud.Hide:return"hide";case ud.Show:return"show"}}getDuration(){return this.duration}}ot([m()],Sm.prototype,"type",void 0);ot([m()],Sm.prototype,"duration",void 0);class $1 extends wm{}var ud;(function(s){s[s.Show=0]="Show",s[s.Hide=1]="Hide"})(ud||(ud={}));const E0=class{constructor(){a(this,"_quicklookButton");a(this,"_arButton");a(this,"_vrButton");a(this,"_sendToQuestButton")}static create(){return new E0}static getOrCreate(){return this._instance||(this._instance=this.create()),this._instance}get isSecureConnection(){return window.location.protocol==="https:"}get quicklookButton(){return this._quicklookButton}get arButton(){return this._arButton}get vrButton(){return this._vrButton}get sendToQuestButton(){return this._sendToQuestButton}get qrButton(){return Hs.getOrCreate().createQRCode()}createQuicklookButton(){if(this._quicklookButton)return this._quicklookButton;const t=document.createElement("button");this._quicklookButton=t,t.dataset.needle="quicklook-button";const e=K.supportsQuickLookAR();t.innerText="View in AR",t.prepend(mi("view_in_ar"));let i=!1,n=null;return t.addEventListener("click",()=>{n=hm(De),n||(i=!0,n=new De),i&&(n.objectToExport=ne.Current.scene),n?(t.classList.add("this-mode-is-requested"),n.exportAndOpen().then(()=>{t.classList.remove("this-mode-is-requested")}).catch(o=>{t.classList.remove("this-mode-is-requested"),console.error(o)})):console.warn("No USDZExporter component found in the scene")}),this.hideElementDuringXRSession(t),t}createARButton(t){var n;if(this._arButton)return this._arButton;const e="immersive-ar",i=document.createElement("button");return this._arButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-ar-button",i.innerText="Enter AR",i.prepend(mi("view_in_ar")),i.title="Click to start an AR session",i.addEventListener("click",()=>te.start(e,t)),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),K.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createVRButton(t){var n;if(this._vrButton)return this._vrButton;const e="immersive-vr",i=document.createElement("button");return this._vrButton=i,i.classList.add("webxr-button"),i.dataset.needle="webxr-vr-button",i.innerText="Enter VR",i.prepend(mi("panorama_photosphere")),i.title="Click to start a VR session",i.addEventListener("click",()=>te.start(e,t)),this.updateSessionSupported(i,e),this.listenToXRSessionState(i,e),this.hideElementDuringXRSession(i),this.isSecureConnection||(i.disabled=!0,i.title="WebXR requires a secure connection (HTTPS)"),K.isMozillaXR()||(n=navigator.xr)==null||n.addEventListener("devicechange",()=>this.updateSessionSupported(i,e)),i}createSendToQuestButton(){var i;if(this._sendToQuestButton)return this._sendToQuestButton;const t="https://oculus.com/open_url/?url=",e=document.createElement("button");return this._sendToQuestButton=e,e.dataset.needle="webxr-sendtoquest-button",e.innerText="Open on Quest",e.prepend(mi("share_windows")),e.title="Click to send this page to the Oculus Browser on your Quest",e.addEventListener("click",()=>{const n=encodeURIComponent(window.location.href),o=t+n;window.open(o)==null&&nt("This page doesn't allow popups. Please paste "+o+" into your browser.")}),this.listenToXRSessionState(e),this.hideElementDuringXRSession(e),K.isMozillaXR()||(i=navigator.xr)==null||i.addEventListener("devicechange",()=>{var n;(n=navigator.xr)!=null&&n.isSessionSupported("immersive-vr")?e.style.display="none":e.style.display=""}),e}createQRCode(){return Hs.getOrCreate().createQRCode()}updateSessionSupported(t,e){if(!("xr"in navigator)){t.style.display="none";return}te.isSessionSupported(e).then(i=>{t.style.display=i?"":"none",U()&&!i&&console.log('[WebXR] "'+e+'" is not supported on this device â€“ make sure your server runs using HTTPS and you have a device connected that supports '+e)})}hideElementDuringXRSession(t){ub(e=>{t["previous-display"]=t.style.display,t.style.display="none"}),PS(e=>{t["previous-display"]!=null&&(t.style.display=t["previous-display"])})}listenToXRSessionState(t,e){e&&(te.onSessionRequestStart(i=>{i.mode===e?t.classList.add("this-mode-is-requested"):(t["was-disabled"]=t.disabled,t.disabled=!0,t.classList.add("other-mode-is-requested"))}),te.onSessionRequestEnd(i=>{t.classList.remove("this-mode-is-requested"),t.classList.remove("other-mode-is-requested"),t.disabled=t["was-disabled"]}))}};let $r=E0;a($r,"_instance");var zt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const fd=S("debugspriterenderer"),pI=S("wireframe"),Dp=class{static getOrCreateGeometry(t){if(t.__cached_geometry)return t.__cached_geometry;if(t.guid&&Dp.cache[t.guid])return fd&&console.log("Take cached geometry for sprite",t.guid),Dp.cache[t.guid];const e=new os;t.__cached_geometry=e;const i=new Float32Array(t.triangles.length*3),n=new Float32Array(t.triangles.length*2);for(let o=0;o<t.triangles.length;o+=1){const r=t.triangles[o];i[o*3]=-t.vertices[r].x,i[o*3+1]=t.vertices[r].y,i[o*3+2]=0;const l=t.uv[r];n[o*2]=l.x,n[o*2+1]=1-l.y}return e.setAttribute("position",new Hi(i,3)),e.setAttribute("uv",new Hi(n,2)),t.guid&&(this.cache[t.guid]=e),fd&&console.log("Built sprite geometry",t,e),e}};let Ya=Dp;a(Ya,"cache",{});var yp;(function(s){s[s.Simple=0]="Simple",s[s.Sliced=1]="Sliced",s[s.Tiled=2]="Tiled"})(yp||(yp={}));class mI{constructor(){a(this,"x");a(this,"y")}}function W1(s){s&&(s.colorSpace!=Qo&&(s.colorSpace=Qo,s.needsUpdate=!0),s.minFilter==zf&&s.magFilter==zf&&(s.anisotropy=1,s.needsUpdate=!0))}let ea=class{constructor(t){a(this,"guid");a(this,"texture");a(this,"triangles");a(this,"uv");a(this,"vertices");a(this,"__cached_geometry");a(this,"_mesh");a(this,"_material");t&&(this.texture=t,this.triangles=[0,1,2,0,2,3],this.uv=[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}],this.vertices=[{x:-.5,y:-.5},{x:.5,y:-.5},{x:.5,y:.5},{x:-.5,y:.5}])}get mesh(){return this._mesh||(this._mesh=new X(Ya.getOrCreateGeometry(this),this.material)),this._mesh}get material(){return this._material||(this.texture&&W1(this.texture),this._material=new Be({map:this.texture,color:16777215,side:vn,transparent:!0})),this._material}getGeometry(){return Ya.getOrCreateGeometry(this)}};zt([m()],ea.prototype,"guid",void 0);zt([m(Ke)],ea.prototype,"texture",void 0);zt([Rt()],ea.prototype,"triangles",void 0);zt([Rt()],ea.prototype,"uv",void 0);zt([Rt()],ea.prototype,"vertices",void 0);const oy=Symbol("spriteOwner");class Qd{constructor(){a(this,"sprites");this.sprites=[]}}zt([m(ea)],Qd.prototype,"sprites",void 0);class Zs{constructor(){a(this,"spriteSheet");a(this,"index",0)}static create(){const t=new Zs;return t.spriteSheet=new Qd,t}clone(){const t=new Zs;return t.index=this.index,t.spriteSheet=this.spriteSheet,t}set sprite(t){t&&(this.spriteSheet?((this.index===null||this.index===void 0)&&(this.index=0),this.spriteSheet.sprites[this.index]=t):(this.spriteSheet=new Qd,this.spriteSheet.sprites=[t],this.index=0))}get sprite(){if(this.spriteSheet)return this.spriteSheet.sprites[this.index]}update(t){if(!this.spriteSheet)return;const e=this.index;if(e<0||e>=this.spriteSheet.sprites.length)return;const i=this.spriteSheet.sprites[e],n=i==null?void 0:i.texture;if(n&&(W1(n),!i.__hasLoadedProgressive)){i.__hasLoadedProgressive=!0;const o=n;pt.assignTextureLOD(n,0).then(r=>{r instanceof Ke&&(i.texture=r,(t==null?void 0:t.map)===o&&(t.map=r,t.needsUpdate=!0))})}}}zt([m(Qd)],Zs.prototype,"spriteSheet",void 0);zt([m()],Zs.prototype,"index",void 0);class Sn extends j{constructor(){super(...arguments);a(this,"drawMode",yp.Simple);a(this,"size",{x:1,y:1});a(this,"color");a(this,"sharedMaterial");a(this,"transparent",!0);a(this,"cutoutThreshold",0);a(this,"castShadows",!1);a(this,"renderOrder",0);a(this,"toneMapped",!0);a(this,"_spriteSheet");a(this,"_currentSprite")}set texture(e){var n;if(!this._spriteSheet)return;const i=(n=this._spriteSheet.spriteSheet)==null?void 0:n.sprites[this.spriteIndex];i&&(i.texture=e,this.updateSprite())}addSprite(e,i=!1){var o,r;if(this._spriteSheet||(this._spriteSheet=Zs.create()),!this._spriteSheet.spriteSheet)return-1;(o=this._spriteSheet.spriteSheet)==null||o.sprites.push(e);const n=((r=this._spriteSheet.spriteSheet)==null?void 0:r.sprites.length)-1;return i&&(this.spriteIndex=n),n}get sprite(){return this._spriteSheet}set sprite(e){if(e!==this._spriteSheet)if(typeof e=="number"){const i=Math.round(e);fd&&console.log("[SpriteSheet] Set index to "+i+" (was "+this.spriteIndex+")",e),this.spriteIndex=i}else e instanceof ea?(this._spriteSheet||(this._spriteSheet=Zs.create()),this._spriteSheet.sprite!=e&&(this._spriteSheet.sprite=e),this.updateSprite()):e!=this._spriteSheet&&(this._spriteSheet=e,this.updateSprite())}set spriteIndex(e){this._spriteSheet&&(this._spriteSheet.index=e,this.updateSprite())}get spriteIndex(){var e;return((e=this._spriteSheet)==null?void 0:e.index)??0}get spriteFrames(){var e,i;return((i=(e=this._spriteSheet)==null?void 0:e.spriteSheet)==null?void 0:i.sprites.length)??0}awake(){this._currentSprite=void 0,this._spriteSheet?this._spriteSheet=this._spriteSheet.clone():this._spriteSheet=Zs.create(),fd&&console.log("Awake",this.name,this,this.sprite)}start(){this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(e=!1){var o;if(!this.__didAwake&&!e)return!1;const i=this._spriteSheet;if(!((o=i==null?void 0:i.spriteSheet)!=null&&o.sprites))return console.warn("SpriteRenderer has no data or spritesheet assigned..."),!1;const n=i.spriteSheet.sprites[this.spriteIndex];if(!n)return fd&&console.warn("Sprite not found",this.spriteIndex,i.spriteSheet.sprites),!1;if(this._currentSprite)this._currentSprite.geometry=Ya.getOrCreateGeometry(n),this._currentSprite.material.map=n.texture;else{const r=new Be({color:16777215,side:vn});if(pI&&(r.wireframe=!0),this.color&&(r.color||(r.color=new de),r.color.copy(this.color),r.opacity=this.color.alpha),r.transparent=!0,r.toneMapped=this.toneMapped,r.depthWrite=!1,n.texture&&!r.wireframe){let l=n.texture;l[oy]!==void 0&&l[oy]!==this&&this.spriteFrames>1&&(l=n.texture=l.clone()),l[oy]=this,r.map=l}this.sharedMaterial=r,this._currentSprite=new X(Ya.getOrCreateGeometry(n),r),this._currentSprite.renderOrder=Math.round(this.renderOrder),pt.assignTextureLOD(r,0)}return this._currentSprite.parent!==this.gameObject&&(this.drawMode===yp.Tiled&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite)),this._currentSprite&&this._currentSprite.layers.set(this.layer),this.sharedMaterial&&(this.sharedMaterial.alphaTest=this.cutoutThreshold,this.sharedMaterial.transparent=this.transparent),this._currentSprite.castShadow=this.castShadows,i==null||i.update(this.sharedMaterial),!0}}zt([m()],Sn.prototype,"drawMode",void 0);zt([m(mI)],Sn.prototype,"size",void 0);zt([m(pe)],Sn.prototype,"color",void 0);zt([m(Ie)],Sn.prototype,"sharedMaterial",void 0);zt([m()],Sn.prototype,"transparent",void 0);zt([m()],Sn.prototype,"cutoutThreshold",void 0);zt([m()],Sn.prototype,"castShadows",void 0);zt([m()],Sn.prototype,"renderOrder",void 0);zt([m()],Sn.prototype,"toneMapped",void 0);zt([m(Zs)],Sn.prototype,"sprite",null);const Zx=S("debugwebxr"),gI=new ce().makeRotationY(Math.PI),nc=class extends j{constructor(){super(...arguments);a(this,"_arScale",1);a(this,"invertForward",!1);a(this,"customReticle");a(this,"arTouchTransform",!0);a(this,"autoPlace",!1);a(this,"autoCenter",!1);a(this,"useXRAnchor",!1);a(this,"_isPlacing",!0);a(this,"_startOffset",new ce);a(this,"_createdPlacementObject",null);a(this,"_reparentedComponents",[]);a(this,"_placementScene",new bn);a(this,"_reticle",[]);a(this,"_hits",[]);a(this,"_placementStartTime",-1);a(this,"_rigPlacementMatrix");a(this,"_anchor",null);a(this,"userInput");a(this,"onPlaceScene",e=>{var o;if(this._isPlacing==!1||e!=null&&e.used)return;let i=this._reticle[0];if(!i){console.warn("No reticle to place...");return}if(!i.visible&&!this.autoPlace){console.warn("Reticle is not visible (can not place)");return}if((o=te.active)!=null&&o.isTrackingImages){console.warn("Scene Placement is disabled while images are being tracked");return}let n=this._hits[0];if(e&&e.origin instanceof TS){const r=this._reticle[e.origin.index];r&&(i=r,n=this._hits[e.origin.index])}if(e&&(e.stopImmediatePropagation(),e.stopPropagation(),e.use()),this._isPlacing=!1,this.context.input.removeEventListener("pointerup",this.onPlaceScene),this.onRevertSceneChanges(),i.position.copy(i.lastPos),i.quaternion.copy(i.lastQuat),this.onApplyPose(i),nc._hasPlaced=!0,this.useXRAnchor&&this.onCreateAnchor(te.active,n),this.context.xr)for(const r of this.context.xr.controllers)r.cancelHitTestSource()});a(this,"upVec",new x(0,1,0));a(this,"lookPoint",new x);a(this,"worldUpVec",new x(0,1,0))}static onPlaced(e){const i="placed";return this._eventListeners[i]||(this._eventListeners[i]=[]),this._eventListeners[i].push(e),()=>{const n=this._eventListeners[i].indexOf(e);n>=0&&this._eventListeners[i].splice(n,1)}}static get hasPlaced(){return this._hasPlaced}get arScale(){return this._arScale}set arScale(e){this._arScale=Math.max(1e-6,e),this.onSetScale()}onEnable(){var e;(e=this.customReticle)==null||e.preload()}supportsXR(e){return e==="immersive-ar"}onEnterXR(e){Zx&&console.log("ENTER WEBXR: SessionRoot start..."),this._anchor=null,nc._hasPlaced=!1,this.gameObject.updateMatrixWorld(),this._startOffset.copy(this.gameObject.matrixWorld);const i=new D;this._createdPlacementObject=i,i.name="AR Session Root",this._placementScene.name="AR Placement Scene",this._placementScene.children.length=0;for(let n=this.context.scene.children.length-1;n>=0;n--){const o=this.context.scene.children[n];this._placementScene.add(o)}if(this.context.scene.add(i),this.autoCenter){const n=Qi(this._placementScene.children),o=n.getCenter(new x),r=n.getSize(new x),l=new ce;l.makeTranslation(o.x,o.y-r.y*.5,o.z),this._startOffset.multiply(l)}this._reparentedComponents.length=0,this._reparentedComponents.push({comp:this,originalObject:this.gameObject}),C.addComponent(i,this);for(const n of this._reticle)Wn(n);this._reticle.length=0,this._isPlacing=!0,this.context.input.addEventListener("pointerup",this.onPlaceScene,{queue:qi.Early})}onLeaveXR(){this.context.input.removeEventListener("pointerup",this.onPlaceScene,{queue:qi.Early}),this.onRevertSceneChanges(),this._anchor=null,nc._hasPlaced=!1,this._rigPlacementMatrix=void 0}onUpdateXR(e){var i,n,o,r;if(e.xr.isTrackingImages){for(const l of this._reticle)l.visible=!1;return}if(this._isPlacing){const l=(i=e.xr.rig)==null?void 0:i.gameObject;l&&l.parent!==this.context.scene&&this.context.scene.add(l);let c=!1;if(e.xr.isPassThrough&&e.xr.controllers.length>0&&!this.autoPlace)for(const h of e.xr.controllers){const d=h.getHitTest();d&&(c=!0,this.updateReticleAndHits(e.xr,h.index,d,e.xr.rigScale))}if(!c){const h=e.xr.getHitTest();h&&this.updateReticleAndHits(e.xr,0,h,e.xr.rigScale)}}else{if(this._anchor&&e.xr.referenceSpace){const l=e.xr.frame.getPose(this._anchor.anchorSpace,e.xr.referenceSpace);if(l&&this.context.time.frame%20===0){const c=e.xr.convertSpace(l.transform),h=this._reticle[0];h&&(h.position.copy(c.position),h.quaternion.copy(c.quaternion),this.onApplyPose(h))}}if(this.arTouchTransform?(this.userInput||(this.userInput=new zl(this.context)),(n=this.userInput)==null||n.enable()):(o=this.userInput)==null||o.disable(),this.arTouchTransform&&((r=this.userInput)!=null&&r.hasChanged)){if(e.xr.rig){const l=e.xr.rig.gameObject;this.userInput.applyMatrixTo(l.matrix,!0),l.matrix.decompose(l.position,l.quaternion,l.scale),this.userInput.factor=l.scale.x}this.userInput.reset()}}}updateReticleAndHits(e,i,n,o){this._hits[i]=n.hit;let r=this._reticle[i];if(!r){if(this.customReticle)if(this.customReticle.asset)r=Mc(this.customReticle.asset);else{this.customReticle.loadAssetAsync();return}else r=new X(new IR(.07,.09,32).rotateX(-Math.PI/2),new Be({side:vn,depthTest:!1,depthWrite:!1,transparent:!0,opacity:1,color:15658734})),r.name="AR Placement Reticle";if(Zx){const l=new yn(1);l.position.y+=.01,r.add(l)}this._reticle[i]=r,r.matrixAutoUpdate=!1,r.visible=!1}if(r.lastPos=r.lastPos||n.position.clone(),r.lastQuat=r.lastQuat||n.quaternion.clone(),r.position.copy(r.lastPos.lerp(n.position,this.context.time.deltaTime/.1)),r.lastPos.copy(r.position),r.quaternion.copy(r.lastQuat.slerp(n.quaternion,this.context.time.deltaTime/.05)),r.lastQuat.copy(r.quaternion),r.scale.set(o,o,o),this.customReticle&&this.applyViewBasedTransform(r),r.updateMatrix(),r.visible=!0,r.parent!==this.context.scene&&this.context.scene.add(r),this._placementStartTime<0&&(this._placementStartTime=this.context.time.realtimeSinceStartup),this.autoPlace)if(this.upVec.set(0,1,0).applyQuaternion(r.quaternion),this.upVec.dot(q(0,1,0))>.9){let c=r["autoplace:timer"]||0;c>=1?(r.visible=!1,this.onPlaceScene(null)):(c+=this.context.time.deltaTime,r["autoplace:timer"]=c)}else r["autoplace:timer"]=0}onSetScale(){var i,n,o;if(!nc._hasPlaced)return;const e=(n=(i=te.active)==null?void 0:i.rig)==null?void 0:n.gameObject;if(e){const r=((o=te.active)==null?void 0:o.rigScale)||1,l=1/this._arScale*r,c=new ce().makeScale(l,l,l).invert();e.matrix.premultiply(c),e.matrix.decompose(e.position,e.quaternion,e.scale)}}onRevertSceneChanges(){var e;for(const i of this._reticle)i&&(i.visible=!1,i==null||i.removeFromParent());this._reticle.length=0;for(let i=this._placementScene.children.length-1;i>=0;i--){const n=this._placementScene.children[i];this.context.scene.add(n)}(e=this._createdPlacementObject)==null||e.removeFromParent();for(const i of this._reparentedComponents)C.addComponent(i.originalObject,i.comp)}async onCreateAnchor(e,i){if(i.createAnchor===void 0){console.warn("Hit does not support creating an anchor",i),U()&&ke("Hit does not support creating an anchor");return}else{const n=await i.createAnchor(e.viewerPose.transform);e.running&&n&&(this._anchor=n)}}applyViewBasedTransform(e){const i=this.context.mainCamera,n=e,o=i.worldPosition,r=n.worldPosition;this.upVec.set(0,1,0).applyQuaternion(e.quaternion);const l=i.worldPosition;l&&e.position.clone().sub(l).angleTo(this.upVec)<Math.PI/2&&this.upVec.negate();const c=this.upVec.angleTo(this.worldUpVec)*180/Math.PI,h=30;c>h&&c<180-h||c<-h&&c>-180+h?(this.lookPoint.copy(e.position).add(this.upVec),this.lookPoint.y=e.position.y,e.lookAt(this.lookPoint)):(o.y=r.y,e.lookAt(o))}onApplyPose(e){var o,r,l;const i=(r=(o=te.active)==null?void 0:o.rig)==null?void 0:r.gameObject;if(!i){console.warn("No rig object to place");return}const n=i.parent||this.context.scene;this._rigPlacementMatrix?(l=this._rigPlacementMatrix)==null||l.decompose(i.position,i.quaternion,i.scale):this._rigPlacementMatrix=i.matrix.clone(),this.applyViewBasedTransform(e),e.updateMatrix(),this.context.scene.add(e),e.attach(i),e.removeFromParent(),i.scale.set(this.arScale,this.arScale,this.arScale),i.position.multiplyScalar(this.arScale),i.updateMatrix(),this.invertForward&&i.matrix.premultiply(gI),i.matrix.premultiply(this._startOffset),i.matrix.decompose(i.position,i.quaternion,i.scale),n.add(i)}};let ss=nc;a(ss,"_eventListeners",{}),a(ss,"_hasPlaced",!1);const Lp=class{constructor(t){a(this,"oneFingerDrag",!0);a(this,"twoFingerRotate",!0);a(this,"twoFingerScale",!0);a(this,"factor",1);a(this,"context");a(this,"offset");a(this,"plane");a(this,"_scale",1);a(this,"_hasChanged",!1);a(this,"_enabled",!1);a(this,"currentlyUsedPointerIds",new Set);a(this,"currentlyUnusedPointerIds",new Set);a(this,"onPointerDownEarly",t=>{this.isActive&&t.stopPropagation()});a(this,"onPointerDownLate",t=>{t.used?this.currentlyUsedPointerIds.add(t.pointerId):this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.add(t.pointerId)});a(this,"onPointerUpEarly",t=>{this.currentlyUsedPointerIds.delete(t.pointerId),this.currentlyUnusedPointerIds.delete(t.pointerId)});a(this,"prev",new Map);a(this,"_didMultitouch",!1);a(this,"touchStart",t=>{if(!t.defaultPrevented)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],n=K.isAndroidDevice()&&i.clientY<window.innerHeight*.1;this.prev.has(i.identifier)||this.prev.set(i.identifier,{ignore:n,x:0,z:0,screenx:0,screeny:0});const o=this.prev.get(i.identifier);if(o){const r=this.getPositionOnPlane(i.clientX,i.clientY);o.x=r.x,o.z=r.z,o.screenx=i.clientX,o.screeny=i.clientY}}});a(this,"touchEnd",t=>{t.touches.length<=0&&(this._didMultitouch=!1);for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e];this.prev.delete(i.identifier)}});a(this,"touchMove",t=>{if(!t.defaultPrevented&&this.isActive){if(t.touches.length===1){if(this._didMultitouch)return;const e=t.touches[0],i=this.prev.get(e.identifier);if(!i||i.ignore)return;const n=this.getPositionOnPlane(e.clientX,e.clientY),o=n.x-i.x,r=n.z-i.z;if(o===0&&r===0)return;this.oneFingerDrag&&this.addMovement(o,r),i.x=n.x,i.z=n.z,i.screenx=e.clientX,i.screeny=e.clientY;return}else if(t.touches.length===2){this._didMultitouch=!0;const e=t.touches[0],i=t.touches[1],n=this.prev.get(e.identifier),o=this.prev.get(i.identifier);if(!n||!o)return;if(this.twoFingerRotate){const r=Math.atan2(e.clientY-i.clientY,e.clientX-i.clientX),l=Math.atan2(n.screeny-o.screeny,n.screenx-o.screenx),c=r-l;Math.abs(c)>.001&&this.addRotation(c)}if(this.twoFingerScale){const r=e.clientX-i.clientX,l=e.clientY-i.clientY,c=Math.sqrt(r*r+l*l),h=n.screenx-o.screenx,d=n.screeny-o.screeny,u=Math.sqrt(h*h+d*d),f=c-u;Math.abs(f)>2&&this.addScale(f)}n.screenx=e.clientX,n.screeny=e.clientY,o.screenx=i.clientX,o.screeny=i.clientY}}});a(this,"_raycaster",new Vp);a(this,"_intersection",new x);a(this,"_screenPos",new x);a(this,"_tempMatrix",new ce);this.context=t,this.offset=new ce,this.plane=new Za,this.plane.setFromNormalAndCoplanarPoint(Lp.up,Lp.zero)}get scale(){return this._scale}reset(){this._scale=1,this.offset.identity(),this._hasChanged=!0}get hasChanged(){return this._hasChanged}applyMatrixTo(t,e){this._hasChanged=!1,e?(this.offset.invert(),t.premultiply(this.offset)):t.multiply(this.offset)}get isActive(){return this.currentlyUsedPointerIds.size<=0&&this.currentlyUnusedPointerIds.size>0}enable(){this._enabled||(this._enabled=!0,this.context.input.addEventListener("pointerdown",this.onPointerDownEarly,{queue:qi.Early}),this.context.input.addEventListener("pointerdown",this.onPointerDownLate,{queue:qi.Late}),this.context.input.addEventListener("pointerup",this.onPointerUpEarly,{queue:qi.Early}),window.addEventListener("touchstart",this.touchStart,{passive:!1}),window.addEventListener("touchmove",this.touchMove,{passive:!1}),window.addEventListener("touchend",this.touchEnd,{passive:!1}))}disable(){this._enabled&&(this._enabled=!1,this.context.input.removeEventListener("pointerdown",this.onPointerDownEarly,{queue:qi.Early}),this.context.input.removeEventListener("pointerdown",this.onPointerDownLate,{queue:qi.Late}),this.context.input.removeEventListener("pointerup",this.onPointerUpEarly,{queue:qi.Early}),window.removeEventListener("touchstart",this.touchStart),window.removeEventListener("touchmove",this.touchMove),window.removeEventListener("touchend",this.touchEnd))}getPositionOnPlane(t,e){const i=this.context.mainCamera;return this._screenPos.x=t/window.innerWidth*2-1,this._screenPos.y=-(e/window.innerHeight)*2+1,this._screenPos.z=1,this._screenPos.unproject(i),this._raycaster.set(i.position,this._screenPos.sub(i.position)),this._raycaster.ray.intersectPlane(this.plane,this._intersection),this._intersection}addMovement(t,e){t/=this._scale,e/=this._scale,t*=this.factor,e*=this.factor,this.offset.elements[12]+=t,this.offset.elements[14]+=e,(t!==0||e!==0)&&(this._hasChanged=!0)}addScale(t){t/=window.innerWidth,t*=-1,this._scale*=1+t,this._tempMatrix.makeScale(1-t,1-t,1-t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}addRotation(t){t*=-1,this._tempMatrix.makeRotationY(t),this.offset.premultiply(this._tempMatrix),t!==0&&(this._hasChanged=!0)}};let zl=Lp;a(zl,"up",new x(0,1,0)),a(zl,"zero",new x(0,0,0)),a(zl,"one",new x(1,1,1));const Rr=S("debugautosync"),ry=Symbol("syncerId");class yI{constructor(){a(this,"_syncers",{})}getOrCreateSyncer(t){if(!t.guid)return null;if(this._syncers[t.guid])return this._syncers[t.guid];const e=new _I(t);return e[ry]=t.guid,this._syncers[e[ry]]=e,e}removeSyncer(t){delete this._syncers[t[ry]]}}const Gb=new yI;class _I{constructor(t){a(this,"comp");a(this,"hasChanges",!1);a(this,"changedProperties",{});a(this,"_isReceiving",!1);a(this,"_isInit",!1);a(this,"onHandleSending",()=>{if(!this.hasChanges)return;this.hasChanges=!1;const t=this.comp.context.connection;if(!t||!t.isConnected||!t.isInRoom){for(const e in this.changedProperties)delete this.changedProperties[e];return}for(const e in this.changedProperties){const i=this.changedProperties[e];Rr&&console.log("SEND",this.comp.guid,this.networkingKey),t.send(this.networkingKey,{guid:this.comp.guid,property:e,data:i},es.Queued),delete this.changedProperties[e]}});a(this,"onHandleReceiving",t=>{if(Rr&&console.log("SYNCFIELD RECEIVE",this.comp.name,this.comp.guid,t),!!this._isInit&&this.comp&&t.guid===this.comp.guid)try{this._isReceiving=!0,this.comp[t.property]=t.data}catch(e){console.error(e)}finally{this._isReceiving=!1}});this.comp=t}get networkingKey(){return this.comp.guid}init(t){if(this._isInit)return;this._isInit=!0,this.comp=t,this.comp.context.post_render_callbacks.push(this.onHandleSending),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving);const e=this.comp.context.connection.tryGetState(this.comp.guid);e&&this.onHandleReceiving(e)}destroy(){this._isInit&&(this.comp.context.post_render_callbacks.splice(this.comp.context.post_render_callbacks.indexOf(this.onHandleSending),1),this.comp.context.connection.stopListen(this.networkingKey,this.onHandleReceiving),this.comp=null,this._isInit=!1)}notifyChanged(t,e){this._isReceiving||(Rr&&console.log("Property changed: "+t,e),this.hasChanges=!0,this.changedProperties[t]=e)}}function bI(s,t){let e=t!==s;return!e&&s&&t&&(Array.isArray(s)&&Array.isArray(t)||typeof s=="object"&&typeof t=="object")&&(e=!0),e}const pd=Symbol("AutoSyncHandler");function vI(s){if(s[pd])return s[pd];const t=Gb.getOrCreateSyncer(s);return t==null||t.init(s),s[pd]=t,t}function xI(s){const t=s[pd];t&&(Gb.removeSyncer(t),t.destroy(),delete s[pd])}const V1=function(s=null){return function(t,e){var d;let i="";typeof e=="string"?i=e:i=e.name;let n=null,o;typeof s=="string"?o=t[s]:typeof s=="function"&&(o=s),o==null&&(U()||Rr)&&s!=null&&console.warn('syncField: no callback function found for property "'+i+'"','"'+s+'"');const r=t,l=r.__internalAwake;if(typeof l!="function"){(Rr||U())&&console.error('@syncField can currently only used on Needle Engine Components, custom object of type "'+((d=t==null?void 0:t.constructor)==null?void 0:d.name)+'" is not supported',t);return}Rr&&console.log(i);const c=Symbol(i);r.__internalAwake=function(){if(this[c]!==void 0)return;this[c]=this[i],n=Gb.getOrCreateSyncer(this);const u=Object.getOwnPropertyDescriptor(this,i);if((u==null?void 0:u.set)===void 0){let f=!1;Object.defineProperty(this,i,{set:function(p){var _;const g=this[c];if(this[c]=p,f){(U()||Rr)&&console.warn("Recursive call detected",i);return}f=!0;try{const y=bI(p,g);Rr&&console.log("SyncField assignment",i,"changed?",y,p,o),y&&(o==null?void 0:o.call(this,p,g))!==!1&&((_=vI(this))==null||_.notifyChanged(i,p))}finally{f=!1}},get:function(){return this[c]},configurable:!0,enumerable:!0})}n==null||n.init(this),l.call(this)};const h=r.__internalDestroy;r.__internalDestroy=function(){xI(this),h.call(this)}}};var Cm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ki=S("debugplayersync");class gl extends j{constructor(){super(...arguments);a(this,"autoSync",!0);a(this,"asset");a(this,"onPlayerSpawned");a(this,"_localInstance");a(this,"onJoinedRoom",()=>{ki&&console.log("PlayerSync.joinedRoom. autoSync is set to "+this.autoSync),this.autoSync&&this.getInstance()});a(this,"destroyInstance",()=>{var e;(e=this._localInstance)==null||e.then(i=>{ki&&console.log("PlayerSync.destroyInstance",i),rm(i,this.context.connection,!0,{saveInRoom:!1})}),this._localInstance=void 0})}static async setupFrom(e,i){const n=he.getOrCreateFromUrl(e);if(!n.asset){const l=await n.loadAssetAsync();l&&C.getOrAddComponent(l,Kt)}const o=new gl;o._internalInit(i),o.asset=n;const r=new D;return r.guid=e,C.addComponent(r,o),o}awake(){this.watchTabVisible(),this.onPlayerSpawned||(this.onPlayerSpawned=new we)}onEnable(){this.context.connection.beginListen(se.RoomStateSent,this.onJoinedRoom),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.beginListen(se.LeftRoom,this.destroyInstance),this.context.connection.isInRoom&&this.onJoinedRoom()}onDisable(){this.context.connection.stopListen(se.RoomStateSent,this.onJoinedRoom),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),this.context.connection.stopListen(se.LeftRoom,this.destroyInstance)}async getInstance(){var i,n,o,r,l,c;if(this._localInstance)return this._localInstance;if(ki&&console.log("PlayerSync.createInstance",(i=this.asset)==null?void 0:i.url),!((n=this.asset)!=null&&n.asset)&&!((o=this.asset)!=null&&o.url))return console.error('PlayerSync: can not create an instance because "asset" is not set and or has no URL!'),null;this.gameObject.guid||console.warn("PlayerSync: gameObject has no guid! This might cause issues with syncing the player state."),this._localInstance=(r=this.asset)==null?void 0:r.instantiateSynced({parent:this.gameObject,deleteOnDisconnect:!0},!0);const e=await this._localInstance;if(e){const h=C.getComponentsInChildren(e,Kt);if(ki&&console.log(`PlayerSync.createInstance: found ${h==null?void 0:h.length} PlayerState components. Owner: ${this.context.connection.connectionId}`),h!=null&&h.length){for(const d of h)d.owner=this.context.connection.connectionId;(l=this.onPlayerSpawned)==null||l.invoke(e)}else this._localInstance=void 0,console.error("<strong>Failed finding PlayerState on "+((c=this.asset)==null?void 0:c.url)+"</strong>: please make sure the asset has a PlayerState component!"),C.destroySynced(e)}else this._localInstance=void 0,console.warn("PlayerSync: failed instantiating asset!");return this._localInstance}watchTabVisible(){window.addEventListener("visibilitychange",e=>{if(document.visibilityState==="visible")for(let i=Kt.all.length-1;i>=0;i--){const n=Kt.all[i];(!n.owner||!this.context.connection.userIsInRoom(n.owner))&&n.doDestroy()}})}}Cm([m()],gl.prototype,"autoSync",void 0);Cm([m(he)],gl.prototype,"asset",void 0);Cm([m(we)],gl.prototype,"onPlayerSpawned",void 0);var O_;(function(s){s.OwnerChanged="ownerChanged"})(O_||(O_={}));const Et=class extends j{constructor(){super(...arguments);a(this,"onOwnerChangeEvent",new we);a(this,"onFirstOwnerChangeEvent",new we);a(this,"hasOwner",!1);a(this,"owner");a(this,"dontDestroy",!1);a(this,"onUserLeftRoom",e=>{if(e.userId===this.owner){ki&&console.log("PLAYERSYNC LEFT",this.owner),this.doDestroy();return}})}static get all(){return Et._all}static get local(){return Et._local}static getFor(e){if(e instanceof D)return C.getComponentInParent(e,Et);if(e instanceof j)return C.getComponentInParent(e.gameObject,Et)}static isLocalPlayer(e){const i=Et.getFor(e);return(i==null?void 0:i.isLocalPlayer)??!1}static addEventListener(e,i){return this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(i),i}static removeEventListener(e,i){if(!this._callbacks[e])return;const n=this._callbacks[e].indexOf(i);n>=0&&this._callbacks[e].splice(n,1)}static dispatchEvent(e,i){if(this._callbacks[e])for(const n of this._callbacks[e])n(i)}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}onOwnerChange(e,i){var l,c;ki&&console.log(`PlayerSync.onOwnerChange: ${i} â†’ ${e} (me: ${this.context.connection.connectionId})`);const n=Et._local.indexOf(this);n>=0&&Et._local.splice(n,1);const o={playerState:this,oldValue:i,newValue:e};if(this.hasOwner||(this.hasOwner=!0,(l=this.onFirstOwnerChangeEvent)==null||l.invoke(o)),(c=this.onOwnerChangeEvent)==null||c.invoke(o),this.owner===this.context.connection.connectionId){Et._local.push(this);const h=new CustomEvent("local-owner-changed",{detail:o});this.dispatchEvent(h)}const r=new CustomEvent("owner-changed",{detail:o});this.dispatchEvent(r),Et.dispatchEvent(O_.OwnerChanged,r)}awake(){Et.all.push(this),ki&&console.log("Registered new PlayerState",this.guid,Et.all.length-1,Et.all),this.context.connection.beginListen(se.UserLeftRoom,this.onUserLeftRoom)}async start(){ki&&console.log("PLAYERSTATE.START, owner: "+this.owner,this.context.connection.usersInRoom([])),this.owner?(this.context.connection.isInRoom||await Ko(300),this.context.connection.userIsInRoom(this.owner)==!1&&(ki&&console.log(`PlayerSync.start â†’ doDestroy "${this.name}" because user "${this.owner}" is not in room anymore...`,"Currently in room:",...this.context.connection.usersInRoom()),this.doDestroy())):this.owner||(ki&&console.warn("PlayerState.start â†’ owner is undefined!",this.name),setTimeout(()=>{!this.destroyed&&!this.owner?this.dontDestroy?ki&&console.warn("PlayerState.start â†’ owner is still undefined but dontDestroy is set to true",this.name):(ki&&console.warn(`PlayerState.start â†’ owner is still undefined: destroying "${this.name}" instance now`),this.doDestroy()):ki&&console.log("PlayerState.start â†’ owner is assigned",this.owner)},2e3))}doDestroy(){ki&&console.log("PlayerSync.doDestroy â†’ syncDestroy",this.name),rm(this.gameObject,this.context.connection,!0,{saveInRoom:!1})}onDestroy(){if(ki&&console.warn("PlayerState.onDestroy",this.owner),this.context.connection.stopListen(se.UserLeftRoom,this.onUserLeftRoom),Et.all.splice(Et.all.indexOf(this),1),this.isLocalPlayer){const e=Et._local.indexOf(this);e>=0&&Et._local.splice(e,1)}}};let Kt=Et;a(Kt,"_all",[]),a(Kt,"_local",[]),a(Kt,"_callbacks",{});Cm([V1(Kt.prototype.onOwnerChange)],Kt.prototype,"owner",void 0);var Hc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class or extends j{constructor(){super(...arguments);a(this,"position","bottom");a(this,"showNeedleLogo",!1);a(this,"showSpatialMenu");a(this,"createFullscreenButton");a(this,"createMuteButton");a(this,"createQRCodeButton")}onEnable(){this.applyOptions()}applyOptions(){this.context.menu.setPosition(this.position),this.context.menu.showNeedleLogo(this.showNeedleLogo),this.createFullscreenButton===!0&&this.context.menu.showFullscreenOption(!0),this.createMuteButton===!0&&this.context.menu.showAudioPlaybackOption(!0),this.showSpatialMenu===!0&&this.context.menu.showSpatialMenu(this.showSpatialMenu),this.createQRCodeButton===!0&&(K.isMobileDevice()||this.context.menu.showQRCodeButton(!0))}}Hc([m()],or.prototype,"position",void 0);Hc([m()],or.prototype,"showNeedleLogo",void 0);Hc([m()],or.prototype,"showSpatialMenu",void 0);Hc([m()],or.prototype,"createFullscreenButton",void 0);Hc([m()],or.prototype,"createMuteButton",void 0);Hc([m()],or.prototype,"createQRCodeButton",void 0);var qb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Rh=S("debugwebxr"),ew=new H().setFromAxisAngle(new x(0,1,0),Math.PI);class il extends j{constructor(){super(...arguments);a(this,"head");a(this,"leftHand");a(this,"rightHand");a(this,"_leftHandMeshes");a(this,"_rightHandMeshes");a(this,"_syncTransforms")}async onEnterXR(e){if(!this.activeAndEnabled)return;Rh&&console.warn("AVATAR ENTER XR",this.guid,this.sourceId,this,this.activeAndEnabled),this._syncTransforms&&(this._syncTransforms.length=0),await this.prepareAvatar();const i=Kt.getFor(this);if(i!=null&&i.owner){const n=this.gameObject.addComponent(Lt);n.avatar=this.gameObject,n.connectionId=i.owner}else this.context.connection.isConnected?console.error("No player state found for avatar",this):i&&!this.context.connection.isConnected&&(i.dontDestroy=!0)}onLeaveXR(e){const i=this.gameObject.getComponent(Lt);i&&i.destroy()}onUpdateXR(e){var h,d;if(!this.activeAndEnabled)return;const i=Kt.isLocalPlayer(this);if(!i)return;const n=e.xr;if(n.rig&&n.rig.gameObject!==this.gameObject.parent&&(this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),this.gameObject.scale.set(1,1,1),n.rig.gameObject.add(this.gameObject)),this._syncTransforms&&i)for(const u of this._syncTransforms)u.fastMode=!0,u.isOwned()||u.requestOwnership();if(this.head&&this.context.mainCamera){const u=this.head.asset;if(u.position.copy(this.context.mainCamera.position),u.position.x*=-1,u.position.z*=-1,u.quaternion.copy(this.context.mainCamera.quaternion),u.quaternion.x*=-1,this.context.time.frameCount%10===0&&this.head.asset){const f=C.getComponentsInChildren(this.head.asset,Qt);for(const p of f)p.enabled=!1,p.gameObject.visible=!1}}const o=e.xr.leftController,r=(h=this.leftHand)==null?void 0:h.asset;o&&r?(r.position.copy(o.gripPosition),r.quaternion.copy(o.gripQuaternion),r.quaternion.multiply(ew),r.visible=o.isTracking,this.updateHandVisibility(o,r,this._leftHandMeshes)):r&&r.visible&&(r.visible=!1);const l=e.xr.rightController,c=(d=this.rightHand)==null?void 0:d.asset;l&&c?(c.position.copy(l.gripPosition),c.quaternion.copy(l.gripQuaternion),c.quaternion.multiply(ew),c.visible=l.isTracking,this.updateHandVisibility(l,c,this._rightHandMeshes)):c&&c.visible&&(c.visible=!1)}onBeforeRender(){this.context.xr&&this.context.time.frame%10===0&&this.updateRemoteAvatarVisibility()}updateHandVisibility(e,i,n){if(n){const o=e.model&&e.model.visible&&e.model!==i;n.forEach(r=>{Io(r,!o)})}}updateRemoteAvatarVisibility(){var e,i,n;if(this.context.connection.isConnected){const o=Kt.getFor(this);if(o&&o.isLocalPlayer==!1){const r=te.getXRSync(this.context);if(r&&r.hasState(o.owner)){this.tryFindAvatarObjectsIfMissing();const l=(e=this.leftHand)==null?void 0:e.asset;l&&(l.visible=(r==null?void 0:r.isTracking(o.owner,"left"))??!1);const c=(i=this.rightHand)==null?void 0:i.asset;c&&(c.visible=(r==null?void 0:r.isTracking(o.owner,"right"))??!1)}if((n=this.head)!=null&&n.asset){const l=C.getComponentsInChildren(this.head.asset,Qt);for(const c of l)c.enabled=!1,c.gameObject.visible=!0}}}}tryFindAvatarObjectsIfMissing(){if(!this.head||!this.leftHand||!this.rightHand){const e={head:this.head,leftHand:this.leftHand,rightHand:this.rightHand};cE.tryFindAvatarObjects(this.gameObject,this.sourceId||"",e),e.head&&(this.head=e.head),e.leftHand&&(this.leftHand=e.leftHand),e.rightHand&&(this.rightHand=e.rightHand)}}async prepareAvatar(){var e,i;if(this.tryFindAvatarObjectsIfMissing(),this.head)this.head instanceof D&&(this.head=new he("",this.sourceId,this.head));else{const n=new D;n.name="Head";const o=ll.createPrimitive(Bn.Cube);n.add(o),this.gameObject.add(n),this.head=new he("",this.sourceId,n),Rh&&console.log("Create head",n)}if(this.rightHand)this.rightHand instanceof D&&(this.rightHand=new he("",this.sourceId,this.rightHand));else{const n=new D;n.name="Right Hand",this.gameObject.add(n),this.rightHand=new he("",this.sourceId,n),Rh&&console.log("Create right hand",n)}if(this.leftHand)this.leftHand instanceof D&&(this.leftHand=new he("",this.sourceId,this.leftHand));else{const n=new D;n.name="Left Hand",this.gameObject.add(n),this.leftHand=new he("",this.sourceId,n),Rh&&console.log("Create left hand",n)}await this.loadAvatarObjects(this.head,this.leftHand,this.rightHand),this._leftHandMeshes=[],(e=this.leftHand.asset)==null||e.traverse(n=>{n!=null&&n.isMesh&&this._leftHandMeshes.push(n)}),this._rightHandMeshes=[],(i=this.rightHand.asset)==null||i.traverse(n=>{n!=null&&n.isMesh&&this._rightHandMeshes.push(n)}),Kt.isLocalPlayer(this.gameObject)&&(this._syncTransforms=C.getComponentsInChildren(this.gameObject,oo))}async loadAvatarObjects(e,i,n){const o=e.loadAssetAsync(),r=i.loadAssetAsync(),l=n.loadAssetAsync(),c=new Array;o&&c.push(o),r&&c.push(r),l&&c.push(l);const h=await sS(c);Rh&&console.log("Avatar loaded results:",h)}}qb([m(he)],il.prototype,"head",void 0);qb([m(he)],il.prototype,"leftHand",void 0);qb([m(he)],il.prototype,"rightHand",void 0);var Pm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const dr=S("debugwebxr"),ur=new Array;class Jo extends j{constructor(){super(...arguments);a(this,"createControllerModel",!0);a(this,"createHandModel",!0);a(this,"customLeftHand");a(this,"customRightHand");a(this,"_models",new Array)}supportsXR(e){return e==="immersive-vr"||e==="immersive-ar"}async onXRControllerAdded(e){var o;if(!(e.xr.isVR||e.xr.isPassThrough))return;console.debug("XR Controller Added",e.controller.side,e.controller.index);const{controller:n}=e;if(this.createControllerModel||this.createHandModel){if(n.hand){if(this.createHandModel){const r=await this.loadHandModel(this,n);if(!r||!n.connected||!n.isHand){r!=null&&r.handObject&&xh(r.handObject,!1),(o=r==null?void 0:r.handObject)==null||o.destroy();return}this._models.push({controller:n,model:r.handObject,handmesh:r.handmesh}),this._models.sort((l,c)=>l.controller.index-c.controller.index),this.scene.add(r.handObject),n.model=r.handObject}}else if(this.createControllerModel){const r=await n.getModelUrl();if(r){const l=await this.loadModel(n,r);if(!l||!n.connected||n.isHand)return;this._models.push({controller:n,model:l}),this._models.sort((c,h)=>c.controller.index-h.controller.index),this.scene.add(l),l.traverse(c=>{c.layers.set(2),c.matrixAutoUpdate=!1,c.updateMatrix()}),n.model=l}else n.targetRayMode!=="transient-pointer"&&console.warn("XRControllerModel: no model found for "+n.side)}}}onXRControllerRemoved(e){console.debug("XR Controller Removed",e.controller.side,e.controller.index);const i=this._models.findIndex(o=>o.controller===e.controller),n=this._models[i];n&&(this._models.splice(i,1),n.model&&(xh(n.model,!1),n.model.destroy(),n.model=void 0))}onBeforeXR(e,i){this.createHandModel&&(this.customLeftHand||this.customRightHand)&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("hand-tracking")||i.optionalFeatures.push("hand-tracking"))}onLeaveXR(e){for(const i of this._models)i&&(i.model&&(xh(i.model,!1),i.model.destroy(),i.model=void 0),i.controller.model===i.model&&(i.controller.model=null));this._models.length=0}onBeforeRender(){if(te.active&&(dr&&(ur[0]=Date.now()),this.updateRendering(te.active),dr)){const e=Date.now()-ur[0];ur.push(e),ur.length>=30&&(ur[0]=0,ur.reduce((i,n)=>i+n,0)/ur.length,ur.length=0)}}updateRendering(e){var i,n,o,r,l;for(let c=0;c<this._models.length;c++){const h=this._models[c];if(!h)continue;const d=h.controller;if(!d.connected){dr&&console.warn("XRControllerModel.onUpdateXR: controller is not connected anymore",d.side,d.hand);continue}if(h.model&&!h.handmesh)h.model.matrixAutoUpdate=!1,h.model.matrix.copy(d.gripMatrix),h.model.visible=d.isTracking,(i=e.rig)==null||i.gameObject.add(h.model);else if(d.inputSource.hand&&h.handmesh){const u=e.referenceSpace,f=this.context.renderer.xr.getHand(d.index);if(u&&e.frame.getJointPose){for(const p of d.inputSource.hand.values()){const g=f.joints[p.jointName];if(g){const _=d.getHandJointPose(p);if(_){const y=_.transform.position,b=_.transform.orientation;g.position.copy(y),g.quaternion.copy(b),g.matrixAutoUpdate=!1}g.visible=_!=null}}h.model&&(h.model.visible=d.isTracking,h.model.visible&&h.model.parent!==((n=e.rig)==null?void 0:n.gameObject)&&((o=e.rig)==null||o.gameObject.add(h.model))),(r=h.model)!=null&&r.visible&&((l=h.handmesh)==null||l.updateMesh(),h.model.matrixAutoUpdate=!1,h.model.matrix.identity(),h.model.applyMatrix4(cc))}}}}async loadModel(e,i){var r;if(!e.connected)return console.warn("XRControllerModel.onXRControllerAdded: controller is not connected anymore",e.side),null;const o=await he.getOrCreate("",i).instantiate();return xh(o),(r=te.active)!=null&&r.isPassThrough&&o.traverseVisible(l=>{this.makeOccluder(l)}),o}async loadHandModel(e,i){const n=this.context,o=n.renderer.xr.getHand(i.index);o||(dr?G.DrawLabel(i.rayWorldPosition,"No hand found for index "+i.index,.05,5):console.warn("No hand found for index "+i.index));const r=new Yo;Mb(r,n),await S_(r,n,this.sourceId??"");const l=P1(r);let c="";const h=i.side==="left"?this.customLeftHand:this.customRightHand;h?(c=h.url.split(".").slice(0,-1).join("."),r.setPath("")):(c=i.inputSource.handedness==="left"?"left":"right",r.setPath("https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/"));const d=new D;xh(d);const u=new uT(d,o,r.path,c,r,f=>{var g;const p=l==null?void 0:l.gltf;((g=p==null?void 0:p.scene.children)==null?void 0:g.length)===0&&(p.scene.children[0]=f),l!=null&&l.gltf&&so().createBuiltinComponents(e.context,e.sourceId||c,l.gltf,null,l),f.traverse(_=>{var y;_.layers.set(2),(y=te.active)!=null&&y.isPassThrough&&!h&&this.makeOccluder(_),_ instanceof X&&pt.assignMeshLOD(_,0)}),i.connected||(dr&&G.DrawLabel(i.rayWorldPosition,"Hand is loaded but not connected anymore",.05,5),f.removeFromParent())});if(dr&&d.add(new yn(.5)),i.inputSource.hand){dr&&console.log(i.inputSource.hand);for(const f of i.inputSource.hand.values())if(o.joints[f.jointName]===void 0){const p=new Ar;p.matrixAutoUpdate=!1,p.visible=!0,o.joints[f.jointName]=p,o.add(p)}}else dr&&G.DrawLabel(i.rayWorldPosition,"No inputSource.hand found for index "+i.index,.05,5);return{handObject:d,handmesh:u}}makeOccluder(e){if(e instanceof X){let i=e.material;i instanceof Ie&&(i=e.material=i.clone(),i.depthWrite=!0,i.depthTest=!0,i.colorWrite=!1,e.receiveShadow=!1,e.renderOrder=-100)}}}a(Jo,"factory",new dT);Pm([m()],Jo.prototype,"createControllerModel",void 0);Pm([m()],Jo.prototype,"createHandModel",void 0);Pm([m(he)],Jo.prototype,"customLeftHand",void 0);Pm([m(he)],Jo.prototype,"customRightHand",void 0);class Xb extends j{}var ta=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ay=S("debugwebxr");class Hn extends j{constructor(){super(...arguments);a(this,"movementSpeed",1.5);a(this,"rotationStep",30);a(this,"useTeleport",!0);a(this,"usePinchToTeleport",!0);a(this,"useTeleportTarget",!1);a(this,"useTeleportFade",!1);a(this,"showRays",!0);a(this,"showHits",!0);a(this,"isXRMovementHandler",!0);a(this,"xrSessionMode","immersive-vr");a(this,"_didApplyRotation",!1);a(this,"_didTeleport",!1);a(this,"_teleportBuffer",new Array);a(this,"_plane",null);a(this,"_lines",[]);a(this,"_hitDiscs",[]);a(this,"_hitDistances",[]);a(this,"_lastHitDistances",[]);a(this,"hitPointRaycastFilter",e=>e.type==="SkinnedMesh"?"continue in children":!0)}onUpdateXR(e){const i=e.xr.rig;if(!(i!=null&&i.gameObject)||e.xr.isPassThrough)return;const n=e.xr.leftController,o=e.xr.rightController;n&&this.onHandleMovement(n,i.gameObject),o&&(this.onHandleRotation(o,i.gameObject),this.useTeleport&&this.onHandleTeleport(o,i.gameObject))}onLeaveXR(e){for(const i of this._lines)i.removeFromParent();for(const i of this._hitDiscs)i==null||i.removeFromParent()}onBeforeRender(){var e;(e=this.context.xr)!=null&&e.running&&(this.showRays&&this.renderRays(this.context.xr),this.showHits&&this.renderHits(this.context.xr))}onHandleMovement(e,i){const n=e.getStick("xr-standard-thumbstick");if(n.x!=0||n.y!=0){const o=q(n.x,0,n.y);o.multiplyScalar(this.context.time.deltaTimeUnscaled*this.movementSpeed);const r=_t(i);o.multiplyScalar(r.x),o.applyQuaternion(e.xr.poseOrientation),o.y=0,o.applyQuaternion(i.worldQuaternion),U()&&Number.isNaN(o.x)&&console.error("Stick movement resulted in NaN",{stick:n,vec:o}),i.position.add(o),i.updateWorldMatrix(!1,!1);for(const l of i.children)l.updateWorldMatrix(!1,!1)}}onHandleRotation(e,i){if(e._isMxInk)return;const o=e.getStick("xr-standard-thumbstick").x;if(this._didApplyRotation)Math.abs(o)<.3&&(this._didApplyRotation=!1);else if(Math.abs(o)>.5){this._didApplyRotation=!0;const r=o>0?1:-1,l=ae(this.context.mainCamera).clone();i.rotateY(r*N.toRadians(this.rotationStep));const h=ae(this.context.mainCamera).clone().sub(l);h.y=0,i.position.sub(h)}}onHandleTeleport(e,i){var o,r,l,c,h;let n=0;if(e.hand&&this.usePinchToTeleport&&e.isTeleportGesture){const d=e.getPointerId("primary");if(d!=null&&this.context.input.getIsPointerIdInUse(d))return;const u=e.getGesture("pinch");u&&(n=u.value)}else n=(o=e.getStick("xr-standard-thumbstick"))==null?void 0:o.y;if(this._didTeleport)n>=0&&n<.4?this._didTeleport=!1:n<0&&n>-.4&&(this._didTeleport=!1);else if(n>.8){this._didTeleport=!0;const d=this.context.physics.raycastFromRay(e.ray)[0];if(d&&d.object instanceof Sc){const f=(r=d.normal)==null?void 0:r.dot(q(0,1,0));if(f!==void 0&&f<.4)return}let u=d==null?void 0:d.point;if(!u&&!this.useTeleportTarget){this._plane||(this._plane=new Za(new x(0,1,0),0));const f=i.worldPosition;this._plane.setFromNormalAndCoplanarPoint(new x(0,1,0),f);const p=e.ray;u=f.clone(),this._plane.intersectLine(new DR(p.origin,q(p.direction).multiplyScalar(1e4).add(p.origin)),u),u.distanceTo(f)>i.scale.x*10&&(u=null)}if(u){if(this.useTeleportTarget&&!C.getComponentInParent(d.object,Xb))return;const f=u.clone();if(ay&&G.DrawSphere(u,.025,16711680,5),(l=this.context.mainCamera)==null?void 0:l.position){const g=(c=this.context.xr)==null?void 0:c.getUserOffsetInRig();g&&(g.y=0,f.sub(g),ay&&G.DrawWireSphere(g.add(f),.025,65280,5))}this._teleportBuffer.push(i.matrix.clone()),this._teleportBuffer.length>10&&this._teleportBuffer.shift(),this.useTeleportFade?(h=e.xr.fadeTransition())==null||h.then(()=>{i.worldPosition=f}):i.worldPosition=f}}else if(n<-.8&&(this._didTeleport=!0,this._teleportBuffer.length>0)){const d=this._teleportBuffer.pop();d&&d.decompose(i.position,i.quaternion,i.scale)}}renderRays(e){var i;for(let n=0;n<this._lines.length;n++){const o=this._lines[n];o&&(o.visible=!1)}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];let r=this._lines[n];if(!o.connected||!o.isTracking||!o.ray||o.targetRayMode==="transient-pointer"||!o.hasSelectEvent){r&&(r.visible=!1);continue}r||(r=this.createRayLineObject(),r.scale.z=.5,this._lines[n]=r),o.updateRayWorldPosition(),o.updateRayWorldQuaternion();const l=o.rayWorldPosition,c=o.rayWorldQuaternion;r.position.copy(l),r.quaternion.copy(c);const h=e.rigScale,d=this.usePinchToTeleport&&o.isTeleportGesture,u=this._lastHitDistances[n],f=this._hitDistances[n]!=null,p=u??h;r.scale.set(h,h,p),r.visible=!0,r.layers.disableAll(),r.layers.enable(2);let g=r.material.opacity;d?g=1:this.showHits&&p<e.rigScale*.5?g=0:(i=o.getButton("primary"))!=null&&i.pressed?g=.5:g=f?.2:.1,r.material.opacity=N.lerp(r.material.opacity,g,this.context.time.deltaTimeUnscaled/.1),r.parent!==this.context.scene&&this.context.scene.add(r)}}renderHits(e){var i;for(const n of this._hitDiscs){if(!n)continue;const o=n.controller;if(!o||!o.connected||!o.isTracking){n.visible=!1;continue}}for(let n=0;n<e.controllers.length;n++){const o=e.controllers[n];if(!o.connected||!o.isTracking||!o.ray||!o.hasSelectEvent)continue;let r=this._hitDiscs[n],l=!0;const c=o.getPointerId("primary");c!=null&&this.context.input.getIsPointerIdInUse(c)&&(r&&(r.visible=!1),this._hitDistances[n]=null,this._lastHitDistances[n]=0,l=!1);const h=this.context.time.smoothedFps>=59?1:10;if((this.context.time.frame+o.index)%h!==0&&(l=!1),!l){const f=this._hitDiscs[n];f&&f.visible&&f.hit&&this.updateHitPointerPosition(o,f,f.hit.distance);continue}const d=this.context.physics.raycastFromRay(o.ray,{testObject:this.hitPointRaycastFilter,precise:!1});let u=d.find(f=>this.usePinchToTeleport&&o.isTeleportGesture?!0:this.isObjectWithInteractiveComponent(f.object));if(u||(u=d[0]),r&&(r.controller=o,r.hit=u),this._hitDistances[n]=(u==null?void 0:u.distance)||null,u){this._lastHitDistances[n]=u.distance;const f=e.rigScale??1;ay&&(G.DrawWireSphere(u.point,.025*f,16711680),G.DrawLabel(q(0,.2,0).add(u.point),u.object.name,.02,0)),r||(r=this.createHitPointObject(),this._hitDiscs[n]=r),r.hit=u,r.visible=u.distance>f*.05;let p=.01*(f+u.distance);const g=(i=o.getButton("primary"))==null?void 0:i.pressed;g&&(p*=1.1),r.scale.set(p,p,p),r.layers.set(2);let _=r.material.opacity;if(g?_=1:_=u.distance<.15*f?.2:.6,r.material.opacity=N.lerp(r.material.opacity,_,this.context.time.deltaTimeUnscaled/.1),r.visible){if(u.normal){this.updateHitPointerPosition(o,r,u.distance);const y=u.normal.applyQuaternion(Le(u.object));r.quaternion.setFromUnitVectors(wI,y)}else this.updateHitPointerPosition(o,r,u.distance);r.parent!==this.context.scene&&this.context.scene.add(r)}}else this._hitDiscs[n]&&(this._hitDiscs[n].visible=!1)}}isObjectWithInteractiveComponent(e,i=0){return __(e)||e.isUI===!0?!0:e.isScene?!1:e.parent?this.isObjectWithInteractiveComponent(e.parent,i+1):!1}updateHitPointerPosition(e,i,n){const o=q(e.rayWorldPosition);o.add(q(0,0,n-.01).applyQuaternion(e.rayWorldQuaternion)),i.position.lerp(o,this.context.time.deltaTimeUnscaled/.05)}createHitPointObject(){const e=new X(new Wp(.3,6,6),new Be({color:15658734,opacity:.7,transparent:!0,depthTest:!1,depthWrite:!1,side:vn}));return e.layers.disableAll(),e.layers.enable(2),e}createRayLineObject(){const e=new fT;e.layers.disableAll(),e.layers.enable(2);const i=new pT;e.geometry=i;const n=new Float32Array(9);n.set([0,0,.02,0,0,.4,0,0,1]),i.setPositions(n);const o=new Float32Array(9);o.set([1,1,1,.1,.1,.1,0,0,0]),i.setColors(o);const r=new mT({color:16777215,vertexColors:!0,worldUnits:!0,linewidth:.004,transparent:!0,depthWrite:!1,blending:Ww,dashed:!1});return e.material=r,e}}ta([m()],Hn.prototype,"movementSpeed",void 0);ta([m()],Hn.prototype,"rotationStep",void 0);ta([m()],Hn.prototype,"useTeleport",void 0);ta([m()],Hn.prototype,"usePinchToTeleport",void 0);ta([m()],Hn.prototype,"useTeleportTarget",void 0);ta([m()],Hn.prototype,"useTeleportFade",void 0);ta([m()],Hn.prototype,"showRays",void 0);ta([m()],Hn.prototype,"showHits",void 0);const wI=new x(0,1,0);var Ut=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Th=S("debugwebxr"),SI=S("debugusdz"),Da=class extends j{constructor(){super(...arguments);a(this,"createVRButton",!0);a(this,"createARButton",!0);a(this,"createSendToQuestButton",!0);a(this,"createQRCode",!0);a(this,"useDefaultControls",!0);a(this,"showControllerModels",!0);a(this,"showHandModels",!0);a(this,"usePlacementReticle",!0);a(this,"customARPlacementReticle");a(this,"usePlacementAdjustment",!0);a(this,"arScale",1);a(this,"useXRAnchor",!1);a(this,"autoPlace",!1);a(this,"autoCenter",!1);a(this,"useQuicklookExport",!1);a(this,"useDepthSensing",!1);a(this,"useSpatialGrab",!0);a(this,"defaultAvatar");a(this,"_playerSync");a(this,"_createdComponentsInSession",[]);a(this,"_usdzExporter");a(this,"_exitXRMenuButton");a(this,"_previousXRState",0);a(this,"_spatialGrabRaycaster");a(this,"_activeWebARSessionRoot",null);a(this,"onAvatarSpawned",e=>{Th&&console.log("WebXR.onAvatarSpawned",e),C.getComponentInChildren(e,il)??(i=C.addComponent(e,il))});a(this,"_buttonFactory");a(this,"_buttons",[])}awake(){te.getXRSync(this.context)}onEnable(){var e,i;window.location.protocol!=="https:"&&ke('<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebXR_Device_API" target="_blank">WebXR</a> only works on secure connections (https).'),this.useQuicklookExport&&(C.findObjectOfType(De)||(Th&&console.log("WebXR: Adding USDZExporter"),this._usdzExporter=C.addComponent(this.gameObject,De),this._usdzExporter.objectToExport=this.context.scene,this._usdzExporter.autoExportAnimations=!0,this._usdzExporter.autoExportAudioSources=!0)),this.handleCreatingHTML(),this.handleOfferSession(),this.defaultAvatar===!0&&(Th&&console.warn("WebXR: No default avatar set, using static default avatar"),this.defaultAvatar=new he("https://cdn.needle.tools/static/avatars/DefaultAvatar.glb")),this.defaultAvatar&&(this._playerSync=this.gameObject.getOrAddComponent(gl),this._playerSync.autoSync=!1),this._playerSync&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,(e=this._playerSync.onPlayerSpawned)==null||e.removeEventListener(this.onAvatarSpawned),(i=this._playerSync.onPlayerSpawned)==null||i.addEventListener(this.onAvatarSpawned))}onDisable(){var e;(e=this._usdzExporter)==null||e.destroy(),this.removeButtons()}async handleOfferSession(){return this.createVRButton&&await te.isVRSupported()&&this.createVRButton?te.offerSession("immersive-vr","default",this.context):this.createARButton&&await te.isARSupported()&&this.createARButton?te.offerSession("immersive-ar","default",this.context):!1}get session(){return te.active??null}get sessionMode(){return te.activeMode??null}get arSessionRoot(){return this._activeWebARSessionRoot}async enterVR(e){return te.start("immersive-vr",e,this.context)}async enterAR(e){return te.start("immersive-ar",e,this.context)}exitXR(){te.stop()}get isActiveWebXR(){return!Da.activeWebXRComponent||Da.activeWebXRComponent===this}onBeforeXR(e,i){var n;if(!this.isActiveWebXR){console.warn(`WebXR: another WebXR component is already active (${(n=Da.activeWebXRComponent)==null?void 0:n.name}). This is ignored: ${this.name}`);return}Da.activeWebXRComponent=this,e=="immersive-ar"&&this.useDepthSensing&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("depth-sensing"))}async onEnterXR(e){if(!this.isActiveWebXR)return;Th&&console.log("WebXR onEnterXR"),this._previousXRState=Ii.Global.Mask;const i=e.xr.isVR;if(Ii.Global.Set(i?Fn.VR:Fn.AR),e.xr.isAR){let n=C.findObjectOfType(ss);if(!n)if(this.usePlacementReticle){const o=new D;for(const r of this.context.scene.children)o.add(r);this.context.scene.add(o),n=C.addComponent(o,ss),this._createdComponentsInSession.push(n)}else(Th||U())&&console.warn("WebXR: No WebARSessionRoot found in scene and usePlacementReticle is disabled in WebXR component.");this._activeWebARSessionRoot=n,n&&(n.customReticle=this.customARPlacementReticle,n.arScale=this.arScale,n.arTouchTransform=this.usePlacementAdjustment,n.autoPlace=this.autoPlace,n.autoCenter=this.autoCenter,n.useXRAnchor=this.useXRAnchor)}this.useDefaultControls&&this.setDefaultMovementEnabled(!0),(this.showControllerModels||this.showHandModels)&&this.setDefaultControllerRenderingEnabled(!0),this.useSpatialGrab&&(this._spatialGrabRaycaster=C.findObjectOfType(Qa)??void 0,this._spatialGrabRaycaster||(this._spatialGrabRaycaster=this.gameObject.addComponent(Qa))),this.createLocalAvatar(e.xr),e.xr.isScreenBasedAR||(this._exitXRMenuButton=this.context.menu.appendChild({label:"Quit XR",onClick:()=>this.exitXR(),icon:"exit_to_app",priority:2e4}))}onUpdateXR(e){this.isActiveWebXR&&this._spatialGrabRaycaster&&(this._spatialGrabRaycaster.enabled=this.useSpatialGrab)}onLeaveXR(e){var i,n;if((i=this._exitXRMenuButton)==null||i.remove(),!!this.isActiveWebXR){Ii.Global.Set(this._previousXRState),(n=this._playerSync)==null||n.destroyInstance();for(const o of this._createdComponentsInSession)o.destroy();this._createdComponentsInSession.length=0,this._activeWebARSessionRoot=null,this.handleOfferSession(),Jp(1).then(()=>Da.activeWebXRComponent=null)}}setDefaultMovementEnabled(e){let i=this.gameObject.getComponent(Hn);return!i&&e&&(i=this.gameObject.addComponent(Hn),this._createdComponentsInSession.push(i)),i&&(i.enabled=e),i}setDefaultControllerRenderingEnabled(e){let i=this.gameObject.getComponent(Jo);return!i&&e&&(i=this.gameObject.addComponent(Jo),this._createdComponentsInSession.push(i),i.createControllerModel=this.showControllerModels,i.createHandModel==this.showHandModels),i&&(i.enabled=e),i}async createLocalAvatar(e){this._playerSync&&e.running&&typeof this.defaultAvatar!="boolean"&&(this._playerSync.asset=this.defaultAvatar,await this._playerSync.getInstance())}getButtonsContainer(){return this.getButtonsFactory()}getButtonsFactory(){return this._buttonFactory||(this._buttonFactory=$r.getOrCreate()),this._buttonFactory}handleCreatingHTML(){if(this.createARButton||this.createVRButton||this.useQuicklookExport){if((K.isiOS()&&K.isSafari()||SI)&&this.useQuicklookExport){const i=C.findObjectOfType(De);if(!i||i&&i.allowCreateQuicklookButton){const n=this.getButtonsFactory().createQuicklookButton();this.addButton(n,50)}}if(this.createARButton){const i=this.getButtonsFactory().createARButton();this.addButton(i,50)}if(this.createVRButton){const i=this.getButtonsFactory().createVRButton();this.addButton(i,50)}}if(this.createSendToQuestButton&&!K.isQuest()&&te.isVRSupported().then(i=>{if(!i){const n=this.getButtonsFactory().createSendToQuestButton();this.addButton(n,50)}}),this.createQRCode){const i=hm(or);if(i&&i.createQRCodeButton===!1)U()&&console.warn("WebXR: QRCode button is disabled in the Needle Menu component");else if(!K.isMobileDevice()){const n=Hs.getOrCreate().createQRCode();this.addButton(n,50)}}}addButton(e,i){this._buttons.push(e),e.setAttribute("priority",i.toString()),this.context.menu.appendChild(e)}removeButtons(){for(const e of this._buttons)e.remove();this._buttons.length=0}};let Je=Da;a(Je,"activeWebXRComponent",null);Ut([m()],Je.prototype,"createVRButton",void 0);Ut([m()],Je.prototype,"createARButton",void 0);Ut([m()],Je.prototype,"createSendToQuestButton",void 0);Ut([m()],Je.prototype,"createQRCode",void 0);Ut([m()],Je.prototype,"useDefaultControls",void 0);Ut([m()],Je.prototype,"showControllerModels",void 0);Ut([m()],Je.prototype,"showHandModels",void 0);Ut([m()],Je.prototype,"usePlacementReticle",void 0);Ut([m(he)],Je.prototype,"customARPlacementReticle",void 0);Ut([m()],Je.prototype,"usePlacementAdjustment",void 0);Ut([m()],Je.prototype,"arScale",void 0);Ut([m()],Je.prototype,"useXRAnchor",void 0);Ut([m()],Je.prototype,"autoPlace",void 0);Ut([m()],Je.prototype,"autoCenter",void 0);Ut([m()],Je.prototype,"useQuicklookExport",void 0);Ut([m()],Je.prototype,"useDepthSensing",void 0);Ut([m()],Je.prototype,"useSpatialGrab",void 0);Ut([m(he)],Je.prototype,"defaultAvatar",void 0);const nf=S("debugusdzbehaviours");class H1{constructor(){a(this,"behaviours",[]);a(this,"behaviourComponents",[]);a(this,"behaviourComponentsCopy",[]);a(this,"audioClips",[]);a(this,"audioClipsCopy",[]);a(this,"targetUuids",new Set)}get extensionName(){return"Behaviour"}addBehavior(t){this.behaviours.push(t)}addAudioClip(t){if(!t||typeof t!="string")return"";const i="audio/"+Wc.getName(t);return this.audioClips.push({clipUrl:t,filesKey:i}),i}getAllTargetUuids(){return this.targetUuids}onBeforeBuildDocument(t){if(!t.root)return Promise.resolve();const e=[];return t.root.traverse(i=>{C.foreachComponent(i,n=>{var r;const o=n;if(typeof o.createBehaviours=="function"||typeof o.beforeCreateDocument=="function"||typeof o.afterCreateDocument=="function"||typeof o.afterSerialize=="function"){this.behaviourComponents.push(o);const l=(r=o.beforeCreateDocument)==null?void 0:r.call(o,this,t);l instanceof Promise&&e.push(l)}},!1)}),nf&&console.log("onBeforeBuildDocument: all components",this.behaviourComponents),Promise.all(e)}onExportObject(t,e,i){var n;for(const o of this.behaviourComponents)(n=o.createBehaviours)==null||n.call(o,this,e,i)}onAfterBuildDocument(t){for(const u of this.behaviourComponents)typeof u.afterCreateDocument=="function"&&u.afterCreateDocument(this,t);this.behaviourComponentsCopy=this.behaviourComponents.slice(),this.behaviourComponents.length=0,this.audioClipsCopy=this.audioClips.slice(),this.audioClips.length=0;const e=new Set,i=new Set,n=new Set,o=new Set,r=nf;let l=`graph LR
`,c="";function h(u){if(u instanceof Ba){r&&(l+=`subgraph Group_${u.id}
`);for(const f of u.actions)r&&(l+=`${u.id}[${u.id}] -- ${u.type},loops:${u.loops} --> ${f.id}[${f.id}]
`),h(f);r&&(l+=`end
`)}else if(u instanceof hn){u.tokenId==="StartAnimation"&&o.add(u);let f=u.tokenId;u.type!==void 0&&(f+=":"+u.type);const p=u.affectedObjects;if(p)if(Array.isArray(p))for(const _ of p)i.add(_),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${_.uuid}(("${_.displayName||_.name||_.uuid}"))
`);else typeof p=="object"?(i.add(p),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${p.uuid}(("${p.displayName||p.name||p.uuid}"))
`)):typeof p=="string"&&i.add({uuid:p});const g=u.xFormTarget;g&&(typeof g=="object"?(i.add(g),r&&(c+=`${u.id}[${u.id}
${f}] -- ${f} --> ${g.uuid}(("${g.displayName||g.name||g.uuid}"))
`)):typeof g=="string"&&i.add({uuid:g}))}}function d(u,f){if(Array.isArray(u))for(const p of u)d(p,f);else if(u instanceof Nr){let p=u.tokenId;u.type!==void 0&&(p+=":"+u.type),typeof u.targetId=="object"&&(e.add(u.targetId),r&&(c+=`${u.targetId.uuid}(("${u.targetId.displayName}")) --> ${u.id}[${u.id}
${p}]
`)),r&&(l+=`${u.id}((${u.id})) -- ${p} --> ${f.id}[${f.tokenId||f.id}]
`)}}for(const u of this.behaviours)r&&(l+=`subgraph ${u.id}
`),h(u.action),d(u.trigger,u.action),r&&(l+=`end
`);r&&(l+=`
`+c),r&&(console.log("All USDZ behaviours",this.behaviours),this.behaviours.length&&(console.warn("The Mermaid graph can be pasted into https://massive-mermaid.glitch.me/ or https://mermaid.live/edit. It should be in your clipboard already!"),console.log(l),navigator.clipboard.writeText(l)));{let u=`gantt
title Animations
dateFormat X
axisFormat %s
`;const f=Array.from(o),p=new Set;for(const b of f)if(b.affectedObjects&&typeof b.affectedObjects!="string"){if(Array.isArray(b.affectedObjects))for(const v of b.affectedObjects)p.add(v);else p.add(b.affectedObjects);r&&(u+=`section ${b.animationName} (${b.id})
`,u+=`${b.id} : ${b.start}, ${b.duration}s
`)}r&&o.size&&console.log(u);const g=new Set;for(const b of p){b.getPath||console.error("USDZExporter: Animation target object has no getPath method. This is likely a bug",b);let v=b.getPath();v.startsWith("<")&&(v=v.substring(1)),v.endsWith(">")&&(v=v.substring(0,v.length-1)),g.add({path:v,obj:b})}const _=Array.from(g).sort((b,v)=>b.path.length-v.path.length),y=new Array;for(let b=0;b<_.length;b++)for(let v=b+1;v<_.length;v++)if(_[v].path.startsWith(_[b].path)){const w=_[v],P=_[b];y.push({child:w.obj.displayName+" ("+w.path+")",parent:P.obj.displayName+" ("+P.path+")"})}y.length&&console.warn("USDZExporter: There are overlapping PlayAnimation actions. This can lead to undefined runtime behaviour when playing multiple animations. Please restructure the hierarchy so that animations don't overlap.",{overlappingTargets:y,playAnimationActions:o})}for(const u of new Set([...e,...i]))if(Array.isArray(u))for(const f of u)n.add(f.uuid);else n.add(u.uuid);nf&&console.log("All Behavior trigger sources and action targets",e,i,n),this.targetUuids=new Set(n)}onAfterHierarchy(t,e){var i;if((i=this.behaviours)!=null&&i.length){e.beginBlock('def Scope "Behaviors"');for(const n of this.behaviours)n.writeTo(this,t.document,e);e.closeBlock()}}async onAfterSerialize(t){nf&&console.log("onAfterSerialize behaviours",this.behaviourComponentsCopy);for(const e of this.behaviourComponentsCopy)typeof e.afterSerialize=="function"&&(e.afterSerialize.constructor.name==="AsyncFunction"?await e.afterSerialize(this,t):e.afterSerialize(this,t));for(const{clipUrl:e,filesKey:i}of this.audioClipsCopy){if(t.files[i])return;const r=await(await(await fetch(e)).blob()).arrayBuffer(),l=new Uint8Array(r);t.files[i]=l}this.behaviourComponentsCopy.length=0,this.audioClipsCopy.length=0}}class G1{get extensionName(){return"Physics"}onExportObject(t,e,i){const n=C.getComponents(t,xe).filter(c=>c.enabled),o=C.getComponents(t,wn).filter(c=>c.enabled&&!c.isTrigger);let r=n.length>0?n[0]:null;const l=o.length>0?o[0]:null;l&&!r&&(r=new xe,r.isKinematic=!0),r&&e.addEventListener("serialize",(c,h)=>{var d,u,f;if(r){if(c.appendLine(),c.beginBlock('def RealityKitComponent "RigidBody"',"{",!0),r.useGravity||c.appendLine("bool gravityEnabled = 0"),c.appendLine('uniform token info:id = "RealityKit.RigidBody"'),r.isKinematic&&c.appendLine('token motionType = "Kinematic"'),c.beginBlock('def RealityKitStruct "massFrame"',"{",!0),c.appendLine(`float m_mass = ${r.mass}`),c.beginBlock('def RealityKitStruct "m_pose"',"{",!0),c.appendLine(`float3 position = (${r.centerOfMass.x}, ${r.centerOfMass.y}, ${r.centerOfMass.z})`),c.closeBlock("}"),c.closeBlock("}"),o.length>0){const p=o[0];c.beginBlock('def RealityKitStruct "material"',"{",!0);const g=p.sharedMaterial;g&&g.dynamicFriction!==void 0&&c.appendLine(`double dynamicFriction = ${(d=p.sharedMaterial)==null?void 0:d.dynamicFriction}`),g&&g.bounciness!==void 0&&c.appendLine(`double restitution = ${(u=p.sharedMaterial)==null?void 0:u.bounciness}`),g&&g.staticFriction!==void 0&&c.appendLine(`double staticFriction = ${(f=p.sharedMaterial)==null?void 0:f.staticFriction}`),c.closeBlock("}")}c.closeBlock("}")}}),l&&(e.addEventListener("serialize",(c,h)=>{var f;c.beginBlock('def RealityKitComponent "Collider"',"{",!0),c.appendLine("uint group = 1"),c.appendLine('uniform token info:id = "RealityKit.Collider"'),c.appendLine("uint mask = 4294967295");const u=l.isTrigger?"Trigger":"Default";if(c.appendLine(`token type = "${u}"`),c.beginBlock('def RealityKitStruct "Shape"',"{",!0),l instanceof lu){const p=l;c.appendLine('token shapeType = "Sphere"'),c.appendLine(`float radius = ${p.radius}`)}else if(l instanceof ul){const p=l;c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${p.size.x}, ${p.size.y}, ${p.size.z})`)}else if(l instanceof qr){const p=l;c.appendLine('token shapeType = "Capsule"'),c.appendLine(`float radius = ${p.radius}`),c.appendLine(`float height = ${p.height}`)}else if(l instanceof fl&&((f=l.sharedMesh)!=null&&f.geometry)){const p=l.sharedMesh.geometry;p.boundingBox||p.computeBoundingBox();const g=l.sharedMesh.geometry.boundingBox;g&&(c.appendLine('token shapeType = "Box"'),c.appendLine(`float3 extent = (${g.max.x-g.min.x}, ${g.max.y-g.min.y}, ${g.max.z-g.min.z})`),console.log("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. MeshCollider will be exported as Box",l))}else console.warn("[USDZ] Only Box, Sphere, and Capsule colliders are supported in visionOS/iOS. Ignoring collider:",l);c.beginBlock('def RealityKitStruct "pose"',"{",!0),c.closeBlock("}"),c.closeBlock("}"),c.closeBlock("}")}),o.length>1&&console.log("WARNING: Multiple colliders detected. visionOS / iOS can only support objects with a single collider, only exporting the first collider: ",l))}}const CI=S("debugshadowcomponents");qw.prototype.interactable={get(){return this.interactive},set(s){this.interactable=s}};class ms extends j{constructor(){super(...arguments);a(this,"_shadowComponent",null);a(this,"_controlsChildLayout",!0);a(this,"_root");a(this,"_parentComponent")}isRoot(){var e;return((e=this.Root)==null?void 0:e.gameObject)===this.gameObject}get canvas(){const e=this.Root;return e!=null&&e.isCanvas?e:null}get Canvas(){return this.canvas}markDirty(){Xi.markUIDirty(this.context)}get shadowComponent(){return this._shadowComponent}set shadowComponent(e){this._shadowComponent=e}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(e){this._controlsChildLayout=e,this.shadowComponent&&(this.shadowComponent.autoLayout=e)}get Root(){return this._root===void 0&&(this._root=C.getComponentInParent(this.gameObject,Rm)),this._root}__internalNewInstanceCreated(e){return super.__internalNewInstanceCreated(e),this.shadowComponent=null,this._root=void 0,this._parentComponent=void 0,this}onEnable(){super.onEnable()}addShadowComponent(e,i){var r;if(!e)return;this.removeShadowComponent();const n=this.isRoot()?this.gameObject:this.gameObject.parent;if(this._parentComponent=C.getComponentInParent(n,ms),!this._parentComponent){console.warn(`Component "${this.name}" doesn't have a UI parent anywhere. Do you have an UI element outside a Canvas? UI components must be a child of a Canvas component`,this);return}e.name=this.name+" ("+(this.constructor.name??"UI")+")",e.autoLayout=this._parentComponent.controlsChildLayout,e[fn]=this,this.setShadowComponentOwner(e);let o=!1;if(((r=this.Root)==null?void 0:r.gameObject)===this.gameObject)this.gameObject.add(e);else{const l=this._parentComponent.shadowComponent;l&&(l==null||l.add(e),o=!0)}this.shadowComponent=e,i&&i.shadowComponent&&this.shadowComponent&&i.shadowComponent.add(this.shadowComponent),iu&&e.add(new yn(.5)),this.onAfterAddedToScene(),o&&eT(),CI&&console.warn("Added shadow component",this.shadowComponent)}setShadowComponentOwner(e){if(e&&(e[fn]===void 0||e[fn]===this)&&(e[fn]=this,e.children))for(const i of e.children)this.setShadowComponentOwner(i)}traverseOwnedShadowComponents(e,i,n){if(e&&e[fn]===i){n(e);for(const o of e.children)this.traverseOwnedShadowComponents(o,i,n)}}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}setInteractable(e){this.shadowComponent&&(this.shadowComponent.interactable=e)}}class Rm extends ms{awake(){super.awake()}}var uu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ly=S("debugui"),cy=S("debuguilayout");class PI{constructor(){a(this,"width");a(this,"height")}}class RI{constructor(){a(this,"x");a(this,"y");a(this,"width");a(this,"height")}}const Yn=new x,Oh=new ce,sf=new H;class ni extends ms{constructor(){super(...arguments);a(this,"_anchoredPosition");a(this,"sizeDelta",new le(100,100));a(this,"pivot",new le(.5,.5));a(this,"anchorMin",new le(0,0));a(this,"anchorMax",new le(1,1));a(this,"minWidth");a(this,"minHeight");a(this,"lastMatrix");a(this,"rectBlock");a(this,"_transformNeedsUpdate",!1);a(this,"_initialPosition");a(this,"_parentRectTransform");a(this,"_lastUpdateFrame",-1);a(this,"_lastAnchoring");a(this,"_createdBlocks",[]);a(this,"_createdTextBlocks",[])}get parent(){return this._parentRectTransform}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get anchoredPosition(){return this._anchoredPosition||(this._anchoredPosition=new le),this._anchoredPosition}set anchoredPosition(e){this._anchoredPosition=e}get width(){let e=this.sizeDelta.x;if(this.anchorMin.x!==this.anchorMax.x&&this._parentRectTransform){const i=this._parentRectTransform.width,n=this.anchorMax.x-this.anchorMin.x;e=i*n,e+=this.sizeDelta.x}return this.minWidth!==void 0&&e<this.minWidth?this.minWidth:e}get height(){let e=this.sizeDelta.y;if(this.anchorMin.y!==this.anchorMax.y&&this._parentRectTransform){const i=this._parentRectTransform.height,n=this.anchorMax.y-this.anchorMin.y;e=i*n,e+=this.sizeDelta.y}return this.minHeight!==void 0&&e<this.minHeight?this.minHeight:e}awake(){super.awake(),this._lastUpdateFrame=-1,this._parentRectTransform=void 0,this.rectBlock=new D,this.rectBlock.name=this.name,this.lastMatrix=new ce,this._lastAnchoring=null,this._initialPosition=this.gameObject.position.clone(),this._initialPosition.z=0,this._anchoredPosition||(this._anchoredPosition=new le),Ll(this,"_anchoredPosition",()=>{this.markDirty()}),Ll(this,"sizeDelta",()=>{this.markDirty()}),Ll(this,"pivot",()=>{this.markDirty()}),Ll(this,"anchorMin",()=>{this.markDirty()}),Ll(this,"anchorMax",()=>{this.markDirty()})}onEnable(){var e;super.onEnable(),this.rectBlock||(this.rectBlock=new D),this.lastMatrix||(this.lastMatrix=new ce),this._lastAnchoring||(this._lastAnchoring=new le),this._initialPosition||(this._initialPosition=new x),this._anchoredPosition||(this._anchoredPosition=new le),this.addShadowComponent(this.rectBlock),this._transformNeedsUpdate=!0,(e=this.canvas)==null||e.registerTransform(this)}onDisable(){var e;super.onDisable(),this.removeShadowComponent(),(e=this.canvas)==null||e.unregisterTransform(this)}onParentRectTransformChanged(e){this._transformNeedsUpdate||this.onApplyTransform(cy?`${e.name} changed`:void 0)}get isDirty(){return this._transformNeedsUpdate||(this._transformNeedsUpdate=!this.lastMatrix.equals(this.gameObject.matrix)),this._transformNeedsUpdate}markDirty(){this._transformNeedsUpdate||(cy&&console.warn("RectTransform markDirty()",this.name),this._transformNeedsUpdate=!0,this._lastUpdateFrame=-1)}updateTransform(){(this._transformNeedsUpdate||!this.lastMatrix.equals(this.gameObject.matrix))&&this.canUpdate()&&this.onApplyTransform(this._transformNeedsUpdate?"Marked dirty":"Matrix changed")}canUpdate(){return this._transformNeedsUpdate&&this.activeAndEnabled&&this._lastUpdateFrame!==this.context.time.frame}onApplyTransform(e){var o;if(this.context.time.frameCount===this._lastUpdateFrame)return;this._lastUpdateFrame=this.context.time.frameCount;const i=this.shadowComponent;if(!i)return;this.gameObject.parent?this._parentRectTransform=C.getComponentInParent(this.gameObject.parent,ni):this._parentRectTransform=void 0,this._transformNeedsUpdate=!1,cy&&console.warn("RectTransform â†’ ApplyTransform",this.name+" because "+e),this.isRoot()?this.Root.screenspace||(i.rotation.y=Math.PI):(i.matrix.identity(),i.matrixAutoUpdate=!1,Yn.set(0,0,0),this.applyPivot(Yn),i.matrix.setPosition(Yn.x,Yn.y,0),(this.gameObject.quaternion.x||this.gameObject.quaternion.y||this.gameObject.quaternion.z)&&(sf.copy(this.gameObject.quaternion),sf.x*=-1,sf.z*=-1,Oh.makeRotationFromQuaternion(sf),i.matrix.premultiply(Oh)),Yn.set(0,0,0),this.applyAnchoring(Yn),(o=this.canvas)!=null&&o.screenspace?Yn.z+=.1:Yn.z+=.01,Oh.identity(),Oh.setPosition(Yn.x,Yn.y,Yn.z),i.matrix.premultiply(Oh),i.matrix.scale(this.gameObject.scale)),this.lastMatrix.copy(this.gameObject.matrix);const n=!0;for(const r of Tb(this.gameObject,ms,n,1)){if(r===this||!r.activeAndEnabled)continue;const l=r;l.onParentRectTransformChanged&&l.onParentRectTransformChanged(this)}}applyAnchoring(e){this._lastAnchoring||(this._lastAnchoring=new le);const i=this._lastAnchoring.sub(this._anchoredPosition);this.gameObject.position.x+=i.x,this.gameObject.position.y+=i.y,this._lastAnchoring.copy(this._anchoredPosition),e.x+=this._initialPosition.x-this.gameObject.position.x,e.y+=this._initialPosition.y-this.gameObject.position.y,e.z+=this._initialPosition.z-this.gameObject.position.z;const n=this._parentRectTransform;if(n){let o=0;const r=1-this.anchorMax.y-this.anchorMin.y;o-=n.height*.5*r,e.y+=o;let l=0;const c=1-this.anchorMax.x-this.anchorMin.x;l-=n.width*.5*c,e.x+=l}}applyPivot(e){if(this.pivot&&!this.isRoot()){const i=this.pivot.x-.5;e.x-=i*this.sizeDelta.x*this.gameObject.scale.x;const n=this.pivot.y-.5;e.y-=n*this.sizeDelta.y*this.gameObject.scale.y}}getBasicOptions(){const e={width:this.sizeDelta.x,height:this.sizeDelta.y,offset:0,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0,letterSpacing:-.03};return this.ensureValidSize(e),e}ensureValidSize(e,i=1e-4){return e.width<=0&&(e.width=i),e.height<=0&&(e.height=1e-4),e}createNewBlock(e){e={...this.getBasicOptions(),...e},ly&&console.log(this.name,e);const i=new qw(e);return this._createdBlocks.push(i),i}createNewText(e){ly&&console.log(e),e={...this.getBasicOptions(),...e},ly&&console.log(this.name,e);const i=new Gw(e);return this._createdTextBlocks.push(i),i}}uu([m(le)],ni.prototype,"anchoredPosition",null);uu([m(le)],ni.prototype,"sizeDelta",void 0);uu([m(le)],ni.prototype,"pivot",void 0);uu([m(le)],ni.prototype,"anchorMin",void 0);uu([m(le)],ni.prototype,"anchorMax",void 0);var q1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class fu extends j{constructor(){super(...arguments);a(this,"effectColor");a(this,"effectDistance")}}q1([m(pe)],fu.prototype,"effectColor",void 0);q1([m(le)],fu.prototype,"effectDistance",void 0);var X1=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const of={backgroundColor:new de(1,1,1),backgroundOpacity:1,borderColor:new de(1,1,1),borderOpacity:1},sc=class extends ms{constructor(){super(...arguments);a(this,"_alphaFactor",1);a(this,"sRGBColor",new de(1,0,1));a(this,"raycastTarget",!0);a(this,"uiObject",null);a(this,"_color",null);a(this,"_rect",null);a(this,"_stateManager",null);a(this,"_currentlyCreatingPanel",!1)}get isGraphic(){return!0}get color(){return this._color||(this._color=new pe(1,1,1,1)),this._color}set color(e){(!this._color||this._color.r!==e.r||this._color.g!==e.g||this._color.b!==e.b||this._color.alpha!==e.alpha)&&(this._color||(this._color=new pe(1,1,1,1)),this._color.copy(e),this.onColorChanged())}setAlphaFactor(e){this._alphaFactor=e,this.onColorChanged()}get alphaFactor(){return this._alphaFactor}onColorChanged(){this.uiObject&&(this.sRGBColor.copy(this._color),this.sRGBColor.convertLinearToSRGB(),of.backgroundColor=this.sRGBColor,of.backgroundOpacity=this._color.alpha*this._alphaFactor,this.applyEffects(of,this._alphaFactor),this.uiObject.set(of),this.markDirty())}get m_Color(){return this._color}get rectTransform(){if(this._rect||(this._rect=C.getComponent(this.gameObject,ni)),!this._rect)throw new Error("Not Supported: Make sure to add a RectTransform component before adding a UI Graphic component.");return this._rect}onParentRectTransformChanged(){var e;(e=this.uiObject)==null||e.set({width:this.rectTransform.width,height:this.rectTransform.height}),this.markDirty()}__internalNewInstanceCreated(e){return super.__internalNewInstanceCreated(e),this._rect=null,this.uiObject=null,this._stateManager=null,this._color&&(this._color=this._color.clone()),this}setState(e){this.makePanel(),this.uiObject&&(this.uiObject.setState(e),this==null||this.markDirty())}setupState(e){this.makePanel(),this.uiObject&&(this._stateManager||(this._stateManager=new tT(this.uiObject)),this.uiObject.setupState(e.state,e.attributes))}setOptions(e){this.makePanel(),this.uiObject&&this.uiObject.set(e)}awake(){super.awake(),this.makePanel(),Ll(this,"_color",()=>WA(this,this.onColorChanged))}onEnable(){var e;super.onEnable(),this.uiObject&&((e=this.rectTransform.shadowComponent)==null||e.add(this.uiObject),this.addShadowComponent(this.uiObject,this.rectTransform))}onDisable(){super.onDisable(),this.uiObject&&this.removeShadowComponent()}makePanel(){if(this.uiObject||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const e=.015,i={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:e};this.onBeforeCreate(i),this.applyEffects(i),this.onCreate(i),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated(),this.onColorChanged()}onBeforeCreate(e){}onCreate(e){this.uiObject=this.rectTransform.createNewBlock(e),this.uiObject.name=this.name}onAfterCreated(){}applyEffects(e,i=1){var o;const n=(o=this.gameObject)==null?void 0:o.getComponent(fu);n&&(n.effectDistance&&(e.borderWidth=Math.max(Math.abs(n.effectDistance.x),Math.abs(n.effectDistance.y))),n.effectColor&&(e.borderColor=n.effectColor,e.borderOpacity=n.effectColor.alpha*i))}async setTexture(e){if(this.setOptions({backgroundOpacity:0}),e){if(sc.textureCache.has(e))e=sc.textureCache.get(e);else if(!e.isRenderTargetTexture){const i=e.clone();i.colorSpace=Xo,sc.textureCache.set(e,i),e=i}this.setOptions({backgroundImage:e,borderRadius:0,backgroundOpacity:this.color.alpha,backgroundSize:"stretch"}),pt.assignTextureLOD(e,0).then(i=>{i instanceof Ke&&(e&&sc.textureCache.set(e,i),this.setOptions({backgroundImage:i}),this.markDirty())})}else this.setOptions({backgroundImage:void 0,borderRadius:0,backgroundOpacity:this.color.alpha});this.markDirty()}onAfterAddedToScene(){super.onAfterAddedToScene(),this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}};let Vo=sc;a(Vo,"textureCache",new Map);X1([m(pe)],Vo.prototype,"color",null);X1([m()],Vo.prototype,"raycastTarget",void 0);class Tm extends Vo{constructor(){super(...arguments);a(this,"_flippedObject",!1)}onAfterCreated(){this.uiObject&&!this._flippedObject&&(this._flippedObject=!0,this.uiObject.scale.y*=-1)}}var rr=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ba=S("debugtext");var fe;(function(s){s[s.UpperLeft=0]="UpperLeft",s[s.UpperCenter=1]="UpperCenter",s[s.UpperRight=2]="UpperRight",s[s.MiddleLeft=3]="MiddleLeft",s[s.MiddleCenter=4]="MiddleCenter",s[s.MiddleRight=5]="MiddleRight",s[s.LowerLeft=6]="LowerLeft",s[s.LowerCenter=7]="LowerCenter",s[s.LowerRight=8]="LowerRight"})(fe||(fe={}));var md;(function(s){s[s.Truncate=0]="Truncate",s[s.Overflow=1]="Overflow"})(md||(md={}));var gd;(function(s){s[s.Wrap=0]="Wrap",s[s.Overflow=1]="Overflow"})(gd||(gd={}));var Ni;(function(s){s[s.Normal=0]="Normal",s[s.Bold=1]="Bold",s[s.Italic=2]="Italic",s[s.BoldAndItalic=3]="BoldAndItalic"})(Ni||(Ni={}));class ji extends Vo{constructor(){super(...arguments);a(this,"alignment",fe.UpperLeft);a(this,"verticalOverflow",md.Truncate);a(this,"horizontalOverflow",gd.Wrap);a(this,"lineSpacing",1);a(this,"supportRichText",!1);a(this,"font");a(this,"fontStyle",Ni.Normal);a(this,"sRGBTextColor",new de(1,0,1));a(this,"_text","");a(this,"_fontSize",12);a(this,"_textMeshUi",null);a(this,"_didHandleTextRenderOnTop",!1)}setAlphaFactor(e){var i;super.setAlphaFactor(e),(i=this.uiObject)==null||i.set({fontOpacity:this.color.alpha*this.alphaFactor}),this.markDirty()}get text(){return this._text}set text(e){e!==this._text&&(this._text=e,this.feedText(this.text,this.supportRichText),this.markDirty())}set_text(e){this.text=e}get fontSize(){return this._fontSize}set fontSize(e){var i;this._fontSize=e,(i=this.uiObject)==null||i.set({fontSize:e})}onColorChanged(){var e;this.sRGBTextColor.copy(this.color),this.sRGBTextColor.convertLinearToSRGB(),(e=this.uiObject)==null||e.set({color:this.sRGBTextColor,fontOpacity:this.color.alpha})}onParentRectTransformChanged(){super.onParentRectTransformChanged(),this.uiObject&&this.updateOverflow()}onBeforeCanvasRender(e){this.updateOverflow()}updateOverflow(){var i;const e=(i=this.uiObject)==null?void 0:i._overflow;e&&(e._needsUpdate=!0)}onCreate(e){ba&&console.log(this),this.horizontalOverflow==gd.Overflow&&(e.whiteSpace="pre"),this.verticalOverflow==md.Truncate&&(this.context.renderer.localClippingEnabled=!0,e.overflow="hidden"),this.horizontalOverflow==gd.Overflow&&this.verticalOverflow==md.Truncate,e.lineHeight=this.lineSpacing,delete e.backgroundOpacity,delete e.backgroundColor,ba&&(e.backgroundColor=16750848,e.backgroundOpacity=.5);const i=this.rectTransform;e={...e,...this.getTextOpts()},this.getAlignment(e),ba&&(e.backgroundColor=Math.random()*16777215,e.backgroundOpacity=.1),this.uiObject=i.createNewText(e),this.feedText(this.text,this.supportRichText)}onAfterAddedToScene(){super.onAfterAddedToScene(),this.handleTextRenderOnTop()}getTextOpts(){const e=this.fontSize,i={color:this.color,fontOpacity:this.color.alpha,fontSize:e,fontKerning:"normal"};return this.setFont(i,this.fontStyle),i}onEnable(){var e;super.onEnable(),this._didHandleTextRenderOnTop=!1,this.uiObject&&this.uiObject.addAfterUpdate(()=>{this.setShadowComponentOwner(this.uiObject),this.markDirty()}),setTimeout(()=>this.markDirty(),10),(e=this.canvas)==null||e.registerEventReceiver(this)}onDisable(){var e;super.onDisable(),(e=this.canvas)==null||e.unregisterEventReceiver(this)}getAlignment(e){switch(e.flexDirection="column",this.alignment){case fe.UpperLeft:case fe.MiddleLeft:case fe.LowerLeft:e.textAlign="left";break;case fe.UpperCenter:case fe.MiddleCenter:case fe.LowerCenter:e.textAlign="center";break;case fe.UpperRight:case fe.MiddleRight:case fe.LowerRight:e.textAlign="right";break}switch(this.alignment){default:case fe.UpperLeft:case fe.UpperCenter:case fe.UpperRight:e.alignItems="start";break;case fe.MiddleLeft:case fe.MiddleCenter:case fe.MiddleRight:e.alignItems="center";break;case fe.LowerLeft:case fe.LowerCenter:case fe.LowerRight:e.alignItems="end";break}return e}feedText(e,i){var n,o,r;if(ba&&console.log("feedText",this.uiObject,e,i),!!this.uiObject)if(this._textMeshUi||(this._textMeshUi=[]),this.uiObject.children.length=0,!i||e.length===0)this.uiObject.textContent=e;else{let l=this.getNextTag(e);if(l){if(l.startIndex>0){for(let d=this.uiObject.children.length-1;d>=0;d--){const u=this.uiObject.children[d];u.isUI&&(this.uiObject.remove(u),u.clear())}const h=new ug({textContent:e.substring(0,l.startIndex),color:"inherit"});this.uiObject.add(h)}}else{this.uiObject.textContent="",this.setOptions({textContent:e});return}const c=[];for(;l;){const h=this.getNextTag(e,l.endIndex),d={fontFamily:(n=this.uiObject)==null?void 0:n.get("fontFamily"),color:"inherit",textContent:""};if(h){d.textContent=this.getText(e,l,h),this.handleTag(l,d,c);const u=new ug(d);(o=this.uiObject)==null||o.add(u)}else{d.textContent=e.substring(l.endIndex),this.handleTag(l,d,c);const u=new ug(d);(r=this.uiObject)==null||r.add(u)}l=h}}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){if(!this.canvas)return;const e=[],i=this.canvas,n={renderOnTop:i.renderOnTop,depthWrite:i.depthWrite,doubleSided:i.doubleSided};for(;;){let o=!1;if(this._textMeshUi)for(let r=0;r<this._textMeshUi.length;r++){if(e[r]===!0)continue;o=!0;const l=this._textMeshUi[r];l.textContent&&(ap(l,n),e[r]=!0)}if(!o)break;yield}}handleTag(e,i,n){if(!e.isEndTag){if(e.type.includes("color")){const o=new hy(e,{color:i.color});if(n.push(o),e.type.length>6){const r=parseInt("0x"+e.type.substring(7));i.color=r}else i.color=new de(1,1,1)}else if(e.type=="b"){this.setFont(i,Ni.Bold);const o=new hy(e,{fontWeight:700});n.push(o)}else if(e.type=="i"){this.setFont(i,Ni.Italic);const o=new hy(e,{fontStyle:"italic"});n.push(o)}}}getText(e,i,n){return e.substring(i.endIndex,n.startIndex)}getNextTag(e,i=0){const n=e.indexOf("<",i),o=e.indexOf(">",n);if(n>=0&&o>=0){const r=e.substring(n+1,o);return{type:r,startIndex:n,endIndex:o+1,isEndTag:r.startsWith("/")}}return null}setFont(e,i){if(!this.font)return;const n=this.font,o=this.getFamilyNameWithCorrectSuffix(n,i);ba&&console.log("Selected font family:"+o);let r=F0.getFontFamily(o);switch(r||(r=F0.addFontFamily(o)),e.fontFamily=r,i){default:case Ni.Normal:e.fontWeight=400,e.fontStyle="normal";break;case Ni.Bold:e.fontWeight=700,e.fontStyle="normal";break;case Ni.Italic:e.fontWeight=400,e.fontStyle="italic";break;case Ni.BoldAndItalic:e.fontStyle="italic",e.fontWeight=400}let l=r.getVariant(e.fontWeight,e.fontStyle);if(!l){let c=o;c!=null&&c.endsWith("-msdf.json")||(c+="-msdf.json");let h=o;h!=null&&h.endsWith(".png")||(h+=".png"),l=r.addVariant(e.fontWeight,e.fontStyle,c,h),l==null||l.addEventListener("ready",()=>{this.markDirty()})}}getFamilyNameWithCorrectSuffix(e,i){var d;const n=e.lastIndexOf("-");if(n<0)return e;const o=(d=e.substring(n+1))==null?void 0:d.toLowerCase();if(TI.includes(o))return ba&&console.warn("Unsupported font style: "+o),e;const r=e.lastIndexOf("/");let l=e;r>=0&&(l=l.substring(r+1));const c=l[0]===l[0].toUpperCase(),h=e.substring(0,n);switch(ba&&console.log("Select font: ",e,Ni[i],l,c,h),i){case Ni.Normal:return c?h+"-Regular":h+"-regular";case Ni.Bold:return c?h+"-Bold":h+"-bold";case Ni.Italic:return c?h+"-Italic":h+"-italic";case Ni.BoldAndItalic:return c?h+"-BoldItalic":h+"-bolditalic";default:return e}}}rr([m()],ji.prototype,"alignment",void 0);rr([m()],ji.prototype,"verticalOverflow",void 0);rr([m()],ji.prototype,"horizontalOverflow",void 0);rr([m()],ji.prototype,"lineSpacing",void 0);rr([m()],ji.prototype,"supportRichText",void 0);rr([m(URL)],ji.prototype,"font",void 0);rr([m()],ji.prototype,"fontStyle",void 0);rr([m()],ji.prototype,"text",null);rr([m()],ji.prototype,"fontSize",null);class hy{constructor(t,e){a(this,"tag");a(this,"previousValues");this.tag=t,this.previousValues=e}}const TI=["medium","mediumitalic","black","blackitalic","thin","thinitalic","extrabold","light","lightitalic","semibold"];var yd;(function(s){s.singleLine="singleLine",s.hardBreaks="hardBreaks",s.flowing="flowing"})(yd||(yd={}));var Hl;(function(s){s.left="left",s.center="center",s.right="right",s.justified="justified"})(Hl||(Hl={}));var Gl;(function(s){s.top="top",s.middle="middle",s.lowerMiddle="lowerMiddle",s.baseline="baseline",s.bottom="bottom"})(Gl||(Gl={}));class ql{constructor(t){a(this,"id");a(this,"content","");a(this,"font",[]);a(this,"pointSize",144);a(this,"width");a(this,"height");a(this,"depth");a(this,"wrapMode");a(this,"horizontalAlignment");a(this,"verticalAlignment");a(this,"material");this.id=t}static getId(){return this.global_id++}setDepth(t){return this.depth=t,this}setPointSize(t){return this.pointSize=t,this}setHorizontalAlignment(t){return this.horizontalAlignment=t,this}setVerticalAlignment(t){return this.verticalAlignment=t,this}writeTo(t,e){var n;e.beginBlock(`def Preliminary_Text "${this.id}"`,"(",!1),e.appendLine('prepend apiSchemas = ["MaterialBindingAPI"]'),e.closeBlock(")"),e.beginBlock(),this.content&&e.appendLine(`string content = "${this.content}"`),(!this.font||this.font.length<=0)&&(this.font||(this.font=[]),(n=this.font)==null||n.push("sans-serif"));const i=this.font.map(o=>`"${o}"`).join(", ");e.appendLine(`string[] font = [ ${i} ]`),e.appendLine(`double pointSize = ${this.pointSize}`),typeof this.width=="number"&&e.appendLine(`double width = ${this.width}`),typeof this.height=="number"&&e.appendLine(`double height = ${this.height}`),typeof this.depth=="number"&&e.appendLine(`double depth = ${this.depth}`),this.wrapMode&&e.appendLine(`token wrapMode = "${this.wrapMode}"`),this.horizontalAlignment&&e.appendLine(`token horizontalAlignment = "${this.horizontalAlignment}"`),this.verticalAlignment&&e.appendLine(`token verticalAlignment = "${this.verticalAlignment}"`),this.material!==void 0&&e.appendLine(`rel material:binding = </StageRoot/Materials/${xm(this.material)}>`),e.closeBlock()}}a(ql,"global_id",0);class Q1{static singleLine(t,e,i){const n=new ql("text_"+ql.getId());return n.content=t,e&&(n.pointSize=e),i&&(n.depth=i),n}static multiLine(t,e,i,n,o,r){const l=new ql("text_"+ql.getId());return l.content=t,l.width=e,l.height=i,l.horizontalAlignment=n,l.verticalAlignment=o,r!==void 0&&(l.wrapMode=r),l}}const OI=new ce().makeRotationY(Math.PI),kI=new ce().makeScale(-1,1,-1);class Qb{get extensionName(){return"text"}exportText(t,e,i){const n=C.getComponent(t,ji);if(!n)return;const o=C.getComponent(t,ni);let r=100,l=100;o&&(r=o.width,l=o.height);const c=OI.clone();o&&c.premultiply(kI),e.setMatrix(c);const h=n.color.clone();e.material=new It({color:h,emissive:h}),e.addEventListener("serialize",(d,u)=>{let f=n.text;f=f.replace(/\r/g,""),f=f.replace(/\n/g,"\\n");const p=Q1.multiLine(f,r,l,Hl.center,Gl.bottom,yd.flowing);this.setTextAlignment(p,n.alignment),this.setOverflow(p,n),e.material&&(p.material=e.material),p.pointSize=this.convertToTextSize(n.fontSize),p.depth=.001,p.writeTo(void 0,d)})}convertToTextSize(t){return 1/.0502*144*t}setOverflow(t,e){e.horizontalOverflow?t.wrapMode=yd.singleLine:t.wrapMode=yd.flowing}setTextAlignment(t,e){switch(e){case fe.LowerLeft:case fe.MiddleLeft:case fe.UpperLeft:t.horizontalAlignment=Hl.left;break;case fe.LowerCenter:case fe.MiddleCenter:case fe.UpperCenter:t.horizontalAlignment=Hl.center;break;case fe.LowerRight:case fe.MiddleRight:case fe.UpperRight:t.horizontalAlignment=Hl.right;break}switch(e){case fe.LowerLeft:case fe.LowerCenter:case fe.LowerRight:t.verticalAlignment=Gl.bottom;break;case fe.MiddleLeft:case fe.MiddleCenter:case fe.MiddleRight:t.verticalAlignment=Gl.middle;break;case fe.UpperLeft:case fe.UpperCenter:case fe.UpperRight:t.verticalAlignment=Gl.top;break}}}var bt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const tw=S("debuguilayout");class Gc{constructor(){a(this,"left",0);a(this,"right",0);a(this,"top",0);a(this,"bottom",0)}get vertical(){return this.top+this.bottom}get horizontal(){return this.left+this.right}}bt([m()],Gc.prototype,"left",void 0);bt([m()],Gc.prototype,"right",void 0);bt([m()],Gc.prototype,"top",void 0);bt([m()],Gc.prototype,"bottom",void 0);var k_;(function(s){s[s.UpperLeft=0]="UpperLeft",s[s.UpperCenter=1]="UpperCenter",s[s.UpperRight=2]="UpperRight",s[s.MiddleLeft=3]="MiddleLeft",s[s.MiddleCenter=4]="MiddleCenter",s[s.MiddleRight=5]="MiddleRight",s[s.LowerLeft=6]="LowerLeft",s[s.LowerCenter=7]="LowerCenter",s[s.LowerRight=8]="LowerRight",s[s.Custom=9]="Custom"})(k_||(k_={}));var Ka;(function(s){s.Horizontal="x",s.Vertical="y"})(Ka||(Ka={}));class Cn extends j{constructor(){super(...arguments);a(this,"_rectTransform",null);a(this,"_needsUpdate",!1);a(this,"childAlignment",k_.UpperLeft);a(this,"reverseArrangement",!1);a(this,"spacing",0);a(this,"padding");a(this,"minWidth",0);a(this,"minHeight",0);a(this,"flexibleHeight",0);a(this,"flexibleWidth",0);a(this,"preferredHeight",0);a(this,"preferredWidth",0)}get rectTransform(){return this._rectTransform}onParentRectTransformChanged(e){this._needsUpdate=!0}get isDirty(){return this._needsUpdate}get isLayoutGroup(){return!0}updateLayout(){this._rectTransform&&(tw&&console.warn("Layout Update",this.context.time.frame,this.name),this._needsUpdate=!1,this.onCalculateLayout(this._rectTransform))}start(){this._needsUpdate=!0}onEnable(){tw&&console.log(this.name,this),this._rectTransform=this.gameObject.getComponent(ni);const e=this.gameObject.getComponentInParent(Bt);e&&e.registerLayoutGroup(this),this._needsUpdate=!0}onDisable(){const e=this.gameObject.getComponentInParent(Bt);e&&e.unregisterLayoutGroup(this)}set m_Spacing(e){e!==this.spacing&&(this._needsUpdate=!0,this.spacing=e)}get m_Spacing(){return this.spacing}}bt([m()],Cn.prototype,"childAlignment",void 0);bt([m()],Cn.prototype,"reverseArrangement",void 0);bt([m()],Cn.prototype,"spacing",void 0);bt([m(Gc)],Cn.prototype,"padding",void 0);bt([m()],Cn.prototype,"minWidth",void 0);bt([m()],Cn.prototype,"minHeight",void 0);bt([m()],Cn.prototype,"flexibleHeight",void 0);bt([m()],Cn.prototype,"flexibleWidth",void 0);bt([m()],Cn.prototype,"preferredHeight",void 0);bt([m()],Cn.prototype,"preferredWidth",void 0);class ia extends Cn{constructor(){super(...arguments);a(this,"childControlHeight",!0);a(this,"childControlWidth",!0);a(this,"childForceExpandHeight",!1);a(this,"childForceExpandWidth",!1);a(this,"childScaleHeight",!1);a(this,"childScaleWidth",!1)}onCalculateLayout(e){var z;const i=this.primaryAxis,n=e.width;let o=n;const r=e.height;let l=r;o-=this.padding.horizontal,l-=this.padding.vertical,i===Ka.Horizontal?this.padding.horizontal:this.padding.vertical;const c=i===Ka.Horizontal,h=c?"y":"x",d=c?this.childControlWidth:this.childControlHeight,u=c?this.childControlHeight:this.childControlWidth,f=c?this.childForceExpandWidth:this.childForceExpandHeight,p=c?this.childForceExpandHeight:this.childForceExpandWidth,g=c?l:o,_=c?n:r,y=.5*(c?this.childAlignment%3:Math.floor(this.childAlignment/3));let b=0;c?b+=this.padding.left:b+=this.padding.top;let v=0,w=0;for(let L=0;L<this.gameObject.children.length;L++){const O=this.gameObject.children[L],A=C.getComponent(O,ni);A!=null&&A.activeAndEnabled&&(w+=1,c?v+=A.width:v+=A.height)}let P=0;const E=this.spacing*(w-1);if(f||d){let L=0;c?L=o-=E:L=l-=E,w>0&&(P=L/w)}let T=0;T+=this.padding.left,T-=this.padding.right,y!==0&&(b=_-v,b*=y,b-=E*y,c?(b-=this.padding.right*y,b+=this.padding.left*(1-y),b<this.padding.left&&(b=this.padding.left)):(b-=this.padding.bottom*y,b+=this.padding.top*(1-y),b<this.padding.top&&(b=this.padding.top)));let k=1;for(let L=0;L<this.gameObject.children.length;L++){const O=this.gameObject.children[L],A=C.getComponent(O,ni);if(A!=null&&A.activeAndEnabled){(z=A.pivot)==null||z.set(.5,.5),A.anchorMin.set(0,1),A.anchorMax.set(0,1);const $=n*.5+T*.5;A.anchoredPosition.x!==$&&(A.anchoredPosition.x=$);const B=r*-.5;A.anchoredPosition.y!==B&&(A.anchoredPosition.y=B),p&&u&&A.sizeDelta[h]!==g&&(A.sizeDelta[h]=g),f&&d&&A.sizeDelta[i]!==P&&(A.sizeDelta[i]=P);const I=c?A.width:A.height,V=I*.5;if(b+=V,f){const Z=P*k-P*.5;Z>b&&(b=Z-P*.5+I+this.padding.left,b-=V)}let ie=b;i===Ka.Vertical&&(ie=-ie),A.anchoredPosition[i]!==ie&&(A.anchoredPosition[i]=ie),b+=V,b+=this.spacing,k+=1}}}}bt([m()],ia.prototype,"childControlHeight",void 0);bt([m()],ia.prototype,"childControlWidth",void 0);bt([m()],ia.prototype,"childForceExpandHeight",void 0);bt([m()],ia.prototype,"childForceExpandWidth",void 0);bt([m()],ia.prototype,"childScaleHeight",void 0);bt([m()],ia.prototype,"childScaleWidth",void 0);class Y1 extends ia{get primaryAxis(){return Ka.Vertical}}class K1 extends ia{get primaryAxis(){return Ka.Horizontal}}class J1 extends Cn{onCalculateLayout(){}}var co=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},js;(function(s){s[s.ScreenSpaceOverlay=0]="ScreenSpaceOverlay",s[s.ScreenSpaceCamera=1]="ScreenSpaceCamera",s[s.WorldSpace=2]="WorldSpace",s[s.Undefined=-1]="Undefined"})(js||(js={}));const dy=S("debuguilayout");class Bt extends Rm{constructor(){super(...arguments);a(this,"_renderOnTop");a(this,"_depthWrite",!1);a(this,"_doubleSided",!0);a(this,"_castShadows",!1);a(this,"_receiveShadows",!1);a(this,"_renderMode",js.Undefined);a(this,"_rootCanvas");a(this,"_scaleFactor",1);a(this,"worldCamera");a(this,"planeDistance",-1);a(this,"_boundRenderSettingsChanged",this.onRenderSettingsChanged.bind(this));a(this,"previousParent",null);a(this,"_lastMatrixWorld",null);a(this,"_rectTransforms",[]);a(this,"_layoutGroups",new Map);a(this,"_receivers",[]);a(this,"onBeforeRenderRoutine",()=>{var e,i,n,o;if(this.previousParent=this.gameObject.parent,((e=this.context.xr)!=null&&e.isVR||(i=this.context.xr)!=null&&i.isPassThrough)&&this.screenspace){this.gameObject.visible=!1,this.gameObject.removeFromParent();return}this.renderOnTop||this.screenspace?this.gameObject.removeFromParent():(this.onUpdateRenderMode(),this.handleLayoutUpdates(),(n=this.shadowComponent)==null||n.updateMatrixWorld(!0),(o=this.shadowComponent)==null||o.updateWorldMatrix(!0,!0),this.invokeBeforeRenderEvents(),Xi.ensureUpdateMeshUI(z0,this.context))});a(this,"onAfterRenderRoutine",()=>{var e,i,n,o,r;if(((e=this.context.xr)!=null&&e.isVR||(i=this.context.xr)!=null&&i.isPassThrough)&&this.screenspace){(n=this.previousParent)==null||n.add(this.gameObject);return}if((this.screenspace||this.renderOnTop)&&this.previousParent&&this.context.mainCamera){if(this.screenspace){const h=this.context.mainCamera;h==null||h.add(this.gameObject)}else this.previousParent.add(this.gameObject);const l=this.context.renderer.autoClear,c=this.context.renderer.autoClearColor;this.context.renderer.autoClear=!1,this.context.renderer.autoClearColor=!1,this.context.renderer.clearDepth(),this.onUpdateRenderMode(!0),this.handleLayoutUpdates(),(o=this.shadowComponent)==null||o.updateMatrixWorld(!0),this.invokeBeforeRenderEvents(),Xi.ensureUpdateMeshUI(z0,this.context,!0),this.context.renderer.render(this.gameObject,this.context.mainCamera),this.context.renderer.autoClear=l,this.context.renderer.autoClearColor=c,this.previousParent.add(this.gameObject)}(r=this._lastMatrixWorld)==null||r.copy(this.gameObject.matrixWorld)});a(this,"_updateRenderSettingsRoutine");a(this,"_activeRenderMode",-1);a(this,"_lastWidth",-1);a(this,"_lastHeight",-1)}get isCanvas(){return!0}get screenspace(){return this.renderMode!==js.WorldSpace}set renderOnTop(e){e!==this._renderOnTop&&(this._renderOnTop=e,this.onRenderSettingsChanged())}get renderOnTop(){return this._renderOnTop!==void 0?this._renderOnTop:!!(this.screenspace&&this._renderMode===js.ScreenSpaceOverlay)}set depthWrite(e){this._depthWrite!==e&&(this._depthWrite=e,this.onRenderSettingsChanged())}get depthWrite(){return this._depthWrite}set doubleSided(e){this._doubleSided!==e&&(this._doubleSided=e,this.onRenderSettingsChanged())}get doubleSided(){return this._doubleSided}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this.onRenderSettingsChanged())}get castShadows(){return this._castShadows}set receiveShadows(e){this._receiveShadows!==e&&(this._receiveShadows=e,this.onRenderSettingsChanged())}get receiveShadows(){return this._receiveShadows}get renderMode(){return this._renderMode}set renderMode(e){this._renderMode!==e&&(this._renderMode=e,this.onRenderSettingsChanged())}set rootCanvas(e){this._rootCanvas instanceof Bt||(this._rootCanvas=e)}get rootCanvas(){return this._rootCanvas}get scaleFactor(){return this._scaleFactor}set scaleFactor(e){this._scaleFactor=e}awake(){var e;this.shadowComponent=this.gameObject,this.previousParent=this.gameObject.parent,dy&&console.log("Canvas.Awake()",((e=this.previousParent)==null?void 0:e.name)+"/"+this.gameObject.name),super.awake()}start(){this.applyRenderSettings()}onEnable(){super.onEnable(),this._updateRenderSettingsRoutine=void 0,this._lastMatrixWorld=new ce,this.applyRenderSettings(),document.addEventListener("resize",this._boundRenderSettingsChanged),this.context.pre_render_callbacks.push(this.onBeforeRenderRoutine),this.context.post_render_callbacks.push(this.onAfterRenderRoutine)}onDisable(){super.onDisable(),document.removeEventListener("resize",this._boundRenderSettingsChanged);const e=this.context.pre_render_callbacks.indexOf(this.onBeforeRenderRoutine);e!==-1&&this.context.pre_render_callbacks.splice(e,1);const i=this.context.post_render_callbacks.indexOf(this.onAfterRenderRoutine);i!==-1&&this.context.post_render_callbacks.splice(i,1)}registerTransform(e){this._rectTransforms.push(e)}unregisterTransform(e){const i=this._rectTransforms.indexOf(e);i!==-1&&this._rectTransforms.splice(i,1)}registerLayoutGroup(e){const i=e.gameObject;this._layoutGroups.set(i,e)}unregisterLayoutGroup(e){const i=e.gameObject;this._layoutGroups.delete(i)}registerEventReceiver(e){this._receivers.push(e)}unregisterEventReceiver(e){const i=this._receivers.indexOf(e);i!==-1&&this._receivers.splice(i,1)}async onEnterXR(e){this.screenspace?(e.xr.isVR||e.xr.isPassThrough)&&(this.gameObject.visible=!1):(this.gameObject.visible=!1,await Jp(1).then(()=>{this.gameObject.visible=!0}))}onLeaveXR(e){this.screenspace&&(e.xr.isVR||e.xr.isPassThrough)&&(this.gameObject.visible=!0)}invokeBeforeRenderEvents(){var e;for(const i of this._receivers)(e=i.onBeforeCanvasRender)==null||e.call(i,this)}handleLayoutUpdates(){this._lastMatrixWorld===null&&(this._lastMatrixWorld=new ce);const e=!this._lastMatrixWorld.equals(this.gameObject.matrixWorld);dy&&e&&console.log("Canvas Layout changed",this.context.time.frameCount,this.name);const i=!1;for(const n of this._rectTransforms){e&&n.markDirty();let o=this._layoutGroups.get(n.gameObject);n.isDirty&&!o&&(o=n.gameObject.getComponentInParent(Cn)),(n.isDirty||o!=null&&o.isDirty)&&(dy&&!i&&console.log("CANVAS UPDATE ### "+n.name+" ##################################### "+this.context.time.frame),o==null||o.updateLayout(),n.updateTransform())}}applyRenderSettings(){this.onRenderSettingsChanged()}onRenderSettingsChanged(){this._updateRenderSettingsRoutine||(this._updateRenderSettingsRoutine=this.startCoroutine(this._updateRenderSettingsDelayed(),oe.OnBeforeRender))}*_updateRenderSettingsDelayed(){if(yield,this._updateRenderSettingsRoutine=void 0,this.shadowComponent){this.onUpdateRenderMode(),ap(this.shadowComponent,this);for(const e of C.getComponentsInChildren(this.gameObject,ms))ap(e.shadowComponent,this)}}onUpdateRenderMode(e=!1){if(!e&&this._renderMode===this._activeRenderMode&&this._lastWidth===this.context.domWidth&&this._lastHeight===this.context.domHeight)return;this._activeRenderMode=this._renderMode;let i=this.context.mainCameraComponent,n=10;switch(i&&i.nearClipPlane>0&&i.farClipPlane>0&&(n=N.lerp(i.nearClipPlane,i.farClipPlane,.01)),this._renderMode===js.ScreenSpaceCamera&&(this.worldCamera&&(i=this.worldCamera),this.planeDistance>0&&(n=this.planeDistance)),this._renderMode){case js.ScreenSpaceOverlay:case js.ScreenSpaceCamera:if(this._lastWidth=this.context.domWidth,this._lastHeight=this.context.domHeight,!i)return;const o=n+.01;this.gameObject.position.x=0,this.gameObject.position.y=0,this.gameObject.position.z=-o,this.gameObject.quaternion.identity();const r=this.gameObject.getComponent(ni);let l=!1;r.sizeDelta.x!==this.context.domWidth&&(l=!0),r.sizeDelta.y!==this.context.domHeight&&(l=!0);const c=i.fieldOfView*Math.PI/180,h=2*Math.tan(c/2)*Math.abs(o);this.gameObject.scale.x=h/this.context.domHeight,this.gameObject.scale.y=h/this.context.domHeight,this.gameObject.scale.z=.01,l&&(r.sizeDelta.x=this.context.domWidth,r.sizeDelta.y=this.context.domHeight,r==null||r.markDirty());break;case js.WorldSpace:this._lastWidth=-1,this._lastHeight=-1;break}}}co([m()],Bt.prototype,"renderOnTop",null);co([m()],Bt.prototype,"depthWrite",null);co([m()],Bt.prototype,"doubleSided",null);co([m()],Bt.prototype,"castShadows",null);co([m()],Bt.prototype,"receiveShadows",null);co([m()],Bt.prototype,"renderMode",null);co([m(Bt)],Bt.prototype,"rootCanvas",null);co([m()],Bt.prototype,"scaleFactor",null);co([m(Pe)],Bt.prototype,"worldCamera",void 0);co([m()],Bt.prototype,"planeDistance",void 0);var Yb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class nl extends j{constructor(){super(...arguments);a(this,"_alpha",1);a(this,"interactable",!0);a(this,"blocksRaycasts",!0);a(this,"_isDirty",!1);a(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(e){e!==this._alpha&&(this._alpha=e,this.markDirty())}get isCanvasGroup(){return!0}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),oe.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){this._buffer.length=0;for(const e of C.getComponentsInChildren(this.gameObject,ms,this._buffer)){const i=e;i.setAlphaFactor&&i.setAlphaFactor(this._alpha)}}}Yb([m()],nl.prototype,"alpha",null);Yb([m()],nl.prototype,"interactable",void 0);Yb([m()],nl.prototype,"blocksRaycasts",void 0);class Z1{get extensionName(){return"tmui"}onExportObject(t,e,i){const n=C.getComponent(t,Bt);if(n&&n.enabled&&n.renderMode===js.WorldSpace){const o=new Qb,r=C.getComponent(t,ni),l=C.getComponent(t,nl),c=new Array;if(r){if(!C.isActiveSelf(t)){const u=C.isActiveSelf(t);C.setActive(t,!0),r.onEnable(),r.updateTransform(),c.push(()=>{r.onDisable(),C.setActive(t,u)})}t.traverse(u=>{if(!C.isActiveInHierarchy(u)){const f=C.isActiveSelf(u);C.setActive(u,!0);const p=C.getComponent(u,ms);p&&(p.onEnable(),c.push(()=>{p.onDisable()}));const g=C.getComponent(u,ni);g&&(g.onEnable(),g.updateTransform(),g.onApplyTransform(),c.push(()=>{g.onDisable()}));const _=C.getComponent(u,ji);_&&(_.onEnable(),c.push(()=>{_.onDisable()})),c.push(()=>{C.setActive(u,f)})}}),r.width,r.height;const h=gi.createEmpty(),d=r.shadowComponent;if(e.add(h),d){const u=d.matrix;h.setMatrix(u);const f=new Map,p=new Map;f.set(d,h),p.set(d,l?l.alpha:1),d.traverse(g=>{if(g===d)return;const _=gi.createEmpty();_.setMatrix(g.matrix);const y=g.parent,b=!!y&&typeof y.textContent=="string"&&y.textContent.length>0;let v=p.get(y)||1;const w=C.getComponent(g,nl);if(w&&(v*=w.alpha),g instanceof X&&b){const E=g[fn];E?o.exportText(E.gameObject,_,i):console.error("Error when exporting UI: shadow component owner not found. This is likely a bug.",g)}if(g instanceof X&&!b){const E=g.geometry.clone();E.scale(1,1,-1),this.flipWindingOrder(E),_.geometry=E;const T=new de,k=g.material.opacity;T.copy(g.material.color),_.material=new Be({color:T,opacity:k*v,map:g.material.map,transparent:!0})}f.set(g,_),p.set(g,v);const P=f.get(y);if(!P){console.error("Error when exporting UI: shadow component parent not found!",g,g.parent);return}P.add(_)})}}for(const h of c)h()}}flipWindingOrder(t){const e=t.index.array;for(let i=0,n=e.length/3;i<n;i++){const o=e[i*3];e[i*3]=e[i*3+2],e[i*3+2]=o}t.index.needsUpdate=!0}}const Gh=S("debugusdz");function EI(s,t){var l;const e=[],i=C.getComponentsInChildren(s,ii),n=C.getComponentsInChildren(s,Yi),o=new Array,r=new Array;if(t.injectImplicitBehaviours)for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;const h=c.runtimeAnimatorController.activeState;if(!h||!h.motion||!h.motion.clip||((l=h.motion.clip.tracks)==null?void 0:l.length)<1||o.includes(c))continue;const d=new Xs;d.animator=c,d.stateName=h.name,d.trigger="start",d.name="PlayAnimationOnClick_implicitAtStart_"+d.stateName;const u=new D;C.addComponent(u,d),r.push(u),o.push(c),s.add(u)}else for(const c of i){if(!c||!c.runtimeAnimatorController||!c.enabled)continue;Gh&&console.log(c);const h=[];for(const d of c.runtimeAnimatorController.enumerateActions()){Gh&&console.log(d);const u=d.getClip();h.includes(u)||h.push(u)}e.push({root:c.gameObject,clips:h})}if(t.injectImplicitBehaviours)for(const c of n){if(!c||!c.clip||!c.enabled||!c.playAutomatically||o.includes(c))continue;const h=new Xs;h.animation=c,h.stateName=c.clip.name,h.trigger="start",h.name="PlayAnimationOnClick_implicitAtStart_"+h.stateName;const d=new D;C.addComponent(d,h),r.push(d),o.push(c),s.add(d)}else for(const c of n){Gh&&console.log(c);const h=[];for(const d of c.animations)h.includes(d)||h.push(d);e.push({root:c.gameObject,clips:h})}Gh&&(e==null?void 0:e.length)>0&&console.log("USDZ Animation Clips without behaviours",e);for(const c of e)for(const h of c.clips)t.registerAnimation(c.root,h);return r}function MI(s,t){const e=C.getComponentsInChildren(s,Oe),i=C.getComponentsInChildren(s,tl),n=new Array,o=new Array;Gh&&console.log({audioSources:e,playAudioOnClicks:i});for(const r of i){if(!r.target)continue;const l=e.indexOf(r.target);l>-1&&e.splice(l,1)}for(const r of e){if(!r||!r.clip||r.volume<=0||n.includes(r))continue;const l=new tl;l.target=r,l.name="PlayAudioOnClick_implicitAtStart_",l.trigger="start";const c=new D;C.addComponent(c,l),console.log("implicit PlayAudioOnStart",c,l),o.push(c),n.push(r),s.add(c)}return o}function AI(s){return new ti("DisableAtStart",_i.sceneStartTrigger(),Te.fadeAction(s,0,!1))}function iw(s,t){const e=s.domElement.shadowRoot.querySelector("link[rel='ar']");if(e)return e;const i=document.createElement("div");i.classList.add("menu"),i.classList.add("quicklook-menu"),i.style.display="none",i.style.visibility="hidden";const n=document.createElement("button");n.id="open-in-ar",t?(n.innerText="View in AR",n.title="View this scene in AR. The scene will be exported to USDZ and opened with Apple's QuickLook."):(n.innerText="View in AR",n.title="Download this scene for AR. Open the downloaded USDZ file to view it in AR using Apple's QuickLook."),i.appendChild(n);const o=document.createElement("a");o.id="needle-usdz-link",o.style.display="none",o.rel="ar",o.href="",o.target="_blank",i.appendChild(o);const r=document.createElement("img");return r.id="button",o.appendChild(r),s.domElement.shadowRoot.appendChild(i),o}var ri=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const tn=S("debugusdz"),II=S("debugusdzpruning");class qc{constructor(){a(this,"callToAction");a(this,"checkoutTitle");a(this,"checkoutSubtitle");a(this,"callToActionURL")}}ri([m()],qc.prototype,"callToAction",void 0);ri([m()],qc.prototype,"checkoutTitle",void 0);ri([m()],qc.prototype,"checkoutSubtitle",void 0);ri([m()],qc.prototype,"callToActionURL",void 0);const oc=class extends j{constructor(){super(...arguments);a(this,"objectToExport");a(this,"autoExportAnimations",!0);a(this,"autoExportAudioSources",!0);a(this,"exportFileName");a(this,"customUsdzFile");a(this,"customBranding");a(this,"anchoringType","plane");a(this,"maxTextureSize",2048);a(this,"planeAnchoringAlignment","horizontal");a(this,"interactive",!0);a(this,"physics",!0);a(this,"allowCreateQuicklookButton",!0);a(this,"quickLookCompatible",!0);a(this,"extensions",[]);a(this,"link");a(this,"button");a(this,"onClickedOpenInARElement",e=>{e.preventDefault(),this.exportAndOpen()});a(this,"_currentExportTasks",new Map);a(this,"_previousTimeScale",1);a(this,"lastCallback");a(this,"_rootSessionRootWasAppliedTo",null);a(this,"_rootPositionBeforeExport",new x);a(this,"_rootRotationBeforeExport",new H);a(this,"_rootScaleBeforeExport",new x)}start(){var e,i,n;tn&&(console.log("USDZExporter",this),console.log("Debug USDZ Mode. Press 'T' to export"),window.addEventListener("keydown",o=>{switch(o.key){case"t":this.exportAndOpen();break}})),this.objectToExport||(this.objectToExport=this.gameObject),!((i=(e=this.objectToExport)==null?void 0:e.children)!=null&&i.length)&&!((n=this.objectToExport)!=null&&n.isMesh)&&(this.objectToExport=this.context.scene)}onEnable(){var n;const e=K.supportsQuickLookAR(),i=K.isiOS()||K.isiPad();!this.button&&(tn||e||i)&&(this.allowCreateQuicklookButton&&(this.button=this.createQuicklookButton()),this.lastCallback=this.quicklookCallback.bind(this),this.link=iw(this.context,e),this.link.addEventListener("message",this.lastCallback)),tn&&nt("USDZ Exporter enabled: "+this.name),(n=document.getElementById("open-in-ar"))==null||n.addEventListener("click",this.onClickedOpenInARElement),$d.registerExporter(this)}onDisable(){var e,i,n;(e=this.button)==null||e.remove(),(i=this.link)==null||i.removeEventListener("message",this.lastCallback),tn&&nt("USDZ Exporter disabled: "+this.name),(n=document.getElementById("open-in-ar"))==null||n.removeEventListener("click",this.onClickedOpenInARElement),$d.unregisterExporter(this)}async exportAsync(){return this.exportAndOpen()}async exportAndOpen(){var n;let e=this.exportFileName??((n=this.objectToExport)==null?void 0:n.name)??this.name;if(e+="-"+z2(),$o()||(e!==""&&(e+="-"),e+="MadeWithNeedle"),this.link||(this.link=iw(this.context,K.supportsQuickLookAR())),this.customUsdzFile)return tn&&console.log("Exporting custom usdz",this.customUsdzFile),this.openInQuickLook(this.customUsdzFile,e),null;if(!this.objectToExport)return console.warn("No object to export",this),null;oc.beforeExport.invoke({exporter:this});const i=await this.export(this.objectToExport).finally(()=>{oc.afterExport.invoke({exporter:this})});return i?(tn&&console.log("USDZ generation done. Downloading as "+e),this.openInQuickLook(i,e),i):(console.error("USDZ generation failed. Please report a bug",this),null)}async export(e){if(!e)return console.warn("No object to export"),null;const i=this._currentExportTasks.get(e);if(i)return i;const n=this.internalExport(e);return n instanceof Promise?(this._currentExportTasks.set(e,n),n.then(o=>(this._currentExportTasks.delete(e),o)).catch(o=>(this._currentExportTasks.delete(e),console.error("Error during USDZ export â€“ please report a bug!",o),null))):n}async internalExport(e){ye.start("export-usdz",{onProgress:T=>{this.dispatchEvent(new CustomEvent("export-progress",{detail:{progress:T}}))}}),ye.report("export-usdz",{message:"Starting export",totalSteps:40,currentStep:0}),ye.report("export-usdz",{message:"Load progressive textures",autoStep:5}),ye.start("export-usdz-textures","export-usdz");const i=C.getComponentsInChildren(e,Sn);for(const T of i)T&&T.enabled&&T.updateSprite(!0);const n=C.getComponentsInChildren(e,Ve),o=new Array;let r=0;for(const T of n){for(const k of T.sharedMeshes)if(k){const z=pt.assignMeshLOD(k,0);z instanceof Promise&&o.push(new Promise((L,O)=>{z.then(()=>{r++,ye.report("export-usdz-textures",{message:"Loaded progressive mesh",currentStep:r,totalSteps:o.length}),L()}).catch(A=>O(A))}))}for(const k of T.sharedMaterials)if(k){const z=pt.assignTextureLOD(k,0);z instanceof Promise&&o.push(new Promise((L,O)=>{z.then(()=>{r++,ye.report("export-usdz-textures",{message:"Loaded progressive texture",currentStep:r,totalSteps:o.length}),L()}).catch(A=>O(A))}))}}tn&&nt("Progressive Loading: "+o.length),await Promise.all(o),tn&&nt("Progressive Loading: done"),ye.end("export-usdz-textures");const l=Ii.Global.Mask;Ii.Global.Set(Fn.AR);const c=new K2,h=new Hb(this.quickLookCompatible);let d;const u=[];this.interactive&&(u.push(new H1),u.push(new Wc),globalThis.true&&C.getComponentsInChildren(e,xe).length>0&&(this.physics?(d=new G1,u.push(d)):U()&&console.warn("USDZExporter: Physics export is disabled, but there are active Rigidbody components in the scene. They will not be exported.")),u.push(new Qb),u.push(new Z1));const f=[h,...u,...this.extensions],p={self:this,exporter:c,extensions:f,object:e};ye.report("export-usdz","Invoking before-export"),this.dispatchEvent(new CustomEvent("before-export",{detail:p})),this.applyWebARSessionRoot(),this._previousTimeScale=this.context.time.timeScale,this.context.time.timeScale=0,ye.report("export-usdz","auto export animations and audio sources");const g=new Array;this.autoExportAnimations&&g.push(...EI(e,h)),f.find(T=>T.extensionName==="Audio")&&this.autoExportAudioSources&&g.push(...MI(e)),c.debug=tn,c.pruneUnusedNodes=!II;const y=ja.instance.objs.map(T=>T.batchedMesh);c.keepObject=T=>{let k=!0;const z=C.getComponent(T,Ve);return z&&!z.enabled&&(k=!1),k&&y.includes(T)&&(k=!1),k&&C.getComponentInParent(T,_n)&&(k=!1),k&&C.getComponentInParent(T,ir)&&(k=!1),tn&&!k&&console.log("USDZExporter: Discarding object",T),k},c.beforeWritingDocument=()=>{if(U()&&h&&d){const T=h.animatedRoots;for(const k of T){const z=C.getComponentsInChildren(k,xe).filter(O=>O.enabled),L=C.getComponents(k,wn).filter(O=>O.enabled&&!O.isTrigger);(z.length>0||L.length>0)&&console.error("An animated object has physics components in its child hierarchy. This can lead to undefined behaviour due to a bug in Apple's QuickLook (FB15925487). Remove the physics components from child objects or verify that you get the expected results.",k)}}};const b=new Array;this.objectToExport&&this.quickLookCompatible&&this.interactive&&this.objectToExport.traverse(T=>{T.visible||b.push(T)});const v=f.find(T=>T.extensionName==="Behaviour");this.interactive&&v&&b.length>0&&v.addBehavior(AI(b));let w=!0;this.quickLookCompatible&&!this.interactive&&(w=!1),this.anchoringType!=="plane"&&this.anchoringType!=="none"&&this.anchoringType!=="image"&&this.anchoringType!=="face"&&(this.anchoringType="plane"),this.planeAnchoringAlignment!=="horizontal"&&this.planeAnchoringAlignment!=="vertical"&&this.planeAnchoringAlignment!=="any"&&(this.planeAnchoringAlignment="horizontal"),ye.report("export-usdz","Invoking exporter.parse");const P=await c.parse(this.objectToExport,{ar:{anchoring:{type:this.anchoringType},planeAnchoring:{alignment:this.planeAnchoringAlignment}},extensions:f,quickLookCompatible:this.quickLookCompatible,maxTextureSize:this.maxTextureSize,exportInvisible:w}),E=new Blob([P],{type:"model/vnd.usdz+zip"});this.revertWebARSessionRoot(),this.context.time.timeScale=this._previousTimeScale,ye.report("export-usdz","Invoking after-export"),this.dispatchEvent(new CustomEvent("after-export",{detail:p}));for(const T of g)C.destroy(T);return Ii.Global.Set(l),ye.end("export-usdz"),E}openInQuickLook(e,i){const n=e instanceof Blob?URL.createObjectURL(e):e,o=this.buildQuicklookOverlay();tn&&console.log("QuickLook Overlay",o);const r=o.callToAction?encodeURIComponent(o.callToAction):"",l=o.checkoutTitle?encodeURIComponent(o.checkoutTitle):"",c=o.checkoutSubtitle?encodeURIComponent(o.checkoutSubtitle):"";this.link.href=n+`#callToAction=${r}&checkoutTitle=${l}&checkoutSubtitle=${c}&callToActionURL=${o.callToActionURL}`,this.lastCallback||(this.lastCallback=this.quicklookCallback.bind(this),this.link.addEventListener("message",this.lastCallback)),this.link.download=i+".usdz",this.link.click()}download(e,i){oc.save(e,i)}static save(e,i){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),typeof e=="string"?n.href=e:n.href=URL.createObjectURL(e),n.download=i,n.click(),n.remove()}quicklookCallback(e){if((e==null?void 0:e.data)=="_apple_ar_quicklook_button_tapped"){tn&&ke("Quicklook closed via call to action button");var i=new CustomEvent("quicklook-button-tapped",{detail:this});if(this.dispatchEvent(i),!i.defaultPrevented){const n=new URLSearchParams(this.link.href);if(n){const o=n.get("callToActionURL");tn&&nt("Quicklook url: "+o),o&&($o()?globalThis.open(o,"_blank"):console.warn("Quicklook closed: custom redirects require a Needle Engine Pro license: https://needle.tools/pricing",o))}}}}buildQuicklookOverlay(){var n,o,r,l,c,h;const e={};return this.customBranding&&Object.assign(e,this.customBranding),$o()||(console.log("Custom Quicklook banner text requires pro license: https://needle.tools/pricing"),e.callToAction="Close",e.checkoutTitle="ðŸŒµ Made with Needle",e.checkoutSubtitle="_"),(((n=e.callToAction)==null?void 0:n.length)||((o=e.checkoutTitle)==null?void 0:o.length)||((r=e.checkoutSubtitle)==null?void 0:r.length))&&((l=e.callToAction)!=null&&l.length||(e.callToAction="\0"),(c=e.checkoutTitle)!=null&&c.length||(e.checkoutTitle="\0"),(h=e.checkoutSubtitle)!=null&&h.length||(e.checkoutSubtitle="\0")),this.dispatchEvent(new CustomEvent("quicklook-overlay",{detail:e})),e}getARScaleAndTarget(){if(!this.objectToExport)return{scale:1,_invertForward:!1,target:this.gameObject,sessionRoot:null};const e=C.findObjectOfType(Je);let i=C.getComponentInParent(this.objectToExport,ss);i||(i=C.getComponentInChildren(this.objectToExport,ss));let n=1,o=!1;const r=this.objectToExport;return e?n=e.arScale:i&&(n=i.arScale,o=i.invertForward),{scale:1/n,_invertForward:o,target:r,sessionRoot:(i==null?void 0:i.gameObject)??null}}applyWebARSessionRoot(){if(!this.objectToExport)return;const{scale:e,_invertForward:i,target:n,sessionRoot:o}=this.getARScaleAndTarget(),r=o==null?void 0:o.matrixWorld.clone().invert();this._rootSessionRootWasAppliedTo=n,this._rootPositionBeforeExport.copy(n.position),this._rootRotationBeforeExport.copy(n.quaternion),this._rootScaleBeforeExport.copy(n.scale),n.scale.multiplyScalar(e),i&&n.quaternion.multiply(oc.invertForwardQuaternion),n.updateMatrix(),n.updateMatrixWorld(!0),o&&r&&n.matrix.premultiply(r)}revertWebARSessionRoot(){if(!this.objectToExport||!this._rootSessionRootWasAppliedTo)return;const e=this._rootSessionRootWasAppliedTo;e.position.copy(this._rootPositionBeforeExport),e.quaternion.copy(this._rootRotationBeforeExport),e.scale.copy(this._rootScaleBeforeExport),e.updateMatrix(),e.updateMatrixWorld(!0),this._rootSessionRootWasAppliedTo=null}createQuicklookButton(){const i=$r.getOrCreate().createQuicklookButton();return i.parentNode||this.context.menu.appendChild(i),i}};let De=oc;a(De,"beforeExport",new we),a(De,"afterExport",new we),a(De,"invertForwardMatrix",new ce().makeRotationY(Math.PI)),a(De,"invertForwardQuaternion",new H().setFromEuler(new Ct(0,Math.PI,0)));ri([m(D)],De.prototype,"objectToExport",void 0);ri([m()],De.prototype,"autoExportAnimations",void 0);ri([m()],De.prototype,"autoExportAudioSources",void 0);ri([m()],De.prototype,"exportFileName",void 0);ri([m(URL)],De.prototype,"customUsdzFile",void 0);ri([m(qc)],De.prototype,"customBranding",void 0);ri([m()],De.prototype,"anchoringType",void 0);ri([m()],De.prototype,"maxTextureSize",void 0);ri([m()],De.prototype,"planeAnchoringAlignment",void 0);ri([m()],De.prototype,"interactive",void 0);ri([m()],De.prototype,"physics",void 0);ri([m()],De.prototype,"allowCreateQuicklookButton",void 0);ri([m()],De.prototype,"quickLookCompatible",void 0);var Kb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},E_;(function(s){s[s.Linear=1]="Linear",s[s.Exponential=2]="Exponential",s[s.ExponentialSquared=3]="ExponentialSquared"})(E_||(E_={}));class pu extends j{constructor(){super(...arguments);a(this,"_fog")}get fog(){return this._fog||(this._fog=new Bw(0,0,50)),this._fog}get mode(){return E_.Linear}set near(e){this.fog.near=e}get near(){return this.fog.near}set far(e){this.fog.far=e}get far(){return this.fog.far}set color(e){this.fog.color.copy(e)}get color(){return this.fog.color}onEnable(){this.scene.fog=this.fog}onDisable(){this.scene.fog===this._fog&&(this.scene.fog=null)}}Kb([m()],pu.prototype,"near",null);Kb([m()],pu.prototype,"far",null);Kb([m(de)],pu.prototype,"color",null);var Jb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Xc extends j{constructor(){super(...arguments);a(this,"objectBounds",!1);a(this,"color");a(this,"isGizmo",!0);a(this,"_gizmoObject",null);a(this,"_boxHelper",null)}onEnable(){this.isGizmo&&!iu||(this._gizmoObject||(this.objectBounds?this._gizmoObject=new LR(this.gameObject,this.color??16776960):(this.objectBounds=!1,this._gizmoObject=vb(this.color??16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),oe.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var e;for(;this._boxHelper;)(e=this._boxHelper)==null||e.update(),yield}}Jb([m()],Xc.prototype,"objectBounds",void 0);Jb([m(de)],Xc.prototype,"color",void 0);Jb([m()],Xc.prototype,"isGizmo",void 0);var Zb=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class mu extends j{constructor(){super(...arguments);a(this,"isGizmo",!1);a(this,"color0");a(this,"color1");a(this,"gridHelper");a(this,"size");a(this,"divisions");a(this,"offset")}onEnable(){if(this.isGizmo&&!iu)return;const e=this.size,i=this.divisions;this.gridHelper||(this.gridHelper=new q_(e,i,this.color0??new de(.4,.4,.4),this.color1??new de(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset)),this.gridHelper&&this.gameObject.add(this.gridHelper)}onDisable(){this.gridHelper&&(this.gameObject.remove(this.gridHelper),this.gridHelper=null)}}Zb([m()],mu.prototype,"isGizmo",void 0);Zb([m(de)],mu.prototype,"color0",void 0);Zb([m(de)],mu.prototype,"color1",void 0);var e0=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class t0 extends j{constructor(){super(...arguments);a(this,"connectedBody");a(this,"_rigidBody",null)}get rigidBody(){return this._rigidBody}onEnable(){this._rigidBody||(this._rigidBody=this.gameObject.getComponent(xe)),this.rigidBody&&this.connectedBody&&this.startCoroutine(this.create())}*create(){yield,this.rigidBody&&this.connectedBody&&this.activeAndEnabled&&this.createJoint(this.rigidBody,this.connectedBody)}}e0([m(xe)],t0.prototype,"connectedBody",void 0);class eP extends t0{createJoint(t,e){var i;(i=this.context.physics.engine)==null||i.addFixedJoint(t,e)}}class Om extends t0{constructor(){super(...arguments);a(this,"anchor");a(this,"axis")}createJoint(e,i){var n;this.axis&&this.anchor&&((n=this.context.physics.engine)==null||n.addHingeJoint(e,i,this.anchor,this.axis))}}e0([m(x)],Om.prototype,"anchor",void 0);e0([m(x)],Om.prototype,"axis",void 0);var ho=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};function uy(s){return s*Math.PI/180}const nw=300,fr=S("debuglights");var Ro;(function(s){s[s.Spot=0]="Spot",s[s.Directional=1]="Directional",s[s.Point=2]="Point",s[s.Area=3]="Area",s[s.Rectangle=3]="Rectangle",s[s.Disc=4]="Disc"})(Ro||(Ro={}));var _p;(function(s){s[s.Realtime=4]="Realtime",s[s.Baked=2]="Baked",s[s.Mixed=1]="Mixed"})(_p||(_p={}));var _d;(function(s){s[s.None=0]="None",s[s.Hard=1]="Hard",s[s.Soft=2]="Soft"})(_d||(_d={}));class Ji extends j{constructor(){super(...arguments);a(this,"type",0);a(this,"range",1);a(this,"spotAngle",1);a(this,"innerSpotAngle",1);a(this,"_color",new de(16777215));a(this,"_shadowNearPlane",.1);a(this,"_shadowBias",0);a(this,"_shadowNormalBias",0);a(this,"_overrideShadowBiasSettings",!1);a(this,"_shadows",1);a(this,"lightmapBakeType",_p.Realtime);a(this,"_intensity",-1);a(this,"_shadowDistance");a(this,"shadowWidth");a(this,"shadowHeight");a(this,"_shadowResolution");a(this,"light");a(this,"_webXRStartedListener");a(this,"_webXREndedListener");a(this,"_webARRoot")}set color(e){this._color=e,this.light!==void 0&&(this.light.color=e)}get color(){return this.light?this.light.color:this._color}set shadowNearPlane(e){var i,n;if(e!==this._shadowNearPlane&&(this._shadowNearPlane=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.camera)!==void 0)){const o=this.light.shadow.camera;o.near=e}}get shadowNearPlane(){return this._shadowNearPlane}set shadowBias(e){var i,n;e!==this._shadowBias&&(this._shadowBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.bias)!==void 0&&(this.light.shadow.bias=e,this.light.shadow.needsUpdate=!0))}get shadowBias(){return this._shadowBias}set shadowNormalBias(e){var i,n;e!==this._shadowNormalBias&&(this._shadowNormalBias=e,((n=(i=this.light)==null?void 0:i.shadow)==null?void 0:n.normalBias)!==void 0&&(this.light.shadow.normalBias=e,this.light.shadow.needsUpdate=!0))}get shadowNormalBias(){return this._shadowNormalBias}set shadows(e){this._shadows=e,this.light&&(this.light.castShadow=e!==_d.None,this.updateShadowSoftHard())}get shadows(){return this._shadows}set intensity(e){var i;if(this._intensity=e,this.light){let n=1;if(this.context.isInXR&&this._webARRoot){const o=(i=this._webARRoot)==null?void 0:i.arScale;typeof o=="number"&&o>0&&(n/=o)}this.light.intensity=e*n}fr&&console.log("Set light intensity to "+this._intensity,e,this)}get intensity(){return this._intensity}get shadowDistance(){const e=this.light;return e!=null&&e.shadow?e.shadow.camera.far:-1}set shadowDistance(e){this._shadowDistance=e;const i=this.light;if(i!=null&&i.shadow){const n=i.shadow.camera;n.far=e,n.updateProjectionMatrix()}}get shadowResolution(){const e=this.light;return e!=null&&e.shadow?e.shadow.mapSize.x:-1}set shadowResolution(e){if(e===this._shadowResolution)return;this._shadowResolution=e;const i=this.light;i!=null&&i.shadow&&(i.shadow.mapSize.set(e,e),i.shadow.needsUpdate=!0)}get isBaked(){return this.lightmapBakeType===_p.Baked}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(e){return this.light?this.type===Ro.Directional?this.light.getWorldPosition(e).multiplyScalar(1):this.light.getWorldPosition(e):e}awake(){this.color=new de(this.color??16777215),fr&&console.log(this.name,this)}onEnable(){fr&&console.log("ENABLE LIGHT",this.name),this.createLight(),!this.isBaked&&(this.light&&(this.light.visible=!0,this.light.intensity=this._intensity,fr&&console.log("Set light intensity to "+this.light.intensity,this.name),this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===Ro.Directional&&this.startCoroutine(this.updateMainLightRoutine(),oe.LateUpdate))}onDisable(){fr&&console.log("DISABLE LIGHT",this.name),this.light&&(this.selfIsLight?this.light.intensity=0:this.light.visible=!1)}onEnterXR(e){this._webARRoot=C.getComponentInParent(this.gameObject,ss)??void 0}onLeaveXR(e){}createLight(){const e=this.selfIsLight;if(e&&!this.light)switch(this.light=this.gameObject,this.light.name=this.name,this._intensity=this.light.intensity,this.type){case Ro.Directional:this.setDirectionalLight(this.light);break}else if(!this.light)switch(this.type){case Ro.Directional:const i=new Ty(this.color,this.intensity*Math.PI);if(i.position.set(0,0,-nw*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(i.target),Cc(i.target,0,0,0),this.light=i,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),fr){const l=new BR(this.light,.2,this.color);this.context.scene.add(l)}break;case Ro.Spot:const n=new jR(this.color,this.intensity*Math.PI,this.range,uy(this.spotAngle/2),1-uy(this.innerSpotAngle/2)/uy(this.spotAngle/2),2);n.position.set(0,0,0),n.rotation.set(0,0,0),this.light=n;const o=n.target;n.add(o),o.position.set(0,0,this.range),o.rotation.set(0,0,0);break;case Ro.Point:const r=new X_(this.color,this.intensity*Math.PI,this.range);this.light=r;break}if(this.light){if(this._intensity>=0?this.light.intensity=this._intensity:this._intensity=this.light.intensity,this.shadows!==_d.None?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow){this._shadowResolution!==void 0&&this._shadowResolution>4?(this.light.shadow.mapSize.width=this._shadowResolution,this.light.shadow.mapSize.height=this._shadowResolution):(this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048),fr&&console.log("Override shadow bias?",this._overrideShadowBiasSettings,this.shadowBias,this.shadowNormalBias),this.light.shadow.bias=this.shadowBias,this.light.shadow.normalBias=this.shadowNormalBias,this.updateShadowSoftHard();const i=this.light.shadow.camera;if(i.near=this.shadowNearPlane,this._shadowDistance!==void 0&&typeof this._shadowDistance=="number"?i.far=this._shadowDistance:i.far=nw*Math.abs(this.gameObject.scale.z),this.gameObject.scale.set(1,1,1),this.shadowWidth!==void 0)i.left=-this.shadowWidth/2,i.right=this.shadowWidth/2;else{const n=this.gameObject.scale.x;i.left*=n,i.right*=n}if(this.shadowHeight!==void 0)i.top=this.shadowHeight/2,i.bottom=-this.shadowHeight/2;else{const n=this.gameObject.scale.y;i.top*=n,i.bottom*=n}this.light.shadow.needsUpdate=!0,fr&&this.context.scene.add(new FR(i))}this.isBaked?this.light.removeFromParent():e||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===Ro.Directional&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}updateShadowSoftHard(){this.light&&this.light.shadow&&(this.shadows===_d.Soft||(this.light.shadow.radius=1,this.light.shadow.blurSamples=1))}setDirectionalLight(e){e.add(e.target),e.target.position.set(0,0,-1)}}a(Ji,"allowChangingRendererShadowMapType",!0);ho([m()],Ji.prototype,"type",void 0);ho([m(de)],Ji.prototype,"color",null);ho([m()],Ji.prototype,"shadowNearPlane",null);ho([m()],Ji.prototype,"shadowBias",null);ho([m()],Ji.prototype,"shadowNormalBias",null);ho([m()],Ji.prototype,"shadows",null);ho([m()],Ji.prototype,"lightmapBakeType",void 0);ho([m()],Ji.prototype,"intensity",null);ho([m()],Ji.prototype,"shadowDistance",null);ho([m()],Ji.prototype,"shadowResolution",null);new x(0,0,0);var gu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const fy=S("debuglods"),DI=S("nolods");var M_;(function(s){s[s.None=0]="None",s[s.CrossFade=1]="CrossFade",s[s.SpeedTree=2]="SpeedTree"})(M_||(M_={}));class yu{constructor(){a(this,"screenRelativeTransitionHeight");a(this,"distance");a(this,"renderers")}}gu([m()],yu.prototype,"screenRelativeTransitionHeight",void 0);gu([m()],yu.prototype,"distance",void 0);gu([m(Ve)],yu.prototype,"renderers",void 0);class LI{constructor(t){a(this,"model");this.model=t}get renderers(){return this.model.renderers}}class km extends j{constructor(){super(...arguments);a(this,"fadeMode",M_.None);a(this,"localReferencePoint");a(this,"lodCount",0);a(this,"size",0);a(this,"animateCrossFading",!1);a(this,"lodModels");a(this,"_lods",[]);a(this,"_settings",[]);a(this,"_lodsHandler");a(this,"_distanceFactor",1)}start(){if(fy&&console.log("LODGROUP",this.name,this.lodModels,this),!DI&&!this._lodsHandler&&this.gameObject&&this.lodModels&&Array.isArray(this.lodModels)){const e=[];for(const n of this.lodModels){const o=new LI(n);this._lods.push(o);for(const r of o.renderers)e.includes(r)||e.push(r)}this._lodsHandler=new Array;for(let n=0;n<e.length;n++){const o=new zR;this._lodsHandler.push(o),this.gameObject.add(o)}const i=new D;i.name="Cull "+this.name;for(let n=0;n<e.length;n++){const o=e[n],r=this._lodsHandler[n],l=o.gameObject;fy&&console.log(n,l.name);for(const c of this._lods){const h=c.model.distance;let d=null;if(c.renderers.includes(o)?d=l:d=i,d.type==="Group"){console.warn(`LODGroup ${this.name}: Group or MultiMaterial object's are not supported as LOD object: ${d.name}`);continue}fy&&console.log("LEVEL",d.name,h),r.autoUpdate=!1,this.onAddLodLevel(r,d,c.model.distance)}}}}onAfterRender(){if(!this.gameObject||!this._lodsHandler)return;const e=this.context.mainCamera;if(e)for(const i of this._lodsHandler){i.update(e);const n=i.getCurrentLevel(),o=i.levels[n];i.layers.mask=o.object.layers.mask}}onAddLodLevel(e,i,n){if(i===this.gameObject){console.warn("LODGroup component must be on parent object and not mesh directly at the moment",i.name,i);return}e.addLevel(i,n*this._distanceFactor,.01);const o={lod:e,levelIndex:e.levels.length-1,distance:n};this._settings.push(o)}distanceFactor(e){if(e!==this._distanceFactor){this._distanceFactor=e;for(const i of this._settings){const n=i.lod.levels[i.levelIndex];n.distance=i.distance*e}}}}gu([m(x)],km.prototype,"localReferencePoint",void 0);gu([m(yu)],km.prototype,"lodModels",void 0);var tP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const rf=S("debugnestedgltf");class Em extends j{constructor(){super(...arguments);a(this,"filePath");a(this,"loaded",new we);a(this,"loadAssetInParent",!0);a(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(e){var i;(i=this.filePath)==null||i.beginListenDownload(e)}preload(){var e;return((e=this.filePath)==null?void 0:e.preload())||null}async start(){var i,n,o,r,l;if(this._isLoadingOrDoneLoading)return;rf&&console.log(this,this.guid);const e=this.gameObject.parent;if(e&&this.filePath){this._isLoadingOrDoneLoading=!0;const c=new lo;c.idProvider=new yi(this.hash(this.guid)),c.parent=this.loadAssetInParent!==!1?e:this.gameObject,this.gameObject.updateMatrix();const h=this.gameObject.matrix;rf&&console.log("Load nested:",((i=this.filePath)==null?void 0:i.url)??this.filePath,this.gameObject.position);const d=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));rf&&console.log("Nested loaded:",((r=this.filePath)==null?void 0:r.url)??this.filePath,d),d&&this.loadAssetInParent!==!1&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0,d.layers.disableAll(),d.layers.set(this.layer),this.loaded.invoke({component:this,instance:d,asset:this.filePath})),rf&&console.log("Nested loading done:",((l=this.filePath)==null?void 0:l.url)??this.filePath,d)}}onDestroy(){var e;(e=this.filePath)==null||e.unload()}hash(e){let i=0;for(let n=0;n<e.length;n++)i=e.charCodeAt(n)+((i<<5)-i);return i}}tP([m(he)],Em.prototype,"filePath",void 0);tP([m(we)],Em.prototype,"loaded",void 0);var i0=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const jI=S("debugnet");class Xr extends j{constructor(){super(...arguments);a(this,"url",null);a(this,"urlParameterName",null);a(this,"localhost",null)}awake(){jI&&console.log(this),this.context.connection.registerProvider(this)}getWebsocketUrl(){let e=this.url?Xr.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const r=S(this.urlParameterName);r&&typeof r=="string"&&(e=r)}if(!e)return null;const n=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(e);return n!=null&&n.groups?(n==null?void 0:n.groups.socket_prefix)?e:"wss://"+(n==null?void 0:n.groups.url):null}static GetUrl(e,i){let n=e;const o=Xr.IsLocalNetwork()&&i;if(o&&(n=i),e!=null&&e.startsWith("/")){const r=o?n:window.location.origin;r!=null&&r.endsWith("/")&&e.startsWith("/")&&(e=e.substring(1)),n=r+e}return n}static IsLocalNetwork(e=window.location.hostname){return fs(e)}}i0([m()],Xr.prototype,"url",void 0);i0([m()],Xr.prototype,"urlParameterName",void 0);i0([m()],Xr.prototype,"localhost",void 0);var Mm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Qc extends j{constructor(){super(...arguments);a(this,"referenceSpace");a(this,"from");a(this,"affectPosition",!1);a(this,"affectRotation",!1);a(this,"alignLookDirection",!1);a(this,"levelLookDirection",!1);a(this,"levelPosition",!1);a(this,"positionOffset",new x(0,0,0));a(this,"rotationOffset",new x(0,0,0));a(this,"offset",new x(0,0,0))}update(){if(!this.from)return;var e=ae(this.from),i=Le(this.from);this.offset.copy(this.positionOffset);const n=this.offset.length();if(this.referenceSpace&&this.offset.transformDirection(this.referenceSpace.matrixWorld).multiplyScalar(n),e.add(this.offset),this.levelPosition&&this.referenceSpace){const c=new Za(this.gameObject.up,0),h=ae(this.referenceSpace);c.setFromNormalAndCoplanarPoint(this.gameObject.up,h);const d=new x(0,0,0);c.projectPoint(e,d),e.copy(d)}this.affectPosition&&ei(this.gameObject,e);const o=new Ct(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),r=new H().setFromEuler(o);this.affectRotation&&no(this.gameObject,i.multiply(r));const l=new x;this.from.getWorldDirection(l).multiplyScalar(50),this.levelLookDirection&&(l.y=0),this.alignLookDirection&&this.gameObject.lookAt(l)}}Mm([m(C)],Qc.prototype,"referenceSpace",void 0);Mm([m(C)],Qc.prototype,"from",void 0);Mm([m(x)],Qc.prototype,"positionOffset",void 0);Mm([m(x)],Qc.prototype,"rotationOffset",void 0);const iP=Math.sqrt(5),BI=(iP-1)/4,Ht=(5-iP)/20,af=s=>Math.floor(s)|0,lf=new Float64Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]);function FI(s=Math.random){const t=zI(s),e=new Float64Array(t).map(r=>lf[r%32*4]),i=new Float64Array(t).map(r=>lf[r%32*4+1]),n=new Float64Array(t).map(r=>lf[r%32*4+2]),o=new Float64Array(t).map(r=>lf[r%32*4+3]);return function(l,c,h,d){let u,f,p,g,_;const y=(l+c+h+d)*BI,b=af(l+y),v=af(c+y),w=af(h+y),P=af(d+y),E=(b+v+w+P)*Ht,T=b-E,k=v-E,z=w-E,L=P-E,O=l-T,A=c-k,$=h-z,B=d-L;let I=0,V=0,ie=0,Z=0;O>A?I++:V++,O>$?I++:ie++,O>B?I++:Z++,A>$?V++:ie++,A>B?V++:Z++,$>B?ie++:Z++;const J=I>=3?1:0,ue=V>=3?1:0,Ae=ie>=3?1:0,He=Z>=3?1:0,ai=I>=2?1:0,Wt=V>=2?1:0,Zi=ie>=2?1:0,en=Z>=2?1:0,xi=I>=1?1:0,xs=V>=1?1:0,pa=ie>=1?1:0,Me=Z>=1?1:0,Sl=O-J+Ht,rh=A-ue+Ht,Ym=$-Ae+Ht,Km=B-He+Ht,Jm=O-ai+2*Ht,Zm=A-Wt+2*Ht,eg=$-Zi+2*Ht,tg=B-en+2*Ht,ig=O-xi+3*Ht,ng=A-xs+3*Ht,sg=$-pa+3*Ht,og=B-Me+3*Ht,rg=O-1+4*Ht,ag=A-1+4*Ht,lg=$-1+4*Ht,cg=B-1+4*Ht,ah=b&255,lh=v&255,ch=w&255,hh=P&255;let dh=.6-O*O-A*A-$*$-B*B;if(dh<0)u=0;else{const Ge=ah+t[lh+t[ch+t[hh]]];dh*=dh,u=dh*dh*(e[Ge]*O+i[Ge]*A+n[Ge]*$+o[Ge]*B)}let uh=.6-Sl*Sl-rh*rh-Ym*Ym-Km*Km;if(uh<0)f=0;else{const Ge=ah+J+t[lh+ue+t[ch+Ae+t[hh+He]]];uh*=uh,f=uh*uh*(e[Ge]*Sl+i[Ge]*rh+n[Ge]*Ym+o[Ge]*Km)}let fh=.6-Jm*Jm-Zm*Zm-eg*eg-tg*tg;if(fh<0)p=0;else{const Ge=ah+ai+t[lh+Wt+t[ch+Zi+t[hh+en]]];fh*=fh,p=fh*fh*(e[Ge]*Jm+i[Ge]*Zm+n[Ge]*eg+o[Ge]*tg)}let ph=.6-ig*ig-ng*ng-sg*sg-og*og;if(ph<0)g=0;else{const Ge=ah+xi+t[lh+xs+t[ch+pa+t[hh+Me]]];ph*=ph,g=ph*ph*(e[Ge]*ig+i[Ge]*ng+n[Ge]*sg+o[Ge]*og)}let mh=.6-rg*rg-ag*ag-lg*lg-cg*cg;if(mh<0)_=0;else{const Ge=ah+1+t[lh+1+t[ch+1+t[hh+1]]];mh*=mh,_=mh*mh*(e[Ge]*rg+i[Ge]*ag+n[Ge]*lg+o[Ge]*cg)}return 27*(u+f+p+g+_)}}function zI(s){const e=new Uint8Array(512);for(let i=0;i<512/2;i++)e[i]=i;for(let i=0;i<512/2-1;i++){const n=i+~~(s()*(256-i)),o=e[i];e[i]=e[n],e[n]=o}for(let i=256;i<512;i++)e[i]=e[i-256];return e}var na=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class gn{constructor(t=0,e=0){a(this,"time",0);a(this,"value",0);a(this,"inTangent",1/0);a(this,"inWeight");a(this,"outTangent",1/0);a(this,"outWeight");a(this,"weightedMode");this.time=t,this.value=e}}na([m()],gn.prototype,"time",void 0);na([m()],gn.prototype,"value",void 0);na([m()],gn.prototype,"inTangent",void 0);na([m()],gn.prototype,"inWeight",void 0);na([m()],gn.prototype,"outTangent",void 0);na([m()],gn.prototype,"outWeight",void 0);na([m()],gn.prototype,"weightedMode",void 0);class Qs{constructor(){a(this,"keys",[])}static linearFromTo(t,e,i){const n=new Qs,o=new gn;o.time=0,o.value=t;const r=new gn;return r.time=i,r.value=e,n.keys.push(o,r),n}static constant(t){const e=new Qs,i=new gn;return i.time=0,i.value=t,e.keys.push(i),e}clone(){var e;const t=new Qs;return t.keys=((e=this.keys)==null?void 0:e.map(i=>{const n=new gn;return n.time=i.time,n.value=i.value,n.inTangent=i.inTangent,n.inWeight=i.inWeight,n.outTangent=i.outTangent,n.outWeight=i.outWeight,n.weightedMode=i.weightedMode,n}))||[],t}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(t){if(!this.keys||this.keys.length==0)return 0;if(this.keys.length===1)return this.keys[0].value;if(this.keys[0].time>=t)return this.keys[0].value;for(let e=0;e<this.keys.length;e++){const i=this.keys[e];if(i.time<=t)if(e+1<this.keys.length){const o=this.keys[e+1];if(o.time<t)continue;return!isFinite(i.outTangent)||!isFinite(o.inTangent)?i.value:Qs.interpolateValue(t,i,o)}else return i.value}return this.keys[this.keys.length-1].value}static interpolateValue(t,e,i){const n=e.time,o=e.value,r=e.outTangent,l=i.time,c=i.value,h=i.inTangent,d=l-n,u=d*d,f=u*d,p=((r+h)*d-2*(c-o))/f,g=(3*(c-o)-(h+2*r)*d)/u,_=r,y=o,b=t-n,v=b*b,w=v*b;return p*w+g*v+_*b+y}}na([m(gn)],Qs.prototype,"keys",void 0);var R=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const cf=S("debugparticles");var zs;(function(s){s[s.Billboard=0]="Billboard",s[s.Stretch=1]="Stretch",s[s.HorizontalBillboard=2]="HorizontalBillboard",s[s.VerticalBillboard=3]="VerticalBillboard",s[s.Mesh=4]="Mesh"})(zs||(zs={}));class Yc{constructor(){a(this,"alphaKeys",[]);a(this,"colorKeys",[])}get duration(){return 1}evaluate(t,e){let i,n=0,o=null,r=0;for(let l=0;l<this.alphaKeys.length;l++){const c=this.alphaKeys[l];(c.time<t||!i)&&(i=c,n=l)}for(let l=0;l<this.colorKeys.length;l++){const c=this.colorKeys[l];(c.time<t||!o)&&(o=c,r=l)}if(o)if(r+1<this.colorKeys.length){const c=this.colorKeys[r+1],h=N.remap(t,o.time,c.time,0,1);e.r=N.lerp(o.color.r,c.color.r,h),e.g=N.lerp(o.color.g,c.color.g,h),e.b=N.lerp(o.color.b,c.color.b,h)}else e.r=o.color.r,e.g=o.color.g,e.b=o.color.b;if(i)if(n+1<this.alphaKeys.length){const c=this.alphaKeys[n+1],h=N.remap(t,i.time,c.time,0,1);e.alpha=N.lerp(i.alpha,c.alpha,h)}else e.alpha=i.alpha;return e}}R([m()],Yc.prototype,"alphaKeys",void 0);R([m()],Yc.prototype,"colorKeys",void 0);var ft;(function(s){s[s.Constant=0]="Constant",s[s.Curve=1]="Curve",s[s.TwoCurves=2]="TwoCurves",s[s.TwoConstants=3]="TwoConstants"})(ft||(ft={}));var Es;(function(s){s[s.Color=0]="Color",s[s.Gradient=1]="Gradient",s[s.TwoColors=2]="TwoColors",s[s.TwoGradients=3]="TwoGradients",s[s.RandomColor=4]="RandomColor"})(Es||(Es={}));var ds;(function(s){s[s.Local=0]="Local",s[s.World=1]="World",s[s.Custom=2]="Custom"})(ds||(ds={}));var Ti;(function(s){s[s.Sphere=0]="Sphere",s[s.SphereShell=1]="SphereShell",s[s.Hemisphere=2]="Hemisphere",s[s.HemisphereShell=3]="HemisphereShell",s[s.Cone=4]="Cone",s[s.Box=5]="Box",s[s.Mesh=6]="Mesh",s[s.ConeShell=7]="ConeShell",s[s.ConeVolume=8]="ConeVolume",s[s.ConeVolumeShell=9]="ConeVolumeShell",s[s.Circle=10]="Circle",s[s.CircleEdge=11]="CircleEdge",s[s.SingleSidedEdge=12]="SingleSidedEdge",s[s.MeshRenderer=13]="MeshRenderer",s[s.SkinnedMeshRenderer=14]="SkinnedMeshRenderer",s[s.BoxShell=15]="BoxShell",s[s.BoxEdge=16]="BoxEdge",s[s.Donut=17]="Donut",s[s.Rectangle=18]="Rectangle",s[s.Sprite=19]="Sprite",s[s.SpriteRenderer=20]="SpriteRenderer"})(Ti||(Ti={}));var ka;(function(s){s[s.Random=0]="Random",s[s.Loop=1]="Loop",s[s.PingPong=2]="PingPong",s[s.BurstSpread=3]="BurstSpread"})(ka||(ka={}));class Q{constructor(){a(this,"mode","Constant");a(this,"constant");a(this,"constantMin");a(this,"constantMax");a(this,"curve");a(this,"curveMin");a(this,"curveMax");a(this,"curveMultiplier")}static constant(t){const e=new Q;return e.setConstant(t),e}static betweenTwoConstants(t,e){const i=new Q;return i.setMinMaxConstant(t,e),i}static curve(t,e=1){const i=new Q;return i.setCurve(t,e),i}setConstant(t){this.mode=ft.Constant,this.constant=t}setMinMaxConstant(t,e){this.mode=ft.TwoConstants,this.constantMin=t,this.constantMax=e}setCurve(t,e=1){this.mode=ft.Curve,this.curve=t,this.curveMultiplier=e}clone(){var e,i,n;const t=new Q;return t.mode=this.mode,t.constant=this.constant,t.constantMin=this.constantMin,t.constantMax=this.constantMax,t.curve=(e=this.curve)==null?void 0:e.clone(),t.curveMin=(i=this.curveMin)==null?void 0:i.clone(),t.curveMax=(n=this.curveMax)==null?void 0:n.clone(),t.curveMultiplier=this.curveMultiplier,t}evaluate(t,e){const i=e===void 0?Math.random():e;switch(this.mode){case ft.Constant:case"Constant":return this.constant;case ft.Curve:case"Curve":return t=N.clamp01(t),this.curve.evaluate(t)*this.curveMultiplier;case ft.TwoCurves:case"TwoCurves":const n=t*this.curveMin.duration,o=t*this.curveMax.duration;return N.lerp(this.curveMin.evaluate(n),this.curveMax.evaluate(o),i%1)*this.curveMultiplier;case ft.TwoConstants:case"TwoConstants":return N.lerp(this.constantMin,this.constantMax,i%1);default:this.curveMax.evaluate(t)*this.curveMultiplier;break}return 0}getMax(){switch(this.mode){case ft.Constant:case"Constant":return this.constant;case ft.Curve:case"Curve":return this.getMaxFromCurve(this.curve)*this.curveMultiplier;case ft.TwoCurves:case"TwoCurves":return Math.max(this.getMaxFromCurve(this.curveMin),this.getMaxFromCurve(this.curveMax))*this.curveMultiplier;case ft.TwoConstants:case"TwoConstants":return Math.max(this.constantMin,this.constantMax);default:return 0}}getMaxFromCurve(t){if(!t)return 0;let e=Number.MIN_VALUE;for(let i=0;i<t.keys.length;i++){const n=t.keys[i];n.value>e&&(e=n.value)}return e}}R([m()],Q.prototype,"mode",void 0);R([m()],Q.prototype,"constant",void 0);R([m()],Q.prototype,"constantMin",void 0);R([m()],Q.prototype,"constantMax",void 0);R([m(Qs)],Q.prototype,"curve",void 0);R([m(Qs)],Q.prototype,"curveMin",void 0);R([m(Qs)],Q.prototype,"curveMax",void 0);R([m()],Q.prototype,"curveMultiplier",void 0);const Mt=class{constructor(){a(this,"mode",Es.Color);a(this,"color");a(this,"colorMin");a(this,"colorMax");a(this,"gradient");a(this,"gradientMin");a(this,"gradientMax")}static constant(t){const e=new Mt;return e.constant(t),e}static betweenTwoColors(t,e){const i=new Mt;return i.betweenTwoColors(t,e),i}constant(t){return this.mode=Es.Color,this.color=t,this}betweenTwoColors(t,e){return this.mode=Es.TwoColors,this.colorMin=t,this.colorMax=e,this}evaluate(t,e){const i=e===void 0?Math.random():e;switch(this.mode){case Es.Color:case"Color":return this.color;case Es.Gradient:case"Gradient":return this.gradient.evaluate(t,Mt._temp),Mt._temp;case Es.TwoColors:case"TwoColors":return Mt._temp.lerpColors(this.colorMin,this.colorMax,i);case Es.TwoGradients:case"TwoGradients":return this.gradientMin.evaluate(t,Mt._temp),this.gradientMax.evaluate(t,Mt._temp2),Mt._temp.lerp(Mt._temp2,i);case Es.RandomColor:case"RandomColor":const o=Math.random();return this.gradientMin.evaluate(t,Mt._temp),this.gradientMax.evaluate(t,Mt._temp2),Mt._temp.lerp(Mt._temp2,o)}return Mt._temp.set(16777215),Mt._temp.alpha=1,Mt._temp}};let Zt=Mt;a(Zt,"_temp",new pe(0,0,0,1)),a(Zt,"_temp2",new pe(0,0,0,1));R([m()],Zt.prototype,"mode",void 0);R([m(pe)],Zt.prototype,"color",void 0);R([m(pe)],Zt.prototype,"colorMin",void 0);R([m(pe)],Zt.prototype,"colorMax",void 0);R([m(Yc)],Zt.prototype,"gradient",void 0);R([m(Yc)],Zt.prototype,"gradientMin",void 0);R([m(Yc)],Zt.prototype,"gradientMax",void 0);var bp;(function(s){s[s.Hierarchy=0]="Hierarchy",s[s.Local=1]="Local",s[s.Shape=2]="Shape"})(bp||(bp={}));class Bi{constructor(){a(this,"cullingMode");a(this,"duration");a(this,"emitterVelocityMode");a(this,"flipRotation");a(this,"gravityModifier");a(this,"gravityModifierMultiplier");a(this,"loop");a(this,"maxParticles");a(this,"playOnAwake");a(this,"prewarm");a(this,"ringBufferLoopRange");a(this,"ringBufferMode");a(this,"scalingMode");a(this,"simulationSpace");a(this,"simulationSpeed");a(this,"startColor");a(this,"startDelay");a(this,"startDelayMultiplier");a(this,"startLifetime");a(this,"startLifetimeMultiplier");a(this,"startRotation");a(this,"startRotationMultiplier");a(this,"startRotation3D");a(this,"startRotationX");a(this,"startRotationXMultiplier");a(this,"startRotationY");a(this,"startRotationYMultiplier");a(this,"startRotationZ");a(this,"startRotationZMultiplier");a(this,"startSize");a(this,"startSize3D");a(this,"startSizeMultiplier");a(this,"startSizeX");a(this,"startSizeXMultiplier");a(this,"startSizeY");a(this,"startSizeYMultiplier");a(this,"startSizeZ");a(this,"startSizeZMultiplier");a(this,"startSpeed");a(this,"startSpeedMultiplier");a(this,"stopAction");a(this,"useUnscaledTime")}}R([m(Q)],Bi.prototype,"gravityModifier",void 0);R([m(Zt)],Bi.prototype,"startColor",void 0);R([m(Q)],Bi.prototype,"startDelay",void 0);R([m(Q)],Bi.prototype,"startLifetime",void 0);R([m(Q)],Bi.prototype,"startRotation",void 0);R([m(Q)],Bi.prototype,"startRotationX",void 0);R([m(Q)],Bi.prototype,"startRotationY",void 0);R([m(Q)],Bi.prototype,"startRotationZ",void 0);R([m(Q)],Bi.prototype,"startSize",void 0);R([m(Q)],Bi.prototype,"startSizeX",void 0);R([m(Q)],Bi.prototype,"startSizeY",void 0);R([m(Q)],Bi.prototype,"startSizeZ",void 0);R([m(Q)],Bi.prototype,"startSpeed",void 0);class A_{constructor(){a(this,"cycleCount");a(this,"maxCount");a(this,"minCount");a(this,"probability");a(this,"repeatInterval");a(this,"time");a(this,"count");a(this,"_performed",0)}reset(){this._performed=0}run(t){if(t<=this.time)return 0;let e=0;if(this.cycleCount===0||this._performed<this.cycleCount){const i=this.time+this.repeatInterval*this._performed;if(t>=i&&(this._performed+=1,Math.random()<this.probability))switch(this.count.mode){case ft.Constant:e=this.count.constant;break;case ft.TwoConstants:e=N.lerp(this.count.constantMin,this.count.constantMax,Math.random());break;case ft.Curve:e=this.count.curve.evaluate(Math.random());break;case ft.TwoCurves:const n=Math.random();e=N.lerp(this.count.curveMin.evaluate(n),this.count.curveMax.evaluate(n),Math.random());break}}return e}}class sa{constructor(){a(this,"enabled");a(this,"bursts");a(this,"rateOverTime");a(this,"rateOverTimeMultiplier");a(this,"rateOverDistance");a(this,"rateOverDistanceMultiplier");a(this,"system")}get burstCount(){var t;return((t=this.bursts)==null?void 0:t.length)??0}reset(){var t;(t=this.bursts)==null||t.forEach(e=>e.reset())}getBurst(){let t=0;if(this.burstCount>0)for(let e=0;e<this.burstCount;e++){const i=this.bursts[e];this.system.main.loop&&i.time>=this.system.time&&i.reset(),t+=Math.round(i.run(this.system.time))}return t}}R([m()],sa.prototype,"enabled",void 0);R([m()],sa.prototype,"bursts",void 0);R([m(Q)],sa.prototype,"rateOverTime",void 0);R([m()],sa.prototype,"rateOverTimeMultiplier",void 0);R([m(Q)],sa.prototype,"rateOverDistance",void 0);R([m()],sa.prototype,"rateOverDistanceMultiplier",void 0);class n0{constructor(){a(this,"enabled");a(this,"color")}}R([m(Zt)],n0.prototype,"color",void 0);class Kc{constructor(){a(this,"enabled");a(this,"separateAxes");a(this,"size");a(this,"sizeMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier");a(this,"_time",0);a(this,"_temp",new x)}evaluate(t,e,i){if(e||(e=this._temp),!this.enabled)return e.x=e.y=e.z=1,e;if(this.separateAxes)e.x=this.x.evaluate(t,i)*this.xMultiplier,e.y=this.y.evaluate(t,i)*this.yMultiplier,e.z=this.z.evaluate(t,i)*this.zMultiplier;else{const n=this.size.evaluate(t,i)*this.sizeMultiplier;e.x=n}return e}}R([m(Q)],Kc.prototype,"size",void 0);R([m(Q)],Kc.prototype,"x",void 0);R([m(Q)],Kc.prototype,"y",void 0);R([m(Q)],Kc.prototype,"z",void 0);var wr;(function(s){s[s.Vertex=0]="Vertex",s[s.Edge=1]="Edge",s[s.Triangle=2]="Triangle"})(wr||(wr={}));const rc=class{constructor(){a(this,"shapeType",Ti.Box);a(this,"enabled",!0);a(this,"alignToDirection",!1);a(this,"angle",0);a(this,"arc",360);a(this,"arcSpread");a(this,"arcSpeedMultiplier");a(this,"arcMode");a(this,"boxThickness");a(this,"position");a(this,"rotation");a(this,"_rotation",new Ct);a(this,"scale");a(this,"radius");a(this,"radiusThickness");a(this,"sphericalDirectionAmount");a(this,"randomDirectionAmount");a(this,"randomPositionAmount");a(this,"meshShapeType");a(this,"meshRenderer");a(this,"_meshObj");a(this,"_meshGeometry");a(this,"system");a(this,"_space");a(this,"_worldSpaceMatrix",new ce);a(this,"_worldSpaceMatrixInverse",new ce);a(this,"_vector",new x(0,0,0));a(this,"_temp",new x(0,0,0));a(this,"_triangle",new UR);a(this,"_dir",new x);a(this,"_loopTime",0);a(this,"_loopDirection",1);cf&&console.log(this)}get type(){return Ti[this.shapeType]}initialize(t){this.onInitialize(t),t.position.x=this._vector.x,t.position.y=this._vector.y,t.position.z=this._vector.z}toJSON(){return this}clone(){return new rc}setMesh(t){this.meshRenderer=t,t?(this._meshObj=t.sharedMeshes[Math.floor(Math.random()*t.sharedMeshes.length)],this._meshGeometry=this._meshObj.geometry):(this._meshObj=void 0,this._meshGeometry=void 0)}update(t,e){}onUpdate(t,e,i,n){this.system=t,this._space=i,i===ds.World&&(this._worldSpaceMatrix.copy(n.matrixWorld),this._worldSpaceMatrix.elements[0]=1,this._worldSpaceMatrix.elements[5]=1,this._worldSpaceMatrix.elements[10]=1,this._worldSpaceMatrixInverse.copy(this._worldSpaceMatrix).invert())}applyRotation(t){const e=this.rotation.x!==0||this.rotation.y!==0||this.rotation.z!==0;return e&&(this._rotation.x=N.toRadians(this.rotation.x),this._rotation.y=N.toRadians(this.rotation.y),this._rotation.z=N.toRadians(this.rotation.z),this._rotation.order="ZYX",t.applyEuler(this._rotation)),e}onInitialize(t){this._vector.set(0,0,0),t.mesh=void 0,t.mesh_geometry=void 0;const e=this._temp.copy(this.position),i=this._space===ds.World;i&&e.applyQuaternion(this.system.worldQuaternion);let n=this.radius;if(i&&(n*=this.system.worldScale.x),this.enabled){switch(this.shapeType){case Ti.Box:cf&&G.DrawWireBox(this.position,this.scale,14540253,1),this._vector.x=Math.random()*this.scale.x-this.scale.x/2,this._vector.y=Math.random()*this.scale.y-this.scale.y/2,this._vector.z=Math.random()*this.scale.z-this.scale.z/2,this._vector.add(e);break;case Ti.Cone:this.randomConePoint(this.position,this.angle,n,this.radiusThickness,this.arc,this.arcMode,this._vector);break;case Ti.Sphere:this.randomSpherePoint(this.position,n,this.radiusThickness,this.arc,this._vector);break;case Ti.Circle:this.randomCirclePoint(this.position,n,this.radiusThickness,this.arc,this._vector);break;case Ti.MeshRenderer:const o=this.meshRenderer;(o==null?void 0:o.destroyed)==!1&&this.setMesh(o);const r=t.mesh=this._meshObj,l=t.mesh_geometry=this._meshGeometry;if(r&&l)switch(this.meshShapeType){case wr.Vertex:{const c=l.getAttribute("position"),h=Math.floor(Math.random()*c.count);this._vector.fromBufferAttribute(c,h),this._vector.applyMatrix4(r.matrixWorld),t.mesh_normal=h}break;case wr.Edge:break;case wr.Triangle:{const c=l.index;if(c){let h=Math.random(),d=Math.random();h+d>1&&(h=1-h,d=1-d);const u=Math.floor(Math.random()*(c.count/3));let f=u*3,p=u*3+1,g=u*3+2;f=c.getX(f),p=c.getX(p),g=c.getX(g);const _=l.getAttribute("position");this._triangle.a.fromBufferAttribute(_,f),this._triangle.b.fromBufferAttribute(_,p),this._triangle.c.fromBufferAttribute(_,g),this._vector.set(0,0,0).addScaledVector(this._triangle.a,h).addScaledVector(this._triangle.b,d).addScaledVector(this._triangle.c,1-(h+d)),this._vector.applyMatrix4(r.matrixWorld),t.mesh_normal=u}}break}break;default:this._vector.set(0,0,0),U()&&!globalThis.__particlesystem_shapetype_unsupported&&(console.warn("ParticleSystem ShapeType is not supported:",Ti[this.shapeType]),globalThis.__particlesystem_shapetype_unsupported=!0);break}this.randomizePosition(this._vector,this.randomPositionAmount)}this.applyRotation(this._vector),i&&(this._vector.applyQuaternion(this.system.worldQuaternion),this._vector.add(this.system.worldPos)),cf&&G.DrawSphere(this._vector,.03,16711680,.5,!0)}getDirection(t,e){var i;if(!this.enabled)return this._dir.set(0,0,1),this._dir;switch(this.shapeType){case Ti.Box:this._dir.set(0,0,1);break;case Ti.Cone:this._dir.set(0,0,1);break;case Ti.Circle:case Ti.Sphere:const n=e.x,o=e.y,r=e.z;this._dir.set(n,o,r),(i=this.system)!=null&&i.worldspace?this._dir.sub(this.system.worldPos):this._dir.sub(this.position);break;case Ti.MeshRenderer:const l=t.mesh,c=t.mesh_geometry;if(l&&c)switch(this.meshShapeType){case wr.Vertex:{const h=c.getAttribute("normal"),d=t.mesh_normal;this._dir.fromBufferAttribute(h,d)}break;case wr.Edge:break;case wr.Triangle:{const h=c.index;if(h){const d=t.mesh_normal,u=h.getX(d*3),f=h.getX(d*3+1),p=h.getX(d*3+2),g=c.getAttribute("position"),_=q(),y=q(),b=q();_.fromBufferAttribute(g,u),y.fromBufferAttribute(g,f),b.fromBufferAttribute(g,p),_.sub(y),b.sub(y),_.cross(b),this._dir.copy(_).multiplyScalar(-1);const v=Le(l);this._dir.applyQuaternion(v)}}break}break;default:this._dir.set(0,0,1);break}return this._space===ds.World&&this._dir.applyQuaternion(this.system.worldQuaternion),this.applyRotation(this._dir),this._dir.normalize(),this.spherizeDirection(this._dir,this.sphericalDirectionAmount),this.randomizeDirection(this._dir,this.randomDirectionAmount),cf&&(G.DrawSphere(e,.01,8925952,.5,!0),G.DrawDirection(e,this._dir,8925952,.5,!0)),this._dir}randomizePosition(t,e){if(e<=0)return;const i=rc._tempVec;i.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1),i.x*=e*this.scale.x,i.y*=e*this.scale.y,i.z*=e*this.scale.z,t.add(i)}randomizeDirection(t,e){if(e===0)return;const i=rc._randomQuat,n=rc._tempVec;n.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),i.setFromAxisAngle(n,e*Math.random()*Math.PI),t.applyQuaternion(i)}spherizeDirection(t,e){if(e===0)return;const i=Math.random()*Math.PI*2,n=Math.acos(1-Math.random()*2),o=Math.sin(n)*Math.cos(i),r=Math.sin(n)*Math.sin(i),l=Math.cos(n),c=new x(o,r,l);t.lerp(c,e)}randomSpherePoint(t,e,i,n,o){const r=Math.random(),l=Math.random(),c=2*Math.PI*r*(n/360),h=Math.acos(2*l-1),d=N.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*e,u=t.x+this.scale.x*(-d*Math.sin(h)*Math.cos(c)),f=t.y+this.scale.y*(d*Math.sin(h)*Math.sin(c)),p=t.z+this.scale.z*(d*Math.cos(h));o.x=u,o.y=f,o.z=p}randomCirclePoint(t,e,i,n,o){const r=Math.random(),l=2*Math.PI*r*(n/360),c=N.lerp(1,1-Math.pow(1-Math.random(),Math.PI),i)*e,h=t.x+this.scale.x*c*Math.cos(l),d=t.y+this.scale.y*c*Math.sin(l),u=t.z;o.x=h,o.y=d,o.z=u}randomConePoint(t,e,i,n,o,r,l){let c=0,h=0;switch(r){case ka.Random:c=Math.random(),h=Math.random();break;case ka.PingPong:this._loopTime>1&&(this._loopDirection=-1),this._loopTime<0&&(this._loopDirection=1);case ka.Loop:c=.5,h=Math.random(),this._loopTime+=this.system.deltaTime*this._loopDirection;break}let d=2*Math.PI*c*(o/360);switch(r){case ka.PingPong:case ka.Loop:d+=Math.PI+.5,d+=this._loopTime*Math.PI*2,d%=N.toRadians(o);break}const u=Math.acos(2*h-1),f=N.lerp(1,1-Math.pow(1-Math.random(),Math.PI),n)*i,p=t.x+-f*Math.sin(u)*Math.cos(d),g=t.y+f*Math.sin(u)*Math.sin(d),_=t.z;l.x=p*this.scale.x,l.y=g*this.scale.y,l.z=_*this.scale.z}};let We=rc;a(We,"_randomQuat",new H),a(We,"_tempVec",new x);R([m()],We.prototype,"shapeType",void 0);R([m()],We.prototype,"enabled",void 0);R([m()],We.prototype,"alignToDirection",void 0);R([m()],We.prototype,"angle",void 0);R([m()],We.prototype,"arc",void 0);R([m()],We.prototype,"arcSpread",void 0);R([m()],We.prototype,"arcSpeedMultiplier",void 0);R([m()],We.prototype,"arcMode",void 0);R([m(x)],We.prototype,"boxThickness",void 0);R([m(x)],We.prototype,"position",void 0);R([m(x)],We.prototype,"rotation",void 0);R([m(x)],We.prototype,"scale",void 0);R([m()],We.prototype,"radius",void 0);R([m()],We.prototype,"radiusThickness",void 0);R([m()],We.prototype,"sphericalDirectionAmount",void 0);R([m()],We.prototype,"randomDirectionAmount",void 0);R([m()],We.prototype,"randomPositionAmount",void 0);R([m()],We.prototype,"meshShapeType",void 0);R([m(vm)],We.prototype,"meshRenderer",void 0);class je{constructor(){a(this,"damping");a(this,"enabled");a(this,"frequency");a(this,"octaveCount");a(this,"octaveMultiplier");a(this,"octaveScale");a(this,"positionAmount");a(this,"quality");a(this,"remap");a(this,"remapEnabled");a(this,"remapMultiplier");a(this,"remapX");a(this,"remapXMultiplier");a(this,"remapY");a(this,"remapYMultiplier");a(this,"remapZ");a(this,"remapZMultiplier");a(this,"scrollSpeedMultiplier");a(this,"separateAxes");a(this,"strengthMultiplier");a(this,"strengthX");a(this,"strengthXMultiplier");a(this,"strengthY");a(this,"strengthYMultiplier");a(this,"strengthZ");a(this,"strengthZMultiplier");a(this,"_noise");a(this,"_time",0);a(this,"_temp",new x)}update(t){this._time+=t.time.deltaTime*this.scrollSpeedMultiplier}apply(t,e,i,n,o,r){if(!this.enabled)return;this._noise||(this._noise=FI(()=>0));const l=this._temp.set(e.x,e.y,e.z).multiplyScalar(this.frequency),c=this._noise(l.x,l.y,l.z,this._time),h=this._noise(l.x,l.y,l.z,this._time+1e3*this.frequency),d=this._noise(l.x,l.y,l.z,this._time+2e3*this.frequency);this._temp.set(c,h,d).normalize();const u=o/r;let f=this.positionAmount.evaluate(u);this.separateAxes?(this._temp.x*=f*this.strengthXMultiplier,this._temp.y*=f*this.strengthYMultiplier,this._temp.z*=f*this.strengthZMultiplier):(this.strengthX&&(f*=this.strengthX.evaluate(u)*1.5),this._temp.multiplyScalar(f)),i.x+=this._temp.x,i.y+=this._temp.y,i.z+=this._temp.z}}R([m()],je.prototype,"damping",void 0);R([m()],je.prototype,"enabled",void 0);R([m()],je.prototype,"frequency",void 0);R([m()],je.prototype,"octaveCount",void 0);R([m()],je.prototype,"octaveMultiplier",void 0);R([m()],je.prototype,"octaveScale",void 0);R([m(Q)],je.prototype,"positionAmount",void 0);R([m()],je.prototype,"quality",void 0);R([m(Q)],je.prototype,"remap",void 0);R([m()],je.prototype,"remapEnabled",void 0);R([m()],je.prototype,"remapMultiplier",void 0);R([m(Q)],je.prototype,"remapX",void 0);R([m()],je.prototype,"remapXMultiplier",void 0);R([m(Q)],je.prototype,"remapY",void 0);R([m()],je.prototype,"remapYMultiplier",void 0);R([m(Q)],je.prototype,"remapZ",void 0);R([m()],je.prototype,"remapZMultiplier",void 0);R([m()],je.prototype,"scrollSpeedMultiplier",void 0);R([m()],je.prototype,"separateAxes",void 0);R([m()],je.prototype,"strengthMultiplier",void 0);R([m(Q)],je.prototype,"strengthX",void 0);R([m()],je.prototype,"strengthXMultiplier",void 0);R([m(Q)],je.prototype,"strengthY",void 0);R([m()],je.prototype,"strengthYMultiplier",void 0);R([m(Q)],je.prototype,"strengthZ",void 0);R([m()],je.prototype,"strengthZMultiplier",void 0);var I_;(function(s){s[s.PerParticle=0]="PerParticle",s[s.Ribbon=1]="Ribbon"})(I_||(I_={}));var D_;(function(s){s[s.Stretch=0]="Stretch",s[s.Tile=1]="Tile",s[s.DistributePerSegment=2]="DistributePerSegment",s[s.RepeatPerSegment=3]="RepeatPerSegment"})(D_||(D_={}));class lt{constructor(){a(this,"enabled");a(this,"attachRibbonToTransform",!1);a(this,"colorOverLifetime");a(this,"colorOverTrail");a(this,"dieWithParticles",!0);a(this,"inheritParticleColor",!0);a(this,"lifetime");a(this,"lifetimeMultiplier");a(this,"minVertexDistance",.2);a(this,"mode",I_.PerParticle);a(this,"ratio",1);a(this,"ribbonCount",1);a(this,"shadowBias",0);a(this,"sizeAffectsLifetime",!1);a(this,"sizeAffectsWidth",!1);a(this,"splitSubEmitterRibbons",!1);a(this,"textureMode",D_.Stretch);a(this,"widthOverTrail");a(this,"widthOverTrailMultiplier");a(this,"worldSpace",!1)}getWidth(t,e,i,n){const o=this.widthOverTrail.evaluate(i,n);return t*=o,t}getColor(t,e,i){const n=this.colorOverTrail.evaluate(i),o=this.colorOverLifetime.evaluate(e);t.x*=n.r*o.r,t.y*=n.g*o.g,t.z*=n.b*o.b,"alpha"in n&&"alpha"in o&&(t.w*=n.alpha*o.alpha)}}R([m()],lt.prototype,"enabled",void 0);R([m()],lt.prototype,"attachRibbonToTransform",void 0);R([m(Zt)],lt.prototype,"colorOverLifetime",void 0);R([m(Zt)],lt.prototype,"colorOverTrail",void 0);R([m()],lt.prototype,"dieWithParticles",void 0);R([m()],lt.prototype,"inheritParticleColor",void 0);R([m(Q)],lt.prototype,"lifetime",void 0);R([m()],lt.prototype,"lifetimeMultiplier",void 0);R([m()],lt.prototype,"minVertexDistance",void 0);R([m()],lt.prototype,"mode",void 0);R([m()],lt.prototype,"ratio",void 0);R([m()],lt.prototype,"ribbonCount",void 0);R([m()],lt.prototype,"shadowBias",void 0);R([m()],lt.prototype,"sizeAffectsLifetime",void 0);R([m()],lt.prototype,"sizeAffectsWidth",void 0);R([m()],lt.prototype,"splitSubEmitterRibbons",void 0);R([m()],lt.prototype,"textureMode",void 0);R([m(Q)],lt.prototype,"widthOverTrail",void 0);R([m()],lt.prototype,"widthOverTrailMultiplier",void 0);R([m()],lt.prototype,"worldSpace",void 0);class mt{constructor(){a(this,"enabled");a(this,"space",ds.Local);a(this,"orbitalX");a(this,"orbitalY");a(this,"orbitalZ");a(this,"orbitalXMultiplier");a(this,"orbitalYMultiplier");a(this,"orbitalZMultiplier");a(this,"orbitalOffsetX");a(this,"orbitalOffsetY");a(this,"orbitalOffsetZ");a(this,"speedModifier");a(this,"speedModifierMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier");a(this,"_system");a(this,"_temp",new x);a(this,"_temp2",new x);a(this,"_temp3",new x);a(this,"_hasOrbital",!1);a(this,"_index",0);a(this,"_orbitalMatrix",new ce)}update(t){this._system=t}init(t){this._index==0&&(t.debug=!0),this._index+=1,t.orbitx=this.orbitalX.evaluate(Math.random()),t.orbity=this.orbitalY.evaluate(Math.random()),t.orbitz=this.orbitalZ.evaluate(Math.random()),this._hasOrbital=t.orbitx!=0||t.orbity!=0||t.orbitz!=0}apply(t,e,i,n,o,r,l){var p;if(!this.enabled)return;const c=r/l,h=this.speedModifier.evaluate(c)*this.speedModifierMultiplier,d=this.x.evaluate(c),u=this.y.evaluate(c),f=this.z.evaluate(c);if(this._temp.set(-d,u,f),this._system&&this._system.main.simulationSpace===ds.World&&this._temp.applyQuaternion(this._system.worldQuaternion),this._hasOrbital&&((p=this._system)==null?void 0:p.worldPos)){const _=this._temp2.set(i.x,i.y,i.z),y=this.orbitalXMultiplier,b=this.orbitalYMultiplier,v=this.orbitalZMultiplier,w=h*Math.PI*2*10,P=Math.cos(w*y),E=Math.sin(w*y),T=Math.cos(w*b),k=Math.sin(w*b),z=Math.cos(w*v),L=Math.sin(w*v),O=_.x*(T*z)+_.y*(T*L)+_.z*-k,A=_.x*(E*k*z-P*L)+_.y*(E*k*L+P*z)+_.z*(E*T),$=_.x*(P*k*z+E*L)+_.y*(P*k*L-E*z)+_.z*(P*T),B=this._temp3.set(_.x-O,_.y-A,_.z-$);B.normalize(),B.multiplyScalar(.2/o*Math.max(this.orbitalXMultiplier,this.orbitalYMultiplier,this.orbitalZMultiplier)),n.x+=B.x,n.y+=B.y,n.z+=B.z}n.x+=this._temp.x,n.y+=this._temp.y,n.z+=this._temp.z,n.x*=h,n.y*=h,n.z*=h}}R([m()],mt.prototype,"enabled",void 0);R([m()],mt.prototype,"space",void 0);R([m(Q)],mt.prototype,"orbitalX",void 0);R([m(Q)],mt.prototype,"orbitalY",void 0);R([m(Q)],mt.prototype,"orbitalZ",void 0);R([m()],mt.prototype,"orbitalXMultiplier",void 0);R([m()],mt.prototype,"orbitalYMultiplier",void 0);R([m()],mt.prototype,"orbitalZMultiplier",void 0);R([m()],mt.prototype,"orbitalOffsetX",void 0);R([m()],mt.prototype,"orbitalOffsetY",void 0);R([m()],mt.prototype,"orbitalOffsetZ",void 0);R([m(Q)],mt.prototype,"speedModifier",void 0);R([m()],mt.prototype,"speedModifierMultiplier",void 0);R([m(Q)],mt.prototype,"x",void 0);R([m()],mt.prototype,"xMultiplier",void 0);R([m(Q)],mt.prototype,"y",void 0);R([m()],mt.prototype,"yMultiplier",void 0);R([m(Q)],mt.prototype,"z",void 0);R([m()],mt.prototype,"zMultiplier",void 0);var L_;(function(s){s[s.Lifetime=0]="Lifetime",s[s.Speed=1]="Speed",s[s.FPS=2]="FPS"})(L_||(L_={}));var sw;(function(s){s[s.Grid=0]="Grid",s[s.Sprites=1]="Sprites"})(sw||(sw={}));var ow;(function(s){s[s.Custom=0]="Custom",s[s.Random=1]="Random",s[s.MeshIndex=2]="MeshIndex"})(ow||(ow={}));var rw;(function(s){s[s.WholeSheet=0]="WholeSheet",s[s.SingleRow=1]="SingleRow"})(rw||(rw={}));class Fi{constructor(){a(this,"animation");a(this,"enabled");a(this,"cycleCount");a(this,"frameOverTime");a(this,"frameOverTimeMultiplier");a(this,"numTilesX");a(this,"numTilesY");a(this,"startFrame");a(this,"startFrameMultiplier");a(this,"rowMode");a(this,"rowIndex");a(this,"spriteCount");a(this,"timeMode")}sampleOnceAtStart(){if(this.timeMode===L_.Lifetime)switch(this.frameOverTime.mode){case ft.Constant:case ft.TwoConstants:case ft.TwoCurves:case ft.Curve:return!0}return!1}getStartIndex(){return this.sampleOnceAtStart()?Math.random()*(this.numTilesX*this.numTilesY):0}evaluate(t){if(!this.sampleOnceAtStart())return this.getIndex(t)}getIndex(t){const e=this.numTilesX*this.numTilesY;t=t*this.cycleCount;let i=this.frameOverTime.evaluate(t%1);return i*=this.frameOverTimeMultiplier,i*=e,i=i%e,i=Math.floor(i),i}}R([m()],Fi.prototype,"animation",void 0);R([m()],Fi.prototype,"enabled",void 0);R([m()],Fi.prototype,"cycleCount",void 0);R([m(Q)],Fi.prototype,"frameOverTime",void 0);R([m()],Fi.prototype,"frameOverTimeMultiplier",void 0);R([m()],Fi.prototype,"numTilesX",void 0);R([m()],Fi.prototype,"numTilesY",void 0);R([m(Q)],Fi.prototype,"startFrame",void 0);R([m()],Fi.prototype,"startFrameMultiplier",void 0);R([m()],Fi.prototype,"rowMode",void 0);R([m()],Fi.prototype,"rowIndex",void 0);R([m()],Fi.prototype,"spriteCount",void 0);R([m()],Fi.prototype,"timeMode",void 0);class uo{constructor(){a(this,"enabled");a(this,"separateAxes");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e){return this.enabled?this.separateAxes?0:this.z.evaluate(t,e)*-1:0}}R([m()],uo.prototype,"enabled",void 0);R([m()],uo.prototype,"separateAxes",void 0);R([m(Q)],uo.prototype,"x",void 0);R([m()],uo.prototype,"xMultiplier",void 0);R([m(Q)],uo.prototype,"y",void 0);R([m()],uo.prototype,"yMultiplier",void 0);R([m(Q)],uo.prototype,"z",void 0);R([m()],uo.prototype,"zMultiplier",void 0);class _s{constructor(){a(this,"enabled");a(this,"range");a(this,"separateAxes");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e){if(!this.enabled)return 0;if(!this.separateAxes){const i=N.lerp(this.range.x,this.range.y,e);return this.z.evaluate(i)*-1}return 0}}R([m()],_s.prototype,"enabled",void 0);R([m()],_s.prototype,"range",void 0);R([m()],_s.prototype,"separateAxes",void 0);R([m(Q)],_s.prototype,"x",void 0);R([m()],_s.prototype,"xMultiplier",void 0);R([m(Q)],_s.prototype,"y",void 0);R([m()],_s.prototype,"yMultiplier",void 0);R([m(Q)],_s.prototype,"z",void 0);R([m()],_s.prototype,"zMultiplier",void 0);class Nt{constructor(){a(this,"enabled");a(this,"dampen");a(this,"drag");a(this,"dragMultiplier");a(this,"limit");a(this,"limitMultiplier");a(this,"separateAxes");a(this,"limitX");a(this,"limitXMultiplier");a(this,"limitY");a(this,"limitYMultiplier");a(this,"limitZ");a(this,"limitZMultiplier");a(this,"multiplyDragByParticleSize",!1);a(this,"multiplyDragByParticleVelocity",!1);a(this,"space");a(this,"_temp",new x);a(this,"_temp2",new x)}apply(t,e,i,n,o,r,l){if(this.enabled){const c=this.limit.evaluate(o)*this.limitMultiplier;if(e.length()>c){this._temp.copy(e).normalize().multiplyScalar(c);const d=this.dampen*.5;e.x=N.lerp(e.x,this._temp.x,d),e.y=N.lerp(e.y,this._temp.y,d),e.z=N.lerp(e.z,this._temp.z,d),i.x=N.lerp(i.x,this._temp.x,d),i.y=N.lerp(i.y,this._temp.y,d),i.z=N.lerp(i.z,this._temp.z,d)}}}}R([m()],Nt.prototype,"enabled",void 0);R([m()],Nt.prototype,"dampen",void 0);R([m(Q)],Nt.prototype,"drag",void 0);R([m()],Nt.prototype,"dragMultiplier",void 0);R([m(Q)],Nt.prototype,"limit",void 0);R([m()],Nt.prototype,"limitMultiplier",void 0);R([m()],Nt.prototype,"separateAxes",void 0);R([m(Q)],Nt.prototype,"limitX",void 0);R([m()],Nt.prototype,"limitXMultiplier",void 0);R([m(Q)],Nt.prototype,"limitY",void 0);R([m()],Nt.prototype,"limitYMultiplier",void 0);R([m(Q)],Nt.prototype,"limitZ",void 0);R([m()],Nt.prototype,"limitZMultiplier",void 0);R([m()],Nt.prototype,"multiplyDragByParticleSize",void 0);R([m()],Nt.prototype,"multiplyDragByParticleVelocity",void 0);R([m()],Nt.prototype,"space",void 0);var vp;(function(s){s[s.Initial=0]="Initial",s[s.Current=1]="Current"})(vp||(vp={}));class oa{constructor(){a(this,"enabled");a(this,"curve");a(this,"curveMultiplier");a(this,"mode");a(this,"system");a(this,"_temp",new x);a(this,"_firstUpdate",!0);a(this,"_frames",0)}clone(){var e;const t=new oa;return t.enabled=this.enabled,t.curve=(e=this.curve)==null?void 0:e.clone(),t.curveMultiplier=this.curveMultiplier,t.mode=this.mode,t}get _lastWorldPosition(){return this.system._iv_lastWorldPosition||(this.system._iv_lastWorldPosition=new x),this.system._iv_lastWorldPosition}get _velocity(){return this.system._iv_velocity||(this.system._iv_velocity=new x),this.system._iv_velocity}awake(t){this.system=t,this.reset()}reset(){this._firstUpdate=!0}update(t){this.enabled&&this.system.worldspace!==!1&&(this._firstUpdate?(this._firstUpdate=!1,this._velocity.set(0,0,0),this._lastWorldPosition.copy(this.system.worldPos)):this._lastWorldPosition&&(this._velocity.copy(this.system.worldPos).sub(this._lastWorldPosition).multiplyScalar(1/this.system.deltaTime),this._lastWorldPosition.copy(this.system.worldPos)))}applyInitial(t){if(this.enabled&&this.system.worldspace!==!1&&this.mode===vp.Initial){const e=this.curve.evaluate(Math.random(),Math.random());this._temp.copy(this._velocity).multiplyScalar(e),t.x+=this._temp.x,t.y+=this._temp.y,t.z+=this._temp.z}}applyCurrent(t,e,i){if(this.enabled&&this.system&&this.system.worldspace!==!1&&this.mode===vp.Current){const n=this.curve.evaluate(e,i);this._temp.copy(this._velocity).multiplyScalar(n),t.x+=this._temp.x,t.y+=this._temp.y,t.z+=this._temp.z}}}R([m()],oa.prototype,"enabled",void 0);R([m(Q)],oa.prototype,"curve",void 0);R([m()],oa.prototype,"curveMultiplier",void 0);R([m()],oa.prototype,"mode",void 0);class Pn{constructor(){a(this,"enabled");a(this,"range");a(this,"separateAxes");a(this,"size");a(this,"sizeMultiplier");a(this,"x");a(this,"xMultiplier");a(this,"y");a(this,"yMultiplier");a(this,"z");a(this,"zMultiplier")}evaluate(t,e,i,n){const o=t.length(),r=N.remap(o,this.range.x,this.range.y,0,1),l=this.size.evaluate(r,i);return n.x*=l,n.y*=l,n.z*=l,n}}R([m()],Pn.prototype,"enabled",void 0);R([m(le)],Pn.prototype,"range",void 0);R([m()],Pn.prototype,"separateAxes",void 0);R([m(Q)],Pn.prototype,"size",void 0);R([m()],Pn.prototype,"sizeMultiplier",void 0);R([m(Q)],Pn.prototype,"x",void 0);R([m()],Pn.prototype,"xMultiplier",void 0);R([m(Q)],Pn.prototype,"y",void 0);R([m()],Pn.prototype,"yMultiplier",void 0);R([m(Q)],Pn.prototype,"z",void 0);R([m()],Pn.prototype,"zMultiplier",void 0);class _u{constructor(){a(this,"enabled");a(this,"range");a(this,"color")}evaluate(t,e,i){const n=t.length(),o=N.remap(n,this.range.x,this.range.y,0,1),r=this.color.evaluate(o,e);i.x*=r.r,i.y*=r.g,i.z*=r.b,"alpha"in r&&(i.w*=r.alpha)}}R([m()],_u.prototype,"enabled",void 0);R([m(le)],_u.prototype,"range",void 0);R([m(Zt)],_u.prototype,"color",void 0);new x(1,1,1);new x(0,0,1);class nP{constructor(t,e,i,n){a(this,"system");a(this,"particleSystem");a(this,"subSystem");a(this,"subParticleSystem");a(this,"type","NeedleParticleSubEmitter");a(this,"emitterType");a(this,"emitterProbability");a(this,"q_",new H);a(this,"v_",new x);a(this,"v2_",new x);a(this,"_emitterMatrix",new fg);a(this,"_circularBuffer");this.system=t,this.particleSystem=e,this.subSystem=i,this.subParticleSystem=n,this.subParticleSystem&&this.subParticleSystem&&(this.subParticleSystem.onlyUsedByOther=!0);const o=1e3;this._circularBuffer=new $n(()=>new fg,o)}clone(){throw new Error("Method not implemented.")}initialize(t){t.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0},this._emitterMatrix.copy(this.subSystem.matrixWorld).invert().premultiply(this.system.matrixWorld),this._emitterMatrix.setPosition(0,0,0),this.emitterType===xp.Birth&&this.run(t)}update(t,e){this.run(t)}frameUpdate(t){}toJSON(){}reset(){}run(t){if(this.subSystem.currentParticles>=this.subSystem.main.maxParticles||!this.subParticleSystem||!t.emissionState||this.emitterProbability&&Math.random()>this.emitterProbability)return;const e=this.system.deltaTime;if(this.emitterType===xp.Death){let n=t.life;if(t[Xl]!==void 0&&(n=t[Xl]),!(t.age+e*1.2>=n))return;const r=this.subSystem.main.maxParticles-this.subSystem.currentParticles;t.emissionState.waitEmiting=r}const i=new fg;i.set(1,0,0,t.position.x,0,1,0,t.position.y,0,0,1,t.position.z,0,0,0,1),this.particleSystem.worldSpace||i.multiplyMatrices(this._emitterMatrix,i),this.subParticleSystem.emit(e,t.emissionState,i)}}var rt=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Sr=S("debugparticles"),UI=S("noprogressive"),NI=S("debugprogressive");var xp;(function(s){s[s.Birth=0]="Birth",s[s.Collision=1]="Collision",s[s.Death=2]="Death",s[s.Trigger=3]="Trigger",s[s.Manual=4]="Manual"})(xp||(xp={}));class bs extends j{constructor(){super(...arguments);a(this,"renderMode");a(this,"particleMaterial");a(this,"trailMaterial");a(this,"particleMesh");a(this,"maxParticleSize");a(this,"minParticleSize");a(this,"velocityScale");a(this,"cameraVelocityScale");a(this,"lengthScale")}start(){if(this.maxParticleSize!==.5&&this.minParticleSize!==0&&U()){const e=`ParticleSystem "${this.name}" has non-default min/max particle size. This may not render correctly. Please set min size to 0 and the max size to 0.5 and use the "StartSize" setting instead`;console.warn(e)}}get transparent(){var i;return((i=this.particleMaterial)==null?void 0:i.transparent)??!1}getMaterial(e=!1){let i=e===!0&&this.trailMaterial?this.trailMaterial:this.particleMaterial;if(i){if(i.type==="MeshStandardMaterial"){Sr&&console.debug("ParticleSystemRenderer.getMaterial: MeshStandardMaterial detected, converting to MeshBasicMaterial. See https://github.com/Alchemist0823/three.quarks/issues/101"),"map"in i&&i.map&&(i.map.colorSpace=Xo,i.map.premultiplyAlpha=!1);const n=new Be;n.copy(i),e?this.trailMaterial=n:this.particleMaterial=n}i.map&&(i.map.colorSpace=Xo,i.map.premultiplyAlpha=!1),e&&i.side===Gr&&(i=i.clone(),i.side=Qp,e?this.trailMaterial=i:this.particleMaterial=i)}return i&&!UI&&i._didRequestTextureLOD===void 0&&(i._didRequestTextureLOD=0,NI&&console.log("Load material LOD",i.name),pt.assignTextureLOD(i,0)),i}getMesh(e){let i=null;if(!i&&(this.particleMesh instanceof X&&(i=this.particleMesh.geometry),i===null)){i=new ro(1,1);const o=i.attributes.uv;for(let r=0;r<o.count;r++)o.setX(r,1-o.getX(r))}return new X(i,this.getMaterial())}}rt([m()],bs.prototype,"renderMode",void 0);rt([m(Ie)],bs.prototype,"particleMaterial",void 0);rt([m(Ie)],bs.prototype,"trailMaterial",void 0);rt([m()],bs.prototype,"maxParticleSize",void 0);rt([m()],bs.prototype,"minParticleSize",void 0);rt([m()],bs.prototype,"velocityScale",void 0);rt([m()],bs.prototype,"cameraVelocityScale",void 0);rt([m()],bs.prototype,"lengthScale",void 0);class hf{constructor(t,e=1){a(this,"_curve");a(this,"_factor");a(this,"type","function");this._curve=t,this._factor=e}startGen(t){}genValue(t,e){return this._curve.evaluate(e,Math.random())*this._factor}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}}class s0{constructor(t){a(this,"type","value");a(this,"system");this.system=t}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}startGen(t){}}class $I extends s0{genValue(){return this.system.textureSheetAnimation.getStartIndex()}}class WI extends s0{constructor(){super(...arguments);a(this,"_lastPosition",new x);a(this,"_lastDistance",0)}update(){const e=ae(this.system.gameObject);this._lastDistance=this._lastPosition.distanceTo(e),this._lastPosition.copy(e)}genValue(){if(!this.system.isPlaying||!this.system.emission.enabled||this.system.currentParticles>=this.system.maxParticles)return 0;let e=this.system.emission.rateOverTime.evaluate(this.system.time/this.system.duration,Math.random());if(this.system.deltaTime>0){const o=this.system.emission.rateOverDistance.evaluate(this.system.time/this.system.duration,Math.random());let l=this._lastDistance/this.system.deltaTime*o;Number.isFinite(l)||(l=0),e+=l}const i=this.system.emission.getBurst();i>0&&(e+=i/this.system.deltaTime);const n=this.system.maxParticles-this.system.currentParticles;return N.clamp(e,0,n/this.system.deltaTime)}}class VI extends s0{genValue(){return this.system.isPlaying,0}}class yl{constructor(t){a(this,"system");a(this,"type");this.type=Object.getPrototypeOf(this).constructor.name||"ParticleSystemBaseBehaviour",t&&(this.system=t)}get context(){return this.system.context}initialize(t){}update(t,e){}frameUpdate(t){}toJSON(){throw new Error("Method not implemented.")}clone(){throw new Error("Method not implemented.")}reset(){}}class HI extends yl{constructor(){super(...arguments);a(this,"type","NeedleTextureSheet")}update(e,i){const n=this.system.textureSheetAnimation;if(n.enabled){const o=e.age/e.life,r=n.evaluate(o);r!==void 0&&(e.uvTile=r)}}}const aw=Symbol("particleRotation");class GI extends yl{constructor(){super(...arguments);a(this,"type","NeedleRotation")}initialize(e){e[aw]=Math.random()}update(e,i){if(e.rotation===void 0)return;const n=e.age/e.life;if(typeof e.rotation=="number"&&(this.system.rotationOverLifetime.enabled?e.rotation+=this.system.rotationOverLifetime.evaluate(n,e[aw])*i:this.system.renderer.renderMode===zs.Billboard&&(e.rotation=Math.PI),this.system.rotationBySpeed.enabled)){const o=e.velocity.length();e.rotation+=this.system.rotationBySpeed.evaluate(n,o)*i}}}const lw=Symbol("sizeLerpFactor"),qI=new x;class XI extends yl{constructor(){super(...arguments);a(this,"type","NeedleSize");a(this,"_minSize",0);a(this,"_maxSize",1)}initialize(e){e[lw]=Math.random(),this._minSize=this.system.renderer.minParticleSize,this._maxSize=this.system.renderer.maxParticleSize}update(e,i){const n=e.age/e.life;let o=1;this.system.sizeOverLifetime.enabled&&(o*=this.system.sizeOverLifetime.evaluate(n,void 0,e[lw]).x);let r=1;this.system.renderer.renderMode!==zs.Mesh&&(r=this.system.worldScale.x/this.system.cameraScale);const l=q(e.startSize).multiplyScalar(o*r);if(e.size.set(l.x,l.y,l.z),this.system.localspace){const c=sP(this.system,qI);e.size.x*=c.x,e.size.y*=c.y,e.size.z*=c.z}}}const Xl=Symbol("particleLife"),py=Symbol("trailLifetime"),cw=Symbol("trailStartLength"),my=Symbol("trailWidthRandom");class QI extends yl{constructor(){super(...arguments);a(this,"type","NeedleTrail")}initialize(e){e instanceof U0&&(e[Xl]=e.life,this.system.trails.enabled&&this.system.trails.dieWithParticles===!1&&(e[py]=this.system.trails.lifetime.evaluate(Math.random(),Math.random()),e.life+=e[py]),e[cw]=e.length,e[my]=Math.random())}update(e){var i;if((i=this.system.trails)!=null&&i.enabled&&e instanceof U0){const n=e,o=e.age/e[Xl],r=e.previous.values(),l=e.previous.length;for(let c=0;c<l;c++){const d=r.next().value,u=1-c/(l-1),f=e.size;if(f.x<=0&&!this.system.trails.sizeAffectsWidth){const p=20*this.system.trails.widthOverTrail.evaluate(.5,n[my]);f.x=p,f.y=p,f.z=p}d.size=this.system.trails.getWidth(f.x,o,u,n[my]),d.color.copy(e.color),this.system.trails.getColor(d.color,o,u)}if(e.age>e[Xl]){e.velocity.set(0,0,0);const c=(e.age-e[Xl])/e[py];n.length=N.lerp(e[cw],0,c)}}}}const df=Symbol("startVelocity"),hw=Symbol("gravityModifier"),gy=Symbol("gravitySpeed"),uf=Symbol("velocity lerp factor"),j_=new x;class YI extends yl{constructor(){super(...arguments);a(this,"type","NeedleVelocity");a(this,"_gravityDirection",new x)}initialize(e){var r,l;const i=this.system.main.simulationSpeed;e.startSpeed=this.system.main.startSpeed.evaluate(Math.random(),Math.random());const n=this.system.shape.getDirection(e,e.position);e.velocity.x=n.x*e.startSpeed,e.velocity.y=n.y*e.startSpeed,e.velocity.z=n.z*e.startSpeed,(r=this.system.inheritVelocity)!=null&&r.enabled&&this.system.inheritVelocity.applyInitial(e.velocity),e[df]?e[df].copy(e.velocity):e[df]=e.velocity.clone();const o=this.system.main.gravityModifier.evaluate(Math.random(),Math.random());e[hw]=o*i,e[gy]=o*i*.5,e[uf]=Math.random(),(l=this.system.velocityOverLifetime)==null||l.init(e),this._gravityDirection.set(0,-1,0),this.system.main.simulationSpace===ds.Local&&this._gravityDirection.applyQuaternion(this.system.worldQuaternionInverted).normalize()}update(e,i){var f;const n=e[df],o=e[hw];if(o!==0){const p=o*e[gy];j_.copy(this._gravityDirection).multiplyScalar(p),e[gy]+=i*.05,n.add(j_)}e.velocity.copy(n);const r=e.age/e.life;(f=this.system.inheritVelocity)!=null&&f.enabled&&this.system.inheritVelocity.applyCurrent(e.velocity,r,e[uf]);const l=this.system.noise;l.enabled&&l.apply(0,e.position,e.velocity,i,e.age,e.life);const c=this.system.sizeBySpeed;c!=null&&c.enabled&&(e.size=c.evaluate(e.velocity,r,e[uf],e.size));const h=this.system.colorBySpeed;h!=null&&h.enabled&&h.evaluate(e.velocity,e[uf],e.color);const d=this.system.velocityOverLifetime;d.enabled&&d.apply(e,0,e.position,e.velocity,i,e.age,e.life);const u=this.system.limitVelocityOverLifetime;if(u.enabled&&u.apply(e.position,n,e.velocity,e.size,r,i,1),this.system.worldspace){const p=this.system.worldScale;e.velocity.x*=p.x,e.velocity.y*=p.y,e.velocity.z*=p.z}}}const dw=Symbol("colorLerpFactor"),uw=new pe(1,1,1,1),va=new pe(1,1,1,1);class KI extends yl{constructor(){super(...arguments);a(this,"type","NeedleColor")}initialize(e){}_init(e){const i=this.system.renderer.particleMaterial;va.copy(this.system.main.startColor.evaluate(Math.random())),i!=null&&i.color&&(uw.copy(i.color),va.multiply(uw)),va.convertLinearToSRGB(),e.startColor.set(va.r,va.g,va.b,va.alpha),e.color.copy(e.startColor),e[dw]=Math.random()}update(e,i){if(e.age===0&&this._init(e),this.system.colorOverLifetime.enabled){const n=e.age/e.life,o=this.system.colorOverLifetime.color.evaluate(n,e[dw]);e.color.set(o.r,o.g,o.b,"alpha"in o?o.alpha:1).multiply(e.startColor)}else e.color.copy(e.startColor)}}class JI{constructor(t){a(this,"system");a(this,"emission");a(this,"autoDestroy");a(this,"startLength");a(this,"emissionBursts");a(this,"onlyUsedByOther");a(this,"behaviors",[]);a(this,"rendererEmitterSettings",{startLength:new kT(220),followLocalOrigin:!1});a(this,"flatWhiteTexture");a(this,"clonedTexture",{original:void 0,clone:void 0});this.system=t,this.emission=new WI(this.system)}get anim(){return this.system.textureSheetAnimation}get prewarm(){return!1}get material(){return this.system.renderer.getMaterial(this.system.trails.enabled)}get layers(){return this.system.gameObject.layers}update(){this.emission.update()}get looping(){return this.system.main.loop}get duration(){return this.system.duration}get shape(){return this.system.shape}get startLife(){return new hf(this.system.main.startLifetime)}get startSpeed(){return new hf(this.system.main.startSpeed)}get startRotation(){return new hf(this.system.main.startRotation)}get startSize(){return new hf(this.system.main.startSize)}get startColor(){return new TT(new OT(1,1,1,1))}get emissionOverTime(){return this.emission}get emissionOverDistance(){return new VI(this.system)}get instancingGeometry(){return this.system.renderer.getMesh(this.system.renderer.renderMode).geometry}get renderMode(){if(this.system.trails.enabled===!0)return So.Trail;switch(this.system.renderer.renderMode){case zs.Billboard:return So.BillBoard;case zs.Stretch:return So.StretchedBillBoard;case zs.HorizontalBillboard:return So.HorizontalBillBoard;case zs.VerticalBillboard:return So.VerticalBillBoard;case zs.Mesh:return So.Mesh}return So.BillBoard}get speedFactor(){var e;let t=this.system.main.simulationSpeed;return((e=this.system.renderer)==null?void 0:e.renderMode)===zs.Stretch&&(t*=this.system.renderer.velocityScale??1),t}get texture(){const t=this.material;if(t&&t.map){const e=t.map;if(this.clonedTexture.original!==e||!this.clonedTexture.clone){const i=e.clone();i.premultiplyAlpha=!1,i.colorSpace=Xo,this.clonedTexture.original=e,this.clonedTexture.clone=i}return this.clonedTexture.clone}return this.flatWhiteTexture||(this.flatWhiteTexture=Ob(new pe(1,1,1,1),1)),this.flatWhiteTexture}get startTileIndex(){return new $I(this.system)}get uTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesX:void 0}get vTileCount(){var t;return this.anim.enabled?(t=this.anim)==null?void 0:t.numTilesY:void 0}get renderOrder(){return 1}get blending(){var t;return((t=this.system.renderer.particleMaterial)==null?void 0:t.blending)??NR}get transparent(){return this.system.renderer.transparent}get worldSpace(){return this.system.main.simulationSpace===ds.World}}class ZI{constructor(){a(this,"burstParticleIndex",0);a(this,"burstParticleCount",0);a(this,"isBursting",!1);a(this,"travelDistance",0);a(this,"previousWorldPos");a(this,"burstIndex",0);a(this,"burstWaveIndex",0);a(this,"time",0);a(this,"waitEmiting",0)}}class st extends j{constructor(){super(...arguments);a(this,"_state");a(this,"colorOverLifetime");a(this,"main");a(this,"emission");a(this,"sizeOverLifetime");a(this,"shape");a(this,"noise");a(this,"trails");a(this,"velocityOverLifetime");a(this,"limitVelocityOverLifetime");a(this,"inheritVelocity");a(this,"colorBySpeed");a(this,"textureSheetAnimation");a(this,"rotationOverLifetime");a(this,"rotationBySpeed");a(this,"sizeBySpeed");a(this,"_cameraScale",1);a(this,"__worldQuaternion",new H);a(this,"_worldQuaternionInverted",new H);a(this,"_worldScale",new x);a(this,"_worldPositionFrame",-1);a(this,"_worldPos",new x);a(this,"_renderer");a(this,"_batchSystem");a(this,"_particleSystem");a(this,"_interface");a(this,"_container");a(this,"_time",0);a(this,"_isPlaying",!0);a(this,"_isUsedAsSubsystem",!1);a(this,"_didPreWarm",!1);a(this,"_bursts");a(this,"_subEmitterSystems");a(this,"_lastBatchesCount",-1)}play(e=!1){var i;e&&C.foreachComponent(this.gameObject,n=>{n instanceof st&&n!==this&&n.play(!1)},!0),this._isPlaying=!0,this._particleSystem&&(this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1),(i=this.emission)==null||i.reset()}pause(e=!0){e&&C.foreachComponent(this.gameObject,i=>{i instanceof st&&i!==this&&i.pause(!1)},!0),this._isPlaying=!1}stop(e=!0,i=!1){e&&C.foreachComponent(this.gameObject,n=>{n instanceof st&&n!==this&&n.stop(!1,i)},!0),this._isPlaying=!1,this._time=0,i&&this.reset()}reset(){var e;this._time=0,this._particleSystem&&(this._particleSystem.particleNum=0,this._particleSystem.emissionState.time=0,this._particleSystem.emitEnded=!1,(e=this.emission)==null||e.reset())}emit(e){if(this._particleSystem){this.onUpdate(),e=Math.min(e,this.maxParticles-this.currentParticles),this._state||(this._state=new ZI),this._state.waitEmiting=e,this._state.time=0;const i=this._particleSystem.emitEnded;this._particleSystem.emitEnded=!1,this._particleSystem.emit(this.deltaTime,this._state,this._particleSystem.emitter.matrixWorld),this._particleSystem.emitEnded=i}}get playOnAwake(){return this.main.playOnAwake}set playOnAwake(e){this.main.playOnAwake=e}get renderer(){return this._renderer}get isPlaying(){return this._isPlaying}get currentParticles(){var e;return((e=this._particleSystem)==null?void 0:e.particleNum)??0}get maxParticles(){return this.main.maxParticles}get time(){return this._time}get duration(){return this.main.duration}get deltaTime(){return this.context.time.deltaTime*this.main.simulationSpeed}get scale(){return this.gameObject.scale.x}get cameraScale(){return this._cameraScale}get container(){return this._container}get worldspace(){return this.main.simulationSpace===ds.World}get localspace(){return this.main.simulationSpace===ds.Local}get worldQuaternion(){return this.__worldQuaternion}get worldQuaternionInverted(){return this._worldQuaternionInverted}get worldScale(){return this._worldScale}get worldPos(){return this._worldPositionFrame!==this.context.time.frame&&(this._worldPositionFrame=this.context.time.frame,ae(this.gameObject,this._worldPos)),this._worldPos}get matrixWorld(){return this._container.matrixWorld}get isSubsystem(){return this._isUsedAsSubsystem}addBehaviour(e){return this._particleSystem?(e instanceof yl&&(e.system=this),Sr&&console.debug("Add custom ParticleSystem Behaviour",e),this._particleSystem.addBehavior(e),!0):!1}removeBehaviour(e){if(!this._particleSystem)return!1;const i=this._particleSystem.behaviors,n=i.indexOf(e);return n!==-1&&((U()||Sr)&&console.debug("Remove custom ParticleSystem Behaviour",n,e),i.splice(n,1)),!0}removeAllBehaviours(){return this._particleSystem?(this._particleSystem.behaviors.length=0,!0):!1}get behaviours(){return this._particleSystem?this._particleSystem.behaviors:null}get particleSystem(){return this._particleSystem??null}set bursts(e){for(let i=0;i<e.length;i++){const n=e[i];if(!(n instanceof A_)){const o=new A_;Oc(o,n),e[i]=o}}this._bursts=e}set subEmitterSystems(e){for(let i=0;i<e.length;i++){const n=e[i];if(!(n instanceof B_)){const o=new B_;Oc(o,n),e[i]=o}}Sr&&e.length>0&&console.log("SubEmitters: ",e,this),this._subEmitterSystems=e}onAfterDeserialize(e){if(this._subEmitterSystems&&Array.isArray(this._subEmitterSystems))for(const i of this._subEmitterSystems)i._deserialize(this.context,this.gameObject)}awake(){if(this._worldPositionFrame=-1,this._renderer=this.gameObject.getComponent(bs),!this.main)throw new Error("Not Supported: ParticleSystem needs a serialized MainModule. Creating new particle systems at runtime is currently not supported.");this._container=new D,this._container.matrixAutoUpdate=!1,this.context.scene.add(this._container),this._batchSystem=new PT,this._batchSystem.name=this.gameObject.name,this._container.add(this._batchSystem),this._interface=new JI(this),this._particleSystem=new RT(this._interface),this._particleSystem.addBehavior(new XI(this)),this._particleSystem.addBehavior(new KI(this)),this._particleSystem.addBehavior(new HI(this)),this._particleSystem.addBehavior(new GI(this)),this._particleSystem.addBehavior(new YI(this)),this._particleSystem.addBehavior(new QI(this)),this._batchSystem.addSystem(this._particleSystem);const e=this._particleSystem.emitter;this.context.scene.add(e),this.inheritVelocity.system&&this.inheritVelocity.system!==this&&(this.inheritVelocity=this.inheritVelocity.clone()),this.inheritVelocity.awake(this),Sr&&(console.log(this),this.gameObject.add(new yn(1)))}start(){this.addSubParticleSystems(),this.updateLayers(),this.renderer.particleMesh instanceof X&&this._interface.renderMode==So.Mesh&&pt.assignMeshLOD(this.renderer.particleMesh,0).then(e=>{e&&this.particleSystem&&this._interface.renderMode==So.Mesh&&(this.particleSystem.instancingGeometry=e)})}onDestroy(){var e,i,n,o;(e=this._container)==null||e.removeFromParent(),(i=this._batchSystem)==null||i.removeFromParent(),(n=this._particleSystem)==null||n.emitter.removeFromParent(),(o=this._particleSystem)==null||o.dispose()}onEnable(){this.main&&(this.inheritVelocity&&(this.inheritVelocity.system=this),this._batchSystem&&(this._batchSystem.visible=!0),this.playOnAwake&&this.play(),this._isPlaying=this.playOnAwake)}onDisable(){this._batchSystem&&(this._batchSystem.visible=!1)}onBeforeRender(){var e;this.main&&(this._didPreWarm===!1&&((e=this.main)==null?void 0:e.prewarm)===!0&&(this._didPreWarm=!0,this.preWarm()),this.onUpdate(),this.onSimulate(this.deltaTime))}preWarm(){var d;if(!((d=this.emission)!=null&&d.enabled)||this.emission.rateOverTime.getMax()<=0)return;const i=1/60,n=this.main.duration,o=this.main.startLifetime.getMax(),r=1e3,l=Math.min(Math.max(n,o)/Math.max(.01,this.main.simulationSpeed),r),c=Math.ceil(l/i),h=Date.now();Sr&&console.log(`Particles ${this.name} - Prewarm for ${c} frames (${l} sec). Duration: ${n}, Lifetime: ${o}`);for(let u=0;u<c&&!(this.currentParticles>=this.maxParticles);u++){const f=Date.now()-h;if(f>2e3){console.warn(`Particles ${this.name} - Prewarm took too long. Aborting: ${f}`);break}this.onUpdate(),this.onSimulate(i)}}onSimulate(e){if(this._batchSystem){let i=this.context.time.frameCount%60===0;this._lastBatchesCount!==this._batchSystem.batches.length&&(this._lastBatchesCount=this._batchSystem.batches.length,i=!0),i&&this.updateLayers(),this._batchSystem.update(e)}this._time+=e,this._time>this.duration&&(this._time=0)}updateLayers(){if(this._batchSystem)for(let e=0;e<this._batchSystem.batches.length;e++){const i=this._batchSystem.batches[e];i.layers.disableAll();const n=this.layer;i.layers.mask=1<<n}}onUpdate(){var o,r;if(this._bursts&&(this.emission.bursts=this._bursts,delete this._bursts),!this._isPlaying)return;const e=this.context.mainCamera;if(e){const l=_t(e);this._cameraScale=l.x}const i=!this.worldspace,n=this.gameObject;if(Le(n,this.__worldQuaternion),this._worldQuaternionInverted.copy(this.__worldQuaternion).invert(),_t(this.gameObject,this._worldScale),i&&this._container&&((o=this.gameObject)!=null&&o.parent)){const l=sP(this,j_);this._container.matrix.makeScale(l.x,l.y,l.z),this._container.matrix.makeRotationFromQuaternion(this.__worldQuaternion),this._container.matrix.setPosition(this.worldPos),this._container.matrix.scale(this.gameObject.scale)}this.emission.system=this,this._interface.update(),this.shape.onUpdate(this,this.context,this.main.simulationSpace,this.gameObject),this.noise.update(this.context),(r=this.inheritVelocity)==null||r.update(this.context),this.velocityOverLifetime.update(this)}addSubParticleSystems(){var e;if(this._subEmitterSystems&&this._particleSystem)for(const i of this._subEmitterSystems){i.particleSystem&&(i.particleSystem.__internalAwake?i.particleSystem.__internalAwake():U()&&console.warn("SubParticleSystem serialization issue(?)",i.particleSystem,i));const n=(e=i.particleSystem)==null?void 0:e._particleSystem;if(n){i.particleSystem._isUsedAsSubsystem=!0;const o=new nP(this,this._particleSystem,i.particleSystem,n);o.emitterType=i.type,o.emitterProbability=i.emitProbability,this._particleSystem.addBehavior(o)}else Sr&&console.warn("Could not add SubParticleSystem",i,this)}}}rt([m(n0)],st.prototype,"colorOverLifetime",void 0);rt([m(Bi)],st.prototype,"main",void 0);rt([m(sa)],st.prototype,"emission",void 0);rt([m(Kc)],st.prototype,"sizeOverLifetime",void 0);rt([m(We)],st.prototype,"shape",void 0);rt([m(je)],st.prototype,"noise",void 0);rt([m(lt)],st.prototype,"trails",void 0);rt([m(mt)],st.prototype,"velocityOverLifetime",void 0);rt([m(Nt)],st.prototype,"limitVelocityOverLifetime",void 0);rt([m(oa)],st.prototype,"inheritVelocity",void 0);rt([m(_u)],st.prototype,"colorBySpeed",void 0);rt([m(Fi)],st.prototype,"textureSheetAnimation",void 0);rt([m(uo)],st.prototype,"rotationOverLifetime",void 0);rt([m(_s)],st.prototype,"rotationBySpeed",void 0);rt([m(Pn)],st.prototype,"sizeBySpeed",void 0);class B_{constructor(){a(this,"particleSystem");a(this,"emitProbability",1);a(this,"properties");a(this,"type")}_deserialize(t,e){const i=this.particleSystem;if(i instanceof st)return;let n="";i&&typeof i.guid=="string"&&(n=i.guid,this.particleSystem=C.findByGuid(n,e)),Sr&&!(this.particleSystem instanceof st)&&console.warn("Could not find particle system for sub emitter",n,e,this)}}function sP(s,t){if(t.set(1,1,1),s.gameObject.parent&&s.localspace)switch(s.main.scalingMode){case bp.Local:t=_t(s.gameObject.parent,t),t.x=1/t.x,t.y=1/t.y,t.z=1/t.z;break;default:if(!s.unsupported_scaling_mode){s.unsupported_scaling_mode=!0;const e="ParticleSystem scale mode "+bp[s.main.scalingMode]+" is not supported";U()&&ke(e),console.warn(e,s.name,s)}t=_t(s.gameObject,t);break}return t}var o0=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class bu extends j{constructor(){super(...arguments);a(this,"strength",1);a(this,"radius",2);a(this,"targets",[])}update(){var n;const e=this.gameObject.worldPosition,i=-this.strength*this.context.time.deltaTime;(n=this.targets)==null||n.forEach(o=>{if(!o)return;const r=o.gameObject.worldPosition.sub(e),l=r.length();if(l>this.radius)return;let c=i;l>1?c/=l*l:c/=Math.max(.05,l),o.applyImpulse(r.multiplyScalar(c))})}}o0([m()],bu.prototype,"strength",void 0);o0([m()],bu.prototype,"radius",void 0);o0([m(xe)],bu.prototype,"targets",void 0);class Yd extends j{constructor(){super(...arguments);a(this,"_didAssignPlayerColor",!1);a(this,"tryAssignColor",()=>{const e=C.getComponentInParent(this.gameObject,Kt);if(e&&e.owner)return this._didAssignPlayerColor=!0,this.assignUserColor(e.owner),!0;const i=C.getComponentInParent(this.gameObject,Lt);return i!=null&&i.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(i.connectionId),!0):!1})}onEnable(){this.context.connection.beginListen(se.JoinedRoom,this.tryAssignColor),this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}onDisable(){this.context.connection.stopListen(se.JoinedRoom,this.tryAssignColor)}*waitForConnection(){for(;!this.destroyed&&this.activeAndEnabled&&(yield KC(.2),!this.tryAssignColor()););}assignUserColor(e){const i=Yd.hashCode(e),n=Yd.colorFromHashCode(i);if(this.gameObject.type==="Mesh"){const o=this.gameObject;this.assignColor(n,e,o)}else if(this.gameObject.children)for(const o of this.gameObject.children){const r=o;r.material&&r.material.color&&this.assignColor(n,e,r)}}assignColor(e,i,n){let o=n.material;o&&(o._playerMaterial!==i&&(o=o.clone(),o._playerMaterial=i,n.material=o),o.color=e)}static hashCode(e){var i=0,n,o;if(e.length===0)return i;for(n=0;n<e.length;n++)o=e.charCodeAt(n),i=(i<<5)-i+o,i|=0;return i}static colorFromHashCode(e){const i=(e&16711680)>>16,n=(e&65280)>>8,o=e&255;return new de(i/255,n/255,o/255)}}const qh=S("debugpost");let F_=null;function eD(s){F_=s}function oP(s){let t=s.gameObject;for(;t;){for(const e of Tb(t))if(e.isPostProcessingManager===!0)return e;t=t.parent}return null}function tD(s){let t=oP(s);if(!t)if(F_){qh&&console.warn("Adding postprocessing manager to the scene.");const e=s.scene;t=Ks(e,F_)}else U()&&console.warn("No post processing manager found");return t}const kt={AT_START:-1e4,NormalPass:0,DepthDownsamplingPass:10,SSAO:20,SMAA:30,TiltShift:40,DepthOfField:50,ChromaticAberration:60,Bloom:70,Vignette:80,Pixelation:90,ToneMapping:100,HueSaturation:110,BrightnessContrast:120,Sharpening:130,AT_END:1e4};let gt=null;function iD(s){qh==="verbose"&&console.debug("Before ordering effects",[...s]),gt||(gt=new Map,gt.set(F.POSTPROCESSING.MODULE.NormalPass,kt.NormalPass),gt.set(F.POSTPROCESSING.MODULE.DepthDownsamplingPass,kt.DepthDownsamplingPass),gt.set(F.POSTPROCESSING.MODULE.SMAAEffect,kt.SMAA),gt.set(F.POSTPROCESSING.MODULE.SSAOEffect,kt.SSAO),gt.set(F.POSTPROCESSING_AO.MODULE.N8AOPostPass,kt.SSAO),gt.set(F.POSTPROCESSING_AO.MODULE.N8AOPass,kt.SSAO),gt.set(F.POSTPROCESSING.MODULE.TiltShiftEffect,kt.TiltShift),gt.set(F.POSTPROCESSING.MODULE.DepthOfFieldEffect,kt.DepthOfField),gt.set(F.POSTPROCESSING.MODULE.ChromaticAberrationEffect,kt.ChromaticAberration),gt.set(F.POSTPROCESSING.MODULE.BloomEffect,kt.Bloom),gt.set(F.POSTPROCESSING.MODULE.SelectiveBloomEffect,kt.Bloom),gt.set(F.POSTPROCESSING.MODULE.VignetteEffect,kt.Vignette),gt.set(F.POSTPROCESSING.MODULE.PixelationEffect,kt.Pixelation),gt.set(F.POSTPROCESSING.MODULE.ToneMappingEffect,kt.ToneMapping),gt.set(F.POSTPROCESSING.MODULE.HueSaturationEffect,kt.HueSaturation),gt.set(F.POSTPROCESSING.MODULE.BrightnessContrastEffect,kt.BrightnessContrast)),s.sort((t,e)=>{const i=typeof t.priority=="number"?t.priority:gt.get(t.effect.constructor)??Number.NEGATIVE_INFINITY,n=typeof e.priority=="number"?e.priority:gt.get(e.effect.constructor)??Number.NEGATIVE_INFINITY;return i===Number.NEGATIVE_INFINITY?(qh&&console.warn("Unknown effect found: ",t.constructor.name,t),1):n===Number.NEGATIVE_INFINITY?(qh&&console.warn("Unknown effect found: ",e.constructor.name,e),-1):i-n}),qh==="verbose"&&console.debug("After ordering effects",[...s])}var rP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const nD=S("debugpost");class W{constructor(t){a(this,"isVolumeParameter",!0);a(this,"_isInitialized",!1);a(this,"_active",!0);a(this,"_value");a(this,"_valueRaw");a(this,"_defaultValue");a(this,"valueProcessor");a(this,"onValueChanged");t!==void 0&&this.initialize(t)}get isInitialized(){return this._isInitialized}initialize(t){t!==void 0&&(this._value=t,this._defaultValue=t,this._valueRaw=t,this._isInitialized=!0)}get overrideState(){return this._active}set overrideState(t){if(this._active===t)return;this._active=t;const e=t?this._valueRaw:this._defaultValue;this.processValue(e,!0)}get value(){return this._valueRaw}set value(t){this.isInitialized||this.initialize(t),this.processValue(t,!1)}set defaultValue(t){this._defaultValue=t}__init(){this.processValue(this._valueRaw,!0)}processValue(t,e){if(t==null||!e&&this.testIfValueChanged(t)===!1)return;const i=this._value;nD&&typeof i=="number"&&typeof t=="number"&&(i==null||i.toFixed(4),t==null||t.toFixed(4)),!this._active&&this._defaultValue!==void 0?(this._value=this._defaultValue,t=this._defaultValue,this._valueRaw=t):(this._valueRaw=t,this._active&&this.valueProcessor&&(t=this.valueProcessor(t)),this._value=t),this.onValueChanged&&this.onValueChanged(t,i,this)}testIfValueChanged(t){return this._valueRaw!==t}}rP([m()],W.prototype,"overrideState",null);rP([m()],W.prototype,"value",null);class sD extends Gn{constructor(){super([W])}onSerialize(t,e){}onDeserialize(t,e){const i=e.target,n=e.path;let o;if(i&&n&&(o=i[n]),(typeof o!="object"||typeof o=="object"&&o.isVolumeParameter!==!0)&&(o=new W),typeof t=="object"&&"value"in t){const r=t.value;o.initialize(r),o.overrideState=t.overrideState}else o.value=t;return o}}new sD;var oD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const yy=S("debugpost");class Pt extends j{constructor(e=void 0){super();a(this,"order");a(this,"active",!0);a(this,"_manager",null);a(this,"_result");a(this,"_postprocessingContext",null);if(e)for(const i of Object.keys(e)){const n=e[i],o=this[i];o instanceof W?o.initialize(n):o!==void 0&&(this[i]=n)}}get isPostProcessingEffect(){return!0}onEnable(){super.onEnable(),yy&&console.warn("Enable",this.constructor.name+(this.__internalDidAwakeAndStart?"":" (awake)")),this.__internalDidAwakeAndStart&&(this.active=!0),this.onEffectEnabled()}onDisable(){var e;super.onDisable(),yy&&console.warn("Disable",this.constructor.name),(e=this._manager)==null||e.removeEffect(this),this.active=!1}onEffectEnabled(e){e&&e.isPostProcessingManager===!0?this._manager=e:this._manager||(this._manager=tD(this)),this._manager.addEffect(this),this._manager.dirty=!0}init(){}get postprocessingContext(){return this._postprocessingContext}apply(e){var i;return this._postprocessingContext=e,this._result||(this.initParameters(),this._result=(i=this.onCreateEffect)==null?void 0:i.call(this)),this._result&&this.initParameters(),this._result}unapply(){}dispose(){yy&&console.warn("DISPOSE",this),this._result&&(Array.isArray(this._result)?this._result.forEach(e=>e.dispose()):this._result.dispose()),this._result=void 0}initParameters(){const e=Object.keys(this);for(const i of e){const n=this[i];n instanceof W&&n.__init()}}onEditorModification(e){const i=e.propertyName;if(this[i]instanceof W){const n=e.value;return this[i].value=n,!0}}}oD([m()],Pt.prototype,"active",void 0);var rD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const aD=S("debugpost"),z_={};function vs(s,t){z_[s]=t}function lD(s){return s.__type in z_?z_[s.__type]:(aD&&s.__type&&console.warn("Unknown postprocessing type",s.__type,s),Pt)}class r0{constructor(){a(this,"components",[])}__init(t){var e;(e=this.components)==null||e.forEach(i=>{i.gameObject===void 0&&t.gameObject.addComponent(i),i.init()})}addEffect(t){this.components.push(t)}removeEffect(t){const e=this.components.indexOf(t);e>=0&&this.components.splice(e,1)}}rD([Rt([s=>lD(s),Pt])],r0.prototype,"components",void 0);var cD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const hD=S("debugpost");var fw;(function(s){s[s.LOW=0]="LOW",s[s.MEDIUM=1]="MEDIUM",s[s.HIGH=2]="HIGH",s[s.ULTRA=3]="ULTRA"})(fw||(fw={}));class Am extends Pt{constructor(){super(...arguments);a(this,"preset",new W(2))}get typeName(){return"Antialiasing"}onCreateEffect(){var i;const e=new F.POSTPROCESSING.MODULE.SMAAEffect({preset:((i=this.preset)==null?void 0:i.value)??F.POSTPROCESSING.MODULE.SMAAPreset.HIGH,edgeDetectionMode:F.POSTPROCESSING.MODULE.EdgeDetectionMode.LUMA});return this.preset.onValueChanged=n=>{hD&&console.log("Antialiasing preset changed to",n),e.applyPreset(n)},e}}cD([m(W)],Am.prototype,"preset",void 0);vs("Antialiasing",Am);var a0=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const M0=class extends Pt{constructor(){super(...arguments);a(this,"threshold",new W(.9));a(this,"intensity",new W(1));a(this,"scatter",new W(.7));a(this,"selectiveBloom")}get typeName(){return"Bloom"}init(){this.threshold.valueProcessor=e=>e,this.intensity.valueProcessor=e=>e,this.scatter.valueProcessor=e=>e}onCreateEffect(){let e;if(this.selectiveBloom==null&&(this.selectiveBloom=M0.useSelectiveBloom),this.selectiveBloom){const i=e=new F.POSTPROCESSING.MODULE.SelectiveBloomEffect(this.context.scene,this.context.mainCamera,{blendFunction:F.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});i.inverted=!0}else e=new F.POSTPROCESSING.MODULE.BloomEffect({blendFunction:F.POSTPROCESSING.MODULE.BlendFunction.ADD,mipmapBlur:!0,luminanceThreshold:this.threshold.value,luminanceSmoothing:this.scatter.value,radius:.85,intensity:this.intensity.value});return this.intensity.onValueChanged=i=>{e.intensity=i},this.threshold.onValueChanged=i=>{e.luminanceMaterial.threshold=Math.pow(i,2.2)},this.scatter.onValueChanged=i=>{e.luminancePass.enabled=!0,e.luminanceMaterial.smoothing=i,e.mipmapBlurPass&&(e.mipmapBlurPass.radius=Fo.lerp(.1,.9,i))},e}};let Ho=M0;a(Ho,"useSelectiveBloom",!1);a0([m(W)],Ho.prototype,"threshold",void 0);a0([m(W)],Ho.prototype,"intensity",void 0);a0([m(W)],Ho.prototype,"scatter",void 0);vs("Bloom",Ho);var dD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Im extends Pt{constructor(){super(...arguments);a(this,"intensity",new W(0))}get typeName(){return"ChromaticAberration"}onCreateEffect(){const e=new F.POSTPROCESSING.MODULE.ChromaticAberrationEffect;return e.offset=new le(0,0),e.radialModulation=!0,e.modulationOffset=.15,this.intensity.valueProcessor=i=>i*.02,this.intensity.onValueChanged=i=>{e.offset.x=-i,e.offset.y=i},e}}dD([m(W)],Im.prototype,"intensity",void 0);vs("ChromaticAberration",Im);var Yt;(function(s){s[s.None=0]="None",s[s.Neutral=1]="Neutral",s[s.ACES=2]="ACES",s[s.AgX=3]="AgX",s[s.KhronosNeutral=4]="KhronosNeutral"})(Yt||(Yt={}));const pw=new Map;function _y(s){switch(s){case Yt.None:return tb;case Yt.Neutral:return eb;case Yt.ACES:return Xp;case Yt.AgX:return qp;case Yt.KhronosNeutral:return wc;default:return pw.has(s)||(pw.set(s,!0),console.warn("[Postprocessing] Unknown tone mapping mode",s)),wc}}function uD(s){switch(s){case tb:return Yt.None;case Xp:return Yt.ACES;case qp:return Yt.AgX;case wc:return Yt.Neutral;case eb:return Yt.Neutral;default:return Yt.None}}function Lf(s){switch(s){case tb:return F.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR;case Xp:return F.POSTPROCESSING.MODULE.ToneMappingMode.ACES_FILMIC;case qp:return F.POSTPROCESSING.MODULE.ToneMappingMode.AGX;case wc:return F.POSTPROCESSING.MODULE.ToneMappingMode.NEUTRAL;case eb:return F.POSTPROCESSING.MODULE.ToneMappingMode.REINHARD;default:return F.POSTPROCESSING.MODULE.ToneMappingMode.LINEAR}}var aP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const by=S("debugpost");class sl extends Pt{constructor(){super(...arguments);a(this,"mode",new W(void 0));a(this,"exposure",new W(1));a(this,"_tonemappingEffect",null)}get typeName(){return"ToneMapping"}setMode(e){const i=Yt[e];return i===void 0?(console.error("[PostProcessing] Invalid ToneMapping mode",e),this):(this.mode.value=i,this)}get isToneMapping(){return!0}onEffectEnabled(){const e=oP(this);e&&super.onEffectEnabled(e)}onCreateEffect(){var n;if(this.mode.isInitialized==!1){const o=uD(this.context.renderer.toneMapping);by&&console.log("[PostProcessing] Initializing ToneMapping mode to renderer.toneMapping",this.context.renderer.toneMapping+" â†’ "+o),this.mode.initialize(o)}(n=this._tonemappingEffect)==null||n.dispose();const e=_y(this.mode.value),i=this._tonemappingEffect=new F.POSTPROCESSING.MODULE.ToneMappingEffect({mode:Lf(e)});return this.mode.onValueChanged=o=>{if(typeof o=="string")o=e1(o),i.mode=Lf(o);else{const r=_y(o);i.mode=Lf(r)}i.name="ToneMapping ("+Yt[o]+")",by&&console.log("[PostProcessing] ToneMapping mode changed to",Yt[o],e,i.mode)},by&&console.log("[PostProcessing] Use ToneMapping",Yt[this.mode.value],e,i.mode,"renderer.tonemapping: "+this.context.renderer.toneMapping),i}onBeforeRender(){var e;if(this._tonemappingEffect&&((e=this.postprocessingContext)!=null&&e.handler.getEffectIsActive(this._tonemappingEffect))&&(this.mode.overrideState&&(this.context.renderer.toneMapping=_y(this.mode.value)),this.exposure.overrideState&&this.exposure.value!==void 0)){const i=Math.max(0,this.exposure.value);this.context.renderer.toneMappingExposure=i}}}aP([m(W)],sl.prototype,"mode",void 0);aP([m(W)],sl.prototype,"exposure",void 0);vs("Tonemapping",sl);var Dm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class _l extends Pt{constructor(){super(...arguments);a(this,"remap",!0);a(this,"postExposure",new W(1));a(this,"contrast",new W(0));a(this,"hueShift",new W(0));a(this,"saturation",new W(0))}get typeName(){return"ColorAdjustments"}init(){this.postExposure.valueProcessor=e=>(this.remap&&(e=Math.pow(2,e)),e),this.contrast.valueProcessor=e=>{if(!this.remap)return e;let i=1;return e>0?i=200:e<0&&(i=100),e/i},this.contrast.defaultValue=0,this.hueShift.valueProcessor=e=>this.remap?Math.PI*e/180:e,this.hueShift.defaultValue=0,this.saturation.valueProcessor=e=>this.remap?e<0?e/100:e/(100*Math.PI):e,this.saturation.defaultValue=0}onCreateEffect(){var r,l;const e=[];let i=(r=this.postprocessingContext)==null?void 0:r.components.find(c=>c instanceof sl);i||(i=new sl,(l=this.postprocessingContext)==null||l.components.push(i)),this.postExposure.onValueChanged=c=>{this.postExposure.overrideState&&i?i.exposure.value=c:console.warn("[PostProcessing] PostExposure is set to override but no ToneMappingEffect found in the postprocessing stack. Please add a ToneMappingEffect to your postprocessing stack to use PostExposure.")};const n=new F.POSTPROCESSING.MODULE.BrightnessContrastEffect;this.contrast.onValueChanged=c=>n.contrast=c;const o=new F.POSTPROCESSING.MODULE.HueSaturationEffect;return this.hueShift.onValueChanged=c=>o.hue=c,this.saturation.onValueChanged=c=>o.saturation=c,e.push(n),e.push(o),e}}Dm([m(W)],_l.prototype,"postExposure",void 0);Dm([m(W)],_l.prototype,"contrast",void 0);Dm([m(W)],_l.prototype,"hueShift",void 0);Dm([m(W)],_l.prototype,"saturation",void 0);vs("ColorAdjustments",_l);var bl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},U_;(function(s){s[s.Off=0]="Off",s[s.Gaussian=1]="Gaussian",s[s.Bokeh=2]="Bokeh"})(U_||(U_={}));const fD=S("debugpost");class fo extends Pt{constructor(){super(...arguments);a(this,"mode");a(this,"focusDistance",new W(1));a(this,"focalLength",new W(.2));a(this,"aperture",new W(20));a(this,"gaussianMaxRadius",new W);a(this,"resolutionScale",new W(1*1/window.devicePixelRatio));a(this,"bokehScale",new W)}get typeName(){return"DepthOfField"}init(){this.focalLength.valueProcessor=i=>{const n=i/300,o=2;return N.lerp(o,.01,n)};const e=20;this.aperture.valueProcessor=i=>{const n=1-i/32;return N.lerp(1,e,n)}}onCreateEffect(){if(this.mode===U_.Off){fD&&console.warn("DepthOfField: Mode is set to Off");return}const e=new F.POSTPROCESSING.MODULE.DepthOfFieldEffect(this.context.mainCamera,{worldFocusRange:.2,focalLength:1,bokehScale:20,resolutionScale:this.resolutionScale.value});return this.focusDistance.onValueChanged=i=>{e.cocMaterial.worldFocusDistance=i},this.focalLength.onValueChanged=i=>e.cocMaterial.worldFocusRange=i,this.aperture.onValueChanged=i=>e.bokehScale=i,this.resolutionScale&&(this.resolutionScale.onValueChanged=i=>e.resolution.scale=i),[e]}unapply(){}}bl([m()],fo.prototype,"mode",void 0);bl([m(W)],fo.prototype,"focusDistance",void 0);bl([m(W)],fo.prototype,"focalLength",void 0);bl([m(W)],fo.prototype,"aperture",void 0);bl([m(W)],fo.prototype,"gaussianMaxRadius",void 0);bl([m(W)],fo.prototype,"resolutionScale",void 0);bl([m(W)],fo.prototype,"bokehScale",void 0);vs("DepthOfField",fo);class wp extends Pt{constructor(e){super();a(this,"effect");this.effect=e}get typeName(){return this.effect.constructor.name}onCreateEffect(){return this.effect}}var pD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Lm extends Pt{constructor(){super(...arguments);a(this,"granularity",new W(10))}get typeName(){return"PixelationEffect"}onCreateEffect(){const e=new F.POSTPROCESSING.MODULE.PixelationEffect;return this.granularity.onValueChanged=i=>{e.granularity=i},e}}pD([m(W)],Lm.prototype,"granularity",void 0);vs("PixelationEffect",Lm);var vu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ra extends Pt{constructor(){super(...arguments);a(this,"intensity",new W(2));a(this,"falloff",new W(1));a(this,"samples",new W(9));a(this,"color",new W(new de(0,0,0)));a(this,"luminanceInfluence",new W(.7));a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusion"}onBeforeRender(){if(this._ssao&&this.context.mainCamera instanceof Se){const e=this.context.mainCamera.far-this.context.mainCamera.near;this._ssao.ssaoMaterial.worldDistanceFalloff=e*.01,this._ssao.ssaoMaterial.worldDistanceThreshold=this.context.mainCamera.far}}onCreateEffect(){const e=this.context.mainCamera,i=new F.POSTPROCESSING.MODULE.NormalPass(this.context.scene,e),n=new F.POSTPROCESSING.MODULE.DepthDownsamplingPass({normalBuffer:i.texture,resolutionScale:.5}),o=this._ssao=new F.POSTPROCESSING.MODULE.SSAOEffect(e,i.texture,{normalDepthBuffer:n.texture,worldDistanceThreshold:1,worldDistanceFalloff:1,worldProximityThreshold:.1,worldProximityFalloff:2,intensity:1,blendFunction:F.POSTPROCESSING.MODULE.BlendFunction.MULTIPLY,luminanceInfluence:.5});this.intensity.onValueChanged=l=>{o.intensity=l},this.falloff.onValueChanged=l=>{o.ssaoMaterial.radius=l*.1},this.samples.onValueChanged=l=>{o.ssaoMaterial.samples=l},this.color.onValueChanged=l=>{o.color||(o.color=new de),o.color.copy(l)},this.luminanceInfluence.onValueChanged=l=>{o.luminanceInfluence=l};const r=new Array;return r.push(i),r.push(n),r.push(o),r}}vu([m(W)],ra.prototype,"intensity",void 0);vu([m(W)],ra.prototype,"falloff",void 0);vu([m(W)],ra.prototype,"samples",void 0);vu([m(W)],ra.prototype,"color",void 0);vu([m(W)],ra.prototype,"luminanceInfluence",void 0);vs("ScreenSpaceAmbientOcclusion",ra);var vl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const mD=S("debugN8AO");var bd;(function(s){s[s.Performance=0]="Performance",s[s.Low=1]="Low",s[s.Medium=2]="Medium",s[s.High=3]="High",s[s.Ultra=4]="Ultra"})(bd||(bd={}));class po extends Pt{constructor(){super(...arguments);a(this,"gammaCorrection",!0);a(this,"aoRadius",new W(1));a(this,"falloff",new W(1));a(this,"intensity",new W(1));a(this,"color",new W(new de(0,0,0)));a(this,"screenspaceRadius",!1);a(this,"quality",bd.Medium);a(this,"_ssao")}get typeName(){return"ScreenSpaceAmbientOcclusionN8"}get pass(){return this._ssao}onValidate(){this._ssao&&(this._ssao.setQualityMode(bd[this.quality]),this._ssao.configuration.gammaCorrection=this.gammaCorrection,this._ssao.configuration.screenSpaceRadius=this.screenspaceRadius)}onCreateEffect(){const e=this.context.mainCamera,i=this.context.domWidth,n=this.context.domHeight,o=this._ssao=new F.POSTPROCESSING_AO.MODULE.N8AOPostPass(this.context.scene,e,i,n);o.name="SSAO_N8";const r=bd[this.quality];o.setQualityMode(r),o.configuration.transparencyAware=!1;const l=new io(i,n);return o.configuration.beautyRenderTarget=l,o.configuration.autoRenderBeauty=!1,o.configuration.gammaCorrection=this.gammaCorrection,o.configuration.screenSpaceRadius=this.screenspaceRadius,mD&&(o.enableDebugMode(),console.log(o),setInterval(()=>{console.log("SSAO",o.lastTime)},1e3),setInterval(()=>{console.log("SSAO",o.enabled,{ssao:o,autoRenderBeauty:o.configuration.autoRenderBeauty})},4e3)),this.intensity.onValueChanged=c=>{o.configuration.intensity=c},this.falloff.onValueChanged=c=>{o.configuration.distanceFalloff=c},this.aoRadius.onValueChanged=c=>{o.configuration.aoRadius=c},this.color.onValueChanged=c=>{o.color||(o.color=new de),o.configuration.color.copy(c)},o}}vl([vi(),m()],po.prototype,"gammaCorrection",void 0);vl([m(W)],po.prototype,"aoRadius",void 0);vl([m(W)],po.prototype,"falloff",void 0);vl([m(W)],po.prototype,"intensity",void 0);vl([m(W)],po.prototype,"color",void 0);vl([vi(),m()],po.prototype,"screenspaceRadius",void 0);vl([vi(),m()],po.prototype,"quality",void 0);vs("ScreenSpaceAmbientOcclusionN8",po);var lP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class jm extends Pt{constructor(){super(...arguments);a(this,"order",kt.Sharpening);a(this,"_effect");a(this,"_amount",1);a(this,"_radius",1)}get typeName(){return"Sharpening"}onCreateEffect(){return this._effect??(this._effect=new(gD())),this.effect}get effect(){return this._effect}set amount(e){this._amount=e,this._effect&&(this._effect.uniforms.get("amount").value=e)}get amount(){return this._effect?this._effect.uniforms.get("amount").value:this._amount}set radius(e){this._radius=e,this._effect&&(this._effect.uniforms.get("radius").value=e)}get radius(){return this._effect?this._effect.uniforms.get("radius").value:this._radius}}lP([m()],jm.prototype,"amount",null);lP([m()],jm.prototype,"radius",null);function gD(){const s=`
      void mainSupport() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,t=`
    uniform sampler2D tDiffuse;
    uniform float amount;
    uniform float radius;
    
    void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {
        float tx = 1.0 / resolution.x;
        float ty = 1.0 / resolution.y;
        vec2 texelSize = vec2(tx, ty);
    
        vec4 blurred = vec4(0.0);
        float total = 0.0;
    
        for (float x = -radius; x <= radius; x++) {
            for (float y = -radius; y <= radius; y++) {
                vec2 offset = vec2(x, y) * texelSize;
                vec4 diffuse = texture2D(tDiffuse, uv + offset);
                float weight = exp(-length(offset) * amount);
                blurred += diffuse * weight;
                total += weight;
            }
        }
    
        if (total > 0.0) {
            blurred /= total;
        }
    
        // Calculate the sharpened color using inputColor
        vec4 sharp = inputColor + clamp(inputColor - blurred, 0.0, 1.0) * amount;
        // Keep original alpha
        sharp.a = inputColor.a;
    
        // Ensure the sharp color does not go below 0 or above 1
        // This means: sharpening must happen AFTER tonemapping.
        sharp = clamp(sharp, 0.0, 1.0);
    
        outputColor = sharp;
    }
    
    `;class e extends F.POSTPROCESSING.MODULE.Effect{constructor(){super("Sharpening",t,{vertexShader:s,blendFunction:F.POSTPROCESSING.MODULE.BlendFunction.NORMAL,uniforms:new Map([["amount",new Un(1)],["radius",new Un(1)]]),attributes:ET.CONVOLUTION})}}return e}var Jc=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ar extends Pt{constructor(){super(...arguments);a(this,"offset",new W(0));a(this,"rotation",new W(0));a(this,"focusArea",new W(.4));a(this,"feather",new W(.3));a(this,"kernelSize",new W(2));a(this,"resolutionScale",new W(1/window.devicePixelRatio))}get typeName(){return"TiltShiftEffect"}init(){this.offset.defaultValue=0,this.rotation.defaultValue=0,this.focusArea.defaultValue=.4,this.feather.defaultValue=.3,this.kernelSize.defaultValue=F.POSTPROCESSING.MODULE.KernelSize.MEDIUM,this.resolutionScale.defaultValue=1/window.devicePixelRatio}onCreateEffect(){const e=new F.POSTPROCESSING.MODULE.TiltShiftEffect({kernelSize:F.POSTPROCESSING.MODULE.KernelSize.VERY_LARGE,offset:this.offset.value,rotation:this.rotation.value,focusArea:this.focusArea.value,feather:this.feather.value});return this.offset.onValueChanged=i=>e.offset=i,this.rotation.onValueChanged=i=>e.rotation=i,this.focusArea.onValueChanged=i=>e.focusArea=i,this.feather.onValueChanged=i=>e.feather=i,this.kernelSize.onValueChanged=i=>e.blurPass.kernelSize=i,this.resolutionScale.onValueChanged=i=>e.resolution.scale=i/window.devicePixelRatio,e}}Jc([m(W)],ar.prototype,"offset",void 0);Jc([m(W)],ar.prototype,"rotation",void 0);Jc([m(W)],ar.prototype,"focusArea",void 0);Jc([m(W)],ar.prototype,"feather",void 0);Jc([m(W)],ar.prototype,"kernelSize",void 0);Jc([m(W)],ar.prototype,"resolutionScale",void 0);vs("TiltShiftEffect",ar);var l0=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Zc extends Pt{constructor(){super(...arguments);a(this,"color",new W({r:0,g:0,b:0,a:1}));a(this,"intensity",new W(0));a(this,"center",new W({x:.5,y:.5}))}get typeName(){return"Vignette"}init(){this.color.defaultValue={r:0,g:0,b:0,a:1},this.intensity.defaultValue=0,this.center.defaultValue={x:.5,y:.5}}onCreateEffect(){const e=new F.POSTPROCESSING.MODULE.VignetteEffect;return this.intensity.onValueChanged=i=>{e.offset=i,this.updateDarkness(e)},this.color.onValueChanged=i=>{this.updateDarkness(e)},e}updateDarkness(e){const i=this.intensity.value;e.darkness=i}}l0([m(W)],Zc.prototype,"color",void 0);l0([m(W)],Zc.prototype,"intensity",void 0);l0([m(W)],Zc.prototype,"center",void 0);vs("Vignette",Zc);globalThis.true=globalThis.true!==void 0?globalThis.true:!0;const Cs=S("debugpost"),vy=Symbol("needle:postprocessing-handler"),kh=Symbol("needle:previous-autoclear-state"),Eh=Symbol("needle:previous-tone-mapping");class cP{constructor(t){a(this,"_composer",null);a(this,"_lastVolumeComponents");a(this,"_effects",[]);a(this,"_isActive",!1);a(this,"context");a(this,"_anyPassHasDepth",!1);a(this,"_anyPassHasNormal",!1);a(this,"_hasSmaaEffect",!1);a(this,"_customInputBuffer",null);a(this,"_customInputBufferId",0);a(this,"_multisampling",0);a(this,"_menuEntry",null);a(this,"_passIndices",null);this.context=t}getEffectIsActive(t){return t?this._isActive&&this._effects.some(e=>e.effect===t):!1}get isActive(){return this._isActive}get composer(){return this._composer}apply(t){return"env"in import.meta&&{}.VITE_NEEDLE_USE_POSTPROCESSING==="false"?(Cs?console.warn("Postprocessing is disabled via vite env setting"):console.debug("Postprocessing is disabled via vite env setting"),Promise.resolve()):(this._isActive=!0,this.onApply(this.context,t))}unapply(t=!0){var n,o;if(Cs&&console.log("Unapplying postprocessing effects"),this._isActive=!1,this._lastVolumeComponents){for(const r of this._lastVolumeComponents)r.unapply();this._lastVolumeComponents.length=0}const e=this.context;e[vy]===this&&(delete e[vy],typeof e.renderer[kh]=="boolean"&&(e.renderer.autoClear=e.renderer[kh]),typeof e.renderer[Eh]=="number"&&(e.renderer.toneMapping=e.renderer[Eh])),(n=this._composer)==null||n.removeAllPasses(),t&&((o=this._composer)==null||o.dispose()),e.composer===this._composer&&(e.composer=null),this.handleDevicePixelRatio()}dispose(){this.unapply(!0);for(const t of this._effects)t.effect.dispose();this._effects.length=0,this._composer=null}async onApply(t,e){if(!e)return;await Promise.all([F.POSTPROCESSING.load(),F.POSTPROCESSING_AO.load()]),t[vy]=this,Cs&&console.log("Apply Postprocessing Effects",e),this._lastVolumeComponents=[...e],this._effects.length=0;const i={handler:this,components:this._lastVolumeComponents};for(let n=0;n<this._lastVolumeComponents.length;n++){const o=this._lastVolumeComponents[n];if(o.context=t,o.apply){if(o.active){let c=function(h,d){return d?(d instanceof F.POSTPROCESSING.MODULE.Effect||d instanceof F.POSTPROCESSING.MODULE.Pass||console.warn(`PostprocessingEffect ${h} created neither Effect nor Pass - this might be caused by a bundler error or false import. Below you find some possible solutions:
- If you create custom effect try creating it like this: 'new NEEDLE_ENGINE_MODULES.POSTPROCESSING.MODULE.Effect(...)' instead of 'new Effect(...)'`),!0):!1};if(!t.mainCameraComponent){console.error("No camera in scene found or available yet - can not create postprocessing effects");return}const r=o.apply(i);if(!r)continue;const l=o.typeName||o.constructor.name;if(Array.isArray(r))for(const h of r)c(l,h)&&this._effects.push({effect:h,typeName:o.typeName,priority:o.order});else{if(!c(l,r))continue;this._effects.push({effect:r,typeName:o.typeName,priority:o.order})}}}else o.active&&ke("Volume component is not a VolumeComponent: "+o.__type)}this.applyEffects(t)}get anyPassHasDepth(){return this._anyPassHasDepth}get anyPassHasNormal(){return this._anyPassHasNormal}get hasSmaaEffect(){return this._hasSmaaEffect}set multisampling(t){this._multisampling=t}get multisampling(){return this._multisampling}applyEffects(t){var d;if(this._anyPassHasDepth=!1,this._anyPassHasNormal=!1,this._hasSmaaEffect=!1,this._effects.length<=0)return;const e=t.mainCameraComponent,i=t.renderer,n=t.scene,o=e.threeCamera;if(typeof i[kh]=="boolean"&&(i.autoClear=i[kh]),i[kh]=i.autoClear,typeof i[Eh]=="number"&&(i.toneMapping=i[Eh]),i[Eh]=i.toneMapping,i.toneMapping!=Ff&&!this._effects.find(u=>u instanceof F.POSTPROCESSING.MODULE.ToneMappingEffect)){const u=new F.POSTPROCESSING.MODULE.ToneMappingEffect;u.name=`ToneMapping (${i.toneMapping})`,u.mode=Lf(i.toneMapping),this._effects.push({typeName:"ToneMapping",effect:u,priority:kt.ToneMapping})}this._composer||(this._composer=new F.POSTPROCESSING.MODULE.EffectComposer(i,{frameBufferType:dg,stencilBuffer:!0})),t.composer&&t.composer!==this._composer&&console.warn("There's already an active EffectComposer in your scene: replacing it with a new one. This might cause unexpected behaviour. Make sure to only use one PostprocessingManager/Volume in your scene."),t.composer=this._composer;const r=t.composer;r.setMainCamera(o),r.setRenderer(i),r.setMainScene(n),r.autoRenderToScreen=!0,r.multisampling=0;for(const u of r.passes)u.dispose();r.removeAllPasses();const l=new F.POSTPROCESSING.MODULE.RenderPass(n,o);l.name="RenderPass",l.mainScene=n,r.addPass(l);const c=l.render;(d=this._customInputBuffer)==null||d.dispose(),this._customInputBuffer=null,l.render=(u,f,p,g,_)=>{var y;f&&(f.samples=0,p&&(p.samples=0),(!this._customInputBuffer||this._customInputBuffer.width!==f.width||this._customInputBuffer.height!==f.height||this._customInputBuffer.samples!==this._multisampling||this._customInputBuffer.texture.format!==f.texture.format||this._customInputBuffer.texture.type!==dg)&&((y=this._customInputBuffer)==null||y.dispose(),this._customInputBuffer=new io(f.width,f.height,{format:f.texture.format,type:dg,depthBuffer:f.depthBuffer,depthTexture:f.depthTexture?new Uw(f.width,f.height):void 0,stencilBuffer:f.stencilBuffer,samples:Math.max(0,this._multisampling),minFilter:f.texture.minFilter??Uf,magFilter:f.texture.magFilter??Uf,generateMipmaps:f.texture.generateMipmaps}),this._customInputBufferId++,this._customInputBuffer.texture.name=`CustomInputBuffer-${this._customInputBufferId}`,this._customInputBuffer.depthTexture&&f.depthTexture&&(this._customInputBuffer.depthTexture.format=f.depthTexture.format,this._customInputBuffer.depthTexture.type=f.depthTexture.type),this._customInputBuffer.samples>0&&(this._customInputBuffer.ignoreDepthForMultisampleCopy=!1),Cs&&console.warn(`[PostProcessing] Input buffer created with size ${this._customInputBuffer.width}x${this._customInputBuffer.height} and samples ${this._customInputBuffer.samples}`)),c.call(l,u,this._customInputBuffer,p,g,_),cn.blit(this._customInputBuffer.texture,f,{renderer:u,depthTexture:this._customInputBuffer.depthTexture,depthWrite:!0,depthTest:!0}))};try{iD(this._effects);let u=!1,f=null;for(let _=this._effects.length-1;_>=0;_--){const y=this._effects[_].effect;if(y instanceof F.POSTPROCESSING.MODULE.ToneMappingEffect){if(u){Cs&&console.warn(`[PostProcessing] Found multiple tonemapping effects in the scene: ${y.name} and ${f==null?void 0:f.name}. Only the last one added will be used.`),this._effects.splice(_,1);continue}f=y,u=!0}}const p=[];let g=!1;for(let _=0;_<this._effects.length;_++){const b=this._effects[_].effect;if(b instanceof F.POSTPROCESSING.MODULE.SMAAEffect?this._hasSmaaEffect=!0:b instanceof F.POSTPROCESSING.MODULE.NormalPass&&(this._anyPassHasNormal=!0),!(b instanceof F.POSTPROCESSING.MODULE.ToneMappingEffect&&f!==b))if(b instanceof F.POSTPROCESSING.MODULE.Effect){const v=b.getAttributes(),w=F.POSTPROCESSING.MODULE.EffectAttribute.CONVOLUTION;v&w&&(Cs&&console.log("[PostProcessing] Convolution effect: "+b.name),g&&(Cs&&console.log("[PostProcessing] â†’ Merging effects ["+p.map(P=>P.name).join(", ")+"]"),this.createPassForMergeableEffects(p,r,o,n)),g=!0),p.push(b)}else b instanceof F.POSTPROCESSING.MODULE.Pass?(g=!1,this.createPassForMergeableEffects(p,r,o,n),b.renderToScreen=!1,r.addPass(b)):(g=!1,this.createPassForMergeableEffects(p,r,o,n),r.addPass(b))}this.createPassForMergeableEffects(p,r,o,n)}catch(u){console.error("Error while applying postprocessing effects",u),r.passes.forEach(f=>f.dispose()),r.removeAllPasses()}let h=!1;for(let u=r.passes.length-1;u>=0;u--){const f=r.passes[u];let p=!1,g=!1;f.enabled&&(h||(p=!0,g=!0),h=!0),f.renderToScreen=g,(f==null?void 0:f.configuration)!==void 0?f.configuration.gammaCorrection=p:"autosetGamma"in f&&(f.autosetGamma=p),this._anyPassHasDepth||(this._anyPassHasDepth=f.needsDepthTexture)}this.handleDevicePixelRatio(),Cs&&console.log("[PostProcessing] Passes â†’",[...r.passes],`
---------------------------------
â€¢ `+r.passes.map(u=>u.name||u.constructor.name+"*").join(`
â€¢ `)+`
`),Cs&&this._onCreateEffectsDebug(this._composer,o)}createPassForMergeableEffects(t,e,i,n){if(t.length>0){const o=new F.POSTPROCESSING.MODULE.EffectPass(i,...t);o.name=t.map(r=>r.name).join(", "),o.mainScene=n,o.enabled=!0,o.renderToScreen=!1,e.addPass(o),t.length=0}}handleDevicePixelRatio(){typeof this.context.devicePixelRatio=="number"&&this.context.requestSizeUpdate()}_onCreateEffectsDebug(t,e){if(Cs==="passes"){const i=new F.POSTPROCESSING.MODULE.DepthEffect({blendFunction:F.POSTPROCESSING.MODULE.BlendFunction.NORMAL,inverted:!0});i.name="Depth Effect";const n=new F.POSTPROCESSING.MODULE.EffectPass(e,i);if(n.name="Depth Effect Pass",n.enabled=!1,t.passes.push(n),this._passIndices!==null){const r=[t.passes[0]];this._passIndices.length>0&&r.push(...this._passIndices.filter(l=>l!==0).map(l=>t.passes[l]).filter(l=>l)),r.length>0&&console.log("[PostProcessing] Passes (selected) â†’",r),t.passes.length=0;for(const l of r)l.enabled=!0,l.renderToScreen=!1,t.addPass(l)}const o=this.context.menu;if(o&&this._passIndices===null){this._menuEntry&&this._menuEntry.remove();const r=document.createElement("select");r.multiple=!0;const l=document.createElement("option");l.innerText="Final Output",l.value="-1",r.appendChild(l);for(const c of t.passes){const h=document.createElement("option");h.innerText=c.name,h.value=`${t.passes.indexOf(c)}`,h.title=c.name,r.appendChild(h)}o.appendChild(r),this._menuEntry=r,r.addEventListener("change",()=>{const c=Array.from(r.selectedOptions).map(h=>parseInt(h.value));c.length===1&&c[0]===-1?this._passIndices=null:this._passIndices=c,this.applyEffects(this.context)})}}}}var hP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const xa=S("debugpost");class xu extends j{constructor(){super(...arguments);a(this,"sharedProfile");a(this,"multisampling","auto");a(this,"_postprocessing");a(this,"_activeEffects",[]);a(this,"_effects",[]);a(this,"_componentEnabledTime",-1);a(this,"_multisampleAutoChangeTime",0);a(this,"_multisampleAutoDecreaseTime",0);a(this,"_lastApplyTime");a(this,"_rapidApplyCount",0);a(this,"_isDirty",!1);a(this,"_modificationQueue");a(this,"_recreateId",-1)}get isPostProcessingManager(){return!0}get effects(){return this._activeEffects}get dirty(){return this._isDirty}set dirty(e){this._isDirty=e}addEffect(e){let i=e;return i instanceof Pt||(i=new wp(i),typeof e.order=="number"&&(i.order=e.order)),i.gameObject===void 0&&this.gameObject.addComponent(i),this._effects.includes(i)||(this._effects.push(i),this._isDirty=!0),e}removeEffect(e){var n,o,r,l;let i=-1;if(e instanceof Pt?i=this._effects.indexOf(e):i=this._effects.findIndex(c=>c instanceof wp&&c.effect===e),i!==-1)return this._effects.splice(i,1),this._isDirty=!0,e;if(e instanceof Pt){const c=(o=(n=this.sharedProfile)==null?void 0:n.components)==null?void 0:o.indexOf(e);c!==void 0&&c!==-1&&(this._isDirty=!0,(l=(r=this.sharedProfile)==null?void 0:r.components)==null||l.splice(c,1))}return e}markDirty(){this._isDirty=!0}awake(){var e;xa&&(console.log("PostprocessingManager Awake",this),console.log("Press P to toggle post processing"),window.addEventListener("keydown",i=>{i.key==="p"&&(this.enabled=!this.enabled,nt("Toggle PostProcessing "+this.name+": Enabled="+this.enabled),this.markDirty())})),(e=this.sharedProfile)==null||e.__init(this)}onEnable(){this._componentEnabledTime=this.context.time.realtimeSinceStartup,this._isDirty=!0}onDisable(){var e;(e=this._postprocessing)==null||e.unapply(),this._isDirty=!1}onBeforeRender(){if(!this.context.isInXR&&(this.context.mainCamera&&this._isDirty&&this.apply(),this.context.composer&&this._postprocessing&&this._postprocessing.composer===this.context.composer)){if(this.context.renderer.getContext().isContextLost()&&this.context.renderer.forceContextRestore(),this.context.composer.getRenderer()!==this.context.renderer&&this.context.composer.setRenderer(this.context.renderer),this.context.composer.setMainScene(this.context.scene),this.multisampling==="auto")if(this._postprocessing&&this._postprocessing.hasSmaaEffect)this._postprocessing.multisampling!==0&&(this._postprocessing.multisampling=0,(xa||U())&&console.log(`[PostProcessing] multisampling is disabled because it's set to 'auto' on your PostprocessingManager/Volume component that also has an SMAA effect.

If you need multisampling consider changing 'auto' to a fixed value (e.g. 4).`));else{const e=this.context.time.realtimeSinceStartup-this._multisampleAutoChangeTime;if(this.context.time.realtimeSinceStartup-this._componentEnabledTime>2&&e>.5){const i=this._postprocessing.multisampling;if(this._postprocessing.multisampling>0&&this.context.time.smoothedFps<=50){this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup,this._multisampleAutoDecreaseTime=this.context.time.realtimeSinceStartup;let n=this._postprocessing.multisampling*.5;n=Math.floor(n),n!=this._postprocessing.multisampling&&(this._postprocessing.multisampling=n),xa&&console.debug(`[PostProcessing] Reduced multisampling from ${i} to ${this._postprocessing.multisampling}`)}else if(e>1&&this.context.time.smoothedFps>=59&&this._postprocessing.multisampling<this.context.renderer.capabilities.maxSamples&&this.context.time.realtimeSinceStartup-this._multisampleAutoDecreaseTime>10){this._multisampleAutoChangeTime=this.context.time.realtimeSinceStartup;let n=this._postprocessing.multisampling<=0?1:this._postprocessing.multisampling*2;n=Math.floor(n),n!==this._postprocessing.multisampling&&(this._postprocessing.multisampling=n),xa&&console.debug(`[PostProcessing] Increased multisampling from ${i} to ${this._postprocessing.multisampling}`)}}}else{const e=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples));e!==this._postprocessing.multisampling&&(this._postprocessing.multisampling=e)}if(this.context.mainCamera){const e=this.context.composer.passes;for(const i of e)if(i.mainCamera&&i.mainCamera!==this.context.mainCamera){this.context.composer.setMainCamera(this.context.mainCamera);break}}}}onDestroy(){var e;(e=this._postprocessing)==null||e.dispose()}apply(){var e,i,n;if(xa&&console.log(`Apply PostProcessing "${this.name||"unnamed"}"`),U()&&(this._lastApplyTime!==void 0&&Date.now()-this._lastApplyTime<100&&(this._rapidApplyCount++,this._rapidApplyCount===5&&console.warn("Detected rapid post processing modifications - this might be a bug",this)),this._lastApplyTime=Date.now()),this._isDirty=!1,this._activeEffects.length=0,(e=this.sharedProfile)!=null&&e.components){const o=this.sharedProfile.components;for(const r of o)r.active&&r.enabled&&!this._activeEffects.includes(r)&&this._activeEffects.push(r)}for(const o of this._effects)o.active&&o.enabled&&!this._activeEffects.includes(o)&&this._activeEffects.push(o);this._activeEffects.length>0?(this._postprocessing||(this._postprocessing=new cP(this.context)),(i=this._postprocessing.apply(this._activeEffects))==null||i.then(()=>{this.activeAndEnabled&&(this._applyPostQueue(),this._postprocessing?(this.multisampling==="auto"?this._postprocessing.multisampling=K.isMobileDevice()?2:4:this._postprocessing.multisampling=Math.max(0,Math.min(this.multisampling,this.context.renderer.capabilities.maxSamples)),xa&&console.debug(`[PostProcessing] Set multisampling to ${this._postprocessing.multisampling} (Is Mobile: ${K.isMobileDevice()})`)):xa&&console.warn("[PostProcessing] No composer found"))})):(n=this._postprocessing)==null||n.unapply(!1)}_applyPostQueue(){if(this._modificationQueue){for(const e of this._modificationQueue.values())this.onEditorModification(e);this._modificationQueue.clear()}}onEditorModification(e){var i,n;if(e.propertyName.startsWith("postprocessing.")){if(!this._postprocessing)return this._modificationQueue||(this._modificationQueue=new Map),this._modificationQueue.set(e.propertyName,e),!0;if(!((i=this._activeEffects)!=null&&i.length))return;const o=e.propertyName.split(".");if(o.length===3||o.length===4){const r=o[1],l=o[2];for(const c of this._activeEffects)if(((n=c.typeName)==null?void 0:n.toLowerCase())===r.toLowerCase()){if(l==="active"){c.active=e.value,this.scheduleRecreate();return}if(!ff.has(r)){const h=new Array;ff.set(r,h);const d=Object.keys(c);for(const u of d)c[u]instanceof W&&h.push(u)}if(ff.has(r)){const h=l.toLowerCase(),d=ff.get(r);for(const u of d)if(u.toLowerCase()===h){const f=c[u];f instanceof W&&(o.length===4&&o[3]==="active"?(f.overrideState=e.value,this.scheduleRecreate()):f&&f.value!==void 0&&(f.value=e.value));return}}console.warn("Unknown modification",l);return}}return!0}return!1}scheduleRecreate(){const e=++this._recreateId;setTimeout(()=>{e===this._recreateId&&(this.onDisable(),this.onEnable())},200)}}hP([Rt(r0)],xu.prototype,"sharedProfile",void 0);hP([Rt()],xu.prototype,"multisampling",void 0);const ff=new Map;eD(xu);async function c0(s){const{NeedleEngineWebComponent:t}=await rs(()=>Promise.resolve().then(()=>_L),void 0,import.meta.url);t.observedAttributes.includes(s)||t.observedAttributes.push(s)}var $t=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const fi=S("debugsceneswitcher"),yD=S("sceneswitcher:clearscene"),jf="scene";c0(jf);const pr=Promise.resolve(!1);class vt extends j{constructor(){super(...arguments);a(this,"autoLoadFirstScene",!0);a(this,"scenes",[]);a(this,"loadingScene");a(this,"queryParameterName","scene");a(this,"useSceneName",!0);a(this,"clamp",!0);a(this,"useHistory",!0);a(this,"useKeyboard",!0);a(this,"useSwipe",!0);a(this,"useSceneLighting",!0);a(this,"useSceneBackground",!0);a(this,"preloadNext",1);a(this,"preloadPrevious",1);a(this,"preloadConcurrent",2);a(this,"createMenuButtons",!1);a(this,"sceneLoadingStart",new we);a(this,"sceneLoadingProgress",new we);a(this,"sceneLoaded",new we);a(this,"_currentIndex",-1);a(this,"_currentScene");a(this,"_engineElementOverserver");a(this,"_preloadScheduler");a(this,"_menuButtons");a(this,"onPopState",async e=>{if(!this.useHistory)return;const i=this.useHistory;try{this.useHistory=!1;let n=!1;if(this.queryParameterName&&(n=await this.tryLoadFromQueryParam()),!n){const o=e==null?void 0:e.state;if(o&&o.startsWith(this.guid)){const r=o.substr(this.guid.length+2);fi&&console.log("PopState",r),await this.trySelectSceneFromValue(r)}}}finally{this.useHistory=i}});a(this,"normalizedSwipeThresholdX",.1);a(this,"_didSwipe",!1);a(this,"onInputPointerMove",e=>{if(this.useSwipe&&!this._didSwipe&&e.button===0&&e.pointerType==="touch"&&this.context.input.getPointerPressedCount()===1){const i=this.context.input.getPointerPositionDelta(e.button);if(i){const n=i.x/this.context.domWidth;n>=this.normalizedSwipeThresholdX?(this._didSwipe=!0,this.selectPrev()):n<=-this.normalizedSwipeThresholdX&&(this._didSwipe=!0,this.selectNext())}}});a(this,"onInputPointerUp",e=>{e.button===0&&(this._didSwipe=!1)});a(this,"onInputKeyDown",e=>{if(!this.useKeyboard||!this.scenes)return;const i=e.key.toLowerCase();if(!i)return;const n=parseInt(i)-1;if(n>=0){this.trySelectSceneFromValue(n);return}switch(i){case"arrowright":case"d":this.selectNext();break;case"arrowleft":case"a":this.selectPrev();break}});a(this,"__lastSwitchScene");a(this,"__lastSwitchScenePromise");a(this,"_currentlyLoadingScene");a(this,"_lastLoadingScene");a(this,"_loadingScenePromise");a(this,"_isCurrentlyLoading",!1);a(this,"_currentLoadingProgress")}get currentIndex(){return this._currentIndex}get currentLoadingProgress(){return this._currentLoadingProgress}get currentlyLoadingScene(){return this._currentlyLoadingScene}get currentlyLoadedScene(){return this._currentScene}awake(){this.scenes===void 0&&(this.scenes=[]);for(const e of this.scenes)e&&!e.hasUrl&&e.asset instanceof D?C.remove(e.asset):e instanceof D&&C.remove(e);fi&&console.log("SceneSwitcher",this)}async onEnable(){if(globalThis.addEventListener("popstate",this.onPopState),this.context.input.addEventListener(_e.KeyDown,this.onInputKeyDown),this.context.input.addEventListener(_e.PointerMove,this.onInputPointerMove),this.context.input.addEventListener(_e.PointerUp,this.onInputPointerUp),this._engineElementOverserver||(this._engineElementOverserver=new MutationObserver(e=>{for(const i of e)if(i.type==="attributes"&&i.attributeName===jf){const n=this.context.domElement.getAttribute(jf);n!==null&&this.trySelectSceneFromValue(n)}})),this._engineElementOverserver.observe(this.context.domElement,{attributes:!0}),this._preloadScheduler||(this._preloadScheduler=new _D(this)),this._preloadScheduler.maxLoadAhead=this.preloadNext,this._preloadScheduler.maxLoadBehind=this.preloadPrevious,this._preloadScheduler.maxConcurrent=this.preloadConcurrent,this._preloadScheduler.begin(2e3),this.autoLoadFirstScene&&this._currentIndex===-1&&!await this.tryLoadFromQueryParam()){const e=this.context.domElement.getAttribute(jf);try{(e===null||!await this.trySelectSceneFromValue(e))&&this._currentIndex===-1&&this.select(0)}finally{}}this.createMenuButtons&&(this._menuButtons??(this._menuButtons=[]),this._menuButtons.push(this.context.menu.appendChild({label:"Previous",icon:"arrow_back_ios",onClick:()=>this.selectPrev(),priority:-1005,class:"row2"})),this._menuButtons.push(this.context.menu.appendChild({label:"Next",icon:"arrow_forward_ios",iconSide:"right",onClick:()=>this.selectNext(),priority:-1e3,class:"row2"})))}onDisable(){var e;if(globalThis.removeEventListener("popstate",this.onPopState),this.context.input.removeEventListener(_e.KeyDown,this.onInputKeyDown),this.context.input.removeEventListener(_e.PointerMove,this.onInputPointerMove),this.context.input.removeEventListener(_e.PointerUp,this.onInputPointerUp),(e=this._preloadScheduler)==null||e.stop(),this._menuButtons){for(const i of this._menuButtons)i.remove();this._menuButtons=void 0}}addScene(e){if(typeof e=="string"){let i=this.context.addressables.findAssetReference(e);return i||(i=new he(e),this.context.addressables.registerAssetReference(i)),this.scenes.push(i),i}return this.scenes.push(e),e}selectNext(){return this.select(this._currentIndex+1)}selectPrev(){return this.select(this._currentIndex-1)}select(e){var n,o,r;if(fi&&console.log("select",e),typeof e=="object"&&console.warn('Switching to "'+e+'" might not work. Please either use an index or a AssetReference (not a scene reference)'),typeof e=="string"){const l=(n=this.scenes)==null?void 0:n.find(c=>c.url===e);if(!l){const c=he.getOrCreate(this.sourceId??"",e,this.context);return this.switchScene(c)}if(l)e=(o=this.scenes)==null?void 0:o.indexOf(l);else return pr}if(!((r=this.scenes)!=null&&r.length))return pr;if(e<0){if(this.clamp)return pr;e=this.scenes.length-1}else if(e>=this.scenes.length){if(this.clamp)return pr;e=0}const i=this.scenes[e];return this.switchScene(i)}unload(){return this.__lastSwitchScene=void 0,this.__lastSwitchScenePromise=void 0,this.__unloadCurrentScene()}async reload(){if(this.__lastSwitchScene){const e=this.__lastSwitchScene;return this.__lastSwitchScene=void 0,this.switchScene(e)}return!1}async switchScene(e){var n;if(!(e instanceof he)){const o=typeof e;if(o==="string")return this.select(e);if(o==="number")return this.select(e);if(e&&e instanceof D){const r=(n=this.scenes)==null?void 0:n.indexOf(e);e=new he(e.name,void 0,e),r>=0&&(this.scenes[r]=e)}else return console.warn(`[SceneSwitcher] Can't switch to scene of type ${o}`),!1}return e.url===this.sourceId?(console.warn("[SceneSwitcher] Can't load own scene - prevent recursive loading",this.sourceId),!1):this.__lastSwitchScene===e&&this.__lastSwitchScenePromise?this.__lastSwitchScenePromise:(this.__lastSwitchScene=e,this.__lastSwitchScenePromise=this.__internalSwitchScene(e),await this.__lastSwitchScenePromise)}async __unloadCurrentScene(){const e=this._currentScene;if(this._currentScene=void 0,e){fi&&console.log("UNLOAD",e.url,"HasURL?: "+e.hasUrl);const i=this.tryGetSceneEventListener(e.asset);if(i!=null&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}e.hasUrl?e.unload():e.asset instanceof D&&C.remove(e.asset)}}async __internalSwitchScene(e){var n,o,r,l,c;await this.__unloadCurrentScene();const i=this._currentIndex=((n=this.scenes)==null?void 0:n.indexOf(e))??-1;try{this._currentlyLoadingScene=e,this._currentLoadingProgress=new ProgressEvent("progress",{loaded:0,total:1});const h=new CustomEvent("loadscene-start",{detail:{scene:e,switcher:this,index:i}});this.dispatchEvent(h),(o=this.sceneLoadingStart)==null||o.invoke(h.detail),await this.onStartLoading(),await e.loadAssetAsync((u,f)=>{var p;if(fi){const g=f.loaded/f.total,_="["+"=".repeat(Math.floor(g*20))+"-".repeat(20-Math.floor(g*20))+"]";console.debug(`[SceneSwitcher] Download ${(g*100).toFixed(1)} % ${_}`,e.url)}this._currentLoadingProgress=f,this.dispatchEvent(f),(p=this.sceneLoadingProgress)==null||p.invoke(f)}).catch(console.error),await this.onEndLoading();const d=new CustomEvent("loadscene-finished",{detail:{scene:e,switcher:this,index:i}});if(this.dispatchEvent(d),this._currentLoadingProgress=void 0,this._currentlyLoadingScene=void 0,d.defaultPrevented)return fi&&console.warn("Adding loaded scene prevented:",e,d),!1;if(!e.asset)return fi&&console.warn("Failed loading scene:",e),!1;if(this._currentIndex===i){if(fi&&console.log("ADD",e.url),this._currentScene=e,yD){const p=((r=this.context.mainCameraComponent)==null?void 0:r.gameObject)||this.context.mainCamera;p==null||p.removeFromParent();const g=this.gameObject.removeFromParent();Wn(this.context.scene,!0,!0),this.context.scene=new bn,this.context.scene.add(g),p&&this.context.scene.add(p)}if(C.add(e.asset,this.gameObject),this.useSceneLighting&&this.context.sceneLighting.enable(e),this.useSceneBackground){const p=this.context.lightmaps.tryGetSkybox(e.url);p?(p.mapping=zo,this.context.scene.background=p):fi&&console.warn("SceneSwitcher: Can't find skybox for scene "+e.url)}if(this.useHistory&&i>=0){let p=i.toString();if(this.useSceneName&&(e instanceof D?p=e.name:e.url&&(p=mw(e.url))),(l=this.queryParameterName)!=null&&l.length)$f(this.queryParameterName,p,this.useHistory);else{const g=history.state,_=this.guid+"::"+i;g!==_&&history.pushState(_,"unused",location.href)}}const u=this.tryGetSceneEventListener(e.asset);if(u!=null&&u.sceneOpened){const p=u.sceneOpened(this);p instanceof Promise&&await p}const f=new CustomEvent("scene-opened",{detail:{scene:e,switcher:this,index:i}});return this.dispatchEvent(f),(c=this.sceneLoaded)==null||c.invoke(this),!0}}catch(h){console.error(h)}return!1}preload(e){if(e>=0&&e<this.scenes.length){const i=this.scenes[e];if(i instanceof he)return i.preload()}return pr}tryLoadFromQueryParam(){var i;if(!((i=this.queryParameterName)!=null&&i.length))return pr;const e=S(this.queryParameterName);return typeof e=="boolean"?pr:this.trySelectSceneFromValue(e)}trySelectSceneFromValue(e){if(typeof e=="string"){const i=parseInt(e);if(i>=0&&i<this.scenes.length)return this.select(i);{const n=e.toLowerCase();for(let o=0;o<this.scenes.length;o++){const r=this.scenes[o];if(!r)continue;if((r instanceof D?r.name:mw(r.url)).toLowerCase().includes(n))return this.select(o)}}}else if(typeof e=="number"&&e>=0&&e<this.scenes.length)return this.select(e);return fs()&&console.warn('Can not find scene: "'+e+'"',this),pr}async onStartLoading(){var e,i;if(this._isCurrentlyLoading=!0,this.loadingScene&&(this._lastLoadingScene!==this.loadingScene&&(this._loadingScenePromise=void 0),this._lastLoadingScene=this.loadingScene,this._loadingScenePromise||(this._loadingScenePromise=(e=this.loadingScene)==null?void 0:e.loadAssetAsync().then(n=>n!=null)),await this._loadingScenePromise,this._isCurrentlyLoading&&((i=this.loadingScene)!=null&&i.asset))){fi&&console.log("Add loading scene",this.loadingScene.url,this.loadingScene.asset);const n=this.loadingScene.asset;C.add(n,this.gameObject);const o=this.tryGetSceneEventListener(n);if(o!=null&&o.sceneOpened){const r=o.sceneOpened(this);r instanceof Promise&&await r}}if(this._isCurrentlyLoading){const n=this.tryGetSceneEventListener(this.gameObject);if(n&&n.sceneOpened){const o=n.sceneOpened(this);o instanceof Promise&&await o}}}async onEndLoading(){var e;if(this._isCurrentlyLoading=!1,(e=this.loadingScene)!=null&&e.asset){fi&&console.log("Remove loading scene",this.loadingScene.url);const i=this.loadingScene.asset,n=this.tryGetSceneEventListener(i);if(typeof(n==null?void 0:n.sceneClosing)=="function"){const o=n.sceneClosing();o instanceof Promise&&await o}C.remove(i)}if(!this._isCurrentlyLoading){const i=this.tryGetSceneEventListener(this.gameObject);if(i&&i.sceneClosing){const n=i.sceneClosing();n instanceof Promise&&await n}}}tryGetSceneEventListener(e,i=0){if(!e)return null;const n=C.foreachComponent(e,o=>{const r=o;if(r.sceneClosing||r.sceneOpened)return r});if(i===0&&!n&&e.children.length)for(const o of e.children){const r=this.tryGetSceneEventListener(o,i+1);if(r)return r}return n||null}}$t([m()],vt.prototype,"autoLoadFirstScene",void 0);$t([m(he)],vt.prototype,"scenes",void 0);$t([m(he)],vt.prototype,"loadingScene",void 0);$t([m()],vt.prototype,"queryParameterName",void 0);$t([m()],vt.prototype,"useSceneName",void 0);$t([m()],vt.prototype,"clamp",void 0);$t([m()],vt.prototype,"useHistory",void 0);$t([m()],vt.prototype,"useKeyboard",void 0);$t([m()],vt.prototype,"useSwipe",void 0);$t([m()],vt.prototype,"useSceneLighting",void 0);$t([m()],vt.prototype,"useSceneBackground",void 0);$t([m()],vt.prototype,"preloadNext",void 0);$t([m()],vt.prototype,"preloadPrevious",void 0);$t([m()],vt.prototype,"preloadConcurrent",void 0);$t([m()],vt.prototype,"createMenuButtons",void 0);$t([m(we)],vt.prototype,"sceneLoadingStart",void 0);$t([m(we)],vt.prototype,"sceneLoadingProgress",void 0);$t([m(we)],vt.prototype,"sceneLoaded",void 0);function mw(s){const t=s.split("/").pop(),e=t==null?void 0:t.split(".").shift();return e!=null&&e.length?e:s}class _D{constructor(t,e=1,i=1,n=2){a(this,"maxLoadAhead");a(this,"maxLoadBehind");a(this,"maxConcurrent");a(this,"_isRunning",!1);a(this,"_switcher");a(this,"_loadTasks",[]);a(this,"_maxConcurrentLoads",1);this._switcher=t,this.maxLoadAhead=e,this.maxLoadBehind=i,this.maxConcurrent=n}begin(t){if(this._isRunning)return;fi&&console.log("Preload begin",{delay:t}),this._isRunning=!0;let e=-10,i,n;const o=this._switcher.scenes,r=Date.now()+t,l=setInterval(()=>{if(this.allLoaded()&&(fi&&console.log("All scenes (pre-)loaded"),this.stop()),!this._isRunning){clearInterval(l);return}if(Date.now()<r||this.canLoadNewScene()===!1)return;(e===-10||e!==this._switcher.currentIndex)&&(e=this._switcher.currentIndex,n=0,i=0);const c=n%2===0;c&&(i+=1),n+=1;const h=c?this.maxLoadAhead:this.maxLoadBehind;if(i>h)return;const d=c?e+i:e-i;if(!(d<0)&&!(d<0||d>=o.length)&&!this._loadTasks.some(u=>u.index===d)){const u=o[d];fi&&console.log("Preload scene",{roomIndex:d,searchForward:c,lastRoom:e,currentIndex:this._switcher.currentIndex,tasks:this._loadTasks.length},u==null?void 0:u.url),new bD(d,u,this._loadTasks)}},200)}stop(){this._isRunning=!1}canLoadNewScene(){return this._loadTasks.length<this._maxConcurrentLoads}allLoaded(){if(this._switcher.scenes){for(const t of this._switcher.scenes)if(t!=null&&t.isLoaded&&t.isLoaded()===!1)return!1}return!0}}class bD{constructor(t,e,i){a(this,"index");a(this,"asset");a(this,"tasks");this.index=t,this.asset=e,this.tasks=i,i.push(this),this.awaitLoading()}async awaitLoading(){this.asset&&!this.asset.isLoaded()&&(fi&&console.log("Preload start: "+this.asset.url,this.index),await this.asset.preload(),fi&&console.log("Preload finished: "+this.asset.url,this.index));const t=this.tasks.indexOf(this);t>=0&&this.tasks.splice(t,1)}}function vD(){return new Promise((s,t)=>{const i=()=>{i!=null&&(document.removeEventListener("pointerdown",i),document.removeEventListener("click",i),document.removeEventListener("dragstart",i),document.removeEventListener("touchstart",i),s())};document.addEventListener("pointerdown",i),document.addEventListener("click",i),document.addEventListener("dragstart",i),document.addEventListener("touchstart",i)})}async function xD(s){await vD(),s()}var Rn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Tt=S("debugvideo");var Tr;(function(s){s[s.None=0]="None",s[s.AdjustHeight=1]="AdjustHeight",s[s.AdjustWidth=2]="AdjustWidth"})(Tr||(Tr={}));var To;(function(s){s[s.VideoClip=0]="VideoClip",s[s.Url=1]="Url"})(To||(To={}));var vd;(function(s){s[s.None=0]="None",s[s.AudioSource=1]="AudioSource",s[s.Direct=2]="Direct",s[s.APIOnly=3]="APIOnly"})(vd||(vd={}));var xd;(function(s){s[s.CameraFarPlane=0]="CameraFarPlane",s[s.CameraNearPlane=1]="CameraNearPlane",s[s.RenderTexture=2]="RenderTexture",s[s.MaterialOverride=3]="MaterialOverride"})(xd||(xd={}));class Ft extends j{constructor(){super();a(this,"playOnAwake",!0);a(this,"aspectMode",Tr.None);a(this,"clip",null);a(this,"source",To.Url);a(this,"_url",null);a(this,"renderMode");a(this,"targetMaterialProperty");a(this,"targetMaterialRenderer");a(this,"targetTexture");a(this,"time",0);a(this,"_playbackSpeed",1);a(this,"_isLooping",!1);a(this,"_muted",!1);a(this,"_audioOutputMode",vd.Direct);a(this,"playInBackground",!0);a(this,"_crossOrigin","anonymous");a(this,"_videoElement",null);a(this,"_videoTexture",null);a(this,"_videoMaterial",null);a(this,"_isPlaying",!1);a(this,"wasPlaying",!1);a(this,"visibilityChanged",e=>{switch(document.visibilityState){case"hidden":this.playInBackground||(this.wasPlaying=this._isPlaying,this.pause());break;case"visible":this.wasPlaying&&!this._isPlaying&&this.play();break}});a(this,"_receivedInput",!1);a(this,"_overlay",null);a(this,"_targetObjects");a(this,"_updateAspectRoutineId",-1);a(this,"_hls");a(this,"onHlsAvailable",()=>{var e;Tt&&console.log("HLS: available",this.clip),!(!this.shouldUseM3U||!this.url)&&(this._hls||(this._hls=new Hls),this.videoElement.autoplay=!0,this._hls.loadSource(this.url),this._hls.attachMedia(this.videoElement),(e=this._videoElement)==null||e.play(),Tt&&console.log("HLS: loaded",this.clip))});xD(()=>{this._receivedInput=!0,this.updateVideoElementSettings()}),this._targetObjects=[],S("videoscreenspace")&&window.addEventListener("keydown",e=>{e.key==="f"&&(this.screenspace=!this.screenspace)})}get url(){return this._url}set url(e){const n=this._url!==e;this.__didAwake?n&&this.setClipURL(e??""):this._url=e}get playbackSpeed(){var e;return((e=this._videoElement)==null?void 0:e.playbackRate)??this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._videoElement&&(this._videoElement.playbackRate=e)}get isLooping(){var e;return((e=this._videoElement)==null?void 0:e.loop)??this._isLooping}set isLooping(e){this._isLooping=e,this._videoElement&&(this._videoElement.loop=e)}get currentTime(){var e;return((e=this._videoElement)==null?void 0:e.currentTime)??this.time}set currentTime(e){this._videoElement?this._videoElement.currentTime=e:this.time=e}get isPlaying(){const e=this._videoElement;if(e){if(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>e.HAVE_CURRENT_DATA)return!0;if(e.srcObject&&e.srcObject.active)return!0}return!1}get crossOrigin(){var e;return((e=this._videoElement)==null?void 0:e.crossOrigin)??this._crossOrigin}set crossOrigin(e){this._crossOrigin=e,this._videoElement&&(e!==null?this._videoElement.setAttribute("crossorigin",e):this._videoElement.removeAttribute("crossorigin"))}get videoMaterial(){return!this._videoMaterial&&!this.create(!1)?null:this._videoMaterial}get videoTexture(){return!this._videoTexture&&!this.create(!1)?null:this._videoTexture}get videoElement(){return!this._videoElement&&!this.create(!1)?null:this._videoElement}requestPictureInPicture(){return this._videoElement?this._videoElement.requestPictureInPicture():null}get muted(){var e;return((e=this._videoElement)==null?void 0:e.muted)??this._muted}set muted(e){this._muted=e,this._videoElement&&(this._videoElement.muted=e)}get currentVideo(){return this.clip}set audioOutputMode(e){e!==this._audioOutputMode&&(e===vd.AudioSource&&U()&&console.warn("VideoAudioOutputMode.AudioSource is not yet implemented"),this._audioOutputMode=e,this.updateVideoElementSettings())}get audioOutputMode(){return this._audioOutputMode}preloadVideo(){Tt&&console.log("Video Preload: "+this.name,this.clip),this.create(!1)}preload(){this.preloadVideo()}setVideo(e){this.clip=e,this.source=To.VideoClip,this._videoElement?(this._videoElement.srcObject=e,this._isPlaying&&this.play(),this.updateAspect()):this.create(this.playOnAwake)}setClipURL(e){this._url!==e&&(this._url=e,this.source=To.Url,Tt&&console.log("set url",e),this._videoElement?e.endsWith(".m3u8")||e.includes(".m3u")?this.ensureM3UCanBePlayed():(this._videoElement.src=e,this._isPlaying&&(this.stop(),this.play())):this.create(this.playOnAwake))}onEnable(){var e,i;Tt&&console.log("VideoPlayer.onEnable",To[this.source],this.clip,this.url,this),window.addEventListener("visibilitychange",this.visibilityChanged),this.playOnAwake===!0?this.create(!0):this.preloadVideo(),this.screenspace?(e=this._overlay)==null||e.start():(i=this._overlay)==null||i.stop()}onDisable(){var e;window.removeEventListener("visibilitychange",this.visibilityChanged),(e=this._overlay)==null||e.stop(),this.pause()}onDestroy(){var e;this._videoElement&&((e=this.videoElement)==null||e.remove(),this._videoElement=null),this._videoTexture&&(this._videoTexture.dispose(),this._videoTexture=null)}play(){var e,i;if(this._videoElement||this.create(!1),!this._videoElement){Tt&&console.warn("Can not play: no video element found",this);return}if(!(this._isPlaying&&!((e=this._videoElement)!=null&&e.ended)&&!((i=this._videoElement)!=null&&i.paused))){if(this._isPlaying=!0,this._receivedInput||(this._videoElement.muted=!0),this.handleBeginPlaying(!1),this.shouldUseM3U){this.ensureM3UCanBePlayed();return}Tt&&console.log("Video Play()",this.clip,this._videoElement,this.time),this._videoElement.currentTime=this.time,this._videoElement.play().catch(n=>{var o;console.log(n),Tt&&console.error("Error playing video",n,"CODE="+n.code,(o=this.videoElement)==null?void 0:o.src,this),setTimeout(()=>{this._isPlaying&&!this.destroyed&&this.activeAndEnabled&&this.play()},1e3)}),Tt&&console.log("play",this._videoElement,this.time)}}stop(){this._isPlaying=!1,this.time=0,this._videoElement&&(this._videoElement.currentTime=0,this._videoElement.pause(),Tt&&console.log("STOP",this))}pause(){var e,i;this.time=((e=this._videoElement)==null?void 0:e.currentTime)??0,this._isPlaying=!1,(i=this._videoElement)==null||i.pause(),Tt&&console.log("PAUSE",this,this.currentTime)}create(e){let i;switch(this.source){case To.VideoClip:i=this.clip;break;case To.Url:i=this.url,!(i!=null&&i.length)&&typeof this.clip=="string"&&(i=this.clip);break}return i?(this._videoElement||(Tt&&console.warn("Create VideoElement",this),this._videoElement=this.createVideoElement(),this.context.domElement.shadowRoot.prepend(this._videoElement),this.updateVideoElementStyles()),typeof i=="string"?(Tt&&console.log("Set Video src",i),this._videoElement.src=i):(Tt&&console.log("Set Video srcObject",i),this._videoElement.srcObject=i),this._videoTexture||(this._videoTexture=new $R(this._videoElement)),this._videoTexture.flipY=!1,this._videoTexture.colorSpace=Qo,e&&this.handleBeginPlaying(e),Tt&&console.log("Video: handle playing done...",i,e),!0):(Tt&&console.warn("No video source set",this),!1)}updateAspect(){this.aspectMode!==Tr.None&&this.startCoroutine(this.updateAspectImpl())}get screenspace(){var e;return((e=this._overlay)==null?void 0:e.enabled)??!1}set screenspace(e){var i;if(e){if(!this._videoTexture)return;this._overlay||(this._overlay=new wD(this.context)),this._overlay.add(this._videoTexture)}else(i=this._overlay)==null||i.remove(this._videoTexture);this._overlay&&(this._overlay.enabled=e)}createVideoElement(){const e=document.createElement("video");return this._crossOrigin&&e.setAttribute("crossorigin",this._crossOrigin),Tt&&console.log("created video element",e),e}handleBeginPlaying(e){var o,r;if(!this.activeAndEnabled||!this._videoElement)return;this._targetObjects.length=0;let i=this.gameObject;switch(this.renderMode){case xd.MaterialOverride:i=(o=this.targetMaterialRenderer)==null?void 0:o.gameObject,i||(i=(r=C.getComponent(this.gameObject,Ve))==null?void 0:r.gameObject);break;case xd.RenderTexture:console.error("VideoPlayer renderTexture not implemented yet. Please use material override instead");return}if(!i){console.error("Missing target for video material renderer",this.name,xd[this.renderMode],this);return}const n=i.material;if(n){this._targetObjects.push(i),n!==this._videoMaterial&&(this._videoMaterial=n.clone(),i.material=this._videoMaterial);const l="map",c=this._videoMaterial;if(!this.targetMaterialProperty)c[l]=this._videoTexture;else switch(this.targetMaterialProperty){default:c[l]=this._videoTexture;break}}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),e&&(this.shouldUseM3U&&this.ensureM3UCanBePlayed(),this.play())}updateVideoElementSettings(){if(!this._videoElement)return;this._videoElement.loop=this._isLooping,this._videoElement.currentTime=this.currentTime,this._videoElement.playbackRate=this._playbackSpeed,this._videoElement.playsInline=!0;let e=!this._receivedInput||this.audioOutputMode===vd.None;!e&&this._muted&&(e=!0),this._videoElement.muted=e,this.playOnAwake&&(this._videoElement.autoplay=!0)}updateVideoElementStyles(){this._videoElement&&(this._videoElement.style.userSelect="none",this._videoElement.style.visibility="hidden",this._videoElement.style.display="none",this.updateAspect())}*updateAspectImpl(){const e=++this._updateAspectRoutineId,i=void 0,n=this.clip;for(;e===this._updateAspectRoutineId&&this.aspectMode!==Tr.None&&this.clip&&n===this.clip&&this._isPlaying;){if(!n||typeof n=="string")return;let o;for(const r of n.getVideoTracks()){const l=r.getSettings();if(l&&l.width&&l.height){o=l.width/l.height;break}else o=this.context.renderer.domElement.clientWidth/this.context.renderer.domElement.clientHeight}if(o===void 0){for(let r=0;r<10;r++)yield;if(!this.isPlaying)break;continue}if(i===o){yield;continue}for(const r of this._targetObjects){let l=1;if(r.parent){const c=_t(r.parent);l=c.x/c.y}switch(this.aspectMode){case Tr.AdjustHeight:r.scale.y=1/o*r.scale.x*l;break;case Tr.AdjustWidth:r.scale.x=o*r.scale.y*l;break}}for(let r=0;r<3;r++)yield}}get shouldUseM3U(){return this.url!=null&&(this.url.endsWith(".m3u8")||this.url.endsWith(".m3u"))&&this.source===To.Url}ensureM3UCanBePlayed(){if(!this.shouldUseM3U)return;let e=document.head.querySelector("script[data-hls_library]");e?globalThis.Hls?this.onHlsAvailable():e.addEventListener("load",this.onHlsAvailable):(Tt&&console.log("HLS: load script"),e=document.createElement("script"),e.dataset.hls_library="hls.js",e.src="https://cdn.jsdelivr.net/npm/hls.js@1",e.addEventListener("load",this.onHlsAvailable),document.head.append(e))}}Rn([m()],Ft.prototype,"playOnAwake",void 0);Rn([m()],Ft.prototype,"aspectMode",void 0);Rn([m(URL)],Ft.prototype,"clip",void 0);Rn([m()],Ft.prototype,"source",void 0);Rn([m(URL)],Ft.prototype,"url",null);Rn([m()],Ft.prototype,"renderMode",void 0);Rn([m()],Ft.prototype,"targetMaterialProperty",void 0);Rn([m(Ve)],Ft.prototype,"targetMaterialRenderer",void 0);Rn([m(Ke)],Ft.prototype,"targetTexture",void 0);Rn([m()],Ft.prototype,"time",void 0);Rn([m()],Ft.prototype,"playbackSpeed",null);Rn([m()],Ft.prototype,"isLooping",null);Rn([m()],Ft.prototype,"audioOutputMode",null);class wD{constructor(t){a(this,"context");a(this,"_videos",[]);a(this,"_screenspaceModeQuad");a(this,"_isInScreenspaceMode",!1);a(this,"_input");this.context=t,this._input=new SD(this)}get enabled(){return this._isInScreenspaceMode}set enabled(t){t?this.start():this.stop()}add(t){this._videos.indexOf(t)===-1&&this._videos.push(t)}remove(t){if(!t)return;const e=this._videos.indexOf(t);e>=0&&this._videos.splice(e,1)}start(){var n;if(this._isInScreenspaceMode||this._videos.length<0)return;const t=this._videos[this._videos.length-1];if(!t)return;if(this._isInScreenspaceMode=!0,!this._screenspaceModeQuad){if(this._screenspaceModeQuad=ll.createPrimitive(Bn.Quad,{material:new CD(t)}),!this._screenspaceModeQuad)return;this._screenspaceModeQuad.geometry.scale(2,2,2)}const e=this._screenspaceModeQuad;this.context.scene.add(e),this.updateScreenspaceMaterialUniforms();const i=e.material;i==null||i.reset(),(n=this._input)==null||n.enable(i)}stop(){var t;this._isInScreenspaceMode=!1,this._screenspaceModeQuad&&((t=this._input)==null||t.disable(),this._screenspaceModeQuad.removeFromParent())}updateScreenspaceMaterialUniforms(){var e;const t=(e=this._screenspaceModeQuad)==null?void 0:e.material;t&&(t.screenAspect=this.context.domElement.clientWidth/this.context.domElement.clientHeight)}}class SD{constructor(t){a(this,"_onResizeScreenFn");a(this,"_onKeyUpFn");a(this,"_onMouseWheelFn");a(this,"context");a(this,"overlay");a(this,"_material");a(this,"_isPinching",!1);a(this,"_lastPinch",0);this.overlay=t,this.context=t.context}enable(t){this._material=t,window.addEventListener("resize",this._onResizeScreenFn=()=>{this.overlay.updateScreenspaceMaterialUniforms()}),window.addEventListener("keyup",this._onKeyUpFn=n=>{n.key==="Escape"&&this.overlay.stop()}),window.addEventListener("wheel",this._onMouseWheelFn=n=>{this.overlay.enabled&&(t.zoom+=n.deltaY*5e-4,n.preventDefault())},{passive:!1});const e=new le;window.addEventListener("mousemove",n=>{if(this.overlay.enabled&&this.context.input.getPointerPressed(0)){const o=new le(n.movementX,n.movementY);o.x/=this.context.domElement.clientWidth,o.y/=this.context.domElement.clientHeight,e.set(o.x,o.y),e.multiplyScalar(t.zoom/-this.context.time.deltaTime*.01),t.offset=t.offset.add(e)}}),window.addEventListener("pointermove",n=>{this.overlay.enabled&&this.context.input.getPointerPressed(0)&&this.context.input.getTouchesPressedCount()===1&&(e.set(n.movementX,n.movementY),e.multiplyScalar(t.zoom*-this.context.time.deltaTime*.05),t.offset=t.offset.add(e))});let i=0;window.addEventListener("touchstart",n=>{if(n.touches.length<2){this.context.time.time-i<.3&&this.overlay.stop(),i=this.context.time.time;return}this._isPinching=!0,this._lastPinch=0}),window.addEventListener("touchmove",n=>{if(!this._isPinching||!this._material)return;const o=n.touches[0],r=n.touches[1],l=o.clientX-r.clientX,c=o.clientY-r.clientY,h=Math.sqrt(l*l+c*c);if(this._lastPinch!==0){const d=h-this._lastPinch;this._material.zoom-=d*.004}this._lastPinch=h}),window.addEventListener("touchend",()=>{this._isPinching=!1})}disable(){this._onResizeScreenFn&&(window.removeEventListener("resize",this._onResizeScreenFn),this._onResizeScreenFn=void 0),this._onKeyUpFn&&(window.removeEventListener("keyup",this._onKeyUpFn),this._onKeyUpFn=void 0),this._onMouseWheelFn&&(window.removeEventListener("wheel",this._onMouseWheelFn),this._onMouseWheelFn=void 0)}}class CD extends to{constructor(e){super();a(this,"_offset",new le);this.uniforms={map:{value:e},screenAspect:{value:1},offsetScale:{value:new Ce(0,0,1,1)}},this.vertexShader=`
        uniform sampler2D map;
        uniform float screenAspect;
        uniform vec4 offsetScale;
        varying vec2 vUv;

        void main() {

            gl_Position = vec4( position , 1.0 );
            vUv = uv;
            vUv.y = 1. - vUv.y;

            // fit into screen
            ivec2 res = textureSize(map, 0);
            float videoAspect = float(res.x) / float(res.y);
            float aspect = videoAspect / screenAspect;
            if(aspect >= 1.0) 
            {
                vUv.y = vUv.y * aspect;
                float offset = (1. - aspect) * .5;
                vUv.y = vUv.y + offset;
            }
            else
            {
                vUv.x = vUv.x / aspect;
                float offset = (1. - 1. / aspect) * .5;
                vUv.x = vUv.x + offset;
            }

            vUv.x -= .5;
            vUv.y -= .5;

            vUv.x *= offsetScale.z;
            vUv.y *= offsetScale.z;
            vUv.x += offsetScale.x;
            vUv.y += offsetScale.y;

            vUv.x += .5;
            vUv.y += .5;
        }

        `,this.fragmentShader=`
        uniform sampler2D map;
        varying vec2 vUv;
        void main() {
            if(vUv.x < 0. || vUv.x > 1. || vUv.y < 0. || vUv.y > 1.)
                gl_FragColor = vec4(0., 0., 0., 1.);
            else
            {
                vec4 texcolor = texture2D(map, vUv);
                gl_FragColor = texcolor;
            }
        }
        `}set screenAspect(e){this.uniforms.screenAspect.value=e,this.needsUpdate=!0}set offset(e){const i=this.uniforms.offsetScale.value;i.x=e.x,i.y=e.y,this.uniforms.offsetScale.value=i,this.needsUpdate=!0}get offset(){const e=this.uniforms.offsetScale.value;return this._offset.set(e.x,e.y),this._offset}set zoom(e){const i=this.uniforms.offsetScale.value;e<.001&&(e=.001),i.z=e,this.needsUpdate=!0}get zoom(){return this.uniforms.offsetScale.value.z}reset(){this.offset=this.offset.set(0,0),this.zoom=1,this.needsUpdate=!0}}var wu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Gt=S("debugscreensharing");var N_;(function(s){s[s.Screen=0]="Screen",s[s.Camera=1]="Camera",s[s.Canvas=2]="Canvas",s[s.Microphone=3]="Microphone"})(N_||(N_={}));var on;(function(s){s[s.Idle=0]="Idle",s[s.Sending=1]="Sending",s[s.Receiving=2]="Receiving"})(on||(on={}));class xl extends j{constructor(){super(...arguments);a(this,"allowStartOnClick",!0);a(this,"autoConnect",!1);a(this,"_videoPlayer");a(this,"_audioSource");a(this,"device","Screen");a(this,"deviceName");a(this,"deviceFilter");a(this,"_net");a(this,"_requestOpen",!1);a(this,"_currentStream",null);a(this,"_currentMode",on.Idle);a(this,"onJoinedRoom",async()=>{await Ko(1e3),this.autoConnect&&!this.isSending&&!this.isReceiving&&this.context.connection.isInRoom&&this.share()});a(this,"_activeShareRequest",null);a(this,"onReceiveStream",e=>{var i;((i=e.stream)==null?void 0:i.active)===!0&&this.setStream(e.stream,on.Receiving)});a(this,"onCallEnded",e=>{Gt&&console.log("CALL ENDED",this.isReceiving,this==null?void 0:this.screenspace),this.isReceiving&&(this.screenspace=!1)})}onPointerEnter(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.setCursor("pointer")}onPointerExit(){this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;if(this.context.connection.allowEditing!=!1&&this.allowStartOnClick&&!(e&&e.pointerId!==0)){if(this.isReceiving&&((i=this.videoPlayer)!=null&&i.isPlaying)){this.videoPlayer&&(this.videoPlayer.screenspace=!this.videoPlayer.screenspace);return}if(this.isSending){this.close();return}this.share()}}set videoPlayer(e){this._videoPlayer&&(this.isSending||this.isReceiving)&&this._videoPlayer.stop(),this._videoPlayer=e,this._videoPlayer&&this._currentStream&&(this.isSending||this.isReceiving)&&this._videoPlayer.setVideo(this._currentStream)}get videoPlayer(){return this._videoPlayer}get screenspace(){var e;return((e=this.videoPlayer)==null?void 0:e.screenspace)??!1}set screenspace(e){this.videoPlayer&&(this.videoPlayer.screenspace=e)}get currentScream(){return this._currentStream}get currentMode(){return this._currentMode}get isSending(){var e;return((e=this._currentStream)==null?void 0:e.active)&&this._currentMode===on.Sending}get isReceiving(){if(this._currentMode===on.Receiving){if(!this._currentStream||this._currentStream.active===!1)return!1;const e=this._currentStream.getTracks();for(const i of e)if(i.readyState==="live")return!0}return!1}get requiresVideoPlayer(){return this.device!=="Microphone"}awake(){typeof this.device=="number"&&(this.device=N_[this.device]),Gt&&console.log("Screensharing",this.name,this),Oe.registerWaitForAllowAudio(()=>{this._videoPlayer&&this._currentStream&&this._currentMode===on.Receiving&&(this._videoPlayer.playInBackground=!0,this._videoPlayer.setVideo(this._currentStream))}),this._net=new gm(this)}onEnable(){var e,i,n;(e=this._net)==null||e.enable(),(i=this._net)==null||i.addEventListener(at.StreamReceived,this.onReceiveStream),(n=this._net)==null||n.addEventListener(at.StreamEnded,this.onCallEnded),this.context.connection.beginListen(se.JoinedRoom,this.onJoinedRoom),this.autoConnect&&Ko(1e3).then(()=>(this.enabled&&this.autoConnect&&!this.isReceiving&&!this.isSending&&this.context.connection.isInRoom&&this.share(),0))}onDisable(){var e,i,n;(e=this._net)==null||e.removeEventListener(at.StreamReceived,this.onReceiveStream),(i=this._net)==null||i.removeEventListener(at.StreamEnded,this.onCallEnded),this.context.connection.stopListen(se.JoinedRoom,this.onJoinedRoom),(n=this._net)==null||n.disable(),this.close()}_ensureVideoPlayer(){const e=new Ft;e.aspectMode=Tr.AdjustWidth,C.addComponent(this.gameObject,e),this._videoPlayer=e}async share(e){return this._activeShareRequest?this._activeShareRequest:(this._activeShareRequest=this.internalShare(e),this._activeShareRequest.then(()=>this._activeShareRequest=null))}async internalShare(e){if(this.context.connection.isInRoom===!1){console.warn("Can not start screensharing: requires network connection"),U()&&ke("Can not start screensharing: requires network connection. Add a SyncedRoom component or join a room first.");return}if(e!=null&&e.device&&(this.device=e.device),!this.videoPlayer&&this.requiresVideoPlayer&&(this._videoPlayer||(this._videoPlayer=C.getComponent(this.gameObject,Ft)??void 0),this.videoPlayer||this._ensureVideoPlayer(),!this.videoPlayer)){console.warn("Can not share video without a videoPlayer assigned");return}this._requestOpen=!0;try{const i=(e==null?void 0:e.constraints)??{echoCancellation:!0,autoGainControl:!1},n={video:i,audio:i},o=n.video;switch(o!==void 0&&typeof o!="boolean"&&(o.width||(o.width={max:1920}),o.height||(o.height={max:1920}),o.aspectRatio||(o.aspectRatio={ideal:1.7777777778}),o.frameRate||(o.frameRate={ideal:24}),o.facingMode||(o.facingMode={ideal:"user"})),this.device){case"Camera":this.tryShareUserCamera(n,e);break;case"Screen":{if(!navigator.mediaDevices.getDisplayMedia){console.error("No getDisplayMedia support");return}const c=await navigator.mediaDevices.getDisplayMedia(n);this._requestOpen?this.setStream(c,on.Sending):Bo(c)}break;case"Canvas":const r=0,l=this.context.renderer.domElement.captureStream(r);this.setStream(l,on.Sending);break;case"Microphone":{if(!navigator.mediaDevices.getUserMedia){console.error("No getDisplayMedia support");return}n.video=!1;const c=await navigator.mediaDevices.getUserMedia(n);this._requestOpen?this.setStream(c,on.Sending):Bo(c)}break;default:console.error("Can not start screen sharing: Unknown device type",this.device)}}catch(i){if(i.name==="NotAllowedError"){console.log("Selection cancelled"),this._requestOpen=!1;return}console.error("Error opening video",i)}}close(){var e;this._requestOpen=!1,this._currentStream&&(Gt&&console.warn("Close current stream / disposing resources, stream was active?",this._currentStream.active),(e=this._net)==null||e.stopSendingStream(this._currentStream),Bo(this._currentStream),this._currentMode=on.Idle,this._currentStream=null)}setStream(e,i){var r,l,c;if(e===this._currentStream||(this.close(),!e))return;this._currentStream=e,this._requestOpen=!0,this._currentMode=i;const n=this.device!=="Microphone",o=i===on.Sending;n?(this._videoPlayer||this._ensureVideoPlayer(),this._videoPlayer?this._videoPlayer.setVideo(e):console.error("No video player assigned for video stream")):(this._audioSource||(this._audioSource=new Oe,this._audioSource.spatialBlend=0,this._audioSource.volume=1,this.gameObject.addComponent(this._audioSource)),o||(Gt&&console.log("PLAY",e.getAudioTracks()),this._audioSource.volume=1,(r=this._audioSource)==null||r.play(e))),o&&((l=this._net)==null||l.startSendingStream(e)),o&&(this._videoPlayer&&(this._videoPlayer.muted=!0),(c=this._audioSource)==null||c.stop());for(const h of e.getTracks())h.addEventListener("ended",()=>{Gt&&console.log("Track ended",h),this.close()}),Gt&&h.kind==="video"&&console.log(o?"Video â†’":"Video â†",h.getSettings())}async tryShareUserCamera(e,i){const n=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");Gt&&console.log(`Request camera. These are your kind:videoinput devices:
`,n);let o=!1;for(const r of n)try{if(!this._requestOpen){Gt&&console.log("Camera selection cancelled");break}if(r.kind!=="videoinput"){Gt&&console.log("Skipping non-video device",r);continue}const l=r.deviceId;if((i==null?void 0:i.deviceId)!=null||(i==null?void 0:i.deviceFilter)!=null){if((i==null?void 0:i.deviceId)!==void 0&&l!==i.deviceId){Gt&&console.log("Skipping device due to options.deviceId: "+r.label+"; "+r.deviceId);continue}if(i!=null&&i.deviceFilter&&i.deviceFilter(r)===!1){Gt&&console.log("Skipping device due to options.deviceFilter: "+r.label+"; "+r.deviceId);continue}}else if(this.deviceFilter)if(this.deviceFilter(r)===!1){Gt&&console.log("Skipping device due to ScreenShare.deviceFilter: "+r.label+"; "+r.deviceId);continue}else Gt&&console.log("Selected device by filter",r);else if(this.deviceName){const d=r.label.toLowerCase(),u=this.deviceName.toLowerCase(),f=d.includes(u),p=r.deviceId===this.deviceName;if(!f&&!p){Gt&&console.log("Skipping device due to ScreenShare.deviceName: "+r.label+"; "+r.deviceId);continue}else Gt&&console.log("Selected device by name",r)}e.video!==!1&&((typeof e.video>"u"||typeof e.video=="boolean")&&(e.video={}),e.video.deviceId=l),o=!0;const h=await navigator.mediaDevices.getUserMedia(e).catch(d=>(console.error("Failed to get user media",d),null));if(h===null)continue;this._requestOpen?(this.setStream(h,on.Sending),Gt&&console.log("Selected camera",r)):(Bo(h),Gt&&console.log("Camera selection cancelled"));break}catch(l){if(l.message==="Failed to allocate videosource"||l.message==="Could not start video source"){ke("Failed to start video: Try another camera (Code "+l.code+")"),console.warn(l);continue}else console.error("Failed to get user media",l.message,l.code,l)}!o&&U()&&(ke("No camera found for sharing. Please connect a camera (see console for more information)"),console.warn("No camera found for sharing. Please connect a camera",n,this.deviceName,"Using deviceFilter? "+this.deviceFilter!=null,"Using options? "+i!=null,"Using deviceName? "+this.deviceName!=null,"Using options.deviceId? "+(i==null?void 0:i.deviceId)!=null,"Using options.deviceFilter? "+(i==null?void 0:i.deviceFilter)!=null))}}wu([m()],xl.prototype,"allowStartOnClick",void 0);wu([m()],xl.prototype,"autoConnect",void 0);wu([m(Ft)],xl.prototype,"videoPlayer",null);wu([m()],xl.prototype,"device",void 0);wu([m()],xl.prototype,"deviceName",void 0);var dP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Ql;(function(s){s[s.ShadowMask=0]="ShadowMask",s[s.Additive=1]="Additive",s[s.Occluder=2]="Occluder"})(Ql||(Ql={}));class Bm extends j{constructor(){super(...arguments);a(this,"mode",Ql.ShadowMask);a(this,"shadowColor",new pe(0,0,0,1));a(this,"targetMesh")}start(){if(this.gameObject instanceof X)this.gameObject instanceof X&&this.gameObject.material&&(this.gameObject.material=this.gameObject.material.clone(),this.targetMesh=this.gameObject,this.targetMesh.receiveShadow=!0);else{const e=ll.createPrimitive(Bn.Quad,{name:"ShadowCatcher",material:new It({color:10066329,roughness:1,metalness:0,transparent:!0})});e.receiveShadow=!0,e.geometry.rotateX(-Math.PI/2),this.gameObject.add(e),this.targetMesh=e}if(!this.targetMesh){console.warn("ShadowCatcher: no mesh to apply shadow catching to. Groups are currently not supported.");return}switch(this.targetMesh.layers.set(2),this.mode){case Ql.ShadowMask:this.applyShadowMaterial();break;case Ql.Additive:this.applyLightBlendMaterial();break;case Ql.Occluder:this.applyOccluderMaterial();break}}applyLightBlendMaterial(){if(!this.targetMesh)return;const e=this.targetMesh.material;e.blending=Ww,this.applyMaterialOptions(e),e.onBeforeCompile=i=>{i.fragmentShader=i.fragmentShader.replace("vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;",`vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
            // diffuse-only lighting with overdrive to somewhat compensate
            // for the loss of indirect lighting and to make it more visible.
            vec3 direct = (reflectedLight.directDiffuse + reflectedLight.directSpecular) * 6.6;
            float max = max(direct.r, max(direct.g, direct.b));
            
            // early out - we're simply returning direct lighting and some alpha based on it so it can 
            // be blended onto the scene.
            gl_FragColor = vec4(direct, max);
            return;
            `)},e.userData.isLightBlendMaterial=!0}applyShadowMaterial(){if(this.targetMesh)if(this.targetMesh.material.type!=="ShadowMaterial"){const e=new Dw;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),this.targetMesh.material=e,e.userData.isShadowCatcherMaterial=!0}else{const e=this.targetMesh.material;e.color=this.shadowColor,e.opacity=this.shadowColor.alpha,this.applyMaterialOptions(e),e.userData.isShadowCatcherMaterial=!0}}applyOccluderMaterial(){if(this.targetMesh){let e=this.targetMesh.material;if(!e){const i=new Be;this.targetMesh.material=i,e=i}e.depthWrite=!0,e.stencilWrite=!0,e.colorWrite=!1,this.gameObject.renderOrder=-100}}applyMaterialOptions(e){e&&(e.depthWrite=!1,e.stencilWrite=!1)}}dP([m()],Bm.prototype,"mode",void 0);dP([m(pe)],Bm.prototype,"shadowColor",void 0);const pf=new Map;function PD(s,t){if(pf.has(s))return pf.get(s);const e=new URL(s,window.location.href),i=RD(e,t);return pf.set(s,i),i.finally(()=>{pf.delete(s)}),i}async function RD(s,t){if(!s)return Promise.resolve(null);const e=s.pathname,i=s.toString().toLowerCase().includes("pmrem")||s.searchParams.get("pmrem")!=null,n=e.endsWith(".exr"),o=e.endsWith(".hdr"),r=e.endsWith(".ktx2");let l;if(n)l=new ib;else if(o)l=new Qw;else if(r){const{ktx2Loader:u}=sb(t);l=u}else l=new Bd;const c=s.toString();return await l.loadAsync(c).then(u=>{if(u){const f=e.lastIndexOf("/");u.name=e.substring(f>=0?f+1:0),i&&(u.mapping=Vw),l instanceof Bd&&(u.colorSpace=Qo)}return u}).catch(u=>(console.warn("Failed to load texture from url:",s),null))}var Su=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Vi=S("debugskybox");c0("background-image");c0("environment-image");function gw(s,t,e,i,n){if(t==="transparent"||t!=null&&t.startsWith("rgb")||t!=null&&t.startsWith("#"))return console.warn(`Needle Engine: Invalid ${n} value (${t}). Did you mean to set background-color instead?`),null;const o=new Zo;o.allowDrop=!1,o.allowNetworking=!1,o.background=e,o.environment=i,C.addComponent(s.scene,o);const r=l=>{typeof l=="string"&&(Vi&&console.log(n,"CHANGED TO",l),o.setSkybox(l))};return GT(s.domElement,n,r),o.addEventListener("destroy",()=>{Vi&&console.log("Destroyed attribute remote skybox",n),qT(s.domElement,n,r)}),o.setSkybox(t)}const Sp=new Array;ve.registerCallback(ge.ContextCreationStart,s=>{const t=s.context,e=t.domElement.getAttribute("background-image"),i=t.domElement.getAttribute("environment-image");if(e){Vi&&console.log("Creating RemoteSkybox to load background "+e);const n=gw(t,e,!0,!1,"background-image");n&&Sp.push(n)}if(i){Vi&&console.log("Creating RemoteSkybox to load environment "+i);const n=gw(t,i,!1,!0,"environment-image");n&&Sp.push(n)}});ve.registerCallback(ge.ContextCreationStart,()=>Promise.all(Sp).finally(()=>{Sp.length=0}));class Zo extends j{constructor(){super(...arguments);a(this,"url");a(this,"allowDrop",!0);a(this,"background",!0);a(this,"environment",!0);a(this,"allowNetworking",!0);a(this,"_prevUrl");a(this,"_prevLoadedEnvironment");a(this,"_prevEnvironment",null);a(this,"_prevBackground",null);a(this,"validProtocols",["file:","blob:","data:"]);a(this,"validTextureTypes",[".ktx2",".hdr",".exr",".jpg",".jpeg",".png"]);a(this,"onDragOverEvent",e=>{if(this.allowDrop&&e.dataTransfer)for(const i of e.dataTransfer.types)(i==="text/uri-list"||i==="Files")&&e.preventDefault()});a(this,"onDrop",e=>{var i,n,o,r;if(this.allowDrop&&e.dataTransfer){for(const l of e.dataTransfer.types)if(Vi&&console.log(l),l==="text/uri-list"){const c=e.dataTransfer.getData(l);Vi&&console.log(l,c);let h=(n=(i=new RegExp(/polyhaven.com\/asset_img\/.+?\/(?<name>.+)\.png/).exec(c))==null?void 0:i.groups)==null?void 0:n.name;if(h||(h=(r=(o=new RegExp(/polyhaven\.com\/a\/(?<name>.+)/).exec(c))==null?void 0:o.groups)==null?void 0:r.name),Vi&&console.log(h),h){const d="https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/"+h+"_1k.exr";console.log(`[Remote Skybox] Setting skybox from url: ${d}`),e.preventDefault(),this.setSkybox(d);break}else if(this.isValidTextureType(c)){console.log("[Remote Skybox] Setting skybox from url: "+c),e.preventDefault(),this.setSkybox(c);break}else{console.warn(`[RemoteSkybox] Unknown url ${c}. If you want to load a skybox from a url, make sure it is a valid image url. Url must end with${this.validTextureTypes.join(", ")}.`);const d=new CustomEvent("dropped-unknown-url",{detail:{sender:this,event:e,url:c,apply:u=>{e.preventDefault(),this.setSkybox(u)}}});this.dispatchEvent(d)}}else if(l=="Files"){const c=e.dataTransfer.files.item(0);if(Vi&&console.log(l,c),!c)continue;if(!this.isValidTextureType(c.name)){console.warn(`[RemoteSkybox]: File "${c.name}" is not supported. Supported files are ${this.validTextureTypes.join(", ")}`);return}e.preventDefault(),this.setSkybox(c.name);break}}})}onEnable(){this.setSkybox(this.url),this.registerDropEvents()}onDisable(){var e;this.context.scene.environment===this._prevLoadedEnvironment&&(this.context.scene.environment=this._prevEnvironment,Pe.backgroundShouldBeTransparent(this.context)||(this.context.scene.background=this._prevBackground),this._prevLoadedEnvironment=void 0),this.unregisterDropEvents(),(e=this.context.mainCameraComponent)==null||e.applyClearFlags()}urlChangedSyncField(){this.allowNetworking&&this.url&&(this.isRemoteTexture(this.url)?this.setSkybox(this.url):Vi&&console.warn(`RemoteSkybox: Not setting skybox: ${this.url} is not a remote texture. If you want to set a local texture, set allowNetworking to false.`))}async setSkybox(e,i){var o,r;if(!this.activeAndEnabled||(e=TD(e,this.environment,this.background),!e))return!1;if(i??(i=e),this.isValidTextureType(i)||console.warn('Potentially invalid skybox URL: "'+i+'" on '+(this.name||((o=this.gameObject)==null?void 0:o.name)||"context")),Vi&&console.log("Set RemoteSkybox url: "+e),this._prevUrl===e&&this._prevLoadedEnvironment)return this.apply(),!0;(r=this._prevLoadedEnvironment)==null||r.dispose(),this._prevLoadedEnvironment=void 0,this._prevUrl=e;const n=await PD(e,this.context.renderer);return n?!this.enabled||this.destroyed?(Vi&&console.warn("RemoteSkybox: Component is disabled or destroyed"),!1):this._prevUrl!==e?(Vi&&console.warn("RemoteSkybox: URL changed while loading texture, aborting setSkybox"),!1):(this.url=e,this._prevLoadedEnvironment=n,this.apply(),!0):(Vi&&console.warn("RemoteSkybox: Failed to load texture from url",e),!1)}apply(){var i;const e=this._prevLoadedEnvironment;if(e&&(e instanceof WR||e instanceof VR||e.mapping==Vw||(e.mapping=HR,e.needsUpdate=!0),!this.destroyed)){if(!this.context){console.warn("RemoteSkybox: Context is not available - can not apply skybox.");return}this.context.scene.background!==e&&(this._prevBackground=this.context.scene.background),this.context.scene.environment!==e&&(this._prevEnvironment=this.context.scene.environment),Vi&&console.log("Set RemoteSkybox ("+(this.environment&&this.background?"environment and background":this.environment?"environment":this.background?"background":"none")+")",this.url,!Pe.backgroundShouldBeTransparent(this.context)),this.environment&&(this.context.scene.environment=e),this.background&&!Pe.backgroundShouldBeTransparent(this.context)&&(this.context.scene.background=e),((i=this.context.mainCameraComponent)==null?void 0:i.backgroundBlurriness)!==void 0&&(this.context.scene.backgroundBlurriness=this.context.mainCameraComponent.backgroundBlurriness)}}isRemoteTexture(e){return e.startsWith("http://")||e.startsWith("https://")}isValidTextureType(e){for(const i of this.validTextureTypes)if(e.includes(i))return!0;for(const i of this.validProtocols)if(e.startsWith(i))return!0;return!1}registerDropEvents(){this.unregisterDropEvents(),this.context.domElement.addEventListener("dragover",this.onDragOverEvent),this.context.domElement.addEventListener("drop",this.onDrop)}unregisterDropEvents(){this.context.domElement.removeEventListener("dragover",this.onDragOverEvent),this.context.domElement.removeEventListener("drop",this.onDrop)}}Su([V1(Zo.prototype.urlChangedSyncField),m(URL)],Zo.prototype,"url",void 0);Su([m()],Zo.prototype,"allowDrop",void 0);Su([m()],Zo.prototype,"background",void 0);Su([m()],Zo.prototype,"environment",void 0);Su([m()],Zo.prototype,"allowNetworking",void 0);function TD(s,t,e){if(s==null)return null;const i=t&&!e;switch(s.toLowerCase()){case"studio":return i?"https://cdn.needle.tools/static/skybox/modelviewer-Neutral-small.pmrem4x4.ktx2?pmrem":"https://cdn.needle.tools/static/skybox/modelviewer-Neutral.pmrem4x4.ktx2?pmrem";case"blurred-skybox":return i?"https://cdn.needle.tools/static/skybox/blurred-skybox-small.pmrem4x4.ktx2?pmrem":"https://cdn.needle.tools/static/skybox/blurred-skybox.pmrem4x4.ktx2?pmrem";case"quicklook-ar":return i?"https://cdn.needle.tools/static/skybox/QuickLook-ARMode-small.pmrem4x4.ktx2?pmrem":"https://cdn.needle.tools/static/skybox/QuickLook-ARMode.pmrem4x4.ktx2?pmrem";case"quicklook":return i?"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode-small.pmrem4x4.ktx2?pmrem":"https://cdn.needle.tools/static/skybox/QuickLook-ObjectMode.pmrem4x4.ktx2?pmrem"}return s}var Fm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const A0=class extends j{constructor(){super(...arguments);a(this,"target",null);a(this,"followFactor",.1);a(this,"rotateFactor",.1);a(this,"positionAxes",$l.All);a(this,"flipForward",!1);a(this,"_firstUpdate",!0)}onBeforeRender(){this.updateNow(!1)}updateNow(e){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const i=ae(this.target),n=this._firstUpdate||e?1:N.clamp01(this.context.time.deltaTime*this.followFactor),o=this.worldPosition;this.positionAxes&$l.X&&(o.x=N.lerp(o.x,i.x,n)),this.positionAxes&$l.Y&&(o.y=N.lerp(o.y,i.y,n)),this.positionAxes&$l.Z&&(o.z=N.lerp(o.z,i.z,n)),this.worldPosition=o}if(this.rotateFactor>0){const i=Le(this.target);this.flipForward&&i.premultiply(A0._invertForward);const n=this._firstUpdate||e?1:N.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(i,n)}this._firstUpdate=!1}}};let eo=A0;a(eo,"_invertForward",new H().setFromAxisAngle(new x(0,1,0),Math.PI));Fm([m(D)],eo.prototype,"target",void 0);Fm([m()],eo.prototype,"followFactor",void 0);Fm([m()],eo.prototype,"rotateFactor",void 0);Fm([m()],eo.prototype,"positionAxes",void 0);var Cu=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const wd=S("debugspatialtrigger"),yw=new Vr,_w=new Vr;function OD(s,t){return yw.mask=s,_w.mask=t,yw.test(_w)}class Go extends j{constructor(){super(...arguments);a(this,"triggerMask",0);a(this,"onEnter");a(this,"onStay");a(this,"onExit");a(this,"currentIntersected",[]);a(this,"lastIntersected",[])}start(){wd&&console.log(this.name,this.triggerMask,this)}update(){this.currentIntersected.length=0;for(const e of Ja.triggers)OD(e.triggerMask,this.triggerMask)&&e.test(this.gameObject)&&this.currentIntersected.push(e);for(let e=this.lastIntersected.length-1;e>=0;e--){const i=this.lastIntersected[e];this.currentIntersected.indexOf(i)<0&&(this.onExitTrigger(i),this.lastIntersected.splice(e,1))}for(const e of this.currentIntersected)this.lastIntersected.indexOf(e)<0&&this.onEnterTrigger(e),this.onStayTrigger(e);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(e){var i;wd&&console.log("ENTER TRIGGER",this.name,e.name,this,e),e.raiseOnEnterEvent(this),(i=this.onEnter)==null||i.invoke()}onExitTrigger(e){var i;wd&&console.log("EXIT TRIGGER",this.name,e.name),e.raiseOnExitEvent(this),(i=this.onExit)==null||i.invoke()}onStayTrigger(e){var i;e.raiseOnStayEvent(this),(i=this.onStay)==null||i.invoke()}}Cu([m()],Go.prototype,"triggerMask",void 0);Cu([m(we)],Go.prototype,"onEnter",void 0);Cu([m(we)],Go.prototype,"onStay",void 0);Cu([m(we)],Go.prototype,"onExit",void 0);const Ld=class extends j{constructor(){super(...arguments);a(this,"triggerMask");a(this,"boxHelper")}start(){wd&&console.log(this.name,this.triggerMask,this)}onEnable(){var e;Ld.triggers.push(this),this.boxHelper||(this.boxHelper=C.addComponent(this.gameObject,un),(e=this.boxHelper)==null||e.showHelper(null,wd))}onDisable(){Ld.triggers.splice(Ld.triggers.indexOf(this),1)}test(e){return this.boxHelper?this.boxHelper.isInBox(e)??!1:!1}raiseOnEnterEvent(e){C.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Go&&i.onEnterTrigger(this)},!1)}raiseOnStayEvent(e){C.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Go&&i.onStayTrigger(this)},!1)}raiseOnExitEvent(e){C.foreachComponent(this.gameObject,i=>{i!==e&&i instanceof Go&&i.onExitTrigger(this)},!1)}};let Ja=Ld;a(Ja,"triggers",[]);Cu([m()],Ja.prototype,"triggerMask",void 0);var kD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Lc;(function(s){s[s.FirstPerson=0]="FirstPerson",s[s.ThirdPerson=1]="ThirdPerson"})(Lc||(Lc={}));const mn=S("debugspectator");class h0 extends j{constructor(){super(...arguments);a(this,"cam",null);a(this,"useKeys",!0);a(this,"_mode",Lc.FirstPerson);a(this,"orbit",null);a(this,"_handler");a(this,"eventSub_WebXRRequestStartEvent",null);a(this,"eventSub_WebXRStartEvent",null);a(this,"eventSub_WebXREndEvent",null);a(this,"_debug");a(this,"_networking")}get mode(){return this._mode}set mode(e){this._mode=e}get isSpectating(){var e;return((e=this._handler)==null?void 0:e.currentTarget)!==void 0}isSpectatingUser(e){var i;return((i=this.target)==null?void 0:i.userId)===e}isFollowedBy(e){var i;return(i=this.followers)==null?void 0:i.includes(e)}get followers(){return this._networking.followers}stopSpectating(){if(this.context.isInXR){this.followSelf();return}this.target=void 0}get localId(){return this.context.connection.connectionId??"local"}set target(e){var i;if(this._handler){const n=(i=this._handler.currentTarget)==null?void 0:i.userId,o=this.context.players.getPlayerView(this.localId);e===void 0||this.context.isInXR===!1&&(o==null?void 0:o.currentObject)===e.currentObject?this._handler.currentTarget!==void 0&&(this._handler.disable(),C.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),this._networking.onSpectatedObjectChanged(e,n)):this._handler.currentTarget!==e&&(this._handler.set(e),C.setActive(this.gameObject,!0),this.orbit&&(this.orbit.enabled=!1),this._networking.onSpectatedObjectChanged(e,n))}}get target(){var e;return(e=this._handler)==null?void 0:e.currentTarget}requestAllFollowMe(){this._networking.onRequestFollowMe()}get isSpectatingSelf(){var e,i;return this.isSpectating&&((e=this.target)==null?void 0:e.currentObject)===((i=this.context.players.getPlayerView(this.localId))==null?void 0:i.currentObject)}awake(){if(this._debug=new AD(this.context,this),this._networking=new LD(this.context,this),this._networking.awake(),C.setActive(this.gameObject,!1),this.cam=C.getComponent(this.gameObject,Pe),!this.cam){console.warn("SpectatorCamera: Spectator camera needs camera component on the same object.",this);return}!this._handler&&this.cam&&(this._handler=new ED(this.context,this.cam,this)),this.orbit=C.getComponent(this.context.mainCamera,Ee)}onDestroy(){var e,i;this.stopSpectating(),(e=this._handler)==null||e.destroy(),(i=this._networking)==null||i.destroy()}isSupportedPlatform(){const e=window.navigator.userAgent,i=/Windows|MacOS/.test(e),n=/Windows NT/.test(e)&&/Edg/.test(e)&&!/Win64/.test(e);return i&&!n}onBeforeXR(e){this.isSupportedPlatform()&&C.setActive(this.gameObject,!0)}onEnterXR(e){this.isSupportedPlatform()&&(mn&&console.log(this.context.mainCamera),this.context.mainCamera&&this.followSelf())}onLeaveXR(e){var i,n;this.context.removeCamera(this.cam),C.setActive(this.gameObject,!1),this.orbit&&(this.orbit.enabled=!0),(i=this._handler)==null||i.set(void 0),(n=this._handler)==null||n.disable(),this.isSpectatingSelf&&this.stopSpectating()}followSelf(){this.target=this.context.players.getPlayerView(this.context.connection.connectionId),this.target||(this.context.players.setPlayerView(this.localId,this.context.mainCamera,No.Headset),this.target=this.context.players.getPlayerView(this.localId)),mn&&console.log("Follow self",this.target)}onAfterRender(){var d,u,f;if(!this.cam)return;const e=this.context.renderer,i=e.xr.enabled;if(!e.xr.isPresenting&&!((d=this._handler)!=null&&d.currentTarget))return;(u=this._handler)==null||u.update(this._mode);const n=e.getRenderTarget();let o=null;const r=e.state;if(!n){if(!e.state.bindFramebuffer||!r.bindXRFramebuffer)return;o=e._framebuffer,r.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender();const l=this.context.mainCameraComponent;if(l){const p=l.backgroundColor;p&&e.setClearColor(p,p.alpha),this.cam.backgroundColor=p,this.cam.clearFlags=l.clearFlags,this.cam.nearClipPlane=l.nearClipPlane,this.cam.farClipPlane=l.farClipPlane}else e.setClearColor(new de(1,1,1));e.setRenderTarget(null),e.xr.enabled=!1;const c=(f=this.cam)==null?void 0:f.threeCamera;this.context.updateAspect(c);const h=e.xr.isPresenting;e.xr.isPresenting=!1,e.setSize(this.context.domWidth,this.context.domHeight),e.render(this.context.scene,c),e.xr.isPresenting=h,e.xr.enabled=i,n?e.setRenderTarget(n):r.bindXRFramebuffer&&r.bindXRFramebuffer(o),this.resetAvatarFlags()}setAvatarFlagsBeforeRender(){const e=this._mode===Lc.FirstPerson;for(const i of Lt.instances)if(i.avatar&&"isLocalAvatar"in i.avatar&&"flags"in i.avatar){let n=Fn.All;this.isSpectatingSelf&&(n=e&&i.avatar.isLocalAvatar?Fn.FirstPerson:Fn.ThirdPerson);const o=i.avatar.flags;if(!o)continue;for(const r of o)r.UpdateVisible(n)}}resetAvatarFlags(){var e;for(const i of Lt.instances)if(i.avatar&&"flags"in i.avatar){const n=i.avatar.flags;if(!n)continue;for(const o of n)"isLocalAvatar"in i.avatar&&((e=i.avatar)!=null&&e.isLocalAvatar)?o.UpdateVisible(Fn.FirstPerson):o.UpdateVisible(Fn.ThirdPerson)}}}kD([m()],h0.prototype,"useKeys",void 0);class ED{constructor(t,e,i){a(this,"context");a(this,"cam");a(this,"spectator");a(this,"follow");a(this,"target");a(this,"view");a(this,"currentObject");this.context=t,this.cam=e,this.spectator=i}get currentTarget(){return this.view}set(t){const e=t==null?void 0:t.currentObject;if(!e){this.spectator.stopSpectating();return}e!==this.currentObject&&(this.currentObject=e,this.view=t,this.follow||(this.follow=C.addComponent(this.cam.gameObject,eo)),this.target||(this.target=new D),e.add(this.target),this.follow.enabled=!0,this.follow.target=this.target,mn&&console.log("FOLLOW",e),this.context.isInXR?this.context.removeCamera(this.cam):this.context.setCurrentCamera(this.cam))}disable(){mn&&console.log("STOP FOLLOW",this.currentObject),this.view=void 0,this.currentObject=void 0,this.context.removeCamera(this.cam),this.follow&&(this.follow.enabled=!1)}destroy(){var t;(t=this.target)==null||t.removeFromParent(),this.follow&&C.destroy(this.follow)}update(t){var n,o,r,l,c,h;if(((n=this.currentTarget)==null?void 0:n.isConnected)===!1||((o=this.currentTarget)==null?void 0:o.removed)===!0){mn&&console.log("Target disconnected or timeout",this.currentTarget),this.spectator.stopSpectating();return}this.currentTarget&&((r=this.currentTarget)==null?void 0:r.currentObject)!==this.currentObject&&(mn&&console.log("Target changed",this.currentObject,"to",this.currentTarget.currentObject),this.set(this.currentTarget));const e=this.context.mainCamera;if(e){const d=this.cam.threeCamera;(d.near!==e.near||d.far!==e.far)&&(d.near=e.near,d.far=e.far,d.updateProjectionMatrix())}const i=(l=this.follow)==null?void 0:l.target;if(!(!i||!this.follow)){switch(t){case Lc.FirstPerson:((c=this.view)==null?void 0:c.viewDevice)!==No.Browser?(this.follow.followFactor=5,this.follow.rotateFactor=5):(this.follow.followFactor=50,this.follow.rotateFactor=50),i.position.set(0,0,0);break;case Lc.ThirdPerson:this.follow.followFactor=3,this.follow.rotateFactor=2,i.position.set(0,.5,1.5);break}this.follow.flipForward=!1,((h=this.view)==null?void 0:h.viewDevice)!==No.Browser?i.quaternion.copy(MD):i.quaternion.identity()}}}const MD=new H().setFromAxisAngle(new x(0,1,0),Math.PI);class AD{constructor(t,e){a(this,"context");a(this,"spectator");this.context=t,this.spectator=e,console.log("[Spectator Camera] Click other avatars or cameras to follow them. Press ESC to exit spectator mode."),this.context.domElement.addEventListener("keydown",n=>{if(!this.spectator.useKeys)return;n.key==="Escape"&&this.spectator.stopSpectating()});let i=0;this.context.input.addEventListener(_e.PointerDown,n=>{i=this.context.time.time}),this.context.input.addEventListener(_e.PointerUp,n=>{const o=this.context.time.time-i;o>1?this.spectator.stopSpectating():this.context.input.getPointerClicked(0)&&o<.3&&this.trySelectObject()})}trySelectObject(){const t=new Kr;t.setMask(16777215);const e=this.context.physics.raycast(t);if(mn&&console.log(...e),e!=null&&e.length)for(const i of e){if(i.distance<.2)continue;const n=i.object,o=C.getComponentInParent(n,Lt),r=o==null?void 0:o.connectionId;if(r){const l=this.context.players.getPlayerView(r);this.spectator.target=l,mn&&console.log("spectate",r,o);break}}}}class ID{constructor(t,e,i){a(this,"guid");a(this,"dontSave",!0);a(this,"targetUserId");a(this,"stoppedFollowing");this.guid=t,this.targetUserId=e,this.stoppedFollowing=i}}class DD{constructor(t,e){a(this,"guid");a(this,"userId");this.guid=t.guid,this.userId=e}}class LD{constructor(t,e){a(this,"followers",[]);a(this,"context");a(this,"spectator");a(this,"_followerEventMethod");a(this,"_requestFollowMethod");a(this,"_joinedRoomMethod");a(this,"_lastRequestFollowUser");a(this,"_enforceFollowInterval");this.context=t,this.spectator=e,this._followerEventMethod=this.onFollowerEvent.bind(this),this._requestFollowMethod=this.onRequestFollowEvent.bind(this),this._joinedRoomMethod=this.onUserJoinedRoom.bind(this)}awake(){this.context.connection.beginListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.beginListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.beginListen(se.JoinedRoom,this._joinedRoomMethod),this.context.domElement.addEventListener("keydown",t=>{this.spectator.useKeys&&(t.key==="f"?this.onRequestFollowMe():t.key==="Escape"&&this.onRequestFollowMe(!0))})}destroy(){this.context.connection.stopListen("spectator-follower-changed",this._followerEventMethod),this.context.connection.stopListen("spectator-request-follow",this._requestFollowMethod),this.context.connection.stopListen(se.JoinedRoom,this._joinedRoomMethod)}onSpectatedObjectChanged(t,e){if(mn&&console.log(this.context.connection.connectionId,"onSpectatedObjectChanged",t,e),this.context.connection.connectionId){const i=(t==null?void 0:t.userId)===void 0,n=i?e:t==null?void 0:t.userId,o=new ID(this.context.connection.connectionId,n,i);this.context.connection.send("spectator-follower-changed",o)}}onRequestFollowMe(t=!1){if(mn&&console.log("Request follow",this.context.connection.connectionId),this.context.connection.connectionId){this.spectator.stopSpectating();const e=t?void 0:this.context.connection.connectionId,i=new DD(this.spectator,e);this.context.connection.send("spectator-request-follow",i)}}onUserJoinedRoom(){S("followme")&&this.onRequestFollowMe()}onFollowerEvent(t){const e=t.targetUserId,i=t.guid;if(mn&&console.log(t),e===this.context.connection.connectionId)if(t.stoppedFollowing){const n=this.followers.indexOf(i);n!==-1&&(this.followers.splice(n,1),this.removeDisconnectedFollowers(),console.log(i,"unfollows you",this.followers.length))}else this.followers.includes(i)||(this.followers.push(i),this.removeDisconnectedFollowers(),console.log(i,"follows you",this.followers.length))}removeDisconnectedFollowers(){for(let t=this.followers.length-1;t>=0;t--){const e=this.followers[t];this.context.connection.userIsInRoom(e)===!1&&this.followers.splice(t,1)}}onRequestFollowEvent(t){if(this._lastRequestFollowUser=t,t.userId===this.context.connection.connectionId)this.spectator.stopSpectating();else if(t.userId===void 0)this.spectator.stopSpectating();else{const e=this.context.players.getPlayerView(t.userId);if(e)this.spectator.target=e;else return mn&&console.warn("Could not find view",t.userId),this.enforceFollow(),!1}return!0}enforceFollow(){this._enforceFollowInterval||(this._enforceFollowInterval=setInterval(()=>{this._lastRequestFollowUser===void 0||this._lastRequestFollowUser.userId&&this.spectator.isFollowedBy(this._lastRequestFollowUser.userId)?(clearInterval(this._enforceFollowInterval),this._enforceFollowInterval=void 0):(mn&&console.log("REQUEST FOLLOW AGAIN",this._lastRequestFollowUser.userId),this.onRequestFollowEvent(this._lastRequestFollowUser))},1e3))}}var eh=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const bw=S("debugsplines");class er{constructor(){a(this,"position",new x);a(this,"rotation",new H);a(this,"tangentIn",new x);a(this,"tangentOut",new x)}}eh([Rt(x)],er.prototype,"position",void 0);eh([Rt(H)],er.prototype,"rotation",void 0);eh([Rt(x)],er.prototype,"tangentIn",void 0);eh([Rt(x)],er.prototype,"tangentOut",void 0);class th extends j{constructor(){super(...arguments);a(this,"_closed",!1);a(this,"spline",[]);a(this,"_isDirty",!1);a(this,"_curve",null);a(this,"_builtCurve",!1);a(this,"_debugLine",null)}addKnot(e){if(e instanceof er)this.spline.push(e),this._isDirty=!0;else{const i=new er;i.position.copy(e.position),this.spline.push(i),this._isDirty=!0}return this}removeKnot(e){if(typeof e=="number")this.spline.splice(e,1),this._isDirty=!0;else{const i=this.spline.indexOf(e);i!==-1&&(this.spline.splice(i,1),this._isDirty=!0)}return this}getPointAt(e,i){if(!this.curve)return new x;const n=this.curve.getPointAt(N.clamp01(e),i),o=this.gameObject.matrixWorld??void 0;return o&&n.applyMatrix4(o),n}markDirty(){this._isDirty=!0}getTangentAt(e,i){if(!this.curve)return i??new x;const n=this.gameObject.worldQuaternion;return this.curve.getTangentAt(N.clamp01(e),i).applyQuaternion(n)}set closed(e){this._closed=e,this._isDirty=!0}get closed(){return this._closed}set debug(e){e&&!this._builtCurve&&this.buildCurve(),this._debugLine&&(this._debugLine.visible=e)}get curve(){return this._curve}get isDirty(){return this._isDirty}awake(){bw&&(console.log(`[Spline] ${this.name}`,this),this.buildCurve())}update(){this._isDirty&&this.buildCurve(!0),this._debugLine&&this._debugLine.parent!==this.gameObject&&this.gameObject.add(this._debugLine)}buildCurve(e=!1){if(!(this._builtCurve&&!e)){if(this._builtCurve=!0,!this.spline){console.error("[Spline] Can not build curve, no spline data",this.name);return}this._isDirty=!1,this._curve=jD(this.spline,this.closed),this.buildDebugCurve()}}buildDebugCurve(){var e,i;if(bw&&this.spline&&this._curve){(e=this._debugLine)==null||e.removeFromParent(),this._debugLine=null;const n=new Q_({color:6684927}),o=this.spline.length*10,r=this._curve.getPoints(o),l=new os().setFromPoints(r);this._debugLine=new vc(l,n),(i=this.gameObject)==null||i.add(this._debugLine)}}}eh([Rt()],th.prototype,"closed",null);eh([Rt(er)],th.prototype,"spline",void 0);function jD(s,t){const e=s.map(o=>new x(-o.position.x,o.position.y,o.position.z));e.length===1&&e.push(e[0]);const i=s.reduce((o,r)=>o+Math.abs(r.tangentOut.x)+Math.abs(r.tangentOut.y)+Math.abs(r.tangentOut.z),0)/s.length,n=N.remap(i,0,.3,0,.5);return new GR(e,t,"catmullrom",n)}var wl=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class mo extends j{constructor(){super(...arguments);a(this,"spline",null);a(this,"object");a(this,"lookAt",null);a(this,"clamp",!1);a(this,"autoRun",!0);a(this,"duration",10);a(this,"_position01",0)}get position01(){return this._position01}set position01(e){this._position01=e,this.updateFromPosition()}reset(){this._position01=0}start(){this.object===void 0&&(this.object=this.gameObject),this.updateFromPosition()}update(){this.autoRun&&(this._position01+=this.context.time.deltaTime/this.duration,this.updateFromPosition())}updateFromPosition(){if(!this.spline||!this.spline.curve||!this.object)return;this.clamp?this._position01=N.clamp01(this._position01):this._position01=this._position01%1;const e=this._position01>=1?1:this._position01%1,i=this.spline.getPointAt(e);if(this.object.worldPosition=i,this.lookAt)this.object.lookAt(this.lookAt.worldPosition);else{const n=this.spline.getTangentAt(e);this.object.lookAt(i.add(n))}}}wl([Rt(th)],mo.prototype,"spline",void 0);wl([Rt(D)],mo.prototype,"object",void 0);wl([Rt(D)],mo.prototype,"lookAt",void 0);wl([Rt()],mo.prototype,"clamp",void 0);wl([Rt()],mo.prototype,"position01",null);wl([Rt()],mo.prototype,"autoRun",void 0);wl([Rt()],mo.prototype,"duration",void 0);class Us{constructor(){a(this,"bb",null);a(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedCameraModel(t,e){return(e||new Us).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedCameraModel(t,e){return t.setPosition(t.position()+fb),(e||new Us).__init(t.readInt32(t.position())+t.position(),t)}userId(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}guid(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__string(this.bb_pos+e,t):null}dontSave(){const t=this.bb.__offset(this.bb_pos,8);return t?!!this.bb.readInt8(this.bb_pos+t):!1}pos(t){const e=this.bb.__offset(this.bb_pos,10);return e?(t||new Xa).__init(this.bb_pos+e,this.bb):null}rot(t){const e=this.bb.__offset(this.bb_pos,12);return e?(t||new Xa).__init(this.bb_pos+e,this.bb):null}static startSyncedCameraModel(t){t.startObject(5)}static addUserId(t,e){t.addFieldOffset(0,e,0)}static addGuid(t,e){t.addFieldOffset(1,e,0)}static addDontSave(t,e){t.addFieldInt8(2,+e,0)}static addPos(t,e){t.addFieldStruct(3,e,0)}static addRot(t,e){t.addFieldStruct(4,e,0)}static endSyncedCameraModel(t){return t.endObject()}static finishSyncedCameraModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedCameraModelBuffer(t,e){t.finish(e,void 0,!0)}}var BD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Cp="SCAM";ES(Cp,Us.getRootAsSyncedCameraModel);const nn=new eu;class FD{constructor(t,e){a(this,"userId");a(this,"guid");this.guid=e,this.userId=t}send(t,e){if(t){nn.clear();const i=nn.createString(this.guid),n=nn.createString(this.userId);Us.startSyncedCameraModel(nn),Us.addGuid(nn,i),Us.addUserId(nn,n);const o=ae(t),r=lb(t);Us.addPos(nn,Xa.createVec3(nn,o.x,o.y,o.z)),Us.addRot(nn,Xa.createVec3(nn,r.x,r.y,r.z));const l=Us.endSyncedCameraModel(nn);nn.finish(l,Cp),e.sendBinary(nn.asUint8Array())}}}const jp=class extends j{constructor(){super(...arguments);a(this,"cameraPrefab",null);a(this,"_lastWorldPosition");a(this,"_lastWorldQuaternion");a(this,"_model",null);a(this,"_needsUpdate",!0);a(this,"_lastUpdateTime",0);a(this,"remoteCams",{});a(this,"userToCamMap",{});a(this,"_camTimeoutInSeconds",10);a(this,"_receiveCallback",null)}getCameraObject(e){const i=this.userToCamMap[e];return i?this.remoteCams[i].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}onEnable(){this._receiveCallback=this.context.connection.beginListenBinary(Cp,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(Cp,this._receiveCallback)}update(){for(const o in this.remoteCams){const r=this.remoteCams[o],l=this.context.time.realtimeSinceStartup-r.lastUpdate;if(!r||l>this._camTimeoutInSeconds){U()&&console.log("Remote cam timeout",o),r!=null&&r.obj&&C.destroy(r.obj),delete this.remoteCams[o],r&&delete this.userToCamMap[r.userId],jp.instances.push(r),this.context.players.removePlayerView(r.userId,No.Browser);continue}}if(this.context.isInXR)return;const e=this.context.mainCamera;if(e===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new FD(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const i=ae(e),n=Le(e);(i.distanceTo(this._lastWorldPosition)>.001||n.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(i),this._lastWorldQuaternion.copy(n),!((!this._needsUpdate||this.context.time.frameCount%2!==0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(e,this.context.connection),this.context.isInXR||this.context.players.setPlayerView(this.context.connection.connectionId,e,No.Browser))}onReceivedRemoteCameraInfoBin(e){const i=e.guid();if(!i)return;const n=e.userId();if(!n||!this.context.connection.userIsInRoom(n)||!this.cameraPrefab)return;let o=this.remoteCams[i];if(!o)if("isObject3D"in this.cameraPrefab){const h=new lo;h.context=this.context;const d=C.instantiate(this.cameraPrefab,h);o=this.remoteCams[i]={obj:d,lastUpdate:this.context.time.realtimeSinceStartup,userId:n},o.obj.visible=!0,this.gameObject.add(d),this.userToCamMap[n]=i,jp.instances.push(o);const u=C.getOrAddComponent(d,Lt);u.connectionId=n,u.avatar=d}else return;const r=o.obj;this.context.players.setPlayerView(n,r,No.Browser),o.lastUpdate=this.context.time.realtimeSinceStartup,cs.markDirty(r);const l=e.pos();l&&Cc(r,l.x(),l.y(),l.z());const c=e.rot();c&&em(r,c.x(),c.y(),c.z())}};let gc=jp;a(gc,"instances",[]);BD([m([D,he])],gc.prototype,"cameraPrefab",void 0);var aa=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const xy="view",wy=S("debugsyncedroom");class go extends j{constructor(){super(...arguments);a(this,"roomName","");a(this,"urlParameterName","room");a(this,"joinRandomRoom");a(this,"requireRoomParameter",!1);a(this,"autoRejoin",!0);a(this,"createJoinButton",!0);a(this,"createViewOnlyButton",!1);a(this,"_lastJoinedRoom");a(this,"_roomPrefix","");a(this,"_lastPingTime",0);a(this,"_lastRoomTime",-1);a(this,"_userWantsToBeInARoom",!1);a(this,"_roomButton");a(this,"_roomButtonIconJoin");a(this,"_roomButtonIconLeave");a(this,"updateRoomButtonState",()=>{var e,i;this._roomButton&&(this.context.connection.isInRoom?(this._roomButton.title="Leave the networked room",this._roomButton.textContent="Leave Room",(e=this._roomButtonIconJoin)==null||e.remove(),this._roomButton.prepend(this._roomButtonIconLeave)):(this._roomButton.title="Create or join a networked room",this._roomButton.textContent="Join Room",(i=this._roomButtonIconLeave)==null||i.remove(),this._roomButton.prepend(this._roomButtonIconJoin)))});a(this,"_viewOnlyButton");a(this,"onCreateViewOnlyButton",()=>{if(!this._viewOnlyButton){const e=document.createElement("button");this._viewOnlyButton=e,e.classList.add("view-only-button"),e.setAttribute("priority","90"),e.onclick=()=>{var n;const i=this.getViewOnlyUrl();i!=null&&i.length?navigator.canShare({url:i})?(n=navigator.share({url:i}))==null||n.catch(o=>{console.warn(o)}):(navigator.clipboard.writeText(i),nt("View only URL copied to clipboard")):ke("Could not create view only URL")},e.title="Copy the view only URL: A page accessed by the view only URL can not be modified by visiting users.",e.textContent="Share View URL",e.prepend(mi("visibility"))}this.context.menu.appendChild(this._viewOnlyButton)})}get currentRoomName(){const e=S(xy);return e||S(this.urlParameterName)}set roomPrefix(e){this._roomPrefix=e}get roomPrefix(){return this._roomPrefix}awake(){var e;this.joinRandomRoom===void 0&&((e=this.roomName)==null?void 0:e.length)<=0&&(this.joinRandomRoom=!0),wy&&console.log(`SyncedRoom roomName:${this.roomName}, urlParamName:${this.urlParameterName}, joinRandomRoom:${this.joinRandomRoom}`)}onEnable(){const e=S(xy);if(e&&typeof e=="string"&&e.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(e,!0);return}if(this.tryJoinRoom(),this.createJoinButton){const i=this.createRoomButton();this.context.menu.appendChild(i)}this.createViewOnlyButton&&this.onEnableViewOnlyButton()}onDisable(){var e;(e=this._roomButton)==null||e.remove(),this.onDisableViewOnlyButton(),this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}onDestroy(){this.destroyRoomButton()}tryJoinRandomRoom(){this.setRandomRoomUrlParameter(),this.tryJoinRoom()}tryJoinRoom(e=0){var n;e===void 0&&(e=0);let i=!1;if(((n=this.urlParameterName)==null?void 0:n.length)>0){const o=S(this.urlParameterName);if(o&&(typeof o=="string"||typeof o=="number")){i=!0;const r=WT(o.toString());this.roomName=r}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),e<1))return this.tryJoinRoom(e+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(this.roomName=this.generateRoomName());return this.requireRoomParameter&&!i?((wy||U())&&console.warn('[SyncedRoom] Missing required room parameter "'+this.urlParameterName+`" in url - will not connect.
To allow joining a room without a query parameter you can set "requireRoomParameter" to false.`),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._lastJoinedRoom=this.roomName,this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.roomName.length<=0?(console.warn(`[SyncedRoom] Room name is not set so we can not join a networked room.
Please choose one of the following options to fix this:
A) Set a room name in the SyncedRoom component
B) Set a room name in the URL parameter "?`+this.urlParameterName+`=my_room"
C) Set "joinRandomRoom" to true`),!1):(wy&&console.log("Join "+this.roomName),this._userWantsToBeInARoom=!0,this.context.connection.joinRoom(this.roomName),!0))}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.sendPing()),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?this._userWantsToBeInARoom&&(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):U()&&console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you?)"))}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const e=window.location.search,i=new URLSearchParams(e);return i.has(this.urlParameterName)&&i.delete(this.urlParameterName),i.set(xy,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+i.toString()}return null}setRandomRoomUrlParameter(){const e=Yp(),i=this.generateRoomName();S(this.urlParameterName)?e.set(this.urlParameterName,i):e.append(this.urlParameterName,i),iS(i,e)}generateRoomName(){let e="";for(let i=0;i<6;i++)e+=Math.floor(Math.random()*10).toFixed(0);return e}createRoomButton(){if(this._roomButton)return this._roomButton;const e=document.createElement("button");return this._roomButton=e,e.classList.add("create-room-button"),e.setAttribute("priority","90"),e.onclick=()=>{if(this.context.connection.isInRoom)this.urlParameterName&&$f(this.urlParameterName,null),this.context.connection.leaveRoom(),this._userWantsToBeInARoom=!1;else{if(this.urlParameterName){const i=S(this.urlParameterName);(!i||i===!0)&&(this._lastJoinedRoom?$f(this.urlParameterName,this._lastJoinedRoom):this.setRandomRoomUrlParameter())}this.tryJoinRoom()}},this._roomButtonIconJoin=mi("group"),this._roomButtonIconLeave=mi("group_off"),this.updateRoomButtonState(),this.context.connection.beginListen(se.JoinedRoom,this.updateRoomButtonState),this.context.connection.beginListen(se.LeftRoom,this.updateRoomButtonState),e}destroyRoomButton(){this.context.connection.stopListen(se.JoinedRoom,this.updateRoomButtonState),this.context.connection.stopListen(se.LeftRoom,this.updateRoomButtonState)}onEnableViewOnlyButton(){this.context.connection.isConnected?this.onCreateViewOnlyButton():(this.context.connection.stopListen(se.JoinedRoom,this.onCreateViewOnlyButton),this.context.connection.beginListen(se.JoinedRoom,this.onCreateViewOnlyButton))}onDisableViewOnlyButton(){var e;this.context.connection.stopListen(se.JoinedRoom,this.onCreateViewOnlyButton),(e=this._viewOnlyButton)==null||e.remove()}}aa([m()],go.prototype,"roomName",void 0);aa([m()],go.prototype,"urlParameterName",void 0);aa([m()],go.prototype,"joinRandomRoom",void 0);aa([m()],go.prototype,"requireRoomParameter",void 0);aa([m()],go.prototype,"autoRejoin",void 0);aa([m()],go.prototype,"createJoinButton",void 0);aa([m()],go.prototype,"createViewOnlyButton",void 0);aa([m()],go.prototype,"roomPrefix",null);function zD(){const s=S("testwindowcount")||0;s&&s>0&&UD(s)}function UD(s){if(S("testwindow"))return null;const t=new URL(window.location.href);$0(t.searchParams,n2,1),$0(t.searchParams,"testwindow",1);const e=t.toString(),i=[];window.onbeforeunload=()=>{for(const c of i)c.close()};const n=.05,o=128;let r=0,l=0;for(let c=0;c<s;c++){r*o+o*.01>=window.innerWidth&&(l+=1,r=0);const h=r*(o*(1+n))+window.screenLeft,d=l*(o*(1+n))+window.screenTop+90+60*l;r+=1;const u=window.open(e,"test window "+c,`popup=yes width=${o} height=${o} top=${d} left=${h}`);if(!u){console.warn("Failed to open window");continue}i.push(u),u.onload=()=>{u.onbeforeunload=()=>{for(let f=0;f<i.length;f++){const p=i[f];p!==u&&p.close()}i.length=0}}}return i}class uP extends j{awake(){zD()}}class fP extends j{constructor(){super(...arguments);a(this,"transformsPerFrame",10);a(this,"interval",0);a(this,"useFlatbuffers",!0);a(this,"builder",null);a(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinary(Xd,e=>{});else{this.models=[];for(let e=0;e<this.transformsPerFrame;e++)this.models.push(new pP(this.context.connection.connectionId+"_simulatedTransform_"+e,this))}}update(){if(this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!==0)return;this.builder===null&&(this.builder=new eu(1024));const e=this.builder;for(let i=0;i<this.transformsPerFrame;i++){e.clear();const n=d1(this.context.connection.connectionId,this);this.context.connection.sendBinary(n)}}else if(this.models)for(let e=0;e<this.models.length;e++){const i=this.models[e];i.dontSave=!0,i.update(this,null),this.context.connection.send("TestSimulateUserData-"+e,i)}}}}class pP{constructor(t,e){a(this,"guid");a(this,"fast",!1);a(this,"position");a(this,"rotation");a(this,"velocity");a(this,"dontSave");this.guid=t,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(e,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(t,e){const i=t.worldPosition;this.position.x=i.x,this.position.y=i.y,this.position.z=i.z;const n=t.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,e){const o=e.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}a(pP,"temp",new x);var zm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ND=S("debugsignals");class d0{constructor(){a(this,"guid")}}zm([m()],d0.prototype,"guid",void 0);class Um{constructor(){a(this,"signal");a(this,"reaction")}}zm([m(d0)],Um.prototype,"signal",void 0);zm([m(we)],Um.prototype,"reaction",void 0);const Ls=class extends j{constructor(){super(...arguments);a(this,"events")}static invoke(e){if(Ls.receivers[e]){const i=Ls.receivers[e];if(!i)return;for(const n of i)n.invoke(e)}}awake(){ND&&console.log("SignalReceiver awake",this)}onEnable(){if(this.events)for(const e of this.events)Ls.receivers[e.signal.guid]||(Ls.receivers[e.signal.guid]=[]),Ls.receivers[e.signal.guid].push(this)}onDisable(){if(this.events){for(const e of this.events)if(Ls.receivers[e.signal.guid]){const i=Ls.receivers[e.signal.guid].indexOf(this);i>=0&&Ls.receivers[e.signal.guid].splice(i,1)}}}invoke(e){if(!this.events||!Array.isArray(this.events))return;const i=typeof e=="object"?e.guid:e;for(const n of this.events)if(n.signal.guid===i)try{if(n.reaction){if(!n.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",n,this);continue}}else{console.warn("Missing reaction for signal",n,this);continue}n.reaction.invoke()}catch(o){console.error(o)}}};let Wr=Ls;a(Wr,"receivers",{});zm([m(Um)],Wr.prototype,"events",void 0);var rn;(function(s){s.Activation="ActivationTrack",s.Animation="AnimationTrack",s.Audio="AudioTrack",s.Control="ControlTrack",s.Marker="MarkerTrack",s.Signal="SignalTrack"})(rn||(rn={}));var Ms;(function(s){s[s.None=0]="None",s[s.Hold=1]="Hold",s[s.Loop=2]="Loop",s[s.PingPong=3]="PingPong",s[s.Continue=4]="Continue"})(Ms||(Ms={}));var $_;(function(s){s.Signal="SignalEmitter"})($_||($_={}));const Ys=S("debugtimeline");class Nm{constructor(){a(this,"director");a(this,"track")}get muted(){return this.track.muted}set muted(t){var e;t!==this.track.muted&&(this.track.muted=t,(e=this.onMuteChanged)==null||e.call(this))}*forEachClip(t=!1){var e;if((e=this.track)!=null&&e.clips)if(t)for(let i=this.track.clips.length-1;i>=0;i--)yield this.track.clips[i];else for(const i of this.track.clips)yield i}getClipTime(t,e){return e.clipIn+(t-e.start)*e.timeScale}getClipTimeNormalized(t,e){return(t-e.start)/e.duration}evaluateWeight(t,e,i,n=!0){if(e<0||e>=i.length)return 0;const o=i[e];if(n||t>=o.start&&t<=o.end){let r=1;const l=!1;if(o.easeInDuration>0){const c=Math.min((t-o.start)/o.easeInDuration,1);r*=c}if(o.easeOutDuration>0&&!l){const c=Math.min((o.end-t)/o.easeOutDuration,1);r*=c}return r}return 0}}class $D{constructor(t){a(this,"clip");a(this,"rootPositionOffset");a(this,"rootQuaternionOffset");a(this,"rootStartPosition");a(this,"rootEndPosition");a(this,"rootStartQuaternion");a(this,"rootEndQuaternion");const e=t.getClip();this.clip=e;const i=t.getRoot(),n=i.name+".position",o=i.name+".quaternion";Ys&&console.log(e.name,e.tracks,n);for(const r of e.tracks)if(!(r.times.length<=0)){if(r.name.endsWith(n))this.rootStartPosition=new x().fromArray(r.values,0),this.rootEndPosition=new x().fromArray(r.values,r.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),Ys&&console.log(this.rootPositionOffset);else if(r.name.endsWith(o)&&(this.rootStartQuaternion=new H().fromArray(r.values,0),this.rootEndQuaternion=new H().fromArray(r.values,r.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),Ys)){const l=new Ct().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}class u0 extends Nm{constructor(){super(...arguments);a(this,"models",[]);a(this,"trackOffset");a(this,"target");a(this,"mixer");a(this,"clips",[]);a(this,"actions",[]);a(this,"weight",1);a(this,"_actionOffsets",[]);a(this,"_didBind",!1);a(this,"_animator",null);a(this,"_useclipOffsets",!0);a(this,"_totalOffsetPosition",new x);a(this,"_totalOffsetRotation",new H);a(this,"_totalOffsetPosition2",new x);a(this,"_totalOffsetRotation2",new H);a(this,"_summedPos",new x);a(this,"_tempPos",new x);a(this,"_summedRot",new H);a(this,"_tempRot",new H);a(this,"_clipRotQuat",new H)}onDisable(){var e;(e=this.mixer)==null||e.stopAllAction()}onDestroy(){this.director.context.animations.unregisterAnimationMixer(this.mixer)}onStateChanged(){this._animator&&Cx(this._animator.gameObject,this,this.director.isPlaying)}createHooks(e,i){var d,u;if(((d=i.tracks)==null?void 0:d.length)<=0){console.warn("No tracks in AnimationClip",i);return}const n=i.tracks[0].name.split("."),o=n[n.length-2],r=o+".position",l=o+".quaternion";let c=!1,h=!1;for(const f of i.tracks)f.name.endsWith(r)?(c=!0,this.createPositionInterpolant(i,e,f)):f.name.endsWith(l)&&(h=!0,this.createRotationInterpolant(i,e,f));if(!c||!h){const f=(u=this.mixer)==null?void 0:u.getRoot(),p=i.tracks[0],g=p.name.lastIndexOf("."),_=p.name.substring(0,g),y=_.substring(_.lastIndexOf(".")+1),b=f.getObjectByName(y);if(b)if(c){if(!h){const v=i.tracks[0].name.substring(0,g)+".quaternion";Ys&&console.warn("Create quaternion track",y,b);const w=b.quaternion,P=new XR(v,[0,i.duration],[w.x,w.y,w.z,w.w,w.x,w.y,w.z,w.w]);i.tracks.push(P),this.createRotationInterpolant(i,e,P)}}else{const v=_+".position";Ys&&console.warn("Create position track",y,b);const w=b.position,P=new qR(v,[0,i.duration],[w.x,w.y,w.z,w.x,w.y,w.z]);i.tracks.push(P),this.createPositionInterpolant(i,e,P)}}}bind(){if(!this._didBind){this._didBind=!0,Ys&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const e of this.actions){const i=new $D(e);this._actionOffsets.push(i)}this.target&&(this._animator=C.getComponent(this.target,ii)??null,this._animator&&Cx(this._animator.gameObject,this,!0));for(const e of this.models){const i=e.asset,n=i.position,o=i.rotation;n&&n.x!==void 0&&(n.isVector3||(i.position=new x(n.x,n.y,n.z)),o.isQuaternion||(i.rotation=new H(o.x,o.y,o.z,o.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const e=this.trackOffset.position;e&&(e.isVector3||(this.trackOffset.position=new x(e.x,e.y,e.z)));const i=this.trackOffset.rotation;i&&(i.isQuaternion||(this.trackOffset.rotation=new H(i.x,i.y,i.z,i.w)))}}evaluate(e){var c,h,d,u,f,p,g;if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let i=0,n=0,o=!1,r=!1,l=0;for(let _=0;_<this.clips.length;_++){const y=this.models[_],b=this.actions[_],v=y.asset;b.weight=0;const w=e>=y.start&&e<=y.end,P=y.preExtrapolationMode,E=y.postExtrapolationMode,T=_<this.clips.length-1?this.models[_+1]:null;let k=w,z=!1;if(!k&&!o&&y.end<e&&E!==Ms.None?(!T||T.start>e)&&(k=!0,o=!0):_==0&&!k&&!r&&y.start>e&&P!==Ms.None&&(!T||T.start<e)&&(k=!0,z=!0,r=!0),k){let L=this.weight;L*=this.evaluateWeight(e,_,this.models,k),L*=this.director.weight;let O=w;if(z)switch(P){case Ms.Hold:break;case Ms.Loop:e+=y.start,O=!0;break;default:e+=y.start,O=!0;break}let A=this.getClipTime(e,y),$=0;const B=v.duration;if(z&&P===Ms.Hold&&(A=0),O){if(v.loop)for($+=Math.floor(A/(B+1e-6));A>B;)A-=B}else if(!w&&o)switch(E){case Ms.Hold:A=this.getClipTime(y.end,y);break;case Ms.Loop:A%=B;break;case Ms.PingPong:const ie=Math.floor(A/B)%2!==0;A%=B,ie&&(A=B-A);break}y.reversed===!0?b.time=b.getClip().duration-A:b.time=A,b.timeScale=0;const I=Math.max(0,L);if(b.weight=I,l+=I,b.clampWhenFinished=!1,b.isRunning()||b.play(),this._useclipOffsets){const V=i==0?this._totalOffsetPosition:this._totalOffsetPosition2,ie=i==0?this._totalOffsetRotation:this._totalOffsetRotation2;i<1&&(n=1-L),i+=1;const Z=this._summedPos.set(0,0,0),J=this._tempPos.set(0,0,0),ue=this._summedRot.identity(),Ae=this._tempRot.identity(),He=v.rotation;He&&(this._clipRotQuat.identity(),this._clipRotQuat.slerp(He,L));const ai=this._actionOffsets[_];if(ai.hasOffsets)for(let Wt=0;Wt<$;Wt++)ai.rootPositionOffset?J.copy(ai.rootPositionOffset):J.set(0,0,0),J.applyQuaternion(ue),this._clipRotQuat&&J.applyQuaternion(this._clipRotQuat),ai.rootQuaternionOffset&&(Ae.copy(ai.rootQuaternionOffset),ue.multiply(Ae)),Z.add(J);this._clipRotQuat&&ie.multiply(this._clipRotQuat),ie.multiply(ue),v.position&&Z.add(v.position),V.add(Z)}}}if(this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,n),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,n)),this.__mixerError===void 0&&(Ys||U())&&((h=(c=this._animator)==null?void 0:c.runtimeAnimatorController)!=null&&h.mixer)&&this.mixer!==((u=(d=this._animator)==null?void 0:d.runtimeAnimatorController)==null?void 0:u.mixer)&&(this.__mixerError=!0,console.error("AnimationTrack mixer is not shared with the animator controller - this might result in the timeline to not animate properly. Please report a bug to the Needle Engine team!",this)),(f=this._animator)!=null&&f.runtimeAnimatorController){const _=Math.max(0,1-l);(g=(p=this._animator)==null?void 0:p.runtimeAnimatorController)==null||g.update(_)}else this.mixer.update(e)}createRotationInterpolant(e,i,n){var c;const o=n.createInterpolant.bind(n),r=new H;this.ensureTrackOffsets();const l=(c=this.trackOffset)==null?void 0:c.rotation;n.createInterpolant=()=>{const h=o(),d=h.evaluate.bind(h);return h.evaluate=u=>{var p;const f=d(u);if(r.set(f[0],f[1],f[2],f[3]),r.premultiply(this._totalOffsetRotation),l&&r.premultiply(l),this.director.animationCallbackReceivers)for(const g of this.director.animationCallbackReceivers)(p=g==null?void 0:g.onTimelineRotation)==null||p.call(g,this.director,this.target,u,r);return f[0]=r.x,f[1]=r.y,f[2]=r.z,f[3]=r.w,f},h}}createPositionInterpolant(e,i,n){var d,u;const o=n.createInterpolant.bind(n),r=new x;this.ensureTrackOffsets();const l=(d=this.trackOffset)==null?void 0:d.rotation,c=(u=this.trackOffset)==null?void 0:u.position;let h;n.createInterpolant=()=>{const f=o(),p=f.evaluate.bind(f);return f.evaluate=g=>{var y,b,v;const _=p(g);if(r.set(_[0],_[1],_[2]),i.removeStartOffset&&(h===void 0?(h=null,h=(b=(y=this._actionOffsets.find(w=>w.clip===e))==null?void 0:y.rootStartPosition)==null?void 0:b.clone()):h!=null&&h.isVector3&&r.sub(h)),r.applyQuaternion(this._totalOffsetRotation),r.add(this._totalOffsetPosition),l&&r.applyQuaternion(l),c&&(r.x-=c.x,r.y+=c.y,r.z+=c.z),this.director.animationCallbackReceivers)for(const w of this.director.animationCallbackReceivers)(v=w==null?void 0:w.onTimelinePosition)==null||v.call(w,this.director,this.target,g,r);return _[0]=r.x,_[1]=r.y,_[2]=r.z,_},f}}}const WD=S("mutetimeline"),ac=class extends Nm{constructor(){super(...arguments);a(this,"models",[]);a(this,"listener");a(this,"audio",[]);a(this,"audioContextTimeOffset",[]);a(this,"lastTime",0);a(this,"audioSource");a(this,"_audioLoader",null);a(this,"_playableDirectorResumed",!1)}getAudioFilePath(e){const i=this.director.sourceId;return rl(i,e)}onAllowAudioChanged(e){for(let i=0;i<this.models.length;i++){const n=this.models[i];this.audio[i].setVolume(e?n.asset.volume:0)}}addModel(e){const i=new QR(this.listener);this.audio.push(i);const n=e;n._didTriggerPlay=!1,this.models.push(n)}onDisable(){for(const e of this.audio)e.isPlaying&&e.stop();for(const e of this.models)e._didTriggerPlay=!1}onDestroy(){for(const e of this.audio)e.source&&(e==null||e.disconnect());this.audio.length=0}onMuteChanged(){if(this.muted)for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}}stop(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}for(const e of this.models)e._didTriggerPlay=!1}onPauseChanged(){for(let e=0;e<this.audio.length;e++){const i=this.audio[e];i!=null&&i.isPlaying&&i.stop()}this._playableDirectorResumed=this.director.isPlaying}evaluate(e){if(WD||this.track.muted||this.director.speed<0)return;const i=this.director.context.application.muted,n=this._playableDirectorResumed;this._playableDirectorResumed=!1;const o=i?.1:0;for(let r=0;r<this.models.length;r++){const l=this.models[r],c=this.audio[r],h=l.asset;if((!c||!c.buffer)&&this.isInTimeRange(l,e-1,e+1)&&this.handleAudioLoading(l,c),Oe.userInteractionRegistered!==!1&&!(c===null||!c.buffer))if(c.playbackRate=this.director.context.time.timeScale*this.director.speed,c.loop=h.loop,e>=l.start&&e<=l.end&&e<this.director.duration){if(!c.isPlaying||!this.director.isPlaying)(n||!l._didTriggerPlay&&this.lastTime<e)&&(l.duration*l.timeScale>.3?c.offset=l.clipIn+(e-l.start)*l.timeScale:c.offset=0,Ys&&console.log("Timeline Audio ("+this.track.name+") play with offset "+c.offset+" - "+l.asset.clip),c.play(o),l._didTriggerPlay=!0);else{const u=l.clipIn+(e-l.start)*l.timeScale,f=c.context.currentTime-c._startedAt+c.offset;Math.abs(u-f)>.3&&(c.offset=u,c.stop(),c.play(o))}let d=h.volume;if(this.track.volume!==void 0&&(d*=this.track.volume),i&&(d=0),l.easeInDuration>0){const u=Math.min((e-l.start)/l.easeInDuration,1);d*=u}if(l.easeOutDuration>0){const u=Math.min((l.end-e)/l.easeOutDuration,1);d*=u}c.setVolume(d*this.director.weight)}else l._didTriggerPlay=!1,this.director.isPlaying&&c.isPlaying&&c.stop()}this.lastTime=e}loadAudio(e,i=0,n=0){let o=null;const r=e-n,l=e+i;for(const c of this.models)if(this.isInTimeRange(c,r,l)){const h=this.audio[this.models.indexOf(c)],d=this.handleAudioLoading(c,h);d!==null&&(o===null&&(o=[]),o.push(d))}return o!==null?Promise.all(o):null}isInTimeRange(e,i,n){return i<=e.start&&n>=e.end||i>=e.start&&i<=e.end||n>=e.start&&n<=e.end}static dispose(){ac._audioBuffers.clear()}handleAudioLoading(e,i){this._audioLoader||(this._audioLoader=new ky);const n=this.getAudioFilePath(e.asset.clip);if(ac._audioBuffers.get(n)){const r=ac._audioBuffers.get(n);return r.then(l=>{l&&i.setBuffer(l)}),r}Ys&&console.warn("LOAD audio track",n,this.director.sourceId);const o=new Promise((r,l)=>{this._audioLoader.load(n,c=>{i.setBuffer(c),r(c)},void 0,c=>{console.error("Error loading audio",c),r(null)})});return ac._audioBuffers.set(n,o),o}};let yc=ac;a(yc,"_audioBuffers",new Map);class Pp extends Nm{constructor(){super(...arguments);a(this,"models",[]);a(this,"didTrigger",[]);a(this,"receivers",[])}evaluate(e){var n;if(this.track.muted)return;const i=this.director.context.time.deltaTime*1.5;for(let o=0;o<this.models.length;o++){const r=this.models[o],l=this.didTrigger[o],c=r.time-e;let h=!1;if(r.retroActive)h=c<=1e-6;else{const d=Math.abs(c);(d===0||d>=1e-5&&d<i)&&(h=!0)}if(h){if(!l)if(Ys&&console.log("Trigger signal",e,r.time,r),this.didTrigger[o]=!0,((n=this.receivers)==null?void 0:n.length)<=0)Wr.invoke(r.asset);else for(const d of this.receivers)d&&d.invoke(r.asset)}else r.emitOnce||(this.didTrigger[o]=!1)}}}class f0 extends Nm{constructor(){super(...arguments);a(this,"models",[]);a(this,"timelines",[]);a(this,"_previousActiveModel",null)}resolveSourceObjects(e){for(let i=this.models.length-1;i>=0;i--){const o=this.models[i].asset;if(!o.sourceObject||typeof o.sourceObject!="object"){console.log("no source object, removing model",i,o),this.models.splice(i,1);continue}else{const r=C.getComponent(o.sourceObject,us);this.timelines.push(r),r&&o.updateDirector&&(r.playOnAwake=!1)}}}evaluate(e){var i;this._previousActiveModel=null;for(let n=0;n<this.models.length;n++){const o=this.models[n],r=o.asset;if(e>=o.start&&e<=o.end){this._previousActiveModel=o;const l=this.getClipTime(e,o);if(r.controlActivation){const c=r.sourceObject;c.visible=!0}if(r.updateDirector){const c=this.timelines[n];c&&(c.isPlaying&&c.pause(),c.time=l,c.evaluate())}}else{const l=(i=this._previousActiveModel)==null?void 0:i.asset;if(r.controlActivation){const c=r.sourceObject;(l==null?void 0:l.sourceObject)!==c&&(c.visible=!1)}}}}}var mP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const wo=S("debugtimeline");var Yl;(function(s){s[s.Hold=0]="Hold",s[s.Loop=1]="Loop",s[s.None=2]="None"})(Yl||(Yl={}));var vw;(function(s){s[s.None=0]="None",s[s.Hold=1]="Hold",s[s.Loop=2]="Loop",s[s.PingPong=3]="PingPong",s[s.Continue=4]="Continue"})(vw||(vw={}));const Bp=class extends j{constructor(){super(...arguments);a(this,"playableAsset");a(this,"playOnAwake");a(this,"extrapolationMode",Yl.Loop);a(this,"waitForAudio",!0);a(this,"_visibilityChangeEvt");a(this,"_clonedPlayableAsset",!1);a(this,"_speed",1);a(this,"_guidsMap");a(this,"_isPlaying",!1);a(this,"_internalUpdateRoutine");a(this,"_isPaused",!1);a(this,"_isStopping",!1);a(this,"_time",0);a(this,"_duration",0);a(this,"_weight",1);a(this,"_animationTracks",[]);a(this,"_audioTracks",[]);a(this,"_signalTracks",[]);a(this,"_controlTracks",[]);a(this,"_customTracks",[]);a(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks]);a(this,"animationCallbackReceivers",[])}static registerCreateTrack(e,i){this.createTrackFunctions[e]=i}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(e){typeof e=="number"&&!Number.isNaN(e)?this._time=e:(wo||fs())&&console.error("INVALID TIMELINE.TIME VALUE",e,this.name)}get duration(){return this._duration}set duration(e){this._duration=e}get weight(){return this._weight}set weight(e){this._weight=e}get speed(){return this._speed}set speed(e){this._speed=e}awake(){var e,i,n,o,r;wo&&console.log(this,(e=this.playableAsset)==null?void 0:e.tracks),this.rebuildGraph(),!this.isValid()&&(wo||U())&&(wo?console.warn("PlayableDirector is not valid","Asset?",this.playableAsset,"Tracks:",(i=this.playableAsset)==null?void 0:i.tracks,"IsArray?",Array.isArray((n=this.playableAsset)==null?void 0:n.tracks),this):(r=(o=this.playableAsset)==null?void 0:o.tracks)!=null&&r.length?console.warn("PlayableDirector is not valid"):console.warn("PlayableDirector has no tracks"))}onEnable(){var e,i,n;for(const o of this._audioTracks)(e=o.onEnable)==null||e.call(o);for(const o of this._customTracks)(i=o.onEnable)==null||i.call(o);for(const o of this._animationTracks)(n=o.onEnable)==null||n.call(o);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var e,i,n;this.stop();for(const o of this._audioTracks)(e=o.onDisable)==null||e.call(o);for(const o of this._customTracks)(i=o.onDisable)==null||i.call(o);for(const o of this._animationTracks)(n=o.onDisable)==null||n.call(o);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var e;for(const i of this._allTracks)for(const n of i)(e=n.onDestroy)==null||e.call(n)}rebuildGraph(){this.isValid()&&(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}async play(){if(!this.isValid())return;const e=this._isPaused==!0;if(this._isPaused=!1,!this._isPlaying){if(this._isPlaying=!0,e&&this.invokePauseChangedMethodsOnTracks(),this.waitForAudio){const i=[];for(const n of this._audioTracks){const o=n.loadAudio(this._time,1,0);o&&i.push(o)}if(i.length>0&&(await Promise.all(i),!this._isPlaying))return;for(;this._audioTracks.length>0&&this._isPlaying&&!Oe.userInteractionRegistered&&this.waitForAudio;)await Ko(200)}this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate(),oe.LateUpdate)}}pause(){this.isValid()&&(this._isPlaying=!1,!this._isPaused&&(this._isPaused=!0,this.internalEvaluate(),this.invokePauseChangedMethodsOnTracks(),this.invokeStateChangedMethodsOnTracks()))}stop(){this._isStopping=!0;for(const n of this._audioTracks)n.stop();const e=this._isPaused==!0,i=this._isPlaying;this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.internalEvaluate(),e&&this.invokePauseChangedMethodsOnTracks()),this._isPlaying=!1,this._isPaused=!1,e&&!i&&this.invokePauseChangedMethodsOnTracks(),i&&this.invokeStateChangedMethodsOnTracks(),this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null,this._isStopping=!1}evaluate(){this.internalEvaluate(!0)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const e of this._allTracks)for(const i of e)yield i}get animationTracks(){return this._animationTracks}get audioTracks(){return this._audioTracks}resolveGuids(e){this._guidsMap=e}invokePauseChangedMethodsOnTracks(){var e;for(const i of this.forEachTrack())(e=i.onPauseChanged)==null||e.call(i)}invokeStateChangedMethodsOnTracks(){var e;for(const i of this.forEachTrack())(e=i.onStateChanged)==null||e.call(i,this._isPlaying)}*internalUpdate(){for(;this._isPlaying&&this.activeAndEnabled;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime*this.speed,this.internalEvaluate()),yield}internalEvaluate(e=!1){if(!this.isValid())return;let i=this._time;switch(this.extrapolationMode){case Yl.Hold:this._speed>0?i=Math.min(i,this._duration):this._speed<0&&(i=Math.max(i,0)),this._time=i;break;case Yl.Loop:i%=this._duration,this._time=i;break;case Yl.None:if(i>this._duration){this.stop();return}break}const n=this._time;for(const o of this.playableAsset.tracks)if(!o.muted)switch(o.type){case rn.Activation:if(!e&&!this._isPlaying)continue;for(let r=0;r<o.outputs.length;r++){const l=o.outputs[r];if(typeof l=="object"){let c=!1;if(o.clips)for(const d of o.clips)d.start<=n&&n<=d.end&&(c=!0);const h=l;h.visible!==void 0&&h.visible!==c&&(h.visible=c,wo&&console.warn(this.name,"set ActivationTrack-"+r,h.name,c,n))}}break}if(!this._isStopping)for(const o of this._animationTracks)o.evaluate(n);for(const o of this._audioTracks)o.evaluate(n);for(const o of this._signalTracks)o.evaluate(n);for(const o of this._controlTracks)o.evaluate(n);for(const o of this._customTracks)o.evaluate(n)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=Kp(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const e=this.findRoot(this.gameObject);for(const i of this.playableAsset.tracks){for(let n=i.outputs.length-1;n>=0;n--){let o=i.outputs[n];if(typeof o=="string"){this._guidsMap&&this._guidsMap[o]&&(o=this._guidsMap[o]);const r=C.findByGuid(o,e);r===null||typeof r!="object"?(i.outputs.splice(n,1),console.warn("Failed to resolve binding",o,i.name,i.type)):(wo&&console.log("Resolved binding",o,"to",r),i.outputs[n]=r)}else if(o===null){if(i.outputs.splice(n,1),Bp.createTrackFunctions[i.type])continue;i.type!==rn.Audio&&i.type!==rn.Control&&i.type!==rn.Marker&&i.type!==rn.Signal&&console.warn("Missing binding",o,i.name,i.type,this.name,this.playableAsset.name)}}if(i.type===rn.Control&&i.clips)for(let n=0;n<i.clips.length;n++){const o=i.clips[n];let r=o.asset.sourceObject;if(typeof r=="string"){this._guidsMap&&this._guidsMap[r]&&(r=this._guidsMap[r]);const l=C.findByGuid(r,e);l===null||typeof l!="object"?console.warn("Failed to resolve sourceObject binding",r,i.name,o):(wo&&console.log("Resolved binding",r,"to",l),o.asset.sourceObject=l)}}}}findRoot(e){return e.parent?this.findRoot(e.parent):e}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const e of this.playableAsset.tracks)if(e.muted!==!0){if(e.clips)for(const i of e.clips)i.end>this._duration&&(this._duration=i.end);if(e.markers)for(const i of e.markers)i.time>this._duration&&(this._duration=i.time+.001)}}}setupAndCreateTrackHandlers(){var i,n,o;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;let e=C.findObjectOfType(Mr,this.context);for(const r of this.playableAsset.tracks){const l=r.type,c=Bp.createTrackFunctions[l];if(c!=null){const h=c(this,r);if(typeof h.evaluate=="function"){h.director=this,h.track=r,this._customTracks.push(h);continue}}if(r.type===rn.Animation){if(!r.clips||r.clips.length<=0){wo&&console.warn("Animation track has no clips",r);continue}for(let h=r.outputs.length-1;h>=0;h--){let d=r.outputs[h];if(d instanceof D){const f=C.getOrAddComponent(d,ii);f&&(d=f)}const u=(i=d==null?void 0:d.gameObject)==null?void 0:i.animations;if(u){const f=new u0;f.trackOffset=r.trackOffset,f.director=this,f.track=r;for(let p=0;p<r.clips.length;p++){const g=r.clips[p],_=g.asset;if(!_){console.error(`Timeline ${this.name}: clip #${p} on track "${r.name}" has no animation data`);continue}const y=_.clip;let b=y;if((typeof b=="string"||typeof b=="number")&&(b=u.find(w=>w.name===y)),wo&&console.log(_,y,"â†’",b),!b){console.warn("Could not find animationClip for model",g,r.name,this.name,(n=this.playableAsset)==null?void 0:n.name,u,d);continue}d instanceof ii&&d.runtimeAnimatorController&&(d.__internalDidAwakeAndStart||d.initializeRuntimeAnimatorController(),d.runtimeAnimatorController.mixer||d.runtimeAnimatorController.bind(d),f.mixer=d.runtimeAnimatorController.mixer),f.mixer||(f.mixer=new J_(d.gameObject),this.context.animations.registerAnimationMixer(f.mixer)),f.clips.push(b),f.mixer.uncacheAction(b),f.createHooks(g.asset,b);const v=f.mixer.clipAction(b);f.actions.push(v),f.models.push(g)}this._animationTracks.push(f)}}}else if(r.type===rn.Audio){if(!r.clips||r.clips.length<=0)continue;const h=new yc;h.director=this,h.track=r,h.audioSource=r.outputs.find(d=>d instanceof Oe),this._audioTracks.push(h),e||(e=(o=this.context.mainCameraComponent)==null?void 0:o.gameObject.addComponent(Mr)),h.listener=e.listener;for(let d=0;d<r.clips.length;d++){const u=r.clips[d];h.addModel(u)}}else if(r.type===rn.Marker){const h=new Pp;if(h.director=this,h.track=r,r.markers)for(const d of r.markers)switch(d.type){case $_.Signal:h.models.push(d),h.didTrigger.push(!1);break}if(h!==null&&h.models.length>0){const d=C.getComponent(this.gameObject,Wr);d&&(h.receivers.push(d),this._signalTracks.push(h))}}else if(r.type===rn.Signal){const h=new Pp;if(h.director=this,h.track=r,r.markers)for(const d of r.markers)h.models.push(d),h.didTrigger.push(!1);for(const d of r.outputs)h.receivers.push(d);this._signalTracks.push(h)}else if(r.type===rn.Control){const h=new f0;if(h.director=this,h.track=r,r.clips)for(const d of r.clips)h.models.push(d);h.resolveSourceObjects(this.context),this._controlTracks.push(h)}}}setAudioTracksAllowPlaying(e){for(const i of this._audioTracks)i.onAllowAudioChanged(e)}registerAnimationCallback(e){this.animationCallbackReceivers.push(e)}unregisterAnimationCallback(e){const i=this.animationCallbackReceivers.indexOf(e);i!==-1&&this.animationCallbackReceivers.splice(i,1)}};let us=Bp;a(us,"createTrackFunctions",{});mP([m()],us.prototype,"playOnAwake",void 0);mP([m()],us.prototype,"extrapolationMode",void 0);var $m=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ih extends j{constructor(){super(...arguments);a(this,"isGizmo",!1);a(this,"translationSnap",1);a(this,"rotationSnapAngle",15);a(this,"scaleSnap",.25);a(this,"_control");a(this,"orbit");a(this,"onControlChangedEvent",e=>{const i=this.orbit;if(i&&(i.enabled=!e.value),e.value){const n=this.gameObject.getComponentInParent(oo);n&&(n.fastMode=!0,n.requestOwnership())}else{const n=this.gameObject.getComponentInParent(oo);n&&(n.fastMode=!1)}});a(this,"windowKeyDownListener",e=>{if(this.enabled&&this._control)switch(e.keyCode){case 81:this._control.setSpace(this._control.space==="local"?"world":"local");break;case 16:this.enableSnapping();break;case 87:this._control.setMode("translate");break;case 69:this._control.setMode("rotate");break;case 82:this._control.setMode("scale");break;case 187:case 107:this._control.setSize(this._control.size+.1);break;case 189:case 109:this._control.setSize(Math.max(this._control.size-.1,.1));break;case 88:this._control.showX=!this._control.showX;break;case 89:this._control.showY=!this._control.showY;break;case 90:this._control.showZ=!this._control.showZ;break;case 32:this._control.enabled=!this._control.enabled;break}});a(this,"windowKeyUpListener",e=>{if(this.enabled)switch(e.keyCode){case 16:this.disableSnapping();break}})}get control(){return this._control}onEnable(){var e;if(!(this.isGizmo&&!iu)&&this.context.mainCamera&&(this._control||(this._control=new gT(this.context.mainCamera,this.context.renderer.domElement),this._control.enabled=!0,this._control.getRaycaster().layers.set(2),this._control.size=1,("_root"in this._control?this._control._root:this._control).traverse(n=>{const o=n;if(o.layers.set(2),o){const r=o.material;r&&(r.opacity=.3)}}),this.orbit=C.getComponentInParent(this.context.mainCamera,Ee)??void 0),this._control)){const i=this._control.getHelper();this.context.scene.add(i),this._control.attach(this.gameObject),(e=this._control)==null||e.addEventListener("dragging-changed",this.onControlChangedEvent),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener)}}onDisable(){var e,i,n;(i=(e=this._control)==null?void 0:e.getHelper())==null||i.removeFromParent(),(n=this._control)==null||n.removeEventListener("dragging-changed",this.onControlChangedEvent),window.removeEventListener("keydown",this.windowKeyDownListener),window.removeEventListener("keyup",this.windowKeyUpListener)}enableSnapping(){this._control&&(this._control.setTranslationSnap(this.translationSnap),this._control.setRotationSnap(Fo.degToRad(this.rotationSnapAngle)),this._control.setScaleSnap(this.scaleSnap))}disableSnapping(){this._control&&(this._control.setTranslationSnap(null),this._control.setRotationSnap(null),this._control.setScaleSnap(null))}}$m([m()],ih.prototype,"isGizmo",void 0);$m([m()],ih.prototype,"translationSnap",void 0);$m([m()],ih.prototype,"rotationSnapAngle",void 0);$m([m()],ih.prototype,"scaleSnap",void 0);var Wm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class p0{constructor(){a(this,"texture",null);a(this,"rect")}}Wm([m(Ke)],p0.prototype,"texture",void 0);let Pu=class extends Tm{constructor(){super(...arguments);a(this,"_sprite");a(this,"pixelsPerUnitMultiplier",1)}set image(e){this.sprite||(this.sprite=new p0),this.sprite.texture=e,this.onAfterCreated()}get image(){return this.sprite?this.sprite.texture:null}get sprite(){return this._sprite}set sprite(e){this._sprite!==e&&(this._sprite=e,this.onAfterCreated())}isBuiltinSprite(){var i,n,o,r,l,c,h;const e=this.sprite;switch((i=e==null?void 0:e.texture)==null?void 0:i.name){case"InputFieldBackground":case"UISprite":case"Background":case"Knob":return!0}return!((o=(n=e==null?void 0:e.texture)==null?void 0:n.name)!=null&&o.length)&&((l=(r=e==null?void 0:e.texture)==null?void 0:r.image)==null?void 0:l.width)===32&&((h=(c=e==null?void 0:e.texture)==null?void 0:c.image)==null?void 0:h.height)===32}onBeforeCreate(e){var i,n;super.onBeforeCreate(e),this.isBuiltinSprite()&&(e.borderRadius=5/this.pixelsPerUnitMultiplier,((n=(i=this.sprite)==null?void 0:i.texture)==null?void 0:n.name)==="Knob"&&(e.borderRadius=999))}onAfterCreated(){var e;this.__didAwake&&(super.onAfterCreated(),!this.isBuiltinSprite()&&this.setTexture((e=this.sprite)==null?void 0:e.texture))}};Wm([m(p0)],Pu.prototype,"sprite",null);Wm([m()],Pu.prototype,"pixelsPerUnitMultiplier",void 0);class m0 extends Tm{constructor(){super(...arguments);a(this,"_mainTexture")}get mainTexture(){return this._mainTexture}set mainTexture(e){this._mainTexture!==e&&(this._mainTexture=e,this.onAfterCreated())}onAfterCreated(){this.__didAwake&&(super.onAfterCreated(),this.setTexture(this.mainTexture))}}Wm([m(Ke)],m0.prototype,"mainTexture",null);var Tn=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const wa=S("debugbutton");var As;(function(s){s[s.None=0]="None",s[s.ColorTint=1]="ColorTint",s[s.SpriteSwap=2]="SpriteSwap",s[s.Animation=3]="Animation"})(As||(As={}));class la{constructor(){a(this,"colorMultiplier");a(this,"disabledColor");a(this,"fadeDuration");a(this,"highlightedColor");a(this,"normalColor");a(this,"pressedColor");a(this,"selectedColor")}}Tn([m()],la.prototype,"colorMultiplier",void 0);Tn([m(pe)],la.prototype,"disabledColor",void 0);Tn([m()],la.prototype,"fadeDuration",void 0);Tn([m(pe)],la.prototype,"highlightedColor",void 0);Tn([m(pe)],la.prototype,"normalColor",void 0);Tn([m(pe)],la.prototype,"pressedColor",void 0);Tn([m(pe)],la.prototype,"selectedColor",void 0);class VD{constructor(){a(this,"disabledTrigger");a(this,"highlightedTrigger");a(this,"normalTrigger");a(this,"pressedTrigger");a(this,"selectedTrigger")}}class ca extends j{constructor(){super(...arguments);a(this,"onClick",new we);a(this,"_isHovered",0);a(this,"colors");a(this,"transition");a(this,"animationTriggers");a(this,"animator");a(this,"_interactable",!0);a(this,"_requestedAnimatorTrigger");a(this,"_isInit",!1);a(this,"_image")}click(){var e;(e=this.onClick)==null||e.invoke()}onPointerEnter(e){var n,o;const i=e.event.pointerType==="mouse"&&e.button===0;i&&(this._isHovered+=1),wa&&console.warn("Button Enter",i,this._isHovered,(n=this.animationTriggers)==null?void 0:n.highlightedTrigger,this.animator),this.interactable&&(this.transition==As.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.highlightedTrigger):this.transition===As.ColorTint&&this.colors&&((o=this._image)==null||o.setState("hovered")),i&&this.context.input.setCursor("pointer"))}onPointerExit(){var e,i;this._isHovered-=1,this._isHovered<0&&(this._isHovered=0),wa&&console.log("Button Exit",this._isHovered,(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this.interactable&&(this._isHovered>0||(this._isHovered=0,this.transition==As.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.normalTrigger):this.transition===As.ColorTint&&this.colors&&((i=this._image)==null||i.setState("normal")),this.context.input.unsetCursor("pointer")))}onPointerDown(e){var i,n;wa&&console.log("Button Down",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator),this.interactable&&(this.transition==As.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this.animationTriggers.pressedTrigger):this.transition===As.ColorTint&&this.colors&&((n=this._image)==null||n.setState("pressed")))}onPointerUp(e){var i,n;wa&&console.warn("Button Up",(i=this.animationTriggers)==null?void 0:i.highlightedTrigger,this.animator,this._isHovered),this.interactable&&(this.transition==As.Animation&&this.animationTriggers&&this.animator?this.animator.setTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger):this.transition===As.ColorTint&&this.colors&&((n=this._image)==null||n.setState(this._isHovered?"hovered":"normal")))}onPointerClick(e){if(this.interactable&&!(e.button!==0&&e.event.pointerType===kr.Mouse)&&(wa&&(console.warn("Button Click",this.onClick),nt("CLICKED button "+this.name+" at "+this.context.time.frameCount)),this.onClick&&this.onClick.listenerCount>0&&(this.onClick.invoke(),e.use(),wa))){const i=this.gameObject.worldPosition;i.add(this.gameObject.worldUp.multiplyScalar(1+Math.random()*.5)),G.DrawLabel(i,"CLICK:"+Date.now(),.1,1+Math.random()*.5)}}set interactable(e){this._interactable=e,this._image&&(this._image.setInteractable(e),e?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(e){this.interactable=e}awake(){super.awake(),wa&&console.log(this),this._isInit=!1,this.init()}start(){var e;(e=this._image)==null||e.setInteractable(this.interactable),this.gameObject.getComponentInParent(Ic)||this.gameObject.addComponent(Db)}onEnable(){super.onEnable()}onDestroy(){this._isHovered&&this.context.input.unsetCursor("pointer")}*setAnimatorTriggerAtEndOfFrame(e){var i;this._requestedAnimatorTrigger=e,yield,yield,this._requestedAnimatorTrigger==e&&((i=this.animator)==null||i.setTrigger(e))}init(){this._isInit||(this._isInit=!0,this._image=C.getComponent(this.gameObject,Pu),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(e){var p,g,_,y,b;e.setInteractable(this.interactable);const i=this.getFinalColor(e.color,(p=this.colors)==null?void 0:p.normalColor),n={state:"normal",attributes:{backgroundColor:i,backgroundOpacity:i.alpha}};e.setupState(n);const o=this.getFinalColor(e.color,(g=this.colors)==null?void 0:g.highlightedColor),r={state:"hovered",attributes:{backgroundColor:o,backgroundOpacity:o.alpha}};e.setupState(r);const l=this.getFinalColor(e.color,(_=this.colors)==null?void 0:_.pressedColor),c={state:"pressed",attributes:{backgroundColor:l,backgroundOpacity:l.alpha}};e.setupState(c);const h=this.getFinalColor(e.color,(y=this.colors)==null?void 0:y.selectedColor),d={state:"selected",attributes:{backgroundColor:h,backgroundOpacity:h.alpha}};e.setupState(d);const u=this.getFinalColor(e.color,(b=this.colors)==null?void 0:b.disabledColor),f={state:"disabled",attributes:{backgroundColor:u,backgroundOpacity:u.alpha}};e.setupState(f)}getFinalColor(e,i){return i?e.clone().multiply(i).convertLinearToSRGB():e.clone().convertLinearToSRGB()}}Tn([m(we)],ca.prototype,"onClick",void 0);Tn([m(la)],ca.prototype,"colors",void 0);Tn([m()],ca.prototype,"transition",void 0);Tn([m(VD)],ca.prototype,"animationTriggers",void 0);Tn([m(ii)],ca.prototype,"animator",void 0);Tn([m()],ca.prototype,"interactable",null);var Vm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const mr=S("debuginputfield"),ee=class extends j{constructor(){super(...arguments);a(this,"textComponent");a(this,"placeholder");a(this,"onValueChanged");a(this,"onEndEdit");a(this,"inputEventFn");a(this,"_iosEventFn")}get text(){var e;return((e=this.textComponent)==null?void 0:e.text)??""}set text(e){this.textComponent&&(this.textComponent.text=e,this.placeholder&&(e.length>0?this.placeholder.gameObject.visible=!1:this.placeholder.gameObject.visible=!0))}get isFocused(){return ee.active===this}start(){mr&&console.log(this.name,this)}onEnable(){var e;ee.htmlField||(ee.htmlField=document.createElement("input"),ee.htmlField.style.width="0px",ee.htmlField.style.height="0px",ee.htmlField.style.padding="0px",ee.htmlField.style.border="none",ee.htmlField.style.overflow="hidden",ee.htmlField.style.caretColor="transparent",ee.htmlField.style.outline="none",ee.htmlField.classList.add("ar"),ee.htmlField.onfocus=()=>ee.htmlFieldFocused=!0,ee.htmlField.onblur=()=>ee.htmlFieldFocused=!1,document.body.append(ee.htmlField)),this.inputEventFn||(this.inputEventFn=this.onInput.bind(this)),ee.htmlField.addEventListener("keyup",this.inputEventFn),this.placeholder&&((e=this.textComponent)!=null&&e.text.length)&&C.setActive(this.placeholder.gameObject,!1),K.isiOS()&&(this._iosEventFn=this.processInputOniOS.bind(this),window.addEventListener("click",this._iosEventFn))}onDisable(){var e;(e=ee.htmlField)==null||e.removeEventListener("keyup",this.inputEventFn),this.onDeselected(),this._iosEventFn&&window.removeEventListener("click",this._iosEventFn)}clear(){ee.active===this&&ee.htmlField?(ee.htmlField.value="",this.setTextFromInputField()):(this.textComponent&&(this.textComponent.text=""),this.placeholder&&C.setActive(this.placeholder.gameObject,!0))}select(){this.onSelected()}deselect(){this.onDeselected()}onPointerEnter(e){e.event.pointerType==="mouse"&&e.button===0&&this.context.input.setCursor("text")}onPointerExit(e){this.context.input.unsetCursor("text")}onPointerClick(e){mr&&console.log("CLICK",e,ee.active),ee.activeTime=this.context.time.time,ee.active!==this&&this.startCoroutine(this.activeLoop(),oe.LateUpdate),this.selectInputField()}*activeLoop(){for(this.onSelected();ee.active===this&&!(this.context.input.getPointerClicked(0)&&this.context.time.time-ee.activeTime>.2);)this.setTextFromInputField(),yield;this.onDeselected()}onSelected(){var e,i,n,o;if(ee.active!==this&&(mr&&console.log("Select",this.name,this,ee.htmlField,this.context.isInXR,this.context.arOverlayElement,(e=this.textComponent)==null?void 0:e.text,(i=ee.htmlField)==null?void 0:i.value),(n=ee.active)==null||n.onDeselected(),ee.active=this,this.placeholder&&C.setActive(this.placeholder.gameObject,!1),ee.htmlField)){if(ee.htmlField.value=((o=this.textComponent)==null?void 0:o.text)||"",mr&&console.log("set input field value",ee.htmlField.value),this.context.isInXR){const r=this.context.arOverlayElement;r&&r.append(ee.htmlField)}this.selectInputField()}}onDeselected(){var e;ee.active===this&&(ee.active=null,mr&&console.log("Deselect",this.name,this),ee.htmlField&&(ee.htmlField.blur(),document.body.append(ee.htmlField)),this.placeholder&&(!this.textComponent||this.textComponent.text.length<=0)&&C.setActive(this.placeholder.gameObject,!0),ee.htmlField&&((e=this.onEndEdit)==null||e.invoke(ee.htmlField.value)))}update(){var e;ee.active===this&&((e=this.textComponent)==null||e.markDirty())}onInput(e){var i,n;if(ee.active===this){if(mr&&console.log(e.code,e,(i=ee.htmlField)==null?void 0:i.value,(n=this.textComponent)==null?void 0:n.text),e.code==="Escape"||e.code==="Enter"){this.onDeselected();return}ee.htmlField&&(this.textComponent&&(this.setTextFromInputField(),this.placeholder&&C.setActive(this.placeholder.gameObject,this.textComponent.text.length<=0)),this.selectInputField())}}setTextFromInputField(){var e;if(this.textComponent&&ee.htmlField){const i=this.textComponent.text,n=ee.htmlField.value,o=this.textComponent.text!==ee.htmlField.value;this.textComponent.text=ee.htmlField.value,o&&(mr&&console.log("[InputField] value changed:",n,i),(e=this.onValueChanged)==null||e.invoke(n,i))}}selectInputField(){ee.htmlField&&(mr&&console.log("Focus Inputfield",ee.htmlFieldFocused),ee.htmlField.setSelectionRange(ee.htmlField.value.length,ee.htmlField.value.length),K.isiOS()?ee.htmlField.focus({preventScroll:!0}):setTimeout(()=>{var e;return(e=ee.htmlField)==null?void 0:e.focus()},1))}processInputOniOS(){const e=this.context.physics.raycast();if(!e.length)return;const n=e[0].object,o=Lb(n);((o==null?void 0:o.gameObject)===this.gameObject||(o==null?void 0:o.gameObject.parent)===this.gameObject)&&this.selectInputField()}};let jn=ee;a(jn,"active",null),a(jn,"activeTime",-1),a(jn,"htmlField",null),a(jn,"htmlFieldFocused",!1);Vm([m(ji)],jn.prototype,"textComponent",void 0);Vm([m(ji)],jn.prototype,"placeholder",void 0);Vm([m(we)],jn.prototype,"onValueChanged",void 0);Vm([m(we)],jn.prototype,"onEndEdit",void 0);var gP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class Hm extends j{constructor(){super(...arguments);a(this,"id",null);a(this,"keepAspect",!1);a(this,"_object",null)}onEnable(){if(this._object){this.gameObject.add(this._object);return}if(!this.id||!this.context.mainCamera)return;const e=document.getElementById(this.id);if(!e){console.warn('Could not find element with id "'+this.id+'"');return}e.style.display="block",e.style.visibility="hidden";const i=new yT;i.listenToPointerEvents(this.context.renderer,this.context.mainCamera),this.gameObject.add(i);const n=new _T(e);i.add(n),n.visible=!1;const o=n.material;o.transparent=!0,setTimeout(()=>{n.visible=!0;const r=lb(this.gameObject).clone();em(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const l=new Nn;l.setFromObject(i),this.setWorldRotation(r.x,r.y,r.z);const c=l.max.x-l.min.x,h=l.max.y-l.min.y;if(this.keepAspect){const u=c/h;c>h?n.scale.set(1/c,1/h/u,1):n.scale.set(1/c*u,1/h,1)}else n.scale.set(1/c,1/h,1);const d=this.gameObject.scale;n.scale.multiply(d)},1)}onDisable(){var e;(e=this._object)==null||e.removeFromParent()}}gP([m()],Hm.prototype,"id",void 0);gP([m()],Hm.prototype,"keepAspect",void 0);/* @license
 * Copyright 2021 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const HD={topLight:{intensity:500,position:[.418,16.199,.3]},room:{position:[-.757,13.219,.717],scale:[31.713,28.305,28.591]},boxes:[{position:[-10.906,2.009,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,.857,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:50,position:[-16.116,14.37,8.208],scale:[.1,2.428,2.739]},{intensity:50,position:[-16.109,18.021,-8.207],scale:[.1,2.425,2.751]},{intensity:17,position:[14.904,12.198,-1.832],scale:[.15,4.265,6.331]},{intensity:43,position:[-.462,8.89,14.52],scale:[4.38,5.441,.088]},{intensity:20,position:[3.235,11.486,-12.541],scale:[2.5,2,.1]},{intensity:100,position:[0,20,0],scale:[1,.1,1]}]},GD={topLight:{intensity:400,position:[.5,14,.5]},room:{position:[0,13.2,0],scale:[31.5,28.5,31.5]},boxes:[{position:[-10.906,-1,1.846],rotation:-.195,scale:[2.328,7.905,4.651]},{position:[-5.607,-.754,-.758],rotation:.994,scale:[1.97,1.534,3.955]},{position:[6.167,-.16,7.803],rotation:.561,scale:[3.927,6.285,3.687]},{position:[-2.017,.018,6.124],rotation:.333,scale:[2.002,4.566,2.064]},{position:[2.291,-.756,-2.621],rotation:-.286,scale:[1.546,1.552,1.496]},{position:[-2.193,-.369,-5.547],rotation:.516,scale:[3.875,3.487,2.986]}],lights:[{intensity:80,position:[-14,10,8],scale:[.1,2.5,2.5]},{intensity:80,position:[-14,14,-4],scale:[.1,2.5,2.5]},{intensity:23,position:[14,12,0],scale:[.1,5,5]},{intensity:16,position:[0,9,14],scale:[5,5,.1]},{intensity:80,position:[7,8,-14],scale:[2.5,2.5,.1]},{intensity:80,position:[-7,16,-14],scale:[2.5,2.5,.1]},{intensity:1,position:[0,20,0],scale:[.1,.1,.1]}]};class g0 extends bn{constructor(t){super(),this.position.y=-3.5;const e=new bc;e.deleteAttribute("uv");const i=new It({metalness:0,side:Qp}),n=new It({metalness:0}),o=t=="legacy"?HD:GD,r=new X_(16777215,o.topLight.intensity,28,2);r.position.set(...o.topLight.position),this.add(r);const l=new X(e,i);l.position.set(...o.room.position),l.scale.set(...o.room.scale),this.add(l);for(const c of o.boxes){const h=new X(e,n);h.position.set(...c.position),h.rotation.set(0,c.rotation,0),h.scale.set(...c.scale),this.add(h)}for(const c of o.lights){const h=new X(e,this.createAreaLightMaterial(c.intensity));h.position.set(...c.position),h.scale.set(...c.scale),this.add(h)}}createAreaLightMaterial(t){const e=new Be;return e.color.setScalar(t),e}}var Gm=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const I0=class extends j{constructor(){super(...arguments);a(this,"target");a(this,"invertForward",!1);a(this,"keepUpDirection",!0);a(this,"copyTargetRotation",!1)}onBeforeRender(){let e=this.target;if(e||(e=this.context.mainCamera),!e)return;let i=this.copyTargetRotation;(this.context.isInVR||this.context.isInPassThrough)&&(i=!1),Zp(this.gameObject,e,this.keepUpDirection,i),this.invertForward&&this.gameObject.quaternion.multiply(I0.flipYQuat)}createBehaviours(e,i,n){if(i.uuid===this.gameObject.uuid){let o=i;if(this.keepUpDirection){const l=gi.createEmptyParent(i);o=l;const c=this.invertForward?-1:1;l.setMatrix(l.getMatrix().multiply(new ce().makeRotationZ(Math.PI/2*c))),i.setMatrix(i.getMatrix().multiply(new ce().makeRotationZ(-Math.PI/2*c)))}const r=new ti("lookat "+this.name,_i.sceneStartTrigger(),Te.lookAtCameraAction(o,void 0,this.invertForward?zn.back:zn.forward,this.keepUpDirection?zn.up:zn.zero));e.addBehavior(r)}}};let qo=I0;a(qo,"flipYQuat",new H().setFromAxisAngle(new x(0,1,0),Math.PI));Gm([m(D)],qo.prototype,"target",void 0);Gm([m()],qo.prototype,"invertForward",void 0);Gm([m()],qo.prototype,"keepUpDirection",void 0);Gm([m()],qo.prototype,"copyTargetRotation",void 0);var y0=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o},Kl;(function(s){s[s.NewTab=0]="NewTab",s[s.SameTab=1]="SameTab",s[s.NewWindow=2]="NewWindow"})(Kl||(Kl={}));class Ru extends j{constructor(){super(...arguments);a(this,"url");a(this,"mode",Kl.NewTab);a(this,"clickable",!0)}async open(){if(!this.url){console.warn("OpenURL: URL is not set, can't open.",this);return}this._validateUrl();let e=this.url;switch(!e.startsWith("mailto:")&&e.includes("@")&&(e="mailto:"+e),U()&&nt("Open URL: "+e),this.mode){case Kl.NewTab:K.isSafari(),globalThis.open(e,"_blank");break;case Kl.SameTab:K.isSafari()&&K.isiOS()?globalThis.open(e,"_top"):globalThis.open(e,"_self");break;case Kl.NewWindow:K.isSafari()?globalThis.open(e,"_top"):globalThis.open(e,"_new");break}}start(){this.gameObject.getComponentInParent(Vn)||this.gameObject.addComponent(Vn)}onPointerEnter(e){!e.used&&this.clickable&&this.context.input.setCursor("pointer")}onPointerExit(){this.clickable&&this.context.input.unsetCursor("pointer")}onPointerClick(e){var i;this.clickable&&!e.used&&((i=this.url)!=null&&i.length)&&this.open()}_validateUrl(){this.url&&this.url.startsWith("www.")&&(U()&&console.warn("URL is not valid, adding https:// to the start of the URL",this.url),this.url="https://"+this.url)}}y0([m()],Ru.prototype,"url",void 0);y0([m()],Ru.prototype,"mode",void 0);y0([m()],Ru.prototype,"clickable",void 0);um(s=>{const t=s.domElement.getAttribute("clickthrough");t!==null&&t!=="0"&&t!=="false"&&s.scene.addComponent(_0)});class _0 extends j{constructor(){super(...arguments);a(this,"_previousPointerEvents","all");a(this,"onPointerEvent",e=>{if(e.pointerId>0)return;const i=e.intersections;(i==null?void 0:i.length)<=0?this.context.domElement.style.pointerEvents="none":this.context.domElement.style.pointerEvents="all"});a(this,"onTouchEnd",e=>{setTimeout(()=>{this.context.domElement.style.pointerEvents="all"},100)})}onEnable(){this.context.input.addEventListener("pointerdown",this.onPointerEvent),this.context.input.addEventListener("pointermove",this.onPointerEvent,{queue:100}),window.addEventListener("touchend",this.onTouchEnd,{passive:!0}),this._previousPointerEvents=this.context.domElement.style.pointerEvents}onDisable(){this.context.input.removeEventListener("pointerdown",this.onPointerEvent),this.context.input.removeEventListener("pointermove",this.onPointerEvent),window.removeEventListener("touchend",this.onTouchEnd),this.context.domElement.style.pointerEvents=this._previousPointerEvents}onPointerEnter(){}}var yP=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class qm extends j{constructor(){super(...arguments);a(this,"damping",0);a(this,"keepDistance",!0);a(this,"_distance",-1)}awake(){this._distance=-1}updateDistance(){this.keepDistance&&this._distance!==-1||(this._distance=this.gameObject.worldPosition.distanceTo(this.context.mainCamera.worldPosition))}update(){this.updateDistance();const e=this.context.input.mousePositionRC,i=this.context.mainCamera,n=i.worldPosition,o=q(e.x,e.y,1).unproject(i);o.sub(n).normalize();const r=o.multiplyScalar(this._distance).add(n);if(this.damping>0){const l=this.gameObject.worldPosition;l.lerp(r,this.context.time.deltaTime/this.damping),this.gameObject.worldPosition=l}else this.gameObject.worldPosition=r}}yP([m()],qm.prototype,"damping",void 0);yP([m()],qm.prototype,"keepDistance",void 0);var nh=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class gs extends j{constructor(){super(...arguments);a(this,"target",null);a(this,"damping",0);a(this,"invert",!1);a(this,"htmlSelector",null);a(this,"mode","window");a(this,"changed",new we);a(this,"current_value",0);a(this,"target_value",0);a(this,"applied_value",-1);a(this,"_lastSelectorValue",null);a(this,"_lastSelectorElement",null);a(this,"updateCurrentScrollValue",()=>{var e;switch(this.mode){case"window":if((e=this.htmlSelector)!=null&&e.length){if(this.htmlSelector!==this._lastSelectorValue&&(this._lastSelectorElement=document.querySelector(this.htmlSelector),this._lastSelectorValue=this.htmlSelector),this._lastSelectorElement){const i=this._lastSelectorElement.getBoundingClientRect();this.target_value=-i.top/(i.height-window.innerHeight),(isNaN(this.target_value)||!isFinite(this.target_value))&&(this.target_value=0);break}}else this.target_value=window.scrollY/(document.body.scrollHeight-window.innerHeight);(isNaN(this.target_value)||!isFinite(this.target_value))&&(this.target_value=0);break}})}get currentValue(){return this.current_value}onEnable(){window.addEventListener("wheel",this.updateCurrentScrollValue,{passive:!0}),this.applied_value=-1}onDisable(){window.removeEventListener("wheel",this.updateCurrentScrollValue)}lateUpdate(){if(this.updateCurrentScrollValue(),this.damping>0?this.current_value=N.lerp(this.current_value,this.target_value,this.context.time.deltaTime/this.damping):this.current_value=this.target_value,this.current_value!==this.applied_value){this.applied_value=this.current_value;let e=!1;if(this.changed.listenerCount>0){const i={type:"change",value:this.current_value,component:this,preventDefault:()=>{i.defaultPrevented=!0},defaultPrevented:!1};this.changed.invoke(i),e=i.defaultPrevented}if(!e){const i=this.invert?1-this.current_value:this.current_value;Array.isArray(this.target)?this.target.forEach(n=>n&&gs.applyScroll(n,i)):this.target&&gs.applyScroll(this.target,i)}}}static applyScroll(e,i){if(e)if(e instanceof us)e.time=i*e.duration,e.isPlaying||e.evaluate();else if(e instanceof ii)e.setFloat("scroll",i);else if(e instanceof Yi)e.time=i*e.duration;else if(e instanceof Oe){if(!e.duration)return;e.time=i*e.duration}else if(e instanceof mo)e.position01=i;else if(e instanceof Ji)e.intensity=i;else if(e instanceof D){e["needle:scrollbounds"]===void 0&&(e["needle:scrollbounds"]=Qi(e)||null);const n=e["needle:scrollbounds"];n&&(e.position.y=-n.min.y-i*(n.max.y-n.min.y))}else"scroll"in e&&(typeof e.scroll=="number"?e.scroll=i:typeof e.scroll=="function"&&e.scroll(i))}}nh([m([j,D])],gs.prototype,"target",void 0);nh([m()],gs.prototype,"damping",void 0);nh([m()],gs.prototype,"invert",void 0);nh([m()],gs.prototype,"htmlSelector",void 0);nh([m()],gs.prototype,"mode",void 0);nh([m(we)],gs.prototype,"changed",void 0);var sh=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};class ha extends j{constructor(){super(...arguments);a(this,"side","none");a(this,"controller",!0);a(this,"hands",!1);a(this,"controlVisibility",!0);a(this,"useGripSpace",!1);a(this,"resetTransformAfterXRSession",!0);a(this,"_startPosition",new x);a(this,"_startRotation",new H);a(this,"_startScale",new x)}get activeAndEnabled(){return!0}onEnterXR(e){this._startPosition.copy(this.gameObject.position),this._startRotation.copy(this.gameObject.quaternion),this._startScale.copy(this.gameObject.scale)}onUpdateXR(e){if(!this.enabled)return;const i=e.xr.getController(this.side);if(i){if(i.hand&&!this.hands){this.controlVisibility&&(this.gameObject.visible=!1);return}else if(!this.controller){this.controlVisibility&&(this.gameObject.visible=!1);return}this.controlVisibility&&(this.gameObject.visible=!0),this.useGripSpace||i.targetRayMode==="transient-pointer"?(this.gameObject.worldPosition=i.gripWorldPosition,this.gameObject.worldQuaternion=i.gripWorldQuaternion,this.gameObject.worldScale=q(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale)):(this.gameObject.worldPosition=i.rayWorldPosition,this.gameObject.worldQuaternion=i.rayWorldQuaternion,this.gameObject.worldScale=q(i.xr.rigScale,i.xr.rigScale,i.xr.rigScale).multiply(this._startScale))}}onLeaveXR(e){this.resetTransformAfterXRSession&&(this.gameObject.position.copy(this._startPosition),this.gameObject.quaternion.copy(this._startRotation),this.gameObject.scale.copy(this._startScale))}}sh([m()],ha.prototype,"side",void 0);sh([m()],ha.prototype,"controller",void 0);sh([m()],ha.prototype,"hands",void 0);sh([m()],ha.prototype,"controlVisibility",void 0);sh([m()],ha.prototype,"useGripSpace",void 0);sh([m()],ha.prototype,"resetTransformAfterXRSession",void 0);function _P(s,t){const e=s.xr.getFrame();if(!e)return console.warn("No XRFrame available"),!1;const i=e.session.enabledFeatures;if(i&&!i.some(o=>o==="camera-access"))return console.error(`No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene.

Example to request camera-access in global scope:
NeedleXRSession.onSessionRequestStart(evt => {
    evt.init.optionalFeatures = evt.init.optionalFeatures || [];
    evt.init.optionalFeatures.push('camera-access');
});
`),U()&&tm("No camera feed available - please request the 'camera-access' feature before starting WebXR or add the ARCameraBackground component to your scene"),!1;const n=e.getViewerPose(s.xr.getReferenceSpace());if(n)for(const o of n.views)if("camera"in o&&o.camera){let r=s.xr.getBinding();if(r||(r=new XRWebGLBinding(e.session,s.getContext())),r){let l=null;if("getCameraImage"in r){qD(s,t);const c=s.properties.get(t);if(c)return l=r.getCameraImage(o.camera),c.__webglTexture=l,!0;console.warn("No texture properties found for target texture")}}else console.error(o.camera,s.xr)}else console.error("NO CAMERA IN VIEW");else console.error(s.xr.getReferenceSpace(),e);return!1}const xw=new WeakMap;function qD(s,t){const e=xw.get(t)||new WeakSet;if(e.has(s))return;e.add(s),xw.set(t,e),console.debug("Initialize texture for camera feed");const i=new Be,n=new ro,o=new bn;o.add(new X(n,i));const r=new Se;i.map=t,s.render(o,r)}function G3(s,t,e,i="image/webp",n){return bP({context:s,width:t,height:e,mimeType:i,camera:n})}function bP(s){var T,k;s||(s={});const{transparent:t=!1}=s;let{mimeType:e,context:i,width:n,height:o,camera:r}=s;if(!i&&(i=ve.Current,!i))return console.error("Can not save screenshot: No needle-engine context found or provided."),null;if(!r&&(r=i.mainCamera,!r))return console.error("No camera found"),null;const l=i.renderer,c=l.xr.enabled&&l.xr.isPresenting;if(c&&i.currentFrameEvent!=oe.EarlyUpdate)return console.warn("Screenshot: defer to access XR frame"),new Promise(L=>{tr(O=>{const A=bP(s);L(A)},oe.EarlyUpdate,{once:!0})});const h=l.domElement,d=h.width,u=h.height;n||(n=d),o||(o=u);const f=n,p=o;let g=window.devicePixelRatio||1,_=1;i.devicePixelRatio==="auto"||i.devicePixelRatio==="manual"?_=1:_=i.devicePixelRatio/window.devicePixelRatio,g*=_,n/=g,o/=g,n=Math.floor(n),o=Math.floor(o),l.xr.isPresenting&&l.xr.getFrame();const y=l.xr.enabled;l.xr.enabled=!1,l.xr.isPresenting=!1,h.style.width=`${n}px`,h.style.height=`${o}px`;const b=l.getRenderTarget(),v=l.getClearColor(new de),w=l.getClearAlpha(),P=i.scene.background,E="aspect"in r?r.aspect:null;try{const z=s.render_events!==!1,L=new Array;z&&(nu(i.scene,Ve,L),L.forEach(I=>{var V;if(I==null||I.onBeforeRender(),I.isInstancingActive&&I.instances)for(let ie=0;ie<((V=I.instances)==null?void 0:V.length);ie++){const Z=I.instances[ie];Io(Z.object,!0)}})),t&&(i.scene.background=null,l.setClearColor(0,0)),s.background&&(i.scene.background=null,l.setClearColor(s.background),s.background instanceof pe&&l.setClearAlpha(s.background.a)),t&&l.setClearAlpha(0),l.setSize(n,o,!1),"cam"in r&&(r=r.threeCamera),r instanceof Se&&(r.aspect=n/o,r.updateProjectionMatrix());const O="type"in s&&s.type==="texture";let A=null;O&&(A=new io(n,o,{wrapS:B0,wrapT:B0,format:1023}),l.setRenderTarget(A));let $=h;if(c?(A&&console.error('Taking XR screenshots with { type: "texture" } is currently not supported.'),$=Rp.compositeWithCameraImage({width:f,height:p,scene:i.scene,camera:r,renderer:l})):i.renderNow(r||null),r instanceof Se&&E!=null&&(r.aspect=E,r.updateProjectionMatrix()),z&&L.forEach(I=>I.onAfterRender()),!e&&"download_filename"in s&&s.download_filename)switch((T=s.download_filename.split(".").pop())==null?void 0:T.toLowerCase()){case"png":e="image/png";break;case"jpg":case"jpeg":e="image/jpeg";break;case"webp":e="image/webp";break}if(t&&s.trim===!0){const I=XD($);I&&($=I)}if("type"in s){if(s.type==="texture")return A?(s.target&&(s.target.image=A==null?void 0:A.texture.image,s.target.needsUpdate=!0),A.texture.offset.set(0,-1),A.texture.needsUpdate=!0,A.texture):(console.error("No target texture found"),null);if(s.type==="blob")return new Promise((V,ie)=>{$.toBlob(Z=>{V(Z)},e)});if(s.type==="share")return new Promise((V,ie)=>{$.toBlob(Z=>{if(Z&&"share"in navigator){let J="file_type"in s&&s.file_type||e;e||(J="image/png");const ue=(J==null?void 0:J.split("/")[1])||"png",Ae=new File([Z],"filename"in s?s.filename||`screenshot.${ue}`:`screenshot.${ue}`,{type:J});return navigator.share({title:"title"in s?s.title:void 0,text:"text"in s?s.text:void 0,url:"url"in s?s.url:void 0,files:[Ae]}).catch(He=>{console.warn("User cancelled share",He.message)}).finally(()=>{V({blob:Z,shared:!0})})}return{blob:Z,shared:!1}},e)})}const B=$.toDataURL(e);if("download_filename"in s&&s.download_filename){let I=s.download_filename;if(K.isMobileDevice()&&typeof window<"u"){const V=I+"_screenshots",ie=I.split("."),Z=(k=ie.pop())==null?void 0:k.toLowerCase();let J=0;localStorage.getItem(V)&&(J=parseInt(sessionStorage.getItem(V)||"0")),J>0&&(I=`${ie.join()}-${J}.${Z}`),J+=1,sessionStorage.setItem(V,J.toString())}QD(B,I)}return B}finally{l.setRenderTarget(b),i.scene.background=P,l.setSize(d,u,!1),l.setClearColor(v,w),E!=null&&r instanceof Se&&(r.aspect=E,r.updateProjectionMatrix()),l.xr.enabled=y,l.xr.isPresenting=c,c||i.updateSize(!0)}return null}function XD(s){if(!("document"in globalThis))return null;const t=document.createElement("canvas");t.width=s.width,t.height=s.height;const e=t.getContext("2d");if(!e)return null;e.drawImage(s,0,0);const i=t.width,n=t.height,r=e.getImageData(0,0,i,n).data;let l=n,c=i,h=0,d=0;for(let _=0;_<n;_++)for(let y=0;y<i;y++){const b=(_*i+y)*4;r[b+3]!==0&&(y<c&&(c=y),y>d&&(d=y),_<l&&(l=_),_>h&&(h=_))}const u=d-c+1,f=h-l+1,p=document.createElement("canvas"),g=p.getContext("2d");return g?(p.width=u,p.height=f,g.drawImage(t,c,l,u,f,0,0,u,f),p):null}let Mh=null;function QD(s,t){if(s){if(!s.startsWith("data:image")){console.error("Can not save image: Data url is not an image",s);return}Mh||(Mh=document.createElement("a")),Mh.href=s,Mh.download=t,Mh.click()}}var Rp;(function(s){let t=null,e=null,i=null,n=null,o=null;function r(h){const{renderer:d,width:u,height:f}=h,p=d.xr.enabled,g=d.getRenderTarget(),_=d.autoClear,y=u,b=f,v=u/f;(!i||i.width!==y||i.height!==b)&&(i??(i=new io(y,b,{colorSpace:Qo})),i.width=y,i.height=b,i.samples=4,i.texture.repeat.y=-1,i.texture.offset.y=1),(!o||o.width!==y||o.height!==b)&&(o=document.createElement("canvas"),o.width=y,o.height=b,o.style.position="fixed",o.style.top="0px",o.style.right="0px",o.style.width="300px",o.style.height=`${300/v}px`,o.style.zIndex="1000",o.style.pointerEvents="none",o.style.opacity="1.0",o.style.willChange="contents"),t||(t=c({defines:{DECODE_VIDEO_TEXTURE:!0}})),e||(e=c()),n||(n=new Ke),d.xr.updateCamera(h.camera),d.xr.enabled=!1,d.autoClear=!1,d.clear(),d.setSize(y,b),d.setRenderTarget(i),_P(h.renderer,n)||console.error("Could not update texture from XR frame");const P=C.findObjectOfType(Xm);return P?P.setTexture(n):(t.setTexture(n),d.render(t,h.camera)),d.clearDepth(),d.setSize(y,b),d.render(h.scene,h.camera),d.setRenderTarget(null),e.setTexture(i.texture),d.render(e,h.camera),o.getContext("2d",{alpha:!1}).drawImage(d.domElement,0,0,o.width,o.height),d.setRenderTarget(g),d.xr.enabled=p,d.autoClear=_,o}s.compositeWithCameraImage=r;const l=`
uniform sampler2D t2D;
varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );

    #ifdef DECODE_VIDEO_TEXTURE

        // inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)
        texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    #endif

    gl_FragColor = texColor;
    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;function c(h){const d=(h==null?void 0:h.material)||new to({name:"BackgroundMaterial",uniforms:Hw.clone(Nf.background.uniforms),vertexShader:Nf.background.vertexShader,fragmentShader:l,defines:h==null?void 0:h.defines,side:Gr,depthTest:!1,depthWrite:!1,fog:!1});Object.defineProperty(d,"map",{get:function(){return this.threeTexture}});const u=new X(new ro(2,2),d);return Dy(u,!1),u.geometry.deleteAttribute("normal"),u.renderOrder=-1e6,u.setTexture=function(f){d.uniforms.t2D.value=f},u}s.makeFullscreenPlane=c})(Rp||(Rp={}));var YD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const ww=S("debugarcamera");class Xm extends j{constructor(){super(...arguments);a(this,"backgroundTint",new pe(1,1,1,1));a(this,"backgroundPlane");a(this,"threeTexture");a(this,"forceTextureInitialization",function(){const e=new Be,i=new ro,n=new bn;n.add(new X(i,e));const o=new Se;return function(l,c){e.map=c,l.render(n,o),ww&&console.warn("Force texture initialization")}}());a(this,"preRender",()=>{if(!this||!this.gameObject)return;if(this.context.renderer.xr.getFrame()){if(!this.threeTexture&&this.context.renderer&&(this.threeTexture=new Ke,this.forceTextureInitialization(this.context.renderer,this.threeTexture)),this.backgroundPlane===void 0){const n=this.backgroundTint;this.backgroundPlane=Rp.makeFullscreenPlane({material:new to({name:"BackgroundMaterial",uniforms:{...Hw.clone(Nf.background.uniforms),tint:{value:new Ce(n.r,n.g,n.b,n.a)}},vertexShader:Nf.background.vertexShader,fragmentShader:KD,side:vn,depthTest:!1,depthWrite:!1,fog:!1})})}this.backgroundPlane.parent!==this.scene&&this.scene.add(this.backgroundPlane),this.backgroundPlane.material instanceof to&&this.backgroundPlane.material.uniforms.tint.value.set(this.backgroundTint.r,this.backgroundTint.g,this.backgroundTint.b,this.backgroundTint.a),this.updateFromFrame()}})}onBeforeXR(e,i){e==="immersive-ar"&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push("camera-access"),ww&&console.warn("Requesting camera-access"))}onEnterXR(e){e.xr.mode==="immersive-ar"&&(this.backgroundPlane&&(this.context.scene.add(this.backgroundPlane),this.backgroundPlane.visible=!1),this.backgroundPlane&&this.context.scene.add(this.backgroundPlane),this.context.pre_render_callbacks.push(this.preRender))}onLeaveXR(e){this.backgroundPlane&&this.backgroundPlane.removeFromParent();const i=this.context.pre_render_callbacks.indexOf(this.preRender);i>=0&&this.context.pre_render_callbacks.splice(i,1)}get background(){return this.backgroundPlane}onBeforeRender(e){this.updateFromFrame()}updateFromFrame(){var e;this.threeTexture&&((e=this.context.xr)==null?void 0:e.mode)==="immersive-ar"&&(_P(this.context.renderer,this.threeTexture),this.setTexture(this.threeTexture))}setTexture(e){this.backgroundPlane&&(this.threeTexture=e,this.backgroundPlane.setTexture(this.threeTexture),this.backgroundPlane.visible=!0)}}YD([m(pe)],Xm.prototype,"backgroundTint",void 0);const KD=`
uniform sampler2D t2D;
uniform vec4 tint;

varying vec2 vUv;

void main() {

    vec4 texColor = texture2D( t2D, vUv );
    texColor.w = 1.0;

    // inline sRGB decode
    texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

    gl_FragColor = texColor * tint;

    #include <tonemapping_fragment>
    #include <colorspace_fragment>
}
`;var da=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Tp=S("debugimagetracking"),Fp=class{constructor(t,e,i,n,o,r){a(this,"measuredSize");a(this,"state");a(this,"_position");a(this,"_rotation");a(this,"_trackingComponent");a(this,"_trackedImage");a(this,"_bitmap");a(this,"_pose");this._trackingComponent=t,this._trackedImage=e,this._bitmap=i,this.measuredSize=n,this.state=o,this._pose=r}get url(){return this._trackedImage.image??""}get widthInMeters(){return this._trackedImage.widthInMeters??void 0}get bitmap(){return this._bitmap}get model(){return this._trackedImage}getPosition(t){return this.ensureTransformData(),t.copy(this._position),t}getQuaternion(t){return this.ensureTransformData(),t.copy(this._rotation),t}applyToObject(t,e=void 0){this.ensureTransformData();const i=t.position.distanceToSquared(this._position)/.05+t.quaternion.angleTo(this._rotation)/.05;e&&(e*=Math.max(1,i)),e===void 0||e>=1?(t.position.copy(this._position),t.quaternion.copy(this._rotation)):(e=Math.max(0,Math.min(1,e)),t.position.lerp(this._position,e),t.quaternion.slerp(this._rotation,e))}ensureTransformData(){if(!this._position){this._position=Fp._positionBuffer.get(),this._rotation=Fp._rotationBuffer.get();const t=this._pose.transform,e=te.active.convertSpace(t);this._position.copy(e==null?void 0:e.position),this._rotation.copy(e==null?void 0:e.quaternion)}}};let Jl=Fp;a(Jl,"_positionBuffer",new $n(()=>new x,20)),a(Jl,"_rotationBuffer",new $n(()=>new H,20));class ua{constructor(t){a(this,"image");a(this,"widthInMeters",.25);a(this,"object");a(this,"createObjectInstance",!1);a(this,"imageDoesNotMove",!1);a(this,"hideWhenTrackingIsLost",!0);this.image=t.url,this.widthInMeters=t.widthInMeters,t.object instanceof D?this.object=new he({asset:t.object}):this.object=t.object,t.createObjectInstance!==void 0&&(this.createObjectInstance=t.createObjectInstance),t.imageDoesNotMove!==void 0&&(this.imageDoesNotMove=t.imageDoesNotMove),t.hideWhenTrackingIsLost!==void 0&&(this.hideWhenTrackingIsLost=t.hideWhenTrackingIsLost)}getNameFromUrl(){if(this.image){const t=this.image.split("/");return t[t.length-1]}return null}}da([m(URL)],ua.prototype,"image",void 0);da([m()],ua.prototype,"widthInMeters",void 0);da([m(he)],ua.prototype,"object",void 0);da([m()],ua.prototype,"createObjectInstance",void 0);da([m()],ua.prototype,"imageDoesNotMove",void 0);da([m()],ua.prototype,"hideWhenTrackingIsLost",void 0);class JD{constructor(t,e){a(this,"exporter");a(this,"component");a(this,"isImageTrackingExtension",!0);a(this,"shouldExport",!0);a(this,"filename",null);a(this,"imageModel",null);this.exporter=t,this.component=e,Tp&&console.log(this),this.exporter.anchoringType="image"}get extensionName(){return"image-tracking"}onBeforeBuildDocument(t){var i;const e=this.exporter.extensions.filter(n=>{var r;const o=n;return o.isImageTrackingExtension&&o.component.activeAndEnabled&&((r=o.component.trackedImages)==null?void 0:r.length)>0}).indexOf(this);this.shouldExport=e===0,this.shouldExport&&((i=this.component.trackedImages)==null?void 0:i.length)>1&&(Tp||U())&&(ke("USDZ: Only one tracked image is supported."),console.warn("USDZ: Only one tracked image is supported. Will choose the first one in the trackedImages list"))}onAfterHierarchy(t,e){if(!this.shouldExport)return;const i=K.getiOSVersion(),r=(i?parseInt(i.split(".")[0]):18)>=18?1:100;e.beginBlock('def Preliminary_ReferenceImage "AnchoringReferenceImage"'),e.appendLine("uniform asset image = @image_tracking/"+this.filename+"@"),e.appendLine("uniform double physicalWidth = "+(this.imageModel.widthInMeters*r).toFixed(8)),e.closeBlock()}async onAfterSerialize(t){if(!this.shouldExport)return;const e=this.imageModel,i=Sd.get(e.image),r=await(await(await iI(i)).convertToBlob({type:"image/png"})).arrayBuffer();t.files["image_tracking/"+this.filename]=new Uint8Array(r)}onExportObject(t,e,i){var r,l;if(!this.shouldExport)return;const n=this.component;if(!n||!((r=n.trackedImages)!=null&&r.length)||!n.activeAndEnabled)return;const o=n.trackedImages[0];if(((l=o.object)==null?void 0:l.asset)===t){this.imageModel=o,this.filename=o.getNameFromUrl()||"marker.png";const{scale:c,target:h}=this.exporter.getARScaleAndTarget();let d=t;const u=new ce;if(t!==h)for(;d&&d.parent&&d.parent!==h;)d=d.parent,u.premultiply(d.matrix);const f=u.clone().invert();e.setMatrix(f.scale(new x(c,c,c)))}}}class Qm extends j{constructor(){super(...arguments);a(this,"trackedImages",[]);a(this,"smooth",!0);a(this,"trackedImageIndexMap",new Map);a(this,"_supported",!0);a(this,"onBeforeUSDZExport",e=>{var i;this.activeAndEnabled&&((i=this.trackedImages)!=null&&i.length)&&e.exporter.extensions.push(new JD(e.exporter,this))});a(this,"imageToObjectMap",new Map);a(this,"currentImages",[]);a(this,"webXRIncubationsWarning",`Image tracking is currently not supported on this device. On Chrome for Android, you can enable the <a target="_blank" href="#" onclick="() => console.log('I')">chrome://flags/#webxr-incubations</a> flag.`);a(this,"onImageTrackingUpdate",e=>{const i=te.active;if(i)for(const n of e){const o=n.model,r=n.state==="tracked";if(!o.object)continue;let l=this.imageToObjectMap.get(o);if(l===void 0)l={object:null,frames:0,lastTrackingTime:Date.now()},this.imageToObjectMap.set(o,l),o.object.loadAssetAsync().then(c=>{if(o.createObjectInstance&&c&&(c=C.instantiate(c)),c){l.object=c;for(const h of c.getComponentsInChildren(Ve))h.setInstancingEnabled(!1);i.rig?(i.rig.gameObject.add(c),n.applyToObject(c),c.activeSelf||C.setActive(c,!0)):console.warn("XRImageTracking: missing XRRig")}});else{if(l.frames++,r&&(l.lastTrackingTime=Date.now()),o.imageDoesNotMove&&l.frames>10||!l.object)continue;i.rig&&(i.rig.gameObject.add(l.object),n.applyToObject(l.object,this.smooth?this.context.time.deltaTimeUnscaled*3:void 0),l.object.activeSelf||C.setActive(l.object,!0))}}})}setPrimaryImage(e){const i=this.trackedImages.indexOf(e);if(i>=0){const n=this.trackedImages[0];n!==e&&(this.trackedImages[0]=e,this.trackedImages[i]=n)}else console.warn(`[WebXRImageTracking] Can not set primary: image not found in 'trackedImages' array ${e.image}`)}addImage(e,i=!1){this.trackedImages.includes(e)||(this.trackedImages.push(e),Sw(e.image)),i&&this.setPrimaryImage(e)}get supported(){return this._supported}awake(){if(Tp&&console.log(this),!!this.trackedImages)for(const e of this.trackedImages)e.image&&Sw(e.image)}onEnable(){De.beforeExport.addEventListener(this.onBeforeUSDZExport)}onDisable(){De.beforeExport.removeEventListener(this.onBeforeUSDZExport)}onBeforeXR(e,i){var n;if(this.trackedImages){i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.includes("image-tracking")||i.optionalFeatures.push("image-tracking"),i.trackedImages=[];for(const o of this.trackedImages)if((n=o.image)!=null&&n.length&&o.widthInMeters>0){const r=Sd.get(o.image);r&&(this.trackedImageIndexMap.set(i.trackedImages.length,o),i.trackedImages.push({image:r,widthInMeters:o.widthInMeters}))}}}onEnterXR(e){var i;if(this.trackedImages){for(const n of this.trackedImages)if((i=n.object)!=null&&i.asset){const o=n.object.asset;o.userData||(o.userData={});const r={visible:o.visible,parent:o.parent,matrix:o.matrix.clone()};o.userData["image-tracking"]=r}}for(const n of this.imageToObjectMap.values())n.frames=0}onLeaveXR(e){var i,n;if(!this.supported&&K.isAndroidDevice()&&ke(this.webXRIncubationsWarning),this.trackedImages){for(const o of this.trackedImages)if((i=o.object)!=null&&i.asset){const r=o.object.asset;if(r.userData){const l=r.userData["image-tracking"];l&&(r.visible=l.visible,(n=l.parent)==null||n.add(r),r.matrix.copy(l.matrix),r.matrix.decompose(r.position,r.quaternion,r.scale)),delete r.userData["image-tracking"]}}}}onUpdateXR(e){var o;this.currentImages.length=0;const i=e.xr.frame;if(!i)return;if("getImageTrackingResults"in i){if(((o=e.xr.session.enabledFeatures)==null?void 0:o.includes("image-tracking"))===!1)return;if(i.session&&typeof i.getImageTrackingResults=="function"){const r=i.getImageTrackingResults();if(r.length>0){const l=this.context.renderer.xr.getReferenceSpace();if(l){for(const c of r){const h=c.trackingState,d=c.index,u=this.trackedImageIndexMap.get(d);if(u){const f=i.getPose(c.imageSpace,l),p=new Jl(this,u,c.image,c.measuredSize,h,f);this.currentImages.push(p)}else Tp&&console.warn("No tracked image for index",d)}if(this.currentImages.length>0)try{this.dispatchEvent(new CustomEvent("image-tracking",{detail:this.currentImages})),this.onImageTrackingUpdate(this.currentImages)}catch(c){console.error(c)}}}}}else{this.didPrintWarning||(this.didPrintWarning=!0,console.log(this.webXRIncubationsWarning)),this._supported=!1,ke(this.webXRIncubationsWarning);return}const n=1e3;for(const[r,l]of this.imageToObjectMap){if(!l.object||!r||r.hideWhenTrackingIsLost===!1)continue;let c=!1;for(const h of this.currentImages)if(h.model===r){const d=Date.now()-l.lastTrackingTime;if(r.imageDoesNotMove||h.state==="tracked"||d<=n){c=!0;break}}c||C.setActive(l.object,!1)}}}da([m(ua)],Qm.prototype,"trackedImages",void 0);da([m()],Qm.prototype,"smooth",void 0);const Sd=new Map,mf=new Map;async function Sw(s){if(Sd.has(s))return mf.has(s)?mf.get(s):Promise.resolve(!0);const t=new Promise(e=>{Sd.set(s,null);const i=document.createElement("img");i.src=s,i.addEventListener("load",async()=>{const n=await createImageBitmap(i);Sd.set(s,n),e(!0)})});return mf.set(s,t),t.finally(()=>{mf.delete(s)}),t}var oh=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Sa=S("debugplanetracking");class fa extends j{constructor(){super(...arguments);a(this,"dataTemplate");a(this,"occluder",!0);a(this,"initiateRoomCaptureIfNoData",!0);a(this,"usePlaneData",!0);a(this,"useMeshData",!0);a(this,"runInVR",!0);a(this,"bounds",new Nn);a(this,"center",new x);a(this,"labelOffset",new x);a(this,"_dataId",1);a(this,"_allPlanes",new Map);a(this,"_allMeshes",new Map);a(this,"firstTimeNoPlanesDetected",-100);a(this,"makeOccluder",(e,i,n=!1)=>{if(i){if(i instanceof Array){for(const o of i)this.makeOccluder(e,o,n);return}!n&&!i.name.toLowerCase().includes("occlu")||(i.colorWrite=!1,i.depthTest=!0,i.depthWrite=!0,i.transparent=!1,i.polygonOffset=!0,i.polygonOffsetFactor=1,i.polygonOffsetUnits=.1,e.renderOrder=-1e3)}});a(this,"_flipForwardMatrix",new ce().makeRotationY(Math.PI));a(this,"_verticesCache",new Map)}get trackedPlanes(){return this._allPlanes.values()}get trackedMeshes(){return this._allMeshes.values()}onBeforeXR(e,i){e==="immersive-vr"&&!this.runInVR||(i.optionalFeatures=i.optionalFeatures||[],this.usePlaneData&&!i.optionalFeatures.includes("plane-detection")&&i.optionalFeatures.push("plane-detection"),this.useMeshData&&!i.optionalFeatures.includes("mesh-detection")&&i.optionalFeatures.push("mesh-detection"))}onEnterXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onLeaveXR(e){for(const i of this._allPlanes.keys())this.removeData(i,this._allPlanes);for(const i of this._allMeshes.keys())this.removeData(i,this._allMeshes)}onUpdateXR(e){if(!this.runInVR&&e.xr.isVR)return;const i=e.xr.rig;if(!i){console.warn("No XR rig found, cannot parent tracked planes to it");return}const n=e.xr.frame;if(!this.context.renderer.xr.getReferenceSpace())return;const l=n.detectedPlanes,c=n.detectedMeshes,h=l!==void 0&&l.size>0,d=c!==void 0&&c.size>0;if(this.initiateRoomCaptureIfNoData&&(!h&&!d&&this.firstTimeNoPlanesDetected<-10&&(this.firstTimeNoPlanesDetected=Date.now()),(h||d)&&(this.firstTimeNoPlanesDetected=-1),this.firstTimeNoPlanesDetected>0&&Date.now()-this.firstTimeNoPlanesDetected>2500&&"initiateRoomCapture"in n.session&&(n.session.initiateRoomCapture(),this.firstTimeNoPlanesDetected=-1)),l!==void 0&&this.processFrameData(e.xr,i.gameObject,n,l,this._allPlanes),c!==void 0&&this.processFrameData(e.xr,i.gameObject,n,c,this._allMeshes),Sa){const u=this.context.mainCameraComponent.gameObject.worldPosition;for(const f of this._allPlanes.values())!f.mesh||!f.mesh.visible||(this.bounds.makeEmpty(),f.mesh.traverse(p=>{p instanceof X&&this.bounds.expandByObject(p)}),this.bounds.getCenter(this.center),this.labelOffset.copy(u).sub(this.center).normalize().multiplyScalar(.1),G.DrawLabel(this.center.add(this.labelOffset),(f.xrData.semanticLabel||"plane").toUpperCase()+`
`+f.xrData.lastChangedTime.toFixed(2),.02))}}removeData(e,i){const n=i.get(e);if(!n)return;i.delete(e),Sa&&console.log("Plane no longer tracked, id="+n.id),n.mesh&&(n.mesh.removeFromParent(),n.mesh.traverse(r=>{const l=r.userData.normalsHelper;l?(l.dispose(),l.removeFromParent()):Sa&&console.warn("No normals helper found for mesh",n.mesh)}),Wn(n.mesh,!0,!0));const o=new CustomEvent("plane-tracking",{detail:{type:"plane-removed",context:n}});this.dispatchEvent(o)}processFrameData(e,i,n,o,r){const c=this.context.renderer.xr.getReferenceSpace();if(c){for(const h of r.keys())o.has(h)||this.removeData(h,r);for(const h of o){const d="planeSpace"in h?h.planeSpace:"meshSpace"in h?h.meshSpace:void 0;if(!d)continue;const u=n.getPose(d,c);let f;if(r.has(h)){const p=r.get(h);if(f=p.mesh,p.timestamp<h.lastChangedTime){if(p.timestamp=h.lastChangedTime,p.mesh){const _=this.createGeometry(h);if(p.mesh instanceof X)p.mesh.geometry.dispose(),p.mesh.geometry=_,this.makeOccluder(p.mesh,p.mesh.material);else if(p.mesh instanceof Ar)for(const y of p.mesh.children)y instanceof X&&(y.geometry.dispose(),y.geometry=_,this.makeOccluder(y,y.material));if(p.collider){const y=p.mesh;p.collider.sharedMesh=y,p.collider.convex=this.checkIfContextShouldBeConvex(y,p.xrData),p.collider.onDisable(),p.collider.onEnable()}Sa&&(console.log("Plane updated, id="+p.id,p),p.mesh.traverse(y=>{if(!(y instanceof X))return;const b=y.userData.normalsHelper;b&&b.update()}))}const g=new CustomEvent("plane-tracking",{detail:{type:"plane-updated",context:p}});this.dispatchEvent(g)}}else{if(!this.dataTemplate){const p=new X;Sa?p.material=new YR:this.occluder?(p.material=new Be,this.makeOccluder(p,p.material,!0)):p.material=new Be({wireframe:!0,opacity:.5,transparent:!0,color:3355443}),this.dataTemplate=new he("","",p)}if(!this.dataTemplate.asset)this.dataTemplate.loadAssetAsync();else{const p=C.instantiate(this.dataTemplate.asset);if(p.name="xr-tracked-plane",f=p,pS(p,!1),p instanceof X)Ye(p.geometry),p.geometry=this.createGeometry(h),this.makeOccluder(p,p.material,this.occluder&&!this.dataTemplate);else if(p instanceof Ar)for(const y of p.children)y instanceof X&&(Ye(y.geometry),y.geometry=this.createGeometry(h),this.makeOccluder(y,y.material,this.occluder&&!this.dataTemplate));const g=p.getComponent(fl);if(g){const y=p;g.sharedMesh=y,g.convex=this.checkIfContextShouldBeConvex(y,h),g.onDisable(),g.onEnable()}p.matrixAutoUpdate=!1,p.matrixWorldNeedsUpdate=!0,i.add(p);const _={id:this._dataId++,xrData:h,timestamp:h.lastChangedTime,mesh:p,collider:g};r.set(h,_),Sa&&console.log("New plane detected, id="+_.id,_,{hasCollider:!!g,isGroup:p instanceof Ar});try{const y=new CustomEvent("plane-tracking",{detail:{type:"plane-added",context:_}});this.dispatchEvent(y)}catch(y){console.error(y)}}}f&&(u?(f.visible=!0,f.matrix.fromArray(u.transform.matrix),f.matrix.premultiply(this._flipForwardMatrix)):f.visible=!1,Sa&&f.traverse(p=>{if(p instanceof X)if(p.userData.normalsHelper)p.userData.normalsHelper.update();else{const g=new bT(p,.05,255);g.layers.disableAll(),g.layers.set(2),this.context.scene.add(g),p.userData.normalsHelper=g}}))}}}checkIfContextShouldBeConvex(e,i){if(!e)return!0;if(e){const n=new Nn;n.expandByObject(e);const o=new x;n.getSize(o);let r=!0;return o.x>2&&o.y>2&&o.z>1.5&&(r=!1),r&&"semanticLabel"in i&&i.semanticLabel==="wall"&&(r=!0),r}return!0}createGeometry(e){return"polygon"in e?this.createPlaneGeometry(e.polygon):"vertices"in e&&"indices"in e?this.createMeshGeometry(e.vertices,e.indices):new os}createMeshGeometry(e,i){const n=e.toString()+"_"+i.toString();if(this._verticesCache.has(n))return this._verticesCache.get(n);const o=new os;o.setIndex(new Hi(i,1)),o.setAttribute("position",new Hi(e,3));const r=Array();for(let l=0;l<e.length;l+=3)r.push(e[l],e[l+2]);return o.setAttribute("uv",new Hi(e,3)),o.computeVertexNormals(),this._verticesCache.set(n,o),o}createPlaneGeometry(e){const i=new os,n=[],o=[];e.forEach(p=>{n.push(p.x,p.y,p.z),o.push(p.x,p.z)});const r=new x(n[0],n[1],n[2]),l=new x(n[3],n[4],n[5]),c=new x(n[6],n[7],n[8]),h=new x,d=new x;h.subVectors(l,r),d.subVectors(c,r),h.cross(d),h.normalize();const u=[];for(let p=0;p<n.length/3;p++)u.push(h.x,h.y,h.z);const f=[];for(let p=2;p<e.length;++p)f.push(0,p-1,p);return i.setAttribute("position",new Hi(new Float32Array(n),3)),i.setAttribute("uv",new Hi(new Float32Array(o),2)),i.setAttribute("normal",new Hi(new Float32Array(u),3)),i.setIndex(f),i.computeBoundingBox(),i.computeBoundingSphere(),i}}oh([m(he)],fa.prototype,"dataTemplate",void 0);oh([m()],fa.prototype,"occluder",void 0);oh([m()],fa.prototype,"initiateRoomCaptureIfNoData",void 0);oh([m()],fa.prototype,"usePlaneData",void 0);oh([m()],fa.prototype,"useMeshData",void 0);oh([m()],fa.prototype,"runInVR",void 0);var ZD=globalThis&&globalThis.__decorate||function(s,t,e,i){var n=arguments.length,o=n<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(s,t,e,i);else for(var l=s.length-1;l>=0;l--)(r=s[l])&&(o=(n<3?r(o):n>3?r(t,e,o):r(t,e))||o);return n>3&&o&&Object.defineProperty(t,e,o),o};const Cw=S("debugwebxr");class b0 extends j{constructor(){super(...arguments);a(this,"priority",0);a(this,"_startScale")}get isActive(){return this.activeAndEnabled&&this.gameObject.visible}setAsActiveXRRig(){var e;(e=te.active)==null||e.setRigActive(this)}setPriority(e){this.priority=e}awake(){if(Cw){const e=new D;e.position.y+=.5,this.gameObject.add(e);const i=e.addNewComponent(Xc);i&&(i.isGizmo=!1);const n=new yn(.5);this.gameObject.add(n)}}isXRRig(){return!0}supportsXR(e){return!0}onEnterXR(e){this._startScale=this.gameObject.scale.clone(),e.xr.addRig(this),Cw&&console.log("WebXR: add Rig",this.name,this.priority)}onLeaveXR(e){e.xr.removeRig(this),this._startScale&&this.gameObject&&this.gameObject.scale.copy(this._startScale)}}ZD([m()],b0.prototype,"priority",void 0);class eL extends j{constructor(){super(...arguments);a(this,"toggleKey","KeyP")}update(){this.context.input.isKeyDown(this.toggleKey)&&this.context.domElement.classList.toggle("presentation-mode")}}M.add("AlignmentConstraint",fm);M.add("Animation",Yi);M.add("Animator",ii);M.add("AudioListener",Mr);M.add("AudioSource",Oe);M.add("Avatar_Brain_LookAt",hp);M.add("Avatar_MouthShapes",ym);M.add("Avatar_MustacheShake",m1);M.add("AvatarBlink_Simple",zc);M.add("AvatarEyeLook_Rotation",Ur);M.add("AxesHelper",au);M.add("BasicIKConstraint",y1);M.add("BoxHelperComponent",un);M.add("Camera",Pe);M.add("CharacterController",Uc);M.add("CharacterControllerInput",Jr);M.add("Collider",wn);M.add("SphereCollider",lu);M.add("BoxCollider",ul);M.add("MeshCollider",fl);M.add("CapsuleCollider",qr);M.add("ContactShadows",_n);M.add("LogStats",_1);M.add("DeleteBox",pc);M.add("Deletable",v1);M.add("DeviceFlag",zb);M.add("DragControls",jt);M.add("DropListener",Zr);M.add("Duplicatable",ml);M.add("EventListEvent",Ib);M.add("EventTrigger",Wb);M.add("GltfExportBox",M1);M.add("GltfExport",Ws);M.add("VariantAction",N1);M.add("ChangeTransformOnClick",Vc);M.add("ChangeMaterialOnClick",is);M.add("SetActiveOnClick",Ln);M.add("HideOnStart",za);M.add("EmphasizeOnClick",hu);M.add("PlayAudioOnClick",tl);M.add("PlayAnimationOnClick",Xs);M.add("PreliminaryAction",du);M.add("PreliminaryTrigger",wm);M.add("VisibilityAction",Sm);M.add("TapGestureTrigger",$1);M.add("USDZExporter",De);M.add("Fog",pu);M.add("BoxGizmo",Xc);M.add("GridHelper",mu);M.add("GroundProjectedEnv",ir);M.add("UsageMarker",bm);M.add("Interactable",b1);M.add("FixedJoint",eP);M.add("HingeJoint",Om);M.add("Light",Ji);M.add("LODGroup",km);M.add("LookAtConstraint",Fc);M.add("NeedleMenu",or);M.add("NestedGltf",Em);M.add("Networking",Xr);M.add("OffsetConstraint",Qc);M.add("CameraTargetReachedEvent",lp);M.add("OrbitControls",Ee);M.add("ParticleSystemRenderer",bs);M.add("ParticleSystem",st);M.add("Attractor",bu);M.add("PlayerColor",Yd);M.add("Antialiasing",Am);M.add("BloomEffect",Ho);M.add("ChromaticAberration",Im);M.add("ColorAdjustments",_l);M.add("DepthOfField",fo);M.add("EffectWrapper",wp);M.add("PixelationEffect",Lm);M.add("ScreenSpaceAmbientOcclusion",ra);M.add("ScreenSpaceAmbientOcclusionN8",po);M.add("SharpeningEffect",jm);M.add("TiltShiftEffect",ar);M.add("ToneMappingEffect",sl);M.add("Vignette",Zc);M.add("Volume",xu);M.add("ReflectionProbe",qs);M.add("Renderer",Ve);M.add("MeshRenderer",vm);M.add("SkinnedMeshRenderer",k1);M.add("Rigidbody",xe);M.add("SceneSwitcher",vt);M.add("ScreenCapture",xl);M.add("ShadowCatcher",Bm);M.add("RemoteSkybox",Zo);M.add("SmoothFollow",eo);M.add("SpatialTriggerReceiver",Go);M.add("SpatialTrigger",Ja);M.add("SpectatorCamera",h0);M.add("SplineContainer",th);M.add("SplineWalker",mo);M.add("SpriteRenderer",Sn);M.add("SyncedCamera",gc);M.add("SyncedRoom",go);M.add("SyncedTransform",oo);M.add("TestRunner",uP);M.add("TestSimulateUserData",fP);M.add("PlayableDirector",us);M.add("SignalReceiver",Wr);M.add("AnimationTrackHandler",u0);M.add("AudioTrackHandler",yc);M.add("SignalTrackHandler",Pp);M.add("ControlTrackHandler",f0);M.add("TransformGizmo",ih);M.add("BaseUIComponent",ms);M.add("UIRootComponent",Rm);M.add("Button",ca);M.add("Canvas",Bt);M.add("CanvasGroup",nl);M.add("EventSystem",Xi);M.add("Graphic",Vo);M.add("MaskableGraphic",Tm);M.add("Image",Pu);M.add("RawImage",m0);M.add("InputField",jn);M.add("VerticalLayoutGroup",Y1);M.add("HorizontalLayoutGroup",K1);M.add("GridLayoutGroup",J1);M.add("Outline",fu);M.add("ObjectRaycaster",Vn);M.add("GraphicRaycaster",Db);M.add("SpatialGrabRaycaster",Qa);M.add("RectTransform",ni);M.add("SpatialHtml",Hm);M.add("Text",ji);M.add("EnvironmentScene",g0);M.add("LookAt",qo);M.add("OpenURL",Ru);M.add("VideoPlayer",Ft);M.add("Voip",dl);M.add("ClickThrough",_0);M.add("CursorFollow",qm);M.add("ScrollFollow",gs);M.add("Avatar",il);M.add("XRControllerFollow",ha);M.add("XRControllerModel",Jo);M.add("XRControllerMovement",Hn);M.add("TeleportTarget",Xb);M.add("WebARCameraBackground",Xm);M.add("WebARSessionRoot",ss);M.add("WebXR",Je);M.add("AvatarMarker",Lt);M.add("WebXRImageTracking",Qm);M.add("WebXRPlaneTracking",fa);M.add("XRRig",b0);M.add("XRFlag",Qt);M.add("PlayerSync",gl);M.add("PlayerState",Kt);M.add("PresentationMode",eL);const Cd=Dt,tL=S("debugtypestore");tL&&console.log(M);function iL(s,t){const i=tM(s,t);return i!==void 0?i:null}const nL=new eM,Sy=Symbol("deserialize-queue");async function sL(s,t,e,i=null,n){if(!e){console.debug("Can not create component instances: gltf is null");return}const o=[];let r=i;typeof r=="number"&&(r=new yi(i));const l=t.indexOf("?");t=l===-1?t:t.substring(0,l);const c=new BC(e.scene);c.gltfId=t,c.context=s,c.gltf=e,c.nodeToObject=n==null?void 0:n.nodeToObjectMap,c.implementationInformation=nL;let h=s[Sy];if(h||(h=s[Sy]=[]),e.scenes)for(const d of e.scenes)await H_(c,d,h,o,0);if(e.children)for(const d of e.children)await H_(c,d,h,o,0);s.new_scripts_pre_setup_callbacks.push(()=>{const d=s[Sy];if(d){for(const u of d)oL(u,c);d.length=0}if(r){const u={},f=[];V_(e,r,u,f);for(const p of e.scenes)V_(p,r,u,f);for(const p of f)p.resolveGuids(u)}})}const W_=Symbol("original-component-name"),Ml=new Map;function V_(s,t,e,i){if(t===null||!s)return;const n=s.guid,o=s.guid;o!=null&&o.length&&(Ml.has(o)||(Cd&&console.log('Creating InstanceIdProvider with key "'+o+'" for object '+s.name),Ml.set(o,new yi(o))));const r=o&&Ml.get(o)||t;if(s.guid=r.generateUUID(),n&&n!=="invalid"&&(e[n]=s.guid),s&&s.userData&&s.userData.components)for(const l of s.userData.components){if(l===null)continue;const c=l.guid;c?Ml.has(c)||(Cd&&console.log('Creating InstanceIdProvider with key "'+c+'" for component '+l[W_]),Ml.set(c,new yi(c))):Cd&&console.warn("Can not create IdProvider: component "+l[W_]+" has no guid",l.guid);const h=Ml.get(c)||t,d=l.guid;l.guid=h.generateUUID(),d&&d!=="invalid"&&(e[d]=l.guid),l.resolveGuids&&i.push(l)}if(s.children)for(const l of s.children)V_(l,t,e,i)}const Ah=[];async function H_(s,t,e,i,n){var r,l,c,h,d;if(!t)return;const o=t.userData;if(o){const u=o.builtin_components;if(u&&u.length>0)for(const f of u)try{if(f===null)continue;const p=M.get(f.name);if(p!=null){const g=new p;g.sourceId=s.gltfId,Oc(g,f,s.implementationInformation),g.context=s.context,"guid"in f&&(g[bf]=f.guid),g[W_]=f.name,uc(t,g,!1),e.push({instance:g,compData:f,obj:t}),g.isCamera&&s.context&&s.context.mainCamera===null&&g.tag==="MainCamera"&&s.context.setCurrentCamera(g),((c=(l=(r=s.context)==null?void 0:r.physics)==null?void 0:l.engine)==null?void 0:c.isInitialized)===!1&&(g.isCollider||g.isRigidbody)&&((d=(h=s.context)==null?void 0:h.physics.engine)==null||d.initialize())}else Cd&&console.debug("unknown component: "+f.name),Ah.includes(f.name)||Ah.push(f.name)}catch(p){console.error(f.name+" - "+p.message,p)}}if(t.children)for(const u of t.children)await H_(s,u,e,i,n+1);if(Ah.length>0&&n===0){const u=Ah.join(", ");console.warn(`Unknown components in scene: ${u}`),Ah.length=0,fs()&&nt(`<strong>Unknown components in scene</strong>:

${u}

This could mean you forgot to add a npmdef to your ExportInfo
<a href="https://engine.needle.tools/docs/project_structure.html#creating-and-installing-a-npmdef" target="_blank">documentation</a>`,Jt.Warn)}}function oL(s,t){const{instance:e,compData:i,obj:n}=s;t.object=n,t.target=e,r_(e,i,t),Cd&&console.debug("add "+i.name,i,e)}class vP{createBuiltinComponents(t,e,i,n,o){return sL(t,e,i,n,o)}writeBuiltinComponentData(t,e){return iL(t,e)}parseSync(t,e,i,n){return lL(t,e,i,n)}loadSync(t,e,i,n,o){return SP(t,e,i,n,o)}}wS(vP);const xP=S("printGltf")||S("printgltf"),rL=S("debugfileformat");async function wP(s,t){const e=await f2(s,{useExtension:!0})||"unknown";rL&&console.debug(`Determined file type: '${e}' for url '${s}'`,{registeredModelLoaderCallbacks:Wl});for(const i of Wl){const{callback:n}=i,o=n({context:t,url:s,mimetype:e});if(o instanceof Promise&&await o,o)return console.debug(`Using custom loader (${i.name||"unnamed"}) for ${e} at '${s}'`),o}switch(e){case"unsupported":return null;default:case"unknown":{console.warn(`Unknown file type (${e}). Needle Engine will fallback to the GLTFLoader - To support more model formats please create a Needle loader plugin.
Use import { NeedleEngineModelLoader } from "@needle-tools/engine" namespace to register your loader.`,s);const i=new Yo;return await S_(i,t,s),i}case"model/fbx":case"model/vnd.autodesk.fbx":return new Zw;case"model/obj":return new nb;case"model/vnd.usdz+zip":case"model/vnd.usd+zip":case"model/vnd.usda+zip":return console.warn(e.toUpperCase()+" files are not supported."),null;case"model/gltf+json":case"model/gltf-binary":case"model/vrm":{const i=new Yo;return await S_(i,t,s),i}}}function aL(s,t){return SP((t==null?void 0:t.context)||ne.Current,s,s,(t==null?void 0:t.seed)||null,t==null?void 0:t.onprogress)}async function lL(s,t,e,i){typeof e!="string"&&(console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",e,typeof e),e=""),xP&&console.log("Parse glTF",e);const n=await wP(e,s);if(!n)return;const{componentsExtension:o}=CP(n,s);if(n instanceof nb){typeof t!="string"&&(t=new TextDecoder().decode(t));const l=n.parse(t);return await Pd(n,s,e,l,i,o)}if(!(n instanceof Yo)){if(n.parse===void 0){console.error("Loader does not support parse");return}const l=n.parse(t,e);return await Pd(n,s,e,l,i,o)}return new Promise((l,c)=>{try{let h=e.split("?")[0].trimEnd();const d=h.split("/");d.length>0&&d[d.length-1]!==""&&d.pop(),h=d.join("/"),h.endsWith("/")||(h+="/"),n.resourcePath=h,n.parse(t,"",async u=>{const f=await Pd(n,s,e,u,i,o);l(f)},u=>{console.error('Loading asset at "'+e+`" failed
`,u),l(void 0)})}catch(h){console.error(h),c(h)}})}async function SP(s,t,e,i,n){hL(t);const o=await wP(t,s);if(!o)return;const{componentsExtension:r}=CP(o,s);if(!(o instanceof Yo)){const l=await o.loadAsync(t,n);return await Pd(o,s,t,l,i,r)}return new Promise((l,c)=>{try{o.load(t,async h=>{const d=await Pd(o,s,e,h,i,r);l(d)},h=>{n==null||n.call(o,h)},h=>{console.error('Loading asset at "'+t+`" failed
`,h),l(void 0)})}catch(h){console.error(h),c(h)}})}function CP(s,t){const e=P1(s);return s instanceof Yo&&Mb(s,t),{componentsExtension:e}}async function Pd(s,t,e,i,n,o){if(xP&&console.warn("Loaded",e,i),i==null)return console.error(`Loaded model is null '${e}' - please make sure the loader is registered correctly`),{scene:new D,animations:[],scenes:[]};if(typeof i!="object")return console.error(`Loaded model is not an object '${e}' - please make sure the loader is registered correctly`),{scene:new D,animations:[],scenes:[]};if(i instanceof D)i={scene:i,animations:i.animations,scenes:[i]};else if(i instanceof os){const r=new It({color:new de(14540253)}),l=new X(i,r);i={scene:l,animations:[],scenes:[l]}}else Array.isArray(i.scenes)===!1&&console.error(`[Needle Engine] The loaded model object does not have a scenes property '${e}' - please make sure the loader is registered correctly and three.js is not imported multiple times.`);return e.includes("?")&&(e=e.split("?")[0]),dL(s,i),QA(i)&&(D2(e,i,t),await so().createBuiltinComponents(t,e,i,n,o||void 0)),await cL(i.scene,t,t.mainCamera),i}async function cL(s,t,e){e||(e=t.mainCamera);try{e?await t.renderer.compileAsync(s,e,t.scene).catch(i=>{console.warn(i.message)}):CE(s,t)}catch(i){console.warn((i==null?void 0:i.message)||i)}}function hL(s){if(new URL(s,window.location.href).href.startsWith("file://")){const e=`Hi - it looks like you are trying to load a local file which will not work. You need to use a webserver to serve your files.
Please refer to the documentation on <a href="https://fwd.needle.tools/needle-engine/docs/local-server">https://docs.needle.tools</a> or ask for help in our <a href="https://discord.needle.tools">discord community</a>`;nt(e),console.warn(e)}}function dL(s,t){var e;if("scenes"in t){for(const i of t.scenes)if(i&&!((e=i.animations)!=null&&e.length))for(const n of t.animations)i.animations.includes(n)||i.animations.push(n)}if(s instanceof Zw||s instanceof nb){let i=t;i instanceof D||(i=t.scene||t.scenes.find(n=>n)),i.traverse(n=>{const o=n;o!=null&&o.isMesh&&mS(o,o.material)})}}const Ih=S("debugoverlay"),PP="ar",uL="quit-ar";class fL{constructor(){a(this,"arContainer",null);a(this,"currentSession",null);a(this,"_createdAROnlyElements",[]);a(this,"_reparentedObjects",[]);a(this,"contentElement",null);a(this,"originalDomOverlayParent",null);a(this,"requestEndAR",()=>{this.onRequestedEndAR()})}get ARContainer(){return this.arContainer}onBegin(t,e,i){var n;if(this.currentSession=i,this.arContainer=e,K.isMozillaXR()){const o=t.domElement.children;for(let r=0;r<(o==null?void 0:o.length);r++){const l=o[r];if(!l||l===this.arContainer)return;this._reparentedObjects.push({el:l,previousParent:l.parentElement}),(n=this.arContainer)==null||n.appendChild(l)}e?(this.originalDomOverlayParent=e.parentNode,this.originalDomOverlayParent&&(console.log("Reparent DOM Overlay to body",e,e.style.display),e.style.display="",e.style.visibility="",document.body.appendChild(e))):console.warn("WebXRViewer: No DOM Overlay found")}this.ensureQuitARButton(this.arContainer)}onEnd(t){var e;for(const i of this._createdAROnlyElements)i.remove&&i.remove();for(const i of this._reparentedObjects){const n=i.el;(e=i.previousParent)==null||e.appendChild(n)}this._reparentedObjects.length=0,K.isMozillaXR()&&setTimeout(()=>{var r;const i=t.renderer.domElement;i&&((r=t.domElement.shadowRoot)==null||r.prepend(i));const n=document.querySelectorAll("*");for(var o=0;o<n.length;o++){const l=n[o];l&&l._displayChanged!==void 0&&l._displayWas!==void 0&&(l.style.display=l._displayWas)}},10)}createOverlayContainer(t){if(this.contentElement)return this.contentElement;Ih&&console.log("Setup overlay container");const e=t.shadowRoot.querySelector(".content");this.contentElement=e;const i=t.shadowRoot.querySelector(".overlay-content");return i&&e.appendChild(i),Ih&&!K.isMobileDevice()&&this.ensureQuitARButton(e),e}onRequestedEndAR(){this.currentSession&&(this.currentSession.end(),this.currentSession=null)}ensureQuitARButton(t){const e=document.createElement("slot");e.setAttribute("name","quit-ar"),this.appendElement(e,t),this._createdAROnlyElements.push(e),e.style.pointerEvents="auto";const i=document.querySelector(`.${uL}`);if(i){i.addEventListener("click",this.requestEndAR),Ih&&i.addEventListener("click",()=>console.log("Clicked quit-ar button"));return}e.addEventListener("click",this.requestEndAR),Ih&&e.addEventListener("click",()=>console.log("Clicked fallback close button"));const n=document.createElement("div");n.style.cssText=`
            position: fixed;
            top: 0;
            right: 0;
            z-index: 600;
            pointer-events: all;
        `,this.appendElement(n,e);var o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.classList.add("quit-ar-button"),o.setAttribute("width","40px"),o.setAttribute("height","40px"),o.style.cssText=`
            background: rgba(255, 255, 255, .4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,.3);
            outline: 1px solid rgba(255, 255, 255, .6);
            display: flex;
            justify-content: center;
            align-items: center;
        `,n.appendChild(o);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),r.setAttribute("stroke","#000000"),r.setAttribute("stroke-width","2px"),r.style.cssText=`
            /**filter: drop-shadow(0 0px 1.2px rgba(0,0,0,.7));**/
        `,o.appendChild(r),Ih&&console.log("Created fallback close button",o,t)}appendElement(t,e){return e.shadowRoot?e.shadowRoot.appendChild(t):e.appendChild(t)}}const Ea=S("debugloading"),Dh=S("debugloadingrendering"),Pw=S("debuglicense");class q3{constructor(){a(this,"className");a(this,"additionalClasses")}}let Lh=0,Rw;function RP(s){Ea&&console.log(s.progress.loaded.toFixed(0)+"/"+s.progress.total.toFixed(0),s);const t=s.count,e=s.progress.total;e===0||e===void 0?(Rw!==s.name&&(Lh=0),Rw=s.name,Lh+=(1-Lh)*.001,Ea&&ke("Loading "+s.name+" did not report total size")):Lh=s.progress.loaded/e;const i=s.index/t+Lh/t;return N.clamp01(i)}const zp=class{constructor(t,e){a(this,"loadingProgress",0);a(this,"_element");a(this,"_progress",0);a(this,"_allowCustomLoadingElement",!0);a(this,"_loadingElement");a(this,"_loadingTextContainer",null);a(this,"_loadingBar",null);a(this,"_messageContainer",null);a(this,"_loadingElementOptions");a(this,"_progressLoop");this._element=t,this._loadingElementOptions=e}async onLoadingBegin(t){const e=this._element.shadowRoot||this._element;if(Ea&&console.warn("Begin Loading"),!this._loadingElement){for(let i=0;i<e.children.length;i++){const n=e.children[i];if(n.classList.contains(zp.LoadingContainerClassName)){if(!this._allowCustomLoadingElement){Ea&&console.warn("Remove custom loading container"),e.removeChild(n);continue}this._loadingElement=this.createLoadingElement(n)}}this._loadingElement||(this._loadingElement=this.createLoadingElement())}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="flex",e.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(t??"")}onLoadingUpdate(t,e){var n;if(!((n=this._loadingElement)!=null&&n.parentNode))return;let i=0;typeof t=="number"?i=t:("index"in t&&(i=RP(t)),!e&&"name"in t&&this.setMessage("loading "+t.name)),this.loadingProgress=i,e&&this.setMessage(e),this.updateDisplay()}onLoadingFinished(){Ea&&console.warn("Finished Loading"),Dh||(this.loadingProgress=1,this.onDoneLoading())}setMessage(t){this._messageContainer&&(this._messageContainer.innerText=t)}smoothProgressLoop(){if(this._progressLoop)return;let t=1/12;Dh&&(t=1/500,typeof Dh=="number"&&(t*=Dh)),this._progressLoop=setInterval(()=>{this.loadingProgress>=.95&&!Dh&&(t=.9),this._progress=N.lerp(this._progress,this.loadingProgress,t*this.loadingProgress),this.updateDisplay()},t)}onDoneLoading(){this._loadingElement&&(Ea&&console.log("Hiding loading element"),this._loadingElement.style.display="none",this._loadingElement.remove()),this._progressLoop&&clearInterval(this._progressLoop),this._progressLoop=null}updateDisplay(){const t=this._progress,e=(t*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=t*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=e)}createLoadingElement(t){var f,p;Ea&&!t&&console.log("Creating loading element"),this._loadingElement=t||document.createElement("div");let e=this._element.getAttribute("loading-style");(!e||e==="auto")&&(window.matchMedia("(prefers-color-scheme: dark)").matches?e="dark":e="light");const i=$o();if(!t){this._loadingElement.style.position="absolute",this._loadingElement.style.width="100%",this._loadingElement.style.height="100%",this._loadingElement.style.left="0",this._loadingElement.style.top="0";const g=this._element.getAttribute("loading-background");g?this._loadingElement.style.background=g:this._loadingElement.style.backgroundColor="transparent",this._loadingElement.style.display="flex",this._loadingElement.style.alignItems="center",this._loadingElement.style.justifyContent="center",this._loadingElement.style.zIndex="0",this._loadingElement.style.flexDirection="column",this._loadingElement.style.pointerEvents="none",this._loadingElement.style.color="white",this._loadingElement.style.fontFamily='system-ui, Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',this._loadingElement.style.fontSize="1rem",e==="light"?this._loadingElement.style.color="rgba(0,0,0,.6)":this._loadingElement.style.color="rgba(255,255,255,.3)"}const n=((f=this._loadingElementOptions)==null?void 0:f.className)??zp.LoadingContainerClassName;if(this._loadingElement.classList.add(n),(p=this._loadingElementOptions)!=null&&p.additionalClasses)for(const g of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(g);const o=document.createElement("div");this._loadingElement.appendChild(o);const r=document.createElement("img"),l=120;if(r.style.width=`${l}px`,r.style.height=`${l}px`,r.style.paddingTop="20px",r.style.paddingBottom="10px",r.style.margin="0px",r.style.userSelect="none",r.style.objectFit="contain",r.style.transition="transform 1.5s ease-out, opacity .3s ease-in-out",r.style.transform="translateY(30px)",r.style.opacity="0.05",setTimeout(()=>{r.style.opacity="1",r.style.transform="translateY(0px)"},1),r.src=tS,i&&this._element){const g=this._element.getAttribute("loading-logo-src");g&&(r.src=g)}o.appendChild(r);const c=document.createElement("div");c.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out 4s;
        `,setTimeout(()=>{c.style.opacity="1"},1),this._loadingElement.appendChild(c);const h=document.createElement("div"),d=100;h.style.display="flex",h.style.width=d+"%",h.style.height="3px",h.style.position="absolute",h.style.left="0",h.style.bottom="0px",h.style.opacity="0",h.style.transition="opacity 1s ease-in-out 2s",setTimeout(()=>{h.style.opacity="1"},1),e==="light"?h.style.backgroundColor="rgba(0,0,0,.2)":h.style.backgroundColor="rgba(255,255,255,.2)",this._loadingElement.appendChild(h),this._loadingBar=document.createElement("div"),h.appendChild(this._loadingBar);const u=function(g){return N.lerp(0,d,g)+"%"};if(this._loadingBar.style.background="#66A22F",this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",i&&this._element){const g=this._element.getAttribute("primary-color"),_=this._element.getAttribute("secondary-color");g&&_?this._loadingBar.style.background=`linear-gradient(90deg, ${g} ${u(0)}, ${_} ${u(1)})`:g?this._loadingBar.style.background=g:_&&(this._loadingBar.style.background=_)}return this.handleRuntimeLicense(this._loadingElement),this._loadingElement}async handleRuntimeLicense(t){let e=Wo();if(e)return;Pw&&console.log("Loading UI has commercial license?",e);const i=document.createElement("div");i.style.paddingTop=".6em",i.style.fontSize=".8em",i.style.textTransform="uppercase",i.innerText=`NEEDLE ENGINE NON COMMERCIAL VERSION
CLICK HERE TO GET A LICENSE`,i.style.cursor="pointer",i.style.userSelect="none",i.style.textAlign="center",i.style.pointerEvents="all",i.addEventListener("click",()=>window.open("https://needle.tools/pricing","_self")),i.style.opacity="0",t.appendChild(i),!U()&&Br&&(Pw&&console.log("Waiting for runtime license check"),await Br,e=Wo()),!e&&(i.style.transition="opacity .5s ease-in-out",i.style.opacity="1")}};let Bf=zp;a(Bf,"LoadingContainerClassName","loading");wS(vP);const Ue=S("debugwebcomponent"),Tw="needle-engine",TP="vr",OP="desktop",pL=[PP,TP,OP],jh="ar-session-active",Bh="desktop-session-active",mL=["public-key","version","hash","src","camera-controls","loadstart","progress","loadfinished","dracoDecoderPath","dracoDecoderType","ktx2DecoderPath","tone-mapping","tone-mapping-exposure","background-blurriness","background-color","environment-intensity"];class kP extends HTMLElement{constructor(){super();a(this,"_context");a(this,"_overlay_ar");a(this,"_loadingProgress01",0);a(this,"_loadingView");a(this,"_previousSrc",null);a(this,"_didFullyLoad",!1);a(this,"_loadId",0);a(this,"_abortController",null);a(this,"_lastSourceFiles",null);a(this,"_createContextPromise",null);a(this,"onXRSessionStarted",()=>{var i;const e=this.context.xrSessionMode;e==="immersive-ar"?this.onEnterAR(this.context.xrSession):e==="immersive-vr"&&this.onEnterVR(this.context.xrSession),(i=this.context.xrSession)==null||i.addEventListener("end",()=>{this.dispatchEvent(new CustomEvent("xr-session-ended",{detail:{session:this.context.xrSession,context:this._context,sessionMode:e}})),e==="immersive-ar"?this.onExitAR(this.context.xrSession):e==="immersive-vr"&&this.onExitVR(this.context.xrSession)})});a(this,"onReady",()=>{var e;return(e=this._loadingView)==null?void 0:e.onLoadingFinished()});a(this,"onError",()=>{var e;return(e=this._loadingView)==null?void 0:e.setMessage("Loading failed!")});a(this,"_previouslyRegisteredMap",new Map);this._overlay_ar=new fL,this.addEventListener("ready",this.onReady),t1(),this.attachShadow({mode:"open"});const e=document.createElement("template");e.innerHTML=`<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

    :host {
        position: absolute;
        display: block;
        width: max(600px, 100%);
        height: max(300px, 100%);
        touch-action: none;

        -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 600px) {
        :host {
            width: 100%;
        }
    }
    @media (max-height: 300px) {
        :host {
            height: 100%;
        }
    }

    :host > div.canvas-wrapper {
        width: 100%;
        height: 100%;
    }

    :host canvas {   
        position: absolute;
        user-select: none;
        -webkit-user-select: none;

        /** allow touch panning but no pinch zoom **/
        /** but this doesnt work yet: 
         * touch-action: pan-x, pan-y;
         **/
        
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
        -webkit-user-modify: none;

        left: 0;
        top: 0;
    }
    :host .content {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
        visibility: visible;
        z-index: 500; /* < must be less than the webxr buttons element */
        pointer-events: none;
    }
    :host .overlay-content {
        position: absolute;
        user-select: auto;
        pointer-events: all;
    }
    :host slot[name="quit-ar"]:hover {
        cursor: pointer;
    }
    :host .quit-ar-button {
        position: absolute;
        // top: env(titlebar-area-y); /** this doesnt work **/
        top: 60px; /** camera access needs a bit more space **/
        right: 20px;
        z-index: 9999;
    }
</style>
<div class="canvas-wrapper"> <!-- this wrapper is necessary for WebXR https://github.com/meta-quest/immersive-web-emulator/issues/55 -->
    <canvas></canvas>
</div>
<div class="content">
    <slot class="overlay-content"></slot>
</div>
`,this.shadowRoot&&this.shadowRoot.appendChild(e.content.cloneNode(!0)),this._context=new ne({domElement:this}),this.addEventListener("error",this.onError)}static get observedAttributes(){return mL}get loadingProgress01(){return this._loadingProgress01}get loadingFinished(){return this.loadingProgress01>.999}get cameraControls(){const e=this.getAttribute("camera-controls");return e==null?null:!(e===null||e==="False"||e==="false"||e==="0"||e==="none")}getContext(){return new Promise((e,i)=>{if(this._context&&this.loadingFinished)e(this._context);else{const n=()=>{this.removeEventListener("loadfinished",n),this._context&&this.loadingFinished&&e(this._context)};this.addEventListener("loadfinished",n)}})}get context(){return this._context}async connectedCallback(){if(Ue&&console.log("<needle-engine> connected"),this.setPublicKey(),this.setVersion(),(this.getAttribute("tabindex")===null||this.getAttribute("tabindex")===void 0)&&this.setAttribute("tabindex","0"),this.addEventListener("xr-session-started",this.onXRSessionStarted),this.onSetupDesktop(),!this.getAttribute("src")){const i=globalThis["needle:codegen_files"];Ue&&console.log('src is null, trying to load from globalThis["needle:codegen_files"]',i),i&&(Ue&&console.log('globalThis["needle:codegen_files"]',i),this.setAttribute("src",i))}Ue&&console.log("src",this.getAttribute("src"));const e=this._loadId;setTimeout(()=>{this.isConnected!==!1&&e===this._loadId&&this.onLoad()},1)}disconnectedCallback(){var n;this.removeEventListener("xr-session-started",this.onXRSessionStarted),this._didFullyLoad=!1;const e=this.getAttribute("keep-alive"),i=e==null||(e==null?void 0:e.length)>0&&e!=="true"&&e!=="1";Ue&&console.warn('<needle-engine> disconnected, keep-alive: "'+e+'"',typeof e,"Dispose=",i),i?(Ue&&console.warn("<needle-engine> dispose"),(n=this._context)==null||n.dispose(),this._context=null,this._lastSourceFiles=null,this._loadId+=1):Ue&&console.warn("<needle-engine> is not disposed because keep-alive is set")}attributeChangedCallback(e,i,n){switch(Ue&&console.log("attributeChangedCallback",e,i,n),e){case"src":Ue&&console.warn(`<needle-engine src>
changed from "`,i,'" to "',n,'"'),this.onLoad();break;case"hash":this._context&&(this._context.hash=n);break;case"loadstart":case"progress":case"loadfinished":typeof n=="string"&&n.length>0&&(Ue&&console.log(e+" attribute changed",n),this.registerEventFromAttribute(e,n));break;case"dracoDecoderPath":Ue&&console.log("dracoDecoderPath",n),_x(n);break;case"dracoDecoderType":n==="wasm"||n==="js"?(Ue&&console.log("dracoDecoderType",n),bx(n)):console.error("Invalid dracoDecoderType",n,"expected js or wasm");break;case"ktx2DecoderPath":Ue&&console.log("ktx2DecoderPath",n),vx(n);break;case"tonemapping":case"tone-mapping":case"tone-mapping-exposure":case"background-blurriness":case"background-color":case"environment-intensity":{this.applyAttributes();break}case"public-key":{n!=_f&&this.setPublicKey();break}case"version":{n!=as&&this.setVersion();break}}}get toneMapping(){return this.getAttribute("tonemapping")||this.getAttribute("tone-mapping")}async onLoad(){var _,y;if(!this.isConnected)return;if(this._context||(Ue&&console.warn("Create new context"),this._context=new ne({domElement:this})),!this._context){console.error("Needle Engine: Context not initialized");return}const e=this.getSourceFiles();if(!this.checkIfSourceHasChanged(e,this._lastSourceFiles))return;this._abortController&&(Ue&&console.warn("Abort previous loading process"),this._abortController.abort(),this._abortController=null),this._lastSourceFiles=e;const i=++this._loadId;if((e==null||e.length<=0)&&(Ue&&console.warn("Clear scene",e),this._context.clear(),i!==this._loadId))return;const n=this.getAttribute("alias");this.classList.add("loading");const o=Wo();this.ensureLoadStartIsRegistered();let r=this.dispatchEvent(new CustomEvent("loadstart",{detail:{context:this._context,alias:n},cancelable:!0}));if(o){const b=this.getAttribute("hide-loading-overlay");b!=null&&b!=="0"&&(r=!1)}r===!1&&!o&&(U()||(r=!0),console.warn("Needle Engine: You need a commercial license to override the default loading view. Visit https://needle.tools/pricing"),U()&&ke('You need a <a target="_blank" href="https://needle.tools/pricing">commercial license</a> to override the default loading view. This will not work in production.')),!this._loadingView&&r&&(this._loadingView=new Bf(this)),r&&(this._didFullyLoad!==!0?(_=this._loadingView)==null||_.onLoadingBegin("begin load"):setTimeout(()=>{this._loadingView&&this._loadingProgress01<.3&&this._loadId===i&&this._loadingView.onLoadingBegin("begin load")},300)),Ue&&console.warn(`--------------
Needle Engine: Begin loading `+i+`
`,e),this.onBeforeBeginLoading();const l=[],c={context:this._context,name:"",progress:{},index:0,count:e.length,totalProgress01:this._loadingProgress01},h=new CustomEvent("progress",{detail:c}),d=new Array,u=new AbortController;this._abortController=u;const f={files:e,abortSignal:u.signal,onLoadingProgress:b=>{var w;if(Ue&&console.debug("Loading progress: ",b),u.signal.aborted)return;const v=b.index;!d[v]&&b.name&&(d[v]=gL(b.name)),b.name=d[v],r&&((w=this._loadingView)==null||w.onLoadingUpdate(b)),c.name=b.name,c.progress=b.progress,this._loadingProgress01=RP(b),c.totalProgress01=this._loadingProgress01,this.dispatchEvent(h)},onLoadingFinished:(b,v,w)=>{Ue&&console.debug(`Finished loading "${v}" (aborted? ${u.signal.aborted})`),!u.signal.aborted&&w&&l.push({src:v,file:w})}};yL(this);const p=this.getAttribute("hash");p!=null&&(this._context.hash=p),this._context.alias=n,this._createContextPromise=this._context.create(f);const g=await this._createContextPromise;if(this.applyAttributes(),Ue&&console.warn(`--------------
Needle Engine: finished loading `+i+`
`,e,`Aborted? ${u.signal.aborted}`),u.signal.aborted){console.log("Loading finished but aborted...");return}if(this._loadId!==i){console.log("Load id changed during loading process");return}this._loadingProgress01=1,r&&g&&((y=this._loadingView)==null||y.onLoadingUpdate(1,"creating scene")),this._didFullyLoad=!0,this.classList.remove("loading"),this.classList.add("loading-finished"),this.dispatchEvent(new CustomEvent("loadfinished",{detail:{context:this._context,src:n,loadedFiles:l}}))}applyAttributes(){var o,r;if((o=this._context)!=null&&o.renderer){const l=e1(this.toneMapping);l!==void 0&&(this._context.renderer.toneMapping=l);const c=this.getAttribute("tone-mapping-exposure");if(c!=null){const h=parseFloat(c);isNaN(h)||(this._context.renderer.toneMappingExposure=h)}}const e=this.getAttribute("background-blurriness");if(e!=null){const l=parseFloat(e);!isNaN(l)&&this._context&&(this._context.scene.backgroundBlurriness=l)}const i=this.getAttribute("environment-intensity");if(i!=null&&this._context){const l=parseFloat(i);!isNaN(l)&&this._context&&(this._context.scene.environmentIntensity=l)}const n=this.getAttribute("background-color");if((r=this._context)!=null&&r.renderer&&typeof n=="string"&&n.length>0){const l=pe.fromColorRepresentation(n);Ue&&console.debug("<needle-engine> background-color changed, str:",n,"â†’",l),this._context.renderer.setClearColor(l,l.alpha),this.context.scene.background=null}}getSourceFiles(){const e=this.getAttribute("src");if(!e)return[];let i;Array.isArray(e)?i=e:e.startsWith("[")&&e.endsWith("]")?i=JSON.parse(e):e.includes(",")?i=e.split(","):i=[e];for(let n=i.length-1;n>=0;n--){const o=i[n];(o==="null"||o==="undefined"||(o==null?void 0:o.length)<=0)&&i.splice(n,1)}return i}checkIfSourceHasChanged(e,i){if((e==null?void 0:e.length)!==(i==null?void 0:i.length)||e==null&&i!==null||e!==null&&i==null)return!0;if(e!==null&&i!==null){for(let n=0;n<(e==null?void 0:e.length);n++)if(e[n]!==i[n])return!0}return!1}ensureLoadStartIsRegistered(){const e=this.getAttribute("loadstart");e&&this.registerEventFromAttribute("loadstart",e)}registerEventFromAttribute(e,i){const n=this._previouslyRegisteredMap.get(e);if(n&&(this._previouslyRegisteredMap.delete(e),this.removeEventListener(e,n)),typeof i=="string"&&i.length>0)try{const o=(0,eval)(i);typeof o=="function"&&(this._previouslyRegisteredMap.set(e,o),this.addEventListener(e,r=>o==null?void 0:o.call(globalThis,this._context,r)))}catch(o){console.error("Error registering event "+e+'="'+i+`" failed with the following error:
`,o)}}setPublicKey(){_f.length>0&&this.setAttribute("public-key",_f)}setVersion(){as.length>0&&this.setAttribute("version",as)}getAROverlayContainer(){return this._overlay_ar.createOverlayContainer(this)}getVROverlayContainer(){for(let e=0;e<this.children.length;e++){const i=this.children[e];if(i.classList.contains("vr"))return i}return null}onEnterAR(e){var n;this.onSetupAR();const i=this.getAROverlayContainer();this._overlay_ar.onBegin(this._context,i,e),this.dispatchEvent(new CustomEvent("enter-ar",{detail:{session:e,context:this._context,htmlContainer:(n=this._overlay_ar)==null?void 0:n.ARContainer}}))}onExitAR(e){var i;this._overlay_ar.onEnd(this._context),this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-ar",{detail:{session:e,context:this._context,htmlContainer:(i=this._overlay_ar)==null?void 0:i.ARContainer}}))}onEnterVR(e){this.onSetupVR(),this.dispatchEvent(new CustomEvent("enter-vr",{detail:{session:e,context:this._context}}))}onExitVR(e){this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-vr",{detail:{session:e,context:this._context}}))}onSetupAR(){this.classList.add(jh),this.classList.remove(Bh);const e=this.getAROverlayContainer();Ue&&console.warn("onSetupAR:",e),e&&(e.classList.add(jh),e.classList.remove(Bh)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,PP))}onSetupVR(){this.classList.remove(jh),this.classList.remove(Bh),this.foreachHtmlElement(e=>this.setupElementsForMode(e,TP))}onSetupDesktop(){this.classList.remove(jh),this.classList.add(Bh);const e=this.getAROverlayContainer();e&&(e.classList.remove(jh),e.classList.add(Bh)),this.foreachHtmlElement(i=>this.setupElementsForMode(i,OP))}setupElementsForMode(e,i,n=null){var r,l;if(e===((l=(r=this._context)==null?void 0:r.renderer)==null?void 0:l.domElement)||e.id==="VRButton"||e.id==="ARButton")return;if(e.classList.contains(i))e.style.visibility="visible",e.style.display==="none"&&(e.style.display="block");else for(const c of pL)e.classList.contains(c)&&(e.style.visibility="hidden",e.style.display="none")}foreachHtmlElement(e){for(let i=0;i<this.children.length;i++){const n=this.children[i];n.style&&e(n)}}onBeforeBeginLoading(){const e=this.getAttribute("dracoDecoderPath");e&&(Ue&&console.log("using custom draco decoder path",e),_x(e));const i=this.getAttribute("dracoDecoderType");i&&(Ue&&console.log("using custom draco decoder type",i),bx(i));const n=this.getAttribute("ktx2DecoderPath");n&&(Ue&&console.log("using custom ktx2 decoder path",n),vx(n))}}typeof window<"u"&&!window.customElements.get(Tw)&&window.customElements.define(Tw,kP);function gL(s){if(s.startsWith("blob:"))return"blob";const t=s.split("/");let e=t[t.length-1];const i=e.indexOf("?");i>0&&(e=e.substring(0,i));const n=e.indexOf("=");n>0&&(e=e.substring(n));const o=e.split(".").pop(),l=o?["glb","gltf","usdz","usd","fbx","obj","mtl"].indexOf(o.toLowerCase()):-1;if(o&&l>=0&&(e=e.substring(0,e.length-o.length-1)),e=decodeURIComponent(e),e.length>3){let c="",h=!1;const d=["(",")","[","]","{","}",":",";",",",".","!","?"];for(let u=0;u<e.length;u++){let f=e[u];(f==="_"||f==="-")&&(f=" "),!(f===" "&&c.length<=0||d.includes(f)||(c.length===0&&(f=f.toUpperCase()),h&&f===" "))&&(h&&(f=f.toUpperCase()),h=!1,c+=f,f===" "&&(h=!0))}return U()&&e!==c&&console.debug('Generated display name: "'+e+'" â†’ "'+c+'"'),c.trim()}return U()&&console.debug("Loading: use default name",e),e}function yL(s){um(t=>{var i;const e=s.getAttribute("loading-blur");if(e!==null&&e!=="0"&&t.domElement===s){const n=(i=t.lodsManager.manager)==null?void 0:i.awaitLoading({frames:5,signal:AbortSignal.timeout(1e4),maxPromisesPerObject:1}).catch(l=>{});let o="20px";e.endsWith("px")&&(o=e);const r=170;if(t.scene.background===null){const l=s,c=t.renderer.domElement,h=c.style.filter,d=c.style.overflow;c.style.filter+=`blur(${o})`,l.style.overflow="hidden",n==null||n.then(()=>{const u=c.animate([{filter:"blur(0px)"}],{duration:r,easing:"ease-in"});u.onfinish=()=>{c.style.filter=h,l.style.overflow=d}})}else{const l=document.createElement("div");t.domElement.prepend(l),l.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none",l.style.backdropFilter=`blur(${o})`,n==null||n.then(()=>{const c=l.animate([{backdropFilter:"blur(0px)",opacity:0}],{duration:r,easing:"ease-in"});c.onfinish=()=>{l.remove()}})}}},{once:!0})}const _L=Object.freeze(Object.defineProperty({__proto__:null,NeedleEngineWebComponent:kP},Symbol.toStringTag,{value:"Module"}));function bL(){ls.registerWaitForInteraction(()=>{const s=KR.getContext();s.addEventListener("statechange",()=>{setTimeout(()=>{const t=s.state;(t==="suspended"||t==="interrupted")&&s.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(e=>{console.log("Failed to resume AudioContext: "+e)})},500)})})}setTimeout(bL,1e3);const dt=S("debugphysics"),Cy=S("debugcolliderplacement"),Py=S("debugcollisions"),vL=S("showcolliders"),gf=S("debugraycasts"),$i=Symbol("needle component"),Pi=Symbol("physics body"),Ow=Symbol("rigidbody");globalThis.true=globalThis.true!==void 0?globalThis.true:!0;dt&&console.log("Use Rapier",!0,globalThis.true);ve.registerCallback(ge.ContextCreationStart,s=>{dt&&console.log("Register rapier physics backend"),s.context.physics.engine=new Ca(s.context)});const jd=class{constructor(t){a(this,"debugRenderColliders",!1);a(this,"debugRenderRaycasts",!1);a(this,"context");a(this,"_initializePromise");a(this,"_isInitialized",!1);a(this,"rapierRay");a(this,"raycastVectorsBuffer",new $n(()=>new x,10));a(this,"rapierSphere",null);a(this,"rapierBox",null);a(this,"rapierColliderArray",[]);a(this,"rapierIdentityRotation",{x:0,y:0,z:0,w:1});a(this,"rapierForwardVector",{x:0,y:0,z:1});a(this,"enabled",!1);a(this,"_tempPosition",new x);a(this,"_tempQuaternion",new H);a(this,"_tempScale",new x);a(this,"_tempMatrix",new ce);a(this,"_isUpdatingPhysicsWorld",!1);a(this,"_world");a(this,"_hasCreatedWorld",!1);a(this,"eventQueue");a(this,"collisionHandler");a(this,"objects",[]);a(this,"bodies",[]);a(this,"_meshCache",new Map);a(this,"_gravity",{x:0,y:-9.81,z:0});a(this,"lines");a(this,"_tempCenterPos",new x);a(this,"_tempCenterVec",new x);a(this,"_tempCenterQuaternion",new H);this.context=t}removeBody(t){var i,n,o;if(!t)return;this.validate();const e=t[Pi];if(t[Pi]=null,e&&this.world){const r=this.objects.findIndex(l=>l===t);if(r>=0){const l=this.bodies[r];if(this.bodies.splice(r,1),this.objects.splice(r,1),l instanceof F.RAPIER_PHYSICS.MODULE.Collider){const c=l;(i=this.world)==null||i.removeCollider(c,!0);const h=c.parent();h&&h.numColliders()<=0&&(h[$i]||(n=this.world)==null||n.removeRigidBody(h))}else l instanceof F.RAPIER_PHYSICS.MODULE.RigidBody&&(l.numColliders()<=0?(o=this.world)==null||o.removeRigidBody(l):U()&&(l.did_log_removing||setTimeout(()=>{l.numColliders()>0&&(l.did_log_removing=!0,console.warn("RapierPhysics: removing rigidbody with colliders from the physics world is not possible right now, please remove the colliders first"))},1)))}}}updateBody(t,e,i){if(this.validate(),!!this.enabled&&!(t.destroyed||!t.gameObject)&&!(!e&&!i))if(t.isCollider===!0)console.warn("TODO: implement updating collider position");else{const n=t,o=n[Pi];o&&this.syncPhysicsBody(n.gameObject,o,e,i)}}updateProperties(t){if(this.validate(),t.isCollider){const e=t,i=e[Pi];i&&(this.internalUpdateColliderProperties(e,i),e.sharedMaterial&&this.updatePhysicsMaterial(e))}else{const e=t,i=this.internal_getRigidbody(e);i&&this.internalUpdateRigidbodyProperties(e,i)}}addForce(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.addForce(e,i):this._isInitialized&&console.warn("Physics Body doesn't exist: can not apply force (does your object with the Rigidbody have a collider?)")}addImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):this._isInitialized&&console.warn("Physics Body doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}getLinearVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.linvel():null}getAngularVelocity(t){this.validate();const e=this.internal_getRigidbody(t);return e?e.angvel():null}resetForces(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetForces(e)}resetTorques(t,e){this.validate();const i=this.internal_getRigidbody(t);i==null||i.resetTorques(e)}applyImpulse(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.applyImpulse(e,i):this._isInitialized&&console.warn("Rigidbody doesn't exist: can not apply impulse (does your object with the Rigidbody have a collider?)")}wakeup(t){this.validate();const e=this.internal_getRigidbody(t);e?e.wakeUp():this._isInitialized&&console.warn("Rigidbody doesn't exist: can not wake up (does your object with the Rigidbody have a collider?)")}isSleeping(t){this.validate();const e=this.internal_getRigidbody(t);return e==null?void 0:e.isSleeping()}setAngularVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setAngvel(e,i):this._isInitialized&&console.warn("Rigidbody doesn't exist: can not set angular velocity (does your object with the Rigidbody have a collider?)")}setLinearVelocity(t,e,i){this.validate();const n=this.internal_getRigidbody(t);n?n.setLinvel(e,i):this._isInitialized&&console.warn("Rigidbody doesn't exist: can not set linear velocity (does your object with the Rigidbody have a collider?)")}get isInitialized(){return this._isInitialized}async initialize(){return this._initializePromise||(this._initializePromise=this.internalInitialization()),this._initializePromise}async internalInitialization(){return S("__nophysics")?(console.warn("Physics are disabled"),!1):(dt&&console.log("Initialize rapier physics engine"),"env"in import.meta&&{}.VITE_NEEDLE_USE_RAPIER==="false"?(dt&&console.log("Rapier disabled"),!1):this._hasCreatedWorld?(console.error("Invalid call to create physics world: world is already created"),!0):(this._hasCreatedWorld=!0,F.RAPIER_PHYSICS.MAYBEMODULE==null&&(dt&&console.trace("Loading rapier physics engine"),await(await F.RAPIER_PHYSICS.load()).init()),dt&&console.log("Physics engine initialized, creating world..."),this._world=new F.RAPIER_PHYSICS.MODULE.World(this._gravity),this.rapierRay=new F.RAPIER_PHYSICS.MODULE.Ray({x:0,y:0,z:0},{x:0,y:0,z:1}),this.enabled=!0,this._isInitialized=!0,dt&&console.log("Physics world created"),!0))}validate(){this._isInitialized||dt&&(this._lastWarnTime=this._lastWarnTime??0,Date.now()-this._lastWarnTime>1e3&&(this._lastWarnTime=Date.now(),console.warn("Physics engine is not initialized")))}raycast(t,e,i){var c;if(!this._isInitialized)return console.log("Physics engine is not initialized"),null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const r=this.getPhysicsRay(this.rapierRay,t,e);if(!r)return null;(this.debugRenderRaycasts||gf)&&G.DrawRay(r.origin,r.dir,255,1);const l=(c=this.world)==null?void 0:c.castRay(r,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,h=>{const d=h[$i];return i!=null&&i.filterPredicate?i.filterPredicate(d):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(l){const h=r.pointAt(l.timeOfImpact),d=this.raycastVectorsBuffer.get();return d.set(h.x,h.y,h.z),{point:d,collider:l.collider[$i]}}return null}raycastAndGetNormal(t,e,i){var c;if(!this._isInitialized)return null;let n=i==null?void 0:i.maxDistance,o=i==null?void 0:i.solid;n===void 0&&(n=1/0),o===void 0&&(o=!0);const r=this.getPhysicsRay(this.rapierRay,t,e);if(!r)return null;(this.debugRenderRaycasts||gf)&&G.DrawRay(r.origin,r.dir,255,1);const l=(c=this.world)==null?void 0:c.castRayAndGetNormal(r,n,o,i==null?void 0:i.queryFilterFlags,i==null?void 0:i.filterGroups,void 0,void 0,h=>{const d=h[$i];return i!=null&&i.filterPredicate?i.filterPredicate(d):(i==null?void 0:i.useIgnoreRaycastLayer)!==!1?!(d!=null&&d.gameObject.layers.isEnabled(2)):!0});if(l){const h=r.pointAt(l.timeOfImpact),d=l.normal,u=this.raycastVectorsBuffer.get(),f=this.raycastVectorsBuffer.get();return u.set(h.x,h.y,h.z),f.set(d.x,d.y,d.z),{point:u,normal:f,collider:l.collider[$i]}}return null}getPhysicsRay(t,e,i){var l,c,h;const n=(l=this.context)==null?void 0:l.mainCamera;if(e===void 0){const d=(c=this.context)==null?void 0:c.input.getPointerPosition(0);if(d)e=d;else return null}if(e.z===void 0){if(!n)return console.error("Can not perform raycast from 2d point - no main camera found"),null;const d=this.raycastVectorsBuffer.get();d.x=e.x,d.y=e.y,d.z=0,(d.x>1||d.y>1||d.y<-1||d.x<-1)&&(dt&&console.warn("Converting screenspace to raycast space",d),(h=this.context)==null||h.input.convertScreenspaceToRaycastSpace(d)),d.unproject(n),e=d}const o=e;t.origin.x=o.x,t.origin.y=o.y,t.origin.z=o.z;const r=this.raycastVectorsBuffer.get();if(i)r.set(i.x,i.y,i.z);else{if(!n)return console.error("Can not perform raycast - no camera found"),null;r.set(t.origin.x,t.origin.y,t.origin.z);const d=ae(n);r.sub(d)}return r.normalize(),t.dir.x=r.x,t.dir.y=r.y,t.dir.z=r.z,t}sphereOverlap(t,e){return this.rapierSphere??(this.rapierSphere=new F.RAPIER_PHYSICS.MODULE.Ball(e)),this.rapierSphere.radius=e,(this.debugRenderRaycasts||gf)&&G.DrawWireSphere(t,e,3359999,1),this.shapeOverlap(t,this.rapierIdentityRotation,this.rapierSphere)}boxOverlap(t,e,i=null){return i===null&&(i=this.rapierIdentityRotation),this.rapierBox??(this.rapierBox=new F.RAPIER_PHYSICS.MODULE.Cuboid(1,1,1)),this.rapierBox.halfExtents.x=e.x*.5,this.rapierBox.halfExtents.y=e.y*.5,this.rapierBox.halfExtents.z=e.z*.5,(this.debugRenderRaycasts||gf)&&G.DrawWireBox(t,e,3359999,1,!0,i),this.shapeOverlap(t,i,this.rapierBox)}shapeOverlap(t,e,i){return this.rapierColliderArray.length=0,this._isInitialized?this.world?(this.world.intersectionsWithShape(t,e,i,n=>{const o=n[$i],r=new ZA(o.gameObject,o);return this.rapierColliderArray.push(r),!0},void 0,void 0,void 0,void 0,n=>n.isSensor()?!1:n[$i].gameObject.layers.isEnabled(2)==!1),this.rapierColliderArray):this.rapierColliderArray:this.rapierColliderArray}get world(){return this._world}get isUpdating(){return this._isUpdatingPhysicsWorld}get gravity(){var t;return((t=this.world)==null?void 0:t.gravity)??this._gravity}set gravity(t){this.world?this.world.gravity=t:this._gravity=t}clearCaches(){var t,e,i,n;this._meshCache.clear(),(t=this.eventQueue)!=null&&t.raw&&((e=this.eventQueue)==null||e.free()),(i=this.world)!=null&&i.bodies&&((n=this.world)==null||n.free())}async addBoxCollider(t,e){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){dt&&console.warn("Physics are disabled");return}const i=t.gameObject,n=_t(i,this._tempPosition).multiply(e);n.multiplyScalar(.5),n.x<0&&(n.x=Math.abs(n.x)),n.y<0&&(n.y=Math.abs(n.y)),n.z<0&&(n.z=Math.abs(n.z));const o=1e-7;n.x<o&&(n.x=o),n.y<o&&(n.y=o),n.z<o&&(n.z=o);const r=F.RAPIER_PHYSICS.MODULE.ColliderDesc.cuboid(n.x,n.y,n.z);this.createCollider(t,r)}async addSphereCollider(t){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){dt&&console.warn("Physics are disabled");return}const e=F.RAPIER_PHYSICS.MODULE.ColliderDesc.ball(.5);this.createCollider(t,e),this.updateProperties(t)}async addCapsuleCollider(t,e,i){if(this._isInitialized||await this.initialize(),!t.activeAndEnabled)return;if(!this.enabled){dt&&console.warn("Physics are disabled");return}const o=t.gameObject.worldScale;o.x=Math.abs(o.x),o.y=Math.abs(o.y);const r=i*o.x;e=Math.max(e,r);const l=N.clamp(e*.5*o.y-i*o.x,0,Number.MAX_SAFE_INTEGER),c=F.RAPIER_PHYSICS.MODULE.ColliderDesc.capsule(l,r);this.createCollider(t,c)}async addMeshCollider(t,e,i,n){var u,f,p;let o=e.geometry;if(!o){dt&&console.warn("Missing mesh geometry",e.name);return}(f=(u=o.index)==null?void 0:u.array)!=null&&f.length||(console.warn(`Your MeshCollider is missing vertices or indices in the assined mesh "${e.name}". Consider providing an indexed geometry.`),o=vT(o));let r=null;const l=o.getAttribute("position");if(l instanceof zw){const g=l.count;r=new Float32Array(g*3);for(let _=0;_<g;_++){const y=l.getX(_),b=l.getY(_),v=l.getZ(_);r[_*3]=y,r[_*3+1]=b,r[_*3+2]=v}}else r=l.array;if(await this.initialize(),!this.enabled){dt&&console.warn("Physics are disabled");return}if(!t.activeAndEnabled)return;const c=(p=o.index)==null?void 0:p.array,h=t.gameObject.worldScale.clone();if(n&&h.multiply(n),Math.abs(h.x-1)>1e-4||Math.abs(h.y-1)>1e-4||Math.abs(h.z-1)>1e-4){const g=`${o.uuid}_${h.x}_${h.y}_${h.z}_${i}`;if(this._meshCache.has(g))dt&&console.warn("Use cached mesh collider"),r=this._meshCache.get(g);else{(dt||U())&&console.debug(`[Performance] Your MeshCollider "${t.name}" is scaled: consider applying the scale to the collider mesh instead (${h.x}, ${h.y}, ${h.z})`);const _=new Float32Array(r.length);for(let y=0;y<r.length;y+=3)_[y]=r[y]*h.x,_[y+1]=r[y+1]*h.y,_[y+2]=r[y+2]*h.z;r=_,this._meshCache.set(g,_)}}const d=i?F.RAPIER_PHYSICS.MODULE.ColliderDesc.convexHull(r):F.RAPIER_PHYSICS.MODULE.ColliderDesc.trimesh(r,c);d&&this.createCollider(t,d)}updatePhysicsMaterial(t){if(!t)return;const e=t.sharedMaterial,i=t[Pi];if(i&&e){if(e.bounciness!==void 0&&i.setRestitution(e.bounciness),e.bounceCombine!==void 0)switch(e.bounceCombine){case Ot.Average:i.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Ot.Maximum:i.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Ot.Minimum:i.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Ot.Multiply:i.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(e.dynamicFriction!==void 0&&i.setFriction(e.dynamicFriction),e.frictionCombine!==void 0)switch(e.frictionCombine){case Ot.Average:i.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Ot.Maximum:i.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Ot.Minimum:i.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Ot.Multiply:i.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}}getBody(t){return t?t[Pi]:null}getComponent(t){return t?t[$i]:null}createCollider(t,e){var r;if(!this.world)throw new Error("Physics world not initialized");const i=this._tempMatrix;let n;t.attachedRigidbody?n=this.getRigidbody(t,this._tempMatrix):(dt&&console.log("Create collider without rigidbody",t.name),i.makeRotationFromQuaternion(Le(t.gameObject)),i.setPosition(ae(t.gameObject))),i.decompose(this._tempPosition,this._tempQuaternion,this._tempScale),this.tryApplyCenter(t,this._tempPosition),e.setTranslation(this._tempPosition.x,this._tempPosition.y,this._tempPosition.z),e.setRotation(this._tempQuaternion),e.setSensor(t.isTrigger);const o=t.sharedMaterial;if(o){if(o.bounciness!==void 0&&e.setRestitution(o.bounciness),o.bounceCombine!==void 0)switch(o.bounceCombine){case Ot.Average:e.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Ot.Maximum:e.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Ot.Minimum:e.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Ot.Multiply:e.setRestitutionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}if(o.dynamicFriction!==void 0&&e.setFriction(o.dynamicFriction),o.frictionCombine!==void 0)switch(o.frictionCombine){case Ot.Average:e.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Average);break;case Ot.Maximum:e.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Max);break;case Ot.Minimum:e.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Min);break;case Ot.Multiply:e.setFrictionCombineRule(F.RAPIER_PHYSICS.MODULE.CoefficientCombineRule.Multiply);break}}((r=t.attachedRigidbody)==null?void 0:r.autoMass)===!1&&(e.setDensity(1e-6),e.setMass(1e-6));try{const l=this.world.createCollider(e,n);return l[$i]=t,t[Pi]=l,l.setActiveEvents(F.RAPIER_PHYSICS.MODULE.ActiveEvents.COLLISION_EVENTS),l.setActiveCollisionTypes(F.RAPIER_PHYSICS.MODULE.ActiveCollisionTypes.ALL),this.objects.push(t),this.bodies.push(l),this.updateColliderCollisionGroups(t),l}catch(l){return console.error('Error creating collider "'+t.name+`"
Error:`,l),null}}updateColliderCollisionGroups(t){const e=t[Pi],i=t.membership;let n=0;if(i==null)n=65535;else for(let l=0;l<i.length;l++){const c=i[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):n|=1<<Math.floor(c)}const o=t.filter;let r=0;if(o==null)r=65535;else for(let l=0;l<o.length;l++){const c=o[l];c>31?console.error(`Rapier only supports 32 layers, layer ${c} is not supported`):r|=1<<Math.floor(c)}e.setCollisionGroups(n<<16|r)}getRigidbody(t,e){if(!this.world)throw new Error("Physics world not initialized");let i=null;if(t.attachedRigidbody){const n=t.attachedRigidbody;if(i=n[Pi],!i){const o=n.isKinematic&&!Cy;dt&&console.log("Create rigidbody",o);const r=o?F.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased():F.RAPIER_PHYSICS.MODULE.RigidBodyDesc.dynamic(),l=ae(t.attachedRigidbody.gameObject);r.setTranslation(l.x,l.y,l.z),r.setRotation(Le(t.attachedRigidbody.gameObject)),r.centerOfMass=new F.RAPIER_PHYSICS.MODULE.Vector3(n.centerOfMass.x,n.centerOfMass.y,n.centerOfMass.z),i=this.world.createRigidBody(r),this.bodies.push(i),this.objects.push(n)}i[$i]=n,n[Pi]=i,this.internalUpdateRigidbodyProperties(n,i),this.getRigidbodyRelativeMatrix(t.gameObject,n.gameObject,e),t[Ow]=i}else{const n=F.RAPIER_PHYSICS.MODULE.RigidBodyDesc.kinematicPositionBased(),o=ae(t.gameObject);n.setTranslation(o.x,o.y,o.z),n.setRotation(Le(t.gameObject)),i=this.world.createRigidBody(n),e.identity(),i[$i]=null}return i}internal_getRigidbody(t){return t.isCollider===!0?t[Ow]:t[Pi]}internalUpdateColliderProperties(t,e){const i=e.shape;let n=!1;switch(i.type){case F.RAPIER_PHYSICS.MODULE.ShapeType.Ball:{const f=i,p=t,g=t.gameObject,_=_t(g,this._tempPosition),y=Math.abs(p.radius*_.x);n=f.radius!==y,f.radius=y,n&&e.setShape(f);break}case F.RAPIER_PHYSICS.MODULE.ShapeType.Cuboid:const o=i,r=t,l=t.gameObject,c=_t(l,this._tempPosition),h=Math.abs(r.size.x*.5*c.x),d=Math.abs(r.size.y*.5*c.y),u=Math.abs(r.size.z*.5*c.z);n=o.halfExtents.x!==h||o.halfExtents.y!==d||o.halfExtents.z!==u,o.halfExtents.x=h,o.halfExtents.y=d,o.halfExtents.z=u,n&&e.setShape(o);break}if(n){const o=t.attachedRigidbody;if(o!=null&&o.autoMass){const r=this.getBody(o);r==null||r.recomputeMassPropertiesFromColliders()}}this.updateColliderCollisionGroups(t),t.isTrigger!==e.isSensor()&&e.setSensor(t.isTrigger)}internalUpdateRigidbodyProperties(t,e){if(e.enableCcd(t.collisionDetectionMode!==op.Discrete),e.setLinearDamping(t.drag),e.setAngularDamping(t.angularDrag),e.setGravityScale(t.useGravity?t.gravityScale:0,!0),t.dominanceGroup<=127&&t.dominanceGroup>=-127?e.setDominanceGroup(Math.floor(t.dominanceGroup)):e.setDominanceGroup(0),t.autoMass){e.setAdditionalMass(0,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1);e.recomputeMassPropertiesFromColliders()}else{e.setAdditionalMass(t.mass,!1);for(let i=0;i<e.numColliders();i++)e.collider(i).setDensity(1e-7);e.recomputeMassPropertiesFromColliders()}e.setEnabledRotations(!t.lockRotationX,!t.lockRotationY,!t.lockRotationZ,!1),e.setEnabledTranslations(!t.lockPositionX,!t.lockPositionY,!t.lockPositionZ,!1),t.isKinematic?e.setBodyType(F.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased,!1):e.setBodyType(F.RAPIER_PHYSICS.MODULE.RigidBodyType.Dynamic,!1)}step(t){if(this.world&&this.enabled){if(this._isUpdatingPhysicsWorld=!0,this.eventQueue||(this.eventQueue=new F.RAPIER_PHYSICS.MODULE.EventQueue(!1)),t===void 0||t<=0){this._isUpdatingPhysicsWorld=!1;return}else if(t!==void 0){const e=N.lerp(this.world.timestep,t,.8);this.world.timestep=e}try{this.world.step(this.eventQueue)}catch(e){console.warn("Error running physics step",{timestep:this.world.timestep},e)}this._isUpdatingPhysicsWorld=!1}}postStep(){this.world&&this.enabled&&(this._isUpdatingPhysicsWorld=!0,this.syncObjects(),this._isUpdatingPhysicsWorld=!1,this.eventQueue&&!this.collisionHandler&&(this.collisionHandler=new xL(this.world,this.eventQueue)),this.collisionHandler&&(this.collisionHandler.handleCollisionEvents(),this.collisionHandler.update()),this.updateDebugRendering(this.world))}updateDebugRendering(t){var e,i,n,o;if(dt||Cy||vL||this.debugRenderColliders===!0){if(!this.lines){const l=new Q_({color:7855479,fog:!1}),c=new os;this.lines=new Fw(c,l),this.lines.layers.disableAll(),this.lines.layers.enable(2)}this.lines.parent!==((e=this.context)==null?void 0:e.scene)&&((i=this.context)==null||i.scene.add(this.lines));const r=t.debugRender();this.lines.geometry.setAttribute("position",new Hi(r.vertices,3)),this.lines.geometry.setAttribute("color",new Hi(r.colors,4)),(this.context.time.frame%30===0||((n=this.lines.geometry.boundingSphere)==null?void 0:n.radius)===0)&&this.lines.geometry.computeBoundingSphere()}else this.lines&&((o=this.context)==null||o.scene.remove(this.lines))}syncObjects(){if(!Cy)for(let t=0;t<this.bodies.length;t++){const e=this.objects[t],i=this.bodies[t],n=e;if((n==null?void 0:n.isCollider)===!0&&!n.attachedRigidbody){const c=i.parent();c?this.syncPhysicsBody(e.gameObject,c,!0,!0):this.syncPhysicsBody(e.gameObject,i,!0,!0);continue}const o=i.translation(),r=i.rotation();if(Number.isNaN(o.x)||Number.isNaN(r.x)){!n.__COLLIDER_NAN&&U()&&(console.warn("Collider has NaN values",n.name,n.gameObject,i),n.__COLLIDER_NAN=!0);continue}const l=e.center;if(l&&l.isVector3){this._tempQuaternion.set(r.x,r.y,r.z,r.w);const c=this._tempPosition.copy(l).applyQuaternion(this._tempQuaternion),h=_t(e.gameObject);c.multiply(h),o.x-=c.x,o.y-=c.y,o.z-=c.z}Cc(e.gameObject,o.x,o.y,o.z),dS(e.gameObject,r.x,r.y,r.z,r.w)}}syncPhysicsBody(t,e,i,n){if(e instanceof F.RAPIER_PHYSICS.MODULE.RigidBody){const o=ae(t,this._tempPosition),r=Le(t,this._tempQuaternion);switch(e.bodyType()){case F.RAPIER_PHYSICS.MODULE.RigidBodyType.Fixed:case F.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicPositionBased:case F.RAPIER_PHYSICS.MODULE.RigidBodyType.KinematicVelocityBased:i&&e.setNextKinematicTranslation(o),n&&e.setNextKinematicRotation(r);break;default:i&&e.setTranslation(o,!1),n&&e.setRotation(r,!1);break}}else if(e instanceof F.RAPIER_PHYSICS.MODULE.Collider){t.matrixWorldNeedsUpdate&&t.updateWorldMatrix(!0,!1),t.matrixWorld.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=this._tempPosition,r=this._tempQuaternion,l=e[$i];if(this.tryApplyCenter(l,o),i){const c=e.translation();(c.x!==o.x||c.y!==o.y||c.z!==o.z)&&e.setTranslation(o)}if(n){const c=e.rotation();(c.x!==r.x||c.y!==r.y||c.z!==r.z||c.w!==r.w)&&e.setRotation(r)}}}tryApplyCenter(t,e){const i=t.center;i&&t.gameObject&&(i.x!==0||i.y!==0||i.z!==0)&&(this._tempCenterPos.x=i.x,this._tempCenterPos.y=i.y,this._tempCenterPos.z=i.z,_t(t.gameObject,this._tempCenterVec),this._tempCenterPos.multiply(this._tempCenterVec),t.attachedRigidbody?this._tempCenterPos.applyQuaternion(t.gameObject.quaternion):(Le(t.gameObject,this._tempCenterQuaternion),this._tempCenterPos.applyQuaternion(this._tempCenterQuaternion)),e.x+=this._tempCenterPos.x,e.y+=this._tempCenterPos.y,e.z+=this._tempCenterPos.z)}getRigidbodyRelativeMatrix(t,e,i,n){if(n===void 0&&(n=jd._matricesBuffer,n.length=0),t===e){const o=_t(t,this._tempPosition);i.makeScale(o.x,o.y,o.z);for(let r=n.length-1;r>=0;r--)i.multiply(n[r]);return i}return n.push(t.matrix),t.parent&&this.getRigidbodyRelativeMatrix(t.parent,e,i,n),i}addFixedJoint(t,e){if(!this.world){console.error("Physics world not initialized");return}const i=t[Pi],n=e[Pi];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const o=F.RAPIER_PHYSICS.MODULE.JointData.fixed(jd.centerConnectionPos,jd.centerConnectionRot,this._tempPosition,this._tempQuaternion),r=this.world.createImpulseJoint(o,i,n,!0);dt&&console.log("ADD FIXED JOINT",r)}addHingeJoint(t,e,i,n){if(!this.world){console.error("Physics world not initialized");return}const o=t[Pi],r=e[Pi];this.calculateJointRelativeMatrices(t.gameObject,e.gameObject,this._tempMatrix),this._tempMatrix.decompose(this._tempPosition,this._tempQuaternion,this._tempScale);const l=F.RAPIER_PHYSICS.MODULE.JointData.revolute(i,this._tempPosition,n),c=this.world.createImpulseJoint(l,o,r,!0);dt&&console.log("ADD HINGE JOINT",c)}calculateJointRelativeMatrices(t,e,i){t.updateWorldMatrix(!0,!1),e.updateWorldMatrix(!0,!1);const n=t.matrixWorld,o=e.matrixWorld;n.elements[0]=1,n.elements[5]=1,n.elements[10]=1,o.elements[0]=1,o.elements[5]=1,o.elements[10]=1,i.copy(o).premultiply(n.invert()).invert()}};let Ca=jd;a(Ca,"_didLoadPhysicsEngine",!1),a(Ca,"_matricesBuffer",[]),a(Ca,"centerConnectionPos",{x:0,y:0,z:0}),a(Ca,"centerConnectionRot",{x:0,y:0,z:0,w:1});class xL{constructor(t,e){a(this,"world");a(this,"eventQueue");a(this,"activeCollisions",[]);a(this,"activeCollisionsStay",[]);a(this,"activeTriggers",[]);this.world=t,this.eventQueue=e}handleCollisionEvents(){this.eventQueue&&this.world&&this.eventQueue.drainCollisionEvents((t,e,i)=>{const n=this.world.getCollider(t),o=this.world.getCollider(e);if(!n||!o)return;const r=n[$i],l=o[$i];Py&&console.log("EVT",r.name,l.name,i,n,o),r&&l&&(i?(this.onCollisionStarted(r,n,l,o),this.onCollisionStarted(l,o,r,n)):(this.onCollisionEnded(r,l),this.onCollisionEnded(l,r)))})}update(){this.onHandleCollisionStay()}onCollisionStarted(t,e,i,n){let o=null;if(t.isTrigger||i.isTrigger)Ec(t.gameObject,r=>{r.onTriggerEnter&&!r.destroyed&&r.onTriggerEnter(i),this.activeTriggers.push({collider:t,component:r,otherCollider:i})});else{const r=t.gameObject;this.world.contactPair(e,n,(l,c)=>{Ec(r,h=>{var u;if(h.destroyed)return;const d=h.onCollisionEnter||h.onCollisionStay||h.onCollisionExit;if(d||Py){if(!o){const f=[],p=l.normal();i instanceof fl&&i.convex&&(p.x=-p.x,p.y=-p.y,p.z=-p.z);for(let g=0;g<l.numSolverContacts();g++){const _=l.solverContactPoint(g),y=l.contactImpulse(g);if(_){const b=l.contactDist(g),v=l.solverContactFriction(g),w=l.solverContactTangentVelocity(g),P=new KA(_,b,p,y,v,w);f.push(P),Py&&G.DrawDirection(_,p,16711680,3,!0)}}o=new JA(r,i,f)}if(d){const f={collider:t,component:h,collision:o};this.activeCollisions.push(f),h.onCollisionStay&&this.activeCollisionsStay.push(f),(u=h.onCollisionEnter)==null||u.call(h,o)}}})})}}onHandleCollisionStay(){for(const t of this.activeCollisionsStay){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onCollisionStay){if(t.collision.collider.destroyed)continue;const i=t.collision;e.onCollisionStay(i)}}for(const t of this.activeTriggers){const e=t.component;if(!e.destroyed&&e.activeAndEnabled&&e.onTriggerStay){const i=t.otherCollider;if(i.destroyed)continue;e.onTriggerStay(i)}}}onCollisionEnded(t,e){if(!(t.destroyed||e.destroyed)){for(let i=0;i<this.activeCollisions.length;i++){const n=this.activeCollisions[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisions.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const r=n.component;if(this.activeCollisions.splice(i,1),i--,r.activeAndEnabled&&r.onCollisionExit){const l=n.collision;r.onCollisionExit(l)}}}for(let i=0;i<this.activeCollisionsStay.length;i++){const n=this.activeCollisionsStay[i],o=n.collider;if(o.destroyed||n.collision.collider.destroyed){this.activeCollisionsStay.splice(i,1),i--;continue}if(o===t&&n.collision.collider===e){const r=n.component;if(this.activeCollisionsStay.splice(i,1),i--,r.activeAndEnabled&&r.onCollisionExit){const l=n.collision;r.onCollisionExit(l)}}}for(let i=0;i<this.activeTriggers.length;i++){const n=this.activeTriggers[i],o=n.collider;if(o.destroyed||n.otherCollider.destroyed){this.activeTriggers.splice(i,1),i--;continue}if(o===t&&n.otherCollider===e){const r=n.component;if(this.activeTriggers.splice(i,1),i--,r.activeAndEnabled&&r.onTriggerExit){const l=n.otherCollider;r.onTriggerExit(l)}}}}}}class X3{static async createComparisonScene(t){const{files:e}=t,n=await Promise.all(e.map(y=>new he(y).loadAssetAsync())),o=new bn;let r=0;for(const y of n)if(y instanceof D){y.position.y=r,o.add(y);const b=Qi([y]);r+=b.getSize(new x).y,r+=.1}const l=new Se(20);o.add(l);const c=t.environment||"https://dl.polyhaven.org/file/ph-assets/HDRIs/exr/1k/studio_small_09_1k.exr";if(c){let y=null;if(c.endsWith(".hdr")){const b=(await rs(()=>import("./three-examples.d0f093e2.js").then(v=>v.q),["./three-examples.d0f093e2.js","./three@0.169.11.js"],import.meta.url)).RGBELoader;y=new b}else if(c.endsWith(".exr")){const b=(await rs(()=>import("./three-examples.d0f093e2.js").then(v=>v.p),["./three-examples.d0f093e2.js","./three@0.169.11.js"],import.meta.url)).EXRLoader;y=new b}if(y){const b=await y.loadAsync(c).catch(v=>(console.error(v),null));b&&(b.mapping=zo,b.needsUpdate=!0,o.background=b,o.environment=b,o.backgroundBlurriness=.75)}else console.warn("Unsupported environment map format",c)}const h=Qi(o.children),d=h.getCenter(new x),u=h.getSize(new x),p=Math.max(u.x,u.y,u.z)/(2*Math.tan(Math.PI*l.fov/360));l.position.set(d.x,d.y,p),l.lookAt(d);const g=new Yw(l,t.domElement||document.body);g.target=d,g.update();const _=(t.domElement||document.body).getBoundingClientRect();return l.aspect=_.width/_.height,l.updateProjectionMatrix(),{scene:o,camera:l}}}let G_=0;function kw(s){s?G_++:G_--}function Q3(){return G_>0}const wL={binary:!0,animations:!0};async function Y3(s){if(!s.context)throw new Error("No context provided to exportAsGLTF");s.scene||(s.scene=s.context.scene);const t={...wL,...s},{context:e}=t,i=new Kw;i.register(l=>new $w(l)),i.register(l=>new _2(l)),i.register(l=>new w1(l)),R1(i,t.context);const n={binary:t.binary,animations:CL(e,t.scene,[])},o=new SL;console.debug("Exporting GLTF",n),o.onBeforeExport(t),kw(!0);const r=await i.parseAsync(t.scene,n).catch(l=>(console.error(l),null));if(kw(!1),o.onAfterExport(t),!r)throw new Error("Failed to export GLTF");if(t.downloadAs!=null){let l=null;if(r instanceof ArrayBuffer?l=new Blob([r],{type:"application/octet-stream"}):console.error("Can not download GLTF as a blob",r),l){const c=URL.createObjectURL(l),h=document.createElement("a");h.href=c;let d=t.downloadAs;!d.endsWith(".glb")&&!d.endsWith(".gltf")&&(d+=t.binary?".glb":".gltf"),h.download=d,h.click()}}return r}const Ew=Symbol("needle:weight");class SL{constructor(){a(this,"_undo",[])}onBeforeExport(t){t.context.animations.mixers.forEach(e=>{const i=Hd.tryGetActionsFromMixer(e);if(i)for(let n=0;n<i.length;n++){const o=i[n];o[Ew]=o.weight,o.weight=0,this._undo.push(()=>{o.weight=o[Ew]})}e.update(0)}),t.context.scene.traverse(e=>{if(!v_(e)){const i=e.parent;i&&(e.removeFromParent(),this._undo.push(()=>i.add(e)))}})}onAfterExport(t){this._undo.forEach(e=>e()),this._undo.length=0}}function CL(s,t,e){s.animations.mixers.forEach(n=>{const o=Hd.tryGetActionsFromMixer(n);if(o)for(let r=0;r<o.length;r++){const c=o[r].getClip();e.push(c)}}),Array.isArray(t)||(t=[t]);for(const n of t)Hd.tryGetAnimationClipsFromObjectHierarchy(n,e);const i=new Set(e);return Array.from(i)}const Mw="needle-button",Ry=U();var Ua,Na,$a,Oi,Eo,_c,Up,MP,Np,AP,Zd;class EP extends HTMLElement{constructor(){super();On(this,Up);On(this,Np);On(this,Ua,void 0);On(this,Na,void 0);On(this,$a,void 0);On(this,Oi,void 0);On(this,Eo,void 0);On(this,_c,void 0);On(this,Zd,e=>{Ry&&console.log("Needle Button clicked"),!e.defaultPrevented&&be(this,Oi)&&be(this,Oi).click()});this.removeEventListener("click",be(this,Zd)),this.addEventListener("click",be(this,Zd))}attributeChangedCallback(e,i,n){gh(this,Up,MP).call(this)}}Ua=new WeakMap,Na=new WeakMap,$a=new WeakMap,Oi=new WeakMap,Eo=new WeakMap,_c=new WeakMap,Up=new WeakSet,MP=function(){var i,n;if((i=be(this,Oi))==null||i.remove(),this.getAttribute("ar")!=null)be(this,Eo)??qn(this,Eo,new $r),qn(this,Oi,be(this,Eo).createARButton());else if(this.getAttribute("vr")!=null)be(this,Eo)??qn(this,Eo,new $r),qn(this,Oi,be(this,Eo).createVRButton());else if(this.getAttribute("quicklook")!=null)be(this,Eo)??qn(this,Eo,new $r),qn(this,Oi,be(this,Eo).createQuicklookButton());else{Ry?console.warn("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute."):console.debug("No button type specified for <needle-button>. Use either ar, vr or quicklook attribute.");return}be(this,Ua)??qn(this,Ua,this.attachShadow({mode:"open"})),be(this,Na)??qn(this,Na,document.createElement("slot")),be(this,$a)??qn(this,$a,document.createElement("style")),be(this,$a).innerHTML=`
            button {
                all: initial;
                cursor: inherit;
                color: inherit;
                font-family: inherit;
                gap: inherit;
                white-space: nowrap;
            }
        `,this.getAttribute("unstyled")!=null||(be(this,$a).innerHTML+=`
            :host {
                display: inline-block;
                background: rgba(255, 255, 255, .8);
                backdrop-filter: blur(10px);
                width: fit-content;
                transition: background .2s;

                cursor: pointer;
                padding: 0.4rem .5rem;
                border-radius: 0.8rem;
                color: black;
                background: rgba(245, 245, 245, .8);
                outline: rgba(0,0,0,.05) 1px solid;
            }
            :host(:hover) {
                background: rgba(255, 255, 255, 1);
                transition: background .2s;
            }
            slot {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: .5rem;
            }
`),be(this,Na).innerHTML=be(this,Oi).innerHTML,be(this,Na).style.cssText="display: flex; align-items: center; justify-content: center;",be(this,Oi).innerHTML=be(this,Na).outerHTML,be(this,Ua).innerHTML=be(this,Oi).outerHTML,be(this,Ua).prepend(be(this,$a)),ip(f_,{element:be(this,Ua)}),(n=be(this,_c))==null||n.disconnect(),be(this,_c)??qn(this,_c,new MutationObserver(()=>gh(this,Np,AP).call(this))),be(this,_c).observe(be(this,Oi),{attributes:!0}),Ry&&console.log("Needle Button updated")},Np=new WeakSet,AP=function(){be(this,Oi)&&(be(this,Oi).style.display==="none"?this.style.display="none":this.style.display==="none"&&(this.style.display=""))},Zd=new WeakMap,a(EP,"observedAttributes",["ar","vr","quicklook"]);typeof window<"u"&&!window.customElements.get(Mw)&&window.customElements.define(Mw,EP);const Fh=S("debugavatar");class IP{constructor(t,e,i,n){a(this,"root");a(this,"head");a(this,"leftHand");a(this,"rigthHand");var o;this.root=t,this.head=e,this.leftHand=i,this.rigthHand=n,(o=this.root)==null||o.traverse(r=>r.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}}class PL{constructor(){a(this,"avatarRegistryUrl",null)}async getOrCreateNewAvatarInstance(t,e){if(!e)return console.error("Can not create avatar: failed to provide id or root object"),null;let i=null;if(typeof e=="string"){if(i=await this.loadAvatar(t,e),!i){const o=new lo;i=C.instantiate(Fd(e,t.scene),o)}}else i=e;if(!i)return null;const n=this.findAvatar(i);return n.isValid?(Fh&&console.log("[Custom Avatar] valid config",e,Fh?n:""),n):(console.warn("[Custom Avatar] config isn't valid",e,Fh?n:""),null)}async loadAvatar(t,e){if(console.assert(e!=null&&typeof e=="string","Avatar id must not be null"),e.length<=0||!e)return null;if(Fh&&console.log("[Custom Avatar] "+e+", loading..."),e.endsWith(".glb")||(e+=".glb"),this.avatarRegistryUrl===null){const n=await fetch("./"+e);let o=null;if(n.ok){const l=await n.blob();l&&(o=await l.arrayBuffer())}if(!o)return null;const r=await so().parseSync(t,o,null,0);return(r==null?void 0:r.scene)??null}const i=new Yo;return Mb(i,t),new Promise((n,o)=>{const r=this.avatarRegistryUrl+"/"+e;i.load(r,async l=>{await so().createBuiltinComponents(t,r,l,null,void 0),n(l.scene)},l=>{Fh&&console.log("[Custom Avatar] "+l.loaded/l.total*100+"% loaded of "+l.total/1024+"kB")},l=>{console.error("[Custom Avatar] Error when loading: "+l),n(null)})})}cacheModel(t,e){}findAvatar(t){const e=t;let i=e;i.children.length==1&&(i=t.children[0]);let n=this.findAvatarPart(i,["head"]);const o=this.findAvatarPart(i,["left","hand"]),r=this.findAvatarPart(i,["right","hand"]);if(!n){n=e;const c=new x;new Nn().setFromObject(n).getSize(c);const h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&n.scale.multiplyScalar(1/h*.3)}return new IP(e,n,o,r)}findAvatarPart(t,e){const i=t.name.toLowerCase();let n=!0;for(const o of e){if(!n)break;i.indexOf(o)===-1&&(n=!1)}if(n)return t;if(t.children)for(const o of t.children){const r=this.findAvatarPart(o,e);if(r)return r}return null}handleCustomAvatarErrors(t){if(!t.ok)throw Error(t.statusText);return t}}class RL{get extensionName(){return"DocumentExtension"}onAfterBuildDocument(t){}}class TL{}const OL=Object.freeze(Object.defineProperty({__proto__:null,ActionBuilder:Te,ActionCollection:dI,ActionModel:hn,AlignmentConstraint:fm,Animation:Yi,AnimationCurve:Qs,AnimationExtension:Hb,AnimationTrackHandler:u0,Animator:ii,AnimatorController:hs,Antialiasing:Am,Attractor:bu,AudioExtension:Wc,AudioListener:Mr,AudioSource:Oe,AudioTrackHandler:yc,Avatar:il,AvatarBlink_Simple:zc,AvatarEyeLook_Rotation:Ur,AvatarLoader:PL,AvatarMarker:Lt,AvatarModel:IP,Avatar_Brain_LookAt:hp,Avatar_MouthShapes:ym,Avatar_MustacheShake:m1,Avatar_POI:zr,AxesHelper:au,BaseUIComponent:ms,BasicIKConstraint:y1,BehaviorExtension:H1,BehaviorModel:ti,BloomEffect:Ho,BoxCollider:ul,BoxGizmo:Xc,BoxHelperComponent:un,Button:ca,CallInfo:Cr,Camera:Pe,CameraTargetReachedEvent:lp,Canvas:Bt,CanvasGroup:nl,CapsuleCollider:qr,ChangeMaterialOnClick:is,ChangeTransformOnClick:Vc,CharacterController:Uc,CharacterControllerInput:Jr,ChromaticAberration:Im,ClickThrough:_0,Collider:wn,ColorAdjustments:_l,ColorBySpeedModule:_u,ColorOverLifetimeModule:n0,ContactShadows:_n,ControlTrackHandler:f0,CursorFollow:qm,CustomBranding:qc,Deletable:v1,DeleteBox:pc,DepthOfField:fo,DeviceFlag:zb,DocumentExtension:RL,DragControls:jt,DropListener:Zr,Duplicatable:ml,EffectWrapper:wp,EmissionModule:sa,EmphasizeOnClick:hu,EnvironmentScene:g0,EventList:we,EventListEvent:Ib,EventSystem:Xi,EventTrigger:Wb,FieldWithDefault:j2,FixedJoint:eP,Fog:pu,GltfExport:Ws,GltfExportBox:M1,Gradient:Yc,Graphic:Vo,GraphicRaycaster:Db,GridHelper:mu,GridLayoutGroup:J1,GroundProjectedEnv:ir,GroupActionModel:Ba,HideOnStart:za,HingeJoint:Om,HorizontalLayoutGroup:K1,Image:Pu,InheritVelocityModule:oa,InputField:jn,InstanceHandle:dd,InstancingHandler:ja,Interactable:b1,Keyframe:gn,LODGroup:km,LODModel:yu,Light:Ji,LimitVelocityOverLifetimeModule:Nt,LogStats:_1,LookAt:qo,LookAtConstraint:Fc,MainModule:Bi,MaskableGraphic:Tm,MeshCollider:fl,MeshRenderer:vm,MinMaxCurve:Q,MinMaxGradient:Zt,NeedleMenu:or,NestedGltf:Em,Networking:Xr,NoiseModule:je,ObjectRaycaster:Vn,OffsetConstraint:Qc,OpenURL:Ru,OrbitControls:Ee,Outline:fu,Padding:Gc,ParticleBurst:A_,ParticleSubEmitter:nP,ParticleSystem:st,ParticleSystemRenderer:bs,PhysicsExtension:G1,PixelationEffect:Lm,PlayAnimationOnClick:Xs,PlayAudioOnClick:tl,PlayableDirector:us,PlayerColor:Yd,PointerEventData:mm,PostProcessingHandler:cP,PreliminaryAction:du,PreliminaryTrigger:wm,RawImage:m0,Rect:RI,RectTransform:ni,ReflectionProbe:qs,RegisteredAnimationInfo:Fa,RemoteSkybox:Zo,Renderer:Ve,RendererLightmap:C_,Rigidbody:xe,RotationBySpeedModule:_s,RotationOverLifetimeModule:uo,SceneSwitcher:vt,ScreenCapture:xl,ScreenSpaceAmbientOcclusion:ra,ScreenSpaceAmbientOcclusionN8:po,ScrollFollow:gs,SetActiveOnClick:Ln,ShadowCatcher:Bm,ShapeModule:We,SharpeningEffect:jm,SignalAsset:d0,SignalReceiver:Wr,SignalReceiverEvent:Um,SignalTrackHandler:Pp,Size:PI,SizeBySpeedModule:Pn,SizeOverLifetimeModule:Kc,SkinnedMeshRenderer:k1,SmoothFollow:eo,SpatialGrabRaycaster:Qa,SpatialHtml:Hm,SpatialTrigger:Ja,SpatialTriggerReceiver:Go,SpectatorCamera:h0,SphereCollider:lu,SplineContainer:th,SplineData:er,SplineWalker:mo,Sprite:ea,SpriteData:Zs,SpriteRenderer:Sn,SpriteSheet:Qd,SubEmitterSystem:B_,SyncedCamera:gc,SyncedRoom:go,SyncedTransform:oo,TapGestureTrigger:$1,TeleportTarget:Xb,TestRunner:uP,TestSimulateUserData:fP,Text:ji,TextBuilder:Q1,TextExtension:Qb,TextureSheetAnimationModule:Fi,TiltShiftEffect:ar,ToneMappingEffect:sl,TrailModule:lt,TransformData:it,TransformGizmo:ih,TriggerBuilder:_i,TriggerModel:Nr,UIRaycastUtils:u1,UIRootComponent:Rm,USDZExporter:De,USDZText:ql,USDZUIExtension:Z1,UsageMarker:bm,VariantAction:N1,VelocityOverLifetimeModule:mt,VerticalLayoutGroup:Y1,VideoPlayer:Ft,Vignette:Zc,VisibilityAction:Sm,Voip:dl,Volume:xu,VolumeParameter:W,VolumeProfile:r0,WebARCameraBackground:Xm,WebARSessionRoot:ss,WebXR:Je,WebXRImageTracking:Qm,WebXRImageTrackingModel:ua,WebXRPlaneTracking:fa,WebXRTrackedImage:Jl,XRControllerFollow:ha,XRControllerModel:Jo,XRControllerMovement:Hn,XRFlag:Qt,XRRig:b0,XRState:Ii,__Ignore:TL},Symbol.toStringTag,{value:"Module"})),Op=S("debugmissingcamera");ve.registerCallback(ge.MissingCamera,s=>{var l,c,h;Op&&console.warn("Creating missing camera");const t=s.context.scene,e=new Se;e.name="Default Fallback Camera",t.add(e);const i=new Pe;if(i.sourceId=((c=(l=s.files)==null?void 0:l[0])==null?void 0:c.src)??"unknown",i.fieldOfView=35,s.context.domElement.getAttribute("transparent")!=null)i.clearFlags=ui.Uninitialized;else if((h=s.context.domElement.getAttribute("background-image"))!=null&&h.length||s.context.lightmaps.tryGetSkybox(i.sourceId))i.clearFlags=ui.Skybox;else{if(i.clearFlags=ui.SolidColor,!s.context.domElement.getAttribute("background-color")){let d="#efefef";typeof window!==void 0&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(d="#1f1f1f"),t.background=new de(d)}if(!t.environment){const d=new JR(s.context.renderer),u=new g0("neutral");t.environment=d.fromScene(u,.025).texture}}const o=uc(e,i,!0);e.position.x=0,e.position.y=1,e.position.z=2;const r=s.context.domElement;return(r==null?void 0:r.cameraControls)!=!1&&DP(s.context,o),o});ve.registerCallback(ge.ContextCreated,s=>{if(!s.context.mainCamera){Op&&console.log("Will not auto-fit because a default camera exists");return}const t=s.context.domElement;if((t==null?void 0:t.cameraControls)==!0){const e=hO(s.context.mainCamera);if((e==null?void 0:e.isCameraController)==!0){Op&&console.log("Will not auto-fit because a camera controller exists");return}DP(s.context)}});function DP(s,t){t=t??s.mainCameraComponent;const e=t==null?void 0:t.gameObject;if(Op&&console.log("Creating default camera controls",t==null?void 0:t.name),e){const i=am(e,Ee);i.sourceId=(t==null?void 0:t.sourceId)??"unknown";const n=s.domElement.getAttribute("auto-rotate");if(i.autoRotate=n!=null&&n!="0"&&(n==null?void 0:n.toLowerCase())!="false",i.autoRotateSpeed=.5,i.autoFit=!0,i.autoRotate&&n){const o=parseFloat(n);isNaN(o)||(i.autoRotateSpeed=o)}}else console.warn("Missing camera object, can not add orbit controls")}ve.registerCallback(ge.ContextCreated,s=>{const t=s.context.domElement.getAttribute("autoplay");if(t!==void 0&&(t===""||t==="true"||t==="1")&&s.files)for(const e of s.files)C.foreachComponent(e.file.scene,n=>{if(n.enabled!==!1){if(n instanceof Yi&&n.playAutomatically||n instanceof ii||n instanceof us&&n.playOnAwake===!0)return!0;if(n instanceof Yi)return n.playAutomatically=!0,!0;if(n instanceof us)return n.playOnAwake=!0,!0}},!0)!==!0&&Hd.autoplayAnimations(e.file)});var Aw;(function(s){function t(e,i=!1,n=.75){const o=new th,r=1-N.clamp(n,0,1);return e.forEach((l,c)=>{const h=new x;c<e.length-1?h.subVectors(e[c+1],l).normalize().multiplyScalar(r):i&&e.length>1&&h.subVectors(e[0],l).normalize().multiplyScalar(r);const d=new er;d.position.copy(l),d.tangentIn.copy(h),d.tangentOut.copy(h),o.addKnot(d)}),o.closed=i,o}s.createFromPoints=t})(Aw||(Aw={}));const Rd={VERSION:as,Context:ne,NeedleXRSession:te,assets:{loadFromURL:aL},onStart:um,onUpdate:r1,onBeforeRender:mA,onAfterRender:gA,onInitializedContext:o1,onDestroyContext:pA,onClearContext:fA};var Iw;((Iw=globalThis.Needle)==null?void 0:Iw.VERSION)!==void 0&&console.warn(`Needle Engine is already imported: ${globalThis.Needle.VERSION}`);function LP(s){for(const t in s)Rd[t]=s[t]}LP(xA);LP(OL);for(const s of Object.getOwnPropertyNames(C))switch(s){case"prototype":case"constructor":case"length":case"name":continue;default:Rd[s]=C[s];break}if(!globalThis.Needle)globalThis.Needle=Rd;else for(const s in Rd)globalThis.Needle[s]=Rd[s];globalThis.THREE?console.warn("Three.js is already imported"):globalThis.THREE=ZR;export{F3 as $physicsKey,Te as ActionBuilder,dI as ActionCollection,hn as ActionModel,EM as Addressables,fm as AlignmentConstraint,$s as AmbientMode,Yi as Animation,Qs as AnimationCurve,Hb as AnimationExtension,u0 as AnimationTrackHandler,Hd as AnimationUtils,ii as Animator,xr as AnimatorConditionMode,hs as AnimatorController,g_ as AnimatorControllerParameterType,Hu as AnimatorStateInfo,Am as Antialiasing,ls as Application,mE as AssetDatabase,he as AssetReference,bu as Attractor,Wc as AudioExtension,Mr as AudioListener,Oe as AudioSource,yc as AudioTrackHandler,il as Avatar,zc as AvatarBlink_Simple,Ur as AvatarEyeLook_Rotation,PL as AvatarLoader,Lt as AvatarMarker,IP as AvatarModel,hp as Avatar_Brain_LookAt,ym as Avatar_MouthShapes,m1 as Avatar_MustacheShake,zr as Avatar_POI,$l as Axes,au as AxesHelper,vS as BUILD_TIME,ms as BaseUIComponent,y1 as BasicIKConstraint,H1 as BehaviorExtension,ti as BehaviorModel,j as Behaviour,Ac as BlobStorage,Ho as BloomEffect,ul as BoxCollider,Xc as BoxGizmo,un as BoxHelperComponent,ca as Button,Hs as ButtonsFactory,Lo as CallDirection,Cr as CallInfo,Pe as Camera,lp as CameraTargetReachedEvent,Bt as Canvas,nl as CanvasGroup,qr as CapsuleCollider,is as ChangeMaterialOnClick,Vc as ChangeTransformOnClick,Uc as CharacterController,Jr as CharacterControllerInput,Im as ChromaticAberration,$n as CircularBuffer,ui as ClearFlags,_0 as ClickThrough,Ms as ClipExtrapolation,wn as Collider,JA as Collision,op as CollisionDetectionMode,_l as ColorAdjustments,_u as ColorBySpeedModule,n0 as ColorOverLifetimeModule,j as Component,om as ComponentLifecycleEvents,Ky as ConnectionEvents,KA as ContactPoint,_n as ContactShadows,ne as Context,O3 as ContextArgs,ge as ContextEvent,ve as ContextRegistry,f0 as ControlTrackHandler,qm as CursorFollow,qc as CustomBranding,Mn as CustomShader,Gd as DefaultReflectionMode,v1 as Deletable,pc as DeleteBox,fo as DepthOfField,zb as DeviceFlag,K as DeviceUtilities,RL as DocumentExtension,jt as DragControls,pi as DragMode,Zr as DropListener,ml as Duplicatable,wp as EffectWrapper,sa as EmissionModule,hu as EmphasizeOnClick,Bf as EngineLoadingView,g0 as EnvironmentScene,we as EventList,Ib as EventListEvent,Xi as EventSystem,Wb as EventTrigger,j2 as FieldWithDefault,nd as FileReference,DM as FileReferenceSerializer,z3 as FileSpawnModel,Ix as File_Event,eP as FixedJoint,pu as Fog,oe as FrameEvent,cb as GENERATOR,C as GameObject,G as Gizmos,Ws as GltfExport,M1 as GltfExportBox,Yc as Gradient,Vo as Graphic,Db as GraphicRaycaster,cn as Graphics,mu as GridHelper,J1 as GridLayoutGroup,ir as GroundProjectedEnv,Ba as GroupActionModel,dp as HideFlags,za as HideOnStart,Om as HingeJoint,K1 as HorizontalLayoutGroup,S3 as HostData,Pu as Image,id as ImageReference,IM as ImageReferenceSerializer,oa as InheritVelocityModule,sk as Input,qi as InputEventQueue,_e as InputEvents,jn as InputField,dd as InstanceHandle,ja as InstancingHandler,cs as InstancingUtil,Tc as InstantiateEvent,yi as InstantiateIdProvider,lo as InstantiateOptions,b1 as Interactable,Rp as InternalScreenshotUtils,g3 as JoinedRoomResponse,f3 as KeyEventArgs,gn as Keyframe,km as LODGroup,yu as LODModel,y3 as LeftRoomResponse,Ji as Light,QM as LightData,Nt as LimitVelocityOverLifetimeModule,q3 as LoadingElementOptions,_1 as LogStats,Jt as LogType,qo as LookAt,Fc as LookAtConstraint,Bi as MainModule,$_ as MarkerType,Tm as MaskableGraphic,N as Mathf,fl as MeshCollider,vm as MeshRenderer,Q as MinMaxCurve,Zt as MinMaxGradient,Yf as NEEDLE_ENGINE_FEATURE_FLAGS,F as NEEDLE_ENGINE_MODULES,pt as NEEDLE_progressive,ku as NEKeyboardEvent,gr as NEPointerEvent,EP as NeedleButtonElement,ve as NeedleEngine,Dx as NeedleEngineModelLoader,kP as NeedleEngineWebComponent,or as NeedleMenu,xg as NeedlePatchesKey,K2 as NeedleUSDZExporter,TS as NeedleXRController,te as NeedleXRSession,Zk as NeedleXRSync,cE as NeedleXRUtils,Em as NestedGltf,Jk as NetworkConnection,at as NetworkedStreamEvents,gm as NetworkedStreams,Xr as Networking,zE as NewInstanceModel,je as NoiseModule,Vn as ObjectRaycaster,ll as ObjectUtils,Qc as OffsetConstraint,yg as OneEuroFilter,cS as OneEuroFilterXYZ,Ru as OpenURL,Ee as OrbitControls,fu as Outline,hi as OwnershipEvent,vC as OwnershipModel,_f as PUBLIC_KEY,Gc as Padding,A_ as ParticleBurst,nP as ParticleSubEmitter,st as ParticleSystem,yl as ParticleSystemBaseBehaviour,bs as ParticleSystemRenderer,Ti as ParticleSystemShapeType,fc as PeerHandle,Qk as PeerNetworking,Zh as Physics,G1 as PhysicsExtension,Ot as PhysicsMaterialCombine,Lm as PixelationEffect,Xs as PlayAnimationOnClick,tl as PlayAudioOnClick,us as PlayableDirector,Yd as PlayerColor,Kt as PlayerState,O_ as PlayerStateEvent,gl as PlayerSync,UM as PlayerView,NM as PlayerViewManager,mm as PointerEventData,kr as PointerType,Pt as PostProcessingEffect,kt as PostProcessingEffectOrder,cP as PostProcessingHandler,xu as PostProcessingManager,du as PreliminaryAction,wm as PreliminaryTrigger,Ta as PreviewHelper,Bn as PrimitiveType,ye as Progress,sS as PromiseAllWithErrors,H0 as PromiseErrorResult,pe as RGBAColor,Ca as RapierPhysics,m0 as RawImage,Kr as RaycastOptions,RI as Rect,ni as RectTransform,qs as ReflectionProbe,Fa as RegisteredAnimationInfo,Zo as RemoteSkybox,qa as RenderTexture,zA as RenderTextureSerializer,Ve as Renderer,XM as RendererData,C_ as RendererLightmap,xe as Rigidbody,ht as RigidbodyConstraints,se as RoomEvents,_s as RotationBySpeedModule,uo as RotationOverLifetimeModule,x_ as SceneLightSettings,vt as SceneSwitcher,xl as ScreenCapture,ra as ScreenSpaceAmbientOcclusion,po as ScreenSpaceAmbientOcclusionN8,gs as ScrollFollow,es as SendQueue,BC as SerializationContext,Ln as SetActiveOnClick,Bm as ShadowCatcher,We as ShapeModule,ZA as ShapeOverlapResult,jm as SharpeningEffect,d0 as SignalAsset,Wr as SignalReceiver,Um as SignalReceiverEvent,Pp as SignalTrackHandler,PI as Size,Pn as SizeBySpeedModule,Kc as SizeOverLifetimeModule,k1 as SkinnedMeshRenderer,eo as SmoothFollow,Qa as SpatialGrabRaycaster,Hm as SpatialHtml,Ja as SpatialTrigger,Go as SpatialTriggerReceiver,h0 as SpectatorCamera,lu as SphereCollider,wC as SphereIntersection,th as SplineContainer,er as SplineData,Aw as SplineUtils,mo as SplineWalker,ea as Sprite,Zs as SpriteData,Sn as SpriteRenderer,Qd as SpriteSheet,A3 as StateMachineBehaviour,f1 as StreamEndedEvent,e2 as StreamReceivedEvent,B_ as SubEmitterSystem,gc as SyncedCamera,go as SyncedRoom,oo as SyncedTransform,$1 as TapGestureTrigger,Xb as TeleportTarget,uP as TestRunner,X3 as TestSceneUtils,fP as TestSimulateUserData,ji as Text,Q1 as TextBuilder,Qb as TextExtension,Fi as TextureSheetAnimationModule,ar as TiltShiftEffect,YM as Time,sl as ToneMappingEffect,Nm as TrackHandler,rn as TrackType,lt as TrailModule,it as TransformData,ih as TransformGizmo,_i as TriggerBuilder,Nr as TriggerModel,M as TypeStore,u1 as UIRaycastUtils,Rm as UIRootComponent,L1 as USDDocument,gi as USDObject,Q2 as USDWriter,De as USDZExporter,ql as USDZText,Z1 as USDZUIExtension,UA as UriSerializer,bm as UsageMarker,_3 as UserJoinedOrLeftRoomModel,as as VERSION,N1 as VariantAction,mt as VelocityOverLifetimeModule,Y1 as VerticalLayoutGroup,Ft as VideoPlayer,No as ViewDevice,Zc as Vignette,Sm as VisibilityAction,dl as Voip,xu as Volume,W as VolumeParameter,r0 as VolumeProfile,P3 as WaitForFrames,jM as WaitForPromise,KC as WaitForSeconds,Lr as Watch,Xm as WebARCameraBackground,ss as WebARSessionRoot,Je as WebXR,$r as WebXRButtonFactory,Qm as WebXRImageTracking,ua as WebXRImageTrackingModel,fa as WebXRPlaneTracking,Jl as WebXRTrackedImage,ha as XRControllerFollow,Jo as XRControllerModel,Hn as XRControllerMovement,Qt as XRFlag,b0 as XRRig,Ii as XRState,Fn as XRStateFlag,TL as __Ignore,x3 as __internalNotifyObjectDestroyed,jr as activeInHierarchyFieldName,GT as addAttributeChangeCallback,Ks as addComponent,U3 as addCustomExtensionPlugin,uc as addNewComponent,hb as addPatch,Pb as apply,E3 as applyHMRChanges,cM as applyPrototypeExtensions,FE as beginListenDestroy,NE as beginListenInstantiate,kS as binaryIdentifierCasts,T3 as build_scene_functions,Il as builtinComponentKeyName,RP as calculateProgress01,t3 as clearBalloonMessages,t3 as clearOverlayMessages,L3 as colorSerializer,QE as compareAssociation,$g as componentSerializer,RO as copyTexture,CA as createMotion,sn as debugNet,ju as debugOwner,Z2 as decompressGpuTexture,Kp as deepClone,Ko as delay,Jp as delayForFrames,r_ as deserializeObject,Wn as destroy,mM as destroyComponentInstance,u2 as determineMimeTypeFromExtension,Ye as disposeObjectResources,Bo as disposeStream,bf as editorGuidKeyName,lc as enableSpatialConsole,j3 as euler,B3 as eventListSerializer,Y3 as exportAsGLTF,VC as findByGuid,hm as findObjectOfType,gM as findObjectsOfType,RC as findResourceUsers,EO as fitObjectIntoVolume,Ec as foreachComponent,Tb as foreachComponentEnumerator,o3 as forward,QT as generateQRCode,UE as generateSeed,Qi as getBoundingBox,hO as getCameraController,Bc as getComponent,cm as getComponentInChildren,ep as getComponentInParent,lm as getComponents,nu as getComponentsInChildren,Cb as getComponentsInParent,z2 as getFormattedDate,mi as getIconElement,px as getIconTexture,so as getLoader,am as getOrAddComponent,S as getParam,r3 as getParentHierarchyPath,$L as getPath,p3 as getPeerOptions,Xk as getPeerjsInstance,w3 as getResourceUserCount,gO as getTempColor,dn as getTempQuaternion,q as getTempVector,Yp as getUrlParams,kO as getVisibleInCustomShadowRendering,wO as getWorldDirection,uS as getWorldEuler,ae as getWorldPosition,Le as getWorldQuaternion,lb as getWorldRotation,_t as getWorldScale,Wo as hasCommercialLicense,dm as hasIndieLicense,__ as hasPointerEventComponent,$o as hasProLicense,FO as hideDebugConsole,iI as imageToCanvas,Mc as instantiate,D2 as invokeLoadedImportPluginHooks,YO as invokeXRSessionEnd,QO as invokeXRSessionStart,vM as isActiveInHierarchy,su as isActiveSelf,qL as isAndroidDevice,PO as isAnimationAction,YA as isComponent,FL as isDebugMode,WL as isDesktop,kc as isDestroyed,U as isDevEnvironment,v3 as isDisposed,Q3 as isExporting,QA as isGLTFModel,MT as isHostedOnGlitch,wx as isHotReloadEnabled,k3 as isHotReloading,HL as isIPad,ZM as isIconElement,fs as isLocalNetwork,QL as isMacOS,VL as isMobileDevice,XL as isMozillaXR,JL as isQuest,gE as isResourceTrackingEnabled,KL as isSafari,Rb as isUsingInstancing,YL as isiOS,GL as isiPad,aL as loadAsset,PD as loadPMREM,SP as loadSync,Ly as logHierarchy,n3 as lookAtInverse,Zp as lookAtObject,s3 as lookAtScreenPoint,UL as makeId,$T as makeIdFromRandomWords,ps as makeNameSafeForUSD,xM as markAsInstancedRendered,ZL as microphonePermissionsGranted,BL as nameof,UT as nameofFactory,LA as objectSerializer,d3 as offXRSessionEnd,h3 as offXRSessionStart,gA as onAfterRender,mA as onBeforeRender,fA as onClear,pA as onDestroy,o1 as onInitialized,um as onStart,r1 as onUpdate,PS as onXRSessionEnd,ub as onXRSessionStart,lL as parseSync,MO as placeOnSurface,mS as postprocessFBXMaterials,D3 as prefix,NT as pushState,NL as randomNumber,ES as registerBinaryType,kb as registerComponent,P1 as registerComponentExtension,vs as registerCustomEffectType,R1 as registerExportExtensions,S_ as registerExtensions,_A as registerHotReloadType,wS as registerLoader,WE as registerPrefabProvider,hM as registerPrototypeExtensions,C3 as registerType,VT as relativePathPrefix,qT as removeAttributeChangeCallback,NC as removeComponent,N3 as removeCustomImportExtensionType,c3 as removePatch,rl as resolveUrl,WT as sanitizeString,QD as saveImage,G3 as screenshot,bP as screenshot2,AC as sendDestroyed,m as serializable,tM as serializeObject,Rt as serializeable,Of as setActive,tO as setAllowBalloonMessages,e3 as setAllowOverlayMessages,Dy as setAutoFitEnabled,X0 as setCameraController,wM as setDestroyed,l3 as setDevEnvironment,yE as setDisposable,xh as setDontDestroy,$0 as setOrAddParamsToUrl,zL as setParam,$f as setParamWithoutReload,m3 as setPeerOptions,b3 as setResourceTrackingEnabled,iS as setState,pS as setVisibleInCustomShadowRendering,fS as setWorldEuler,ei as setWorldPosition,Cc as setWorldPositionXYZ,no as setWorldQuaternion,dS as setWorldQuaternionXYZW,CO as setWorldRotation,em as setWorldRotationXYZ,zd as setWorldScale,tm as showBalloonError,nt as showBalloonMessage,ke as showBalloonWarning,_S as showDebugConsole,i3 as slerp,rm as syncDestroy,V1 as syncField,IC as syncInstantiate,a3 as textureToCanvas,dk as tryCastBinary,p2 as tryDetermineMimetypeFromBinary,f2 as tryDetermineMimetypeFromURL,Fd as tryFindObject,uk as tryGetGuid,bA as unregisterHotReloadType,nS as unwatchWrite,dO as useForAutoFit,vi as validate,ob as watchWrite};
